<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="RunLoopæ˜¯å¹²å•¥çš„å®˜ç¿»ï¼š Run loopsæ˜¯ä¸çº¿ç¨‹ç›¸å…³çš„åŸºç¡€è®¾æ–½çš„ä¸€éƒ¨åˆ†ï¼Œä¸€ä¸ªRunloopå°±æ˜¯ä¸€ä¸ªäº‹ä»¶å¤„ç†çš„å¾ªç¯ã€‚Runloopçš„ç›®æ ‡æ˜¯è®©çº¿ç¨‹åœ¨æœ‰äº‹æƒ…åšçš„æ—¶å€™ä¿æŒå¿™ç¢Œã€æ²¡æœ‰äº‹æƒ…åšçš„æ—¶å€™ä¿æŒç¡çœ ã€‚ ç–‘é—®ï¼Ÿï¼Ÿï¼Ÿ Runloopçš„è¿è¡Œæœºåˆ¶ Runloopæ˜¯å¦‚ä½•å”¤é†’å’Œç¡çœ çº¿ç¨‹çš„ï¼Œä¸çº¿ç¨‹åˆ°åº•æ˜¯ä»€ä¹ˆå…³ç³» Runloopçš„Sourceã€Timerã€Observerå’ŒModeä¸Runloopåˆ°åº•æ˜¯ä»€ä¹ˆå…³ç³»">
<meta property="og:type" content="article">
<meta property="og:title" content="Runloopæºç è§£æå’Œå®è·µ">
<meta property="og:url" content="http://yoursite.com/2018/09/10/Runloopæºç è§£æå’Œå®è·µ/index.html">
<meta property="og:site_name" content="lly&#39;s Blog">
<meta property="og:description" content="RunLoopæ˜¯å¹²å•¥çš„å®˜ç¿»ï¼š Run loopsæ˜¯ä¸çº¿ç¨‹ç›¸å…³çš„åŸºç¡€è®¾æ–½çš„ä¸€éƒ¨åˆ†ï¼Œä¸€ä¸ªRunloopå°±æ˜¯ä¸€ä¸ªäº‹ä»¶å¤„ç†çš„å¾ªç¯ã€‚Runloopçš„ç›®æ ‡æ˜¯è®©çº¿ç¨‹åœ¨æœ‰äº‹æƒ…åšçš„æ—¶å€™ä¿æŒå¿™ç¢Œã€æ²¡æœ‰äº‹æƒ…åšçš„æ—¶å€™ä¿æŒç¡çœ ã€‚ ç–‘é—®ï¼Ÿï¼Ÿï¼Ÿ Runloopçš„è¿è¡Œæœºåˆ¶ Runloopæ˜¯å¦‚ä½•å”¤é†’å’Œç¡çœ çº¿ç¨‹çš„ï¼Œä¸çº¿ç¨‹åˆ°åº•æ˜¯ä»€ä¹ˆå…³ç³» Runloopçš„Sourceã€Timerã€Observerå’ŒModeä¸Runloopåˆ°åº•æ˜¯ä»€ä¹ˆå…³ç³»">
<meta property="og:locale" content="zh-Hans">
<meta property="og:image" content="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Runloop/runloop001.png">
<meta property="og:image" content="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Runloop/runloop003.png">
<meta property="og:image" content="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Runloop/runloop004.png">
<meta property="og:image" content="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Runloop/runloop005.png">
<meta property="og:image" content="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Runloop/runloop007.png">
<meta property="og:image" content="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Runloop/runloop008.png">
<meta property="og:updated_time" content="2019-04-03T04:22:15.023Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Runloopæºç è§£æå’Œå®è·µ">
<meta name="twitter:description" content="RunLoopæ˜¯å¹²å•¥çš„å®˜ç¿»ï¼š Run loopsæ˜¯ä¸çº¿ç¨‹ç›¸å…³çš„åŸºç¡€è®¾æ–½çš„ä¸€éƒ¨åˆ†ï¼Œä¸€ä¸ªRunloopå°±æ˜¯ä¸€ä¸ªäº‹ä»¶å¤„ç†çš„å¾ªç¯ã€‚Runloopçš„ç›®æ ‡æ˜¯è®©çº¿ç¨‹åœ¨æœ‰äº‹æƒ…åšçš„æ—¶å€™ä¿æŒå¿™ç¢Œã€æ²¡æœ‰äº‹æƒ…åšçš„æ—¶å€™ä¿æŒç¡çœ ã€‚ ç–‘é—®ï¼Ÿï¼Ÿï¼Ÿ Runloopçš„è¿è¡Œæœºåˆ¶ Runloopæ˜¯å¦‚ä½•å”¤é†’å’Œç¡çœ çº¿ç¨‹çš„ï¼Œä¸çº¿ç¨‹åˆ°åº•æ˜¯ä»€ä¹ˆå…³ç³» Runloopçš„Sourceã€Timerã€Observerå’ŒModeä¸Runloopåˆ°åº•æ˜¯ä»€ä¹ˆå…³ç³»">
<meta name="twitter:image" content="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Runloop/runloop001.png">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'åšä¸»'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/2018/09/10/Runloopæºç è§£æå’Œå®è·µ/"/>

  <title> Runloopæºç è§£æå’Œå®è·µ | lly's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">lly's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">ç”¨å¿ƒè®°å½•ç‚¹æ»´</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                Runloopæºç è§£æå’Œå®è·µ
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2018-09-10T21:20:28+08:00" content="2018-09-10">
              2018-09-10
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/09/10/Runloopæºç è§£æå’Œå®è·µ/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/09/10/Runloopæºç è§£æå’Œå®è·µ/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <h4 id="RunLoopæ˜¯å¹²å•¥çš„"><a href="#RunLoopæ˜¯å¹²å•¥çš„" class="headerlink" title="RunLoopæ˜¯å¹²å•¥çš„"></a>RunLoopæ˜¯å¹²å•¥çš„</h4><p><strong>å®˜ç¿»ï¼š</strong> Run loopsæ˜¯ä¸çº¿ç¨‹ç›¸å…³çš„åŸºç¡€è®¾æ–½çš„ä¸€éƒ¨åˆ†ï¼Œä¸€ä¸ªRunloopå°±æ˜¯ä¸€ä¸ªäº‹ä»¶å¤„ç†çš„å¾ªç¯ã€‚Runloopçš„ç›®æ ‡æ˜¯è®©çº¿ç¨‹åœ¨æœ‰äº‹æƒ…åšçš„æ—¶å€™ä¿æŒå¿™ç¢Œã€æ²¡æœ‰äº‹æƒ…åšçš„æ—¶å€™ä¿æŒç¡çœ ã€‚</p>
<h4 id="ç–‘é—®ï¼Ÿï¼Ÿï¼Ÿ"><a href="#ç–‘é—®ï¼Ÿï¼Ÿï¼Ÿ" class="headerlink" title="ç–‘é—®ï¼Ÿï¼Ÿï¼Ÿ"></a>ç–‘é—®ï¼Ÿï¼Ÿï¼Ÿ</h4><ul>
<li>Runloopçš„è¿è¡Œæœºåˆ¶</li>
<li>Runloopæ˜¯å¦‚ä½•å”¤é†’å’Œç¡çœ çº¿ç¨‹çš„ï¼Œä¸çº¿ç¨‹åˆ°åº•æ˜¯ä»€ä¹ˆå…³ç³»</li>
<li>Runloopçš„Sourceã€Timerã€Observerå’ŒModeä¸Runloopåˆ°åº•æ˜¯ä»€ä¹ˆå…³ç³»</li>
<li>iOSç³»ç»Ÿæ€ä¹ˆä½¿ç”¨Runloopçš„</li>
<li>å¦‚ä½•è‡ªå®šä¹‰</li>
</ul>
<h3 id="åº–ä¸è§£ğŸ‚"><a href="#åº–ä¸è§£ğŸ‚" class="headerlink" title="åº–ä¸è§£ğŸ‚"></a>åº–ä¸è§£ğŸ‚</h3><p>ä¸€ä¸ªRunloopæ¥æ”¶2ä¸­ä¸åŒç±»å‹çš„sources.<strong>Input source</strong> å‘é€å¼‚æ­¥äº‹ä»¶ï¼Œä¸€èˆ¬æ˜¯æ¥è‡ªå…¶ä»–çº¿ç¨‹æˆ–è€…æ˜¯å…¶ä»–åº”ç”¨çš„ï¼›<strong>Timer source</strong>å‘é€åŒæ­¥äº‹ä»¶ï¼Œä¼šåœ¨é¢„è®¾å¥½çš„æ—¶é—´æˆ–è€…é‡å¤é—´éš”å†…è§¦å‘ã€‚è¿™2ç§sourceéƒ½ä¼šé€šè¿‡ç‰¹æ®Šçš„å¤„ç†ç¨‹åºå¤„ç†äº‹ä»¶ã€‚</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Runloop/runloop001.png" alt=""></p>
<p>Input sourceå‘é€å¼‚æ­¥äº‹ä»¶ï¼Œè¿™ç§source runloopåœ¨å¤„ç†çš„æ—¶å€™ä¼šè°ƒç”¨runUnitlDateï¼šæ–¹æ³•å¼€å¯ä¸€ä¸ªrunloop,å¹¶ä¸”åœ¨è¿è¡Œdateæ—¶é—´åé€€å‡ºã€‚Timer sourceåˆ™ä¸ä¼šä½¿runloopé€€å‡ºã€‚</p>
<p>åœ¨å¤„ç†input sourceæ—¶ï¼Œrunloops ä¹Ÿä¼šç”Ÿæˆç›¸å…³çš„é€šçŸ¥ï¼Œä½ å¯ä»¥æ³¨å†Œæˆä¸ºè§‚å¯Ÿè€…åœ¨å½“å‰çº¿ç¨‹æ¥å¤„ç†å…¶ä»–æ—¶é—´ã€‚</p>
<p>#####ï¼ˆè¡¥å……ï¼‰ runloop çš„è¿è¡Œæ–¹å¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (void)run; </div><div class="line">- (BOOL)runMode:(NSRunLoopMode)mode beforeDate:(NSDate *)limitDate;</div><div class="line">- (void)runUntilDate:(NSDate *)limitDate;</div></pre></td></tr></table></figure>
<ul>
<li><p>runæ–¹æ³•å¯¹åº”CFRunloopRefä¸­çš„CFRunLoopRunå¹¶ä¸ä¼šé€€å‡ºï¼Œé™¤éæ‰‹åŠ¨è°ƒç”¨CFRunLoopStop();é€šå¸¸å¦‚æœæƒ³è¦æ°¸è¿œä¸ä¼šé€€å‡ºRunLoopæ‰ä¼šä½¿ç”¨æ­¤æ–¹æ³•ï¼Œå¦åˆ™å¯ä»¥ä½¿ç”¨runUntilDateã€‚</p>
</li>
<li><p>runMode:beforeDate:åˆ™å¯¹åº”CFRunLoopRunInMode(mode,limiteDate,true)æ–¹æ³•,åªæ‰§è¡Œä¸€æ¬¡ï¼Œæ‰§è¡Œå®Œå°±é€€å‡ºï¼›é€šå¸¸ç”¨äºæ‰‹åŠ¨æ§åˆ¶RunLoopï¼ˆä¾‹å¦‚åœ¨whileå¾ªç¯ä¸­ï¼‰ã€‚</p>
</li>
<li><p>runUntilDate:æ–¹æ³•å…¶å®æ˜¯CFRunLoopRunInMode(kCFRunLoopDefaultMode,limiteDate,false)ï¼Œæ‰§è¡Œå®Œå¹¶ä¸ä¼šé€€å‡ºï¼Œç»§ç»­ä¸‹ä¸€æ¬¡RunLoopç›´åˆ°timeoutã€‚</p>
</li>
</ul>
<h4 id="Modes"><a href="#Modes" class="headerlink" title="Modes"></a>Modes</h4><p>ä¸€ä¸ªrunloop modeæ˜¯input sourceå’Œtimer sourcesçš„é›†åˆï¼ŒåŒæ—¶åŒ…å«ä¸€ä¸ªrunloopè§‚å¯Ÿè€…çš„åˆé›†ã€‚æ¯æ¬¡è¿è¡Œä¸€ä¸ªrunloopæ—¶ï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªç‰¹åˆ«çš„modeã€‚åœ¨runloop è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œåªæœ‰å’Œè¿™ä¸ªmodeç›¸å…³è”sourceæ‰èƒ½å‘é€äº‹ä»¶ï¼ˆåŒæ ·ï¼Œåªæœ‰å’Œè¿™ä¸ªmodeå…³è”çš„è§‚å¯Ÿè€…æ‰èƒ½æ”¶åˆ°é€šçŸ¥ï¼‰ã€‚å…³è”äº†å…¶ä»–modeçš„sourceä¼šè¢«æš‚åœä¸€åˆ‡æ–°äº‹ä»¶çš„å‘é€ç›´åˆ°runloopè¿è¡Œåœ¨è¯¥modeä¸Šã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">struct __CFRunLoopMode &#123;</div><div class="line">    CFStringRef _name;            // Mode Name, ä¾‹å¦‚ @&quot;kCFRunLoopDefaultMode&quot;</div><div class="line">    CFMutableSetRef _sources0;    // Set</div><div class="line">    CFMutableSetRef _sources1;    // Set</div><div class="line">    CFMutableArrayRef _observers; // Array</div><div class="line">    CFMutableArrayRef _timers;    // Array</div><div class="line">    ...</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>modesé€šè¿‡nameæ¥åŒºåˆ†ï¼Œå¯ç”¨é€šè¿‡æŒ‡å®šmodeçš„nameæ¥è‡ªå®šä¹‰ä¸€ä¸ªmode,è™½ç„¶nameåœ¨è‡ªå®šä¹‰çš„æ—¶å€™å¯ä»¥ä»»æ„æŒ‡å®šï¼Œä½†æ˜¯å…¶ä»–å†…å®¹å´ä¸è¡Œï¼Œå½“ä½ è‡ªå®šä¹‰ä¸€ä¸ªmodeçš„æ—¶å€™ï¼Œå¿…é¡»æ·»åŠ ä¸€ä¸ªæˆ–è€…å¤šä¸ªsource(input source æˆ– timer source) ,æˆ–è€…è§‚å¯Ÿè€…ã€‚</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Runloop/runloop003.png" alt=""></p>
<h4 id="Input-Sources"><a href="#Input-Sources" class="headerlink" title="Input Sources"></a>Input Sources</h4><p>Input sources ç»™çº¿ç¨‹å‘é€å¼‚æ­¥äº‹ä»¶ï¼Œäº‹ä»¶çš„ç±»å‹å’Œinput sourceçš„ç±»å‹ç›¸å…³ã€‚ä¸€èˆ¬æœ‰2ç§:<strong>Port-based input sources ç”¨æ¥ç›‘æ§Mach ports</strong>å’Œ<strong>è‡ªå®šä¹‰ input sources ç”¨æ¥ç›‘æ§è‡ªå®šä¹‰äº‹ä»¶</strong>ã€‚2è€…çš„å”¯ä¸€ä¸åŒåœ¨äºå¦‚ä½•å‘é€ä¿¡å·ï¼šPort-based input sourcesæ˜¯kernelå†…æ ¸è‡ªåŠ¨å‘é€ä¿¡å·ï¼›è‡ªå®šä¹‰ input sourcesæ˜¯ä»å…¶ä»–çº¿ç¨‹æ‰‹åŠ¨å‘é€ä¿¡å·ã€‚</p>
<h5 id="Port-Based-Sources"><a href="#Port-Based-Sources" class="headerlink" title="Port-Based Sources"></a>Port-Based Sources</h5><ul>
<li>NSMachPort</li>
<li>NSMessagePort</li>
</ul>
<p>mach æ“ä½œç³»ç»Ÿå¾®å†…æ ¸ åœ¨mac oså’Œiosç³»ç»Ÿä¸­é‡‡ç”¨ã€‚è™šæ‹Ÿå†…å­˜çš„åˆ†é…ï¼Œè¿›ç¨‹é—´çš„é€šä¿¡ï¼ˆåŸºäºportï¼‰ã€‚</p>
<p>æ¯ä¸€ç§æœåŠ¡éƒ½æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼ˆhttp 8080 https 443 ftp 20 21 rtmp 1935ï¼‰ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹éƒ½åˆ†é…ä¸€ä¸ªport(è™šæ‹Ÿç«¯å£)ï¼Œ </p>
<h5 id="Custom-Input-Sources"><a href="#Custom-Input-Sources" class="headerlink" title="Custom Input Sources"></a>Custom Input Sources</h5><p>è‡ªå®šä¹‰ä¸€ä¸ªInput sourceéœ€è¦æ»¡è¶³å¦‚ä¸‹å®šä¹‰ï¼š</p>
<ul>
<li>éœ€è¦input sourceå¤„ç†çš„ä¿¡æ¯</li>
<li>è®©æ„Ÿå…´è¶£çš„å®¢æˆ·ç«¯çŸ¥é“æ€ä¹ˆè”ç³»ä½ çš„input source</li>
<li>ä¸€ä¸ªå¤„ç†ç¨‹åºä¾‹ç¨‹æ¥æ‰§è¡Œä»»ä½•å®¢æˆ·ç«¯çš„å‘é€è¯·æ±‚</li>
<li>å–æ¶ˆç¨‹åº</li>
</ul>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Runloop/runloop004.png" alt=""></p>
<h5 id="Cocoa-Perform-Selector-Sources"><a href="#Cocoa-Perform-Selector-Sources" class="headerlink" title="Cocoa Perform Selector Sources"></a>Cocoa Perform Selector Sources</h5><p>Perform Selector Sources åœ¨æ‰§è¡Œå®Œä»¥åä¼šä»runloopçš„modeä¸­ç§»é™¤ã€‚</p>
<p>å½“è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œtargetçº¿ç¨‹å¿…é¡»åŒ…å«ä¸€ä¸ªæ´»è·ƒçš„runloopï¼Œrunloopä¼šåœ¨ä¸€æ¬¡loopä¸­å¤„ç†æ‰€æœ‰çš„æ’é˜ŸPerformäº‹ä»¶è€Œä¸æ˜¯åªå¤„ç†ä¸€ä¸ªã€‚</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Runloop/runloop005.png" alt=""></p>
<h4 id="Timer-Sources"><a href="#Timer-Sources" class="headerlink" title="Timer Sources"></a>Timer Sources</h4><p>timeréœ€è¦å…³è”ä¸€ä¸ªmodeï¼Œå¦‚æœtimerä¸åœ¨å½“å‰æ´»åŠ¨çš„modeä¸Šï¼Œåˆ™ä¸ä¼šè¢«è§¦å‘ã€‚å¦‚æœtimeræ‰€åœ¨çš„modeæ‰§è¡Œè¿‡ç¨‹ä¸­è¢«åˆ‡æ¢ï¼Œåˆ™è¯¥timerä¹Ÿä¸ä¼šæš‚åœç›´åˆ°modeé‡æ–°åˆ‡æ¢å›æ¥ï¼Œè¿™å°±å†³å®šäº†NSTimerçš„è§¦å‘å¹¶ä¸æ˜¯ååˆ†å¯é çš„ã€‚</p>
<h4 id="Run-Loop-Observers"><a href="#Run-Loop-Observers" class="headerlink" title="Run Loop Observers"></a>Run Loop Observers</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"> /* Run Loop Observer Activities */</div><div class="line">typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) &#123;</div><div class="line">    kCFRunLoopEntry = (1UL &lt;&lt; 0),// å³å°†è¿›å…¥Loop  0x1</div><div class="line">    kCFRunLoopBeforeTimers = (1UL &lt;&lt; 1),// å³å°†å¤„ç† Timer </div><div class="line">    kCFRunLoopBeforeSources = (1UL &lt;&lt; 2),// å³å°†å¤„ç† Source </div><div class="line">    kCFRunLoopBeforeWaiting = (1UL &lt;&lt; 5),// å³å°†è¿›å…¥ä¼‘çœ  0x20</div><div class="line">    kCFRunLoopAfterWaiting = (1UL &lt;&lt; 6),// åˆšä»ä¼‘çœ ä¸­å”¤é†’ </div><div class="line">    </div><div class="line">    kCFRunLoopExit = (1UL &lt;&lt; 7),// å³å°†é€€å‡ºLoop </div><div class="line">    </div><div class="line">    kCFRunLoopAllActivities = 0x0FFFFFFFU</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="Runloopä½¿ç”¨åœºæ™¯"><a href="#Runloopä½¿ç”¨åœºæ™¯" class="headerlink" title="Runloopä½¿ç”¨åœºæ™¯"></a>Runloopä½¿ç”¨åœºæ™¯</h4><ul>
<li>ä½¿ç”¨mach portæˆ–è€…è‡ªå®šä¹‰input source æ¥ä¸å…¶ä»–çº¿ç¨‹é€šä¿¡</li>
<li>ä½¿ç”¨NSTimer</li>
<li>ä½¿ç”¨performSelector</li>
<li>çº¿ç¨‹ä¿æ´»</li>
<li>ç³»ç»Ÿé»˜è®¤ä½¿ç”¨</li>
</ul>
<h4 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h4><p>æºç ä¸‹è½½<a href="https://opensource.apple.com/tarballs/CF/" target="_blank" rel="noopener">https://opensource.apple.com/tarballs/CF/</a></p>
<h5 id="Input-Source-amp-amp-CFRunLoopSource-çš„ç»“æ„"><a href="#Input-Source-amp-amp-CFRunLoopSource-çš„ç»“æ„" class="headerlink" title="Input Source &amp;&amp; CFRunLoopSource çš„ç»“æ„"></a>Input Source &amp;&amp; CFRunLoopSource çš„ç»“æ„</h5><ul>
<li>source0/è‡ªå®šä¹‰ source</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">typedef struct &#123;</div><div class="line">    CFIndex	version;</div><div class="line">    void *	info;</div><div class="line">    const void *(*retain)(const void *info);</div><div class="line">    void	(*release)(const void *info);</div><div class="line">    CFStringRef	(*copyDescription)(const void *info);</div><div class="line">    Boolean	(*equal)(const void *info1, const void *info2);</div><div class="line">    CFHashCode	(*hash)(const void *info);</div><div class="line">    void	(*schedule)(void *info, CFRunLoopRef rl, CFStringRef mode);</div><div class="line">    void	(*cancel)(void *info, CFRunLoopRef rl, CFStringRef mode);</div><div class="line">    void	(*perform)(void *info);</div><div class="line">&#125; CFRunLoopSourceContext;</div></pre></td></tr></table></figure>
<ul>
<li>source1/(mach port source+è‡ªå®šä¹‰ source)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">typedef struct &#123;</div><div class="line">    CFIndex	version;</div><div class="line">    void *	info;</div><div class="line">    const void *(*retain)(const void *info);</div><div class="line">    void	(*release)(const void *info);</div><div class="line">    CFStringRef	(*copyDescription)(const void *info);</div><div class="line">    Boolean	(*equal)(const void *info1, const void *info2);</div><div class="line">    CFHashCode	(*hash)(const void *info);</div><div class="line">#if (TARGET_OS_MAC &amp;&amp; !(TARGET_OS_EMBEDDED || TARGET_OS_IPHONE)) || (TARGET_OS_EMBEDDED || TARGET_OS_IPHONE)</div><div class="line">    mach_port_t	(*getPort)(void *info);</div><div class="line">    void *	(*perform)(void *msg, CFIndex size, CFAllocatorRef allocator, void *info);</div><div class="line">#else</div><div class="line">    void *	(*getPort)(void *info);</div><div class="line">    void	(*perform)(void *info);</div><div class="line">#endif</div><div class="line">&#125; CFRunLoopSourceContext1;</div></pre></td></tr></table></figure>
<ul>
<li>CFRunLoopSource</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">struct __CFRunLoopSource &#123;</div><div class="line">    CFRuntimeBase _base;</div><div class="line">    uint32_t _bits;</div><div class="line">    pthread_mutex_t _lock;</div><div class="line">    CFIndex _order;			/* immutable */</div><div class="line">    CFMutableBagRef _runLoops;</div><div class="line">    union &#123;</div><div class="line">	CFRunLoopSourceContext version0;	/* immutable, except invalidation */</div><div class="line">        CFRunLoopSourceContext1 version1;	/* immutable, except invalidation */</div><div class="line">    &#125; _context;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h5 id="observer-amp-amp-CFRunLoopObserver-çš„ç»“æ„"><a href="#observer-amp-amp-CFRunLoopObserver-çš„ç»“æ„" class="headerlink" title="observer &amp;&amp; CFRunLoopObserver çš„ç»“æ„"></a>observer &amp;&amp; CFRunLoopObserver çš„ç»“æ„</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">typedef struct &#123;</div><div class="line">    CFIndex	version;</div><div class="line">    void *	info;</div><div class="line">    const void *(*retain)(const void *info);</div><div class="line">    void	(*release)(const void *info);</div><div class="line">    CFStringRef	(*copyDescription)(const void *info);</div><div class="line">&#125; CFRunLoopObserverContext;</div><div class="line"></div><div class="line">struct __CFRunLoopObserver &#123;</div><div class="line">    CFRuntimeBase _base;</div><div class="line">    pthread_mutex_t _lock;</div><div class="line">    CFRunLoopRef _runLoop;</div><div class="line">    CFIndex _rlCount;</div><div class="line">    CFOptionFlags _activities;		/* immutable */</div><div class="line">    CFIndex _order;			/* immutable */</div><div class="line">    CFRunLoopObserverCallBack _callout;	/* immutable */</div><div class="line">    CFRunLoopObserverContext _context;	/* immutable, except invalidation */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h5 id="NSTimer-amp-amp-CFRunloopTimer-çš„ç»“æ„"><a href="#NSTimer-amp-amp-CFRunloopTimer-çš„ç»“æ„" class="headerlink" title="NSTimer &amp;&amp; CFRunloopTimer çš„ç»“æ„"></a>NSTimer &amp;&amp; CFRunloopTimer çš„ç»“æ„</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">typedef struct &#123;</div><div class="line">    CFIndex	version;</div><div class="line">    void *	info;</div><div class="line">    const void *(*retain)(const void *info);</div><div class="line">    void	(*release)(const void *info);</div><div class="line">    CFStringRef	(*copyDescription)(const void *info);</div><div class="line">&#125; CFRunLoopTimerContext;</div><div class="line"></div><div class="line">struct __CFRunLoopTimer &#123;</div><div class="line">    CFRuntimeBase _base;</div><div class="line">    uint16_t _bits;</div><div class="line">    pthread_mutex_t _lock;</div><div class="line">    CFRunLoopRef _runLoop;</div><div class="line">    CFMutableSetRef _rlModes;</div><div class="line">    CFAbsoluteTime _nextFireDate;</div><div class="line">    CFTimeInterval _interval;		/* immutable */</div><div class="line">    CFTimeInterval _tolerance;          /* mutable */</div><div class="line">    uint64_t _fireTSR;			/* TSR units */</div><div class="line">    CFIndex _order;			/* immutable */</div><div class="line">    CFRunLoopTimerCallBack _callout;	/* immutable */</div><div class="line">    CFRunLoopTimerContext _context;	/* immutable, except invalidation */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h5 id="Mode-çš„ç»“æ„"><a href="#Mode-çš„ç»“æ„" class="headerlink" title="Mode çš„ç»“æ„"></a>Mode çš„ç»“æ„</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">struct __CFRunLoopMode &#123;</div><div class="line">    CFRuntimeBase _base;</div><div class="line">    pthread_mutex_t _lock;	/* must have the run loop locked before locking this */</div><div class="line">    CFStringRef _name;</div><div class="line">    Boolean _stopped;</div><div class="line">    char _padding[3];</div><div class="line">    CFMutableSetRef _sources0;</div><div class="line">    CFMutableSetRef _sources1;</div><div class="line">    CFMutableArrayRef _observers;</div><div class="line">    CFMutableArrayRef _timers;</div><div class="line">    CFMutableDictionaryRef _portToV1SourceMap;</div><div class="line">    __CFPortSet _portSet;</div><div class="line">    CFIndex _observerMask;</div><div class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</div><div class="line">    dispatch_source_t _timerSource;</div><div class="line">    dispatch_queue_t _queue;</div><div class="line">    Boolean _timerFired; // set to true by the source when a timer has fired</div><div class="line">    Boolean _dispatchTimerArmed;</div><div class="line">#endif</div><div class="line">#if USE_MK_TIMER_TOO</div><div class="line">    mach_port_t _timerPort;//å¦‚æœæ˜¯MK_TIMERçš„è¯ï¼Œä¼šé€šè¿‡è¿™ä¸ªç«¯å£å”¤é†’çº¿ç¨‹</div><div class="line">    Boolean _mkTimerArmed;</div><div class="line">#endif</div><div class="line">#if DEPLOYMENT_TARGET_WINDOWS</div><div class="line">    DWORD _msgQMask;</div><div class="line">    void (*_msgPump)(void);</div><div class="line">#endif</div><div class="line">    uint64_t _timerSoftDeadline; /* TSR */</div><div class="line">    uint64_t _timerHardDeadline; /* TSR */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="runloop-çš„ç»“æ„"><a href="#runloop-çš„ç»“æ„" class="headerlink" title="runloop çš„ç»“æ„"></a>runloop çš„ç»“æ„</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">struct _block_item &#123;</div><div class="line">    struct _block_item *_next;</div><div class="line">    CFTypeRef _mode;	// CFString or CFSet</div><div class="line">    void (^_block)(void);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">typedef struct _per_run_data &#123;</div><div class="line">    uint32_t a;</div><div class="line">    uint32_t b;</div><div class="line">    uint32_t stopped;</div><div class="line">    uint32_t ignoreWakeUps;</div><div class="line">&#125; _per_run_data;</div><div class="line"></div><div class="line">struct __CFRunLoop &#123;</div><div class="line">    CFRuntimeBase _base;</div><div class="line">    pthread_mutex_t _lock;			/* locked for accessing mode list */</div><div class="line">    __CFPort _wakeUpPort;			// used for CFRunLoopWakeUp source0çš„æ‰‹åŠ¨å”¤é†’å°±æ˜¯é€šè¿‡ç»™è¿™ä¸ªç«¯å£å‘æ¶ˆæ¯å®ç°çš„ã€‚</div><div class="line">    Boolean _unused;</div><div class="line">    </div><div class="line">    volatile _per_run_data *_perRunData;              // reset for runs of the run  loop ä¸ªäººç†è§£ä¸ºrunloopçš„ä¸€ä¸ªé…ç½®æ–‡ä»¶</div><div class="line">    </div><div class="line">    pthread_t _pthread;</div><div class="line">    uint32_t _winthread;</div><div class="line">    </div><div class="line">    CFMutableSetRef _commonModes;//å­˜æ”¾ common mode çš„é›†åˆ</div><div class="line">    CFMutableSetRef _commonModeItems;//æ¯ä¸ª common mode éƒ½æœ‰çš„ item (source, timer and observer) é›†åˆ</div><div class="line">    </div><div class="line">    CFRunLoopModeRef _currentMode;</div><div class="line">    CFMutableSetRef _modes;//è¿™ä¸ª run loop æ‰€æœ‰çš„ mode é›†åˆ</div><div class="line">    </div><div class="line">    struct _block_item *_blocks_head;</div><div class="line">    struct _block_item *_blocks_tail;</div><div class="line">    </div><div class="line">    </div><div class="line">    CFAbsoluteTime _runTime;</div><div class="line">    CFAbsoluteTime _sleepTime;</div><div class="line">    CFTypeRef _counterpart;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="Runloopçš„åˆ›å»ºå’Œé”€æ¯-CFRunLoopCreate-amp-amp-CFRunLoopGet0-amp-amp-CFRunLoopGetMain-amp-amp-CFRunLoopGetCurrent-amp-amp-CFFinalizeRunLoop"><a href="#Runloopçš„åˆ›å»ºå’Œé”€æ¯-CFRunLoopCreate-amp-amp-CFRunLoopGet0-amp-amp-CFRunLoopGetMain-amp-amp-CFRunLoopGetCurrent-amp-amp-CFFinalizeRunLoop" class="headerlink" title="Runloopçš„åˆ›å»ºå’Œé”€æ¯ CFRunLoopCreate() &amp;&amp; CFRunLoopGet0() &amp;&amp; CFRunLoopGetMain() &amp;&amp; CFRunLoopGetCurrent() &amp;&amp; CFFinalizeRunLoop()"></a>Runloopçš„åˆ›å»ºå’Œé”€æ¯ CFRunLoopCreate() &amp;&amp; CFRunLoopGet0() &amp;&amp; CFRunLoopGetMain() &amp;&amp; CFRunLoopGetCurrent() &amp;&amp; CFFinalizeRunLoop()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">//è·å–ä¸»çº¿ç¨‹runloop</div><div class="line">CFRunLoopRef CFRunLoopGetMain(void) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    static CFRunLoopRef __main = NULL; // no retain needed</div><div class="line">    if (!__main) __main = _CFRunLoopGet0(pthread_main_thread_np()); // no CAS needed</div><div class="line">    return __main;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//è·å–å½“å‰çº¿ç¨‹runloop</div><div class="line">CFRunLoopRef CFRunLoopGetCurrent(void) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    CFRunLoopRef rl = (CFRunLoopRef)_CFGetTSD(__CFTSDKeyRunLoop);</div><div class="line">    if (rl) return rl;</div><div class="line">    return _CFRunLoopGet0(pthread_self());</div><div class="line">&#125;</div><div class="line"></div><div class="line">//ä¿å­˜runloopå’Œpthreadçš„å…¨å±€å­—å…¸ã€‚key = pthreadPointer(t); value = runloop.</div><div class="line">static CFMutableDictionaryRef __CFRunLoops = NULL;</div><div class="line">static CFLock_t loopsLock = CFLockInit;</div><div class="line"></div><div class="line">CF_EXPORT CFRunLoopRef _CFRunLoopGet0(pthread_t t) &#123;</div><div class="line"></div><div class="line">	//å¦‚æœå½“å‰çº¿ç¨‹ä¸º0 åˆ™å–ä¸»çº¿ç¨‹.</div><div class="line">    if (pthread_equal(t, kNilPthreadT)) &#123;</div><div class="line">	t = pthread_main_thread_np();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    __CFLock(&amp;loopsLock);</div><div class="line">    </div><div class="line">    //å…¨å±€å­—å…¸ä¸ºç©ºï¼Œåˆ™åˆ›å»ºå­—å…¸</div><div class="line">    if (!__CFRunLoops) &#123;</div><div class="line">        __CFUnlock(&amp;loopsLock);</div><div class="line">	CFMutableDictionaryRef dict = CFDictionaryCreateMutable(kCFAllocatorSystemDefault, 0, NULL, &amp;kCFTypeDictionaryValueCallBacks);</div><div class="line"></div><div class="line">	//åˆ›å»ºä¸»çº¿ç¨‹çš„runloop</div><div class="line">	CFRunLoopRef mainLoop = __CFRunLoopCreate(pthread_main_thread_np());</div><div class="line"></div><div class="line">	//å°†runloopå’Œpthread setåˆ°ä¸€ä¸ªä¸´æ—¶å­—å…¸ä¸­</div><div class="line">	CFDictionarySetValue(dict, pthreadPointer(pthread_main_thread_np()), mainLoop);</div><div class="line">	</div><div class="line">	//å°†ä¸´æ—¶å­—å…¸å¤åˆ¶åˆ°å…¨å±€å­—å…¸ï¼Œè¿™ä¸ªæ˜¯ä¸€ä¸ªåŸå­æ“ä½œã€‚</div><div class="line">	if (!OSAtomicCompareAndSwapPtrBarrier(NULL, dict, (void * volatile *)&amp;__CFRunLoops)) &#123;</div><div class="line">	    CFRelease(dict);</div><div class="line">	&#125;</div><div class="line">	CFRelease(mainLoop);</div><div class="line">        __CFLock(&amp;loopsLock);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //ä»å…¨å±€å­—å…¸ä¸­å–å‡ºå½“å‰çº¿ç¨‹å¯¹åº”çš„runloop</div><div class="line">    CFRunLoopRef loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));</div><div class="line">    __CFUnlock(&amp;loopsLock);</div><div class="line">    </div><div class="line">    //å¦‚æœrunloopä¸ºç©ºï¼Œæ–°å»ºrunloop,å¹¶ä¿å­˜åˆ°å…¨å±€å­—å…¸ä¸­</div><div class="line">    if (!loop) &#123;</div><div class="line">	CFRunLoopRef newLoop = __CFRunLoopCreate(t);</div><div class="line">        __CFLock(&amp;loopsLock);</div><div class="line">	loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));</div><div class="line">	if (!loop) &#123;</div><div class="line">	    CFDictionarySetValue(__CFRunLoops, pthreadPointer(t), newLoop);</div><div class="line">	    loop = newLoop;</div><div class="line">	&#125;</div><div class="line">        // don&apos;t release run loops inside the loopsLock, because CFRunLoopDeallocate may end up taking it</div><div class="line">        __CFUnlock(&amp;loopsLock);</div><div class="line">	CFRelease(newLoop);</div><div class="line">    &#125;</div><div class="line">    if (pthread_equal(t, pthread_self())) &#123;</div><div class="line">        _CFSetTSD(__CFTSDKeyRunLoop, (void *)loop, NULL);</div><div class="line">        if (0 == _CFGetTSD(__CFTSDKeyRunLoopCntr)) &#123;</div><div class="line">            _CFSetTSD(__CFTSDKeyRunLoopCntr, (void *)(PTHREAD_DESTRUCTOR_ITERATIONS-1), (void (*)(void *))__CFFinalizeRunLoop);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return loop;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//å…¥å‚ä¸ºä¸€ä¸ªçº¿ç¨‹</div><div class="line">static CFRunLoopRef __CFRunLoopCreate(pthread_t t) &#123;</div><div class="line">    CFRunLoopRef loop = NULL;</div><div class="line">    CFRunLoopModeRef rlm;</div><div class="line">    uint32_t size = sizeof(struct __CFRunLoop) - sizeof(CFRuntimeBase);</div><div class="line">    </div><div class="line">    //åˆ›å»ºrunloopå®ä¾‹</div><div class="line">    loop = (CFRunLoopRef)_CFRuntimeCreateInstance(kCFAllocatorSystemDefault, CFRunLoopGetTypeID(), size, NULL);</div><div class="line">    if (NULL == loop) &#123;</div><div class="line">	return NULL;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //åˆå§‹åŒ–é…ç½®</div><div class="line">    (void)__CFRunLoopPushPerRunData(loop);</div><div class="line">    __CFRunLoopLockInit(&amp;loop-&gt;_lock);</div><div class="line"></div><div class="line">	//åˆå§‹åŒ–å”¤é†’port</div><div class="line">    loop-&gt;_wakeUpPort = __CFPortAllocate();</div><div class="line">    if (CFPORT_NULL == loop-&gt;_wakeUpPort) HALT;</div><div class="line">    __CFRunLoopSetIgnoreWakeUps(loop);</div><div class="line">    </div><div class="line">    //åˆå§‹åŒ–commonModes å¹¶ add kCFRunLoopDefaultMode</div><div class="line">    loop-&gt;_commonModes = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</div><div class="line">    CFSetAddValue(loop-&gt;_commonModes, kCFRunLoopDefaultMode);</div><div class="line">    </div><div class="line">    //åˆå§‹åŒ–å…¶ä»–å˜é‡</div><div class="line">    loop-&gt;_commonModeItems = NULL;</div><div class="line">    loop-&gt;_currentMode = NULL;</div><div class="line">    loop-&gt;_modes = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</div><div class="line">    loop-&gt;_blocks_head = NULL;</div><div class="line">    loop-&gt;_blocks_tail = NULL;</div><div class="line">    loop-&gt;_counterpart = NULL;</div><div class="line">    </div><div class="line">    //ç»‘å®šçº¿ç¨‹</div><div class="line">    loop-&gt;_pthread = t;</div><div class="line">#if DEPLOYMENT_TARGET_WINDOWS</div><div class="line">    loop-&gt;_winthread = GetCurrentThreadId();</div><div class="line">#else</div><div class="line">    loop-&gt;_winthread = 0;</div><div class="line">#endif</div><div class="line">    rlm = __CFRunLoopFindMode(loop, kCFRunLoopDefaultMode, true);</div><div class="line">    if (NULL != rlm) __CFRunLoopModeUnlock(rlm);</div><div class="line">    return loop;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">// çº¿ç¨‹é€€å‡ºæ—¶è°ƒç”¨</div><div class="line">CF_PRIVATE void __CFFinalizeRunLoop(uintptr_t data) &#123;</div><div class="line">    CFRunLoopRef rl = NULL;</div><div class="line">    if (data &lt;= 1) &#123;</div><div class="line">	__CFLock(&amp;loopsLock);</div><div class="line">	if (__CFRunLoops) &#123;</div><div class="line">		</div><div class="line">		//åœ¨å…¨å±€å­—å…¸ä¸­ç§»é™¤è¯¥runloop</div><div class="line">	    rl = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(pthread_self()));</div><div class="line">	    if (rl) CFRetain(rl);</div><div class="line">	    CFDictionaryRemoveValue(__CFRunLoops, pthreadPointer(pthread_self()));</div><div class="line">	&#125;</div><div class="line">	__CFUnlock(&amp;loopsLock);</div><div class="line">    &#125; else &#123;</div><div class="line">        _CFSetTSD(__CFTSDKeyRunLoopCntr, (void *)(data - 1), (void (*)(void *))__CFFinalizeRunLoop);</div><div class="line">    &#125;</div><div class="line">    if (rl &amp;&amp; CFRunLoopGetMain() != rl) &#123; // protect against cooperative threads</div><div class="line">        if (NULL != rl-&gt;_counterpart) &#123;</div><div class="line">            CFRelease(rl-&gt;_counterpart);</div><div class="line">	    rl-&gt;_counterpart = NULL;</div><div class="line">        &#125;</div><div class="line">	// purge all sources before deallocation</div><div class="line">        CFArrayRef array = CFRunLoopCopyAllModes(rl);</div><div class="line">        </div><div class="line">        //ç§»é™¤è¯¥runloopçš„æ‰€æœ‰source</div><div class="line">        for (CFIndex idx = CFArrayGetCount(array); idx--;) &#123;</div><div class="line">            CFStringRef modeName = (CFStringRef)CFArrayGetValueAtIndex(array, idx);</div><div class="line">            __CFRunLoopRemoveAllSources(rl, modeName);</div><div class="line">        &#125;</div><div class="line">        __CFRunLoopRemoveAllSources(rl, kCFRunLoopCommonModes);</div><div class="line">        CFRelease(array);</div><div class="line">    &#125;</div><div class="line">    if (rl) CFRelease(rl);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><ul>
<li>runloopçš„åˆ›å»ºæ˜¯æ‡’åŠ è½½çš„æ–¹å¼åˆ›å»ºï¼Œåœ¨ç¬¬ä¸€æ¬¡è·å–è¯¥runloopçš„æ—¶å€™æ‰ä¼šå»åˆ›å»ºï¼Œæ‰€ä»¥å­çº¿ç¨‹å¦‚æœæ²¡æœ‰æ‰‹åŠ¨çš„å»è·å–å¹¶è¿è¡Œrunloop,æ˜¯ä¸ä¼šè‡ªåŠ¨åˆ›å»ºçš„ã€‚</li>
<li>runloopå’Œçº¿ç¨‹æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„å­—å…¸ä¸­ã€‚keyæ˜¯çº¿ç¨‹çš„æŒ‡é’ˆï¼Œvalueæ˜¯å¯¹åº”çš„runloop.</li>
<li>runloopçš„é”€æ¯å‘ç”Ÿåœ¨çº¿ç¨‹é€€å‡ºæ—¶ã€‚</li>
</ul>
<h4 id="Runloopçš„è¿è¡Œ-CFRunLoopRun-amp-amp-CFRunLoopRunSpecific-amp-amp-CFRunLoopRun"><a href="#Runloopçš„è¿è¡Œ-CFRunLoopRun-amp-amp-CFRunLoopRunSpecific-amp-amp-CFRunLoopRun" class="headerlink" title="Runloopçš„è¿è¡Œ CFRunLoopRun &amp;&amp; CFRunLoopRunSpecific &amp;&amp; CFRunLoopRun"></a>Runloopçš„è¿è¡Œ CFRunLoopRun &amp;&amp; CFRunLoopRunSpecific &amp;&amp; CFRunLoopRun</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div></pre></td><td class="code"><pre><div class="line">struct __timeout_context &#123;</div><div class="line">    dispatch_source_t ds;</div><div class="line">    CFRunLoopRef rl;</div><div class="line">    uint64_t termTSR;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">static void __CFRunLoopTimeoutCancel(void *arg) &#123;</div><div class="line">    struct __timeout_context *context = (struct __timeout_context *)arg;</div><div class="line">    CFRelease(context-&gt;rl);</div><div class="line">    dispatch_release(context-&gt;ds);</div><div class="line">    free(context);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static void __CFRunLoopTimeout(void *arg) &#123;</div><div class="line">    struct __timeout_context *context = (struct __timeout_context *)arg;</div><div class="line">    context-&gt;termTSR = 0ULL;</div><div class="line">    CFRUNLOOP_WAKEUP_FOR_TIMEOUT();</div><div class="line">    CFRunLoopWakeUp(context-&gt;rl);</div><div class="line">    // The interval is DISPATCH_TIME_FOREVER, so this won&apos;t fire again</div><div class="line">&#125;</div><div class="line"></div><div class="line">void CFRunLoopRun(void) &#123;	/* DOES CALLOUT */</div><div class="line">    int32_t result;</div><div class="line">    do &#123;</div><div class="line">        result = CFRunLoopRunSpecific(CFRunLoopGetCurrent(), kCFRunLoopDefaultMode, 1.0e10, false);</div><div class="line">        CHECK_FOR_FORK();</div><div class="line">    &#125; while (kCFRunLoopRunStopped != result &amp;&amp; kCFRunLoopRunFinished != result);</div><div class="line">&#125;</div><div class="line"></div><div class="line">SInt32 CFRunLoopRunSpecific(CFRunLoopRef rl, CFStringRef modeName, CFTimeInterval seconds, Boolean returnAfterSourceHandled) &#123;     /* DOES CALLOUT */</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    if (__CFRunLoopIsDeallocating(rl)) return kCFRunLoopRunFinished;</div><div class="line">    __CFRunLoopLock(rl);</div><div class="line">    CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, modeName, false);</div><div class="line">    if (NULL == currentMode || __CFRunLoopModeIsEmpty(rl, currentMode, rl-&gt;_currentMode)) &#123;</div><div class="line">	Boolean did = false;</div><div class="line">	if (currentMode) __CFRunLoopModeUnlock(currentMode);</div><div class="line">	__CFRunLoopUnlock(rl);</div><div class="line">	return did ? kCFRunLoopRunHandledSource : kCFRunLoopRunFinished;</div><div class="line">    &#125;</div><div class="line">    volatile _per_run_data *previousPerRun = __CFRunLoopPushPerRunData(rl);</div><div class="line">    CFRunLoopModeRef previousMode = rl-&gt;_currentMode;</div><div class="line">    rl-&gt;_currentMode = currentMode;</div><div class="line">    int32_t result = kCFRunLoopRunFinished;</div><div class="line"></div><div class="line">	// 1.é€šçŸ¥è§‚å¯Ÿè€…runloopå³å°†è¿›å…¥loop</div><div class="line">	if (currentMode-&gt;_observerMask &amp; kCFRunLoopEntry ) __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopEntry);</div><div class="line">	</div><div class="line">	//run</div><div class="line">	result = __CFRunLoopRun(rl, currentMode, seconds, returnAfterSourceHandled, previousMode);</div><div class="line">	</div><div class="line">	// 10. é€šçŸ¥è§‚å¯Ÿè€…runLoopå³å°†é€€å‡º</div><div class="line">	if (currentMode-&gt;_observerMask &amp; kCFRunLoopExit ) __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopExit);</div><div class="line"></div><div class="line">        __CFRunLoopModeUnlock(currentMode);</div><div class="line">        __CFRunLoopPopPerRunData(rl, previousPerRun);</div><div class="line">	rl-&gt;_currentMode = previousMode;</div><div class="line">    __CFRunLoopUnlock(rl);</div><div class="line">    return result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">/**</div><div class="line"> *  è¿è¡Œrun loop</div><div class="line"> *</div><div class="line"> *  @param rl              è¿è¡Œçš„RunLoopå¯¹è±¡</div><div class="line"> *  @param rlm             è¿è¡Œçš„mode</div><div class="line"> *  @param seconds         run loopè¶…æ—¶æ—¶é—´</div><div class="line"> *  @param stopAfterHandle true:run loopå¤„ç†å®Œäº‹ä»¶å°±é€€å‡º  false:ä¸€ç›´è¿è¡Œç›´åˆ°è¶…æ—¶æˆ–è€…è¢«æ‰‹åŠ¨ç»ˆæ­¢</div><div class="line"> *  @param previousMode    ä¸Šä¸€æ¬¡è¿è¡Œçš„mode</div><div class="line"> *</div><div class="line"> *  @return è¿”å›4ç§çŠ¶æ€</div><div class="line"> */</div><div class="line">static int32_t __CFRunLoopRun(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFTimeInterval seconds, Boolean stopAfterHandle, CFRunLoopModeRef previousMode) &#123;</div><div class="line"></div><div class="line">	</div><div class="line">    uint64_t startTSR = mach_absolute_time();</div><div class="line">    </div><div class="line">    //å¦‚æœè¯¥runloopå·²åœæ­¢ï¼Œç›´æ¥é€€å‡ºã€‚</div><div class="line">    if (__CFRunLoopIsStopped(rl)) &#123;</div><div class="line">        __CFRunLoopUnsetStopped(rl);</div><div class="line">	return kCFRunLoopRunStopped;</div><div class="line">    &#125; else if (rlm-&gt;_stopped) &#123;</div><div class="line">	rlm-&gt;_stopped = false;</div><div class="line">	return kCFRunLoopRunStopped;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    //è·å–GCDçš„æ¶ˆæ¯ç«¯å£</div><div class="line">    mach_port_name_t dispatchPort = MACH_PORT_NULL;</div><div class="line">    Boolean libdispatchQSafe = pthread_main_np() &amp;&amp; ((HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; NULL == previousMode) || (!HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; 0 == _CFGetTSD(__CFTSDKeyIsInGCDMainQ)));</div><div class="line">    </div><div class="line">    //çœ‹åˆ¤æ–­æ¡ä»¶ï¼Œåªæœ‰å½“å‰æ˜¯ä¸»çº¿ç¨‹ï¼Œæ‰è·å–ç«¯å£ã€‚ï¼ˆGCDåªèƒ½å”¤é†’ä¸»çº¿ç¨‹çš„runloopï¼‰</div><div class="line">    if (libdispatchQSafe &amp;&amp; (CFRunLoopGetMain() == rl) &amp;&amp; CFSetContainsValue(rl-&gt;_commonModes, rlm-&gt;_name)) dispatchPort = _dispatch_get_main_queue_port_4CF();</div><div class="line">    </div><div class="line">    //ä½¿ç”¨GCDçš„sourceæ¥å®ç°NSTimer</div><div class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</div><div class="line">    mach_port_name_t modeQueuePort = MACH_PORT_NULL;</div><div class="line">    if (rlm-&gt;_queue) &#123;</div><div class="line">        modeQueuePort = _dispatch_runloop_root_queue_get_port_4CF(rlm-&gt;_queue);</div><div class="line">        if (!modeQueuePort) &#123;</div><div class="line">            CRASH(&quot;Unable to get port for run loop mode queue (%d)&quot;, -1);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">#endif</div><div class="line">    </div><div class="line">    //è®¾ç½®runloopçš„è¶…æ—¶æ—¶é—´ï¼Œsecondæ˜¯å‚æ•°ã€‚</div><div class="line">    dispatch_source_t timeout_timer = NULL;</div><div class="line">    struct __timeout_context *timeout_context = (struct __timeout_context *)malloc(sizeof(*timeout_context));</div><div class="line">    if (seconds &lt;= 0.0) &#123; // instant timeout</div><div class="line">        seconds = 0.0;</div><div class="line">        timeout_context-&gt;termTSR = 0ULL;</div><div class="line">    &#125; else if (seconds &lt;= TIMER_INTERVAL_LIMIT) &#123;</div><div class="line">	dispatch_queue_t queue = pthread_main_np() ? __CFDispatchQueueGetGenericMatchingMain() : __CFDispatchQueueGetGenericBackground();</div><div class="line">	timeout_timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue);</div><div class="line">        dispatch_retain(timeout_timer);</div><div class="line">	timeout_context-&gt;ds = timeout_timer;</div><div class="line">	timeout_context-&gt;rl = (CFRunLoopRef)CFRetain(rl);</div><div class="line">	timeout_context-&gt;termTSR = startTSR + __CFTimeIntervalToTSR(seconds);</div><div class="line">	dispatch_set_context(timeout_timer, timeout_context); // source gets ownership of context</div><div class="line">	</div><div class="line">	//è°ƒç”¨__CFRunLoopTimeout</div><div class="line">	dispatch_source_set_event_handler_f(timeout_timer, __CFRunLoopTimeout);</div><div class="line">        dispatch_source_set_cancel_handler_f(timeout_timer, __CFRunLoopTimeoutCancel);</div><div class="line">        uint64_t ns_at = (uint64_t)((__CFTSRToTimeInterval(startTSR) + seconds) * 1000000000ULL);</div><div class="line">        dispatch_source_set_timer(timeout_timer, dispatch_time(1, ns_at), DISPATCH_TIME_FOREVER, 1000ULL);</div><div class="line">        dispatch_resume(timeout_timer);</div><div class="line">    &#125; else &#123; // infinite timeout</div><div class="line">        seconds = 9999999999.0;</div><div class="line">        timeout_context-&gt;termTSR = UINT64_MAX;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	//åˆå§‹åŒ–ä¸ºtrue</div><div class="line">    Boolean didDispatchPortLastTime = true;</div><div class="line">    int32_t retVal = 0;//è¿”å›çŠ¶æ€</div><div class="line">    </div><div class="line">    //do whileå¾ªç¯</div><div class="line">    do &#123;</div><div class="line">    </div><div class="line">    //runloopç¡çœ çš„æ—¶å€™ä¼šæ³¨å†Œè¿™ä¸ªç«¯å£ç”¨æ¥æ¥å£æ¶ˆæ¯    </div><div class="line">	__CFPortSet waitSet = rlm-&gt;_portSet;</div><div class="line"></div><div class="line">	// è®¾ç½®RunLoopä¸ºå¯ä»¥è¢«å”¤é†’çŠ¶æ€</div><div class="line">        __CFRunLoopUnsetIgnoreWakeUps(rl);</div><div class="line"></div><div class="line">	// 2.é€šçŸ¥observerï¼Œå³å°†è§¦å‘timerå›è°ƒï¼Œå¤„ç†timeräº‹ä»¶</div><div class="line">        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeTimers) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeTimers);</div><div class="line">        </div><div class="line">   	// 3.é€šçŸ¥observerï¼Œå³å°†è§¦å‘Source0å›è°ƒ</div><div class="line">        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeSources) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeSources);</div><div class="line"></div><div class="line"></div><div class="line">	// æ‰§è¡ŒåŠ å…¥å½“å‰ runloop çš„ block</div><div class="line">	__CFRunLoopDoBlocks(rl, rlm);</div><div class="line">	</div><div class="line">	 	 // 4.å¤„ç† source0 äº‹ä»¶ æœ‰äº‹ä»¶å¤„ç†è¿”å› trueï¼Œæ²¡æœ‰äº‹ä»¶è¿”å› false</div><div class="line">        Boolean sourceHandledThisLoop = __CFRunLoopDoSources0(rl, rlm, stopAfterHandle);</div><div class="line">        </div><div class="line">        // å¦‚æœå®é™…å¤„ç†äº† sources 0ï¼Œå†ä¸€æ¬¡å¤„ç† blocksï¼ˆæœ‰å¯èƒ½æ˜¯source0çš„å›è°ƒä¸­åˆç»™runloopæ·»åŠ äº†blockï¼‰</div><div class="line">        if (sourceHandledThisLoop) &#123;</div><div class="line">            __CFRunLoopDoBlocks(rl, rlm);</div><div class="line">			&#125;</div><div class="line">		</div><div class="line">		 // å¦‚æœæ²¡æœ‰ Sources0 äº‹ä»¶å¤„ç† å¹¶ä¸” æ²¡æœ‰è¶…æ—¶ï¼Œpoll ä¸º false</div><div class="line">        // å¦‚æœæœ‰ Sources0 äº‹ä»¶å¤„ç† æˆ–è€… è¶…æ—¶ï¼Œpoll éƒ½ä¸º true</div><div class="line">        Boolean poll = sourceHandledThisLoop || (0ULL == timeout_context-&gt;termTSR);</div><div class="line">        </div><div class="line">         if (MACH_PORT_NULL != dispatchPort &amp;&amp; !didDispatchPortLastTime) &#123;</div><div class="line"></div><div class="line">         //å¦‚æœæ”¶åˆ°source1çš„æ¶ˆæ¯</div><div class="line">            msg = (mach_msg_header_t *)msg_buffer;</div><div class="line">            if (__CFRunLoopServiceMachPort(dispatchPort, &amp;msg, sizeof(msg_buffer), &amp;livePort, 0, &amp;voucherState, NULL)) &#123;</div><div class="line">                goto handle_msg;    </div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        didDispatchPortLastTime = false;</div><div class="line"></div><div class="line">	// 6.é€šçŸ¥è§‚å¯Ÿè€…RunLoopå³å°†è¿›å…¥ä¼‘çœ </div><div class="line">	if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeWaiting)) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeWaiting);</div><div class="line">	</div><div class="line">	 // 7.è®¾ç½®RunLoopä¸ºä¼‘çœ çŠ¶æ€</div><div class="line">	__CFRunLoopSetSleeping(rl);</div><div class="line">	</div><div class="line">	// do not do any user callouts after this point (after notifying of sleeping)</div><div class="line"></div><div class="line">        // Must push the local-to-this-activation ports in on every loop</div><div class="line">        // iteration, as this mode could be run re-entrantly and we don&apos;t</div><div class="line">        // want these ports to get serviced.</div><div class="line"></div><div class="line">	//å°†ç¡çœ ç­‰å¾…ç«¯å£æ·»åŠ åˆ°å½“å‰mach portæ´»è·ƒåˆ—è¡¨</div><div class="line">        __CFPortSetInsert(dispatchPort, waitSet);</div><div class="line">        </div><div class="line">	__CFRunLoopModeUnlock(rlm);</div><div class="line">	__CFRunLoopUnlock(rl);</div><div class="line"></div><div class="line">		//è®°å½•å¼€å§‹ç¡çœ æ—¶é—´</div><div class="line">        CFAbsoluteTime sleepStart = poll ? 0.0 : CFAbsoluteTimeGetCurrent();</div><div class="line"></div><div class="line"></div><div class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</div><div class="line"></div><div class="line">		// ç­‰å¾…è¢«å”¤é†’ï¼Œå¯ä»¥è¢« sources0ã€source1ã€Mach port source,timersã€CFRunLoopWakeUp å‡½æ•°å’Œ GCD äº‹ä»¶ï¼ˆå¦‚æœåœ¨ä¸»çº¿ç¨‹ï¼‰</div><div class="line">        do &#123;</div><div class="line">        </div><div class="line">        	  //æ¸…ç†æ¶ˆæ¯ç¼“å­˜åŒº</div><div class="line">            if (kCFUseCollectableAllocator) &#123;</div><div class="line">                // objc_clear_stack(0);</div><div class="line">                // &lt;rdar://problem/16393959&gt;</div><div class="line">                memset(msg_buffer, 0, sizeof(msg_buffer));</div><div class="line">            &#125;</div><div class="line">            msg = (mach_msg_header_t *)msg_buffer;</div><div class="line">            </div><div class="line">            // æ¥æ”¶waitSetç«¯å£çš„æ¶ˆæ¯ </div><div class="line">            __CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort, poll ? 0 : TIMEOUT_INFINITY, &amp;voucherState, &amp;voucherCopy);</div><div class="line">            </div><div class="line">			  // å¦‚æœæ˜¯ timer ç«¯å£å”¤é†’çš„ï¼Œè¿›è¡Œä¸€ä¸‹å–„åå¤„ç†ï¼Œä¹‹åå†å¤„ç† timer</div><div class="line">            if (modeQueuePort != MACH_PORT_NULL &amp;&amp; livePort == modeQueuePort) &#123;</div><div class="line">                // Drain the internal queue. If one of the callout blocks sets the timerFired flag, break out and service the timer.</div><div class="line">                while (_dispatch_runloop_root_queue_perform_4CF(rlm-&gt;_queue));</div><div class="line">                if (rlm-&gt;_timerFired) &#123;</div><div class="line">                    // Leave livePort as the queue port, and service timers below</div><div class="line">                    rlm-&gt;_timerFired = false;</div><div class="line">                    break;</div><div class="line">                &#125; else &#123;</div><div class="line">                    if (msg &amp;&amp; msg != (mach_msg_header_t *)msg_buffer) free(msg);</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">            </div><div class="line">            	   // ä¸æ˜¯ timer ç«¯å£å”¤é†’çš„ï¼Œè·³å‡ºå¾ªç¯ï¼Œè¿›è¡Œæ¥ä¸‹æ¥çš„å¤„ç†</div><div class="line">                // Go ahead and leave the inner loop.</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">        &#125; while (1);</div><div class="line">#else</div><div class="line"></div><div class="line">		 // ä¸ä½¿ç”¨ GCD timer ä½œä¸º timer å®ç°çš„æƒ…å†µ</div><div class="line">		 </div><div class="line">        if (kCFUseCollectableAllocator) &#123;</div><div class="line">            // objc_clear_stack(0);</div><div class="line">            // &lt;rdar://problem/16393959&gt;</div><div class="line">            </div><div class="line">            //æ¸…ç†æ¶ˆæ¯ç¼“å­˜åŒº</div><div class="line">            memset(msg_buffer, 0, sizeof(msg_buffer));</div><div class="line">        &#125;</div><div class="line">        msg = (mach_msg_header_t *)msg_buffer;</div><div class="line">        __CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort, poll ? 0 : TIMEOUT_INFINITY, &amp;voucherState, &amp;voucherCopy);</div><div class="line">        </div><div class="line">#endif</div><div class="line">      </div><div class="line">      	 //è¢«å”¤é†’äº†ã€‚ã€‚ã€‚</div><div class="line">      	 </div><div class="line">        __CFRunLoopLock(rl);</div><div class="line">        __CFRunLoopModeLock(rlm);</div><div class="line"></div><div class="line">		  // è®°å½•å¢åŠ çš„ç¡çœ æ—¶é—´</div><div class="line">        rl-&gt;_sleepTime += (poll ? 0.0 : (CFAbsoluteTimeGetCurrent() - sleepStart));</div><div class="line"></div><div class="line">        // Must remove the local-to-this-activation ports in on every loop</div><div class="line">        // iteration, as this mode could be run re-entrantly and we don&apos;t</div><div class="line">        // want these ports to get serviced. Also, we don&apos;t want them left</div><div class="line">        // in there if this function returns.</div><div class="line"></div><div class="line">		 //å°†ç­‰å¾…å”¤é†’çš„ç«¯å£ä»mach portæ´»è·ƒç«¯å£åˆ—è¡¨ç§»é™¤</div><div class="line">        __CFPortSetRemove(dispatchPort, waitSet);</div><div class="line">        </div><div class="line">        //è®¾ç½®ä¸ºå¿½ç•¥å”¤é†’çŠ¶æ€</div><div class="line">        __CFRunLoopSetIgnoreWakeUps(rl);</div><div class="line"></div><div class="line">		 // å–æ¶ˆrunloopçš„ä¼‘çœ çŠ¶æ€</div><div class="line">        // user callouts now OK again</div><div class="line">	__CFRunLoopUnsetSleeping(rl);</div><div class="line">	</div><div class="line">		 // 8.é€šçŸ¥è§‚å¯Ÿè€…runloopè¢«å”¤é†’</div><div class="line">	if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopAfterWaiting)) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopAfterWaiting);</div><div class="line"></div><div class="line"></div><div class="line">		 // 9.å¤„ç†é€šè¿‡ç«¯å£æ”¶åˆ°çš„æ¶ˆæ¯</div><div class="line">        handle_msg:;</div><div class="line">        __CFRunLoopSetIgnoreWakeUps(rl);</div><div class="line">		</div><div class="line">        if (MACH_PORT_NULL == livePort) &#123;</div><div class="line">        	  </div><div class="line">        	  // ä¸çŸ¥é“å“ªä¸ªç«¯å£å”¤é†’çš„ï¼ˆæˆ–è€…æ ¹æœ¬æ²¡ç¡ï¼‰ï¼Œå•¥ä¹Ÿä¸å¹²</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_NOTHING();</div><div class="line">            // handle nothing</div><div class="line">            </div><div class="line">        &#125; else if (livePort == rl-&gt;_wakeUpPort) &#123;</div><div class="line">        		</div><div class="line">        	  // è¢« CFRunLoopWakeUp å‡½æ•°å”¤é†’çš„ï¼Œå•¥ä¹Ÿä¸å¹²</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_WAKEUP();</div><div class="line">            // do nothing on Mac OS</div><div class="line">            </div><div class="line">        &#125;</div><div class="line">        </div><div class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</div><div class="line">        else if (modeQueuePort != MACH_PORT_NULL &amp;&amp; livePort == modeQueuePort) &#123;</div><div class="line">        	  </div><div class="line">        	  // è¢« timers å”¤é†’ï¼Œå¤„ç† timers</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_TIMER();</div><div class="line">            if (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) &#123;</div><div class="line">                // Re-arm the next timer, because we apparently fired early</div><div class="line">                __CFArmNextTimerInMode(rlm, rl);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">#endif</div><div class="line">#if USE_MK_TIMER_TOO</div><div class="line">        else if (rlm-&gt;_timerPort != MACH_PORT_NULL &amp;&amp; livePort == rlm-&gt;_timerPort) &#123;</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_TIMER();</div><div class="line">            // On Windows, we have observed an issue where the timer port is set before the time which we requested it to be set. For example, we set the fire time to be TSR 167646765860, but it is actually observed firing at TSR 167646764145, which is 1715 ticks early. The result is that, when __CFRunLoopDoTimers checks to see if any of the run loop timers should be firing, it appears to be &apos;too early&apos; for the next timer, and no timers are handled.</div><div class="line">            // In this case, the timer port has been automatically reset (since it was returned from MsgWaitForMultipleObjectsEx), and if we do not re-arm it, then no timers will ever be serviced again unless something adjusts the timer list (e.g. adding or removing timers). The fix for the issue is to reset the timer here if CFRunLoopDoTimers did not handle a timer itself. 9308754</div><div class="line">            </div><div class="line">            // è¢« timers å”¤é†’ï¼Œå¤„ç† timers</div><div class="line">            if (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) &#123;</div><div class="line">                // Re-arm the next timer</div><div class="line">                __CFArmNextTimerInMode(rlm, rl);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">#endif</div><div class="line"></div><div class="line">			//è¢«GCDå”¤é†’</div><div class="line">        else if (livePort == dispatchPort) &#123;</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_DISPATCH();</div><div class="line">            __CFRunLoopModeUnlock(rlm);</div><div class="line">            __CFRunLoopUnlock(rl);</div><div class="line">            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (void *)6, NULL);</div><div class="line">           __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);</div><div class="line">            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (void *)0, NULL);</div><div class="line">            __CFRunLoopLock(rl);</div><div class="line">            __CFRunLoopModeLock(rlm);</div><div class="line">            sourceHandledThisLoop = true;</div><div class="line">            didDispatchPortLastTime = true;</div><div class="line">        &#125; else &#123;</div><div class="line">        </div><div class="line">        	//ä»¥ä¸Šéƒ½ä¸æ˜¯åˆ™æ˜¯è¢«source1å”¤é†’çš„</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_SOURCE();</div><div class="line">            </div><div class="line">            // If we received a voucher from this mach_msg, then put a copy of the new voucher into TSD. CFMachPortBoost will look in the TSD for the voucher. By using the value in the TSD we tie the CFMachPortBoost to this received mach_msg explicitly without a chance for anything in between the two pieces of code to set the voucher again.</div><div class="line">            voucher_t previousVoucher = _CFSetTSD(__CFTSDKeyMachMessageHasVoucher, (void *)voucherCopy, os_release);</div><div class="line"></div><div class="line">            // Despite the name, this works for windows handles as well</div><div class="line">            CFRunLoopSourceRef rls = __CFRunLoopModeFindSourceForMachPort(rl, rlm, livePort);</div><div class="line">            </div><div class="line"></div><div class="line">	        mach_msg_header_t *reply = NULL;</div><div class="line"></div><div class="line">	        //å¤„ç†source1</div><div class="line">	        sourceHandledThisLoop = __CFRunLoopDoSource1(rl, rlm, rls, msg, msg-&gt;msgh_size, &amp;reply) || sourceHandledThisLoop;</div><div class="line">	        if (NULL != reply) &#123;</div><div class="line">	            (void)mach_msg(reply, MACH_SEND_MSG, reply-&gt;msgh_size, 0, MACH_PORT_NULL, 0, MACH_PORT_NULL);</div><div class="line">	            CFAllocatorDeallocate(kCFAllocatorSystemDefault, reply);</div><div class="line">	        &#125;</div><div class="line">	            </div><div class="line">	            // Restore the previous voucher</div><div class="line">	            _CFSetTSD(__CFTSDKeyMachMessageHasVoucher, previousVoucher, os_release);</div><div class="line">            </div><div class="line">        &#125; </div><div class="line">               </div><div class="line">   // å†ä¸€æ¬¡å¤„ç† blocks</div><div class="line">	__CFRunLoopDoBlocks(rl, rlm);</div><div class="line">        </div><div class="line">	// å–„å</div><div class="line">	if (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;</div><div class="line">	</div><div class="line">	// å¤„ç†å®Œå½“å‰äº‹ä»¶ &amp; runloop æ‰§è¡Œå®Œå°±é€€å‡º</div><div class="line">	    retVal = kCFRunLoopRunHandledSource;</div><div class="line">	    </div><div class="line">	&#125; else if (timeout_context-&gt;termTSR &lt; mach_absolute_time()) &#123;</div><div class="line">        </div><div class="line">        // run loopè¶…æ—¶</div><div class="line">        retVal = kCFRunLoopRunTimedOut;</div><div class="line">            </div><div class="line">	&#125; else if (__CFRunLoopIsStopped(rl)) &#123;</div><div class="line">	</div><div class="line">		 // run loopè¢«æ‰‹åŠ¨ç»ˆæ­¢</div><div class="line">        __CFRunLoopUnsetStopped(rl);</div><div class="line">	    retVal = kCFRunLoopRunStopped;</div><div class="line">	    </div><div class="line">	&#125; else if (rlm-&gt;_stopped) &#123;</div><div class="line">		</div><div class="line">		// modeè¢«ç»ˆæ­¢</div><div class="line">	    rlm-&gt;_stopped = false;</div><div class="line">	    retVal = kCFRunLoopRunStopped;</div><div class="line">	    </div><div class="line">	&#125; else if (__CFRunLoopModeIsEmpty(rl, rlm, previousMode)) &#123;</div><div class="line">	</div><div class="line">		// modeä¸­çš„Itemséƒ½ä¸ºç©ºï¼Œé€€å‡ºã€‚</div><div class="line">	    retVal = kCFRunLoopRunFinished;</div><div class="line">	&#125;</div><div class="line">        </div><div class="line">    &#125; while (0 == retVal);</div><div class="line"></div><div class="line">    if (timeout_timer) &#123;</div><div class="line">        dispatch_source_cancel(timeout_timer);</div><div class="line">        dispatch_release(timeout_timer);</div><div class="line">    &#125; else &#123;</div><div class="line">        free(timeout_context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return retVal;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//æ¥æ”¶mach portæ¶ˆæ¯</div><div class="line">static Boolean __CFRunLoopServiceMachPort(mach_port_name_t port, mach_msg_header_t **buffer, size_t buffer_size, mach_port_t *livePort, mach_msg_timeout_t timeout, voucher_mach_msg_state_t *voucherState, voucher_t *voucherCopy) &#123;</div><div class="line">    Boolean originalBuffer = true;</div><div class="line">    kern_return_t ret = KERN_SUCCESS;</div><div class="line">    for (;;) &#123;		/* In that sleep of death what nightmares may come ... */</div><div class="line">        mach_msg_header_t *msg = (mach_msg_header_t *)*buffer;</div><div class="line">        msg-&gt;msgh_bits = 0;</div><div class="line">        msg-&gt;msgh_local_port = port;</div><div class="line">        msg-&gt;msgh_remote_port = MACH_PORT_NULL;</div><div class="line">        msg-&gt;msgh_size = buffer_size;</div><div class="line">        msg-&gt;msgh_id = 0;</div><div class="line">        if (TIMEOUT_INFINITY == timeout) &#123; CFRUNLOOP_SLEEP(); &#125; else &#123; CFRUNLOOP_POLL(); &#125;</div><div class="line">        </div><div class="line">        //æ¥æ”¶æˆ–å‘é€æ¶ˆæ¯</div><div class="line">        ret = mach_msg(msg, MACH_RCV_MSG|(voucherState ? MACH_RCV_VOUCHER : 0)|MACH_RCV_LARGE|((TIMEOUT_INFINITY != timeout) ? MACH_RCV_TIMEOUT : 0)|MACH_RCV_TRAILER_TYPE(MACH_MSG_TRAILER_FORMAT_0)|MACH_RCV_TRAILER_ELEMENTS(MACH_RCV_TRAILER_AV), 0, msg-&gt;msgh_size, port, timeout, MACH_PORT_NULL);</div><div class="line"></div><div class="line">        // Take care of all voucher-related work right after mach_msg.</div><div class="line">        // If we don&apos;t release the previous voucher we&apos;re going to leak it.</div><div class="line">        voucher_mach_msg_revert(*voucherState);</div><div class="line">        </div><div class="line">        // Someone will be responsible for calling voucher_mach_msg_revert. This call makes the received voucher the current one.</div><div class="line">        *voucherState = voucher_mach_msg_adopt(msg);</div><div class="line">        </div><div class="line">        if (voucherCopy) &#123;</div><div class="line">            if (*voucherState != VOUCHER_MACH_MSG_STATE_UNCHANGED) &#123;</div><div class="line">                // Caller requested a copy of the voucher at this point. By doing this right next to mach_msg we make sure that no voucher has been set in between the return of mach_msg and the use of the voucher copy.</div><div class="line">                // CFMachPortBoost uses the voucher to drop importance explicitly. However, we want to make sure we only drop importance for a new voucher (not unchanged), so we only set the TSD when the voucher is not state_unchanged.</div><div class="line">                *voucherCopy = voucher_copy();</div><div class="line">            &#125; else &#123;</div><div class="line">                *voucherCopy = NULL;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        CFRUNLOOP_WAKEUP(ret);</div><div class="line">        </div><div class="line">        //æ¥æ”¶æ¶ˆæ¯æˆåŠŸ</div><div class="line">        if (MACH_MSG_SUCCESS == ret) &#123;</div><div class="line">            *livePort = msg ? msg-&gt;msgh_local_port : MACH_PORT_NULL;</div><div class="line">            return true;</div><div class="line">        &#125;</div><div class="line">        if (MACH_RCV_TIMED_OUT == ret) &#123;</div><div class="line">            if (!originalBuffer) free(msg);</div><div class="line">            *buffer = NULL;</div><div class="line">            *livePort = MACH_PORT_NULL;</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line">        if (MACH_RCV_TOO_LARGE != ret) break;</div><div class="line">        buffer_size = round_msg(msg-&gt;msgh_size + MAX_TRAILER_SIZE);</div><div class="line">        if (originalBuffer) *buffer = NULL;</div><div class="line">        originalBuffer = false;</div><div class="line">        *buffer = realloc(*buffer, buffer_size);</div><div class="line">    &#125;</div><div class="line">    HALT;</div><div class="line">    return false;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="runloopè¿è¡Œæµç¨‹æ€»ç»“å…¥ä¸‹å›¾"><a href="#runloopè¿è¡Œæµç¨‹æ€»ç»“å…¥ä¸‹å›¾" class="headerlink" title="runloopè¿è¡Œæµç¨‹æ€»ç»“å…¥ä¸‹å›¾"></a>runloopè¿è¡Œæµç¨‹æ€»ç»“å…¥ä¸‹å›¾</h5><p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Runloop/runloop007.png" alt=""></p>
<p>runloopå†…éƒ¨å…¶å®å°±æ˜¯ä¸€ä¸ªdo while()çš„å¾ªç¯ã€‚åªæ˜¯åœ¨æ²¡æœ‰äº‹ä»¶éœ€è¦å¤„ç†çš„æ—¶å€™ï¼Œrunloopä¼šè°ƒç”¨<strong>__CFRunLoopSetSleeping</strong> æ–¹æ³•å°†å½“å‰çº¿ç¨‹ç½®ä¸ºç¡çœ çŠ¶æ€ï¼ŒåŒæ—¶ä¼šè°ƒç”¨ <strong>__CFRunLoopServiceMachPort</strong> æ–¹æ³•æ¥ç¡çœ çº¿ç¨‹å¹¶ç­‰å¾…æ¥æ”¶machå‘æ¥çš„å”¤é†’æ¶ˆæ¯ã€‚æ”¶åˆ°æ¶ˆæ¯åï¼Œè¯¥çº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œå”¤é†’årunloopé™¤äº†å¤„ç†å”¤é†’å®ƒçš„äº‹ä»¶ï¼Œè¿˜éœ€è¦å¤„ç†ä¸€éæ‰€æœ‰ç­‰å¾…å¤„ç†çš„äº‹ä»¶ï¼ŒåŒ…æ‹¬ï¼ˆtimer,observer,source,blockï¼‰ã€‚</p>
<h5 id="runloopå”¤é†’äº‹ä»¶æ€»ç»“"><a href="#runloopå”¤é†’äº‹ä»¶æ€»ç»“" class="headerlink" title="runloopå”¤é†’äº‹ä»¶æ€»ç»“"></a>runloopå”¤é†’äº‹ä»¶æ€»ç»“</h5><ul>
<li>mach port source</li>
<li>æ‰‹åŠ¨å”¤é†’Custom Input Sourceï¼ˆCFRunLoopSourceSignal(source)/CFRunLoopWakeUp(runloop)ï¼‰</li>
<li>dispatch_async(dispatch_get_main_queue)/dispatch_sync(dispatch_get_main_queue)(ä¸è¦åœ¨ä¸»çº¿ç¨‹åŒæ­¥ä»»åŠ¡ï¼Œä¼šæ­»é”);</li>
<li>timer</li>
</ul>
<h4 id="Modeå’Œå®ƒçš„å››å¤§å¤§ç‹-Source-Timer-Observer-Block"><a href="#Modeå’Œå®ƒçš„å››å¤§å¤§ç‹-Source-Timer-Observer-Block" class="headerlink" title="Modeå’Œå®ƒçš„å››å¤§å¤§ç‹(Source,Timer,Observer,Block)"></a>Modeå’Œå®ƒçš„å››å¤§å¤§ç‹(Source,Timer,Observer,Block)</h4><h5 id="Mode"><a href="#Mode" class="headerlink" title="Mode"></a>Mode</h5><p>Modeçš„åˆ›å»ºä¹Ÿæ˜¯æ‡’åŠ è½½</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line">static CFRunLoopModeRef __CFRunLoopFindMode(CFRunLoopRef rl, CFStringRef modeName, Boolean create) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    CFRunLoopModeRef rlm;</div><div class="line">    struct __CFRunLoopMode srlm;</div><div class="line">    memset(&amp;srlm, 0, sizeof(srlm));</div><div class="line">    _CFRuntimeSetInstanceTypeIDAndIsa(&amp;srlm, __kCFRunLoopModeTypeID);</div><div class="line">    srlm._name = modeName;</div><div class="line">    rlm = (CFRunLoopModeRef)CFSetGetValue(rl-&gt;_modes, &amp;srlm);</div><div class="line">    </div><div class="line">    //modeä¸ä¸ºç©ºç›´æ¥è¿”å›ï¼Œä¸ºç©ºåˆ™åˆ›å»ºæ–°çš„</div><div class="line">    if (NULL != rlm) &#123;</div><div class="line">	__CFRunLoopModeLock(rlm);</div><div class="line">	return rlm;</div><div class="line">    &#125;</div><div class="line">    if (!create) &#123;</div><div class="line">	return NULL;</div><div class="line">    &#125;</div><div class="line">    rlm = (CFRunLoopModeRef)_CFRuntimeCreateInstance(kCFAllocatorSystemDefault, __kCFRunLoopModeTypeID, sizeof(struct __CFRunLoopMode) - sizeof(CFRuntimeBase), NULL);</div><div class="line">    if (NULL == rlm) &#123;</div><div class="line">	return NULL;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //å‚æ•°çš„åˆå§‹åŒ–</div><div class="line">    __CFRunLoopLockInit(&amp;rlm-&gt;_lock);</div><div class="line">    rlm-&gt;_name = CFStringCreateCopy(kCFAllocatorSystemDefault, modeName);</div><div class="line">    rlm-&gt;_stopped = false;</div><div class="line">    rlm-&gt;_portToV1SourceMap = NULL;</div><div class="line">    rlm-&gt;_sources0 = NULL;</div><div class="line">    rlm-&gt;_sources1 = NULL;</div><div class="line">    rlm-&gt;_observers = NULL;</div><div class="line">    rlm-&gt;_timers = NULL;</div><div class="line">    rlm-&gt;_observerMask = 0;</div><div class="line">    rlm-&gt;_portSet = __CFPortSetAllocate();</div><div class="line">    rlm-&gt;_timerSoftDeadline = UINT64_MAX;</div><div class="line">    rlm-&gt;_timerHardDeadline = UINT64_MAX;</div><div class="line">    </div><div class="line">    kern_return_t ret = KERN_SUCCESS;</div><div class="line">    </div><div class="line">    //åˆå§‹åŒ–timerç›¸å…³å†…å®¹</div><div class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</div><div class="line">    rlm-&gt;_timerFired = false;</div><div class="line">    rlm-&gt;_queue = _dispatch_runloop_root_queue_create_4CF(&quot;Run Loop Mode Queue&quot;, 0);</div><div class="line">    </div><div class="line">    //ç”¨æ¥å”¤é†’çš„ç«¯å£</div><div class="line">    mach_port_t queuePort = _dispatch_runloop_root_queue_get_port_4CF(rlm-&gt;_queue);</div><div class="line">    if (queuePort == MACH_PORT_NULL) CRASH(&quot;*** Unable to create run loop mode queue port. (%d) ***&quot;, -1);</div><div class="line">    rlm-&gt;_timerSource = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, rlm-&gt;_queue);</div><div class="line">    </div><div class="line">    __block Boolean *timerFiredPointer = &amp;(rlm-&gt;_timerFired);</div><div class="line">    dispatch_source_set_event_handler(rlm-&gt;_timerSource, ^&#123;</div><div class="line">        *timerFiredPointer = true;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    // Set timer to far out there. The unique leeway makes this timer easy to spot in debug output.</div><div class="line">    _dispatch_source_set_runloop_timer_4CF(rlm-&gt;_timerSource, DISPATCH_TIME_FOREVER, DISPATCH_TIME_FOREVER, 321);</div><div class="line">    dispatch_resume(rlm-&gt;_timerSource);</div><div class="line">    </div><div class="line">    ret = __CFPortSetInsert(queuePort, rlm-&gt;_portSet);</div><div class="line">    if (KERN_SUCCESS != ret) CRASH(&quot;*** Unable to insert timer port into port set. (%d) ***&quot;, ret);</div><div class="line">    </div><div class="line">#endif</div><div class="line">#if USE_MK_TIMER_TOO</div><div class="line"></div><div class="line">    //ç”¨æ¥å”¤é†’çš„ç«¯å£</div><div class="line">    rlm-&gt;_timerPort = mk_timer_create();</div><div class="line">    ret = __CFPortSetInsert(rlm-&gt;_timerPort, rlm-&gt;_portSet);</div><div class="line">    if (KERN_SUCCESS != ret) CRASH(&quot;*** Unable to insert timer port into port set. (%d) ***&quot;, ret);</div><div class="line">#endif</div><div class="line">    </div><div class="line">    ret = __CFPortSetInsert(rl-&gt;_wakeUpPort, rlm-&gt;_portSet);</div><div class="line">    if (KERN_SUCCESS != ret) CRASH(&quot;*** Unable to insert wake up port into port set. (%d) ***&quot;, ret);</div><div class="line">    </div><div class="line">#if DEPLOYMENT_TARGET_WINDOWS</div><div class="line">    rlm-&gt;_msgQMask = 0;</div><div class="line">    rlm-&gt;_msgPump = NULL;</div><div class="line">#endif</div><div class="line">    CFSetAddValue(rl-&gt;_modes, rlm);</div><div class="line">    CFRelease(rlm);</div><div class="line">    __CFRunLoopModeLock(rlm);	/* return mode locked */</div><div class="line">    return rlm;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">//åˆ¤æ–­modeæ˜¯å¦ä¸ºç©º é€šè¿‡è¿™ä¸ªå‡½æ•°å¯ä»¥çœ‹åˆ°ï¼Œåªæœ‰å½“source0ã€source1ã€timerå’Œblockéƒ½ä¸ºç©ºï¼Œmodeæ‰ä¼šè¢«æ ‡è®°ä¸ºç©ºï¼ˆè¿™ä¹ˆçœ‹observeråº”è¯¥æ˜¯ä½ç­‰å±æ°‘äº†ï¼Œæ²¡æœ‰ä»€ä¹ˆå­˜åœ¨æ„Ÿï¼‰</div><div class="line"></div><div class="line">static Boolean __CFRunLoopModeIsEmpty(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFRunLoopModeRef previousMode) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    if (NULL == rlm) return true;</div><div class="line">#if DEPLOYMENT_TARGET_WINDOWS</div><div class="line">    if (0 != rlm-&gt;_msgQMask) return false;</div><div class="line">#endif</div><div class="line">    Boolean libdispatchQSafe = pthread_main_np() &amp;&amp; ((HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; NULL == previousMode) || (!HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; 0 == _CFGetTSD(__CFTSDKeyIsInGCDMainQ)));</div><div class="line">    </div><div class="line">	//ä¸»çº¿ç¨‹ä¸”å½“å‰Modeä¹Ÿåœ¨CommonModeä¸­ï¼Œä¸å¯èƒ½ä¸ºç©ºï¼Œåº”è¯¥æ˜¯ç³»ç»Ÿæœ‰å¾€CommonModeé‡Œé¢æ·»åŠ äº†ä¸œè¥¿ï¼Œä¼šè¢«åŒæ­¥åˆ°è¯¥Modeä¸­ã€‚</div><div class="line">    if (libdispatchQSafe &amp;&amp; (CFRunLoopGetMain() == rl) &amp;&amp; CFSetContainsValue(rl-&gt;_commonModes, rlm-&gt;_name)) return false; // represents the libdispatch main queue</div><div class="line">    </div><div class="line">    if (NULL != rlm-&gt;_sources0 &amp;&amp; 0 &lt; CFSetGetCount(rlm-&gt;_sources0)) return false;</div><div class="line">    if (NULL != rlm-&gt;_sources1 &amp;&amp; 0 &lt; CFSetGetCount(rlm-&gt;_sources1)) return false;</div><div class="line">    if (NULL != rlm-&gt;_timers &amp;&amp; 0 &lt; CFArrayGetCount(rlm-&gt;_timers)) return false;</div><div class="line">    struct _block_item *item = rl-&gt;_blocks_head;</div><div class="line">    while (item) &#123;</div><div class="line">        struct _block_item *curr = item;</div><div class="line">        item = item-&gt;_next;</div><div class="line">        Boolean doit = false;</div><div class="line">        if (CFStringGetTypeID() == CFGetTypeID(curr-&gt;_mode)) &#123;</div><div class="line">            doit = CFEqual(curr-&gt;_mode, rlm-&gt;_name) || (CFEqual(curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(rl-&gt;_commonModes, rlm-&gt;_name));</div><div class="line">        &#125; else &#123;</div><div class="line">            doit = CFSetContainsValue((CFSetRef)curr-&gt;_mode, rlm-&gt;_name) || (CFSetContainsValue((CFSetRef)curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(rl-&gt;_commonModes, rlm-&gt;_name));</div><div class="line">        &#125;</div><div class="line">        if (doit) return false;</div><div class="line">    &#125;</div><div class="line">    return true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div></pre></td><td class="code"><pre><div class="line">//sourceçš„åˆ›å»º</div><div class="line"></div><div class="line">CFRunLoopSourceRef CFRunLoopSourceCreate(CFAllocatorRef allocator, CFIndex order, CFRunLoopSourceContext *context) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    CFRunLoopSourceRef memory;</div><div class="line">    uint32_t size;</div><div class="line">    if (NULL == context) CRASH(&quot;*** NULL context value passed to CFRunLoopSourceCreate(). (%d) ***&quot;, -1);</div><div class="line">    </div><div class="line">    size = sizeof(struct __CFRunLoopSource) - sizeof(CFRuntimeBase);</div><div class="line">    memory = (CFRunLoopSourceRef)_CFRuntimeCreateInstance(allocator, CFRunLoopSourceGetTypeID(), size, NULL);</div><div class="line">    if (NULL == memory) &#123;</div><div class="line">	return NULL;</div><div class="line">    &#125;</div><div class="line">    __CFSetValid(memory);</div><div class="line">    __CFRunLoopSourceUnsetSignaled(memory);</div><div class="line">    __CFRunLoopLockInit(&amp;memory-&gt;_lock);</div><div class="line">    memory-&gt;_bits = 0;</div><div class="line">    memory-&gt;_order = order;</div><div class="line">    memory-&gt;_runLoops = NULL;</div><div class="line">    size = 0;</div><div class="line">    switch (context-&gt;version) &#123;</div><div class="line">    case 0:</div><div class="line">	size = sizeof(CFRunLoopSourceContext);</div><div class="line">	break;</div><div class="line">    case 1:</div><div class="line">	size = sizeof(CFRunLoopSourceContext1);</div><div class="line">	break;</div><div class="line">    &#125;</div><div class="line">    objc_memmove_collectable(&amp;memory-&gt;_context, context, size);</div><div class="line">    if (context-&gt;retain) &#123;</div><div class="line">	memory-&gt;_context.version0.info = (void *)context-&gt;retain(context-&gt;info);</div><div class="line">    &#125;</div><div class="line">    return memory;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">//ç»™modeæ·»åŠ source</div><div class="line"></div><div class="line">void CFRunLoopAddSource(CFRunLoopRef rl, CFRunLoopSourceRef rls, CFStringRef modeName) &#123;	/* DOES CALLOUT */</div><div class="line"></div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    if (__CFRunLoopIsDeallocating(rl)) return;</div><div class="line">    if (!__CFIsValid(rls)) return;</div><div class="line">    Boolean doVer0Callout = false;</div><div class="line">    __CFRunLoopLock(rl);</div><div class="line">    </div><div class="line">    //å¦‚æœæ˜¯common ç›´æ¥æ·»åŠ åˆ°_commonModeItemsæ•°ç»„</div><div class="line">    if (modeName == kCFRunLoopCommonModes) &#123;</div><div class="line">	CFSetRef set = rl-&gt;_commonModes ? CFSetCreateCopy(kCFAllocatorSystemDefault, rl-&gt;_commonModes) : NULL;</div><div class="line">	if (NULL == rl-&gt;_commonModeItems) &#123;</div><div class="line">	    rl-&gt;_commonModeItems = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</div><div class="line">	&#125;</div><div class="line">	CFSetAddValue(rl-&gt;_commonModeItems, rls);</div><div class="line">	if (NULL != set) &#123;</div><div class="line">	    CFTypeRef context[2] = &#123;rl, rls&#125;;</div><div class="line">	    /* add new item to all common-modes */</div><div class="line">	    CFSetApplyFunction(set, (__CFRunLoopAddItemToCommonModes), (void *)context);</div><div class="line">	    CFRelease(set);</div><div class="line">	&#125;</div><div class="line">    &#125; else &#123;</div><div class="line">    </div><div class="line">    //åˆ›å»ºsource0å’Œsource1çš„é›†åˆ</div><div class="line">	CFRunLoopModeRef rlm = __CFRunLoopFindMode(rl, modeName, true);</div><div class="line">	if (NULL != rlm &amp;&amp; NULL == rlm-&gt;_sources0) &#123;</div><div class="line">	    rlm-&gt;_sources0 = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</div><div class="line">	    rlm-&gt;_sources1 = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</div><div class="line">	    rlm-&gt;_portToV1SourceMap = CFDictionaryCreateMutable(kCFAllocatorSystemDefault, 0, NULL, NULL);</div><div class="line">	&#125;</div><div class="line">	if (NULL != rlm &amp;&amp; !CFSetContainsValue(rlm-&gt;_sources0, rls) &amp;&amp; !CFSetContainsValue(rlm-&gt;_sources1, rls)) &#123;</div><div class="line">	</div><div class="line">		//æŒ‰sourceç±»å‹æ·»åŠ åˆ°ä¸åŒçš„é›†åˆä¸­</div><div class="line">	    if (0 == rls-&gt;_context.version0.version) &#123;</div><div class="line">	        CFSetAddValue(rlm-&gt;_sources0, rls);</div><div class="line">	    &#125; else if (1 == rls-&gt;_context.version0.version) &#123;</div><div class="line">	        CFSetAddValue(rlm-&gt;_sources1, rls);</div><div class="line">		__CFPort src_port = rls-&gt;_context.version1.getPort(rls-&gt;_context.version1.info);</div><div class="line">		</div><div class="line">		//å¦‚æœæ˜¯source1 è¿˜éœ€è¦æŠŠsource1å¯¹åº”çš„portæ·»åŠ åˆ°mach portçš„åˆ—è¡¨ä¸­</div><div class="line">		if (CFPORT_NULL != src_port) &#123;</div><div class="line">		    CFDictionarySetValue(rlm-&gt;_portToV1SourceMap, (const void *)(uintptr_t)src_port, rls);</div><div class="line">		    __CFPortSetInsert(src_port, rlm-&gt;_portSet);</div><div class="line">	        &#125;</div><div class="line">	    &#125;</div><div class="line">	    __CFRunLoopSourceLock(rls);</div><div class="line">	    if (NULL == rls-&gt;_runLoops) &#123;</div><div class="line">	        rls-&gt;_runLoops = CFBagCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeBagCallBacks); // sources retain run loops!</div><div class="line">	    &#125;</div><div class="line">	    CFBagAddValue(rls-&gt;_runLoops, rl);</div><div class="line">	    __CFRunLoopSourceUnlock(rls);</div><div class="line">	    if (0 == rls-&gt;_context.version0.version) &#123;</div><div class="line">	        if (NULL != rls-&gt;_context.version0.schedule) &#123;</div><div class="line">	            doVer0Callout = true;</div><div class="line">	        &#125;</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">        if (NULL != rlm) &#123;</div><div class="line">	    __CFRunLoopModeUnlock(rlm);</div><div class="line">	&#125;</div><div class="line">    &#125;</div><div class="line">    __CFRunLoopUnlock(rl);</div><div class="line">    if (doVer0Callout) &#123;</div><div class="line">        // although it looses some protection for the source, we have no choice but</div><div class="line">        // to do this after unlocking the run loop and mode locks, to avoid deadlocks</div><div class="line">        // where the source wants to take a lock which is already held in another</div><div class="line">        // thread which is itself waiting for a run loop/mode lock</div><div class="line">	rls-&gt;_context.version0.schedule(rls-&gt;_context.version0.info, rl, modeName);	/* CALLOUT */</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//å¤„ç†source0</div><div class="line">static Boolean __CFRunLoopDoSources0(CFRunLoopRef rl, CFRunLoopModeRef rlm, Boolean stopAfterHandle) &#123;	/* DOES CALLOUT */</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    CFTypeRef sources = NULL;</div><div class="line">    Boolean sourceHandled = false;</div><div class="line"></div><div class="line">    /* Fire the version 0 sources */</div><div class="line">    </div><div class="line">    //è·å–å½“å‰modeçš„source0é›†åˆ</div><div class="line">    if (NULL != rlm-&gt;_sources0 &amp;&amp; 0 &lt; CFSetGetCount(rlm-&gt;_sources0)) &#123;</div><div class="line">	CFSetApplyFunction(rlm-&gt;_sources0, (__CFRunLoopCollectSources0), &amp;sources);</div><div class="line">    &#125;</div><div class="line">    if (NULL != sources) &#123;</div><div class="line">	__CFRunLoopModeUnlock(rlm);</div><div class="line">	__CFRunLoopUnlock(rl);</div><div class="line">	// sources is either a single (retained) CFRunLoopSourceRef or an array of (retained) CFRunLoopSourceRef</div><div class="line">	</div><div class="line">	//å¦‚æœæ˜¯å•ä¸ªäº‹ä»¶</div><div class="line">	if (CFGetTypeID(sources) == CFRunLoopSourceGetTypeID()) &#123;</div><div class="line">	    CFRunLoopSourceRef rls = (CFRunLoopSourceRef)sources;</div><div class="line">	    __CFRunLoopSourceLock(rls);</div><div class="line">	    </div><div class="line">	    //è¿™é‡Œåœ¨å¤„ç†å®Œè¿™ä¸ªsourceä¹‹åï¼Œä¼šæŠŠè¿™ä¸ªsourceæ ‡è®°ä¸ºä¸å†å¤„ç†ï¼ï¼ï¼ï¼åé¢demoé‡Œæœ‰åº”ç”¨ã€‚</div><div class="line">            if (__CFRunLoopSourceIsSignaled(rls)) &#123;</div><div class="line">	        __CFRunLoopSourceUnsetSignaled(rls);</div><div class="line">	        if (__CFIsValid(rls)) &#123;</div><div class="line">	            __CFRunLoopSourceUnlock(rls);</div><div class="line"></div><div class="line">                    //è°ƒç”¨source0å¯¹åº”çš„å›è°ƒ</div><div class="line">                    __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__(rls-&gt;_context.version0.perform, rls-&gt;_context.version0.info);</div><div class="line">	            CHECK_FOR_FORK();</div><div class="line">	            sourceHandled = true;</div><div class="line">	        &#125; else &#123;</div><div class="line">	            __CFRunLoopSourceUnlock(rls);</div><div class="line">	        &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                __CFRunLoopSourceUnlock(rls);</div><div class="line">            &#125;</div><div class="line">	&#125; else &#123;</div><div class="line">	</div><div class="line">	//å¦‚æœæ˜¯ä¸€ä¸ªäº‹ä»¶åˆ—è¡¨</div><div class="line">	    CFIndex cnt = CFArrayGetCount((CFArrayRef)sources);</div><div class="line">	    CFArraySortValues((CFMutableArrayRef)sources, CFRangeMake(0, cnt), (__CFRunLoopSourceComparator), NULL);</div><div class="line">	    for (CFIndex idx = 0; idx &lt; cnt; idx++) &#123;</div><div class="line">		CFRunLoopSourceRef rls = (CFRunLoopSourceRef)CFArrayGetValueAtIndex((CFArrayRef)sources, idx);</div><div class="line">		__CFRunLoopSourceLock(rls);</div><div class="line">                if (__CFRunLoopSourceIsSignaled(rls)) &#123;</div><div class="line">		    __CFRunLoopSourceUnsetSignaled(rls);</div><div class="line">		    if (__CFIsValid(rls)) &#123;</div><div class="line">		        __CFRunLoopSourceUnlock(rls);</div><div class="line">                        </div><div class="line">                        //è°ƒç”¨source0å¯¹åº”çš„å›è°ƒ                       __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__(rls-&gt;_context.version0.perform, rls-&gt;_context.version0.info);</div><div class="line">		        CHECK_FOR_FORK();</div><div class="line">		        sourceHandled = true;</div><div class="line">		    &#125; else &#123;</div><div class="line">		        __CFRunLoopSourceUnlock(rls);</div><div class="line">		    &#125;</div><div class="line">                &#125; else &#123;</div><div class="line">                    __CFRunLoopSourceUnlock(rls);</div><div class="line">                &#125;</div><div class="line">		if (stopAfterHandle &amp;&amp; sourceHandled) &#123;</div><div class="line">		    break;</div><div class="line">		&#125;</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">	CFRelease(sources);</div><div class="line">	__CFRunLoopLock(rl);</div><div class="line">	__CFRunLoopModeLock(rlm);</div><div class="line">    &#125;</div><div class="line">    return sourceHandled;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">//å¤„ç†source1</div><div class="line">static Boolean __CFRunLoopDoSource1(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFRunLoopSourceRef rls</div><div class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</div><div class="line">                                    , mach_msg_header_t *msg, CFIndex size, mach_msg_header_t **reply</div><div class="line">#endif</div><div class="line">                                    ) &#123;	/* DOES CALLOUT */</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    Boolean sourceHandled = false;</div><div class="line"></div><div class="line">    /* Fire a version 1 source */</div><div class="line">    CFRetain(rls);</div><div class="line">    __CFRunLoopModeUnlock(rlm);</div><div class="line">    __CFRunLoopUnlock(rl);</div><div class="line">    __CFRunLoopSourceLock(rls);</div><div class="line">    if (__CFIsValid(rls)) &#123;</div><div class="line">	__CFRunLoopSourceUnsetSignaled(rls);</div><div class="line">	__CFRunLoopSourceUnlock(rls);</div><div class="line">        __CFRunLoopDebugInfoForRunLoopSource(rls);</div><div class="line">        </div><div class="line">        //è°ƒç”¨source1å¯¹åº”çš„å›è°ƒ</div><div class="line">        __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__(rls-&gt;_context.version1.perform,</div><div class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</div><div class="line">            msg, size, reply,</div><div class="line">#endif</div><div class="line">            rls-&gt;_context.version1.info);</div><div class="line">	CHECK_FOR_FORK();</div><div class="line">	sourceHandled = true;</div><div class="line">    &#125; else &#123;</div><div class="line">        if (_LogCFRunLoop) &#123; CFLog(kCFLogLevelDebug, CFSTR(&quot;%p (%s) __CFRunLoopDoSource1 rls %p is invalid&quot;), CFRunLoopGetCurrent(), *_CFGetProgname(), rls); &#125;</div><div class="line">	__CFRunLoopSourceUnlock(rls);</div><div class="line">    &#125;</div><div class="line">    CFRelease(rls);</div><div class="line">    __CFRunLoopLock(rl);</div><div class="line">    __CFRunLoopModeLock(rlm);</div><div class="line">    return sourceHandled;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="sourceæ€»ç»“"><a href="#sourceæ€»ç»“" class="headerlink" title="sourceæ€»ç»“"></a>sourceæ€»ç»“</h5><p>é€šè¿‡å¯¹æ¯”source0å’Œsource1çš„å¤„ç†å‡½æ•°å‘ç°ï¼Œsource0æœ‰2ç§æƒ…å†µï¼Œå•ä¸ªäº‹ä»¶å’Œäº‹ä»¶åˆ—è¡¨ï¼Œè€Œsource1åªæœ‰å•ä¸ªäº‹ä»¶çš„å¤„ç†ï¼Œä¸ªäººç†è§£æ˜¯å› ä¸ºsource1çš„äº‹ä»¶æ˜¯å³æ—¶å¤„ç†çš„ï¼Œå› ä¸ºsource1å¯ä»¥å”¤é†’runloop,åªè¦æœ‰source1äº‹ä»¶runloopå°±ä¼šå»å¤„ç†ï¼Œæ‰€æœ‰ä¸å­˜åœ¨å¤„ç†äº‹ä»¶åˆ—è¡¨çš„æƒ…å†µï¼Œè€Œsource0æœ‰å¯èƒ½åªæ˜¯æ ‡è®°ä¸ºå¾…å¤„ç†è€Œæ²¡æœ‰æ‰‹åŠ¨å”¤é†’runloop,å½“æ ‡è®°ä¸ºå¾…å¤„ç†source0äº‹ä»¶åï¼Œåªä¼šè¢«æ·»åŠ åˆ°modeçš„source0é›†åˆä¸­ï¼Œåœ¨runloopè¢«å”¤é†’åç»Ÿä¸€å¤„ç†ã€‚</p>
<h5 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a>Timer</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">CFRunLoopTimerRef CFRunLoopTimerCreate(CFAllocatorRef allocator, CFAbsoluteTime fireDate, CFTimeInterval interval, CFOptionFlags flags, CFIndex order, CFRunLoopTimerCallBack callout, CFRunLoopTimerContext *context) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    if (isnan(interval)) &#123;</div><div class="line">        CRSetCrashLogMessage(&quot;NaN was used as an interval for a CFRunLoopTimer&quot;);</div><div class="line">        HALT;</div><div class="line">    &#125;</div><div class="line">    CFRunLoopTimerRef memory;</div><div class="line">    UInt32 size;</div><div class="line">    size = sizeof(struct __CFRunLoopTimer) - sizeof(CFRuntimeBase);</div><div class="line">    memory = (CFRunLoopTimerRef)_CFRuntimeCreateInstance(allocator, CFRunLoopTimerGetTypeID(), size, NULL);</div><div class="line">    if (NULL == memory) &#123;</div><div class="line">	return NULL;</div><div class="line">    &#125;</div><div class="line">    __CFSetValid(memory);</div><div class="line">    __CFRunLoopTimerUnsetFiring(memory);</div><div class="line">    __CFRunLoopLockInit(&amp;memory-&gt;_lock);</div><div class="line">    memory-&gt;_runLoop = NULL;</div><div class="line">    memory-&gt;_rlModes = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</div><div class="line">    memory-&gt;_order = order;</div><div class="line">    if (interval &lt; 0.0) interval = 0.0;</div><div class="line">    memory-&gt;_interval = interval;</div><div class="line">    memory-&gt;_tolerance = 0.0;</div><div class="line">    </div><div class="line">    //fireDate é¦–æ¬¡è§¦å‘çš„ç»å¯¹æ—¶é—´</div><div class="line">    if (TIMER_DATE_LIMIT &lt; fireDate) fireDate = TIMER_DATE_LIMIT;</div><div class="line">    memory-&gt;_nextFireDate = fireDate;</div><div class="line">    memory-&gt;_fireTSR = 0ULL;</div><div class="line">    </div><div class="line">    //è·å–machå†…æ ¸å’ŒCFå†…æ ¸çš„ç»å¯¹æ—¶é—´</div><div class="line">    uint64_t now2 = mach_absolute_time();</div><div class="line">    CFAbsoluteTime now1 = CFAbsoluteTimeGetCurrent();</div><div class="line">    </div><div class="line">    //_fireTSRä¸ºæœ¬æ¬¡åº”è§¦å‘çš„ç»å¯¹æ—¶é—´ç‚¹</div><div class="line">    if (fireDate &lt; now1) &#123;</div><div class="line">		memory-&gt;_fireTSR = now2;</div><div class="line">    &#125; else if (TIMER_INTERVAL_LIMIT &lt; fireDate - now1) &#123;</div><div class="line">		memory-&gt;_fireTSR = now2 + __CFTimeIntervalToTSR(TIMER_INTERVAL_LIMIT);</div><div class="line">    &#125; else &#123;</div><div class="line">		memory-&gt;_fireTSR = now2 + __CFTimeIntervalToTSR(fireDate - now1);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    memory-&gt;_callout = callout;</div><div class="line">    if (NULL != context) &#123;</div><div class="line">	if (context-&gt;retain) &#123;</div><div class="line">	    memory-&gt;_context.info = (void *)context-&gt;retain(context-&gt;info);</div><div class="line">	&#125; else &#123;</div><div class="line">	    memory-&gt;_context.info = context-&gt;info;</div><div class="line">	&#125;</div><div class="line">	memory-&gt;_context.retain = context-&gt;retain;</div><div class="line">	memory-&gt;_context.release = context-&gt;release;</div><div class="line">	memory-&gt;_context.copyDescription = context-&gt;copyDescription;</div><div class="line">    &#125; else &#123;</div><div class="line">	memory-&gt;_context.info = 0;</div><div class="line">	memory-&gt;_context.retain = 0;</div><div class="line">	memory-&gt;_context.release = 0;</div><div class="line">	memory-&gt;_context.copyDescription = 0;</div><div class="line">    &#125;</div><div class="line">    return memory;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">void CFRunLoopAddTimer(CFRunLoopRef rl, CFRunLoopTimerRef rlt, CFStringRef modeName) &#123;    </div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    if (__CFRunLoopIsDeallocating(rl)) return;</div><div class="line">    if (!__CFIsValid(rlt) || (NULL != rlt-&gt;_runLoop &amp;&amp; rlt-&gt;_runLoop != rl)) return;</div><div class="line">    __CFRunLoopLock(rl);</div><div class="line">    </div><div class="line">    //å¦‚æœæ˜¯common modeç›´æ¥åŠ åˆ°_commonModeItems</div><div class="line">    if (modeName == kCFRunLoopCommonModes) &#123;</div><div class="line">	CFSetRef set = rl-&gt;_commonModes ? CFSetCreateCopy(kCFAllocatorSystemDefault, rl-&gt;_commonModes) : NULL;</div><div class="line">	if (NULL == rl-&gt;_commonModeItems) &#123;</div><div class="line">	    rl-&gt;_commonModeItems = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</div><div class="line">	&#125;</div><div class="line">	CFSetAddValue(rl-&gt;_commonModeItems, rlt);</div><div class="line">	if (NULL != set) &#123;</div><div class="line">	    CFTypeRef context[2] = &#123;rl, rlt&#125;;</div><div class="line">	    /* add new item to all common-modes */</div><div class="line">	    CFSetApplyFunction(set, (__CFRunLoopAddItemToCommonModes), (void *)context);</div><div class="line">	    CFRelease(set);</div><div class="line">	&#125;</div><div class="line">    &#125; else &#123;</div><div class="line">    </div><div class="line">    //åˆ›å»ºtimersçš„æ•°ç»„</div><div class="line">	CFRunLoopModeRef rlm = __CFRunLoopFindMode(rl, modeName, true);</div><div class="line">	if (NULL != rlm) &#123;</div><div class="line">            if (NULL == rlm-&gt;_timers) &#123;</div><div class="line">                CFArrayCallBacks cb = kCFTypeArrayCallBacks;</div><div class="line">                cb.equal = NULL;</div><div class="line">                rlm-&gt;_timers = CFArrayCreateMutable(kCFAllocatorSystemDefault, 0, &amp;cb);</div><div class="line">            &#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	//åˆ¤æ–­timeræ˜¯å¦è¢«æ·»åŠ åˆ°å½“å‰mode</div><div class="line">	if (NULL != rlm &amp;&amp; !CFSetContainsValue(rlt-&gt;_rlModes, rlm-&gt;_name)) &#123;</div><div class="line">            __CFRunLoopTimerLock(rlt);</div><div class="line">            if (NULL == rlt-&gt;_runLoop) &#123;</div><div class="line">		rlt-&gt;_runLoop = rl;</div><div class="line">  	    &#125; else if (rl != rlt-&gt;_runLoop) &#123;</div><div class="line">                __CFRunLoopTimerUnlock(rlt);</div><div class="line">	        __CFRunLoopModeUnlock(rlm);</div><div class="line">                __CFRunLoopUnlock(rl);</div><div class="line">		return;</div><div class="line">	    &#125;</div><div class="line">	    </div><div class="line">	    //timerå°†å½“å‰modeæ ‡è®°ä¸ºå·²æ·»åŠ </div><div class="line">  	    CFSetAddValue(rlt-&gt;_rlModes, rlm-&gt;_name);</div><div class="line">            __CFRunLoopTimerUnlock(rlt);</div><div class="line">            __CFRunLoopTimerFireTSRLock();</div><div class="line">            </div><div class="line">            //æ·»åŠ timeråˆ°mode</div><div class="line">            __CFRepositionTimerInMode(rlm, rlt, false);</div><div class="line">            __CFRunLoopTimerFireTSRUnlock();</div><div class="line">            if (!_CFExecutableLinkedOnOrAfter(CFSystemVersionLion)) &#123;</div><div class="line">                // Normally we don&apos;t do this on behalf of clients, but for</div><div class="line">                // backwards compatibility due to the change in timer handling...</div><div class="line">                if (rl != CFRunLoopGetCurrent()) CFRunLoopWakeUp(rl);</div><div class="line">            &#125;</div><div class="line">	&#125;</div><div class="line">        if (NULL != rlm) &#123;</div><div class="line">	    __CFRunLoopModeUnlock(rlm);</div><div class="line">	&#125;</div><div class="line">    &#125;</div><div class="line">    __CFRunLoopUnlock(rl);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//é‡æ–°æ’åˆ—è¿™ä¸ªmodeä¸­çš„æ‰€æœ‰timerè§¦å‘æ—¶åˆ»</div><div class="line">static void __CFRepositionTimerInMode(CFRunLoopModeRef rlm, CFRunLoopTimerRef rlt, Boolean isInArray) &#123;</div><div class="line">    if (!rlt) return;</div><div class="line">    CFMutableArrayRef timerArray = rlm-&gt;_timers;</div><div class="line">    if (!timerArray) return;</div><div class="line">    Boolean found = false;</div><div class="line">    // If we know in advance that the timer is not in the array (just being added now) then we can skip this search</div><div class="line">    if (isInArray) &#123;</div><div class="line">        CFIndex idx = CFArrayGetFirstIndexOfValue(timerArray, CFRangeMake(0, CFArrayGetCount(timerArray)), rlt);</div><div class="line">        if (kCFNotFound != idx) &#123;</div><div class="line">            CFRetain(rlt);</div><div class="line">            CFArrayRemoveValueAtIndex(timerArray, idx);</div><div class="line">            found = true;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    if (!found &amp;&amp; isInArray) return;</div><div class="line">    CFIndex newIdx = __CFRunLoopInsertionIndexInTimerArray(timerArray, rlt);</div><div class="line">    CFArrayInsertValueAtIndex(timerArray, newIdx, rlt);</div><div class="line">    __CFArmNextTimerInMode(rlm, rlt-&gt;_runLoop);</div><div class="line">    if (isInArray) CFRelease(rlt);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//è¿”å›timeréœ€è¦æ’å…¥çš„ç´¢å¼•</div><div class="line">static CFIndex __CFRunLoopInsertionIndexInTimerArray(CFArrayRef array, CFRunLoopTimerRef rlt) &#123;</div><div class="line">    CFIndex cnt = CFArrayGetCount(array);</div><div class="line">    if (cnt &lt;= 0) &#123;</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //timerå¤§äº256 å¦‚æœæœ€åä¸€ä¸ªitemçš„fireTSRå°äºå¾…æ’å…¥çš„timerï¼Œç›´æ¥æ’å…¥åˆ°æœ€åä¸€ä¸ªä½ç½®å¦åˆ™å¦‚æœç¬¬ä¸€ä¸ªitemçš„fireTSRå¤§äºå¸¦æ’å…¥çš„timer,ç›´æ¥æ’å…¥ç¬¬ä¸€ä¸ªä½ç½®ã€‚</div><div class="line">    if (256 &lt; cnt) &#123;</div><div class="line">        CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, cnt - 1);</div><div class="line">        if (item-&gt;_fireTSR &lt;= rlt-&gt;_fireTSR) &#123;</div><div class="line">            return cnt;</div><div class="line">        &#125;</div><div class="line">        item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, 0);</div><div class="line">        if (rlt-&gt;_fireTSR &lt; item-&gt;_fireTSR) &#123;</div><div class="line">            return 0;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	//äºŒåˆ†æŸ¥æ‰¾ä¸€ä¸ªåˆé€‚çš„ä½ç½®ã€‚</div><div class="line">    CFIndex add = (1 &lt;&lt; flsl(cnt)) * 2;</div><div class="line">    CFIndex idx = 0;</div><div class="line">    Boolean lastTestLEQ;</div><div class="line">    do &#123;</div><div class="line">        add = add / 2;</div><div class="line">	lastTestLEQ = false;</div><div class="line">        CFIndex testIdx = idx + add;</div><div class="line">        if (testIdx &lt; cnt) &#123;</div><div class="line">            CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, testIdx);</div><div class="line">            if (item-&gt;_fireTSR &lt;= rlt-&gt;_fireTSR) &#123;</div><div class="line">                idx = testIdx;</div><div class="line">		lastTestLEQ = true;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; while (0 &lt; add);</div><div class="line"></div><div class="line">    return lastTestLEQ ? idx + 1 : idx;</div><div class="line">&#125;</div><div class="line"></div><div class="line">static void __CFArmNextTimerInMode(CFRunLoopModeRef rlm, CFRunLoopRef rl) &#123;  </div><div class="line">  </div><div class="line">    uint64_t nextHardDeadline = UINT64_MAX;//æœ€æ™šçš„æ—¶é—´ç‚¹</div><div class="line">    uint64_t nextSoftDeadline = UINT64_MAX;//åº”è¯¥è§¦å‘çš„æ—¶é—´ç‚¹</div><div class="line"></div><div class="line">    if (rlm-&gt;_timers) &#123;</div><div class="line">        // Look at the list of timers. We will calculate two TSR values; the next soft and next hard deadline.</div><div class="line">        // The next soft deadline is the first time we can fire any timer. This is the fire date of the first timer in our sorted list of timers.</div><div class="line">        // The next hard deadline is the last time at which we can fire the timer before we&apos;ve moved out of the allowable tolerance of the timers in our list.</div><div class="line">        for (CFIndex idx = 0, cnt = CFArrayGetCount(rlm-&gt;_timers); idx &lt; cnt; idx++) &#123;</div><div class="line">            CFRunLoopTimerRef t = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(rlm-&gt;_timers , idx);</div><div class="line">            // discount timers currently firing</div><div class="line">            if (__CFRunLoopTimerIsFiring(t)) continue;</div><div class="line">            </div><div class="line">            int32_t err = CHECKINT_NO_ERROR;</div><div class="line">            </div><div class="line">            //SoftDeadlineæ˜¯ç†åº”è§¦å‘çš„æ—¶é—´</div><div class="line">            uint64_t oneTimerSoftDeadline = t-&gt;_fireTSR;</div><div class="line">            </div><div class="line">            //HardDeadlineæ˜¯ç†åº”è§¦å‘çš„æ—¶é—´åŠ ä¸Štoleranceï¼ˆå³æœ€æ™šè§¦å‘æ—¶é—´ï¼‰</div><div class="line">            uint64_t oneTimerHardDeadline = check_uint64_add(t-&gt;_fireTSR, __CFTimeIntervalToTSR(t-&gt;_tolerance), &amp;err);</div><div class="line">            </div><div class="line">            if (err != CHECKINT_NO_ERROR) oneTimerHardDeadline = UINT64_MAX;</div><div class="line">            </div><div class="line">            // We can stop searching if the soft deadline for this timer exceeds the current hard deadline. Otherwise, later timers with lower tolerance could still have earlier hard deadlines.</div><div class="line">            </div><div class="line">            //é€šè¿‡è¿™å‡ è¡Œä»£ç å¯¹deadlineè¿›è¡Œä¿®æ­£ï¼Œä¿è¯å‰è¾¹çš„é•¿toleranceçš„timerä¸ä¼šå½±å“åé¢çš„timerçš„è§¦å‘</div><div class="line">            </div><div class="line">            //åº”è§¦å‘çš„æ—¶é—´ç‚¹ &gt; ä¸‹æ¬¡æœ€æ™šè§¦å‘æ—¶é—´ç‚¹ ç›´æ¥é€€å‡º</div><div class="line">            if (oneTimerSoftDeadline &gt; nextHardDeadline) &#123;</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            //åº”è§¦å‘çš„æ—¶é—´ç‚¹ &lt; ä¸‹æ¬¡æœ€æ™šè§¦å‘æ—¶é—´ç‚¹ </div><div class="line">            if (oneTimerSoftDeadline &lt; nextSoftDeadline) &#123;</div><div class="line">                nextSoftDeadline = oneTimerSoftDeadline;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            //æœ€æ™šè§¦å‘æ—¶é—´ç‚¹ &lt; ä¸‹æ¬¡æœ€æ™šè§¦å‘æ—¶é—´ç‚¹</div><div class="line">            if (oneTimerHardDeadline &lt; nextHardDeadline) &#123;</div><div class="line">                nextHardDeadline = oneTimerHardDeadline;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        if (nextSoftDeadline &lt; UINT64_MAX &amp;&amp; (nextHardDeadline != rlm-&gt;_timerHardDeadline || nextSoftDeadline != rlm-&gt;_timerSoftDeadline)) &#123;</div><div class="line">            if (CFRUNLOOP_NEXT_TIMER_ARMED_ENABLED()) &#123;</div><div class="line">                CFRUNLOOP_NEXT_TIMER_ARMED((unsigned long)(nextSoftDeadline - mach_absolute_time()));</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</div><div class="line"></div><div class="line">            // We&apos;re going to hand off the range of allowable timer fire date to dispatch and let it fire when appropriate for the system.</div><div class="line">            uint64_t leeway = __CFTSRToNanoseconds(nextHardDeadline - nextSoftDeadline);</div><div class="line">            dispatch_time_t deadline = __CFTSRToDispatchTime(nextSoftDeadline);</div><div class="line">            </div><div class="line">#if USE_MK_TIMER_TOO</div><div class="line"></div><div class="line">				//å¯¹äºæœ‰leewayçš„æƒ…å†µï¼ˆæœ‰toleranceçš„æƒ…å†µï¼‰ï¼Œåªé‡‡ç”¨_dispatch_source_set_runloop_timer_4CFçš„æ–¹æ³•</div><div class="line">            if (leeway &gt; 0) &#123;</div><div class="line">                // Only use the dispatch timer if we have any leeway</div><div class="line">                // &lt;rdar://problem/14447675&gt;</div><div class="line">                </div><div class="line">                // Cancel the mk timer</div><div class="line">                if (rlm-&gt;_mkTimerArmed &amp;&amp; rlm-&gt;_timerPort) &#123;</div><div class="line">                    AbsoluteTime dummy;</div><div class="line">                    mk_timer_cancel(rlm-&gt;_timerPort, &amp;dummy);</div><div class="line">                    rlm-&gt;_mkTimerArmed = false;</div><div class="line">                &#125;</div><div class="line">                </div><div class="line">                // Arm the dispatch timer</div><div class="line">                _dispatch_source_set_runloop_timer_4CF(rlm-&gt;_timerSource, deadline, DISPATCH_TIME_FOREVER, leeway);</div><div class="line">                rlm-&gt;_dispatchTimerArmed = true;</div><div class="line">            &#125; else &#123;</div><div class="line">            </div><div class="line">            // å¯¹äºleewayä¸º0çš„æƒ…å†µï¼ˆæ— toleranceçš„æƒ…å†µï¼‰,é‡‡ç”¨mk_timerçš„æ–¹å¼</div><div class="line">                // Cancel the dispatch timer</div><div class="line">                if (rlm-&gt;_dispatchTimerArmed) &#123;</div><div class="line">                    // Cancel the dispatch timer</div><div class="line">                    _dispatch_source_set_runloop_timer_4CF(rlm-&gt;_timerSource, DISPATCH_TIME_FOREVER, DISPATCH_TIME_FOREVER, 888);</div><div class="line">                    rlm-&gt;_dispatchTimerArmed = false;</div><div class="line">                &#125;</div><div class="line">                </div><div class="line">                // Arm the mk timer</div><div class="line">                if (rlm-&gt;_timerPort) &#123;</div><div class="line">                    mk_timer_arm(rlm-&gt;_timerPort, __CFUInt64ToAbsoluteTime(nextSoftDeadline));</div><div class="line">                    rlm-&gt;_mkTimerArmed = true;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">#else</div><div class="line">            _dispatch_source_set_runloop_timer_4CF(rlm-&gt;_timerSource, deadline, DISPATCH_TIME_FOREVER, leeway);</div><div class="line">#endif</div><div class="line">#else</div><div class="line">            if (rlm-&gt;_timerPort) &#123;</div><div class="line">                mk_timer_arm(rlm-&gt;_timerPort, __CFUInt64ToAbsoluteTime(nextSoftDeadline));</div><div class="line">            &#125;</div><div class="line">#endif</div><div class="line">        &#125; else if (nextSoftDeadline == UINT64_MAX) &#123;</div><div class="line">            // Disarm the timers - there is no timer scheduled</div><div class="line">            // ç§»é™¤timer</div><div class="line">            if (rlm-&gt;_mkTimerArmed &amp;&amp; rlm-&gt;_timerPort) &#123;</div><div class="line">                AbsoluteTime dummy;</div><div class="line">                mk_timer_cancel(rlm-&gt;_timerPort, &amp;dummy);</div><div class="line">                rlm-&gt;_mkTimerArmed = false;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</div><div class="line">            if (rlm-&gt;_dispatchTimerArmed) &#123;</div><div class="line">                _dispatch_source_set_runloop_timer_4CF(rlm-&gt;_timerSource, DISPATCH_TIME_FOREVER, DISPATCH_TIME_FOREVER, 333);</div><div class="line">                rlm-&gt;_dispatchTimerArmed = false;</div><div class="line">            &#125;</div><div class="line">#endif</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    rlm-&gt;_timerHardDeadline = nextHardDeadline;</div><div class="line">    rlm-&gt;_timerSoftDeadline = nextSoftDeadline;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">//å¤„ç†timer</div><div class="line">// mode and rl are locked on entry and exit</div><div class="line">static Boolean __CFRunLoopDoTimer(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFRunLoopTimerRef rlt) &#123;	/* DOES CALLOUT */</div><div class="line">    Boolean timerHandled = false;</div><div class="line">    uint64_t oldFireTSR = 0;</div><div class="line"></div><div class="line">    /* Fire a timer */</div><div class="line">    CFRetain(rlt);</div><div class="line">    __CFRunLoopTimerLock(rlt);</div><div class="line">	</div><div class="line">	//ä¸€å †åˆ¤æ–­æ¡ä»¶</div><div class="line">    if (__CFIsValid(rlt) &amp;&amp; rlt-&gt;_fireTSR &lt;= mach_absolute_time() &amp;&amp; !__CFRunLoopTimerIsFiring(rlt) &amp;&amp; rlt-&gt;_runLoop == rl) &#123;</div><div class="line">        void *context_info = NULL;</div><div class="line">        void (*context_release)(const void *) = NULL;</div><div class="line">        if (rlt-&gt;_context.retain) &#123;</div><div class="line">            context_info = (void *)rlt-&gt;_context.retain(rlt-&gt;_context.info);</div><div class="line">            context_release = rlt-&gt;_context.release;</div><div class="line">        &#125; else &#123;</div><div class="line">            context_info = rlt-&gt;_context.info;</div><div class="line">        &#125;</div><div class="line">        Boolean doInvalidate = (0.0 == rlt-&gt;_interval);</div><div class="line">	__CFRunLoopTimerSetFiring(rlt);</div><div class="line">        // Just in case the next timer has exactly the same deadlines as this one, we reset these values so that the arm next timer code can correctly find the next timer in the list and arm the underlying timer.</div><div class="line">        </div><div class="line">        //é‡ç½®åº”è§¦å‘æ—¶é—´å’Œæœ€æ™šè§¦å‘æ—¶é—´</div><div class="line">        rlm-&gt;_timerSoftDeadline = UINT64_MAX;</div><div class="line">        rlm-&gt;_timerHardDeadline = UINT64_MAX;</div><div class="line">        __CFRunLoopTimerUnlock(rlt);</div><div class="line">	__CFRunLoopTimerFireTSRLock();</div><div class="line">	oldFireTSR = rlt-&gt;_fireTSR;</div><div class="line">	__CFRunLoopTimerFireTSRUnlock();</div><div class="line"></div><div class="line">        __CFArmNextTimerInMode(rlm, rl);</div><div class="line"></div><div class="line">	__CFRunLoopModeUnlock(rlm);</div><div class="line">	__CFRunLoopUnlock(rl);</div><div class="line">	</div><div class="line">	//å¤„ç†timerçš„å›è°ƒ</div><div class="line">	__CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__(rlt-&gt;_callout, rlt, context_info);</div><div class="line">	CHECK_FOR_FORK();</div><div class="line">        if (doInvalidate) &#123;</div><div class="line">            CFRunLoopTimerInvalidate(rlt);      /* DOES CALLOUT */</div><div class="line">        &#125;</div><div class="line">        if (context_release) &#123;</div><div class="line">            context_release(context_info);</div><div class="line">        &#125;</div><div class="line">	__CFRunLoopLock(rl);</div><div class="line">	__CFRunLoopModeLock(rlm);</div><div class="line">        __CFRunLoopTimerLock(rlt);</div><div class="line">        </div><div class="line">    //timerå¤„ç†æˆåŠŸçš„æ ‡è®°</div><div class="line">	timerHandled = true;</div><div class="line">	__CFRunLoopTimerUnsetFiring(rlt);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //æœ¬æ¬¡timerå¤„ç†æˆåŠŸäº† æ¥æ›´æ–°ä¸€ä¸‹ä¸‹æ¬¡çš„è§¦å‘æ—¶é—´</div><div class="line">    if (__CFIsValid(rlt) &amp;&amp; timerHandled) &#123;</div><div class="line">        /* This is just a little bit tricky: we want to support calling</div><div class="line">         * CFRunLoopTimerSetNextFireDate() from within the callout and</div><div class="line">         * honor that new time here if it is a later date, otherwise</div><div class="line">         * it is completely ignored. */</div><div class="line"></div><div class="line">         //ä¸€ä¸‹æ¬¡çš„è§¦å‘æ—¶é—´å·²ç»è®¾ç½®äº† è€Œä¸”æ¯”ä¸Šæ¬¡çš„æ—¶é—´å¤§ è¯´æ˜è®¾ç½®çš„æ²¡æœ‰é—®é¢˜ï¼Œç›´æ¥æ›´æ–°ã€‚</div><div class="line">        if (oldFireTSR &lt; rlt-&gt;_fireTSR) &#123;</div><div class="line">            /* Next fire TSR was set, and set to a date after the previous</div><div class="line">            * fire date, so we honor it. */</div><div class="line">            __CFRunLoopTimerUnlock(rlt);</div><div class="line">            // The timer was adjusted and repositioned, during the</div><div class="line">            // callout, but if it was still the min timer, it was</div><div class="line">            // skipped because it was firing.  Need to redo the</div><div class="line">            // min timer calculation in case rlt should now be that</div><div class="line">            // timer instead of whatever was chosen.</div><div class="line">            </div><div class="line">            //è¿™ä¸ªå‡½æ•°å°±æ˜¯æ›´æ–°ä¸‹æ¬¡è§¦å‘æ—¶é—´çš„</div><div class="line">            __CFArmNextTimerInMode(rlm, rl);</div><div class="line">        &#125; else &#123;</div><div class="line">        </div><div class="line">        //æ²¡æœ‰è®¾ç½®ä¸‹ä¸€æ¬¡çš„è§¦å‘æ—¶é—´ï¼Œè¿›è¡Œè®¾ç½®ï¼Œç„¶åæ›´æ–°åˆ—è¡¨</div><div class="line">	    uint64_t nextFireTSR = 0LL;</div><div class="line">            uint64_t intervalTSR = 0LL;</div><div class="line">            if (rlt-&gt;_interval &lt;= 0.0) &#123;</div><div class="line">            &#125; else if (TIMER_INTERVAL_LIMIT &lt; rlt-&gt;_interval) &#123;</div><div class="line">        	intervalTSR = __CFTimeIntervalToTSR(TIMER_INTERVAL_LIMIT);</div><div class="line">            &#125; else &#123;</div><div class="line">        	intervalTSR = __CFTimeIntervalToTSR(rlt-&gt;_interval);</div><div class="line">            &#125;</div><div class="line">            if (LLONG_MAX - intervalTSR &lt;= oldFireTSR) &#123;</div><div class="line">                nextFireTSR = LLONG_MAX;</div><div class="line">            &#125; else &#123;</div><div class="line">                if (intervalTSR == 0) &#123;</div><div class="line">                    // 15304159: Make sure we don&apos;t accidentally loop forever here</div><div class="line">                    CRSetCrashLogMessage(&quot;A CFRunLoopTimer with an interval of 0 is set to repeat&quot;);</div><div class="line">                    HALT;</div><div class="line">                &#125;</div><div class="line">                uint64_t currentTSR = mach_absolute_time();</div><div class="line">                nextFireTSR = oldFireTSR;</div><div class="line">                while (nextFireTSR &lt;= currentTSR) &#123;</div><div class="line">                    nextFireTSR += intervalTSR;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            CFRunLoopRef rlt_rl = rlt-&gt;_runLoop;</div><div class="line">            if (rlt_rl) &#123;</div><div class="line">                CFRetain(rlt_rl);</div><div class="line">		CFIndex cnt = CFSetGetCount(rlt-&gt;_rlModes);</div><div class="line">		STACK_BUFFER_DECL(CFTypeRef, modes, cnt);</div><div class="line">		CFSetGetValues(rlt-&gt;_rlModes, (const void **)modes);</div><div class="line">		// To avoid A-&gt;B, B-&gt;A lock ordering issues when coming up</div><div class="line">		// towards the run loop from a source, the timer has to be</div><div class="line">		// unlocked, which means we have to protect from object</div><div class="line">		// invalidation, although that&apos;s somewhat expensive.</div><div class="line">		for (CFIndex idx = 0; idx &lt; cnt; idx++) &#123;</div><div class="line">		    CFRetain(modes[idx]);</div><div class="line">		&#125;</div><div class="line">		__CFRunLoopTimerUnlock(rlt);</div><div class="line">		for (CFIndex idx = 0; idx &lt; cnt; idx++) &#123;</div><div class="line">		    CFStringRef name = (CFStringRef)modes[idx];</div><div class="line">		    modes[idx] = (CFTypeRef)__CFRunLoopFindMode(rlt_rl, name, false);</div><div class="line">		    CFRelease(name);</div><div class="line">		&#125;</div><div class="line">		__CFRunLoopTimerFireTSRLock();</div><div class="line">		</div><div class="line">		//ä¸Šé¢ç®—äº†ä¸€å †å°±æ˜¯è®¡ç®—ä¸€ä¸ªæ­£ç¡®çš„nextFireTSRï¼Œåˆ°è¿™é‡Œå·²ç»æ‹¿åˆ°æ­£ç¡®çš„å€¼äº†ï¼Œå¯ä»¥èµ‹å€¼ã€‚</div><div class="line">		rlt-&gt;_fireTSR = nextFireTSR;</div><div class="line">                rlt-&gt;_nextFireDate = CFAbsoluteTimeGetCurrent() + __CFTimeIntervalUntilTSR(nextFireTSR);</div><div class="line">		for (CFIndex idx = 0; idx &lt; cnt; idx++) &#123;</div><div class="line">		    CFRunLoopModeRef rlm = (CFRunLoopModeRef)modes[idx];</div><div class="line">		    if (rlm) &#123;</div><div class="line">		    </div><div class="line">		    //æ›´æ–°æ—¶é—´è§¦å‘çš„åˆ—è¡¨</div><div class="line">                        __CFRepositionTimerInMode(rlm, rlt, true);</div><div class="line">		    &#125;</div><div class="line">		&#125;</div><div class="line">		__CFRunLoopTimerFireTSRUnlock();</div><div class="line">		for (CFIndex idx = 0; idx &lt; cnt; idx++) &#123;</div><div class="line">		    __CFRunLoopModeUnlock((CFRunLoopModeRef)modes[idx]);</div><div class="line">		&#125;</div><div class="line">		CFRelease(rlt_rl);</div><div class="line">	    &#125; else &#123;</div><div class="line">	    </div><div class="line">	    //timeræ²¡æœ‰åŠ åˆ°ä¸€ä¸ªrunloopé‡Œé¢ã€‚è¿™ä¸ªtimeråº”è¯¥ä¸ä¼šè¢«è§¦å‘ã€‚ä¸‹é¢ä¹Ÿæ²¡æœ‰è°ƒæ•´ä¸‹æ¬¡è§¦å‘æ—¶é—´çš„æ“ä½œã€‚ã€‚ã€‚</div><div class="line">		__CFRunLoopTimerUnlock(rlt);</div><div class="line">		__CFRunLoopTimerFireTSRLock();</div><div class="line">		rlt-&gt;_fireTSR = nextFireTSR;</div><div class="line">                rlt-&gt;_nextFireDate = CFAbsoluteTimeGetCurrent() + __CFTimeIntervalUntilTSR(nextFireTSR);</div><div class="line">		__CFRunLoopTimerFireTSRUnlock();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        __CFRunLoopTimerUnlock(rlt);</div><div class="line">    &#125;</div><div class="line">    CFRelease(rlt);</div><div class="line">    return timerHandled;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="timeræ€»ç»“"><a href="#timeræ€»ç»“" class="headerlink" title="timeræ€»ç»“"></a>timeræ€»ç»“</h5><p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Runloop/runloop008.png" alt=""></p>
<ul>
<li>å¯¹äºé‡å¤çš„NSTimerï¼Œå…¶å¤šæ¬¡è§¦å‘çš„æ—¶åˆ»ä¸æ˜¯ä¸€å¼€å§‹ç®—å¥½çš„ï¼Œè€Œæ˜¯timerè§¦å‘åè®¡ç®—çš„ã€‚ä½†æ˜¯è®¡ç®—æ—¶å‚è€ƒçš„æ˜¯ä¸Šæ¬¡åº”å½“è§¦å‘çš„æ—¶é—´_fireTSRï¼Œå› æ­¤è®¡ç®—å‡ºçš„ä¸‹æ¬¡è§¦å‘çš„æ—¶åˆ»ä¸ä¼šæœ‰è¯¯å·®ã€‚</li>
<li>è®¾ç½®äº†toleranceçš„NSTimerï¼Œå¯¹äºiOSå’ŒMacOSç³»ç»Ÿï¼Œå®è´¨ä¸Šä¼šé‡‡ç”¨GCD timerçš„å½¢å¼æ³¨å†Œåˆ°å†…æ ¸ä¸­ï¼ŒGCD timerè§¦å‘åï¼Œå†ç”±RunLoopå¤„ç†å…¶å›è°ƒé€»è¾‘ã€‚å¯¹äºæ²¡æœ‰è®¾ç½®toleranceçš„timerï¼Œåˆ™æ˜¯ç”¨mk_timerçš„å½¢å¼æ³¨å†Œã€‚</li>
<li>RunLoopModeä¸­timerçš„æ’åºæ˜¯æŒ‰ç…§_fireTSRï¼Œä¹Ÿå°±æ˜¯åº”å½“è§¦å‘çš„æ—¶é—´æ’åºçš„ã€‚</li>
</ul>
<h5 id="Observer"><a href="#Observer" class="headerlink" title="Observer"></a>Observer</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div></pre></td><td class="code"><pre><div class="line">//åˆ›å»ºobserver</div><div class="line"></div><div class="line">CFRunLoopObserverRef CFRunLoopObserverCreate(CFAllocatorRef allocator, CFOptionFlags activities, Boolean repeats, CFIndex order, CFRunLoopObserverCallBack callout, CFRunLoopObserverContext *context) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    CFRunLoopObserverRef memory;</div><div class="line">    UInt32 size;</div><div class="line">    size = sizeof(struct __CFRunLoopObserver) - sizeof(CFRuntimeBase);</div><div class="line">    memory = (CFRunLoopObserverRef)_CFRuntimeCreateInstance(allocator, CFRunLoopObserverGetTypeID(), size, NULL);</div><div class="line">    if (NULL == memory) &#123;</div><div class="line">	return NULL;</div><div class="line">    &#125;</div><div class="line">    __CFSetValid(memory);</div><div class="line">    __CFRunLoopObserverUnsetFiring(memory);</div><div class="line">    if (repeats) &#123;</div><div class="line">	__CFRunLoopObserverSetRepeats(memory);</div><div class="line">    &#125; else &#123;</div><div class="line">	__CFRunLoopObserverUnsetRepeats(memory);</div><div class="line">    &#125;</div><div class="line">    __CFRunLoopLockInit(&amp;memory-&gt;_lock);</div><div class="line">    memory-&gt;_runLoop = NULL;</div><div class="line">    memory-&gt;_rlCount = 0;</div><div class="line">    memory-&gt;_activities = activities;</div><div class="line">    memory-&gt;_order = order;</div><div class="line">    memory-&gt;_callout = callout;</div><div class="line">    if (context) &#123;</div><div class="line">	if (context-&gt;retain) &#123;</div><div class="line">	    memory-&gt;_context.info = (void *)context-&gt;retain(context-&gt;info);</div><div class="line">	&#125; else &#123;</div><div class="line">	    memory-&gt;_context.info = context-&gt;info;</div><div class="line">	&#125;</div><div class="line">	memory-&gt;_context.retain = context-&gt;retain;</div><div class="line">	memory-&gt;_context.release = context-&gt;release;</div><div class="line">	memory-&gt;_context.copyDescription = context-&gt;copyDescription;</div><div class="line">    &#125; else &#123;</div><div class="line">	memory-&gt;_context.info = 0;</div><div class="line">	memory-&gt;_context.retain = 0;</div><div class="line">	memory-&gt;_context.release = 0;</div><div class="line">	memory-&gt;_context.copyDescription = 0;</div><div class="line">    &#125;</div><div class="line">    return memory;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//ç»™modeæ·»åŠ observer</div><div class="line"></div><div class="line">void CFRunLoopAddObserver(CFRunLoopRef rl, CFRunLoopObserverRef rlo, CFStringRef modeName) &#123;</div><div class="line"></div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    CFRunLoopModeRef rlm;</div><div class="line">    if (__CFRunLoopIsDeallocating(rl)) return;</div><div class="line">    if (!__CFIsValid(rlo) || (NULL != rlo-&gt;_runLoop &amp;&amp; rlo-&gt;_runLoop != rl)) return;</div><div class="line">    __CFRunLoopLock(rl);</div><div class="line">    </div><div class="line">    </div><div class="line">    //å¦‚æœæ˜¯common modeç›´æ¥åŠ åˆ°_commonModeItems</div><div class="line">    if (modeName == kCFRunLoopCommonModes) &#123;</div><div class="line">	CFSetRef set = rl-&gt;_commonModes ? CFSetCreateCopy(kCFAllocatorSystemDefault, rl-&gt;_commonModes) : NULL;</div><div class="line">	if (NULL == rl-&gt;_commonModeItems) &#123;</div><div class="line">	    rl-&gt;_commonModeItems = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</div><div class="line">	&#125;</div><div class="line">	CFSetAddValue(rl-&gt;_commonModeItems, rlo);</div><div class="line">	if (NULL != set) &#123;</div><div class="line">	    CFTypeRef context[2] = &#123;rl, rlo&#125;;</div><div class="line">	    /* add new item to all common-modes */</div><div class="line">	    CFSetApplyFunction(set, (__CFRunLoopAddItemToCommonModes), (void *)context);</div><div class="line">	    CFRelease(set);</div><div class="line">	&#125;</div><div class="line">    &#125; else &#123;</div><div class="line">    </div><div class="line">    //åˆ›å»º_observersæ•°ç»„</div><div class="line">	rlm = __CFRunLoopFindMode(rl, modeName, true);</div><div class="line">	if (NULL != rlm &amp;&amp; NULL == rlm-&gt;_observers) &#123;</div><div class="line">	    rlm-&gt;_observers = CFArrayCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeArrayCallBacks);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	//åˆ¤æ–­æ˜¯å¦å·²æ·»åŠ </div><div class="line">	if (NULL != rlm &amp;&amp; !CFArrayContainsValue(rlm-&gt;_observers, CFRangeMake(0, CFArrayGetCount(rlm-&gt;_observers)), rlo)) &#123;</div><div class="line">            Boolean inserted = false;</div><div class="line">            for (CFIndex idx = CFArrayGetCount(rlm-&gt;_observers); idx--; ) &#123;</div><div class="line">                CFRunLoopObserverRef obs = (CFRunLoopObserverRef)CFArrayGetValueAtIndex(rlm-&gt;_observers, idx);</div><div class="line">                </div><div class="line">                //æœ‰ä¸€ä¸ªæ’åºï¼Œåªæœ‰orderå¤§äºå·²æ·»åŠ çš„observer æ‰ä¼šè¢«æ·»åŠ åˆ°æ•°ç»„ä¸­</div><div class="line">                if (obs-&gt;_order &lt;= rlo-&gt;_order) &#123;</div><div class="line">                    CFArrayInsertValueAtIndex(rlm-&gt;_observers, idx + 1, rlo);</div><div class="line">                    inserted = true;</div><div class="line">                    break;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            //æ·»åŠ å¤±è´¥ç›´æ¥æ’åˆ°ç¬¬ä¸€ä¸ªä½ç½®</div><div class="line">            if (!inserted) &#123;</div><div class="line">	        CFArrayInsertValueAtIndex(rlm-&gt;_observers, 0, rlo);</div><div class="line">            &#125;</div><div class="line">	    rlm-&gt;_observerMask |= rlo-&gt;_activities;</div><div class="line">	    __CFRunLoopObserverSchedule(rlo, rl, rlm);</div><div class="line">	&#125;</div><div class="line">        if (NULL != rlm) &#123;</div><div class="line">	    __CFRunLoopModeUnlock(rlm);</div><div class="line">	&#125;</div><div class="line">    &#125;</div><div class="line">    __CFRunLoopUnlock(rl);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static void __CFRunLoopDoObservers(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFRunLoopActivity activity) &#123;	/* DOES CALLOUT */</div><div class="line">    CHECK_FOR_FORK();</div><div class="line"></div><div class="line">    CFIndex cnt = rlm-&gt;_observers ? CFArrayGetCount(rlm-&gt;_observers) : 0;</div><div class="line">    if (cnt &lt; 1) return;</div><div class="line"></div><div class="line">    /* Fire the observers */</div><div class="line">    STACK_BUFFER_DECL(CFRunLoopObserverRef, buffer, (cnt &lt;= 1024) ? cnt : 1);</div><div class="line">    CFRunLoopObserverRef *collectedObservers = (cnt &lt;= 1024) ? buffer : (CFRunLoopObserverRef *)malloc(cnt * sizeof(CFRunLoopObserverRef));</div><div class="line">    CFIndex obs_cnt = 0;</div><div class="line">    </div><div class="line">    //å°†åˆ—è¡¨ä¸­ æ´»åŠ¨ &amp;&amp; å¯ç”¨ &amp;&amp; æœªå¤„ç† çš„observeræ·»åŠ åˆ°ä¸€ä¸ªä¸´æ—¶çš„æ•°ç»„ä¸­</div><div class="line">    for (CFIndex idx = 0; idx &lt; cnt; idx++) &#123;</div><div class="line">        CFRunLoopObserverRef rlo = (CFRunLoopObserverRef)CFArrayGetValueAtIndex(rlm-&gt;_observers, idx);</div><div class="line">        if (0 != (rlo-&gt;_activities &amp; activity) &amp;&amp; __CFIsValid(rlo) &amp;&amp; !__CFRunLoopObserverIsFiring(rlo)) &#123;</div><div class="line">            collectedObservers[obs_cnt++] = (CFRunLoopObserverRef)CFRetain(rlo);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    __CFRunLoopModeUnlock(rlm);</div><div class="line">    __CFRunLoopUnlock(rl);</div><div class="line">    for (CFIndex idx = 0; idx &lt; obs_cnt; idx++) &#123;</div><div class="line">        CFRunLoopObserverRef rlo = collectedObservers[idx];</div><div class="line">        __CFRunLoopObserverLock(rlo);</div><div class="line">        if (__CFIsValid(rlo)) &#123;</div><div class="line">            Boolean doInvalidate = !__CFRunLoopObserverRepeats(rlo);</div><div class="line">            __CFRunLoopObserverSetFiring(rlo);</div><div class="line">            __CFRunLoopObserverUnlock(rlo);</div><div class="line">            </div><div class="line">            //è°ƒç”¨observerçš„å›è°ƒ</div><div class="line">            __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(rlo-&gt;_callout, rlo, activity, rlo-&gt;_context.info);</div><div class="line">            if (doInvalidate) &#123;</div><div class="line">                CFRunLoopObserverInvalidate(rlo);</div><div class="line">            &#125;</div><div class="line">            __CFRunLoopObserverUnsetFiring(rlo);</div><div class="line">        &#125; else &#123;</div><div class="line">            __CFRunLoopObserverUnlock(rlo);</div><div class="line">        &#125;</div><div class="line">        CFRelease(rlo);</div><div class="line">    &#125;</div><div class="line">    __CFRunLoopLock(rl);</div><div class="line">    __CFRunLoopModeLock(rlm);</div><div class="line"></div><div class="line">    if (collectedObservers != buffer) free(collectedObservers);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="Block"><a href="#Block" class="headerlink" title="Block"></a>Block</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">//ç»™runloopæ·»åŠ ä¸€ä¸ªblock</div><div class="line"></div><div class="line">void CFRunLoopPerformBlock(CFRunLoopRef rl, CFTypeRef mode, void (^block)(void)) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    </div><div class="line">    //ä¿è¯modeå­˜åœ¨</div><div class="line">    </div><div class="line">    if (CFStringGetTypeID() == CFGetTypeID(mode)) &#123;</div><div class="line">	mode = CFStringCreateCopy(kCFAllocatorSystemDefault, (CFStringRef)mode);</div><div class="line">        __CFRunLoopLock(rl);</div><div class="line">	// ensure mode exists</div><div class="line">        CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, (CFStringRef)mode, true);</div><div class="line">        if (currentMode) __CFRunLoopModeUnlock(currentMode);</div><div class="line">        __CFRunLoopUnlock(rl);</div><div class="line">    &#125; else if (CFArrayGetTypeID() == CFGetTypeID(mode)) &#123;</div><div class="line">        CFIndex cnt = CFArrayGetCount((CFArrayRef)mode);</div><div class="line">	const void **values = (const void **)malloc(sizeof(const void *) * cnt);</div><div class="line">        CFArrayGetValues((CFArrayRef)mode, CFRangeMake(0, cnt), values);</div><div class="line">	mode = CFSetCreate(kCFAllocatorSystemDefault, values, cnt, &amp;kCFTypeSetCallBacks);</div><div class="line">        __CFRunLoopLock(rl);</div><div class="line">	// ensure modes exist</div><div class="line">	for (CFIndex idx = 0; idx &lt; cnt; idx++) &#123;</div><div class="line">            CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, (CFStringRef)values[idx], true);</div><div class="line">            if (currentMode) __CFRunLoopModeUnlock(currentMode);</div><div class="line">	&#125;</div><div class="line">        __CFRunLoopUnlock(rl);</div><div class="line">	free(values);</div><div class="line">    &#125; else if (CFSetGetTypeID() == CFGetTypeID(mode)) &#123;</div><div class="line">        CFIndex cnt = CFSetGetCount((CFSetRef)mode);</div><div class="line">	const void **values = (const void **)malloc(sizeof(const void *) * cnt);</div><div class="line">        CFSetGetValues((CFSetRef)mode, values);</div><div class="line">	mode = CFSetCreate(kCFAllocatorSystemDefault, values, cnt, &amp;kCFTypeSetCallBacks);</div><div class="line">        __CFRunLoopLock(rl);</div><div class="line">	// ensure modes exist</div><div class="line">	for (CFIndex idx = 0; idx &lt; cnt; idx++) &#123;</div><div class="line">            CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, (CFStringRef)values[idx], true);</div><div class="line">            if (currentMode) __CFRunLoopModeUnlock(currentMode);</div><div class="line">	&#125;</div><div class="line">        __CFRunLoopUnlock(rl);</div><div class="line">	free(values);</div><div class="line">    &#125; else &#123;</div><div class="line">	mode = NULL;</div><div class="line">    &#125;</div><div class="line">    block = Block_copy(block);</div><div class="line">    </div><div class="line">    //å¦‚æœmodeæˆ–è€…blockä¸ºç©º ç›´æ¥è¿”å›</div><div class="line">    if (!mode || !block) &#123;</div><div class="line">	if (mode) CFRelease(mode);</div><div class="line">	if (block) Block_release(block);</div><div class="line">	return;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //å°†blockæ·»åŠ åˆ°åˆ—è¡¨ä¸­</div><div class="line">    __CFRunLoopLock(rl);</div><div class="line">    struct _block_item *new_item = (struct _block_item *)malloc(sizeof(struct _block_item));</div><div class="line">    new_item-&gt;_next = NULL;</div><div class="line">    new_item-&gt;_mode = mode;</div><div class="line">    new_item-&gt;_block = block;</div><div class="line">    if (!rl-&gt;_blocks_tail) &#123;</div><div class="line">	rl-&gt;_blocks_head = new_item;</div><div class="line">    &#125; else &#123;</div><div class="line">	rl-&gt;_blocks_tail-&gt;_next = new_item;</div><div class="line">    &#125;</div><div class="line">    rl-&gt;_blocks_tail = new_item;</div><div class="line">    __CFRunLoopUnlock(rl);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">//å¤„ç†block</div><div class="line"></div><div class="line">static Boolean __CFRunLoopDoBlocks(CFRunLoopRef rl, CFRunLoopModeRef rlm) &#123; // Call with rl and rlm locked</div><div class="line">    if (!rl-&gt;_blocks_head) return false;</div><div class="line">    if (!rlm || !rlm-&gt;_name) return false;</div><div class="line">    Boolean did = false;</div><div class="line">    struct _block_item *head = rl-&gt;_blocks_head;</div><div class="line">    struct _block_item *tail = rl-&gt;_blocks_tail;</div><div class="line">    rl-&gt;_blocks_head = NULL;</div><div class="line">    rl-&gt;_blocks_tail = NULL;</div><div class="line">    CFSetRef commonModes = rl-&gt;_commonModes;</div><div class="line">    CFStringRef curMode = rlm-&gt;_name;</div><div class="line">    __CFRunLoopModeUnlock(rlm);</div><div class="line">    __CFRunLoopUnlock(rl);</div><div class="line">    struct _block_item *prev = NULL;</div><div class="line">    struct _block_item *item = head;</div><div class="line">    </div><div class="line">    //éå†blockåˆ—è¡¨</div><div class="line">    while (item) &#123;</div><div class="line">        struct _block_item *curr = item;</div><div class="line">        item = item-&gt;_next;</div><div class="line">	Boolean doit = false;</div><div class="line">	</div><div class="line">	//å½“å‰modeæ˜¯blockæ‰€å±çš„modeä¸€æ · || å½“å‰modeæ˜¯common modeä¸”commonsä¸­åŒ…å«äº†å½“å‰mode</div><div class="line">	if (CFStringGetTypeID() == CFGetTypeID(curr-&gt;_mode)) &#123;</div><div class="line">	    doit = CFEqual(curr-&gt;_mode, curMode) || (CFEqual(curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(commonModes, curMode));</div><div class="line">        &#125; else &#123;</div><div class="line">	    doit = CFSetContainsValue((CFSetRef)curr-&gt;_mode, curMode) || (CFSetContainsValue((CFSetRef)curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(commonModes, curMode));</div><div class="line">	&#125;</div><div class="line">	if (!doit) prev = curr;</div><div class="line">	if (doit) &#123;</div><div class="line">	    if (prev) prev-&gt;_next = item;</div><div class="line">	    if (curr == head) head = item;</div><div class="line">	    if (curr == tail) tail = prev;</div><div class="line">	    void (^block)(void) = curr-&gt;_block;</div><div class="line">            CFRelease(curr-&gt;_mode);</div><div class="line">            free(curr);</div><div class="line">	    if (doit) &#123;</div><div class="line">	    </div><div class="line">		    //è°ƒç”¨block</div><div class="line">                __CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__(block);</div><div class="line">	        did = true;</div><div class="line">	    &#125;</div><div class="line">            Block_release(block); // do this before relocking to prevent deadlocks where some yahoo wants to run the run loop reentrantly from their dealloc</div><div class="line">	&#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    __CFRunLoopLock(rl);</div><div class="line">    __CFRunLoopModeLock(rlm);</div><div class="line">    if (head) &#123;</div><div class="line">	tail-&gt;_next = rl-&gt;_blocks_head;</div><div class="line">	rl-&gt;_blocks_head = head;</div><div class="line">        if (!rl-&gt;_blocks_tail) rl-&gt;_blocks_tail = tail;</div><div class="line">    &#125;</div><div class="line">    return did;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="blockæ€»ç»“"><a href="#blockæ€»ç»“" class="headerlink" title="blockæ€»ç»“"></a>blockæ€»ç»“</h5><ul>
<li>å¯ä»¥ç›´æ¥ç»™runloopæ·»åŠ block.æ·»åŠ æˆåŠŸåï¼Œblockä¼šåœ¨ä¸‹ä¸€æ¬¡runloopè¿è¡Œæ—¶è¢«è§¦å‘ã€‚</li>
<li>blockä¸èƒ½å”¤é†’runloop,åªä¼šè¢«æ·»åŠ åˆ°é“¾è¡¨ä¸­ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡runloopè¢«å”¤é†’åæ‰ä¼šè¢«æ‰§è¡Œã€‚</li>
</ul>
<h3 id="Runloopå®è·µ"><a href="#Runloopå®è·µ" class="headerlink" title="Runloopå®è·µ"></a>Runloopå®è·µ</h3><h4 id="æŸ¥çœ‹Main-Runloopçš„ç»“æ„"><a href="#æŸ¥çœ‹Main-Runloopçš„ç»“æ„" class="headerlink" title="æŸ¥çœ‹Main Runloopçš„ç»“æ„"></a>æŸ¥çœ‹Main Runloopçš„ç»“æ„</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">NSRunLoop *runloop = [NSRunLoop mainRunLoop];</div><div class="line">NSLog(@&quot;runloop = %@&quot;,runloop);</div></pre></td></tr></table></figure>
<h5 id="å…·ä½“ç»“æ„å¦‚ä¸‹ï¼š"><a href="#å…·ä½“ç»“æ„å¦‚ä¸‹ï¼š" class="headerlink" title="å…·ä½“ç»“æ„å¦‚ä¸‹ï¼š"></a>å…·ä½“ç»“æ„å¦‚ä¸‹ï¼š</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div></pre></td><td class="code"><pre><div class="line">&lt;CFRunLoop 0x60c0001e7800 [0x10805cc80]&gt;&#123;</div><div class="line"></div><div class="line">//å”¤é†’ç«¯å£ &amp;&amp; å½“å‰çŠ¶æ€ &amp;&amp; æ˜¯å¦å¿½ç•¥å”¤é†’</div><div class="line">wakeup port = 0x1803, stopped = false, ignoreWakeUps = false, </div><div class="line"></div><div class="line">//current mode</div><div class="line">current mode = kCFRunLoopDefaultMode,</div><div class="line"></div><div class="line">//common mode åŒ…å«2ä¸ªå­mode</div><div class="line">common modes = &lt;CFBasicHash 0x60c00004db90 [0x10805cc80]&gt;&#123;type = mutable set, count = 2,</div><div class="line">entries =&gt;</div><div class="line">	0 : &lt;CFString 0x1093cce88 [0x10805cc80]&gt;&#123;contents = &quot;UITrackingRunLoopMode&quot;&#125;</div><div class="line">	2 : &lt;CFString 0x108032818 [0x10805cc80]&gt;&#123;contents = &quot;kCFRunLoopDefaultMode&quot;&#125;</div><div class="line">&#125;</div><div class="line">,</div><div class="line"></div><div class="line">//common mode çš„items(åŒ…æ‹¬ timer &amp;&amp; source &amp;&amp; observer)</div><div class="line">//observer activities (0x20 == kCFRunLoopBeforeWaiting)  (0x1 == kCFRunLoopEntry) (0xa0 ==  kCFRunLoopBeforeWaiting || kCFRunLoopExit)</div><div class="line"></div><div class="line">common mode items = &lt;CFBasicHash 0x60c00004df50 [0x10805cc80]&gt;&#123;type = mutable set, count = 13,</div><div class="line">entries =&gt;</div><div class="line"></div><div class="line"></div><div class="line">	//source0 ç³»ç»Ÿäº‹ä»¶</div><div class="line">	0 : &lt;CFRunLoopSource 0x60c000167a40 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x0, callout = PurpleEventSignalCallback (0x10cf0675a)&#125;&#125;</div><div class="line"></div><div class="line">	//å¤„ç†æ‰‹åŠ¿çš„é€šçŸ¥</div><div class="line">	1 : &lt;CFRunLoopObserver 0x608000122bc0 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0x20, repeats = Yes, order = 0, callout = _UIGestureRecognizerUpdateObserver (0x1087f06b3), context = &lt;CFRunLoopObserver context 0x6080000dfa30&gt;&#125;</div><div class="line"></div><div class="line">	//autoreleasepoolç›¸å…³é€šçŸ¥</div><div class="line">	2 : &lt;CFRunLoopObserver 0x6040001226c0 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x10820ad92), context = &lt;CFArray 0x604000044890 [0x10805cc80]&gt;&#123;type = mutable-small, count = 1, values = (</div><div class="line">	0 : &lt;0x7fa8a2802048&gt;</div><div class="line">)&#125;&#125;</div><div class="line">	3 : &lt;CFRunLoopObserver 0x604000122940 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0x1, repeats = Yes, order = -2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x10820ad92), context = &lt;CFArray 0x604000044890 [0x10805cc80]&gt;&#123;type = mutable-small, count = 1, values = (</div><div class="line">	0 : &lt;0x7fa8a2802048&gt;</div><div class="line">)&#125;&#125;</div><div class="line"></div><div class="line">	//mach port source</div><div class="line">	4 : &lt;CFRunLoopSource 0x60c000168b80 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = 0, context = &lt;CFRunLoopSource MIG Server&gt; &#123;port = 22787, subsystem = 0x10939e668, context = 0x60000003adc0&#125;&#125;</div><div class="line"></div><div class="line">	//å¤„ç†äº‹ä»¶é˜Ÿåˆ—çš„source</div><div class="line">	6 : &lt;CFRunLoopSource 0x604000167ec0 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x60c000141fa0, callout = __handleEventQueue (0x108b67bb2)&#125;&#125;</div><div class="line"></div><div class="line">	//å¤„ç†åŠ¨ç”»äº‹åŠ¡çš„é€šçŸ¥</div><div class="line">	16 : &lt;CFRunLoopObserver 0x604000122b20 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2000000, callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv (0x10dd374ce), context = &lt;CFRunLoopObserver context 0x0&gt;&#125;</div><div class="line"></div><div class="line">	//mach port source </div><div class="line">	17 : &lt;CFRunLoopSource 0x604000167f80 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = 0, context = &lt;CFRunLoopSource MIG Server&gt; &#123;port = 14599, subsystem = 0x109383fe8, context = 0x0&#125;&#125;</div><div class="line"></div><div class="line">	//CAåŠ¨ç”»æäº¤å‰çš„é€šçŸ¥</div><div class="line">	18 : &lt;CFRunLoopObserver 0x604000122a80 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 1999000, callout = _beforeCACommitHandler (0x108239da1), context = &lt;CFRunLoopObserver context 0x7fa8a3100000&gt;&#125;</div><div class="line"></div><div class="line">	//å¤„ç†ç³»ç»Ÿäº‹ä»¶ source0</div><div class="line">	19 : &lt;CFRunLoopSource 0x604000167e00 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -2, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x60c00004e400, callout = __handleHIDEventFetcherDrain (0x108b67bbe)&#125;&#125;</div><div class="line">	</div><div class="line">	//å¤„ç†ç³»ç»Ÿäº‹ä»¶ source1</div><div class="line">	20 : &lt;CFRunLoopSource 0x60c000167b00 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 1, info = 0x2c03, callout = PurpleEventCallback (0x10cf08bf7)&#125;&#125;</div><div class="line"></div><div class="line">	//CAåŠ¨ç”»æäº¤åçš„é€šçŸ¥</div><div class="line">	21 : &lt;CFRunLoopObserver 0x604000122800 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2001000, callout = _afterCACommitHandler (0x108239e1c), context = &lt;CFRunLoopObserver context 0x7fa8a3100000&gt;&#125;</div><div class="line"></div><div class="line">	//Front Board Services(å‰å°æœåŠ¡)</div><div class="line">	22 : &lt;CFRunLoopSource 0x6040001687c0 [0x10805cc80]&gt;&#123;signalled = Yes, valid = Yes, order = 0, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x6040000a8d00, callout = FBSSerialQueueRunLoopSourceHandler (0x10c67182f)&#125;&#125;</div><div class="line">&#125;</div><div class="line">,</div><div class="line"></div><div class="line"></div><div class="line">modes = &lt;CFBasicHash 0x60c00004dbc0 [0x10805cc80]&gt;&#123;type = mutable set, count = 4,</div><div class="line">entries =&gt;</div><div class="line"></div><div class="line"></div><div class="line">	//UITrackingRunLoopMode çš„ items</div><div class="line"></div><div class="line">	2 : &lt;CFRunLoopMode 0x60c0001869a0 [0x10805cc80]&gt;&#123;name = UITrackingRunLoopMode, port set = 0x1c03, queue = 0x60c000141e40, source = 0x60c000186a70 (not fired), timer port = 0x5403, </div><div class="line"></div><div class="line">	//source0</div><div class="line"></div><div class="line">	sources0 = &lt;CFBasicHash 0x60c00004dfb0 [0x10805cc80]&gt;&#123;type = mutable set, count = 4,</div><div class="line">entries =&gt;</div><div class="line">	0 : &lt;CFRunLoopSource 0x60c000167a40 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x0, callout = PurpleEventSignalCallback (0x10cf0675a)&#125;&#125;</div><div class="line">	3 : &lt;CFRunLoopSource 0x604000167ec0 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x60c000141fa0, callout = __handleEventQueue (0x108b67bb2)&#125;&#125;</div><div class="line">	4 : &lt;CFRunLoopSource 0x6040001687c0 [0x10805cc80]&gt;&#123;signalled = Yes, valid = Yes, order = 0, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x6040000a8d00, callout = FBSSerialQueueRunLoopSourceHandler (0x10c67182f)&#125;&#125;</div><div class="line">	5 : &lt;CFRunLoopSource 0x604000167e00 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -2, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x60c00004e400, callout = __handleHIDEventFetcherDrain (0x108b67bbe)&#125;&#125;</div><div class="line">&#125;</div><div class="line">,</div><div class="line"></div><div class="line">	//source1</div><div class="line"></div><div class="line">	sources1 = &lt;CFBasicHash 0x60c00004dfe0 [0x10805cc80]&gt;&#123;type = mutable set, count = 3,</div><div class="line">entries =&gt;</div><div class="line">	0 : &lt;CFRunLoopSource 0x60c000168b80 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = 0, context = &lt;CFRunLoopSource MIG Server&gt; &#123;port = 22787, subsystem = 0x10939e668, context = 0x60000003adc0&#125;&#125;</div><div class="line">	1 : &lt;CFRunLoopSource 0x604000167f80 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = 0, context = &lt;CFRunLoopSource MIG Server&gt; &#123;port = 14599, subsystem = 0x109383fe8, context = 0x0&#125;&#125;</div><div class="line">	2 : &lt;CFRunLoopSource 0x60c000167b00 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 1, info = 0x2c03, callout = PurpleEventCallback (0x10cf08bf7)&#125;&#125;</div><div class="line">&#125;</div><div class="line">,</div><div class="line">	//observer</div><div class="line"></div><div class="line">	observers = (</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x604000122940 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0x1, repeats = Yes, order = -2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x10820ad92), context = &lt;CFArray 0x604000044890 [0x10805cc80]&gt;&#123;type = mutable-small, count = 1, values = (\n\t0 : &lt;0x7fa8a2802048&gt;\n)&#125;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x608000122bc0 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0x20, repeats = Yes, order = 0, callout = _UIGestureRecognizerUpdateObserver (0x1087f06b3), context = &lt;CFRunLoopObserver context 0x6080000dfa30&gt;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x604000122a80 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 1999000, callout = _beforeCACommitHandler (0x108239da1), context = &lt;CFRunLoopObserver context 0x7fa8a3100000&gt;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x604000122b20 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2000000, callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv (0x10dd374ce), context = &lt;CFRunLoopObserver context 0x0&gt;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x604000122800 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2001000, callout = _afterCACommitHandler (0x108239e1c), context = &lt;CFRunLoopObserver context 0x7fa8a3100000&gt;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x6040001226c0 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x10820ad92), context = &lt;CFArray 0x604000044890 [0x10805cc80]&gt;&#123;type = mutable-small, count = 1, values = (\n\t0 : &lt;0x7fa8a2802048&gt;\n)&#125;&#125;&quot;</div><div class="line">),</div><div class="line">	timers = (null),</div><div class="line">	currently 558352445 (30290423333420) / soft deadline in: 1.84467138e+10 sec (@ -1) / hard deadline in: 1.84467138e+10 sec (@ -1)</div><div class="line">&#125;,</div><div class="line"></div><div class="line">	//GSEventReceiveRunLoopMode æ¥å—ç³»ç»Ÿäº‹ä»¶çš„å†…éƒ¨ Mode</div><div class="line">	3 : &lt;CFRunLoopMode 0x60c000186b40 [0x10805cc80]&gt;&#123;name = GSEventReceiveRunLoopMode, port set = 0x5203, queue = 0x60c000141ef0, source = 0x60c000186c10 (not fired), timer port = 0x5103, </div><div class="line">	sources0 = &lt;CFBasicHash 0x60c00004e070 [0x10805cc80]&gt;&#123;type = mutable set, count = 1,</div><div class="line">entries =&gt;</div><div class="line">	0 : &lt;CFRunLoopSource 0x60c000167a40 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x0, callout = PurpleEventSignalCallback (0x10cf0675a)&#125;&#125;</div><div class="line">&#125;</div><div class="line">,</div><div class="line">	sources1 = &lt;CFBasicHash 0x60c00004e0a0 [0x10805cc80]&gt;&#123;type = mutable set, count = 1,</div><div class="line">entries =&gt;</div><div class="line">	2 : &lt;CFRunLoopSource 0x60c000167bc0 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 1, info = 0x2c03, callout = PurpleEventCallback (0x10cf08bf7)&#125;&#125;</div><div class="line">&#125;</div><div class="line">,</div><div class="line">	observers = (null),</div><div class="line">	timers = (null),</div><div class="line">	currently 558352445 (30290424620943) / soft deadline in: 1.84467138e+10 sec (@ -1) / hard deadline in: 1.84467138e+10 sec (@ -1)</div><div class="line">&#125;,</div><div class="line"></div><div class="line">	//kCFRunLoopDefaultMode</div><div class="line"></div><div class="line">	4 : &lt;CFRunLoopMode 0x60c000186660 [0x10805cc80]&gt;&#123;name = kCFRunLoopDefaultMode, port set = 0x2503, queue = 0x60c000141ce0, source = 0x60c000186730 (not fired), timer port = 0x2303, </div><div class="line">	sources0 = &lt;CFBasicHash 0x60c00004e010 [0x10805cc80]&gt;&#123;type = mutable set, count = 4,</div><div class="line">entries =&gt;</div><div class="line">	0 : &lt;CFRunLoopSource 0x60c000167a40 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x0, callout = PurpleEventSignalCallback (0x10cf0675a)&#125;&#125;</div><div class="line">	3 : &lt;CFRunLoopSource 0x604000167ec0 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x60c000141fa0, callout = __handleEventQueue (0x108b67bb2)&#125;&#125;</div><div class="line">	4 : &lt;CFRunLoopSource 0x6040001687c0 [0x10805cc80]&gt;&#123;signalled = Yes, valid = Yes, order = 0, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x6040000a8d00, callout = FBSSerialQueueRunLoopSourceHandler (0x10c67182f)&#125;&#125;</div><div class="line">	5 : &lt;CFRunLoopSource 0x604000167e00 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -2, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x60c00004e400, callout = __handleHIDEventFetcherDrain (0x108b67bbe)&#125;&#125;</div><div class="line">&#125;</div><div class="line">,</div><div class="line">	sources1 = &lt;CFBasicHash 0x60c00004e040 [0x10805cc80]&gt;&#123;type = mutable set, count = 3,</div><div class="line">entries =&gt;</div><div class="line">	0 : &lt;CFRunLoopSource 0x60c000168b80 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = 0, context = &lt;CFRunLoopSource MIG Server&gt; &#123;port = 22787, subsystem = 0x10939e668, context = 0x60000003adc0&#125;&#125;</div><div class="line">	1 : &lt;CFRunLoopSource 0x604000167f80 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = 0, context = &lt;CFRunLoopSource MIG Server&gt; &#123;port = 14599, subsystem = 0x109383fe8, context = 0x0&#125;&#125;</div><div class="line">	2 : &lt;CFRunLoopSource 0x60c000167b00 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 1, info = 0x2c03, callout = PurpleEventCallback (0x10cf08bf7)&#125;&#125;</div><div class="line">&#125;</div><div class="line">,</div><div class="line">	observers = (</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x604000122940 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0x1, repeats = Yes, order = -2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x10820ad92), context = &lt;CFArray 0x604000044890 [0x10805cc80]&gt;&#123;type = mutable-small, count = 1, values = (\n\t0 : &lt;0x7fa8a2802048&gt;\n)&#125;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x608000122bc0 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0x20, repeats = Yes, order = 0, callout = _UIGestureRecognizerUpdateObserver (0x1087f06b3), context = &lt;CFRunLoopObserver context 0x6080000dfa30&gt;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x604000122a80 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 1999000, callout = _beforeCACommitHandler (0x108239da1), context = &lt;CFRunLoopObserver context 0x7fa8a3100000&gt;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x604000122b20 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2000000, callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv (0x10dd374ce), context = &lt;CFRunLoopObserver context 0x0&gt;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x604000122800 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2001000, callout = _afterCACommitHandler (0x108239e1c), context = &lt;CFRunLoopObserver context 0x7fa8a3100000&gt;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x6040001226c0 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x10820ad92), context = &lt;CFArray 0x604000044890 [0x10805cc80]&gt;&#123;type = mutable-small, count = 1, values = (\n\t0 : &lt;0x7fa8a2802048&gt;\n)&#125;&#125;&quot;</div><div class="line">),</div><div class="line">	timers = &lt;CFArray 0x6080000aa5c0 [0x10805cc80]&gt;&#123;type = mutable-small, count = 1, values = (</div><div class="line">	0 : &lt;CFRunLoopTimer 0x600000168ac0 [0x10805cc80]&gt;&#123;valid = Yes, firing = No, interval = 0, tolerance = 0, next fire date = 558352446 (1.35804296 @ 30291784384812), callout = (Delayed Perform) UIApplication _accessibilitySetUpQuickSpeak (0x106e7e849 / 0x1086fb31b) (/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/Library/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/System/Library/Frameworks/UIKit.framework/UIKit), context = &lt;CFRunLoopTimer context 0x600000076700&gt;&#125;</div><div class="line">)&#125;,</div><div class="line">	currently 558352445 (30290424667708) / soft deadline in: 1.35971708 sec (@ 30291784384812) / hard deadline in: 1.35971705 sec (@ 30291784384812)</div><div class="line">&#125;,</div><div class="line"></div><div class="line">	//kCFRunLoopCommonModes</div><div class="line">	5 : &lt;CFRunLoopMode 0x60c000186e80 [0x10805cc80]&gt;&#123;name = kCFRunLoopCommonModes, port set = 0x420b, queue = 0x60c000142520, source = 0x60c000186db0 (not fired), timer port = 0x350b, </div><div class="line">	sources0 = (null),</div><div class="line">	sources1 = (null),</div><div class="line">	observers = (null),</div><div class="line">	timers = (null),</div><div class="line">	currently 558352445 (30290426387800) / soft deadline in: 1.84467138e+10 sec (@ -1) / hard deadline in: 1.84467138e+10 sec (@ -1)</div><div class="line">&#125;,</div><div class="line"></div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ç»™ç³»ç»Ÿmodeæ·»åŠ è‡ªå®šä¹‰items-timer-amp-amp-source-amp-amp-observer"><a href="#ç»™ç³»ç»Ÿmodeæ·»åŠ è‡ªå®šä¹‰items-timer-amp-amp-source-amp-amp-observer" class="headerlink" title="ç»™ç³»ç»Ÿmodeæ·»åŠ è‡ªå®šä¹‰items(timer &amp;&amp; source &amp;&amp; observer)"></a>ç»™ç³»ç»Ÿmodeæ·»åŠ è‡ªå®šä¹‰items(timer &amp;&amp; source &amp;&amp; observer)</h4><p>ä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿæ·»åŠ æ˜¯å¦æˆåŠŸï¼Œæˆ‘ä»¬ä¸åœ¨ä¸»çº¿ç¨‹çš„runloopä¸­æ·»åŠ ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªæ–°çš„çº¿ç¨‹ã€‚</p>
<h5 id="æ·»åŠ Custom-Input-Sourceæ³¨æ„äº‹é¡¹"><a href="#æ·»åŠ Custom-Input-Sourceæ³¨æ„äº‹é¡¹" class="headerlink" title="æ·»åŠ Custom Input Sourceæ³¨æ„äº‹é¡¹"></a>æ·»åŠ Custom Input Sourceæ³¨æ„äº‹é¡¹</h5><ul>
<li>custom input source é»˜è®¤çŠ¶æ€ä¸ºä¸å¤„ç†ï¼Œéœ€è¦æ‰‹åŠ¨å”¤é†’ï¼Œæ‰‹åŠ¨å”¤é†’éœ€è¦å…ˆæ ‡è®°ä¸ºå¾…å¤„ç†çŠ¶æ€ï¼Œæ¯æ¬¡runloopå¤„ç†å®ŒåçŠ¶æ€ä¼šè¢«ç½®å›ä¸å¤„ç†ã€‚</li>
<li>åœ¨å­çº¿ç¨‹æ·»åŠ sourceéœ€è¦åœ¨runloop runçš„ä»£ç ä¹‹å‰æ·»åŠ ï¼Œå› ä¸ºrunåè¯¥çº¿ç¨‹ä¼šé©¬ä¸Šä¼‘çœ ï¼ˆå½“å‰runloopä¸­æ²¡æœ‰èƒ½å”¤é†’è‡ªå·±çš„sourceï¼‰,ä¸å†è¿™è¡Œrunåé¢çš„ä»£ç ã€‚</li>
</ul>
<h5 id="æ·»åŠ Mach-Port-Input-Sourceæ³¨æ„äº‹é¡¹"><a href="#æ·»åŠ Mach-Port-Input-Sourceæ³¨æ„äº‹é¡¹" class="headerlink" title="æ·»åŠ Mach Port Input Sourceæ³¨æ„äº‹é¡¹"></a>æ·»åŠ Mach Port Input Sourceæ³¨æ„äº‹é¡¹</h5><ul>
<li>éœ€è¦åŒæ—¶è®°å½•ä¸»çº¿ç¨‹ç«¯å£å’Œå­çº¿ç¨‹ç«¯å£å·ï¼Œéœ€è¦å”¤é†’å¯¹åº”çº¿ç¨‹æ—¶ç›´æ¥ä½¿ç”¨è¯¥ç«¯å£å‘é€æ¶ˆæ¯å³å¯ï¼Œä¸éœ€è¦åƒCustom Input Sourceé‚£æ ·åšæ ‡è®°ã€‚</li>
</ul>
<h4 id="ç»™runloopæ·»åŠ è‡ªå®šä¹‰modeå’Œitems"><a href="#ç»™runloopæ·»åŠ è‡ªå®šä¹‰modeå’Œitems" class="headerlink" title="ç»™runloopæ·»åŠ è‡ªå®šä¹‰modeå’Œitems"></a>ç»™runloopæ·»åŠ è‡ªå®šä¹‰modeå’Œitems</h4><ul>
<li>éœ€è¦æ³¨æ„çš„æ˜¯ä¸èƒ½ç›´æ¥è°ƒç”¨runè¿™ä¸ªæ–¹æ³•ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯è¿è¡Œåœ¨DefaultModeä¸‹çš„ï¼Œä¸ä¼šè§¦å‘è‡ªå®šä¹‰modeä¸­çš„source,éœ€è¦è°ƒç”¨runMode:beforeDateæ–¹æ³•å¼€å¯runloop.</li>
</ul>
<p><a href="https://github.com/lilingyu0620/LLYRunloopDemo.git" target="_blank" rel="noopener">è¿™é‡Œæ˜¯demo</a></p>
<h4 id="Runloopåœ¨iOSä¸­çš„åº”ç”¨"><a href="#Runloopåœ¨iOSä¸­çš„åº”ç”¨" class="headerlink" title="Runloopåœ¨iOSä¸­çš„åº”ç”¨"></a>Runloopåœ¨iOSä¸­çš„åº”ç”¨</h4><p>è¿™å—ç›´æ¥çœ‹YYåšå®¢å§ï¼Œå·²ç»æ²¡æ³•å†è¡¥å……æ›´å¤šäº†ã€‚ã€‚ã€‚</p>
<p>åšå®¢é“¾æ¥<a href="https://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="noopener">https://blog.ibireme.com/2015/05/18/runloop/</a></p>
<h4 id="æœ€åçš„æ€»ç»“"><a href="#æœ€åçš„æ€»ç»“" class="headerlink" title="æœ€åçš„æ€»ç»“"></a>æœ€åçš„æ€»ç»“</h4><p>Runloopæ˜¯ä¸€ä¸ªäº‹ä»¶å¤„ç†çš„å¾ªç¯ã€‚Runloopçš„ç›®æ ‡æ˜¯è®©çº¿ç¨‹åœ¨æœ‰äº‹æƒ…åšçš„æ—¶å€™ä¿æŒå¿™ç¢Œã€æ²¡æœ‰äº‹æƒ…åšçš„æ—¶å€™ä¿æŒç¡çœ ã€‚</p>
<p>Runloopä½¿ç”¨Machå†…æ ¸å®ç°çº¿ç¨‹çš„ç¡çœ ï¼Œé€šè¿‡Sourceå’ŒTimeræ¥å”¤é†’çº¿ç¨‹ï¼ŒSourceå’ŒTimeræœ€ç»ˆéƒ½æ˜¯é€šè¿‡Mach Portæ¥å”¤é†’çš„çº¿ç¨‹ã€‚</p>
<p>Sourceæœ‰CustomSourceå’ŒMach Port Source2ç§ï¼ŒCustomSourceå”¤é†’çº¿ç¨‹å‰éœ€è¦å…ˆè¢«æ ‡æ³¨ä¸ºå¾…å¤„ç†ï¼ŒMachPortSourceåˆ™ç›´æ¥ä½¿ç”¨ç«¯å£å·å‘é€å”¤é†’æ¶ˆæ¯ã€‚</p>
<p>Timeræœ‰ä¸¤ç§å®ç°æ–¹å¼åˆ†åˆ«æ˜¯MK_Timerå’ŒGCD Timer,åœ¨runloopä¸­Timerè¢«è½¬ä¸ºäº†ä¸€ä¸ªå­˜äº†è§¦å‘æ—¶é—´çš„åˆ—è¡¨ï¼Œè¿™ä¸ªè§¦å‘æ—¶é—´æ˜¯ä¸€ä¸ªç»å¯¹æ—¶é—´ï¼Œä¼šæŒ‰æ—¶é—´å¤§å°å‡åºæ’åºï¼Œåœ¨æœ€å°çš„æ—¶é—´è¢«è§¦å‘åï¼ŒRunloopä¼šæ›´æ–°åˆ—è¡¨ä¿è¯æ—¶é—´å§‹ç»ˆæ˜¯å‡åºæ’åˆ—ã€‚å¦‚æœRunloopåœ¨æŸæ¬¡è¿è¡Œä¸­é˜»å¡äº†å¾ˆé•¿æ—¶é—´ï¼ŒTimerçš„è§¦å‘ä¼šå—åˆ°å½±å“ã€‚è¿‡æœŸçš„æ—¶é—´ç‚¹ä¼šè¢«ç§»é™¤è€Œä¸ä¼šå»è§¦å‘ã€‚</p>
<p>Runloopçš„çŠ¶æ€éƒ½å¯ä»¥é€šè¿‡æ·»åŠ Observeræ¥å¾—åˆ°ã€‚Observeråœ¨Runloopä¸­æ˜¯æŒ‰orderä¼˜å…ˆçº§å‡åºæ’åºçš„ï¼Œæ’åœ¨å‰é¢çš„é€šçŸ¥ä¼šå…ˆè¢«è§¦å‘ï¼ˆorderè¶Šå°ä¼˜å…ˆçº§åè€Œè¶Šé«˜ï¼‰ã€‚</p>
<p>Modeè¡¨ç¤ºå½“å‰Runloopè¿è¡Œåœ¨å“ªä¸ªæ¨¡å¼ä¸Šï¼ŒRunloopå¿…é¡»è¿è¡Œåœ¨ä¸€ç§Modeä¸Šï¼ŒRunloopåœ¨åˆ›å»ºæ—¶ä¼šæœ‰ä¸€ä¸ªDefaultMode,å¯ä»¥é€šè¿‡runmodeï¼šbeforeDate åˆ‡æ¢Runloopå½“å‰è¿è¡Œçš„Modeã€‚</p>
<p>Modeä¸­åŒ…å«äº†ä¸Šé¢çš„Source,Timerå’ŒObserverä¸‰ç§Itemsã€‚Runloopè¿è¡Œçš„æ—¶å€™å…¶å®å°±æ˜¯åœ¨å¤„ç†è¿™äº›Itemsä¸­çš„å†…å®¹ï¼Œå¦‚æœè¿™ä¸‰ç§Itemséƒ½æ²¡æœ‰è¦å¤„ç†çš„å†…å®¹ï¼ŒRunloopå°±è¦å¼€å§‹ç¡äº†,è€Œå½“Modeçš„itemsä¸ºç©ºæ—¶ï¼Œå½“å‰Runloopä¼šé€€å‡ºã€‚</p>
<p>CommonModeä¸æ˜¯ä¸€ç§çœŸæ­£çš„Mode,å®ƒæ˜¯ä¸€ä¸ªæ‰€æœ‰Modeçš„é›†åˆï¼Œå¦‚æœæŠŠä¸Šé¢ä¸‰ç§Itemsæ·»åŠ åˆ°CommonMode,é‚£è¿™äº›Itemsä¼šè¢«æ·»åŠ åˆ°é›†åˆä¸­æ‰€æœ‰çš„Modeä¸­ã€‚æ‰€ä»¥æ·»åŠ åˆ°CommonModeä¸­Items,ä¸ç®¡å½“å‰Runloopè¿è¡Œåœ¨å“ªç§Modeä¸Šï¼ŒItemsä¸­éœ€è¦å¤„ç†çš„äº‹ä»¶éƒ½ä¼šè¢«è§¦å‘ã€‚ï¼ˆå‰ææ˜¯è¿™ä¸ªModeå·²ç»è¢«æ·»åŠ åˆ°äº†CommonModeé›†åˆä¸­ï¼‰ã€‚</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>

    <footer class="post-footer">
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/08/22/h-256ä¸h-264çš„å¯¹æ¯”/" rel="next" title="h.256ä¸h.264çš„å¯¹æ¯”">
                <i class="fa fa-chevron-left"></i> h.256ä¸h.264çš„å¯¹æ¯”
              </a>
            
          </div>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/10/08/iOSæ€§èƒ½ä¼˜åŒ–çš„ä¸€äº›å¥—è·¯/" rel="prev" title="iOSæ€§èƒ½ä¼˜åŒ–çš„ä¸€äº›å¥—è·¯">
                iOSæ€§èƒ½ä¼˜åŒ–çš„ä¸€äº›å¥—è·¯ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2018/09/10/Runloopæºç è§£æå’Œå®è·µ/"
           data-title="Runloopæºç è§£æå’Œå®è·µ" data-url="http://yoursite.com/2018/09/10/Runloopæºç è§£æå’Œå®è·µ/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap" >
            æ–‡ç« ç›®å½•
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview">
            ç«™ç‚¹æ¦‚è§ˆ
          </li>
        </ul>
      

      <section class="site-overview sidebar-panel ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/head.png"
               alt="lly" />
          <p class="site-author-name" itemprop="name">lly</p>
          <p class="site-description motion-element" itemprop="description">è€¿ç›´çš„ä¸€Boy</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">54</span>
              <span class="site-state-item-name">æ—¥å¿—</span>
            </a>
          </div>

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">
            
              
            
            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-4"><a class="nav-link" href="#RunLoopæ˜¯å¹²å•¥çš„"><span class="nav-number">1.</span> <span class="nav-text">RunLoopæ˜¯å¹²å•¥çš„</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ç–‘é—®ï¼Ÿï¼Ÿï¼Ÿ"><span class="nav-number">2.</span> <span class="nav-text">ç–‘é—®ï¼Ÿï¼Ÿï¼Ÿ</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#åº–ä¸è§£ğŸ‚"><span class="nav-number"></span> <span class="nav-text">åº–ä¸è§£ğŸ‚</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Modes"><span class="nav-number">1.</span> <span class="nav-text">Modes</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Input-Sources"><span class="nav-number">2.</span> <span class="nav-text">Input Sources</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Port-Based-Sources"><span class="nav-number">2.1.</span> <span class="nav-text">Port-Based Sources</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Custom-Input-Sources"><span class="nav-number">2.2.</span> <span class="nav-text">Custom Input Sources</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Cocoa-Perform-Selector-Sources"><span class="nav-number">2.3.</span> <span class="nav-text">Cocoa Perform Selector Sources</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Timer-Sources"><span class="nav-number">3.</span> <span class="nav-text">Timer Sources</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Run-Loop-Observers"><span class="nav-number">4.</span> <span class="nav-text">Run Loop Observers</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Runloopä½¿ç”¨åœºæ™¯"><span class="nav-number">5.</span> <span class="nav-text">Runloopä½¿ç”¨åœºæ™¯</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æºç è§£æ"><span class="nav-number">6.</span> <span class="nav-text">æºç è§£æ</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Input-Source-amp-amp-CFRunLoopSource-çš„ç»“æ„"><span class="nav-number">6.1.</span> <span class="nav-text">Input Source &amp;&amp; CFRunLoopSource çš„ç»“æ„</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#observer-amp-amp-CFRunLoopObserver-çš„ç»“æ„"><span class="nav-number">6.2.</span> <span class="nav-text">observer &amp;&amp; CFRunLoopObserver çš„ç»“æ„</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#NSTimer-amp-amp-CFRunloopTimer-çš„ç»“æ„"><span class="nav-number">6.3.</span> <span class="nav-text">NSTimer &amp;&amp; CFRunloopTimer çš„ç»“æ„</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Mode-çš„ç»“æ„"><span class="nav-number">6.4.</span> <span class="nav-text">Mode çš„ç»“æ„</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#runloop-çš„ç»“æ„"><span class="nav-number">7.</span> <span class="nav-text">runloop çš„ç»“æ„</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Runloopçš„åˆ›å»ºå’Œé”€æ¯-CFRunLoopCreate-amp-amp-CFRunLoopGet0-amp-amp-CFRunLoopGetMain-amp-amp-CFRunLoopGetCurrent-amp-amp-CFFinalizeRunLoop"><span class="nav-number">8.</span> <span class="nav-text">Runloopçš„åˆ›å»ºå’Œé”€æ¯ CFRunLoopCreate() &amp;&amp; CFRunLoopGet0() &amp;&amp; CFRunLoopGetMain() &amp;&amp; CFRunLoopGetCurrent() &amp;&amp; CFFinalizeRunLoop()</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#æ€»ç»“"><span class="nav-number">8.1.</span> <span class="nav-text">æ€»ç»“</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Runloopçš„è¿è¡Œ-CFRunLoopRun-amp-amp-CFRunLoopRunSpecific-amp-amp-CFRunLoopRun"><span class="nav-number">9.</span> <span class="nav-text">Runloopçš„è¿è¡Œ CFRunLoopRun &amp;&amp; CFRunLoopRunSpecific &amp;&amp; CFRunLoopRun</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#runloopè¿è¡Œæµç¨‹æ€»ç»“å…¥ä¸‹å›¾"><span class="nav-number">9.1.</span> <span class="nav-text">runloopè¿è¡Œæµç¨‹æ€»ç»“å…¥ä¸‹å›¾</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#runloopå”¤é†’äº‹ä»¶æ€»ç»“"><span class="nav-number">9.2.</span> <span class="nav-text">runloopå”¤é†’äº‹ä»¶æ€»ç»“</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Modeå’Œå®ƒçš„å››å¤§å¤§ç‹-Source-Timer-Observer-Block"><span class="nav-number">10.</span> <span class="nav-text">Modeå’Œå®ƒçš„å››å¤§å¤§ç‹(Source,Timer,Observer,Block)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#Mode"><span class="nav-number">10.1.</span> <span class="nav-text">Mode</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Source"><span class="nav-number">10.2.</span> <span class="nav-text">Source</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#sourceæ€»ç»“"><span class="nav-number">10.3.</span> <span class="nav-text">sourceæ€»ç»“</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Timer"><span class="nav-number">10.4.</span> <span class="nav-text">Timer</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#timeræ€»ç»“"><span class="nav-number">10.5.</span> <span class="nav-text">timeræ€»ç»“</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Observer"><span class="nav-number">10.6.</span> <span class="nav-text">Observer</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#Block"><span class="nav-number">10.7.</span> <span class="nav-text">Block</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#blockæ€»ç»“"><span class="nav-number">10.8.</span> <span class="nav-text">blockæ€»ç»“</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Runloopå®è·µ"><span class="nav-number"></span> <span class="nav-text">Runloopå®è·µ</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#æŸ¥çœ‹Main-Runloopçš„ç»“æ„"><span class="nav-number">1.</span> <span class="nav-text">æŸ¥çœ‹Main Runloopçš„ç»“æ„</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#å…·ä½“ç»“æ„å¦‚ä¸‹ï¼š"><span class="nav-number">1.1.</span> <span class="nav-text">å…·ä½“ç»“æ„å¦‚ä¸‹ï¼š</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ç»™ç³»ç»Ÿmodeæ·»åŠ è‡ªå®šä¹‰items-timer-amp-amp-source-amp-amp-observer"><span class="nav-number">2.</span> <span class="nav-text">ç»™ç³»ç»Ÿmodeæ·»åŠ è‡ªå®šä¹‰items(timer &amp;&amp; source &amp;&amp; observer)</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#æ·»åŠ Custom-Input-Sourceæ³¨æ„äº‹é¡¹"><span class="nav-number">2.1.</span> <span class="nav-text">æ·»åŠ Custom Input Sourceæ³¨æ„äº‹é¡¹</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#æ·»åŠ Mach-Port-Input-Sourceæ³¨æ„äº‹é¡¹"><span class="nav-number">2.2.</span> <span class="nav-text">æ·»åŠ Mach Port Input Sourceæ³¨æ„äº‹é¡¹</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#ç»™runloopæ·»åŠ è‡ªå®šä¹‰modeå’Œitems"><span class="nav-number">3.</span> <span class="nav-text">ç»™runloopæ·»åŠ è‡ªå®šä¹‰modeå’Œitems</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Runloopåœ¨iOSä¸­çš„åº”ç”¨"><span class="nav-number">4.</span> <span class="nav-text">Runloopåœ¨iOSä¸­çš„åº”ç”¨</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#æœ€åçš„æ€»ç»“"><span class="nav-number">5.</span> <span class="nav-text">æœ€åçš„æ€»ç»“</span></a></li></ol></div>
            
          </div>
        </section>
      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lly</span>
</div>

<div class="powered-by">
  ç”± <a class="theme-link" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.0.1"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.0.1"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"llyblog"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
