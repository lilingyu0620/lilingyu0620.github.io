<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="è€¿ç›´çš„ä¸€Boy">
<meta property="og:type" content="website">
<meta property="og:title" content="lly&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/page/2/index.html">
<meta property="og:site_name" content="lly&#39;s Blog">
<meta property="og:description" content="è€¿ç›´çš„ä¸€Boy">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="lly&#39;s Blog">
<meta name="twitter:description" content="è€¿ç›´çš„ä¸€Boy">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: 'åšä¸»'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/page/2/"/>

  <title> lly's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">lly's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">ç”¨å¿ƒè®°å½•ç‚¹æ»´</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            é¦–é¡µ
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            å½’æ¡£
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/09/10/Runloopæºç è§£æå’Œå®è·µ/" itemprop="url">
                  Runloopæºç è§£æå’Œå®è·µ
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2018-09-10T21:20:28+08:00" content="2018-09-10">
              2018-09-10
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/09/10/Runloopæºç è§£æå’Œå®è·µ/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/09/10/Runloopæºç è§£æå’Œå®è·µ/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="RunLoopæ˜¯å¹²å•¥çš„"><a href="#RunLoopæ˜¯å¹²å•¥çš„" class="headerlink" title="RunLoopæ˜¯å¹²å•¥çš„"></a>RunLoopæ˜¯å¹²å•¥çš„</h4><p><strong>å®˜ç¿»ï¼š</strong> Run loopsæ˜¯ä¸çº¿ç¨‹ç›¸å…³çš„åŸºç¡€è®¾æ–½çš„ä¸€éƒ¨åˆ†ï¼Œä¸€ä¸ªRunloopå°±æ˜¯ä¸€ä¸ªäº‹ä»¶å¤„ç†çš„å¾ªç¯ã€‚Runloopçš„ç›®æ ‡æ˜¯è®©çº¿ç¨‹åœ¨æœ‰äº‹æƒ…åšçš„æ—¶å€™ä¿æŒå¿™ç¢Œã€æ²¡æœ‰äº‹æƒ…åšçš„æ—¶å€™ä¿æŒç¡çœ ã€‚</p>
<h4 id="ç–‘é—®ï¼Ÿï¼Ÿï¼Ÿ"><a href="#ç–‘é—®ï¼Ÿï¼Ÿï¼Ÿ" class="headerlink" title="ç–‘é—®ï¼Ÿï¼Ÿï¼Ÿ"></a>ç–‘é—®ï¼Ÿï¼Ÿï¼Ÿ</h4><ul>
<li>Runloopçš„è¿è¡Œæœºåˆ¶</li>
<li>Runloopæ˜¯å¦‚ä½•å”¤é†’å’Œç¡çœ çº¿ç¨‹çš„ï¼Œä¸çº¿ç¨‹åˆ°åº•æ˜¯ä»€ä¹ˆå…³ç³»</li>
<li>Runloopçš„Sourceã€Timerã€Observerå’ŒModeä¸Runloopåˆ°åº•æ˜¯ä»€ä¹ˆå…³ç³»</li>
<li>iOSç³»ç»Ÿæ€ä¹ˆä½¿ç”¨Runloopçš„</li>
<li>å¦‚ä½•è‡ªå®šä¹‰</li>
</ul>
<h3 id="åº–ä¸è§£ğŸ‚"><a href="#åº–ä¸è§£ğŸ‚" class="headerlink" title="åº–ä¸è§£ğŸ‚"></a>åº–ä¸è§£ğŸ‚</h3><p>ä¸€ä¸ªRunloopæ¥æ”¶2ä¸­ä¸åŒç±»å‹çš„sources.<strong>Input source</strong> å‘é€å¼‚æ­¥äº‹ä»¶ï¼Œä¸€èˆ¬æ˜¯æ¥è‡ªå…¶ä»–çº¿ç¨‹æˆ–è€…æ˜¯å…¶ä»–åº”ç”¨çš„ï¼›<strong>Timer source</strong>å‘é€åŒæ­¥äº‹ä»¶ï¼Œä¼šåœ¨é¢„è®¾å¥½çš„æ—¶é—´æˆ–è€…é‡å¤é—´éš”å†…è§¦å‘ã€‚è¿™2ç§sourceéƒ½ä¼šé€šè¿‡ç‰¹æ®Šçš„å¤„ç†ç¨‹åºå¤„ç†äº‹ä»¶ã€‚</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Runloop/runloop001.png" alt=""></p>
<p>Input sourceå‘é€å¼‚æ­¥äº‹ä»¶ï¼Œè¿™ç§source runloopåœ¨å¤„ç†çš„æ—¶å€™ä¼šè°ƒç”¨runUnitlDateï¼šæ–¹æ³•å¼€å¯ä¸€ä¸ªrunloop,å¹¶ä¸”åœ¨è¿è¡Œdateæ—¶é—´åé€€å‡ºã€‚Timer sourceåˆ™ä¸ä¼šä½¿runloopé€€å‡ºã€‚</p>
<p>åœ¨å¤„ç†input sourceæ—¶ï¼Œrunloops ä¹Ÿä¼šç”Ÿæˆç›¸å…³çš„é€šçŸ¥ï¼Œä½ å¯ä»¥æ³¨å†Œæˆä¸ºè§‚å¯Ÿè€…åœ¨å½“å‰çº¿ç¨‹æ¥å¤„ç†å…¶ä»–æ—¶é—´ã€‚</p>
<p>#####ï¼ˆè¡¥å……ï¼‰ runloop çš„è¿è¡Œæ–¹å¼</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- (void)run; </div><div class="line">- (BOOL)runMode:(NSRunLoopMode)mode beforeDate:(NSDate *)limitDate;</div><div class="line">- (void)runUntilDate:(NSDate *)limitDate;</div></pre></td></tr></table></figure>
<ul>
<li><p>runæ–¹æ³•å¯¹åº”CFRunloopRefä¸­çš„CFRunLoopRunå¹¶ä¸ä¼šé€€å‡ºï¼Œé™¤éæ‰‹åŠ¨è°ƒç”¨CFRunLoopStop();é€šå¸¸å¦‚æœæƒ³è¦æ°¸è¿œä¸ä¼šé€€å‡ºRunLoopæ‰ä¼šä½¿ç”¨æ­¤æ–¹æ³•ï¼Œå¦åˆ™å¯ä»¥ä½¿ç”¨runUntilDateã€‚</p>
</li>
<li><p>runMode:beforeDate:åˆ™å¯¹åº”CFRunLoopRunInMode(mode,limiteDate,true)æ–¹æ³•,åªæ‰§è¡Œä¸€æ¬¡ï¼Œæ‰§è¡Œå®Œå°±é€€å‡ºï¼›é€šå¸¸ç”¨äºæ‰‹åŠ¨æ§åˆ¶RunLoopï¼ˆä¾‹å¦‚åœ¨whileå¾ªç¯ä¸­ï¼‰ã€‚</p>
</li>
<li><p>runUntilDate:æ–¹æ³•å…¶å®æ˜¯CFRunLoopRunInMode(kCFRunLoopDefaultMode,limiteDate,false)ï¼Œæ‰§è¡Œå®Œå¹¶ä¸ä¼šé€€å‡ºï¼Œç»§ç»­ä¸‹ä¸€æ¬¡RunLoopç›´åˆ°timeoutã€‚</p>
</li>
</ul>
<h4 id="Modes"><a href="#Modes" class="headerlink" title="Modes"></a>Modes</h4><p>ä¸€ä¸ªrunloop modeæ˜¯input sourceå’Œtimer sourcesçš„é›†åˆï¼ŒåŒæ—¶åŒ…å«ä¸€ä¸ªrunloopè§‚å¯Ÿè€…çš„åˆé›†ã€‚æ¯æ¬¡è¿è¡Œä¸€ä¸ªrunloopæ—¶ï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªç‰¹åˆ«çš„modeã€‚åœ¨runloop è¿è¡Œçš„è¿‡ç¨‹ä¸­ï¼Œåªæœ‰å’Œè¿™ä¸ªmodeç›¸å…³è”sourceæ‰èƒ½å‘é€äº‹ä»¶ï¼ˆåŒæ ·ï¼Œåªæœ‰å’Œè¿™ä¸ªmodeå…³è”çš„è§‚å¯Ÿè€…æ‰èƒ½æ”¶åˆ°é€šçŸ¥ï¼‰ã€‚å…³è”äº†å…¶ä»–modeçš„sourceä¼šè¢«æš‚åœä¸€åˆ‡æ–°äº‹ä»¶çš„å‘é€ç›´åˆ°runloopè¿è¡Œåœ¨è¯¥modeä¸Šã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">struct __CFRunLoopMode &#123;</div><div class="line">    CFStringRef _name;            // Mode Name, ä¾‹å¦‚ @&quot;kCFRunLoopDefaultMode&quot;</div><div class="line">    CFMutableSetRef _sources0;    // Set</div><div class="line">    CFMutableSetRef _sources1;    // Set</div><div class="line">    CFMutableArrayRef _observers; // Array</div><div class="line">    CFMutableArrayRef _timers;    // Array</div><div class="line">    ...</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>modesé€šè¿‡nameæ¥åŒºåˆ†ï¼Œå¯ç”¨é€šè¿‡æŒ‡å®šmodeçš„nameæ¥è‡ªå®šä¹‰ä¸€ä¸ªmode,è™½ç„¶nameåœ¨è‡ªå®šä¹‰çš„æ—¶å€™å¯ä»¥ä»»æ„æŒ‡å®šï¼Œä½†æ˜¯å…¶ä»–å†…å®¹å´ä¸è¡Œï¼Œå½“ä½ è‡ªå®šä¹‰ä¸€ä¸ªmodeçš„æ—¶å€™ï¼Œå¿…é¡»æ·»åŠ ä¸€ä¸ªæˆ–è€…å¤šä¸ªsource(input source æˆ– timer source) ,æˆ–è€…è§‚å¯Ÿè€…ã€‚</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Runloop/runloop003.png" alt=""></p>
<h4 id="Input-Sources"><a href="#Input-Sources" class="headerlink" title="Input Sources"></a>Input Sources</h4><p>Input sources ç»™çº¿ç¨‹å‘é€å¼‚æ­¥äº‹ä»¶ï¼Œäº‹ä»¶çš„ç±»å‹å’Œinput sourceçš„ç±»å‹ç›¸å…³ã€‚ä¸€èˆ¬æœ‰2ç§:<strong>Port-based input sources ç”¨æ¥ç›‘æ§Mach ports</strong>å’Œ<strong>è‡ªå®šä¹‰ input sources ç”¨æ¥ç›‘æ§è‡ªå®šä¹‰äº‹ä»¶</strong>ã€‚2è€…çš„å”¯ä¸€ä¸åŒåœ¨äºå¦‚ä½•å‘é€ä¿¡å·ï¼šPort-based input sourcesæ˜¯kernelå†…æ ¸è‡ªåŠ¨å‘é€ä¿¡å·ï¼›è‡ªå®šä¹‰ input sourcesæ˜¯ä»å…¶ä»–çº¿ç¨‹æ‰‹åŠ¨å‘é€ä¿¡å·ã€‚</p>
<h5 id="Port-Based-Sources"><a href="#Port-Based-Sources" class="headerlink" title="Port-Based Sources"></a>Port-Based Sources</h5><ul>
<li>NSMachPort</li>
<li>NSMessagePort</li>
</ul>
<p>mach æ“ä½œç³»ç»Ÿå¾®å†…æ ¸ åœ¨mac oså’Œiosç³»ç»Ÿä¸­é‡‡ç”¨ã€‚è™šæ‹Ÿå†…å­˜çš„åˆ†é…ï¼Œè¿›ç¨‹é—´çš„é€šä¿¡ï¼ˆåŸºäºportï¼‰ã€‚</p>
<p>æ¯ä¸€ç§æœåŠ¡éƒ½æ˜¯ä¸€ä¸ªè¿›ç¨‹ï¼ˆhttp 8080 https 443 ftp 20 21 rtmp 1935ï¼‰ï¼Œæ¯ä¸€ä¸ªè¿›ç¨‹éƒ½åˆ†é…ä¸€ä¸ªport(è™šæ‹Ÿç«¯å£)ï¼Œ </p>
<h5 id="Custom-Input-Sources"><a href="#Custom-Input-Sources" class="headerlink" title="Custom Input Sources"></a>Custom Input Sources</h5><p>è‡ªå®šä¹‰ä¸€ä¸ªInput sourceéœ€è¦æ»¡è¶³å¦‚ä¸‹å®šä¹‰ï¼š</p>
<ul>
<li>éœ€è¦input sourceå¤„ç†çš„ä¿¡æ¯</li>
<li>è®©æ„Ÿå…´è¶£çš„å®¢æˆ·ç«¯çŸ¥é“æ€ä¹ˆè”ç³»ä½ çš„input source</li>
<li>ä¸€ä¸ªå¤„ç†ç¨‹åºä¾‹ç¨‹æ¥æ‰§è¡Œä»»ä½•å®¢æˆ·ç«¯çš„å‘é€è¯·æ±‚</li>
<li>å–æ¶ˆç¨‹åº</li>
</ul>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Runloop/runloop004.png" alt=""></p>
<h5 id="Cocoa-Perform-Selector-Sources"><a href="#Cocoa-Perform-Selector-Sources" class="headerlink" title="Cocoa Perform Selector Sources"></a>Cocoa Perform Selector Sources</h5><p>Perform Selector Sources åœ¨æ‰§è¡Œå®Œä»¥åä¼šä»runloopçš„modeä¸­ç§»é™¤ã€‚</p>
<p>å½“è°ƒç”¨è¿™ä¸ªæ–¹æ³•æ—¶ï¼Œtargetçº¿ç¨‹å¿…é¡»åŒ…å«ä¸€ä¸ªæ´»è·ƒçš„runloopï¼Œrunloopä¼šåœ¨ä¸€æ¬¡loopä¸­å¤„ç†æ‰€æœ‰çš„æ’é˜ŸPerformäº‹ä»¶è€Œä¸æ˜¯åªå¤„ç†ä¸€ä¸ªã€‚</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Runloop/runloop005.png" alt=""></p>
<h4 id="Timer-Sources"><a href="#Timer-Sources" class="headerlink" title="Timer Sources"></a>Timer Sources</h4><p>timeréœ€è¦å…³è”ä¸€ä¸ªmodeï¼Œå¦‚æœtimerä¸åœ¨å½“å‰æ´»åŠ¨çš„modeä¸Šï¼Œåˆ™ä¸ä¼šè¢«è§¦å‘ã€‚å¦‚æœtimeræ‰€åœ¨çš„modeæ‰§è¡Œè¿‡ç¨‹ä¸­è¢«åˆ‡æ¢ï¼Œåˆ™è¯¥timerä¹Ÿä¸ä¼šæš‚åœç›´åˆ°modeé‡æ–°åˆ‡æ¢å›æ¥ï¼Œè¿™å°±å†³å®šäº†NSTimerçš„è§¦å‘å¹¶ä¸æ˜¯ååˆ†å¯é çš„ã€‚</p>
<h4 id="Run-Loop-Observers"><a href="#Run-Loop-Observers" class="headerlink" title="Run Loop Observers"></a>Run Loop Observers</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"> /* Run Loop Observer Activities */</div><div class="line">typedef CF_OPTIONS(CFOptionFlags, CFRunLoopActivity) &#123;</div><div class="line">    kCFRunLoopEntry = (1UL &lt;&lt; 0),// å³å°†è¿›å…¥Loop  0x1</div><div class="line">    kCFRunLoopBeforeTimers = (1UL &lt;&lt; 1),// å³å°†å¤„ç† Timer </div><div class="line">    kCFRunLoopBeforeSources = (1UL &lt;&lt; 2),// å³å°†å¤„ç† Source </div><div class="line">    kCFRunLoopBeforeWaiting = (1UL &lt;&lt; 5),// å³å°†è¿›å…¥ä¼‘çœ  0x20</div><div class="line">    kCFRunLoopAfterWaiting = (1UL &lt;&lt; 6),// åˆšä»ä¼‘çœ ä¸­å”¤é†’ </div><div class="line">    </div><div class="line">    kCFRunLoopExit = (1UL &lt;&lt; 7),// å³å°†é€€å‡ºLoop </div><div class="line">    </div><div class="line">    kCFRunLoopAllActivities = 0x0FFFFFFFU</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="Runloopä½¿ç”¨åœºæ™¯"><a href="#Runloopä½¿ç”¨åœºæ™¯" class="headerlink" title="Runloopä½¿ç”¨åœºæ™¯"></a>Runloopä½¿ç”¨åœºæ™¯</h4><ul>
<li>ä½¿ç”¨mach portæˆ–è€…è‡ªå®šä¹‰input source æ¥ä¸å…¶ä»–çº¿ç¨‹é€šä¿¡</li>
<li>ä½¿ç”¨NSTimer</li>
<li>ä½¿ç”¨performSelector</li>
<li>çº¿ç¨‹ä¿æ´»</li>
<li>ç³»ç»Ÿé»˜è®¤ä½¿ç”¨</li>
</ul>
<h4 id="æºç è§£æ"><a href="#æºç è§£æ" class="headerlink" title="æºç è§£æ"></a>æºç è§£æ</h4><p>æºç ä¸‹è½½<a href="https://opensource.apple.com/tarballs/CF/" target="_blank" rel="noopener">https://opensource.apple.com/tarballs/CF/</a></p>
<h5 id="Input-Source-amp-amp-CFRunLoopSource-çš„ç»“æ„"><a href="#Input-Source-amp-amp-CFRunLoopSource-çš„ç»“æ„" class="headerlink" title="Input Source &amp;&amp; CFRunLoopSource çš„ç»“æ„"></a>Input Source &amp;&amp; CFRunLoopSource çš„ç»“æ„</h5><ul>
<li>source0/è‡ªå®šä¹‰ source</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">typedef struct &#123;</div><div class="line">    CFIndex	version;</div><div class="line">    void *	info;</div><div class="line">    const void *(*retain)(const void *info);</div><div class="line">    void	(*release)(const void *info);</div><div class="line">    CFStringRef	(*copyDescription)(const void *info);</div><div class="line">    Boolean	(*equal)(const void *info1, const void *info2);</div><div class="line">    CFHashCode	(*hash)(const void *info);</div><div class="line">    void	(*schedule)(void *info, CFRunLoopRef rl, CFStringRef mode);</div><div class="line">    void	(*cancel)(void *info, CFRunLoopRef rl, CFStringRef mode);</div><div class="line">    void	(*perform)(void *info);</div><div class="line">&#125; CFRunLoopSourceContext;</div></pre></td></tr></table></figure>
<ul>
<li>source1/(mach port source+è‡ªå®šä¹‰ source)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">typedef struct &#123;</div><div class="line">    CFIndex	version;</div><div class="line">    void *	info;</div><div class="line">    const void *(*retain)(const void *info);</div><div class="line">    void	(*release)(const void *info);</div><div class="line">    CFStringRef	(*copyDescription)(const void *info);</div><div class="line">    Boolean	(*equal)(const void *info1, const void *info2);</div><div class="line">    CFHashCode	(*hash)(const void *info);</div><div class="line">#if (TARGET_OS_MAC &amp;&amp; !(TARGET_OS_EMBEDDED || TARGET_OS_IPHONE)) || (TARGET_OS_EMBEDDED || TARGET_OS_IPHONE)</div><div class="line">    mach_port_t	(*getPort)(void *info);</div><div class="line">    void *	(*perform)(void *msg, CFIndex size, CFAllocatorRef allocator, void *info);</div><div class="line">#else</div><div class="line">    void *	(*getPort)(void *info);</div><div class="line">    void	(*perform)(void *info);</div><div class="line">#endif</div><div class="line">&#125; CFRunLoopSourceContext1;</div></pre></td></tr></table></figure>
<ul>
<li>CFRunLoopSource</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">struct __CFRunLoopSource &#123;</div><div class="line">    CFRuntimeBase _base;</div><div class="line">    uint32_t _bits;</div><div class="line">    pthread_mutex_t _lock;</div><div class="line">    CFIndex _order;			/* immutable */</div><div class="line">    CFMutableBagRef _runLoops;</div><div class="line">    union &#123;</div><div class="line">	CFRunLoopSourceContext version0;	/* immutable, except invalidation */</div><div class="line">        CFRunLoopSourceContext1 version1;	/* immutable, except invalidation */</div><div class="line">    &#125; _context;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h5 id="observer-amp-amp-CFRunLoopObserver-çš„ç»“æ„"><a href="#observer-amp-amp-CFRunLoopObserver-çš„ç»“æ„" class="headerlink" title="observer &amp;&amp; CFRunLoopObserver çš„ç»“æ„"></a>observer &amp;&amp; CFRunLoopObserver çš„ç»“æ„</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">typedef struct &#123;</div><div class="line">    CFIndex	version;</div><div class="line">    void *	info;</div><div class="line">    const void *(*retain)(const void *info);</div><div class="line">    void	(*release)(const void *info);</div><div class="line">    CFStringRef	(*copyDescription)(const void *info);</div><div class="line">&#125; CFRunLoopObserverContext;</div><div class="line"></div><div class="line">struct __CFRunLoopObserver &#123;</div><div class="line">    CFRuntimeBase _base;</div><div class="line">    pthread_mutex_t _lock;</div><div class="line">    CFRunLoopRef _runLoop;</div><div class="line">    CFIndex _rlCount;</div><div class="line">    CFOptionFlags _activities;		/* immutable */</div><div class="line">    CFIndex _order;			/* immutable */</div><div class="line">    CFRunLoopObserverCallBack _callout;	/* immutable */</div><div class="line">    CFRunLoopObserverContext _context;	/* immutable, except invalidation */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h5 id="NSTimer-amp-amp-CFRunloopTimer-çš„ç»“æ„"><a href="#NSTimer-amp-amp-CFRunloopTimer-çš„ç»“æ„" class="headerlink" title="NSTimer &amp;&amp; CFRunloopTimer çš„ç»“æ„"></a>NSTimer &amp;&amp; CFRunloopTimer çš„ç»“æ„</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">typedef struct &#123;</div><div class="line">    CFIndex	version;</div><div class="line">    void *	info;</div><div class="line">    const void *(*retain)(const void *info);</div><div class="line">    void	(*release)(const void *info);</div><div class="line">    CFStringRef	(*copyDescription)(const void *info);</div><div class="line">&#125; CFRunLoopTimerContext;</div><div class="line"></div><div class="line">struct __CFRunLoopTimer &#123;</div><div class="line">    CFRuntimeBase _base;</div><div class="line">    uint16_t _bits;</div><div class="line">    pthread_mutex_t _lock;</div><div class="line">    CFRunLoopRef _runLoop;</div><div class="line">    CFMutableSetRef _rlModes;</div><div class="line">    CFAbsoluteTime _nextFireDate;</div><div class="line">    CFTimeInterval _interval;		/* immutable */</div><div class="line">    CFTimeInterval _tolerance;          /* mutable */</div><div class="line">    uint64_t _fireTSR;			/* TSR units */</div><div class="line">    CFIndex _order;			/* immutable */</div><div class="line">    CFRunLoopTimerCallBack _callout;	/* immutable */</div><div class="line">    CFRunLoopTimerContext _context;	/* immutable, except invalidation */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h5 id="Mode-çš„ç»“æ„"><a href="#Mode-çš„ç»“æ„" class="headerlink" title="Mode çš„ç»“æ„"></a>Mode çš„ç»“æ„</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line">struct __CFRunLoopMode &#123;</div><div class="line">    CFRuntimeBase _base;</div><div class="line">    pthread_mutex_t _lock;	/* must have the run loop locked before locking this */</div><div class="line">    CFStringRef _name;</div><div class="line">    Boolean _stopped;</div><div class="line">    char _padding[3];</div><div class="line">    CFMutableSetRef _sources0;</div><div class="line">    CFMutableSetRef _sources1;</div><div class="line">    CFMutableArrayRef _observers;</div><div class="line">    CFMutableArrayRef _timers;</div><div class="line">    CFMutableDictionaryRef _portToV1SourceMap;</div><div class="line">    __CFPortSet _portSet;</div><div class="line">    CFIndex _observerMask;</div><div class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</div><div class="line">    dispatch_source_t _timerSource;</div><div class="line">    dispatch_queue_t _queue;</div><div class="line">    Boolean _timerFired; // set to true by the source when a timer has fired</div><div class="line">    Boolean _dispatchTimerArmed;</div><div class="line">#endif</div><div class="line">#if USE_MK_TIMER_TOO</div><div class="line">    mach_port_t _timerPort;//å¦‚æœæ˜¯MK_TIMERçš„è¯ï¼Œä¼šé€šè¿‡è¿™ä¸ªç«¯å£å”¤é†’çº¿ç¨‹</div><div class="line">    Boolean _mkTimerArmed;</div><div class="line">#endif</div><div class="line">#if DEPLOYMENT_TARGET_WINDOWS</div><div class="line">    DWORD _msgQMask;</div><div class="line">    void (*_msgPump)(void);</div><div class="line">#endif</div><div class="line">    uint64_t _timerSoftDeadline; /* TSR */</div><div class="line">    uint64_t _timerHardDeadline; /* TSR */</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="runloop-çš„ç»“æ„"><a href="#runloop-çš„ç»“æ„" class="headerlink" title="runloop çš„ç»“æ„"></a>runloop çš„ç»“æ„</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">struct _block_item &#123;</div><div class="line">    struct _block_item *_next;</div><div class="line">    CFTypeRef _mode;	// CFString or CFSet</div><div class="line">    void (^_block)(void);</div><div class="line">&#125;;</div><div class="line"></div><div class="line">typedef struct _per_run_data &#123;</div><div class="line">    uint32_t a;</div><div class="line">    uint32_t b;</div><div class="line">    uint32_t stopped;</div><div class="line">    uint32_t ignoreWakeUps;</div><div class="line">&#125; _per_run_data;</div><div class="line"></div><div class="line">struct __CFRunLoop &#123;</div><div class="line">    CFRuntimeBase _base;</div><div class="line">    pthread_mutex_t _lock;			/* locked for accessing mode list */</div><div class="line">    __CFPort _wakeUpPort;			// used for CFRunLoopWakeUp source0çš„æ‰‹åŠ¨å”¤é†’å°±æ˜¯é€šè¿‡ç»™è¿™ä¸ªç«¯å£å‘æ¶ˆæ¯å®ç°çš„ã€‚</div><div class="line">    Boolean _unused;</div><div class="line">    </div><div class="line">    volatile _per_run_data *_perRunData;              // reset for runs of the run  loop ä¸ªäººç†è§£ä¸ºrunloopçš„ä¸€ä¸ªé…ç½®æ–‡ä»¶</div><div class="line">    </div><div class="line">    pthread_t _pthread;</div><div class="line">    uint32_t _winthread;</div><div class="line">    </div><div class="line">    CFMutableSetRef _commonModes;//å­˜æ”¾ common mode çš„é›†åˆ</div><div class="line">    CFMutableSetRef _commonModeItems;//æ¯ä¸ª common mode éƒ½æœ‰çš„ item (source, timer and observer) é›†åˆ</div><div class="line">    </div><div class="line">    CFRunLoopModeRef _currentMode;</div><div class="line">    CFMutableSetRef _modes;//è¿™ä¸ª run loop æ‰€æœ‰çš„ mode é›†åˆ</div><div class="line">    </div><div class="line">    struct _block_item *_blocks_head;</div><div class="line">    struct _block_item *_blocks_tail;</div><div class="line">    </div><div class="line">    </div><div class="line">    CFAbsoluteTime _runTime;</div><div class="line">    CFAbsoluteTime _sleepTime;</div><div class="line">    CFTypeRef _counterpart;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h4 id="Runloopçš„åˆ›å»ºå’Œé”€æ¯-CFRunLoopCreate-amp-amp-CFRunLoopGet0-amp-amp-CFRunLoopGetMain-amp-amp-CFRunLoopGetCurrent-amp-amp-CFFinalizeRunLoop"><a href="#Runloopçš„åˆ›å»ºå’Œé”€æ¯-CFRunLoopCreate-amp-amp-CFRunLoopGet0-amp-amp-CFRunLoopGetMain-amp-amp-CFRunLoopGetCurrent-amp-amp-CFFinalizeRunLoop" class="headerlink" title="Runloopçš„åˆ›å»ºå’Œé”€æ¯ CFRunLoopCreate() &amp;&amp; CFRunLoopGet0() &amp;&amp; CFRunLoopGetMain() &amp;&amp; CFRunLoopGetCurrent() &amp;&amp; CFFinalizeRunLoop()"></a>Runloopçš„åˆ›å»ºå’Œé”€æ¯ CFRunLoopCreate() &amp;&amp; CFRunLoopGet0() &amp;&amp; CFRunLoopGetMain() &amp;&amp; CFRunLoopGetCurrent() &amp;&amp; CFFinalizeRunLoop()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">//è·å–ä¸»çº¿ç¨‹runloop</div><div class="line">CFRunLoopRef CFRunLoopGetMain(void) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    static CFRunLoopRef __main = NULL; // no retain needed</div><div class="line">    if (!__main) __main = _CFRunLoopGet0(pthread_main_thread_np()); // no CAS needed</div><div class="line">    return __main;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//è·å–å½“å‰çº¿ç¨‹runloop</div><div class="line">CFRunLoopRef CFRunLoopGetCurrent(void) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    CFRunLoopRef rl = (CFRunLoopRef)_CFGetTSD(__CFTSDKeyRunLoop);</div><div class="line">    if (rl) return rl;</div><div class="line">    return _CFRunLoopGet0(pthread_self());</div><div class="line">&#125;</div><div class="line"></div><div class="line">//ä¿å­˜runloopå’Œpthreadçš„å…¨å±€å­—å…¸ã€‚key = pthreadPointer(t); value = runloop.</div><div class="line">static CFMutableDictionaryRef __CFRunLoops = NULL;</div><div class="line">static CFLock_t loopsLock = CFLockInit;</div><div class="line"></div><div class="line">CF_EXPORT CFRunLoopRef _CFRunLoopGet0(pthread_t t) &#123;</div><div class="line"></div><div class="line">	//å¦‚æœå½“å‰çº¿ç¨‹ä¸º0 åˆ™å–ä¸»çº¿ç¨‹.</div><div class="line">    if (pthread_equal(t, kNilPthreadT)) &#123;</div><div class="line">	t = pthread_main_thread_np();</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    __CFLock(&amp;loopsLock);</div><div class="line">    </div><div class="line">    //å…¨å±€å­—å…¸ä¸ºç©ºï¼Œåˆ™åˆ›å»ºå­—å…¸</div><div class="line">    if (!__CFRunLoops) &#123;</div><div class="line">        __CFUnlock(&amp;loopsLock);</div><div class="line">	CFMutableDictionaryRef dict = CFDictionaryCreateMutable(kCFAllocatorSystemDefault, 0, NULL, &amp;kCFTypeDictionaryValueCallBacks);</div><div class="line"></div><div class="line">	//åˆ›å»ºä¸»çº¿ç¨‹çš„runloop</div><div class="line">	CFRunLoopRef mainLoop = __CFRunLoopCreate(pthread_main_thread_np());</div><div class="line"></div><div class="line">	//å°†runloopå’Œpthread setåˆ°ä¸€ä¸ªä¸´æ—¶å­—å…¸ä¸­</div><div class="line">	CFDictionarySetValue(dict, pthreadPointer(pthread_main_thread_np()), mainLoop);</div><div class="line">	</div><div class="line">	//å°†ä¸´æ—¶å­—å…¸å¤åˆ¶åˆ°å…¨å±€å­—å…¸ï¼Œè¿™ä¸ªæ˜¯ä¸€ä¸ªåŸå­æ“ä½œã€‚</div><div class="line">	if (!OSAtomicCompareAndSwapPtrBarrier(NULL, dict, (void * volatile *)&amp;__CFRunLoops)) &#123;</div><div class="line">	    CFRelease(dict);</div><div class="line">	&#125;</div><div class="line">	CFRelease(mainLoop);</div><div class="line">        __CFLock(&amp;loopsLock);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //ä»å…¨å±€å­—å…¸ä¸­å–å‡ºå½“å‰çº¿ç¨‹å¯¹åº”çš„runloop</div><div class="line">    CFRunLoopRef loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));</div><div class="line">    __CFUnlock(&amp;loopsLock);</div><div class="line">    </div><div class="line">    //å¦‚æœrunloopä¸ºç©ºï¼Œæ–°å»ºrunloop,å¹¶ä¿å­˜åˆ°å…¨å±€å­—å…¸ä¸­</div><div class="line">    if (!loop) &#123;</div><div class="line">	CFRunLoopRef newLoop = __CFRunLoopCreate(t);</div><div class="line">        __CFLock(&amp;loopsLock);</div><div class="line">	loop = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(t));</div><div class="line">	if (!loop) &#123;</div><div class="line">	    CFDictionarySetValue(__CFRunLoops, pthreadPointer(t), newLoop);</div><div class="line">	    loop = newLoop;</div><div class="line">	&#125;</div><div class="line">        // don&apos;t release run loops inside the loopsLock, because CFRunLoopDeallocate may end up taking it</div><div class="line">        __CFUnlock(&amp;loopsLock);</div><div class="line">	CFRelease(newLoop);</div><div class="line">    &#125;</div><div class="line">    if (pthread_equal(t, pthread_self())) &#123;</div><div class="line">        _CFSetTSD(__CFTSDKeyRunLoop, (void *)loop, NULL);</div><div class="line">        if (0 == _CFGetTSD(__CFTSDKeyRunLoopCntr)) &#123;</div><div class="line">            _CFSetTSD(__CFTSDKeyRunLoopCntr, (void *)(PTHREAD_DESTRUCTOR_ITERATIONS-1), (void (*)(void *))__CFFinalizeRunLoop);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return loop;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//å…¥å‚ä¸ºä¸€ä¸ªçº¿ç¨‹</div><div class="line">static CFRunLoopRef __CFRunLoopCreate(pthread_t t) &#123;</div><div class="line">    CFRunLoopRef loop = NULL;</div><div class="line">    CFRunLoopModeRef rlm;</div><div class="line">    uint32_t size = sizeof(struct __CFRunLoop) - sizeof(CFRuntimeBase);</div><div class="line">    </div><div class="line">    //åˆ›å»ºrunloopå®ä¾‹</div><div class="line">    loop = (CFRunLoopRef)_CFRuntimeCreateInstance(kCFAllocatorSystemDefault, CFRunLoopGetTypeID(), size, NULL);</div><div class="line">    if (NULL == loop) &#123;</div><div class="line">	return NULL;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //åˆå§‹åŒ–é…ç½®</div><div class="line">    (void)__CFRunLoopPushPerRunData(loop);</div><div class="line">    __CFRunLoopLockInit(&amp;loop-&gt;_lock);</div><div class="line"></div><div class="line">	//åˆå§‹åŒ–å”¤é†’port</div><div class="line">    loop-&gt;_wakeUpPort = __CFPortAllocate();</div><div class="line">    if (CFPORT_NULL == loop-&gt;_wakeUpPort) HALT;</div><div class="line">    __CFRunLoopSetIgnoreWakeUps(loop);</div><div class="line">    </div><div class="line">    //åˆå§‹åŒ–commonModes å¹¶ add kCFRunLoopDefaultMode</div><div class="line">    loop-&gt;_commonModes = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</div><div class="line">    CFSetAddValue(loop-&gt;_commonModes, kCFRunLoopDefaultMode);</div><div class="line">    </div><div class="line">    //åˆå§‹åŒ–å…¶ä»–å˜é‡</div><div class="line">    loop-&gt;_commonModeItems = NULL;</div><div class="line">    loop-&gt;_currentMode = NULL;</div><div class="line">    loop-&gt;_modes = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</div><div class="line">    loop-&gt;_blocks_head = NULL;</div><div class="line">    loop-&gt;_blocks_tail = NULL;</div><div class="line">    loop-&gt;_counterpart = NULL;</div><div class="line">    </div><div class="line">    //ç»‘å®šçº¿ç¨‹</div><div class="line">    loop-&gt;_pthread = t;</div><div class="line">#if DEPLOYMENT_TARGET_WINDOWS</div><div class="line">    loop-&gt;_winthread = GetCurrentThreadId();</div><div class="line">#else</div><div class="line">    loop-&gt;_winthread = 0;</div><div class="line">#endif</div><div class="line">    rlm = __CFRunLoopFindMode(loop, kCFRunLoopDefaultMode, true);</div><div class="line">    if (NULL != rlm) __CFRunLoopModeUnlock(rlm);</div><div class="line">    return loop;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">// çº¿ç¨‹é€€å‡ºæ—¶è°ƒç”¨</div><div class="line">CF_PRIVATE void __CFFinalizeRunLoop(uintptr_t data) &#123;</div><div class="line">    CFRunLoopRef rl = NULL;</div><div class="line">    if (data &lt;= 1) &#123;</div><div class="line">	__CFLock(&amp;loopsLock);</div><div class="line">	if (__CFRunLoops) &#123;</div><div class="line">		</div><div class="line">		//åœ¨å…¨å±€å­—å…¸ä¸­ç§»é™¤è¯¥runloop</div><div class="line">	    rl = (CFRunLoopRef)CFDictionaryGetValue(__CFRunLoops, pthreadPointer(pthread_self()));</div><div class="line">	    if (rl) CFRetain(rl);</div><div class="line">	    CFDictionaryRemoveValue(__CFRunLoops, pthreadPointer(pthread_self()));</div><div class="line">	&#125;</div><div class="line">	__CFUnlock(&amp;loopsLock);</div><div class="line">    &#125; else &#123;</div><div class="line">        _CFSetTSD(__CFTSDKeyRunLoopCntr, (void *)(data - 1), (void (*)(void *))__CFFinalizeRunLoop);</div><div class="line">    &#125;</div><div class="line">    if (rl &amp;&amp; CFRunLoopGetMain() != rl) &#123; // protect against cooperative threads</div><div class="line">        if (NULL != rl-&gt;_counterpart) &#123;</div><div class="line">            CFRelease(rl-&gt;_counterpart);</div><div class="line">	    rl-&gt;_counterpart = NULL;</div><div class="line">        &#125;</div><div class="line">	// purge all sources before deallocation</div><div class="line">        CFArrayRef array = CFRunLoopCopyAllModes(rl);</div><div class="line">        </div><div class="line">        //ç§»é™¤è¯¥runloopçš„æ‰€æœ‰source</div><div class="line">        for (CFIndex idx = CFArrayGetCount(array); idx--;) &#123;</div><div class="line">            CFStringRef modeName = (CFStringRef)CFArrayGetValueAtIndex(array, idx);</div><div class="line">            __CFRunLoopRemoveAllSources(rl, modeName);</div><div class="line">        &#125;</div><div class="line">        __CFRunLoopRemoveAllSources(rl, kCFRunLoopCommonModes);</div><div class="line">        CFRelease(array);</div><div class="line">    &#125;</div><div class="line">    if (rl) CFRelease(rl);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h5><ul>
<li>runloopçš„åˆ›å»ºæ˜¯æ‡’åŠ è½½çš„æ–¹å¼åˆ›å»ºï¼Œåœ¨ç¬¬ä¸€æ¬¡è·å–è¯¥runloopçš„æ—¶å€™æ‰ä¼šå»åˆ›å»ºï¼Œæ‰€ä»¥å­çº¿ç¨‹å¦‚æœæ²¡æœ‰æ‰‹åŠ¨çš„å»è·å–å¹¶è¿è¡Œrunloop,æ˜¯ä¸ä¼šè‡ªåŠ¨åˆ›å»ºçš„ã€‚</li>
<li>runloopå’Œçº¿ç¨‹æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼Œä¿å­˜åœ¨ä¸€ä¸ªå…¨å±€çš„å­—å…¸ä¸­ã€‚keyæ˜¯çº¿ç¨‹çš„æŒ‡é’ˆï¼Œvalueæ˜¯å¯¹åº”çš„runloop.</li>
<li>runloopçš„é”€æ¯å‘ç”Ÿåœ¨çº¿ç¨‹é€€å‡ºæ—¶ã€‚</li>
</ul>
<h4 id="Runloopçš„è¿è¡Œ-CFRunLoopRun-amp-amp-CFRunLoopRunSpecific-amp-amp-CFRunLoopRun"><a href="#Runloopçš„è¿è¡Œ-CFRunLoopRun-amp-amp-CFRunLoopRunSpecific-amp-amp-CFRunLoopRun" class="headerlink" title="Runloopçš„è¿è¡Œ CFRunLoopRun &amp;&amp; CFRunLoopRunSpecific &amp;&amp; CFRunLoopRun"></a>Runloopçš„è¿è¡Œ CFRunLoopRun &amp;&amp; CFRunLoopRunSpecific &amp;&amp; CFRunLoopRun</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div></pre></td><td class="code"><pre><div class="line">struct __timeout_context &#123;</div><div class="line">    dispatch_source_t ds;</div><div class="line">    CFRunLoopRef rl;</div><div class="line">    uint64_t termTSR;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">static void __CFRunLoopTimeoutCancel(void *arg) &#123;</div><div class="line">    struct __timeout_context *context = (struct __timeout_context *)arg;</div><div class="line">    CFRelease(context-&gt;rl);</div><div class="line">    dispatch_release(context-&gt;ds);</div><div class="line">    free(context);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static void __CFRunLoopTimeout(void *arg) &#123;</div><div class="line">    struct __timeout_context *context = (struct __timeout_context *)arg;</div><div class="line">    context-&gt;termTSR = 0ULL;</div><div class="line">    CFRUNLOOP_WAKEUP_FOR_TIMEOUT();</div><div class="line">    CFRunLoopWakeUp(context-&gt;rl);</div><div class="line">    // The interval is DISPATCH_TIME_FOREVER, so this won&apos;t fire again</div><div class="line">&#125;</div><div class="line"></div><div class="line">void CFRunLoopRun(void) &#123;	/* DOES CALLOUT */</div><div class="line">    int32_t result;</div><div class="line">    do &#123;</div><div class="line">        result = CFRunLoopRunSpecific(CFRunLoopGetCurrent(), kCFRunLoopDefaultMode, 1.0e10, false);</div><div class="line">        CHECK_FOR_FORK();</div><div class="line">    &#125; while (kCFRunLoopRunStopped != result &amp;&amp; kCFRunLoopRunFinished != result);</div><div class="line">&#125;</div><div class="line"></div><div class="line">SInt32 CFRunLoopRunSpecific(CFRunLoopRef rl, CFStringRef modeName, CFTimeInterval seconds, Boolean returnAfterSourceHandled) &#123;     /* DOES CALLOUT */</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    if (__CFRunLoopIsDeallocating(rl)) return kCFRunLoopRunFinished;</div><div class="line">    __CFRunLoopLock(rl);</div><div class="line">    CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, modeName, false);</div><div class="line">    if (NULL == currentMode || __CFRunLoopModeIsEmpty(rl, currentMode, rl-&gt;_currentMode)) &#123;</div><div class="line">	Boolean did = false;</div><div class="line">	if (currentMode) __CFRunLoopModeUnlock(currentMode);</div><div class="line">	__CFRunLoopUnlock(rl);</div><div class="line">	return did ? kCFRunLoopRunHandledSource : kCFRunLoopRunFinished;</div><div class="line">    &#125;</div><div class="line">    volatile _per_run_data *previousPerRun = __CFRunLoopPushPerRunData(rl);</div><div class="line">    CFRunLoopModeRef previousMode = rl-&gt;_currentMode;</div><div class="line">    rl-&gt;_currentMode = currentMode;</div><div class="line">    int32_t result = kCFRunLoopRunFinished;</div><div class="line"></div><div class="line">	// 1.é€šçŸ¥è§‚å¯Ÿè€…runloopå³å°†è¿›å…¥loop</div><div class="line">	if (currentMode-&gt;_observerMask &amp; kCFRunLoopEntry ) __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopEntry);</div><div class="line">	</div><div class="line">	//run</div><div class="line">	result = __CFRunLoopRun(rl, currentMode, seconds, returnAfterSourceHandled, previousMode);</div><div class="line">	</div><div class="line">	// 10. é€šçŸ¥è§‚å¯Ÿè€…runLoopå³å°†é€€å‡º</div><div class="line">	if (currentMode-&gt;_observerMask &amp; kCFRunLoopExit ) __CFRunLoopDoObservers(rl, currentMode, kCFRunLoopExit);</div><div class="line"></div><div class="line">        __CFRunLoopModeUnlock(currentMode);</div><div class="line">        __CFRunLoopPopPerRunData(rl, previousPerRun);</div><div class="line">	rl-&gt;_currentMode = previousMode;</div><div class="line">    __CFRunLoopUnlock(rl);</div><div class="line">    return result;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">/**</div><div class="line"> *  è¿è¡Œrun loop</div><div class="line"> *</div><div class="line"> *  @param rl              è¿è¡Œçš„RunLoopå¯¹è±¡</div><div class="line"> *  @param rlm             è¿è¡Œçš„mode</div><div class="line"> *  @param seconds         run loopè¶…æ—¶æ—¶é—´</div><div class="line"> *  @param stopAfterHandle true:run loopå¤„ç†å®Œäº‹ä»¶å°±é€€å‡º  false:ä¸€ç›´è¿è¡Œç›´åˆ°è¶…æ—¶æˆ–è€…è¢«æ‰‹åŠ¨ç»ˆæ­¢</div><div class="line"> *  @param previousMode    ä¸Šä¸€æ¬¡è¿è¡Œçš„mode</div><div class="line"> *</div><div class="line"> *  @return è¿”å›4ç§çŠ¶æ€</div><div class="line"> */</div><div class="line">static int32_t __CFRunLoopRun(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFTimeInterval seconds, Boolean stopAfterHandle, CFRunLoopModeRef previousMode) &#123;</div><div class="line"></div><div class="line">	</div><div class="line">    uint64_t startTSR = mach_absolute_time();</div><div class="line">    </div><div class="line">    //å¦‚æœè¯¥runloopå·²åœæ­¢ï¼Œç›´æ¥é€€å‡ºã€‚</div><div class="line">    if (__CFRunLoopIsStopped(rl)) &#123;</div><div class="line">        __CFRunLoopUnsetStopped(rl);</div><div class="line">	return kCFRunLoopRunStopped;</div><div class="line">    &#125; else if (rlm-&gt;_stopped) &#123;</div><div class="line">	rlm-&gt;_stopped = false;</div><div class="line">	return kCFRunLoopRunStopped;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    </div><div class="line">    //è·å–GCDçš„æ¶ˆæ¯ç«¯å£</div><div class="line">    mach_port_name_t dispatchPort = MACH_PORT_NULL;</div><div class="line">    Boolean libdispatchQSafe = pthread_main_np() &amp;&amp; ((HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; NULL == previousMode) || (!HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; 0 == _CFGetTSD(__CFTSDKeyIsInGCDMainQ)));</div><div class="line">    </div><div class="line">    //çœ‹åˆ¤æ–­æ¡ä»¶ï¼Œåªæœ‰å½“å‰æ˜¯ä¸»çº¿ç¨‹ï¼Œæ‰è·å–ç«¯å£ã€‚ï¼ˆGCDåªèƒ½å”¤é†’ä¸»çº¿ç¨‹çš„runloopï¼‰</div><div class="line">    if (libdispatchQSafe &amp;&amp; (CFRunLoopGetMain() == rl) &amp;&amp; CFSetContainsValue(rl-&gt;_commonModes, rlm-&gt;_name)) dispatchPort = _dispatch_get_main_queue_port_4CF();</div><div class="line">    </div><div class="line">    //ä½¿ç”¨GCDçš„sourceæ¥å®ç°NSTimer</div><div class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</div><div class="line">    mach_port_name_t modeQueuePort = MACH_PORT_NULL;</div><div class="line">    if (rlm-&gt;_queue) &#123;</div><div class="line">        modeQueuePort = _dispatch_runloop_root_queue_get_port_4CF(rlm-&gt;_queue);</div><div class="line">        if (!modeQueuePort) &#123;</div><div class="line">            CRASH(&quot;Unable to get port for run loop mode queue (%d)&quot;, -1);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">#endif</div><div class="line">    </div><div class="line">    //è®¾ç½®runloopçš„è¶…æ—¶æ—¶é—´ï¼Œsecondæ˜¯å‚æ•°ã€‚</div><div class="line">    dispatch_source_t timeout_timer = NULL;</div><div class="line">    struct __timeout_context *timeout_context = (struct __timeout_context *)malloc(sizeof(*timeout_context));</div><div class="line">    if (seconds &lt;= 0.0) &#123; // instant timeout</div><div class="line">        seconds = 0.0;</div><div class="line">        timeout_context-&gt;termTSR = 0ULL;</div><div class="line">    &#125; else if (seconds &lt;= TIMER_INTERVAL_LIMIT) &#123;</div><div class="line">	dispatch_queue_t queue = pthread_main_np() ? __CFDispatchQueueGetGenericMatchingMain() : __CFDispatchQueueGetGenericBackground();</div><div class="line">	timeout_timer = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, queue);</div><div class="line">        dispatch_retain(timeout_timer);</div><div class="line">	timeout_context-&gt;ds = timeout_timer;</div><div class="line">	timeout_context-&gt;rl = (CFRunLoopRef)CFRetain(rl);</div><div class="line">	timeout_context-&gt;termTSR = startTSR + __CFTimeIntervalToTSR(seconds);</div><div class="line">	dispatch_set_context(timeout_timer, timeout_context); // source gets ownership of context</div><div class="line">	</div><div class="line">	//è°ƒç”¨__CFRunLoopTimeout</div><div class="line">	dispatch_source_set_event_handler_f(timeout_timer, __CFRunLoopTimeout);</div><div class="line">        dispatch_source_set_cancel_handler_f(timeout_timer, __CFRunLoopTimeoutCancel);</div><div class="line">        uint64_t ns_at = (uint64_t)((__CFTSRToTimeInterval(startTSR) + seconds) * 1000000000ULL);</div><div class="line">        dispatch_source_set_timer(timeout_timer, dispatch_time(1, ns_at), DISPATCH_TIME_FOREVER, 1000ULL);</div><div class="line">        dispatch_resume(timeout_timer);</div><div class="line">    &#125; else &#123; // infinite timeout</div><div class="line">        seconds = 9999999999.0;</div><div class="line">        timeout_context-&gt;termTSR = UINT64_MAX;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	//åˆå§‹åŒ–ä¸ºtrue</div><div class="line">    Boolean didDispatchPortLastTime = true;</div><div class="line">    int32_t retVal = 0;//è¿”å›çŠ¶æ€</div><div class="line">    </div><div class="line">    //do whileå¾ªç¯</div><div class="line">    do &#123;</div><div class="line">    </div><div class="line">    //runloopç¡çœ çš„æ—¶å€™ä¼šæ³¨å†Œè¿™ä¸ªç«¯å£ç”¨æ¥æ¥å£æ¶ˆæ¯    </div><div class="line">	__CFPortSet waitSet = rlm-&gt;_portSet;</div><div class="line"></div><div class="line">	// è®¾ç½®RunLoopä¸ºå¯ä»¥è¢«å”¤é†’çŠ¶æ€</div><div class="line">        __CFRunLoopUnsetIgnoreWakeUps(rl);</div><div class="line"></div><div class="line">	// 2.é€šçŸ¥observerï¼Œå³å°†è§¦å‘timerå›è°ƒï¼Œå¤„ç†timeräº‹ä»¶</div><div class="line">        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeTimers) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeTimers);</div><div class="line">        </div><div class="line">   	// 3.é€šçŸ¥observerï¼Œå³å°†è§¦å‘Source0å›è°ƒ</div><div class="line">        if (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeSources) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeSources);</div><div class="line"></div><div class="line"></div><div class="line">	// æ‰§è¡ŒåŠ å…¥å½“å‰ runloop çš„ block</div><div class="line">	__CFRunLoopDoBlocks(rl, rlm);</div><div class="line">	</div><div class="line">	 	 // 4.å¤„ç† source0 äº‹ä»¶ æœ‰äº‹ä»¶å¤„ç†è¿”å› trueï¼Œæ²¡æœ‰äº‹ä»¶è¿”å› false</div><div class="line">        Boolean sourceHandledThisLoop = __CFRunLoopDoSources0(rl, rlm, stopAfterHandle);</div><div class="line">        </div><div class="line">        // å¦‚æœå®é™…å¤„ç†äº† sources 0ï¼Œå†ä¸€æ¬¡å¤„ç† blocksï¼ˆæœ‰å¯èƒ½æ˜¯source0çš„å›è°ƒä¸­åˆç»™runloopæ·»åŠ äº†blockï¼‰</div><div class="line">        if (sourceHandledThisLoop) &#123;</div><div class="line">            __CFRunLoopDoBlocks(rl, rlm);</div><div class="line">			&#125;</div><div class="line">		</div><div class="line">		 // å¦‚æœæ²¡æœ‰ Sources0 äº‹ä»¶å¤„ç† å¹¶ä¸” æ²¡æœ‰è¶…æ—¶ï¼Œpoll ä¸º false</div><div class="line">        // å¦‚æœæœ‰ Sources0 äº‹ä»¶å¤„ç† æˆ–è€… è¶…æ—¶ï¼Œpoll éƒ½ä¸º true</div><div class="line">        Boolean poll = sourceHandledThisLoop || (0ULL == timeout_context-&gt;termTSR);</div><div class="line">        </div><div class="line">         if (MACH_PORT_NULL != dispatchPort &amp;&amp; !didDispatchPortLastTime) &#123;</div><div class="line"></div><div class="line">         //å¦‚æœæ”¶åˆ°source1çš„æ¶ˆæ¯</div><div class="line">            msg = (mach_msg_header_t *)msg_buffer;</div><div class="line">            if (__CFRunLoopServiceMachPort(dispatchPort, &amp;msg, sizeof(msg_buffer), &amp;livePort, 0, &amp;voucherState, NULL)) &#123;</div><div class="line">                goto handle_msg;    </div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        didDispatchPortLastTime = false;</div><div class="line"></div><div class="line">	// 6.é€šçŸ¥è§‚å¯Ÿè€…RunLoopå³å°†è¿›å…¥ä¼‘çœ </div><div class="line">	if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopBeforeWaiting)) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopBeforeWaiting);</div><div class="line">	</div><div class="line">	 // 7.è®¾ç½®RunLoopä¸ºä¼‘çœ çŠ¶æ€</div><div class="line">	__CFRunLoopSetSleeping(rl);</div><div class="line">	</div><div class="line">	// do not do any user callouts after this point (after notifying of sleeping)</div><div class="line"></div><div class="line">        // Must push the local-to-this-activation ports in on every loop</div><div class="line">        // iteration, as this mode could be run re-entrantly and we don&apos;t</div><div class="line">        // want these ports to get serviced.</div><div class="line"></div><div class="line">	//å°†ç¡çœ ç­‰å¾…ç«¯å£æ·»åŠ åˆ°å½“å‰mach portæ´»è·ƒåˆ—è¡¨</div><div class="line">        __CFPortSetInsert(dispatchPort, waitSet);</div><div class="line">        </div><div class="line">	__CFRunLoopModeUnlock(rlm);</div><div class="line">	__CFRunLoopUnlock(rl);</div><div class="line"></div><div class="line">		//è®°å½•å¼€å§‹ç¡çœ æ—¶é—´</div><div class="line">        CFAbsoluteTime sleepStart = poll ? 0.0 : CFAbsoluteTimeGetCurrent();</div><div class="line"></div><div class="line"></div><div class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</div><div class="line"></div><div class="line">		// ç­‰å¾…è¢«å”¤é†’ï¼Œå¯ä»¥è¢« sources0ã€source1ã€Mach port source,timersã€CFRunLoopWakeUp å‡½æ•°å’Œ GCD äº‹ä»¶ï¼ˆå¦‚æœåœ¨ä¸»çº¿ç¨‹ï¼‰</div><div class="line">        do &#123;</div><div class="line">        </div><div class="line">        	  //æ¸…ç†æ¶ˆæ¯ç¼“å­˜åŒº</div><div class="line">            if (kCFUseCollectableAllocator) &#123;</div><div class="line">                // objc_clear_stack(0);</div><div class="line">                // &lt;rdar://problem/16393959&gt;</div><div class="line">                memset(msg_buffer, 0, sizeof(msg_buffer));</div><div class="line">            &#125;</div><div class="line">            msg = (mach_msg_header_t *)msg_buffer;</div><div class="line">            </div><div class="line">            // æ¥æ”¶waitSetç«¯å£çš„æ¶ˆæ¯ </div><div class="line">            __CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort, poll ? 0 : TIMEOUT_INFINITY, &amp;voucherState, &amp;voucherCopy);</div><div class="line">            </div><div class="line">			  // å¦‚æœæ˜¯ timer ç«¯å£å”¤é†’çš„ï¼Œè¿›è¡Œä¸€ä¸‹å–„åå¤„ç†ï¼Œä¹‹åå†å¤„ç† timer</div><div class="line">            if (modeQueuePort != MACH_PORT_NULL &amp;&amp; livePort == modeQueuePort) &#123;</div><div class="line">                // Drain the internal queue. If one of the callout blocks sets the timerFired flag, break out and service the timer.</div><div class="line">                while (_dispatch_runloop_root_queue_perform_4CF(rlm-&gt;_queue));</div><div class="line">                if (rlm-&gt;_timerFired) &#123;</div><div class="line">                    // Leave livePort as the queue port, and service timers below</div><div class="line">                    rlm-&gt;_timerFired = false;</div><div class="line">                    break;</div><div class="line">                &#125; else &#123;</div><div class="line">                    if (msg &amp;&amp; msg != (mach_msg_header_t *)msg_buffer) free(msg);</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">            </div><div class="line">            	   // ä¸æ˜¯ timer ç«¯å£å”¤é†’çš„ï¼Œè·³å‡ºå¾ªç¯ï¼Œè¿›è¡Œæ¥ä¸‹æ¥çš„å¤„ç†</div><div class="line">                // Go ahead and leave the inner loop.</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">        &#125; while (1);</div><div class="line">#else</div><div class="line"></div><div class="line">		 // ä¸ä½¿ç”¨ GCD timer ä½œä¸º timer å®ç°çš„æƒ…å†µ</div><div class="line">		 </div><div class="line">        if (kCFUseCollectableAllocator) &#123;</div><div class="line">            // objc_clear_stack(0);</div><div class="line">            // &lt;rdar://problem/16393959&gt;</div><div class="line">            </div><div class="line">            //æ¸…ç†æ¶ˆæ¯ç¼“å­˜åŒº</div><div class="line">            memset(msg_buffer, 0, sizeof(msg_buffer));</div><div class="line">        &#125;</div><div class="line">        msg = (mach_msg_header_t *)msg_buffer;</div><div class="line">        __CFRunLoopServiceMachPort(waitSet, &amp;msg, sizeof(msg_buffer), &amp;livePort, poll ? 0 : TIMEOUT_INFINITY, &amp;voucherState, &amp;voucherCopy);</div><div class="line">        </div><div class="line">#endif</div><div class="line">      </div><div class="line">      	 //è¢«å”¤é†’äº†ã€‚ã€‚ã€‚</div><div class="line">      	 </div><div class="line">        __CFRunLoopLock(rl);</div><div class="line">        __CFRunLoopModeLock(rlm);</div><div class="line"></div><div class="line">		  // è®°å½•å¢åŠ çš„ç¡çœ æ—¶é—´</div><div class="line">        rl-&gt;_sleepTime += (poll ? 0.0 : (CFAbsoluteTimeGetCurrent() - sleepStart));</div><div class="line"></div><div class="line">        // Must remove the local-to-this-activation ports in on every loop</div><div class="line">        // iteration, as this mode could be run re-entrantly and we don&apos;t</div><div class="line">        // want these ports to get serviced. Also, we don&apos;t want them left</div><div class="line">        // in there if this function returns.</div><div class="line"></div><div class="line">		 //å°†ç­‰å¾…å”¤é†’çš„ç«¯å£ä»mach portæ´»è·ƒç«¯å£åˆ—è¡¨ç§»é™¤</div><div class="line">        __CFPortSetRemove(dispatchPort, waitSet);</div><div class="line">        </div><div class="line">        //è®¾ç½®ä¸ºå¿½ç•¥å”¤é†’çŠ¶æ€</div><div class="line">        __CFRunLoopSetIgnoreWakeUps(rl);</div><div class="line"></div><div class="line">		 // å–æ¶ˆrunloopçš„ä¼‘çœ çŠ¶æ€</div><div class="line">        // user callouts now OK again</div><div class="line">	__CFRunLoopUnsetSleeping(rl);</div><div class="line">	</div><div class="line">		 // 8.é€šçŸ¥è§‚å¯Ÿè€…runloopè¢«å”¤é†’</div><div class="line">	if (!poll &amp;&amp; (rlm-&gt;_observerMask &amp; kCFRunLoopAfterWaiting)) __CFRunLoopDoObservers(rl, rlm, kCFRunLoopAfterWaiting);</div><div class="line"></div><div class="line"></div><div class="line">		 // 9.å¤„ç†é€šè¿‡ç«¯å£æ”¶åˆ°çš„æ¶ˆæ¯</div><div class="line">        handle_msg:;</div><div class="line">        __CFRunLoopSetIgnoreWakeUps(rl);</div><div class="line">		</div><div class="line">        if (MACH_PORT_NULL == livePort) &#123;</div><div class="line">        	  </div><div class="line">        	  // ä¸çŸ¥é“å“ªä¸ªç«¯å£å”¤é†’çš„ï¼ˆæˆ–è€…æ ¹æœ¬æ²¡ç¡ï¼‰ï¼Œå•¥ä¹Ÿä¸å¹²</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_NOTHING();</div><div class="line">            // handle nothing</div><div class="line">            </div><div class="line">        &#125; else if (livePort == rl-&gt;_wakeUpPort) &#123;</div><div class="line">        		</div><div class="line">        	  // è¢« CFRunLoopWakeUp å‡½æ•°å”¤é†’çš„ï¼Œå•¥ä¹Ÿä¸å¹²</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_WAKEUP();</div><div class="line">            // do nothing on Mac OS</div><div class="line">            </div><div class="line">        &#125;</div><div class="line">        </div><div class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</div><div class="line">        else if (modeQueuePort != MACH_PORT_NULL &amp;&amp; livePort == modeQueuePort) &#123;</div><div class="line">        	  </div><div class="line">        	  // è¢« timers å”¤é†’ï¼Œå¤„ç† timers</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_TIMER();</div><div class="line">            if (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) &#123;</div><div class="line">                // Re-arm the next timer, because we apparently fired early</div><div class="line">                __CFArmNextTimerInMode(rlm, rl);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">#endif</div><div class="line">#if USE_MK_TIMER_TOO</div><div class="line">        else if (rlm-&gt;_timerPort != MACH_PORT_NULL &amp;&amp; livePort == rlm-&gt;_timerPort) &#123;</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_TIMER();</div><div class="line">            // On Windows, we have observed an issue where the timer port is set before the time which we requested it to be set. For example, we set the fire time to be TSR 167646765860, but it is actually observed firing at TSR 167646764145, which is 1715 ticks early. The result is that, when __CFRunLoopDoTimers checks to see if any of the run loop timers should be firing, it appears to be &apos;too early&apos; for the next timer, and no timers are handled.</div><div class="line">            // In this case, the timer port has been automatically reset (since it was returned from MsgWaitForMultipleObjectsEx), and if we do not re-arm it, then no timers will ever be serviced again unless something adjusts the timer list (e.g. adding or removing timers). The fix for the issue is to reset the timer here if CFRunLoopDoTimers did not handle a timer itself. 9308754</div><div class="line">            </div><div class="line">            // è¢« timers å”¤é†’ï¼Œå¤„ç† timers</div><div class="line">            if (!__CFRunLoopDoTimers(rl, rlm, mach_absolute_time())) &#123;</div><div class="line">                // Re-arm the next timer</div><div class="line">                __CFArmNextTimerInMode(rlm, rl);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">#endif</div><div class="line"></div><div class="line">			//è¢«GCDå”¤é†’</div><div class="line">        else if (livePort == dispatchPort) &#123;</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_DISPATCH();</div><div class="line">            __CFRunLoopModeUnlock(rlm);</div><div class="line">            __CFRunLoopUnlock(rl);</div><div class="line">            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (void *)6, NULL);</div><div class="line">           __CFRUNLOOP_IS_SERVICING_THE_MAIN_DISPATCH_QUEUE__(msg);</div><div class="line">            _CFSetTSD(__CFTSDKeyIsInGCDMainQ, (void *)0, NULL);</div><div class="line">            __CFRunLoopLock(rl);</div><div class="line">            __CFRunLoopModeLock(rlm);</div><div class="line">            sourceHandledThisLoop = true;</div><div class="line">            didDispatchPortLastTime = true;</div><div class="line">        &#125; else &#123;</div><div class="line">        </div><div class="line">        	//ä»¥ä¸Šéƒ½ä¸æ˜¯åˆ™æ˜¯è¢«source1å”¤é†’çš„</div><div class="line">            CFRUNLOOP_WAKEUP_FOR_SOURCE();</div><div class="line">            </div><div class="line">            // If we received a voucher from this mach_msg, then put a copy of the new voucher into TSD. CFMachPortBoost will look in the TSD for the voucher. By using the value in the TSD we tie the CFMachPortBoost to this received mach_msg explicitly without a chance for anything in between the two pieces of code to set the voucher again.</div><div class="line">            voucher_t previousVoucher = _CFSetTSD(__CFTSDKeyMachMessageHasVoucher, (void *)voucherCopy, os_release);</div><div class="line"></div><div class="line">            // Despite the name, this works for windows handles as well</div><div class="line">            CFRunLoopSourceRef rls = __CFRunLoopModeFindSourceForMachPort(rl, rlm, livePort);</div><div class="line">            </div><div class="line"></div><div class="line">	        mach_msg_header_t *reply = NULL;</div><div class="line"></div><div class="line">	        //å¤„ç†source1</div><div class="line">	        sourceHandledThisLoop = __CFRunLoopDoSource1(rl, rlm, rls, msg, msg-&gt;msgh_size, &amp;reply) || sourceHandledThisLoop;</div><div class="line">	        if (NULL != reply) &#123;</div><div class="line">	            (void)mach_msg(reply, MACH_SEND_MSG, reply-&gt;msgh_size, 0, MACH_PORT_NULL, 0, MACH_PORT_NULL);</div><div class="line">	            CFAllocatorDeallocate(kCFAllocatorSystemDefault, reply);</div><div class="line">	        &#125;</div><div class="line">	            </div><div class="line">	            // Restore the previous voucher</div><div class="line">	            _CFSetTSD(__CFTSDKeyMachMessageHasVoucher, previousVoucher, os_release);</div><div class="line">            </div><div class="line">        &#125; </div><div class="line">               </div><div class="line">   // å†ä¸€æ¬¡å¤„ç† blocks</div><div class="line">	__CFRunLoopDoBlocks(rl, rlm);</div><div class="line">        </div><div class="line">	// å–„å</div><div class="line">	if (sourceHandledThisLoop &amp;&amp; stopAfterHandle) &#123;</div><div class="line">	</div><div class="line">	// å¤„ç†å®Œå½“å‰äº‹ä»¶ &amp; runloop æ‰§è¡Œå®Œå°±é€€å‡º</div><div class="line">	    retVal = kCFRunLoopRunHandledSource;</div><div class="line">	    </div><div class="line">	&#125; else if (timeout_context-&gt;termTSR &lt; mach_absolute_time()) &#123;</div><div class="line">        </div><div class="line">        // run loopè¶…æ—¶</div><div class="line">        retVal = kCFRunLoopRunTimedOut;</div><div class="line">            </div><div class="line">	&#125; else if (__CFRunLoopIsStopped(rl)) &#123;</div><div class="line">	</div><div class="line">		 // run loopè¢«æ‰‹åŠ¨ç»ˆæ­¢</div><div class="line">        __CFRunLoopUnsetStopped(rl);</div><div class="line">	    retVal = kCFRunLoopRunStopped;</div><div class="line">	    </div><div class="line">	&#125; else if (rlm-&gt;_stopped) &#123;</div><div class="line">		</div><div class="line">		// modeè¢«ç»ˆæ­¢</div><div class="line">	    rlm-&gt;_stopped = false;</div><div class="line">	    retVal = kCFRunLoopRunStopped;</div><div class="line">	    </div><div class="line">	&#125; else if (__CFRunLoopModeIsEmpty(rl, rlm, previousMode)) &#123;</div><div class="line">	</div><div class="line">		// modeä¸­çš„Itemséƒ½ä¸ºç©ºï¼Œé€€å‡ºã€‚</div><div class="line">	    retVal = kCFRunLoopRunFinished;</div><div class="line">	&#125;</div><div class="line">        </div><div class="line">    &#125; while (0 == retVal);</div><div class="line"></div><div class="line">    if (timeout_timer) &#123;</div><div class="line">        dispatch_source_cancel(timeout_timer);</div><div class="line">        dispatch_release(timeout_timer);</div><div class="line">    &#125; else &#123;</div><div class="line">        free(timeout_context);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return retVal;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//æ¥æ”¶mach portæ¶ˆæ¯</div><div class="line">static Boolean __CFRunLoopServiceMachPort(mach_port_name_t port, mach_msg_header_t **buffer, size_t buffer_size, mach_port_t *livePort, mach_msg_timeout_t timeout, voucher_mach_msg_state_t *voucherState, voucher_t *voucherCopy) &#123;</div><div class="line">    Boolean originalBuffer = true;</div><div class="line">    kern_return_t ret = KERN_SUCCESS;</div><div class="line">    for (;;) &#123;		/* In that sleep of death what nightmares may come ... */</div><div class="line">        mach_msg_header_t *msg = (mach_msg_header_t *)*buffer;</div><div class="line">        msg-&gt;msgh_bits = 0;</div><div class="line">        msg-&gt;msgh_local_port = port;</div><div class="line">        msg-&gt;msgh_remote_port = MACH_PORT_NULL;</div><div class="line">        msg-&gt;msgh_size = buffer_size;</div><div class="line">        msg-&gt;msgh_id = 0;</div><div class="line">        if (TIMEOUT_INFINITY == timeout) &#123; CFRUNLOOP_SLEEP(); &#125; else &#123; CFRUNLOOP_POLL(); &#125;</div><div class="line">        </div><div class="line">        //æ¥æ”¶æˆ–å‘é€æ¶ˆæ¯</div><div class="line">        ret = mach_msg(msg, MACH_RCV_MSG|(voucherState ? MACH_RCV_VOUCHER : 0)|MACH_RCV_LARGE|((TIMEOUT_INFINITY != timeout) ? MACH_RCV_TIMEOUT : 0)|MACH_RCV_TRAILER_TYPE(MACH_MSG_TRAILER_FORMAT_0)|MACH_RCV_TRAILER_ELEMENTS(MACH_RCV_TRAILER_AV), 0, msg-&gt;msgh_size, port, timeout, MACH_PORT_NULL);</div><div class="line"></div><div class="line">        // Take care of all voucher-related work right after mach_msg.</div><div class="line">        // If we don&apos;t release the previous voucher we&apos;re going to leak it.</div><div class="line">        voucher_mach_msg_revert(*voucherState);</div><div class="line">        </div><div class="line">        // Someone will be responsible for calling voucher_mach_msg_revert. This call makes the received voucher the current one.</div><div class="line">        *voucherState = voucher_mach_msg_adopt(msg);</div><div class="line">        </div><div class="line">        if (voucherCopy) &#123;</div><div class="line">            if (*voucherState != VOUCHER_MACH_MSG_STATE_UNCHANGED) &#123;</div><div class="line">                // Caller requested a copy of the voucher at this point. By doing this right next to mach_msg we make sure that no voucher has been set in between the return of mach_msg and the use of the voucher copy.</div><div class="line">                // CFMachPortBoost uses the voucher to drop importance explicitly. However, we want to make sure we only drop importance for a new voucher (not unchanged), so we only set the TSD when the voucher is not state_unchanged.</div><div class="line">                *voucherCopy = voucher_copy();</div><div class="line">            &#125; else &#123;</div><div class="line">                *voucherCopy = NULL;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        CFRUNLOOP_WAKEUP(ret);</div><div class="line">        </div><div class="line">        //æ¥æ”¶æ¶ˆæ¯æˆåŠŸ</div><div class="line">        if (MACH_MSG_SUCCESS == ret) &#123;</div><div class="line">            *livePort = msg ? msg-&gt;msgh_local_port : MACH_PORT_NULL;</div><div class="line">            return true;</div><div class="line">        &#125;</div><div class="line">        if (MACH_RCV_TIMED_OUT == ret) &#123;</div><div class="line">            if (!originalBuffer) free(msg);</div><div class="line">            *buffer = NULL;</div><div class="line">            *livePort = MACH_PORT_NULL;</div><div class="line">            return false;</div><div class="line">        &#125;</div><div class="line">        if (MACH_RCV_TOO_LARGE != ret) break;</div><div class="line">        buffer_size = round_msg(msg-&gt;msgh_size + MAX_TRAILER_SIZE);</div><div class="line">        if (originalBuffer) *buffer = NULL;</div><div class="line">        originalBuffer = false;</div><div class="line">        *buffer = realloc(*buffer, buffer_size);</div><div class="line">    &#125;</div><div class="line">    HALT;</div><div class="line">    return false;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="runloopè¿è¡Œæµç¨‹æ€»ç»“å…¥ä¸‹å›¾"><a href="#runloopè¿è¡Œæµç¨‹æ€»ç»“å…¥ä¸‹å›¾" class="headerlink" title="runloopè¿è¡Œæµç¨‹æ€»ç»“å…¥ä¸‹å›¾"></a>runloopè¿è¡Œæµç¨‹æ€»ç»“å…¥ä¸‹å›¾</h5><p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Runloop/runloop007.png" alt=""></p>
<p>runloopå†…éƒ¨å…¶å®å°±æ˜¯ä¸€ä¸ªdo while()çš„å¾ªç¯ã€‚åªæ˜¯åœ¨æ²¡æœ‰äº‹ä»¶éœ€è¦å¤„ç†çš„æ—¶å€™ï¼Œrunloopä¼šè°ƒç”¨<strong>__CFRunLoopSetSleeping</strong> æ–¹æ³•å°†å½“å‰çº¿ç¨‹ç½®ä¸ºç¡çœ çŠ¶æ€ï¼ŒåŒæ—¶ä¼šè°ƒç”¨ <strong>__CFRunLoopServiceMachPort</strong> æ–¹æ³•æ¥ç¡çœ çº¿ç¨‹å¹¶ç­‰å¾…æ¥æ”¶machå‘æ¥çš„å”¤é†’æ¶ˆæ¯ã€‚æ”¶åˆ°æ¶ˆæ¯åï¼Œè¯¥çº¿ç¨‹ä¼šè¢«å”¤é†’ï¼Œå”¤é†’årunloopé™¤äº†å¤„ç†å”¤é†’å®ƒçš„äº‹ä»¶ï¼Œè¿˜éœ€è¦å¤„ç†ä¸€éæ‰€æœ‰ç­‰å¾…å¤„ç†çš„äº‹ä»¶ï¼ŒåŒ…æ‹¬ï¼ˆtimer,observer,source,blockï¼‰ã€‚</p>
<h5 id="runloopå”¤é†’äº‹ä»¶æ€»ç»“"><a href="#runloopå”¤é†’äº‹ä»¶æ€»ç»“" class="headerlink" title="runloopå”¤é†’äº‹ä»¶æ€»ç»“"></a>runloopå”¤é†’äº‹ä»¶æ€»ç»“</h5><ul>
<li>mach port source</li>
<li>æ‰‹åŠ¨å”¤é†’Custom Input Sourceï¼ˆCFRunLoopSourceSignal(source)/CFRunLoopWakeUp(runloop)ï¼‰</li>
<li>dispatch_async(dispatch_get_main_queue)/dispatch_sync(dispatch_get_main_queue)(ä¸è¦åœ¨ä¸»çº¿ç¨‹åŒæ­¥ä»»åŠ¡ï¼Œä¼šæ­»é”);</li>
<li>timer</li>
</ul>
<h4 id="Modeå’Œå®ƒçš„å››å¤§å¤§ç‹-Source-Timer-Observer-Block"><a href="#Modeå’Œå®ƒçš„å››å¤§å¤§ç‹-Source-Timer-Observer-Block" class="headerlink" title="Modeå’Œå®ƒçš„å››å¤§å¤§ç‹(Source,Timer,Observer,Block)"></a>Modeå’Œå®ƒçš„å››å¤§å¤§ç‹(Source,Timer,Observer,Block)</h4><h5 id="Mode"><a href="#Mode" class="headerlink" title="Mode"></a>Mode</h5><p>Modeçš„åˆ›å»ºä¹Ÿæ˜¯æ‡’åŠ è½½</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div></pre></td><td class="code"><pre><div class="line">static CFRunLoopModeRef __CFRunLoopFindMode(CFRunLoopRef rl, CFStringRef modeName, Boolean create) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    CFRunLoopModeRef rlm;</div><div class="line">    struct __CFRunLoopMode srlm;</div><div class="line">    memset(&amp;srlm, 0, sizeof(srlm));</div><div class="line">    _CFRuntimeSetInstanceTypeIDAndIsa(&amp;srlm, __kCFRunLoopModeTypeID);</div><div class="line">    srlm._name = modeName;</div><div class="line">    rlm = (CFRunLoopModeRef)CFSetGetValue(rl-&gt;_modes, &amp;srlm);</div><div class="line">    </div><div class="line">    //modeä¸ä¸ºç©ºç›´æ¥è¿”å›ï¼Œä¸ºç©ºåˆ™åˆ›å»ºæ–°çš„</div><div class="line">    if (NULL != rlm) &#123;</div><div class="line">	__CFRunLoopModeLock(rlm);</div><div class="line">	return rlm;</div><div class="line">    &#125;</div><div class="line">    if (!create) &#123;</div><div class="line">	return NULL;</div><div class="line">    &#125;</div><div class="line">    rlm = (CFRunLoopModeRef)_CFRuntimeCreateInstance(kCFAllocatorSystemDefault, __kCFRunLoopModeTypeID, sizeof(struct __CFRunLoopMode) - sizeof(CFRuntimeBase), NULL);</div><div class="line">    if (NULL == rlm) &#123;</div><div class="line">	return NULL;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //å‚æ•°çš„åˆå§‹åŒ–</div><div class="line">    __CFRunLoopLockInit(&amp;rlm-&gt;_lock);</div><div class="line">    rlm-&gt;_name = CFStringCreateCopy(kCFAllocatorSystemDefault, modeName);</div><div class="line">    rlm-&gt;_stopped = false;</div><div class="line">    rlm-&gt;_portToV1SourceMap = NULL;</div><div class="line">    rlm-&gt;_sources0 = NULL;</div><div class="line">    rlm-&gt;_sources1 = NULL;</div><div class="line">    rlm-&gt;_observers = NULL;</div><div class="line">    rlm-&gt;_timers = NULL;</div><div class="line">    rlm-&gt;_observerMask = 0;</div><div class="line">    rlm-&gt;_portSet = __CFPortSetAllocate();</div><div class="line">    rlm-&gt;_timerSoftDeadline = UINT64_MAX;</div><div class="line">    rlm-&gt;_timerHardDeadline = UINT64_MAX;</div><div class="line">    </div><div class="line">    kern_return_t ret = KERN_SUCCESS;</div><div class="line">    </div><div class="line">    //åˆå§‹åŒ–timerç›¸å…³å†…å®¹</div><div class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</div><div class="line">    rlm-&gt;_timerFired = false;</div><div class="line">    rlm-&gt;_queue = _dispatch_runloop_root_queue_create_4CF(&quot;Run Loop Mode Queue&quot;, 0);</div><div class="line">    </div><div class="line">    //ç”¨æ¥å”¤é†’çš„ç«¯å£</div><div class="line">    mach_port_t queuePort = _dispatch_runloop_root_queue_get_port_4CF(rlm-&gt;_queue);</div><div class="line">    if (queuePort == MACH_PORT_NULL) CRASH(&quot;*** Unable to create run loop mode queue port. (%d) ***&quot;, -1);</div><div class="line">    rlm-&gt;_timerSource = dispatch_source_create(DISPATCH_SOURCE_TYPE_TIMER, 0, 0, rlm-&gt;_queue);</div><div class="line">    </div><div class="line">    __block Boolean *timerFiredPointer = &amp;(rlm-&gt;_timerFired);</div><div class="line">    dispatch_source_set_event_handler(rlm-&gt;_timerSource, ^&#123;</div><div class="line">        *timerFiredPointer = true;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">    // Set timer to far out there. The unique leeway makes this timer easy to spot in debug output.</div><div class="line">    _dispatch_source_set_runloop_timer_4CF(rlm-&gt;_timerSource, DISPATCH_TIME_FOREVER, DISPATCH_TIME_FOREVER, 321);</div><div class="line">    dispatch_resume(rlm-&gt;_timerSource);</div><div class="line">    </div><div class="line">    ret = __CFPortSetInsert(queuePort, rlm-&gt;_portSet);</div><div class="line">    if (KERN_SUCCESS != ret) CRASH(&quot;*** Unable to insert timer port into port set. (%d) ***&quot;, ret);</div><div class="line">    </div><div class="line">#endif</div><div class="line">#if USE_MK_TIMER_TOO</div><div class="line"></div><div class="line">    //ç”¨æ¥å”¤é†’çš„ç«¯å£</div><div class="line">    rlm-&gt;_timerPort = mk_timer_create();</div><div class="line">    ret = __CFPortSetInsert(rlm-&gt;_timerPort, rlm-&gt;_portSet);</div><div class="line">    if (KERN_SUCCESS != ret) CRASH(&quot;*** Unable to insert timer port into port set. (%d) ***&quot;, ret);</div><div class="line">#endif</div><div class="line">    </div><div class="line">    ret = __CFPortSetInsert(rl-&gt;_wakeUpPort, rlm-&gt;_portSet);</div><div class="line">    if (KERN_SUCCESS != ret) CRASH(&quot;*** Unable to insert wake up port into port set. (%d) ***&quot;, ret);</div><div class="line">    </div><div class="line">#if DEPLOYMENT_TARGET_WINDOWS</div><div class="line">    rlm-&gt;_msgQMask = 0;</div><div class="line">    rlm-&gt;_msgPump = NULL;</div><div class="line">#endif</div><div class="line">    CFSetAddValue(rl-&gt;_modes, rlm);</div><div class="line">    CFRelease(rlm);</div><div class="line">    __CFRunLoopModeLock(rlm);	/* return mode locked */</div><div class="line">    return rlm;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">//åˆ¤æ–­modeæ˜¯å¦ä¸ºç©º é€šè¿‡è¿™ä¸ªå‡½æ•°å¯ä»¥çœ‹åˆ°ï¼Œåªæœ‰å½“source0ã€source1ã€timerå’Œblockéƒ½ä¸ºç©ºï¼Œmodeæ‰ä¼šè¢«æ ‡è®°ä¸ºç©ºï¼ˆè¿™ä¹ˆçœ‹observeråº”è¯¥æ˜¯ä½ç­‰å±æ°‘äº†ï¼Œæ²¡æœ‰ä»€ä¹ˆå­˜åœ¨æ„Ÿï¼‰</div><div class="line"></div><div class="line">static Boolean __CFRunLoopModeIsEmpty(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFRunLoopModeRef previousMode) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    if (NULL == rlm) return true;</div><div class="line">#if DEPLOYMENT_TARGET_WINDOWS</div><div class="line">    if (0 != rlm-&gt;_msgQMask) return false;</div><div class="line">#endif</div><div class="line">    Boolean libdispatchQSafe = pthread_main_np() &amp;&amp; ((HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; NULL == previousMode) || (!HANDLE_DISPATCH_ON_BASE_INVOCATION_ONLY &amp;&amp; 0 == _CFGetTSD(__CFTSDKeyIsInGCDMainQ)));</div><div class="line">    </div><div class="line">	//ä¸»çº¿ç¨‹ä¸”å½“å‰Modeä¹Ÿåœ¨CommonModeä¸­ï¼Œä¸å¯èƒ½ä¸ºç©ºï¼Œåº”è¯¥æ˜¯ç³»ç»Ÿæœ‰å¾€CommonModeé‡Œé¢æ·»åŠ äº†ä¸œè¥¿ï¼Œä¼šè¢«åŒæ­¥åˆ°è¯¥Modeä¸­ã€‚</div><div class="line">    if (libdispatchQSafe &amp;&amp; (CFRunLoopGetMain() == rl) &amp;&amp; CFSetContainsValue(rl-&gt;_commonModes, rlm-&gt;_name)) return false; // represents the libdispatch main queue</div><div class="line">    </div><div class="line">    if (NULL != rlm-&gt;_sources0 &amp;&amp; 0 &lt; CFSetGetCount(rlm-&gt;_sources0)) return false;</div><div class="line">    if (NULL != rlm-&gt;_sources1 &amp;&amp; 0 &lt; CFSetGetCount(rlm-&gt;_sources1)) return false;</div><div class="line">    if (NULL != rlm-&gt;_timers &amp;&amp; 0 &lt; CFArrayGetCount(rlm-&gt;_timers)) return false;</div><div class="line">    struct _block_item *item = rl-&gt;_blocks_head;</div><div class="line">    while (item) &#123;</div><div class="line">        struct _block_item *curr = item;</div><div class="line">        item = item-&gt;_next;</div><div class="line">        Boolean doit = false;</div><div class="line">        if (CFStringGetTypeID() == CFGetTypeID(curr-&gt;_mode)) &#123;</div><div class="line">            doit = CFEqual(curr-&gt;_mode, rlm-&gt;_name) || (CFEqual(curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(rl-&gt;_commonModes, rlm-&gt;_name));</div><div class="line">        &#125; else &#123;</div><div class="line">            doit = CFSetContainsValue((CFSetRef)curr-&gt;_mode, rlm-&gt;_name) || (CFSetContainsValue((CFSetRef)curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(rl-&gt;_commonModes, rlm-&gt;_name));</div><div class="line">        &#125;</div><div class="line">        if (doit) return false;</div><div class="line">    &#125;</div><div class="line">    return true;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="Source"><a href="#Source" class="headerlink" title="Source"></a>Source</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div></pre></td><td class="code"><pre><div class="line">//sourceçš„åˆ›å»º</div><div class="line"></div><div class="line">CFRunLoopSourceRef CFRunLoopSourceCreate(CFAllocatorRef allocator, CFIndex order, CFRunLoopSourceContext *context) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    CFRunLoopSourceRef memory;</div><div class="line">    uint32_t size;</div><div class="line">    if (NULL == context) CRASH(&quot;*** NULL context value passed to CFRunLoopSourceCreate(). (%d) ***&quot;, -1);</div><div class="line">    </div><div class="line">    size = sizeof(struct __CFRunLoopSource) - sizeof(CFRuntimeBase);</div><div class="line">    memory = (CFRunLoopSourceRef)_CFRuntimeCreateInstance(allocator, CFRunLoopSourceGetTypeID(), size, NULL);</div><div class="line">    if (NULL == memory) &#123;</div><div class="line">	return NULL;</div><div class="line">    &#125;</div><div class="line">    __CFSetValid(memory);</div><div class="line">    __CFRunLoopSourceUnsetSignaled(memory);</div><div class="line">    __CFRunLoopLockInit(&amp;memory-&gt;_lock);</div><div class="line">    memory-&gt;_bits = 0;</div><div class="line">    memory-&gt;_order = order;</div><div class="line">    memory-&gt;_runLoops = NULL;</div><div class="line">    size = 0;</div><div class="line">    switch (context-&gt;version) &#123;</div><div class="line">    case 0:</div><div class="line">	size = sizeof(CFRunLoopSourceContext);</div><div class="line">	break;</div><div class="line">    case 1:</div><div class="line">	size = sizeof(CFRunLoopSourceContext1);</div><div class="line">	break;</div><div class="line">    &#125;</div><div class="line">    objc_memmove_collectable(&amp;memory-&gt;_context, context, size);</div><div class="line">    if (context-&gt;retain) &#123;</div><div class="line">	memory-&gt;_context.version0.info = (void *)context-&gt;retain(context-&gt;info);</div><div class="line">    &#125;</div><div class="line">    return memory;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">//ç»™modeæ·»åŠ source</div><div class="line"></div><div class="line">void CFRunLoopAddSource(CFRunLoopRef rl, CFRunLoopSourceRef rls, CFStringRef modeName) &#123;	/* DOES CALLOUT */</div><div class="line"></div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    if (__CFRunLoopIsDeallocating(rl)) return;</div><div class="line">    if (!__CFIsValid(rls)) return;</div><div class="line">    Boolean doVer0Callout = false;</div><div class="line">    __CFRunLoopLock(rl);</div><div class="line">    </div><div class="line">    //å¦‚æœæ˜¯common ç›´æ¥æ·»åŠ åˆ°_commonModeItemsæ•°ç»„</div><div class="line">    if (modeName == kCFRunLoopCommonModes) &#123;</div><div class="line">	CFSetRef set = rl-&gt;_commonModes ? CFSetCreateCopy(kCFAllocatorSystemDefault, rl-&gt;_commonModes) : NULL;</div><div class="line">	if (NULL == rl-&gt;_commonModeItems) &#123;</div><div class="line">	    rl-&gt;_commonModeItems = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</div><div class="line">	&#125;</div><div class="line">	CFSetAddValue(rl-&gt;_commonModeItems, rls);</div><div class="line">	if (NULL != set) &#123;</div><div class="line">	    CFTypeRef context[2] = &#123;rl, rls&#125;;</div><div class="line">	    /* add new item to all common-modes */</div><div class="line">	    CFSetApplyFunction(set, (__CFRunLoopAddItemToCommonModes), (void *)context);</div><div class="line">	    CFRelease(set);</div><div class="line">	&#125;</div><div class="line">    &#125; else &#123;</div><div class="line">    </div><div class="line">    //åˆ›å»ºsource0å’Œsource1çš„é›†åˆ</div><div class="line">	CFRunLoopModeRef rlm = __CFRunLoopFindMode(rl, modeName, true);</div><div class="line">	if (NULL != rlm &amp;&amp; NULL == rlm-&gt;_sources0) &#123;</div><div class="line">	    rlm-&gt;_sources0 = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</div><div class="line">	    rlm-&gt;_sources1 = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</div><div class="line">	    rlm-&gt;_portToV1SourceMap = CFDictionaryCreateMutable(kCFAllocatorSystemDefault, 0, NULL, NULL);</div><div class="line">	&#125;</div><div class="line">	if (NULL != rlm &amp;&amp; !CFSetContainsValue(rlm-&gt;_sources0, rls) &amp;&amp; !CFSetContainsValue(rlm-&gt;_sources1, rls)) &#123;</div><div class="line">	</div><div class="line">		//æŒ‰sourceç±»å‹æ·»åŠ åˆ°ä¸åŒçš„é›†åˆä¸­</div><div class="line">	    if (0 == rls-&gt;_context.version0.version) &#123;</div><div class="line">	        CFSetAddValue(rlm-&gt;_sources0, rls);</div><div class="line">	    &#125; else if (1 == rls-&gt;_context.version0.version) &#123;</div><div class="line">	        CFSetAddValue(rlm-&gt;_sources1, rls);</div><div class="line">		__CFPort src_port = rls-&gt;_context.version1.getPort(rls-&gt;_context.version1.info);</div><div class="line">		</div><div class="line">		//å¦‚æœæ˜¯source1 è¿˜éœ€è¦æŠŠsource1å¯¹åº”çš„portæ·»åŠ åˆ°mach portçš„åˆ—è¡¨ä¸­</div><div class="line">		if (CFPORT_NULL != src_port) &#123;</div><div class="line">		    CFDictionarySetValue(rlm-&gt;_portToV1SourceMap, (const void *)(uintptr_t)src_port, rls);</div><div class="line">		    __CFPortSetInsert(src_port, rlm-&gt;_portSet);</div><div class="line">	        &#125;</div><div class="line">	    &#125;</div><div class="line">	    __CFRunLoopSourceLock(rls);</div><div class="line">	    if (NULL == rls-&gt;_runLoops) &#123;</div><div class="line">	        rls-&gt;_runLoops = CFBagCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeBagCallBacks); // sources retain run loops!</div><div class="line">	    &#125;</div><div class="line">	    CFBagAddValue(rls-&gt;_runLoops, rl);</div><div class="line">	    __CFRunLoopSourceUnlock(rls);</div><div class="line">	    if (0 == rls-&gt;_context.version0.version) &#123;</div><div class="line">	        if (NULL != rls-&gt;_context.version0.schedule) &#123;</div><div class="line">	            doVer0Callout = true;</div><div class="line">	        &#125;</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">        if (NULL != rlm) &#123;</div><div class="line">	    __CFRunLoopModeUnlock(rlm);</div><div class="line">	&#125;</div><div class="line">    &#125;</div><div class="line">    __CFRunLoopUnlock(rl);</div><div class="line">    if (doVer0Callout) &#123;</div><div class="line">        // although it looses some protection for the source, we have no choice but</div><div class="line">        // to do this after unlocking the run loop and mode locks, to avoid deadlocks</div><div class="line">        // where the source wants to take a lock which is already held in another</div><div class="line">        // thread which is itself waiting for a run loop/mode lock</div><div class="line">	rls-&gt;_context.version0.schedule(rls-&gt;_context.version0.info, rl, modeName);	/* CALLOUT */</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//å¤„ç†source0</div><div class="line">static Boolean __CFRunLoopDoSources0(CFRunLoopRef rl, CFRunLoopModeRef rlm, Boolean stopAfterHandle) &#123;	/* DOES CALLOUT */</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    CFTypeRef sources = NULL;</div><div class="line">    Boolean sourceHandled = false;</div><div class="line"></div><div class="line">    /* Fire the version 0 sources */</div><div class="line">    </div><div class="line">    //è·å–å½“å‰modeçš„source0é›†åˆ</div><div class="line">    if (NULL != rlm-&gt;_sources0 &amp;&amp; 0 &lt; CFSetGetCount(rlm-&gt;_sources0)) &#123;</div><div class="line">	CFSetApplyFunction(rlm-&gt;_sources0, (__CFRunLoopCollectSources0), &amp;sources);</div><div class="line">    &#125;</div><div class="line">    if (NULL != sources) &#123;</div><div class="line">	__CFRunLoopModeUnlock(rlm);</div><div class="line">	__CFRunLoopUnlock(rl);</div><div class="line">	// sources is either a single (retained) CFRunLoopSourceRef or an array of (retained) CFRunLoopSourceRef</div><div class="line">	</div><div class="line">	//å¦‚æœæ˜¯å•ä¸ªäº‹ä»¶</div><div class="line">	if (CFGetTypeID(sources) == CFRunLoopSourceGetTypeID()) &#123;</div><div class="line">	    CFRunLoopSourceRef rls = (CFRunLoopSourceRef)sources;</div><div class="line">	    __CFRunLoopSourceLock(rls);</div><div class="line">	    </div><div class="line">	    //è¿™é‡Œåœ¨å¤„ç†å®Œè¿™ä¸ªsourceä¹‹åï¼Œä¼šæŠŠè¿™ä¸ªsourceæ ‡è®°ä¸ºä¸å†å¤„ç†ï¼ï¼ï¼ï¼åé¢demoé‡Œæœ‰åº”ç”¨ã€‚</div><div class="line">            if (__CFRunLoopSourceIsSignaled(rls)) &#123;</div><div class="line">	        __CFRunLoopSourceUnsetSignaled(rls);</div><div class="line">	        if (__CFIsValid(rls)) &#123;</div><div class="line">	            __CFRunLoopSourceUnlock(rls);</div><div class="line"></div><div class="line">                    //è°ƒç”¨source0å¯¹åº”çš„å›è°ƒ</div><div class="line">                    __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__(rls-&gt;_context.version0.perform, rls-&gt;_context.version0.info);</div><div class="line">	            CHECK_FOR_FORK();</div><div class="line">	            sourceHandled = true;</div><div class="line">	        &#125; else &#123;</div><div class="line">	            __CFRunLoopSourceUnlock(rls);</div><div class="line">	        &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                __CFRunLoopSourceUnlock(rls);</div><div class="line">            &#125;</div><div class="line">	&#125; else &#123;</div><div class="line">	</div><div class="line">	//å¦‚æœæ˜¯ä¸€ä¸ªäº‹ä»¶åˆ—è¡¨</div><div class="line">	    CFIndex cnt = CFArrayGetCount((CFArrayRef)sources);</div><div class="line">	    CFArraySortValues((CFMutableArrayRef)sources, CFRangeMake(0, cnt), (__CFRunLoopSourceComparator), NULL);</div><div class="line">	    for (CFIndex idx = 0; idx &lt; cnt; idx++) &#123;</div><div class="line">		CFRunLoopSourceRef rls = (CFRunLoopSourceRef)CFArrayGetValueAtIndex((CFArrayRef)sources, idx);</div><div class="line">		__CFRunLoopSourceLock(rls);</div><div class="line">                if (__CFRunLoopSourceIsSignaled(rls)) &#123;</div><div class="line">		    __CFRunLoopSourceUnsetSignaled(rls);</div><div class="line">		    if (__CFIsValid(rls)) &#123;</div><div class="line">		        __CFRunLoopSourceUnlock(rls);</div><div class="line">                        </div><div class="line">                        //è°ƒç”¨source0å¯¹åº”çš„å›è°ƒ                       __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE0_PERFORM_FUNCTION__(rls-&gt;_context.version0.perform, rls-&gt;_context.version0.info);</div><div class="line">		        CHECK_FOR_FORK();</div><div class="line">		        sourceHandled = true;</div><div class="line">		    &#125; else &#123;</div><div class="line">		        __CFRunLoopSourceUnlock(rls);</div><div class="line">		    &#125;</div><div class="line">                &#125; else &#123;</div><div class="line">                    __CFRunLoopSourceUnlock(rls);</div><div class="line">                &#125;</div><div class="line">		if (stopAfterHandle &amp;&amp; sourceHandled) &#123;</div><div class="line">		    break;</div><div class="line">		&#125;</div><div class="line">	    &#125;</div><div class="line">	&#125;</div><div class="line">	CFRelease(sources);</div><div class="line">	__CFRunLoopLock(rl);</div><div class="line">	__CFRunLoopModeLock(rlm);</div><div class="line">    &#125;</div><div class="line">    return sourceHandled;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">//å¤„ç†source1</div><div class="line">static Boolean __CFRunLoopDoSource1(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFRunLoopSourceRef rls</div><div class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</div><div class="line">                                    , mach_msg_header_t *msg, CFIndex size, mach_msg_header_t **reply</div><div class="line">#endif</div><div class="line">                                    ) &#123;	/* DOES CALLOUT */</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    Boolean sourceHandled = false;</div><div class="line"></div><div class="line">    /* Fire a version 1 source */</div><div class="line">    CFRetain(rls);</div><div class="line">    __CFRunLoopModeUnlock(rlm);</div><div class="line">    __CFRunLoopUnlock(rl);</div><div class="line">    __CFRunLoopSourceLock(rls);</div><div class="line">    if (__CFIsValid(rls)) &#123;</div><div class="line">	__CFRunLoopSourceUnsetSignaled(rls);</div><div class="line">	__CFRunLoopSourceUnlock(rls);</div><div class="line">        __CFRunLoopDebugInfoForRunLoopSource(rls);</div><div class="line">        </div><div class="line">        //è°ƒç”¨source1å¯¹åº”çš„å›è°ƒ</div><div class="line">        __CFRUNLOOP_IS_CALLING_OUT_TO_A_SOURCE1_PERFORM_FUNCTION__(rls-&gt;_context.version1.perform,</div><div class="line">#if DEPLOYMENT_TARGET_MACOSX || DEPLOYMENT_TARGET_EMBEDDED || DEPLOYMENT_TARGET_EMBEDDED_MINI</div><div class="line">            msg, size, reply,</div><div class="line">#endif</div><div class="line">            rls-&gt;_context.version1.info);</div><div class="line">	CHECK_FOR_FORK();</div><div class="line">	sourceHandled = true;</div><div class="line">    &#125; else &#123;</div><div class="line">        if (_LogCFRunLoop) &#123; CFLog(kCFLogLevelDebug, CFSTR(&quot;%p (%s) __CFRunLoopDoSource1 rls %p is invalid&quot;), CFRunLoopGetCurrent(), *_CFGetProgname(), rls); &#125;</div><div class="line">	__CFRunLoopSourceUnlock(rls);</div><div class="line">    &#125;</div><div class="line">    CFRelease(rls);</div><div class="line">    __CFRunLoopLock(rl);</div><div class="line">    __CFRunLoopModeLock(rlm);</div><div class="line">    return sourceHandled;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="sourceæ€»ç»“"><a href="#sourceæ€»ç»“" class="headerlink" title="sourceæ€»ç»“"></a>sourceæ€»ç»“</h5><p>é€šè¿‡å¯¹æ¯”source0å’Œsource1çš„å¤„ç†å‡½æ•°å‘ç°ï¼Œsource0æœ‰2ç§æƒ…å†µï¼Œå•ä¸ªäº‹ä»¶å’Œäº‹ä»¶åˆ—è¡¨ï¼Œè€Œsource1åªæœ‰å•ä¸ªäº‹ä»¶çš„å¤„ç†ï¼Œä¸ªäººç†è§£æ˜¯å› ä¸ºsource1çš„äº‹ä»¶æ˜¯å³æ—¶å¤„ç†çš„ï¼Œå› ä¸ºsource1å¯ä»¥å”¤é†’runloop,åªè¦æœ‰source1äº‹ä»¶runloopå°±ä¼šå»å¤„ç†ï¼Œæ‰€æœ‰ä¸å­˜åœ¨å¤„ç†äº‹ä»¶åˆ—è¡¨çš„æƒ…å†µï¼Œè€Œsource0æœ‰å¯èƒ½åªæ˜¯æ ‡è®°ä¸ºå¾…å¤„ç†è€Œæ²¡æœ‰æ‰‹åŠ¨å”¤é†’runloop,å½“æ ‡è®°ä¸ºå¾…å¤„ç†source0äº‹ä»¶åï¼Œåªä¼šè¢«æ·»åŠ åˆ°modeçš„source0é›†åˆä¸­ï¼Œåœ¨runloopè¢«å”¤é†’åç»Ÿä¸€å¤„ç†ã€‚</p>
<h5 id="Timer"><a href="#Timer" class="headerlink" title="Timer"></a>Timer</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div><div class="line">408</div><div class="line">409</div><div class="line">410</div><div class="line">411</div><div class="line">412</div><div class="line">413</div><div class="line">414</div><div class="line">415</div><div class="line">416</div><div class="line">417</div><div class="line">418</div><div class="line">419</div><div class="line">420</div><div class="line">421</div><div class="line">422</div><div class="line">423</div><div class="line">424</div><div class="line">425</div><div class="line">426</div><div class="line">427</div><div class="line">428</div><div class="line">429</div><div class="line">430</div><div class="line">431</div><div class="line">432</div><div class="line">433</div><div class="line">434</div><div class="line">435</div><div class="line">436</div><div class="line">437</div><div class="line">438</div><div class="line">439</div><div class="line">440</div><div class="line">441</div><div class="line">442</div><div class="line">443</div><div class="line">444</div><div class="line">445</div><div class="line">446</div><div class="line">447</div><div class="line">448</div><div class="line">449</div><div class="line">450</div><div class="line">451</div><div class="line">452</div><div class="line">453</div><div class="line">454</div><div class="line">455</div><div class="line">456</div><div class="line">457</div><div class="line">458</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">CFRunLoopTimerRef CFRunLoopTimerCreate(CFAllocatorRef allocator, CFAbsoluteTime fireDate, CFTimeInterval interval, CFOptionFlags flags, CFIndex order, CFRunLoopTimerCallBack callout, CFRunLoopTimerContext *context) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    if (isnan(interval)) &#123;</div><div class="line">        CRSetCrashLogMessage(&quot;NaN was used as an interval for a CFRunLoopTimer&quot;);</div><div class="line">        HALT;</div><div class="line">    &#125;</div><div class="line">    CFRunLoopTimerRef memory;</div><div class="line">    UInt32 size;</div><div class="line">    size = sizeof(struct __CFRunLoopTimer) - sizeof(CFRuntimeBase);</div><div class="line">    memory = (CFRunLoopTimerRef)_CFRuntimeCreateInstance(allocator, CFRunLoopTimerGetTypeID(), size, NULL);</div><div class="line">    if (NULL == memory) &#123;</div><div class="line">	return NULL;</div><div class="line">    &#125;</div><div class="line">    __CFSetValid(memory);</div><div class="line">    __CFRunLoopTimerUnsetFiring(memory);</div><div class="line">    __CFRunLoopLockInit(&amp;memory-&gt;_lock);</div><div class="line">    memory-&gt;_runLoop = NULL;</div><div class="line">    memory-&gt;_rlModes = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</div><div class="line">    memory-&gt;_order = order;</div><div class="line">    if (interval &lt; 0.0) interval = 0.0;</div><div class="line">    memory-&gt;_interval = interval;</div><div class="line">    memory-&gt;_tolerance = 0.0;</div><div class="line">    </div><div class="line">    //fireDate é¦–æ¬¡è§¦å‘çš„ç»å¯¹æ—¶é—´</div><div class="line">    if (TIMER_DATE_LIMIT &lt; fireDate) fireDate = TIMER_DATE_LIMIT;</div><div class="line">    memory-&gt;_nextFireDate = fireDate;</div><div class="line">    memory-&gt;_fireTSR = 0ULL;</div><div class="line">    </div><div class="line">    //è·å–machå†…æ ¸å’ŒCFå†…æ ¸çš„ç»å¯¹æ—¶é—´</div><div class="line">    uint64_t now2 = mach_absolute_time();</div><div class="line">    CFAbsoluteTime now1 = CFAbsoluteTimeGetCurrent();</div><div class="line">    </div><div class="line">    //_fireTSRä¸ºæœ¬æ¬¡åº”è§¦å‘çš„ç»å¯¹æ—¶é—´ç‚¹</div><div class="line">    if (fireDate &lt; now1) &#123;</div><div class="line">		memory-&gt;_fireTSR = now2;</div><div class="line">    &#125; else if (TIMER_INTERVAL_LIMIT &lt; fireDate - now1) &#123;</div><div class="line">		memory-&gt;_fireTSR = now2 + __CFTimeIntervalToTSR(TIMER_INTERVAL_LIMIT);</div><div class="line">    &#125; else &#123;</div><div class="line">		memory-&gt;_fireTSR = now2 + __CFTimeIntervalToTSR(fireDate - now1);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    memory-&gt;_callout = callout;</div><div class="line">    if (NULL != context) &#123;</div><div class="line">	if (context-&gt;retain) &#123;</div><div class="line">	    memory-&gt;_context.info = (void *)context-&gt;retain(context-&gt;info);</div><div class="line">	&#125; else &#123;</div><div class="line">	    memory-&gt;_context.info = context-&gt;info;</div><div class="line">	&#125;</div><div class="line">	memory-&gt;_context.retain = context-&gt;retain;</div><div class="line">	memory-&gt;_context.release = context-&gt;release;</div><div class="line">	memory-&gt;_context.copyDescription = context-&gt;copyDescription;</div><div class="line">    &#125; else &#123;</div><div class="line">	memory-&gt;_context.info = 0;</div><div class="line">	memory-&gt;_context.retain = 0;</div><div class="line">	memory-&gt;_context.release = 0;</div><div class="line">	memory-&gt;_context.copyDescription = 0;</div><div class="line">    &#125;</div><div class="line">    return memory;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">void CFRunLoopAddTimer(CFRunLoopRef rl, CFRunLoopTimerRef rlt, CFStringRef modeName) &#123;    </div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    if (__CFRunLoopIsDeallocating(rl)) return;</div><div class="line">    if (!__CFIsValid(rlt) || (NULL != rlt-&gt;_runLoop &amp;&amp; rlt-&gt;_runLoop != rl)) return;</div><div class="line">    __CFRunLoopLock(rl);</div><div class="line">    </div><div class="line">    //å¦‚æœæ˜¯common modeç›´æ¥åŠ åˆ°_commonModeItems</div><div class="line">    if (modeName == kCFRunLoopCommonModes) &#123;</div><div class="line">	CFSetRef set = rl-&gt;_commonModes ? CFSetCreateCopy(kCFAllocatorSystemDefault, rl-&gt;_commonModes) : NULL;</div><div class="line">	if (NULL == rl-&gt;_commonModeItems) &#123;</div><div class="line">	    rl-&gt;_commonModeItems = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</div><div class="line">	&#125;</div><div class="line">	CFSetAddValue(rl-&gt;_commonModeItems, rlt);</div><div class="line">	if (NULL != set) &#123;</div><div class="line">	    CFTypeRef context[2] = &#123;rl, rlt&#125;;</div><div class="line">	    /* add new item to all common-modes */</div><div class="line">	    CFSetApplyFunction(set, (__CFRunLoopAddItemToCommonModes), (void *)context);</div><div class="line">	    CFRelease(set);</div><div class="line">	&#125;</div><div class="line">    &#125; else &#123;</div><div class="line">    </div><div class="line">    //åˆ›å»ºtimersçš„æ•°ç»„</div><div class="line">	CFRunLoopModeRef rlm = __CFRunLoopFindMode(rl, modeName, true);</div><div class="line">	if (NULL != rlm) &#123;</div><div class="line">            if (NULL == rlm-&gt;_timers) &#123;</div><div class="line">                CFArrayCallBacks cb = kCFTypeArrayCallBacks;</div><div class="line">                cb.equal = NULL;</div><div class="line">                rlm-&gt;_timers = CFArrayCreateMutable(kCFAllocatorSystemDefault, 0, &amp;cb);</div><div class="line">            &#125;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	//åˆ¤æ–­timeræ˜¯å¦è¢«æ·»åŠ åˆ°å½“å‰mode</div><div class="line">	if (NULL != rlm &amp;&amp; !CFSetContainsValue(rlt-&gt;_rlModes, rlm-&gt;_name)) &#123;</div><div class="line">            __CFRunLoopTimerLock(rlt);</div><div class="line">            if (NULL == rlt-&gt;_runLoop) &#123;</div><div class="line">		rlt-&gt;_runLoop = rl;</div><div class="line">  	    &#125; else if (rl != rlt-&gt;_runLoop) &#123;</div><div class="line">                __CFRunLoopTimerUnlock(rlt);</div><div class="line">	        __CFRunLoopModeUnlock(rlm);</div><div class="line">                __CFRunLoopUnlock(rl);</div><div class="line">		return;</div><div class="line">	    &#125;</div><div class="line">	    </div><div class="line">	    //timerå°†å½“å‰modeæ ‡è®°ä¸ºå·²æ·»åŠ </div><div class="line">  	    CFSetAddValue(rlt-&gt;_rlModes, rlm-&gt;_name);</div><div class="line">            __CFRunLoopTimerUnlock(rlt);</div><div class="line">            __CFRunLoopTimerFireTSRLock();</div><div class="line">            </div><div class="line">            //æ·»åŠ timeråˆ°mode</div><div class="line">            __CFRepositionTimerInMode(rlm, rlt, false);</div><div class="line">            __CFRunLoopTimerFireTSRUnlock();</div><div class="line">            if (!_CFExecutableLinkedOnOrAfter(CFSystemVersionLion)) &#123;</div><div class="line">                // Normally we don&apos;t do this on behalf of clients, but for</div><div class="line">                // backwards compatibility due to the change in timer handling...</div><div class="line">                if (rl != CFRunLoopGetCurrent()) CFRunLoopWakeUp(rl);</div><div class="line">            &#125;</div><div class="line">	&#125;</div><div class="line">        if (NULL != rlm) &#123;</div><div class="line">	    __CFRunLoopModeUnlock(rlm);</div><div class="line">	&#125;</div><div class="line">    &#125;</div><div class="line">    __CFRunLoopUnlock(rl);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//é‡æ–°æ’åˆ—è¿™ä¸ªmodeä¸­çš„æ‰€æœ‰timerè§¦å‘æ—¶åˆ»</div><div class="line">static void __CFRepositionTimerInMode(CFRunLoopModeRef rlm, CFRunLoopTimerRef rlt, Boolean isInArray) &#123;</div><div class="line">    if (!rlt) return;</div><div class="line">    CFMutableArrayRef timerArray = rlm-&gt;_timers;</div><div class="line">    if (!timerArray) return;</div><div class="line">    Boolean found = false;</div><div class="line">    // If we know in advance that the timer is not in the array (just being added now) then we can skip this search</div><div class="line">    if (isInArray) &#123;</div><div class="line">        CFIndex idx = CFArrayGetFirstIndexOfValue(timerArray, CFRangeMake(0, CFArrayGetCount(timerArray)), rlt);</div><div class="line">        if (kCFNotFound != idx) &#123;</div><div class="line">            CFRetain(rlt);</div><div class="line">            CFArrayRemoveValueAtIndex(timerArray, idx);</div><div class="line">            found = true;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    if (!found &amp;&amp; isInArray) return;</div><div class="line">    CFIndex newIdx = __CFRunLoopInsertionIndexInTimerArray(timerArray, rlt);</div><div class="line">    CFArrayInsertValueAtIndex(timerArray, newIdx, rlt);</div><div class="line">    __CFArmNextTimerInMode(rlm, rlt-&gt;_runLoop);</div><div class="line">    if (isInArray) CFRelease(rlt);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//è¿”å›timeréœ€è¦æ’å…¥çš„ç´¢å¼•</div><div class="line">static CFIndex __CFRunLoopInsertionIndexInTimerArray(CFArrayRef array, CFRunLoopTimerRef rlt) &#123;</div><div class="line">    CFIndex cnt = CFArrayGetCount(array);</div><div class="line">    if (cnt &lt;= 0) &#123;</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //timerå¤§äº256 å¦‚æœæœ€åä¸€ä¸ªitemçš„fireTSRå°äºå¾…æ’å…¥çš„timerï¼Œç›´æ¥æ’å…¥åˆ°æœ€åä¸€ä¸ªä½ç½®å¦åˆ™å¦‚æœç¬¬ä¸€ä¸ªitemçš„fireTSRå¤§äºå¸¦æ’å…¥çš„timer,ç›´æ¥æ’å…¥ç¬¬ä¸€ä¸ªä½ç½®ã€‚</div><div class="line">    if (256 &lt; cnt) &#123;</div><div class="line">        CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, cnt - 1);</div><div class="line">        if (item-&gt;_fireTSR &lt;= rlt-&gt;_fireTSR) &#123;</div><div class="line">            return cnt;</div><div class="line">        &#125;</div><div class="line">        item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, 0);</div><div class="line">        if (rlt-&gt;_fireTSR &lt; item-&gt;_fireTSR) &#123;</div><div class="line">            return 0;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">	//äºŒåˆ†æŸ¥æ‰¾ä¸€ä¸ªåˆé€‚çš„ä½ç½®ã€‚</div><div class="line">    CFIndex add = (1 &lt;&lt; flsl(cnt)) * 2;</div><div class="line">    CFIndex idx = 0;</div><div class="line">    Boolean lastTestLEQ;</div><div class="line">    do &#123;</div><div class="line">        add = add / 2;</div><div class="line">	lastTestLEQ = false;</div><div class="line">        CFIndex testIdx = idx + add;</div><div class="line">        if (testIdx &lt; cnt) &#123;</div><div class="line">            CFRunLoopTimerRef item = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(array, testIdx);</div><div class="line">            if (item-&gt;_fireTSR &lt;= rlt-&gt;_fireTSR) &#123;</div><div class="line">                idx = testIdx;</div><div class="line">		lastTestLEQ = true;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; while (0 &lt; add);</div><div class="line"></div><div class="line">    return lastTestLEQ ? idx + 1 : idx;</div><div class="line">&#125;</div><div class="line"></div><div class="line">static void __CFArmNextTimerInMode(CFRunLoopModeRef rlm, CFRunLoopRef rl) &#123;  </div><div class="line">  </div><div class="line">    uint64_t nextHardDeadline = UINT64_MAX;//æœ€æ™šçš„æ—¶é—´ç‚¹</div><div class="line">    uint64_t nextSoftDeadline = UINT64_MAX;//åº”è¯¥è§¦å‘çš„æ—¶é—´ç‚¹</div><div class="line"></div><div class="line">    if (rlm-&gt;_timers) &#123;</div><div class="line">        // Look at the list of timers. We will calculate two TSR values; the next soft and next hard deadline.</div><div class="line">        // The next soft deadline is the first time we can fire any timer. This is the fire date of the first timer in our sorted list of timers.</div><div class="line">        // The next hard deadline is the last time at which we can fire the timer before we&apos;ve moved out of the allowable tolerance of the timers in our list.</div><div class="line">        for (CFIndex idx = 0, cnt = CFArrayGetCount(rlm-&gt;_timers); idx &lt; cnt; idx++) &#123;</div><div class="line">            CFRunLoopTimerRef t = (CFRunLoopTimerRef)CFArrayGetValueAtIndex(rlm-&gt;_timers , idx);</div><div class="line">            // discount timers currently firing</div><div class="line">            if (__CFRunLoopTimerIsFiring(t)) continue;</div><div class="line">            </div><div class="line">            int32_t err = CHECKINT_NO_ERROR;</div><div class="line">            </div><div class="line">            //SoftDeadlineæ˜¯ç†åº”è§¦å‘çš„æ—¶é—´</div><div class="line">            uint64_t oneTimerSoftDeadline = t-&gt;_fireTSR;</div><div class="line">            </div><div class="line">            //HardDeadlineæ˜¯ç†åº”è§¦å‘çš„æ—¶é—´åŠ ä¸Štoleranceï¼ˆå³æœ€æ™šè§¦å‘æ—¶é—´ï¼‰</div><div class="line">            uint64_t oneTimerHardDeadline = check_uint64_add(t-&gt;_fireTSR, __CFTimeIntervalToTSR(t-&gt;_tolerance), &amp;err);</div><div class="line">            </div><div class="line">            if (err != CHECKINT_NO_ERROR) oneTimerHardDeadline = UINT64_MAX;</div><div class="line">            </div><div class="line">            // We can stop searching if the soft deadline for this timer exceeds the current hard deadline. Otherwise, later timers with lower tolerance could still have earlier hard deadlines.</div><div class="line">            </div><div class="line">            //é€šè¿‡è¿™å‡ è¡Œä»£ç å¯¹deadlineè¿›è¡Œä¿®æ­£ï¼Œä¿è¯å‰è¾¹çš„é•¿toleranceçš„timerä¸ä¼šå½±å“åé¢çš„timerçš„è§¦å‘</div><div class="line">            </div><div class="line">            //åº”è§¦å‘çš„æ—¶é—´ç‚¹ &gt; ä¸‹æ¬¡æœ€æ™šè§¦å‘æ—¶é—´ç‚¹ ç›´æ¥é€€å‡º</div><div class="line">            if (oneTimerSoftDeadline &gt; nextHardDeadline) &#123;</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            //åº”è§¦å‘çš„æ—¶é—´ç‚¹ &lt; ä¸‹æ¬¡æœ€æ™šè§¦å‘æ—¶é—´ç‚¹ </div><div class="line">            if (oneTimerSoftDeadline &lt; nextSoftDeadline) &#123;</div><div class="line">                nextSoftDeadline = oneTimerSoftDeadline;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            //æœ€æ™šè§¦å‘æ—¶é—´ç‚¹ &lt; ä¸‹æ¬¡æœ€æ™šè§¦å‘æ—¶é—´ç‚¹</div><div class="line">            if (oneTimerHardDeadline &lt; nextHardDeadline) &#123;</div><div class="line">                nextHardDeadline = oneTimerHardDeadline;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        if (nextSoftDeadline &lt; UINT64_MAX &amp;&amp; (nextHardDeadline != rlm-&gt;_timerHardDeadline || nextSoftDeadline != rlm-&gt;_timerSoftDeadline)) &#123;</div><div class="line">            if (CFRUNLOOP_NEXT_TIMER_ARMED_ENABLED()) &#123;</div><div class="line">                CFRUNLOOP_NEXT_TIMER_ARMED((unsigned long)(nextSoftDeadline - mach_absolute_time()));</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</div><div class="line"></div><div class="line">            // We&apos;re going to hand off the range of allowable timer fire date to dispatch and let it fire when appropriate for the system.</div><div class="line">            uint64_t leeway = __CFTSRToNanoseconds(nextHardDeadline - nextSoftDeadline);</div><div class="line">            dispatch_time_t deadline = __CFTSRToDispatchTime(nextSoftDeadline);</div><div class="line">            </div><div class="line">#if USE_MK_TIMER_TOO</div><div class="line"></div><div class="line">				//å¯¹äºæœ‰leewayçš„æƒ…å†µï¼ˆæœ‰toleranceçš„æƒ…å†µï¼‰ï¼Œåªé‡‡ç”¨_dispatch_source_set_runloop_timer_4CFçš„æ–¹æ³•</div><div class="line">            if (leeway &gt; 0) &#123;</div><div class="line">                // Only use the dispatch timer if we have any leeway</div><div class="line">                // &lt;rdar://problem/14447675&gt;</div><div class="line">                </div><div class="line">                // Cancel the mk timer</div><div class="line">                if (rlm-&gt;_mkTimerArmed &amp;&amp; rlm-&gt;_timerPort) &#123;</div><div class="line">                    AbsoluteTime dummy;</div><div class="line">                    mk_timer_cancel(rlm-&gt;_timerPort, &amp;dummy);</div><div class="line">                    rlm-&gt;_mkTimerArmed = false;</div><div class="line">                &#125;</div><div class="line">                </div><div class="line">                // Arm the dispatch timer</div><div class="line">                _dispatch_source_set_runloop_timer_4CF(rlm-&gt;_timerSource, deadline, DISPATCH_TIME_FOREVER, leeway);</div><div class="line">                rlm-&gt;_dispatchTimerArmed = true;</div><div class="line">            &#125; else &#123;</div><div class="line">            </div><div class="line">            // å¯¹äºleewayä¸º0çš„æƒ…å†µï¼ˆæ— toleranceçš„æƒ…å†µï¼‰,é‡‡ç”¨mk_timerçš„æ–¹å¼</div><div class="line">                // Cancel the dispatch timer</div><div class="line">                if (rlm-&gt;_dispatchTimerArmed) &#123;</div><div class="line">                    // Cancel the dispatch timer</div><div class="line">                    _dispatch_source_set_runloop_timer_4CF(rlm-&gt;_timerSource, DISPATCH_TIME_FOREVER, DISPATCH_TIME_FOREVER, 888);</div><div class="line">                    rlm-&gt;_dispatchTimerArmed = false;</div><div class="line">                &#125;</div><div class="line">                </div><div class="line">                // Arm the mk timer</div><div class="line">                if (rlm-&gt;_timerPort) &#123;</div><div class="line">                    mk_timer_arm(rlm-&gt;_timerPort, __CFUInt64ToAbsoluteTime(nextSoftDeadline));</div><div class="line">                    rlm-&gt;_mkTimerArmed = true;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">#else</div><div class="line">            _dispatch_source_set_runloop_timer_4CF(rlm-&gt;_timerSource, deadline, DISPATCH_TIME_FOREVER, leeway);</div><div class="line">#endif</div><div class="line">#else</div><div class="line">            if (rlm-&gt;_timerPort) &#123;</div><div class="line">                mk_timer_arm(rlm-&gt;_timerPort, __CFUInt64ToAbsoluteTime(nextSoftDeadline));</div><div class="line">            &#125;</div><div class="line">#endif</div><div class="line">        &#125; else if (nextSoftDeadline == UINT64_MAX) &#123;</div><div class="line">            // Disarm the timers - there is no timer scheduled</div><div class="line">            // ç§»é™¤timer</div><div class="line">            if (rlm-&gt;_mkTimerArmed &amp;&amp; rlm-&gt;_timerPort) &#123;</div><div class="line">                AbsoluteTime dummy;</div><div class="line">                mk_timer_cancel(rlm-&gt;_timerPort, &amp;dummy);</div><div class="line">                rlm-&gt;_mkTimerArmed = false;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">#if USE_DISPATCH_SOURCE_FOR_TIMERS</div><div class="line">            if (rlm-&gt;_dispatchTimerArmed) &#123;</div><div class="line">                _dispatch_source_set_runloop_timer_4CF(rlm-&gt;_timerSource, DISPATCH_TIME_FOREVER, DISPATCH_TIME_FOREVER, 333);</div><div class="line">                rlm-&gt;_dispatchTimerArmed = false;</div><div class="line">            &#125;</div><div class="line">#endif</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    rlm-&gt;_timerHardDeadline = nextHardDeadline;</div><div class="line">    rlm-&gt;_timerSoftDeadline = nextSoftDeadline;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">//å¤„ç†timer</div><div class="line">// mode and rl are locked on entry and exit</div><div class="line">static Boolean __CFRunLoopDoTimer(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFRunLoopTimerRef rlt) &#123;	/* DOES CALLOUT */</div><div class="line">    Boolean timerHandled = false;</div><div class="line">    uint64_t oldFireTSR = 0;</div><div class="line"></div><div class="line">    /* Fire a timer */</div><div class="line">    CFRetain(rlt);</div><div class="line">    __CFRunLoopTimerLock(rlt);</div><div class="line">	</div><div class="line">	//ä¸€å †åˆ¤æ–­æ¡ä»¶</div><div class="line">    if (__CFIsValid(rlt) &amp;&amp; rlt-&gt;_fireTSR &lt;= mach_absolute_time() &amp;&amp; !__CFRunLoopTimerIsFiring(rlt) &amp;&amp; rlt-&gt;_runLoop == rl) &#123;</div><div class="line">        void *context_info = NULL;</div><div class="line">        void (*context_release)(const void *) = NULL;</div><div class="line">        if (rlt-&gt;_context.retain) &#123;</div><div class="line">            context_info = (void *)rlt-&gt;_context.retain(rlt-&gt;_context.info);</div><div class="line">            context_release = rlt-&gt;_context.release;</div><div class="line">        &#125; else &#123;</div><div class="line">            context_info = rlt-&gt;_context.info;</div><div class="line">        &#125;</div><div class="line">        Boolean doInvalidate = (0.0 == rlt-&gt;_interval);</div><div class="line">	__CFRunLoopTimerSetFiring(rlt);</div><div class="line">        // Just in case the next timer has exactly the same deadlines as this one, we reset these values so that the arm next timer code can correctly find the next timer in the list and arm the underlying timer.</div><div class="line">        </div><div class="line">        //é‡ç½®åº”è§¦å‘æ—¶é—´å’Œæœ€æ™šè§¦å‘æ—¶é—´</div><div class="line">        rlm-&gt;_timerSoftDeadline = UINT64_MAX;</div><div class="line">        rlm-&gt;_timerHardDeadline = UINT64_MAX;</div><div class="line">        __CFRunLoopTimerUnlock(rlt);</div><div class="line">	__CFRunLoopTimerFireTSRLock();</div><div class="line">	oldFireTSR = rlt-&gt;_fireTSR;</div><div class="line">	__CFRunLoopTimerFireTSRUnlock();</div><div class="line"></div><div class="line">        __CFArmNextTimerInMode(rlm, rl);</div><div class="line"></div><div class="line">	__CFRunLoopModeUnlock(rlm);</div><div class="line">	__CFRunLoopUnlock(rl);</div><div class="line">	</div><div class="line">	//å¤„ç†timerçš„å›è°ƒ</div><div class="line">	__CFRUNLOOP_IS_CALLING_OUT_TO_A_TIMER_CALLBACK_FUNCTION__(rlt-&gt;_callout, rlt, context_info);</div><div class="line">	CHECK_FOR_FORK();</div><div class="line">        if (doInvalidate) &#123;</div><div class="line">            CFRunLoopTimerInvalidate(rlt);      /* DOES CALLOUT */</div><div class="line">        &#125;</div><div class="line">        if (context_release) &#123;</div><div class="line">            context_release(context_info);</div><div class="line">        &#125;</div><div class="line">	__CFRunLoopLock(rl);</div><div class="line">	__CFRunLoopModeLock(rlm);</div><div class="line">        __CFRunLoopTimerLock(rlt);</div><div class="line">        </div><div class="line">    //timerå¤„ç†æˆåŠŸçš„æ ‡è®°</div><div class="line">	timerHandled = true;</div><div class="line">	__CFRunLoopTimerUnsetFiring(rlt);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //æœ¬æ¬¡timerå¤„ç†æˆåŠŸäº† æ¥æ›´æ–°ä¸€ä¸‹ä¸‹æ¬¡çš„è§¦å‘æ—¶é—´</div><div class="line">    if (__CFIsValid(rlt) &amp;&amp; timerHandled) &#123;</div><div class="line">        /* This is just a little bit tricky: we want to support calling</div><div class="line">         * CFRunLoopTimerSetNextFireDate() from within the callout and</div><div class="line">         * honor that new time here if it is a later date, otherwise</div><div class="line">         * it is completely ignored. */</div><div class="line"></div><div class="line">         //ä¸€ä¸‹æ¬¡çš„è§¦å‘æ—¶é—´å·²ç»è®¾ç½®äº† è€Œä¸”æ¯”ä¸Šæ¬¡çš„æ—¶é—´å¤§ è¯´æ˜è®¾ç½®çš„æ²¡æœ‰é—®é¢˜ï¼Œç›´æ¥æ›´æ–°ã€‚</div><div class="line">        if (oldFireTSR &lt; rlt-&gt;_fireTSR) &#123;</div><div class="line">            /* Next fire TSR was set, and set to a date after the previous</div><div class="line">            * fire date, so we honor it. */</div><div class="line">            __CFRunLoopTimerUnlock(rlt);</div><div class="line">            // The timer was adjusted and repositioned, during the</div><div class="line">            // callout, but if it was still the min timer, it was</div><div class="line">            // skipped because it was firing.  Need to redo the</div><div class="line">            // min timer calculation in case rlt should now be that</div><div class="line">            // timer instead of whatever was chosen.</div><div class="line">            </div><div class="line">            //è¿™ä¸ªå‡½æ•°å°±æ˜¯æ›´æ–°ä¸‹æ¬¡è§¦å‘æ—¶é—´çš„</div><div class="line">            __CFArmNextTimerInMode(rlm, rl);</div><div class="line">        &#125; else &#123;</div><div class="line">        </div><div class="line">        //æ²¡æœ‰è®¾ç½®ä¸‹ä¸€æ¬¡çš„è§¦å‘æ—¶é—´ï¼Œè¿›è¡Œè®¾ç½®ï¼Œç„¶åæ›´æ–°åˆ—è¡¨</div><div class="line">	    uint64_t nextFireTSR = 0LL;</div><div class="line">            uint64_t intervalTSR = 0LL;</div><div class="line">            if (rlt-&gt;_interval &lt;= 0.0) &#123;</div><div class="line">            &#125; else if (TIMER_INTERVAL_LIMIT &lt; rlt-&gt;_interval) &#123;</div><div class="line">        	intervalTSR = __CFTimeIntervalToTSR(TIMER_INTERVAL_LIMIT);</div><div class="line">            &#125; else &#123;</div><div class="line">        	intervalTSR = __CFTimeIntervalToTSR(rlt-&gt;_interval);</div><div class="line">            &#125;</div><div class="line">            if (LLONG_MAX - intervalTSR &lt;= oldFireTSR) &#123;</div><div class="line">                nextFireTSR = LLONG_MAX;</div><div class="line">            &#125; else &#123;</div><div class="line">                if (intervalTSR == 0) &#123;</div><div class="line">                    // 15304159: Make sure we don&apos;t accidentally loop forever here</div><div class="line">                    CRSetCrashLogMessage(&quot;A CFRunLoopTimer with an interval of 0 is set to repeat&quot;);</div><div class="line">                    HALT;</div><div class="line">                &#125;</div><div class="line">                uint64_t currentTSR = mach_absolute_time();</div><div class="line">                nextFireTSR = oldFireTSR;</div><div class="line">                while (nextFireTSR &lt;= currentTSR) &#123;</div><div class="line">                    nextFireTSR += intervalTSR;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            CFRunLoopRef rlt_rl = rlt-&gt;_runLoop;</div><div class="line">            if (rlt_rl) &#123;</div><div class="line">                CFRetain(rlt_rl);</div><div class="line">		CFIndex cnt = CFSetGetCount(rlt-&gt;_rlModes);</div><div class="line">		STACK_BUFFER_DECL(CFTypeRef, modes, cnt);</div><div class="line">		CFSetGetValues(rlt-&gt;_rlModes, (const void **)modes);</div><div class="line">		// To avoid A-&gt;B, B-&gt;A lock ordering issues when coming up</div><div class="line">		// towards the run loop from a source, the timer has to be</div><div class="line">		// unlocked, which means we have to protect from object</div><div class="line">		// invalidation, although that&apos;s somewhat expensive.</div><div class="line">		for (CFIndex idx = 0; idx &lt; cnt; idx++) &#123;</div><div class="line">		    CFRetain(modes[idx]);</div><div class="line">		&#125;</div><div class="line">		__CFRunLoopTimerUnlock(rlt);</div><div class="line">		for (CFIndex idx = 0; idx &lt; cnt; idx++) &#123;</div><div class="line">		    CFStringRef name = (CFStringRef)modes[idx];</div><div class="line">		    modes[idx] = (CFTypeRef)__CFRunLoopFindMode(rlt_rl, name, false);</div><div class="line">		    CFRelease(name);</div><div class="line">		&#125;</div><div class="line">		__CFRunLoopTimerFireTSRLock();</div><div class="line">		</div><div class="line">		//ä¸Šé¢ç®—äº†ä¸€å †å°±æ˜¯è®¡ç®—ä¸€ä¸ªæ­£ç¡®çš„nextFireTSRï¼Œåˆ°è¿™é‡Œå·²ç»æ‹¿åˆ°æ­£ç¡®çš„å€¼äº†ï¼Œå¯ä»¥èµ‹å€¼ã€‚</div><div class="line">		rlt-&gt;_fireTSR = nextFireTSR;</div><div class="line">                rlt-&gt;_nextFireDate = CFAbsoluteTimeGetCurrent() + __CFTimeIntervalUntilTSR(nextFireTSR);</div><div class="line">		for (CFIndex idx = 0; idx &lt; cnt; idx++) &#123;</div><div class="line">		    CFRunLoopModeRef rlm = (CFRunLoopModeRef)modes[idx];</div><div class="line">		    if (rlm) &#123;</div><div class="line">		    </div><div class="line">		    //æ›´æ–°æ—¶é—´è§¦å‘çš„åˆ—è¡¨</div><div class="line">                        __CFRepositionTimerInMode(rlm, rlt, true);</div><div class="line">		    &#125;</div><div class="line">		&#125;</div><div class="line">		__CFRunLoopTimerFireTSRUnlock();</div><div class="line">		for (CFIndex idx = 0; idx &lt; cnt; idx++) &#123;</div><div class="line">		    __CFRunLoopModeUnlock((CFRunLoopModeRef)modes[idx]);</div><div class="line">		&#125;</div><div class="line">		CFRelease(rlt_rl);</div><div class="line">	    &#125; else &#123;</div><div class="line">	    </div><div class="line">	    //timeræ²¡æœ‰åŠ åˆ°ä¸€ä¸ªrunloopé‡Œé¢ã€‚è¿™ä¸ªtimeråº”è¯¥ä¸ä¼šè¢«è§¦å‘ã€‚ä¸‹é¢ä¹Ÿæ²¡æœ‰è°ƒæ•´ä¸‹æ¬¡è§¦å‘æ—¶é—´çš„æ“ä½œã€‚ã€‚ã€‚</div><div class="line">		__CFRunLoopTimerUnlock(rlt);</div><div class="line">		__CFRunLoopTimerFireTSRLock();</div><div class="line">		rlt-&gt;_fireTSR = nextFireTSR;</div><div class="line">                rlt-&gt;_nextFireDate = CFAbsoluteTimeGetCurrent() + __CFTimeIntervalUntilTSR(nextFireTSR);</div><div class="line">		__CFRunLoopTimerFireTSRUnlock();</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        __CFRunLoopTimerUnlock(rlt);</div><div class="line">    &#125;</div><div class="line">    CFRelease(rlt);</div><div class="line">    return timerHandled;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="timeræ€»ç»“"><a href="#timeræ€»ç»“" class="headerlink" title="timeræ€»ç»“"></a>timeræ€»ç»“</h5><p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Runloop/runloop008.png" alt=""></p>
<ul>
<li>å¯¹äºé‡å¤çš„NSTimerï¼Œå…¶å¤šæ¬¡è§¦å‘çš„æ—¶åˆ»ä¸æ˜¯ä¸€å¼€å§‹ç®—å¥½çš„ï¼Œè€Œæ˜¯timerè§¦å‘åè®¡ç®—çš„ã€‚ä½†æ˜¯è®¡ç®—æ—¶å‚è€ƒçš„æ˜¯ä¸Šæ¬¡åº”å½“è§¦å‘çš„æ—¶é—´_fireTSRï¼Œå› æ­¤è®¡ç®—å‡ºçš„ä¸‹æ¬¡è§¦å‘çš„æ—¶åˆ»ä¸ä¼šæœ‰è¯¯å·®ã€‚</li>
<li>è®¾ç½®äº†toleranceçš„NSTimerï¼Œå¯¹äºiOSå’ŒMacOSç³»ç»Ÿï¼Œå®è´¨ä¸Šä¼šé‡‡ç”¨GCD timerçš„å½¢å¼æ³¨å†Œåˆ°å†…æ ¸ä¸­ï¼ŒGCD timerè§¦å‘åï¼Œå†ç”±RunLoopå¤„ç†å…¶å›è°ƒé€»è¾‘ã€‚å¯¹äºæ²¡æœ‰è®¾ç½®toleranceçš„timerï¼Œåˆ™æ˜¯ç”¨mk_timerçš„å½¢å¼æ³¨å†Œã€‚</li>
<li>RunLoopModeä¸­timerçš„æ’åºæ˜¯æŒ‰ç…§_fireTSRï¼Œä¹Ÿå°±æ˜¯åº”å½“è§¦å‘çš„æ—¶é—´æ’åºçš„ã€‚</li>
</ul>
<h5 id="Observer"><a href="#Observer" class="headerlink" title="Observer"></a>Observer</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div></pre></td><td class="code"><pre><div class="line">//åˆ›å»ºobserver</div><div class="line"></div><div class="line">CFRunLoopObserverRef CFRunLoopObserverCreate(CFAllocatorRef allocator, CFOptionFlags activities, Boolean repeats, CFIndex order, CFRunLoopObserverCallBack callout, CFRunLoopObserverContext *context) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    CFRunLoopObserverRef memory;</div><div class="line">    UInt32 size;</div><div class="line">    size = sizeof(struct __CFRunLoopObserver) - sizeof(CFRuntimeBase);</div><div class="line">    memory = (CFRunLoopObserverRef)_CFRuntimeCreateInstance(allocator, CFRunLoopObserverGetTypeID(), size, NULL);</div><div class="line">    if (NULL == memory) &#123;</div><div class="line">	return NULL;</div><div class="line">    &#125;</div><div class="line">    __CFSetValid(memory);</div><div class="line">    __CFRunLoopObserverUnsetFiring(memory);</div><div class="line">    if (repeats) &#123;</div><div class="line">	__CFRunLoopObserverSetRepeats(memory);</div><div class="line">    &#125; else &#123;</div><div class="line">	__CFRunLoopObserverUnsetRepeats(memory);</div><div class="line">    &#125;</div><div class="line">    __CFRunLoopLockInit(&amp;memory-&gt;_lock);</div><div class="line">    memory-&gt;_runLoop = NULL;</div><div class="line">    memory-&gt;_rlCount = 0;</div><div class="line">    memory-&gt;_activities = activities;</div><div class="line">    memory-&gt;_order = order;</div><div class="line">    memory-&gt;_callout = callout;</div><div class="line">    if (context) &#123;</div><div class="line">	if (context-&gt;retain) &#123;</div><div class="line">	    memory-&gt;_context.info = (void *)context-&gt;retain(context-&gt;info);</div><div class="line">	&#125; else &#123;</div><div class="line">	    memory-&gt;_context.info = context-&gt;info;</div><div class="line">	&#125;</div><div class="line">	memory-&gt;_context.retain = context-&gt;retain;</div><div class="line">	memory-&gt;_context.release = context-&gt;release;</div><div class="line">	memory-&gt;_context.copyDescription = context-&gt;copyDescription;</div><div class="line">    &#125; else &#123;</div><div class="line">	memory-&gt;_context.info = 0;</div><div class="line">	memory-&gt;_context.retain = 0;</div><div class="line">	memory-&gt;_context.release = 0;</div><div class="line">	memory-&gt;_context.copyDescription = 0;</div><div class="line">    &#125;</div><div class="line">    return memory;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//ç»™modeæ·»åŠ observer</div><div class="line"></div><div class="line">void CFRunLoopAddObserver(CFRunLoopRef rl, CFRunLoopObserverRef rlo, CFStringRef modeName) &#123;</div><div class="line"></div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    CFRunLoopModeRef rlm;</div><div class="line">    if (__CFRunLoopIsDeallocating(rl)) return;</div><div class="line">    if (!__CFIsValid(rlo) || (NULL != rlo-&gt;_runLoop &amp;&amp; rlo-&gt;_runLoop != rl)) return;</div><div class="line">    __CFRunLoopLock(rl);</div><div class="line">    </div><div class="line">    </div><div class="line">    //å¦‚æœæ˜¯common modeç›´æ¥åŠ åˆ°_commonModeItems</div><div class="line">    if (modeName == kCFRunLoopCommonModes) &#123;</div><div class="line">	CFSetRef set = rl-&gt;_commonModes ? CFSetCreateCopy(kCFAllocatorSystemDefault, rl-&gt;_commonModes) : NULL;</div><div class="line">	if (NULL == rl-&gt;_commonModeItems) &#123;</div><div class="line">	    rl-&gt;_commonModeItems = CFSetCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeSetCallBacks);</div><div class="line">	&#125;</div><div class="line">	CFSetAddValue(rl-&gt;_commonModeItems, rlo);</div><div class="line">	if (NULL != set) &#123;</div><div class="line">	    CFTypeRef context[2] = &#123;rl, rlo&#125;;</div><div class="line">	    /* add new item to all common-modes */</div><div class="line">	    CFSetApplyFunction(set, (__CFRunLoopAddItemToCommonModes), (void *)context);</div><div class="line">	    CFRelease(set);</div><div class="line">	&#125;</div><div class="line">    &#125; else &#123;</div><div class="line">    </div><div class="line">    //åˆ›å»º_observersæ•°ç»„</div><div class="line">	rlm = __CFRunLoopFindMode(rl, modeName, true);</div><div class="line">	if (NULL != rlm &amp;&amp; NULL == rlm-&gt;_observers) &#123;</div><div class="line">	    rlm-&gt;_observers = CFArrayCreateMutable(kCFAllocatorSystemDefault, 0, &amp;kCFTypeArrayCallBacks);</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	//åˆ¤æ–­æ˜¯å¦å·²æ·»åŠ </div><div class="line">	if (NULL != rlm &amp;&amp; !CFArrayContainsValue(rlm-&gt;_observers, CFRangeMake(0, CFArrayGetCount(rlm-&gt;_observers)), rlo)) &#123;</div><div class="line">            Boolean inserted = false;</div><div class="line">            for (CFIndex idx = CFArrayGetCount(rlm-&gt;_observers); idx--; ) &#123;</div><div class="line">                CFRunLoopObserverRef obs = (CFRunLoopObserverRef)CFArrayGetValueAtIndex(rlm-&gt;_observers, idx);</div><div class="line">                </div><div class="line">                //æœ‰ä¸€ä¸ªæ’åºï¼Œåªæœ‰orderå¤§äºå·²æ·»åŠ çš„observer æ‰ä¼šè¢«æ·»åŠ åˆ°æ•°ç»„ä¸­</div><div class="line">                if (obs-&gt;_order &lt;= rlo-&gt;_order) &#123;</div><div class="line">                    CFArrayInsertValueAtIndex(rlm-&gt;_observers, idx + 1, rlo);</div><div class="line">                    inserted = true;</div><div class="line">                    break;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            //æ·»åŠ å¤±è´¥ç›´æ¥æ’åˆ°ç¬¬ä¸€ä¸ªä½ç½®</div><div class="line">            if (!inserted) &#123;</div><div class="line">	        CFArrayInsertValueAtIndex(rlm-&gt;_observers, 0, rlo);</div><div class="line">            &#125;</div><div class="line">	    rlm-&gt;_observerMask |= rlo-&gt;_activities;</div><div class="line">	    __CFRunLoopObserverSchedule(rlo, rl, rlm);</div><div class="line">	&#125;</div><div class="line">        if (NULL != rlm) &#123;</div><div class="line">	    __CFRunLoopModeUnlock(rlm);</div><div class="line">	&#125;</div><div class="line">    &#125;</div><div class="line">    __CFRunLoopUnlock(rl);</div><div class="line">&#125;</div><div class="line"></div><div class="line">static void __CFRunLoopDoObservers(CFRunLoopRef rl, CFRunLoopModeRef rlm, CFRunLoopActivity activity) &#123;	/* DOES CALLOUT */</div><div class="line">    CHECK_FOR_FORK();</div><div class="line"></div><div class="line">    CFIndex cnt = rlm-&gt;_observers ? CFArrayGetCount(rlm-&gt;_observers) : 0;</div><div class="line">    if (cnt &lt; 1) return;</div><div class="line"></div><div class="line">    /* Fire the observers */</div><div class="line">    STACK_BUFFER_DECL(CFRunLoopObserverRef, buffer, (cnt &lt;= 1024) ? cnt : 1);</div><div class="line">    CFRunLoopObserverRef *collectedObservers = (cnt &lt;= 1024) ? buffer : (CFRunLoopObserverRef *)malloc(cnt * sizeof(CFRunLoopObserverRef));</div><div class="line">    CFIndex obs_cnt = 0;</div><div class="line">    </div><div class="line">    //å°†åˆ—è¡¨ä¸­ æ´»åŠ¨ &amp;&amp; å¯ç”¨ &amp;&amp; æœªå¤„ç† çš„observeræ·»åŠ åˆ°ä¸€ä¸ªä¸´æ—¶çš„æ•°ç»„ä¸­</div><div class="line">    for (CFIndex idx = 0; idx &lt; cnt; idx++) &#123;</div><div class="line">        CFRunLoopObserverRef rlo = (CFRunLoopObserverRef)CFArrayGetValueAtIndex(rlm-&gt;_observers, idx);</div><div class="line">        if (0 != (rlo-&gt;_activities &amp; activity) &amp;&amp; __CFIsValid(rlo) &amp;&amp; !__CFRunLoopObserverIsFiring(rlo)) &#123;</div><div class="line">            collectedObservers[obs_cnt++] = (CFRunLoopObserverRef)CFRetain(rlo);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    __CFRunLoopModeUnlock(rlm);</div><div class="line">    __CFRunLoopUnlock(rl);</div><div class="line">    for (CFIndex idx = 0; idx &lt; obs_cnt; idx++) &#123;</div><div class="line">        CFRunLoopObserverRef rlo = collectedObservers[idx];</div><div class="line">        __CFRunLoopObserverLock(rlo);</div><div class="line">        if (__CFIsValid(rlo)) &#123;</div><div class="line">            Boolean doInvalidate = !__CFRunLoopObserverRepeats(rlo);</div><div class="line">            __CFRunLoopObserverSetFiring(rlo);</div><div class="line">            __CFRunLoopObserverUnlock(rlo);</div><div class="line">            </div><div class="line">            //è°ƒç”¨observerçš„å›è°ƒ</div><div class="line">            __CFRUNLOOP_IS_CALLING_OUT_TO_AN_OBSERVER_CALLBACK_FUNCTION__(rlo-&gt;_callout, rlo, activity, rlo-&gt;_context.info);</div><div class="line">            if (doInvalidate) &#123;</div><div class="line">                CFRunLoopObserverInvalidate(rlo);</div><div class="line">            &#125;</div><div class="line">            __CFRunLoopObserverUnsetFiring(rlo);</div><div class="line">        &#125; else &#123;</div><div class="line">            __CFRunLoopObserverUnlock(rlo);</div><div class="line">        &#125;</div><div class="line">        CFRelease(rlo);</div><div class="line">    &#125;</div><div class="line">    __CFRunLoopLock(rl);</div><div class="line">    __CFRunLoopModeLock(rlm);</div><div class="line"></div><div class="line">    if (collectedObservers != buffer) free(collectedObservers);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="Block"><a href="#Block" class="headerlink" title="Block"></a>Block</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">//ç»™runloopæ·»åŠ ä¸€ä¸ªblock</div><div class="line"></div><div class="line">void CFRunLoopPerformBlock(CFRunLoopRef rl, CFTypeRef mode, void (^block)(void)) &#123;</div><div class="line">    CHECK_FOR_FORK();</div><div class="line">    </div><div class="line">    //ä¿è¯modeå­˜åœ¨</div><div class="line">    </div><div class="line">    if (CFStringGetTypeID() == CFGetTypeID(mode)) &#123;</div><div class="line">	mode = CFStringCreateCopy(kCFAllocatorSystemDefault, (CFStringRef)mode);</div><div class="line">        __CFRunLoopLock(rl);</div><div class="line">	// ensure mode exists</div><div class="line">        CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, (CFStringRef)mode, true);</div><div class="line">        if (currentMode) __CFRunLoopModeUnlock(currentMode);</div><div class="line">        __CFRunLoopUnlock(rl);</div><div class="line">    &#125; else if (CFArrayGetTypeID() == CFGetTypeID(mode)) &#123;</div><div class="line">        CFIndex cnt = CFArrayGetCount((CFArrayRef)mode);</div><div class="line">	const void **values = (const void **)malloc(sizeof(const void *) * cnt);</div><div class="line">        CFArrayGetValues((CFArrayRef)mode, CFRangeMake(0, cnt), values);</div><div class="line">	mode = CFSetCreate(kCFAllocatorSystemDefault, values, cnt, &amp;kCFTypeSetCallBacks);</div><div class="line">        __CFRunLoopLock(rl);</div><div class="line">	// ensure modes exist</div><div class="line">	for (CFIndex idx = 0; idx &lt; cnt; idx++) &#123;</div><div class="line">            CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, (CFStringRef)values[idx], true);</div><div class="line">            if (currentMode) __CFRunLoopModeUnlock(currentMode);</div><div class="line">	&#125;</div><div class="line">        __CFRunLoopUnlock(rl);</div><div class="line">	free(values);</div><div class="line">    &#125; else if (CFSetGetTypeID() == CFGetTypeID(mode)) &#123;</div><div class="line">        CFIndex cnt = CFSetGetCount((CFSetRef)mode);</div><div class="line">	const void **values = (const void **)malloc(sizeof(const void *) * cnt);</div><div class="line">        CFSetGetValues((CFSetRef)mode, values);</div><div class="line">	mode = CFSetCreate(kCFAllocatorSystemDefault, values, cnt, &amp;kCFTypeSetCallBacks);</div><div class="line">        __CFRunLoopLock(rl);</div><div class="line">	// ensure modes exist</div><div class="line">	for (CFIndex idx = 0; idx &lt; cnt; idx++) &#123;</div><div class="line">            CFRunLoopModeRef currentMode = __CFRunLoopFindMode(rl, (CFStringRef)values[idx], true);</div><div class="line">            if (currentMode) __CFRunLoopModeUnlock(currentMode);</div><div class="line">	&#125;</div><div class="line">        __CFRunLoopUnlock(rl);</div><div class="line">	free(values);</div><div class="line">    &#125; else &#123;</div><div class="line">	mode = NULL;</div><div class="line">    &#125;</div><div class="line">    block = Block_copy(block);</div><div class="line">    </div><div class="line">    //å¦‚æœmodeæˆ–è€…blockä¸ºç©º ç›´æ¥è¿”å›</div><div class="line">    if (!mode || !block) &#123;</div><div class="line">	if (mode) CFRelease(mode);</div><div class="line">	if (block) Block_release(block);</div><div class="line">	return;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //å°†blockæ·»åŠ åˆ°åˆ—è¡¨ä¸­</div><div class="line">    __CFRunLoopLock(rl);</div><div class="line">    struct _block_item *new_item = (struct _block_item *)malloc(sizeof(struct _block_item));</div><div class="line">    new_item-&gt;_next = NULL;</div><div class="line">    new_item-&gt;_mode = mode;</div><div class="line">    new_item-&gt;_block = block;</div><div class="line">    if (!rl-&gt;_blocks_tail) &#123;</div><div class="line">	rl-&gt;_blocks_head = new_item;</div><div class="line">    &#125; else &#123;</div><div class="line">	rl-&gt;_blocks_tail-&gt;_next = new_item;</div><div class="line">    &#125;</div><div class="line">    rl-&gt;_blocks_tail = new_item;</div><div class="line">    __CFRunLoopUnlock(rl);</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">//å¤„ç†block</div><div class="line"></div><div class="line">static Boolean __CFRunLoopDoBlocks(CFRunLoopRef rl, CFRunLoopModeRef rlm) &#123; // Call with rl and rlm locked</div><div class="line">    if (!rl-&gt;_blocks_head) return false;</div><div class="line">    if (!rlm || !rlm-&gt;_name) return false;</div><div class="line">    Boolean did = false;</div><div class="line">    struct _block_item *head = rl-&gt;_blocks_head;</div><div class="line">    struct _block_item *tail = rl-&gt;_blocks_tail;</div><div class="line">    rl-&gt;_blocks_head = NULL;</div><div class="line">    rl-&gt;_blocks_tail = NULL;</div><div class="line">    CFSetRef commonModes = rl-&gt;_commonModes;</div><div class="line">    CFStringRef curMode = rlm-&gt;_name;</div><div class="line">    __CFRunLoopModeUnlock(rlm);</div><div class="line">    __CFRunLoopUnlock(rl);</div><div class="line">    struct _block_item *prev = NULL;</div><div class="line">    struct _block_item *item = head;</div><div class="line">    </div><div class="line">    //éå†blockåˆ—è¡¨</div><div class="line">    while (item) &#123;</div><div class="line">        struct _block_item *curr = item;</div><div class="line">        item = item-&gt;_next;</div><div class="line">	Boolean doit = false;</div><div class="line">	</div><div class="line">	//å½“å‰modeæ˜¯blockæ‰€å±çš„modeä¸€æ · || å½“å‰modeæ˜¯common modeä¸”commonsä¸­åŒ…å«äº†å½“å‰mode</div><div class="line">	if (CFStringGetTypeID() == CFGetTypeID(curr-&gt;_mode)) &#123;</div><div class="line">	    doit = CFEqual(curr-&gt;_mode, curMode) || (CFEqual(curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(commonModes, curMode));</div><div class="line">        &#125; else &#123;</div><div class="line">	    doit = CFSetContainsValue((CFSetRef)curr-&gt;_mode, curMode) || (CFSetContainsValue((CFSetRef)curr-&gt;_mode, kCFRunLoopCommonModes) &amp;&amp; CFSetContainsValue(commonModes, curMode));</div><div class="line">	&#125;</div><div class="line">	if (!doit) prev = curr;</div><div class="line">	if (doit) &#123;</div><div class="line">	    if (prev) prev-&gt;_next = item;</div><div class="line">	    if (curr == head) head = item;</div><div class="line">	    if (curr == tail) tail = prev;</div><div class="line">	    void (^block)(void) = curr-&gt;_block;</div><div class="line">            CFRelease(curr-&gt;_mode);</div><div class="line">            free(curr);</div><div class="line">	    if (doit) &#123;</div><div class="line">	    </div><div class="line">		    //è°ƒç”¨block</div><div class="line">                __CFRUNLOOP_IS_CALLING_OUT_TO_A_BLOCK__(block);</div><div class="line">	        did = true;</div><div class="line">	    &#125;</div><div class="line">            Block_release(block); // do this before relocking to prevent deadlocks where some yahoo wants to run the run loop reentrantly from their dealloc</div><div class="line">	&#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    __CFRunLoopLock(rl);</div><div class="line">    __CFRunLoopModeLock(rlm);</div><div class="line">    if (head) &#123;</div><div class="line">	tail-&gt;_next = rl-&gt;_blocks_head;</div><div class="line">	rl-&gt;_blocks_head = head;</div><div class="line">        if (!rl-&gt;_blocks_tail) rl-&gt;_blocks_tail = tail;</div><div class="line">    &#125;</div><div class="line">    return did;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h5 id="blockæ€»ç»“"><a href="#blockæ€»ç»“" class="headerlink" title="blockæ€»ç»“"></a>blockæ€»ç»“</h5><ul>
<li>å¯ä»¥ç›´æ¥ç»™runloopæ·»åŠ block.æ·»åŠ æˆåŠŸåï¼Œblockä¼šåœ¨ä¸‹ä¸€æ¬¡runloopè¿è¡Œæ—¶è¢«è§¦å‘ã€‚</li>
<li>blockä¸èƒ½å”¤é†’runloop,åªä¼šè¢«æ·»åŠ åˆ°é“¾è¡¨ä¸­ï¼Œç­‰å¾…ä¸‹ä¸€æ¬¡runloopè¢«å”¤é†’åæ‰ä¼šè¢«æ‰§è¡Œã€‚</li>
</ul>
<h3 id="Runloopå®è·µ"><a href="#Runloopå®è·µ" class="headerlink" title="Runloopå®è·µ"></a>Runloopå®è·µ</h3><h4 id="æŸ¥çœ‹Main-Runloopçš„ç»“æ„"><a href="#æŸ¥çœ‹Main-Runloopçš„ç»“æ„" class="headerlink" title="æŸ¥çœ‹Main Runloopçš„ç»“æ„"></a>æŸ¥çœ‹Main Runloopçš„ç»“æ„</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">NSRunLoop *runloop = [NSRunLoop mainRunLoop];</div><div class="line">NSLog(@&quot;runloop = %@&quot;,runloop);</div></pre></td></tr></table></figure>
<h5 id="å…·ä½“ç»“æ„å¦‚ä¸‹ï¼š"><a href="#å…·ä½“ç»“æ„å¦‚ä¸‹ï¼š" class="headerlink" title="å…·ä½“ç»“æ„å¦‚ä¸‹ï¼š"></a>å…·ä½“ç»“æ„å¦‚ä¸‹ï¼š</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div></pre></td><td class="code"><pre><div class="line">&lt;CFRunLoop 0x60c0001e7800 [0x10805cc80]&gt;&#123;</div><div class="line"></div><div class="line">//å”¤é†’ç«¯å£ &amp;&amp; å½“å‰çŠ¶æ€ &amp;&amp; æ˜¯å¦å¿½ç•¥å”¤é†’</div><div class="line">wakeup port = 0x1803, stopped = false, ignoreWakeUps = false, </div><div class="line"></div><div class="line">//current mode</div><div class="line">current mode = kCFRunLoopDefaultMode,</div><div class="line"></div><div class="line">//common mode åŒ…å«2ä¸ªå­mode</div><div class="line">common modes = &lt;CFBasicHash 0x60c00004db90 [0x10805cc80]&gt;&#123;type = mutable set, count = 2,</div><div class="line">entries =&gt;</div><div class="line">	0 : &lt;CFString 0x1093cce88 [0x10805cc80]&gt;&#123;contents = &quot;UITrackingRunLoopMode&quot;&#125;</div><div class="line">	2 : &lt;CFString 0x108032818 [0x10805cc80]&gt;&#123;contents = &quot;kCFRunLoopDefaultMode&quot;&#125;</div><div class="line">&#125;</div><div class="line">,</div><div class="line"></div><div class="line">//common mode çš„items(åŒ…æ‹¬ timer &amp;&amp; source &amp;&amp; observer)</div><div class="line">//observer activities (0x20 == kCFRunLoopBeforeWaiting)  (0x1 == kCFRunLoopEntry) (0xa0 ==  kCFRunLoopBeforeWaiting || kCFRunLoopExit)</div><div class="line"></div><div class="line">common mode items = &lt;CFBasicHash 0x60c00004df50 [0x10805cc80]&gt;&#123;type = mutable set, count = 13,</div><div class="line">entries =&gt;</div><div class="line"></div><div class="line"></div><div class="line">	//source0 ç³»ç»Ÿäº‹ä»¶</div><div class="line">	0 : &lt;CFRunLoopSource 0x60c000167a40 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x0, callout = PurpleEventSignalCallback (0x10cf0675a)&#125;&#125;</div><div class="line"></div><div class="line">	//å¤„ç†æ‰‹åŠ¿çš„é€šçŸ¥</div><div class="line">	1 : &lt;CFRunLoopObserver 0x608000122bc0 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0x20, repeats = Yes, order = 0, callout = _UIGestureRecognizerUpdateObserver (0x1087f06b3), context = &lt;CFRunLoopObserver context 0x6080000dfa30&gt;&#125;</div><div class="line"></div><div class="line">	//autoreleasepoolç›¸å…³é€šçŸ¥</div><div class="line">	2 : &lt;CFRunLoopObserver 0x6040001226c0 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x10820ad92), context = &lt;CFArray 0x604000044890 [0x10805cc80]&gt;&#123;type = mutable-small, count = 1, values = (</div><div class="line">	0 : &lt;0x7fa8a2802048&gt;</div><div class="line">)&#125;&#125;</div><div class="line">	3 : &lt;CFRunLoopObserver 0x604000122940 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0x1, repeats = Yes, order = -2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x10820ad92), context = &lt;CFArray 0x604000044890 [0x10805cc80]&gt;&#123;type = mutable-small, count = 1, values = (</div><div class="line">	0 : &lt;0x7fa8a2802048&gt;</div><div class="line">)&#125;&#125;</div><div class="line"></div><div class="line">	//mach port source</div><div class="line">	4 : &lt;CFRunLoopSource 0x60c000168b80 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = 0, context = &lt;CFRunLoopSource MIG Server&gt; &#123;port = 22787, subsystem = 0x10939e668, context = 0x60000003adc0&#125;&#125;</div><div class="line"></div><div class="line">	//å¤„ç†äº‹ä»¶é˜Ÿåˆ—çš„source</div><div class="line">	6 : &lt;CFRunLoopSource 0x604000167ec0 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x60c000141fa0, callout = __handleEventQueue (0x108b67bb2)&#125;&#125;</div><div class="line"></div><div class="line">	//å¤„ç†åŠ¨ç”»äº‹åŠ¡çš„é€šçŸ¥</div><div class="line">	16 : &lt;CFRunLoopObserver 0x604000122b20 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2000000, callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv (0x10dd374ce), context = &lt;CFRunLoopObserver context 0x0&gt;&#125;</div><div class="line"></div><div class="line">	//mach port source </div><div class="line">	17 : &lt;CFRunLoopSource 0x604000167f80 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = 0, context = &lt;CFRunLoopSource MIG Server&gt; &#123;port = 14599, subsystem = 0x109383fe8, context = 0x0&#125;&#125;</div><div class="line"></div><div class="line">	//CAåŠ¨ç”»æäº¤å‰çš„é€šçŸ¥</div><div class="line">	18 : &lt;CFRunLoopObserver 0x604000122a80 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 1999000, callout = _beforeCACommitHandler (0x108239da1), context = &lt;CFRunLoopObserver context 0x7fa8a3100000&gt;&#125;</div><div class="line"></div><div class="line">	//å¤„ç†ç³»ç»Ÿäº‹ä»¶ source0</div><div class="line">	19 : &lt;CFRunLoopSource 0x604000167e00 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -2, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x60c00004e400, callout = __handleHIDEventFetcherDrain (0x108b67bbe)&#125;&#125;</div><div class="line">	</div><div class="line">	//å¤„ç†ç³»ç»Ÿäº‹ä»¶ source1</div><div class="line">	20 : &lt;CFRunLoopSource 0x60c000167b00 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 1, info = 0x2c03, callout = PurpleEventCallback (0x10cf08bf7)&#125;&#125;</div><div class="line"></div><div class="line">	//CAåŠ¨ç”»æäº¤åçš„é€šçŸ¥</div><div class="line">	21 : &lt;CFRunLoopObserver 0x604000122800 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2001000, callout = _afterCACommitHandler (0x108239e1c), context = &lt;CFRunLoopObserver context 0x7fa8a3100000&gt;&#125;</div><div class="line"></div><div class="line">	//Front Board Services(å‰å°æœåŠ¡)</div><div class="line">	22 : &lt;CFRunLoopSource 0x6040001687c0 [0x10805cc80]&gt;&#123;signalled = Yes, valid = Yes, order = 0, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x6040000a8d00, callout = FBSSerialQueueRunLoopSourceHandler (0x10c67182f)&#125;&#125;</div><div class="line">&#125;</div><div class="line">,</div><div class="line"></div><div class="line"></div><div class="line">modes = &lt;CFBasicHash 0x60c00004dbc0 [0x10805cc80]&gt;&#123;type = mutable set, count = 4,</div><div class="line">entries =&gt;</div><div class="line"></div><div class="line"></div><div class="line">	//UITrackingRunLoopMode çš„ items</div><div class="line"></div><div class="line">	2 : &lt;CFRunLoopMode 0x60c0001869a0 [0x10805cc80]&gt;&#123;name = UITrackingRunLoopMode, port set = 0x1c03, queue = 0x60c000141e40, source = 0x60c000186a70 (not fired), timer port = 0x5403, </div><div class="line"></div><div class="line">	//source0</div><div class="line"></div><div class="line">	sources0 = &lt;CFBasicHash 0x60c00004dfb0 [0x10805cc80]&gt;&#123;type = mutable set, count = 4,</div><div class="line">entries =&gt;</div><div class="line">	0 : &lt;CFRunLoopSource 0x60c000167a40 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x0, callout = PurpleEventSignalCallback (0x10cf0675a)&#125;&#125;</div><div class="line">	3 : &lt;CFRunLoopSource 0x604000167ec0 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x60c000141fa0, callout = __handleEventQueue (0x108b67bb2)&#125;&#125;</div><div class="line">	4 : &lt;CFRunLoopSource 0x6040001687c0 [0x10805cc80]&gt;&#123;signalled = Yes, valid = Yes, order = 0, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x6040000a8d00, callout = FBSSerialQueueRunLoopSourceHandler (0x10c67182f)&#125;&#125;</div><div class="line">	5 : &lt;CFRunLoopSource 0x604000167e00 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -2, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x60c00004e400, callout = __handleHIDEventFetcherDrain (0x108b67bbe)&#125;&#125;</div><div class="line">&#125;</div><div class="line">,</div><div class="line"></div><div class="line">	//source1</div><div class="line"></div><div class="line">	sources1 = &lt;CFBasicHash 0x60c00004dfe0 [0x10805cc80]&gt;&#123;type = mutable set, count = 3,</div><div class="line">entries =&gt;</div><div class="line">	0 : &lt;CFRunLoopSource 0x60c000168b80 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = 0, context = &lt;CFRunLoopSource MIG Server&gt; &#123;port = 22787, subsystem = 0x10939e668, context = 0x60000003adc0&#125;&#125;</div><div class="line">	1 : &lt;CFRunLoopSource 0x604000167f80 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = 0, context = &lt;CFRunLoopSource MIG Server&gt; &#123;port = 14599, subsystem = 0x109383fe8, context = 0x0&#125;&#125;</div><div class="line">	2 : &lt;CFRunLoopSource 0x60c000167b00 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 1, info = 0x2c03, callout = PurpleEventCallback (0x10cf08bf7)&#125;&#125;</div><div class="line">&#125;</div><div class="line">,</div><div class="line">	//observer</div><div class="line"></div><div class="line">	observers = (</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x604000122940 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0x1, repeats = Yes, order = -2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x10820ad92), context = &lt;CFArray 0x604000044890 [0x10805cc80]&gt;&#123;type = mutable-small, count = 1, values = (\n\t0 : &lt;0x7fa8a2802048&gt;\n)&#125;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x608000122bc0 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0x20, repeats = Yes, order = 0, callout = _UIGestureRecognizerUpdateObserver (0x1087f06b3), context = &lt;CFRunLoopObserver context 0x6080000dfa30&gt;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x604000122a80 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 1999000, callout = _beforeCACommitHandler (0x108239da1), context = &lt;CFRunLoopObserver context 0x7fa8a3100000&gt;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x604000122b20 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2000000, callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv (0x10dd374ce), context = &lt;CFRunLoopObserver context 0x0&gt;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x604000122800 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2001000, callout = _afterCACommitHandler (0x108239e1c), context = &lt;CFRunLoopObserver context 0x7fa8a3100000&gt;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x6040001226c0 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x10820ad92), context = &lt;CFArray 0x604000044890 [0x10805cc80]&gt;&#123;type = mutable-small, count = 1, values = (\n\t0 : &lt;0x7fa8a2802048&gt;\n)&#125;&#125;&quot;</div><div class="line">),</div><div class="line">	timers = (null),</div><div class="line">	currently 558352445 (30290423333420) / soft deadline in: 1.84467138e+10 sec (@ -1) / hard deadline in: 1.84467138e+10 sec (@ -1)</div><div class="line">&#125;,</div><div class="line"></div><div class="line">	//GSEventReceiveRunLoopMode æ¥å—ç³»ç»Ÿäº‹ä»¶çš„å†…éƒ¨ Mode</div><div class="line">	3 : &lt;CFRunLoopMode 0x60c000186b40 [0x10805cc80]&gt;&#123;name = GSEventReceiveRunLoopMode, port set = 0x5203, queue = 0x60c000141ef0, source = 0x60c000186c10 (not fired), timer port = 0x5103, </div><div class="line">	sources0 = &lt;CFBasicHash 0x60c00004e070 [0x10805cc80]&gt;&#123;type = mutable set, count = 1,</div><div class="line">entries =&gt;</div><div class="line">	0 : &lt;CFRunLoopSource 0x60c000167a40 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x0, callout = PurpleEventSignalCallback (0x10cf0675a)&#125;&#125;</div><div class="line">&#125;</div><div class="line">,</div><div class="line">	sources1 = &lt;CFBasicHash 0x60c00004e0a0 [0x10805cc80]&gt;&#123;type = mutable set, count = 1,</div><div class="line">entries =&gt;</div><div class="line">	2 : &lt;CFRunLoopSource 0x60c000167bc0 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 1, info = 0x2c03, callout = PurpleEventCallback (0x10cf08bf7)&#125;&#125;</div><div class="line">&#125;</div><div class="line">,</div><div class="line">	observers = (null),</div><div class="line">	timers = (null),</div><div class="line">	currently 558352445 (30290424620943) / soft deadline in: 1.84467138e+10 sec (@ -1) / hard deadline in: 1.84467138e+10 sec (@ -1)</div><div class="line">&#125;,</div><div class="line"></div><div class="line">	//kCFRunLoopDefaultMode</div><div class="line"></div><div class="line">	4 : &lt;CFRunLoopMode 0x60c000186660 [0x10805cc80]&gt;&#123;name = kCFRunLoopDefaultMode, port set = 0x2503, queue = 0x60c000141ce0, source = 0x60c000186730 (not fired), timer port = 0x2303, </div><div class="line">	sources0 = &lt;CFBasicHash 0x60c00004e010 [0x10805cc80]&gt;&#123;type = mutable set, count = 4,</div><div class="line">entries =&gt;</div><div class="line">	0 : &lt;CFRunLoopSource 0x60c000167a40 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x0, callout = PurpleEventSignalCallback (0x10cf0675a)&#125;&#125;</div><div class="line">	3 : &lt;CFRunLoopSource 0x604000167ec0 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x60c000141fa0, callout = __handleEventQueue (0x108b67bb2)&#125;&#125;</div><div class="line">	4 : &lt;CFRunLoopSource 0x6040001687c0 [0x10805cc80]&gt;&#123;signalled = Yes, valid = Yes, order = 0, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x6040000a8d00, callout = FBSSerialQueueRunLoopSourceHandler (0x10c67182f)&#125;&#125;</div><div class="line">	5 : &lt;CFRunLoopSource 0x604000167e00 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -2, context = &lt;CFRunLoopSource context&gt;&#123;version = 0, info = 0x60c00004e400, callout = __handleHIDEventFetcherDrain (0x108b67bbe)&#125;&#125;</div><div class="line">&#125;</div><div class="line">,</div><div class="line">	sources1 = &lt;CFBasicHash 0x60c00004e040 [0x10805cc80]&gt;&#123;type = mutable set, count = 3,</div><div class="line">entries =&gt;</div><div class="line">	0 : &lt;CFRunLoopSource 0x60c000168b80 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = 0, context = &lt;CFRunLoopSource MIG Server&gt; &#123;port = 22787, subsystem = 0x10939e668, context = 0x60000003adc0&#125;&#125;</div><div class="line">	1 : &lt;CFRunLoopSource 0x604000167f80 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = 0, context = &lt;CFRunLoopSource MIG Server&gt; &#123;port = 14599, subsystem = 0x109383fe8, context = 0x0&#125;&#125;</div><div class="line">	2 : &lt;CFRunLoopSource 0x60c000167b00 [0x10805cc80]&gt;&#123;signalled = No, valid = Yes, order = -1, context = &lt;CFRunLoopSource context&gt;&#123;version = 1, info = 0x2c03, callout = PurpleEventCallback (0x10cf08bf7)&#125;&#125;</div><div class="line">&#125;</div><div class="line">,</div><div class="line">	observers = (</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x604000122940 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0x1, repeats = Yes, order = -2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x10820ad92), context = &lt;CFArray 0x604000044890 [0x10805cc80]&gt;&#123;type = mutable-small, count = 1, values = (\n\t0 : &lt;0x7fa8a2802048&gt;\n)&#125;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x608000122bc0 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0x20, repeats = Yes, order = 0, callout = _UIGestureRecognizerUpdateObserver (0x1087f06b3), context = &lt;CFRunLoopObserver context 0x6080000dfa30&gt;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x604000122a80 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 1999000, callout = _beforeCACommitHandler (0x108239da1), context = &lt;CFRunLoopObserver context 0x7fa8a3100000&gt;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x604000122b20 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2000000, callout = _ZN2CA11Transaction17observer_callbackEP19__CFRunLoopObservermPv (0x10dd374ce), context = &lt;CFRunLoopObserver context 0x0&gt;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x604000122800 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2001000, callout = _afterCACommitHandler (0x108239e1c), context = &lt;CFRunLoopObserver context 0x7fa8a3100000&gt;&#125;&quot;,</div><div class="line">    &quot;&lt;CFRunLoopObserver 0x6040001226c0 [0x10805cc80]&gt;&#123;valid = Yes, activities = 0xa0, repeats = Yes, order = 2147483647, callout = _wrapRunLoopWithAutoreleasePoolHandler (0x10820ad92), context = &lt;CFArray 0x604000044890 [0x10805cc80]&gt;&#123;type = mutable-small, count = 1, values = (\n\t0 : &lt;0x7fa8a2802048&gt;\n)&#125;&#125;&quot;</div><div class="line">),</div><div class="line">	timers = &lt;CFArray 0x6080000aa5c0 [0x10805cc80]&gt;&#123;type = mutable-small, count = 1, values = (</div><div class="line">	0 : &lt;CFRunLoopTimer 0x600000168ac0 [0x10805cc80]&gt;&#123;valid = Yes, firing = No, interval = 0, tolerance = 0, next fire date = 558352446 (1.35804296 @ 30291784384812), callout = (Delayed Perform) UIApplication _accessibilitySetUpQuickSpeak (0x106e7e849 / 0x1086fb31b) (/Applications/Xcode.app/Contents/Developer/Platforms/iPhoneOS.platform/Developer/Library/CoreSimulator/Profiles/Runtimes/iOS.simruntime/Contents/Resources/RuntimeRoot/System/Library/Frameworks/UIKit.framework/UIKit), context = &lt;CFRunLoopTimer context 0x600000076700&gt;&#125;</div><div class="line">)&#125;,</div><div class="line">	currently 558352445 (30290424667708) / soft deadline in: 1.35971708 sec (@ 30291784384812) / hard deadline in: 1.35971705 sec (@ 30291784384812)</div><div class="line">&#125;,</div><div class="line"></div><div class="line">	//kCFRunLoopCommonModes</div><div class="line">	5 : &lt;CFRunLoopMode 0x60c000186e80 [0x10805cc80]&gt;&#123;name = kCFRunLoopCommonModes, port set = 0x420b, queue = 0x60c000142520, source = 0x60c000186db0 (not fired), timer port = 0x350b, </div><div class="line">	sources0 = (null),</div><div class="line">	sources1 = (null),</div><div class="line">	observers = (null),</div><div class="line">	timers = (null),</div><div class="line">	currently 558352445 (30290426387800) / soft deadline in: 1.84467138e+10 sec (@ -1) / hard deadline in: 1.84467138e+10 sec (@ -1)</div><div class="line">&#125;,</div><div class="line"></div><div class="line">&#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="ç»™ç³»ç»Ÿmodeæ·»åŠ è‡ªå®šä¹‰items-timer-amp-amp-source-amp-amp-observer"><a href="#ç»™ç³»ç»Ÿmodeæ·»åŠ è‡ªå®šä¹‰items-timer-amp-amp-source-amp-amp-observer" class="headerlink" title="ç»™ç³»ç»Ÿmodeæ·»åŠ è‡ªå®šä¹‰items(timer &amp;&amp; source &amp;&amp; observer)"></a>ç»™ç³»ç»Ÿmodeæ·»åŠ è‡ªå®šä¹‰items(timer &amp;&amp; source &amp;&amp; observer)</h4><p>ä¸ºäº†æ–¹ä¾¿è§‚å¯Ÿæ·»åŠ æ˜¯å¦æˆåŠŸï¼Œæˆ‘ä»¬ä¸åœ¨ä¸»çº¿ç¨‹çš„runloopä¸­æ·»åŠ ï¼Œè‡ªå®šä¹‰ä¸€ä¸ªæ–°çš„çº¿ç¨‹ã€‚</p>
<h5 id="æ·»åŠ Custom-Input-Sourceæ³¨æ„äº‹é¡¹"><a href="#æ·»åŠ Custom-Input-Sourceæ³¨æ„äº‹é¡¹" class="headerlink" title="æ·»åŠ Custom Input Sourceæ³¨æ„äº‹é¡¹"></a>æ·»åŠ Custom Input Sourceæ³¨æ„äº‹é¡¹</h5><ul>
<li>custom input source é»˜è®¤çŠ¶æ€ä¸ºä¸å¤„ç†ï¼Œéœ€è¦æ‰‹åŠ¨å”¤é†’ï¼Œæ‰‹åŠ¨å”¤é†’éœ€è¦å…ˆæ ‡è®°ä¸ºå¾…å¤„ç†çŠ¶æ€ï¼Œæ¯æ¬¡runloopå¤„ç†å®ŒåçŠ¶æ€ä¼šè¢«ç½®å›ä¸å¤„ç†ã€‚</li>
<li>åœ¨å­çº¿ç¨‹æ·»åŠ sourceéœ€è¦åœ¨runloop runçš„ä»£ç ä¹‹å‰æ·»åŠ ï¼Œå› ä¸ºrunåè¯¥çº¿ç¨‹ä¼šé©¬ä¸Šä¼‘çœ ï¼ˆå½“å‰runloopä¸­æ²¡æœ‰èƒ½å”¤é†’è‡ªå·±çš„sourceï¼‰,ä¸å†è¿™è¡Œrunåé¢çš„ä»£ç ã€‚</li>
</ul>
<h5 id="æ·»åŠ Mach-Port-Input-Sourceæ³¨æ„äº‹é¡¹"><a href="#æ·»åŠ Mach-Port-Input-Sourceæ³¨æ„äº‹é¡¹" class="headerlink" title="æ·»åŠ Mach Port Input Sourceæ³¨æ„äº‹é¡¹"></a>æ·»åŠ Mach Port Input Sourceæ³¨æ„äº‹é¡¹</h5><ul>
<li>éœ€è¦åŒæ—¶è®°å½•ä¸»çº¿ç¨‹ç«¯å£å’Œå­çº¿ç¨‹ç«¯å£å·ï¼Œéœ€è¦å”¤é†’å¯¹åº”çº¿ç¨‹æ—¶ç›´æ¥ä½¿ç”¨è¯¥ç«¯å£å‘é€æ¶ˆæ¯å³å¯ï¼Œä¸éœ€è¦åƒCustom Input Sourceé‚£æ ·åšæ ‡è®°ã€‚</li>
</ul>
<h4 id="ç»™runloopæ·»åŠ è‡ªå®šä¹‰modeå’Œitems"><a href="#ç»™runloopæ·»åŠ è‡ªå®šä¹‰modeå’Œitems" class="headerlink" title="ç»™runloopæ·»åŠ è‡ªå®šä¹‰modeå’Œitems"></a>ç»™runloopæ·»åŠ è‡ªå®šä¹‰modeå’Œitems</h4><ul>
<li>éœ€è¦æ³¨æ„çš„æ˜¯ä¸èƒ½ç›´æ¥è°ƒç”¨runè¿™ä¸ªæ–¹æ³•ï¼Œå› ä¸ºè¿™ä¸ªæ–¹æ³•æ˜¯è¿è¡Œåœ¨DefaultModeä¸‹çš„ï¼Œä¸ä¼šè§¦å‘è‡ªå®šä¹‰modeä¸­çš„source,éœ€è¦è°ƒç”¨runMode:beforeDateæ–¹æ³•å¼€å¯runloop.</li>
</ul>
<p><a href="https://github.com/lilingyu0620/LLYRunloopDemo.git" target="_blank" rel="noopener">è¿™é‡Œæ˜¯demo</a></p>
<h4 id="Runloopåœ¨iOSä¸­çš„åº”ç”¨"><a href="#Runloopåœ¨iOSä¸­çš„åº”ç”¨" class="headerlink" title="Runloopåœ¨iOSä¸­çš„åº”ç”¨"></a>Runloopåœ¨iOSä¸­çš„åº”ç”¨</h4><p>è¿™å—ç›´æ¥çœ‹YYåšå®¢å§ï¼Œå·²ç»æ²¡æ³•å†è¡¥å……æ›´å¤šäº†ã€‚ã€‚ã€‚</p>
<p>åšå®¢é“¾æ¥<a href="https://blog.ibireme.com/2015/05/18/runloop/" target="_blank" rel="noopener">https://blog.ibireme.com/2015/05/18/runloop/</a></p>
<h4 id="æœ€åçš„æ€»ç»“"><a href="#æœ€åçš„æ€»ç»“" class="headerlink" title="æœ€åçš„æ€»ç»“"></a>æœ€åçš„æ€»ç»“</h4><p>Runloopæ˜¯ä¸€ä¸ªäº‹ä»¶å¤„ç†çš„å¾ªç¯ã€‚Runloopçš„ç›®æ ‡æ˜¯è®©çº¿ç¨‹åœ¨æœ‰äº‹æƒ…åšçš„æ—¶å€™ä¿æŒå¿™ç¢Œã€æ²¡æœ‰äº‹æƒ…åšçš„æ—¶å€™ä¿æŒç¡çœ ã€‚</p>
<p>Runloopä½¿ç”¨Machå†…æ ¸å®ç°çº¿ç¨‹çš„ç¡çœ ï¼Œé€šè¿‡Sourceå’ŒTimeræ¥å”¤é†’çº¿ç¨‹ï¼ŒSourceå’ŒTimeræœ€ç»ˆéƒ½æ˜¯é€šè¿‡Mach Portæ¥å”¤é†’çš„çº¿ç¨‹ã€‚</p>
<p>Sourceæœ‰CustomSourceå’ŒMach Port Source2ç§ï¼ŒCustomSourceå”¤é†’çº¿ç¨‹å‰éœ€è¦å…ˆè¢«æ ‡æ³¨ä¸ºå¾…å¤„ç†ï¼ŒMachPortSourceåˆ™ç›´æ¥ä½¿ç”¨ç«¯å£å·å‘é€å”¤é†’æ¶ˆæ¯ã€‚</p>
<p>Timeræœ‰ä¸¤ç§å®ç°æ–¹å¼åˆ†åˆ«æ˜¯MK_Timerå’ŒGCD Timer,åœ¨runloopä¸­Timerè¢«è½¬ä¸ºäº†ä¸€ä¸ªå­˜äº†è§¦å‘æ—¶é—´çš„åˆ—è¡¨ï¼Œè¿™ä¸ªè§¦å‘æ—¶é—´æ˜¯ä¸€ä¸ªç»å¯¹æ—¶é—´ï¼Œä¼šæŒ‰æ—¶é—´å¤§å°å‡åºæ’åºï¼Œåœ¨æœ€å°çš„æ—¶é—´è¢«è§¦å‘åï¼ŒRunloopä¼šæ›´æ–°åˆ—è¡¨ä¿è¯æ—¶é—´å§‹ç»ˆæ˜¯å‡åºæ’åˆ—ã€‚å¦‚æœRunloopåœ¨æŸæ¬¡è¿è¡Œä¸­é˜»å¡äº†å¾ˆé•¿æ—¶é—´ï¼ŒTimerçš„è§¦å‘ä¼šå—åˆ°å½±å“ã€‚è¿‡æœŸçš„æ—¶é—´ç‚¹ä¼šè¢«ç§»é™¤è€Œä¸ä¼šå»è§¦å‘ã€‚</p>
<p>Runloopçš„çŠ¶æ€éƒ½å¯ä»¥é€šè¿‡æ·»åŠ Observeræ¥å¾—åˆ°ã€‚Observeråœ¨Runloopä¸­æ˜¯æŒ‰orderä¼˜å…ˆçº§å‡åºæ’åºçš„ï¼Œæ’åœ¨å‰é¢çš„é€šçŸ¥ä¼šå…ˆè¢«è§¦å‘ï¼ˆorderè¶Šå°ä¼˜å…ˆçº§åè€Œè¶Šé«˜ï¼‰ã€‚</p>
<p>Modeè¡¨ç¤ºå½“å‰Runloopè¿è¡Œåœ¨å“ªä¸ªæ¨¡å¼ä¸Šï¼ŒRunloopå¿…é¡»è¿è¡Œåœ¨ä¸€ç§Modeä¸Šï¼ŒRunloopåœ¨åˆ›å»ºæ—¶ä¼šæœ‰ä¸€ä¸ªDefaultMode,å¯ä»¥é€šè¿‡runmodeï¼šbeforeDate åˆ‡æ¢Runloopå½“å‰è¿è¡Œçš„Modeã€‚</p>
<p>Modeä¸­åŒ…å«äº†ä¸Šé¢çš„Source,Timerå’ŒObserverä¸‰ç§Itemsã€‚Runloopè¿è¡Œçš„æ—¶å€™å…¶å®å°±æ˜¯åœ¨å¤„ç†è¿™äº›Itemsä¸­çš„å†…å®¹ï¼Œå¦‚æœè¿™ä¸‰ç§Itemséƒ½æ²¡æœ‰è¦å¤„ç†çš„å†…å®¹ï¼ŒRunloopå°±è¦å¼€å§‹ç¡äº†,è€Œå½“Modeçš„itemsä¸ºç©ºæ—¶ï¼Œå½“å‰Runloopä¼šé€€å‡ºã€‚</p>
<p>CommonModeä¸æ˜¯ä¸€ç§çœŸæ­£çš„Mode,å®ƒæ˜¯ä¸€ä¸ªæ‰€æœ‰Modeçš„é›†åˆï¼Œå¦‚æœæŠŠä¸Šé¢ä¸‰ç§Itemsæ·»åŠ åˆ°CommonMode,é‚£è¿™äº›Itemsä¼šè¢«æ·»åŠ åˆ°é›†åˆä¸­æ‰€æœ‰çš„Modeä¸­ã€‚æ‰€ä»¥æ·»åŠ åˆ°CommonModeä¸­Items,ä¸ç®¡å½“å‰Runloopè¿è¡Œåœ¨å“ªç§Modeä¸Šï¼ŒItemsä¸­éœ€è¦å¤„ç†çš„äº‹ä»¶éƒ½ä¼šè¢«è§¦å‘ã€‚ï¼ˆå‰ææ˜¯è¿™ä¸ªModeå·²ç»è¢«æ·»åŠ åˆ°äº†CommonModeé›†åˆä¸­ï¼‰ã€‚</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/08/22/h-256ä¸h-264çš„å¯¹æ¯”/" itemprop="url">
                  h.256ä¸h.264çš„å¯¹æ¯”
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2018-08-22T17:35:46+08:00" content="2018-08-22">
              2018-08-22
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/08/22/h-256ä¸h-264çš„å¯¹æ¯”/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/08/22/h-256ä¸h-264çš„å¯¹æ¯”/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="h-256ä¸h-264çš„å¯¹æ¯”"><a href="#h-256ä¸h-264çš„å¯¹æ¯”" class="headerlink" title="h.256ä¸h.264çš„å¯¹æ¯”"></a>h.256ä¸h.264çš„å¯¹æ¯”</h3><h4 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h4><p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/h-256ä¸h-264çš„å¯¹æ¯”/h265001.png" alt=""></p>
<h4 id="h-264çš„æŠ€æœ¯å±€é™åœ¨å“ªé‡Œï¼Ÿ"><a href="#h-264çš„æŠ€æœ¯å±€é™åœ¨å“ªé‡Œï¼Ÿ" class="headerlink" title="h.264çš„æŠ€æœ¯å±€é™åœ¨å“ªé‡Œï¼Ÿ"></a>h.264çš„æŠ€æœ¯å±€é™åœ¨å“ªé‡Œï¼Ÿ</h4><p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/h-256ä¸h-264çš„å¯¹æ¯”/h265002.png" alt=""></p>
<h4 id="h-265çš„ä¼˜åŠ¿åœ¨å“ªé‡Œ"><a href="#h-265çš„ä¼˜åŠ¿åœ¨å“ªé‡Œ" class="headerlink" title="h.265çš„ä¼˜åŠ¿åœ¨å“ªé‡Œ"></a>h.265çš„ä¼˜åŠ¿åœ¨å“ªé‡Œ</h4><p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/h-256ä¸h-264çš„å¯¹æ¯”/h265003.png" alt=""></p>
<h4 id="h-265å…³é”®æŠ€æœ¯"><a href="#h-265å…³é”®æŠ€æœ¯" class="headerlink" title="h.265å…³é”®æŠ€æœ¯"></a>h.265å…³é”®æŠ€æœ¯</h4><h5 id="å››å‰æ ‘ç¼–ç ç»“æ„"><a href="#å››å‰æ ‘ç¼–ç ç»“æ„" class="headerlink" title="å››å‰æ ‘ç¼–ç ç»“æ„"></a>å››å‰æ ‘ç¼–ç ç»“æ„</h5><p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/h-256ä¸h-264çš„å¯¹æ¯”/h265004.png" alt=""></p>
<ul>
<li>å®å—çš„åˆ’åˆ†æ–¹å¼ï¼š</li>
</ul>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/h-256ä¸h-264çš„å¯¹æ¯”/h265005.png" alt=""></p>
<ul>
<li>å››å‰æ ‘ç»“æ„</li>
</ul>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/h-256ä¸h-264çš„å¯¹æ¯”/h265006.png" alt=""></p>
<ul>
<li>å®ä¾‹</li>
</ul>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/h-256ä¸h-264çš„å¯¹æ¯”/h265007.png" alt=""></p>
<h5 id="å¸§å†…å’Œå¸§é—´é¢„æµ‹"><a href="#å¸§å†…å’Œå¸§é—´é¢„æµ‹" class="headerlink" title="å¸§å†…å’Œå¸§é—´é¢„æµ‹"></a>å¸§å†…å’Œå¸§é—´é¢„æµ‹</h5><ul>
<li>å¸§å†…é¢„æµ‹</li>
</ul>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/h-256ä¸h-264çš„å¯¹æ¯”/h265008.png" alt=""></p>
<ul>
<li>å¸§é—´é¢„æµ‹</li>
</ul>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/h-256ä¸h-264çš„å¯¹æ¯”/h265009.png" alt=""></p>
<h5 id="ç¯è·¯æ»¤æ³¢"><a href="#ç¯è·¯æ»¤æ³¢" class="headerlink" title="ç¯è·¯æ»¤æ³¢"></a>ç¯è·¯æ»¤æ³¢</h5><p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/h-256ä¸h-264çš„å¯¹æ¯”/h265010.png" alt=""></p>
<h5 id="ç†µç¼–ç "><a href="#ç†µç¼–ç " class="headerlink" title="ç†µç¼–ç "></a>ç†µç¼–ç </h5><p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/h-256ä¸h-264çš„å¯¹æ¯”/h265011.png" alt=""></p>
<h5 id="ç»†ç²’åº¦sliceåˆ†å—è¾¹ç•Œ"><a href="#ç»†ç²’åº¦sliceåˆ†å—è¾¹ç•Œ" class="headerlink" title="ç»†ç²’åº¦sliceåˆ†å—è¾¹ç•Œ"></a>ç»†ç²’åº¦sliceåˆ†å—è¾¹ç•Œ</h5><p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/h-256ä¸h-264çš„å¯¹æ¯”/h265012.png" alt=""></p>
<h4 id="h-264ä¸h-265æ•°æ®æ¯”å¯¹"><a href="#h-264ä¸h-265æ•°æ®æ¯”å¯¹" class="headerlink" title="h.264ä¸h.265æ•°æ®æ¯”å¯¹"></a>h.264ä¸h.265æ•°æ®æ¯”å¯¹</h4><p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/h-256ä¸h-264çš„å¯¹æ¯”/h265013.png" alt=""></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/08/09/HLSåè®®è¯¦è§£/" itemprop="url">
                  HLSåè®®è¯¦è§£
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2018-08-09T15:54:42+08:00" content="2018-08-09">
              2018-08-09
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/08/09/HLSåè®®è¯¦è§£/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/08/09/HLSåè®®è¯¦è§£/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="HLSåè®®è¯¦è§£"><a href="#HLSåè®®è¯¦è§£" class="headerlink" title="HLSåè®®è¯¦è§£"></a>HLSåè®®è¯¦è§£</h3><p>HLS ï¼ˆHTTP Live Streamingï¼‰, æ˜¯ç”± Apple å…¬å¸å®ç°çš„åŸºäº HTTP çš„åª’ä½“æµä¼ è¾“åè®®ã€‚Apple çš„å…¨ç³»åˆ—äº§å“æ”¯æŒï¼Œç”±äº HLS æ˜¯è‹¹æœæå‡ºçš„ï¼Œ æ‰€ä»¥åœ¨ Apple çš„å…¨ç³»åˆ—äº§å“åŒ…æ‹¬ iphoneã€ ipadã€safari éƒ½ä¸éœ€è¦å®‰è£…ä»»ä½•æ’ä»¶å°±å¯ä»¥åŸç”Ÿæ”¯æŒæ’­æ”¾ HLSï¼Œ ç°åœ¨Android ä¹ŸåŠ å…¥äº†å¯¹ HLS çš„æ”¯æŒã€‚ä½†PCç«¯ç›®å‰é™¤äº†Microsoft Edgeå¤–ï¼ŒChromeã€Firefoxç­‰æµè§ˆå™¨å‡ä¸æ”¯æŒè¯¥åè®®çš„æ’­æ”¾ã€‚</p>
<p>HLSè·Ÿ DASH åè®®çš„åŸç†éå¸¸ç±»ä¼¼ï¼Œ<strong>é€šè¿‡å°†æ•´æ¡æµåˆ‡å‰²æˆä¸€ä¸ªå°çš„å¯ä»¥é€šè¿‡ HTTP ä¸‹è½½çš„åª’ä½“æ–‡ä»¶ï¼Œç„¶åæä¾›ä¸€ä¸ªé…å¥—çš„åª’ä½“åˆ—è¡¨æ–‡ä»¶ç»™å®¢æˆ·ç«¯ï¼Œè®©å®¢æˆ·ç«¯é¡ºåºåœ°æ‹‰å–è¿™äº›åª’ä½“æ–‡ä»¶æ’­æ”¾, æ¥å®ç°çœ‹ä¸Šå»æ˜¯åœ¨æ’­æ”¾ä¸€æ¡æµçš„æ•ˆæœã€‚</strong> HLS ç›®å‰å¹¿æ³›åœ°åº”ç”¨äºç‚¹æ’­å’Œç›´æ’­é¢†åŸŸ</p>
<h4 id="HLS-çš„ä¼˜åŠ¿"><a href="#HLS-çš„ä¼˜åŠ¿" class="headerlink" title="HLS çš„ä¼˜åŠ¿"></a>HLS çš„ä¼˜åŠ¿</h4><ul>
<li><p>å®¢æˆ·ç«¯æ”¯æŒç®€å•ï¼Œåªéœ€è¦æ”¯æŒ HTTP è¯·æ±‚å³å¯ï¼ŒHTTP åè®®æ— çŠ¶æ€ï¼Œåªéœ€è¦æŒ‰é¡ºåºä¸‹è½½åª’ä½“ç‰‡æ®µå³å¯ã€‚</p>
</li>
<li><p>ä½¿ç”¨ HTTP åè®®ç½‘ç»œå…¼å®¹æ€§å¥½ï¼Œ HTTP æ•°æ®åŒ…ä¹Ÿå¯ä»¥æ–¹ä¾¿åœ°é€šè¿‡é˜²ç«å¢™æˆ–è€…ä»£ç†æœåŠ¡å™¨ï¼ŒCDN æ”¯æŒè‰¯å¥½ã€‚</p>
</li>
<li><p>è‡ªå¸¦å¤šç ç‡è‡ªé€‚åº”ï¼ŒApple åœ¨æå‡º HLS æ—¶ï¼Œå°±å·²ç»è€ƒè™‘äº†ç ç‡è‡ªé€‚åº”çš„é—®é¢˜ã€‚</p>
</li>
</ul>
<h4 id="HLS-çš„åŠ£åŠ¿"><a href="#HLS-çš„åŠ£åŠ¿" class="headerlink" title="HLS çš„åŠ£åŠ¿"></a>HLS çš„åŠ£åŠ¿</h4><ul>
<li><p>ç›¸æ¯” RTMP è¿™ç±»é•¿è¿æ¥åè®®ï¼Œå»¶æ—¶è¾ƒé«˜ï¼Œéš¾ä»¥ç”¨åˆ°äº’åŠ¨ç›´æ’­åœºæ™¯ã€‚</p>
</li>
<li><p>å¯¹äºç‚¹æ’­æœåŠ¡æ¥è¯´ï¼Œç”±äº TS åˆ‡ç‰‡é€šå¸¸è¾ƒå°ï¼Œæµ·é‡ç¢ç‰‡åœ¨æ–‡ä»¶åˆ†å‘ã€ä¸€è‡´æ€§ç¼“å­˜ã€å­˜å‚¨ç­‰æ–¹é¢éƒ½æœ‰è¾ƒå¤§æŒ‘æˆ˜ã€‚</p>
</li>
</ul>
<h3 id="åè®®è¯¦è§£"><a href="#åè®®è¯¦è§£" class="headerlink" title="åè®®è¯¦è§£"></a>åè®®è¯¦è§£</h3><p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/HLS/hls01.png" alt=""></p>
<p>ä¸Šå›¾å¯ä»¥çœ‹å‡ºï¼ŒHLSæ€»å…±æœ‰ä¸‰ä¸ªéƒ¨åˆ†: Serveã€CDNã€Clientã€‚HLS åè®®çš„ä¸»è¦å†…å®¹æ˜¯å…³äº M3U8 è¿™ä¸ªæ–‡æœ¬åè®®ï¼Œå…¶å®ç”Ÿæˆä¸è§£æéƒ½éå¸¸ç®€å•ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p>
<p>ç®€å•çš„Media Playlist:</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/HLS/hls02.png" alt=""></p>
<p>åŒ…å«å¤šç§æ¯”ç‰¹ç‡çš„ Master Playlist:</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/HLS/hls03.png" alt=""></p>
<ul>
<li>HLS é€šè¿‡ URI(RFC3986) æŒ‡å‘çš„ä¸€ä¸ª Playlist æ¥è¡¨ç¤ºä¸€ä¸ªåª’ä½“æµ.</li>
<li>ä¸€ä¸ª Playlist å¯ä»¥æ˜¯ä¸€ä¸ª Media Playlist æˆ–è€… Master Playlist, ä½¿ç”¨ UTF-8 ç¼–ç çš„æ–‡æœ¬æ–‡ä»¶, åŒ…å«ä¸€äº› URI è·Ÿæè¿°æ€§çš„ tags.</li>
<li>ä¸€ä¸ª Media Playlist åŒ…å«ä¸€ä¸ª Media Segments åˆ—è¡¨,å½“é¡ºåºæ’­æ”¾æ—¶, èƒ½æ’­æ”¾æ•´ä¸ªå®Œæ•´çš„æµ.</li>
<li>è¦æƒ³æ’­æ”¾è¿™ä¸ª Playlist, å®¢æˆ·ç«¯éœ€è¦é¦–å…ˆä¸‹è½½ä»–, ç„¶åæ’­æ”¾é‡Œé¢çš„æ¯ä¸€ä¸ª Media Segment.</li>
<li>æ›´åŠ å¤æ‚çš„æƒ…å†µæ˜¯, Playlist æ˜¯ä¸€ä¸ª Master Playlist, åŒ…å«ä¸€ä¸ª Variant Stream é›†åˆ, é€šå¸¸æ¯ä¸ª Variant Stream é‡Œé¢æ˜¯åŒä¸€ä¸ªæµçš„å¤šä¸ªä¸åŒç‰ˆæœ¬(å¦‚: åˆ†è¾¨ç‡, ç ç‡ä¸åŒ).</li>
</ul>
<h4 id="HLS-Media-Segments"><a href="#HLS-Media-Segments" class="headerlink" title="HLS Media Segments"></a>HLS Media Segments</h4><ul>
<li>æ¯ä¸€ä¸ª Media Segment é€šè¿‡ä¸€ä¸ª URI æŒ‡å®š, å¯èƒ½åŒ…å«ä¸€ä¸ª byte range.</li>
<li>æ¯ä¸€ä¸ª Media Segment çš„ duration é€šè¿‡ EXTINF tag æŒ‡å®š.</li>
<li>æ¯ä¸€ä¸ª Media Segment æœ‰ä¸€ä¸ªå”¯ä¸€çš„æ•´æ•° Media Segment Number.</li>
<li>æœ‰äº›åª’ä½“æ ¼å¼éœ€è¦ä¸€ä¸ª format-specific sequence æ¥åˆå§‹åŒ–ä¸€ä¸ª parser, åœ¨ Media Segment è¢« parse ä¹‹å‰. è¿™ä¸ªå­—æ®µå«åš Media Initialization Section, é€šè¿‡ EXT-X-MAP tag æ¥æŒ‡å®š. </li>
</ul>
<h4 id="æ”¯æŒçš„Media-Segmentæ ¼å¼"><a href="#æ”¯æŒçš„Media-Segmentæ ¼å¼" class="headerlink" title="æ”¯æŒçš„Media Segmentæ ¼å¼"></a>æ”¯æŒçš„Media Segmentæ ¼å¼</h4><h5 id="MPEG-2-Transport-Streams"><a href="#MPEG-2-Transport-Streams" class="headerlink" title="MPEG-2 Transport Streams"></a>MPEG-2 Transport Streams</h5><ul>
<li>å³æœ€å¸¸è§çš„ TS æ–‡ä»¶.</li>
<li>RFC: ISO_13818.</li>
<li>Media Initialization Section: PAT(Program Association Table) è·Ÿ PMT(Program Map Table).</li>
<li>æ¯ä¸ª TS segment å¿…é¡»å€¼å«ä¸€ä¸ª MPEG-2 Program.</li>
<li>æ¯ä¸ª TS segment åŒ…å«ä¸€ä¸ª PAT å’Œ PMT, æœ€å¥½åœ¨ segment çš„å¼€å§‹å¤„, æˆ–è€…é€šè¿‡ä¸€ä¸ª EXT-X-MAP tag æ¥æŒ‡å®š.</li>
</ul>
<h5 id="Fragmented-MPEG-4"><a href="#Fragmented-MPEG-4" class="headerlink" title="Fragmented MPEG-4"></a>Fragmented MPEG-4</h5><ul>
<li>å³å¸¸æåˆ°çš„ fMP4.</li>
<li>RFC: ISOBMFF.</li>
<li>Media Initialization Section: ftyp box(åŒ…å«ä¸€ä¸ªé«˜äº ios6 çš„ brand), ftyp box å¿…é¡»ç´§è·Ÿåœ¨ moov box ä¹‹å. moov box å¿…é¡»åŒ…å«ä¸€ä¸ª trak box(å¯¹äºæ¯ä¸ª fMP4 segment é‡Œé¢çš„ traf box, åŒ…å«åŒ¹é…çš„ track_ID). æ¯ä¸ª trak box åº”è¯¥åŒ…å«ä¸€ä¸ª sample table, ä½†æ˜¯ä»–çš„ sample count å¿…é¡»ä¸º 0. mvhd box è·Ÿ tkhd çš„ duration å¿…é¡»ä¸º 0. mvex box å¿…é¡»è·Ÿåœ¨ä¸Šä¸€ä¸ª trak box åé¢.</li>
<li>ä¸åƒæ™®é€šçš„ MP4 æ–‡ä»¶åŒ…å«ä¸€ä¸ª moov box(åŒ…å« sample tables) å’Œä¸€ä¸ª mdat box(åŒ…å«å¯¹åº”çš„ samples), ä¸€ä¸ª fMP4 åŒ…å«ä¸€ä¸ª moof box (åŒ…å« sample table çš„å­é›†), å’Œä¸€ä¸ª mdat box(åŒ…å«å¯¹åº”çš„ samples).</li>
<li>åœ¨æ¯ä¸€ä¸ª fMP4 segment é‡Œé¢, æ¯ä¸€ä¸ª traf box å¿…é¡»åŒ…å«ä¸€ä¸ª tfdt box, fMP4 segment å¿…é¡»ä½¿ç”¨ movie-fragment relative addressing. fMP4 segments ç»å¯¹ä¸èƒ½ä½¿ç”¨å¤–éƒ¨çš„ data references.</li>
<li>æ¯ä¸€ä¸ª fMP4 segment å¿…é¡»æœ‰ä¸€ä¸ª EXT-X-MAP tag.</li>
</ul>
<h5 id="Packed-Audio"><a href="#Packed-Audio" class="headerlink" title="Packed Audio"></a>Packed Audio</h5><ul>
<li>ä¸€ä¸ª Packed Audio Segment åŒ…å«ç¼–ç çš„ audio samples å’Œ ID3 tags. ç®€å•çš„æ‰“åŒ…åˆ°ä¸€èµ·, åŒ…å«æœ€å°çš„ framing, å¹¶ä¸”æ²¡æœ‰ per-sample timestamp.</li>
<li>æ”¯æŒçš„ Packed Audio: AAC with ADTS framing [ISO_13818_7], MP3 [ISO_13818_3], AC-3 [AC_3], Enhanced AC-3 [AC_3].</li>
<li>ä¸€ä¸ª Packed Audio Segment æ²¡æœ‰ Media Initialization Section.</li>
<li>æ¯ä¸€ä¸ª Packed Audio Segment å¿…é¡»åœ¨ä»–çš„ç¬¬ä¸€ä¸ª sample æŒ‡å®š timestamp é€šè¿‡ä¸€ä¸ª ID3 PRIV tag.</li>
<li>ID3 PRIV owner identifier å¿…é¡»æ˜¯ com.apple.streaming.transportStreamTimestamp.</li>
<li>ID3 payload å¿…é¡»æ˜¯ä¸€ä¸ª 33-bit MPEG-2 Program Elementary Stream timestamp çš„å¤§ç«¯ eight-octet number, é«˜ 31 ä¸ºè®¾ç½®ä¸º 0.</li>
</ul>
<h5 id="WebVTT"><a href="#WebVTT" class="headerlink" title="WebVTT"></a>WebVTT</h5><ul>
<li>ä¸€ä¸ª WebVTT Segment æ˜¯ä¸€ä¸ª WebVTT æ–‡ä»¶çš„ä¸€ä¸ª section, WebVTT Segment åŒ…å« subtitles.</li>
<li>Media Initialization Section: WebVTT header.</li>
<li>æ¯ä¸€ä¸ª WebVTT Segment å¿…é¡»æœ‰ä»¥ä¸€ä¸ª WebVTT header å¼€å§‹, æˆ–è€…æœ‰ä¸€ä¸ª EXT-X-MAP tag æ¥æŒ‡å®š.</li>
<li>æ¯ä¸€ä¸ª WebVTT header åº”è¯¥æœ‰ä¸€ä¸ª X-TIMESTAMP-MAP æ¥ä¿è¯éŸ³è§†é¢‘åŒæ­¥.</li>
</ul>
<h4 id="HLS-Playlists"><a href="#HLS-Playlists" class="headerlink" title="HLS Playlists"></a>HLS Playlists</h4><ul>
<li>Playlist æ–‡ä»¶çš„æ ¼å¼æ˜¯èµ·æºäº M3U, å¹¶ä¸”ç»§æ‰¿ä¸¤ä¸ª tag: EXTM3U å’Œ EXTINF</li>
<li>ä¸‹é¢çš„ tags é€šè¿‡ BNF-style è¯­æ³•æ¥æŒ‡å®š.</li>
<li>ä¸€ä¸ª Playlist æ–‡ä»¶å¿…é¡»é€šè¿‡ URI(.m3u8 æˆ– m3u) æˆ–è€… HTTP Content-Type æ¥è¯†åˆ«(application/vnd.apple.mpegurl æˆ– audio/mpegurl).</li>
<li>æ¢è¡Œç¬¦å¯ä»¥ç”¨ \n æˆ–è€… \r\n.</li>
<li>ä»¥ # å¼€å¤´çš„æ˜¯ tag æˆ–è€…æ³¨é‡Š, ä»¥ #EXT å¼€å¤´çš„æ˜¯ tag, å…¶ä½™çš„ä¸ºæ³¨é‡Š, åœ¨è§£ææ—¶åº”è¯¥å¿½ç•¥.</li>
<li>Playlist é‡Œé¢çš„ URI å¯ä»¥ç”¨ç»å¯¹åœ°å€æˆ–è€…ç›¸å¯¹åœ°å€, å¦‚æœä½¿ç”¨ç›¸å¯¹åœ°å€, é‚£ä¹ˆæ˜¯ç›¸å¯¹äº Playlist æ–‡ä»¶çš„åœ°å€.</li>
</ul>
<h5 id="Attribute-Lists"><a href="#Attribute-Lists" class="headerlink" title="Attribute Lists"></a>Attribute Lists</h5><ul>
<li>æœ‰çš„ tags çš„å€¼æ˜¯ Attribute Lists.</li>
<li>ä¸€ä¸ª Attribute List æ˜¯ä¸€ä¸ªç”¨é€—å·åˆ†éš”çš„ attribute/value å¯¹åˆ—è¡¨.</li>
<li>æ ¼å¼ä¸º: AttributeName=AttributeValue.</li>
</ul>
<h5 id="Basic-Tags"><a href="#Basic-Tags" class="headerlink" title="Basic Tags"></a>Basic Tags</h5><p>Basic Tags å¯ä»¥ç”¨åœ¨ Media Playlist å’Œ Master Playlist é‡Œé¢.</p>
<ul>
<li>EXTM3U: å¿…é¡»åœ¨æ–‡ä»¶çš„ç¬¬ä¸€è¡Œ, æ ‡è¯†æ˜¯ä¸€ä¸ª Extended M3U Playlist æ–‡ä»¶.</li>
<li>EXT-X-VERSION: è¡¨ç¤º Playlist å…¼å®¹çš„ç‰ˆæœ¬.</li>
</ul>
<h5 id="Media-Segment-Tags"><a href="#Media-Segment-Tags" class="headerlink" title="Media Segment Tags"></a>Media Segment Tags</h5><p>æ¯ä¸€ä¸ª Media Segment é€šè¿‡ä¸€ç³»åˆ—çš„ Media Segment tags è·Ÿä¸€ä¸ª URI æ¥æŒ‡å®š. æœ‰çš„ Media Segment tags åªåº”ç”¨ä¸ä¸‹ä¸€ä¸ª segment, æœ‰çš„åˆ™æ˜¯åº”ç”¨æ‰€æœ‰ä¸‹é¢çš„ segments. ä¸€ä¸ª Media Segment tag åªèƒ½å‡ºç°åœ¨ Media Playlist é‡Œé¢.</p>
<ul>
<li>EXTINF: ç”¨äºæŒ‡å®š Media Segment çš„ duration</li>
<li>EXT-X-BYTERANGE: ç”¨äºæŒ‡å®š URI çš„ sub-range</li>
<li>EXT-X-DISCONTINUITY: è¡¨ç¤ºä¸è¿ç»­.</li>
<li>EXT-X-KEY: è¡¨ç¤º Media Segment å·²åŠ å¯†, è¯¥å€¼ç”¨äºè§£å¯†.</li>
<li>EXT-X-MAP: ç”¨äºæŒ‡å®š Media Initialization Section.</li>
<li>EXT-X-PROGRAM-DATE-TIME: å’Œ Media Segment çš„ç¬¬ä¸€ä¸ª sample ä¸€èµ·æ¥ç¡®å®šæ—¶é—´æˆ³.</li>
<li>EXT-X-DATERANGE: å°†ä¸€ä¸ªæ—¶é—´èŒƒå›´å’Œä¸€ç»„å±æ€§é”®å€¼å¯¹ç»“åˆåˆ°ä¸€èµ·.</li>
</ul>
<h5 id="Media-Playlist-Tags"><a href="#Media-Playlist-Tags" class="headerlink" title="Media Playlist Tags"></a>Media Playlist Tags</h5><p>Media Playlist tags æè¿° Media Playlist çš„å…¨å±€å‚æ•°. åŒæ ·åœ°, Media Playlist tags åªèƒ½å‡ºç°åœ¨ Media Playlist é‡Œé¢.</p>
<ul>
<li>EXT-X-TARGETDURATION: ç”¨äºæŒ‡å®šæœ€å¤§çš„ Media Segment duration.</li>
<li>EXT-X-MEDIA-SEQUENCE: ç”¨äºæŒ‡å®šç¬¬ä¸€ä¸ª Media Segment çš„ Media Sequence Number.</li>
<li>EXT-X-DISCONTINUITY-SEQUENCE: ç”¨äºä¸åŒ Variant Stream ä¹‹é—´åŒæ­¥.</li>
<li>EXT-X-ENDLIST: è¡¨ç¤ºç»“æŸ.</li>
<li>EXT-X-PLAYLIST-TYPE: å¯é€‰, æŒ‡å®šæ•´ä¸ª Playlist çš„ç±»å‹.</li>
<li>EXT-X-I-FRAMES-ONLY: è¡¨ç¤ºæ¯ä¸ª Media Segment æè¿°ä¸€ä¸ªå•ä¸€çš„ I-frame.</li>
</ul>
<h5 id="Master-Playlist-Tags"><a href="#Master-Playlist-Tags" class="headerlink" title="Master Playlist Tags"></a>Master Playlist Tags</h5><p>Master Playlist tags å®šä¹‰ Variant Streams, Renditions å’Œ å…¶ä»–æ˜¾ç¤ºçš„å…¨å±€å‚æ•°. Master Playlist tags åªèƒ½å‡ºç°åœ¨ Master Playlist ä¸­.</p>
<ul>
<li>EXT-X-MEDIA: ç”¨äºå…³è”åŒä¸€ä¸ªå†…å®¹çš„å¤šä¸ª Media Playlist çš„å¤šç§ renditions.</li>
<li>EXT-X-STREAM-INF: ç”¨äºæŒ‡å®šä¸€ä¸ª Variant Stream.</li>
<li>EXT-X-I-FRAME-STREAM-INF: ç”¨äºæŒ‡å®šä¸€ä¸ª Media Playlist åŒ…å«åª’ä½“çš„ I-frames.</li>
<li>EXT-X-SESSION-DATA: å­˜æ”¾ä¸€äº› session æ•°æ®.</li>
<li>EXT-X-SESSION-KEY: ç”¨äºè§£å¯†.</li>
</ul>
<h5 id="Media-or-Master-Playlist-Tags"><a href="#Media-or-Master-Playlist-Tags" class="headerlink" title="Media or Master Playlist Tags"></a>Media or Master Playlist Tags</h5><p>è¿™é‡Œçš„ tags å¯ä»¥å‡ºç°åœ¨ Media Playlist æˆ–è€… Master Playlist ä¸­. ä½†æ˜¯å¦‚æœåŒæ—¶å‡ºç°åœ¨åŒä¸€ä¸ª Master Playlist å’Œ Media Playlist ä¸­æ—¶, å¿…é¡»ä¸ºç›¸åŒå€¼.</p>
<ul>
<li>EXT-X-INDEPENDENT-SEGMENTS: è¡¨ç¤ºæ¯ä¸ª Media Segment å¯ä»¥ç‹¬ç«‹è§£ç .</li>
<li>EXT-X-START: æ ‡è¯†ä¸€ä¸ªä¼˜é€‰çš„ç‚¹æ¥æ’­æ”¾è¿™ä¸ª Playlist.</li>
</ul>
<h3 id="æœåŠ¡å™¨ç«¯ä¸å®¢æˆ·ç«¯é€»è¾‘"><a href="#æœåŠ¡å™¨ç«¯ä¸å®¢æˆ·ç«¯é€»è¾‘" class="headerlink" title="æœåŠ¡å™¨ç«¯ä¸å®¢æˆ·ç«¯é€»è¾‘"></a>æœåŠ¡å™¨ç«¯ä¸å®¢æˆ·ç«¯é€»è¾‘</h3><p>ä»¥ä¸‹æµç¨‹ä»…ä¾›å‚è€ƒ, å…¶å®ä¸åŒçš„æ’­æ”¾å™¨å®¢æˆ·ç«¯ä»¥åŠæœåŠ¡å™¨ç«¯çš„æ‹‰å–è§„åˆ™éƒ½æœ‰å¾ˆå¤šç»†èŠ‚å·®å¼‚.</p>
<h4 id="æœåŠ¡å™¨ç«¯é€»è¾‘"><a href="#æœåŠ¡å™¨ç«¯é€»è¾‘" class="headerlink" title="æœåŠ¡å™¨ç«¯é€»è¾‘"></a>æœåŠ¡å™¨ç«¯é€»è¾‘</h4><ul>
<li>å°†åª’ä½“æºåˆ‡ç‰‡æˆ Media Segment, åº”è¯¥ä¼˜å…ˆä»å¯ä»¥é«˜æ•ˆè§£ç çš„æ—¶é—´ç‚¹æ¥è¿›è¡Œåˆ‡ç‰‡(å¦‚: I-frame).</li>
<li>ä¸ºæ¯ä¸€ä¸ª Media Segment ç”Ÿæˆ URI.</li>
<li>Server éœ€è¦æ”¯æŒ â€œgzipâ€ æ–¹å¼å‹ç¼©æ–‡æœ¬å†…å®¹.</li>
<li>åˆ›å»ºä¸€ä¸ª Media Playlist ç´¢å¼•æ–‡ä»¶, EXT-X-VERSION ä¸è¦é«˜äºä»–éœ€è¦çš„ç‰ˆæœ¬, æ¥æä¾›æ›´å¥½çš„å…¼å®¹æ€§.</li>
<li>Server ä¸èƒ½éšä¾¿ä¿®æ”¹ Media Playlist, é™¤äº† Append æ–‡æœ¬åˆ°æ–‡ä»¶æœ«å°¾, æŒ‰é¡ºåºç§»é™¤ Media Segment URIs, å¢é•¿ EXT-X-MEDIA-SEQUENCE å’Œ EXT-X-DISCONTINUITY-SEQUENCE, æ·»åŠ  EXT-X-ENDLIST åˆ°æ–‡ä»¶å°¾.</li>
<li>åœ¨æœ€åæ·»åŠ  EXT-X-ENDLIST tag, æ¥å‡å°‘ Client reload Playlist çš„æ¬¡æ•°.</li>
<li>æ³¨æ„ç‚¹æ’­ä¸ç›´æ’­æœåŠ¡å™¨ä¸åŒçš„åœ°æ–¹æ˜¯, ç›´æ’­çš„ m3u8 æ–‡ä»¶ä¼šä¸æ–­æ›´æ–°, è€Œç‚¹æ’­çš„ m3u8 æ–‡ä»¶æ˜¯ä¸ä¼šå˜çš„, åªéœ€è¦å®¢æˆ·ç«¯åœ¨å¼€å§‹æ—¶è¯·æ±‚ä¸€æ¬¡å³å¯.</li>
</ul>
<h4 id="å®¢æˆ·ç«¯é€»è¾‘"><a href="#å®¢æˆ·ç«¯é€»è¾‘" class="headerlink" title="å®¢æˆ·ç«¯é€»è¾‘"></a>å®¢æˆ·ç«¯é€»è¾‘</h4><ul>
<li>å®¢æˆ·ç«¯é€šè¿‡ URI è·å– Playlist. å¦‚æœæ˜¯ Master Playlist, å®¢æˆ·ç«¯å¯ä»¥é€‰æ‹©ä¸€ä¸ª Variant Stream æ¥æ’­æ”¾.</li>
<li>å®¢æˆ·ç«¯æ£€æŸ¥ EXT-X-VERSION ç‰ˆæœ¬æ˜¯å¦æ»¡è¶³.</li>
<li>å®¢æˆ·ç«¯åº”è¯¥å¿½ç•¥ä¸å¯è¯†åˆ«çš„ tags, å¿½ç•¥ä¸å¯è¯†åˆ«çš„å±æ€§é”®å€¼å¯¹.</li>
<li>åŠ è½½ Media Playlist file.</li>
<li>æ’­æ”¾ Media Playlist file.</li>
<li>é‡åŠ è½½ Media Playlist file.</li>
<li>å†³å®šä¸‹ä¸€æ¬¡è¦åŠ è½½çš„ Media Segment.</li>
</ul>
<h3 id="HLSä¼˜åŒ–æŠ€æœ¯"><a href="#HLSä¼˜åŒ–æŠ€æœ¯" class="headerlink" title="HLSä¼˜åŒ–æŠ€æœ¯"></a>HLSä¼˜åŒ–æŠ€æœ¯</h3><p>ç”±äºå®¢æˆ·ç«¯æ¯æ¬¡è¯·æ±‚ TS æˆ– M3U8 æœ‰å¯èƒ½éƒ½æ˜¯ä¸€ä¸ªæ–°çš„è¿æ¥è¯·æ±‚ï¼Œæ‰€ä»¥,æˆ‘ä»¬æ— æ³•æœ‰æ•ˆçš„æ ‡è¯†å®¢æˆ·ç«¯ï¼Œä¸€æ—¦å‡ºç°é—®é¢˜ï¼ŒåŸºæœ¬æ— æ³•æœ‰æ•ˆçš„å®šä½é—®é¢˜ï¼Œå› æ­¤ä¸€èˆ¬å·¥ä¸šçº§çš„æœåŠ¡å™¨éƒ½ä¼šå¯¹ä¼ ç»Ÿçš„ HLS åšä¸€äº›æ”¹è¿›ã€‚</p>
<h4 id="302"><a href="#302" class="headerlink" title="302"></a>302</h4><p>é¦–å…ˆåœ¨å®¢æˆ·ç«¯ç¬¬ä¸€æ¬¡è¿›è¡Œæ‹‰æµè¯·æ±‚çš„æ—¶å€™ï¼ŒæœåŠ¡å™¨ä¼šåšä¸€ä¸ª302çš„è·³è½¬ã€‚</p>
<h4 id="uuid"><a href="#uuid" class="headerlink" title="uuid"></a>uuid</h4><p>åœ¨302è·³è½¬åäº§ç”Ÿçš„æ–°çš„urlä¸Šï¼ŒæœåŠ¡å™¨ä¼šç»™urlåŠ ä¸Šä¸€ä¸ªuuidï¼Œç”¨æ¥å®šä½å¯èƒ½çš„é—®é¢˜ã€‚</p>
<h3 id="TSæ–‡ä»¶è¯¦è§£"><a href="#TSæ–‡ä»¶è¯¦è§£" class="headerlink" title="TSæ–‡ä»¶è¯¦è§£"></a>TSæ–‡ä»¶è¯¦è§£</h3><p>m3u8åªæ˜¯ä¸€ä¸ªä¼ è¾“æ ¼å¼ï¼Œä¸€ä¸ªå…¸å‹çš„m3u8æ–‡ä»¶ï¼Œæœ€ç»ˆçš„éŸ³è§†é¢‘æ•°æ®æµéƒ½æ˜¯å°è£…åœ¨.tsæ–‡ä»¶ä¸­ï¼Œtsæ–‡ä»¶çš„å…¨ç§°æ˜¯<strong>MPEG-2 Transport Streams</strong>ï¼Œä¸‹é¢æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªæ–‡ä»¶çš„å…·ä½“ç»“æ„ã€‚</p>
<h4 id="æ–‡ä»¶ç»“æ„"><a href="#æ–‡ä»¶ç»“æ„" class="headerlink" title="æ–‡ä»¶ç»“æ„"></a>æ–‡ä»¶ç»“æ„</h4><p>è§†é¢‘ç¼–ç ä¸»è¦æ ¼å¼æ˜¯h264/mpeg4,éŸ³é¢‘ç¼–ç æ ¼å¼ä¸»è¦æ˜¯acc/mp3</p>
<p>tsæ–‡ä»¶åˆ†ä¸ºä¸‰å±‚ï¼š</p>
<ul>
<li>ts(TransportStream)ä¸»è¦æ˜¯éŸ³è§†é¢‘æ•°æ®</li>
<li>pes(PacketElementalStream)åœ¨éŸ³è§†é¢‘æ•°æ®ï¼ˆtsï¼‰ä¸ŠåŠ äº†æ—¶é—´æˆ³ç­‰æ•°æ®è¯´æ˜ä¿¡æ¯</li>
<li>es(ElementaryStream)åœ¨ï¼ˆpesï¼‰ä¸ŠåŠ å…¥æ•°æ®æµçš„è¯†åˆ«å’Œä¼ è¾“å¿…é¡»ä¿¡æ¯</li>
</ul>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/HLS/hlsts.png" alt=""></p>
<p>ä¸‹é¢æ¥åˆ†æä¸€ä¸‹æ¯ä¸€å±‚å…·ä½“çš„æ ¼å¼ã€‚</p>
<h4 id="ts-TransportStream"><a href="#ts-TransportStream" class="headerlink" title="ts(TransportStream)"></a>ts(TransportStream)</h4><p>tsæ•°æ®å¤§å°å›ºå®šä¸º188ä¸ªå­—èŠ‚ï¼Œtsåˆåˆ†ä¸ºä¸‰ä¸ªç»„æˆéƒ¨åˆ†ï¼Œåˆ†åˆ«æ˜¯ <strong>ts header</strong>,<strong>adaptation field</strong>å’Œ<strong>payload</strong>.<br>å…¶ä¸­ts headerå›ºå®šä¸º4ä¸ªå­—èŠ‚ï¼Œadaptation fieldå¯èƒ½å­˜åœ¨ä¹Ÿå¯èƒ½ä¸å­˜åœ¨ï¼Œä¸»è¦ä½œç”¨æ˜¯ç»™ä¸è¶³188å­—èŠ‚çš„æ•°æ®åšå¡«å……ï¼Œpayloadæ˜¯pesæ•°æ®ã€‚</p>
<h5 id="ts-header"><a href="#ts-header" class="headerlink" title="ts header"></a>ts header</h5><p>ts headerä¸­åŒ…å«ä¸€ä¸‹å­—æ®µï¼š</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/HLS/hlstsheader.png" alt=""></p>
<p>tså±‚çš„å†…å®¹æ˜¯é€šè¿‡<strong>pid</strong>å€¼æ¥æ ‡è¯†çš„ï¼Œä¸»è¦å†…å®¹åŒ…æ‹¬ï¼šPATè¡¨ã€PMTè¡¨ã€éŸ³é¢‘æµã€è§†é¢‘æµã€‚è§£ætsæµè¦å…ˆæ‰¾åˆ°PATè¡¨ï¼Œåªè¦æ‰¾åˆ°PATå°±å¯ä»¥æ‰¾åˆ°PMTï¼Œç„¶åå°±å¯ä»¥æ‰¾åˆ°éŸ³è§†é¢‘æµäº†ã€‚<strong>PATè¡¨çš„pidå€¼å›ºå®šä¸º0</strong>ã€‚PATè¡¨å’ŒPMTè¡¨éœ€è¦å®šæœŸæ’å…¥tsæµï¼Œå› ä¸ºç”¨æˆ·éšæ—¶å¯èƒ½åŠ å…¥tsæµï¼Œè¿™ä¸ªé—´éš”æ¯”è¾ƒå°ï¼Œé€šå¸¸æ¯éš”å‡ ä¸ªè§†é¢‘å¸§å°±è¦åŠ å…¥PATå’ŒPMTã€‚PATå’ŒPMTè¡¨æ˜¯å¿…é¡»çš„ï¼Œè¿˜å¯ä»¥åŠ å…¥å…¶å®ƒè¡¨å¦‚SDTï¼ˆä¸šåŠ¡æè¿°è¡¨ï¼‰ç­‰ï¼Œä¸è¿‡hlsæµåªè¦æœ‰PATå’ŒPMTå°±å¯ä»¥æ’­æ”¾äº†ã€‚</p>
<h5 id="adaptation-field"><a href="#adaptation-field" class="headerlink" title="adaptation field"></a>adaptation field</h5><p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/HLS/tsadaptation.png" alt=""></p>
<p>è‡ªé€‚åº”åŒºçš„é•¿åº¦è¦åŒ…å«ä¼ è¾“é”™è¯¯æŒ‡ç¤ºç¬¦æ ‡è¯†çš„ä¸€ä¸ªå­—èŠ‚ã€‚pcræ˜¯èŠ‚ç›®æ—¶é’Ÿå‚è€ƒï¼Œpcrã€dtsã€ptséƒ½æ˜¯å¯¹åŒä¸€ä¸ªç³»ç»Ÿæ—¶é’Ÿçš„é‡‡æ ·å€¼ï¼Œpcræ˜¯é€’å¢çš„ï¼Œå› æ­¤å¯ä»¥å°†å…¶è®¾ç½®ä¸ºdtså€¼ï¼ŒéŸ³é¢‘æ•°æ®ä¸éœ€è¦pcrã€‚å¦‚æœæ²¡æœ‰å­—æ®µï¼Œipadæ˜¯å¯ä»¥æ’­æ”¾çš„ï¼Œä½†vlcæ— æ³•æ’­æ”¾ã€‚æ‰“åŒ…tsæµæ—¶PATå’ŒPMTè¡¨æ˜¯æ²¡æœ‰adaptation fieldçš„ï¼Œä¸å¤Ÿçš„é•¿åº¦ç›´æ¥è¡¥0xffå³å¯ã€‚è§†é¢‘æµå’ŒéŸ³é¢‘æµéƒ½éœ€è¦åŠ adaptation fieldï¼Œé€šå¸¸åŠ åœ¨ä¸€ä¸ªå¸§çš„ç¬¬ä¸€ä¸ªtsåŒ…å’Œæœ€åä¸€ä¸ªtsåŒ…é‡Œï¼Œä¸­é—´çš„tsåŒ…ä¸åŠ ã€‚</p>
<h5 id="PAT-amp-PMT"><a href="#PAT-amp-PMT" class="headerlink" title="PAT &amp; PMT"></a>PAT &amp; PMT</h5><p>è¿™2ä¸ªç±»å‹éƒ½æ˜¯tsçš„ä¸€ç§ï¼Œé€šè¿‡pidæ¥åŒºåˆ†ã€‚</p>
<p><strong>PATä¸»è¦çš„ä½œç”¨å°±æ˜¯æŒ‡æ˜äº†PMTè¡¨çš„pidå€¼</strong>ï¼Œä¸‹å›¾æ˜¯PATåŒ…å«çš„å­—æ®µï¼š</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/HLS/tspat.png" alt=""></p>
<p><strong>PMTä¸»è¦çš„ä½œç”¨å°±æ˜¯æŒ‡æ˜äº†éŸ³è§†é¢‘æµçš„pidå€¼</strong>ï¼Œä¸‹å›¾æ˜¯PMTåŒ…å«çš„å­—æ®µï¼š</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/HLS/tspmt.png" alt=""></p>
<h4 id="pes-PacketElementalStream"><a href="#pes-PacketElementalStream" class="headerlink" title="pes(PacketElementalStream)"></a>pes(PacketElementalStream)</h4><p>peså±‚æ˜¯åœ¨æ¯ä¸€ä¸ªè§†é¢‘/éŸ³é¢‘å¸§ä¸ŠåŠ å…¥äº†æ—¶é—´æˆ³ç­‰ä¿¡æ¯ï¼ŒpesåŒ…å†…å®¹å¾ˆå¤šï¼Œæˆ‘ä»¬åªç•™ä¸‹æœ€å¸¸ç”¨çš„å­—æ®µï¼Œå¦‚ä¸‹ï¼š</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/HLS/hlspes.png" alt=""></p>
<p><strong>ptsæ˜¯æ˜¾ç¤ºæ—¶é—´æˆ³</strong>ã€<strong>dtsæ˜¯è§£ç æ—¶é—´æˆ³</strong>ï¼Œè§†é¢‘æ•°æ®ä¸¤ç§æ—¶é—´æˆ³éƒ½éœ€è¦ï¼ŒéŸ³é¢‘æ•°æ®çš„ptså’Œdtsç›¸åŒï¼Œæ‰€ä»¥åªéœ€è¦ptsã€‚<strong>æœ‰ptså’Œdtsä¸¤ç§æ—¶é—´æˆ³æ˜¯Bå¸§å¼•èµ·çš„</strong>ï¼ŒIå¸§å’ŒPå¸§çš„ptsç­‰äºdtsã€‚å¦‚æœä¸€ä¸ªè§†é¢‘æ²¡æœ‰Bå¸§ï¼Œåˆ™ptsæ°¸è¿œå’Œdtsç›¸åŒã€‚ä»æ–‡ä»¶ä¸­é¡ºåºè¯»å–è§†é¢‘å¸§ï¼Œå–å‡ºçš„å¸§é¡ºåºå’Œdtsé¡ºåºç›¸åŒã€‚dtsç®—æ³•æ¯”è¾ƒç®€å•ï¼Œåˆå§‹å€¼ + å¢é‡å³å¯ï¼Œptsè®¡ç®—æ¯”è¾ƒå¤æ‚ï¼Œéœ€è¦åœ¨dtsçš„åŸºç¡€ä¸ŠåŠ åç§»é‡ã€‚</p>
<p>éŸ³é¢‘çš„pesä¸­åªæœ‰ptsï¼ˆåŒdtsï¼‰ï¼Œè§†é¢‘çš„Iã€På¸§ä¸¤ç§æ—¶é—´æˆ³éƒ½è¦æœ‰ï¼Œè§†é¢‘Bå¸§åªè¦ptsï¼ˆåŒdtsï¼‰ã€‚æ‰“åŒ…ptså’Œdtså°±éœ€è¦çŸ¥é“è§†é¢‘å¸§ç±»å‹ï¼Œä½†æ˜¯é€šè¿‡å®¹å™¨æ ¼å¼æˆ‘ä»¬æ˜¯æ— æ³•åˆ¤æ–­å¸§ç±»å‹çš„ï¼Œå¿…é¡»è§£æh.264å†…å®¹æ‰å¯ä»¥è·å–å¸§ç±»å‹ã€‚</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/HLS/ptsdts.png" alt=""></p>
<p>ç‚¹æ’­è§†é¢‘dtsç®—æ³•ï¼š</p>
<p>dts = åˆå§‹å€¼ + 90000 / video_frame_rateï¼Œåˆå§‹å€¼å¯ä»¥éšä¾¿æŒ‡å®šï¼Œä½†æ˜¯æœ€å¥½ä¸è¦å–0ï¼Œvideo_frame_rateå°±æ˜¯å¸§ç‡ï¼Œæ¯”å¦‚23ã€30ã€‚</p>
<p>ptså’Œdtsæ˜¯ä»¥timescaleä¸ºå•ä½çš„ï¼Œ1s = 90000 time scale , ä¸€å¸§å°±åº”è¯¥æ˜¯90000/video_frame_rate ä¸ªtimescaleã€‚</p>
<p>ç”¨ä¸€å¸§çš„timescaleé™¤ä»¥é‡‡æ ·é¢‘ç‡å°±å¯ä»¥è½¬æ¢ä¸ºä¸€å¸§çš„æ’­æ”¾æ—¶é•¿</p>
<p>ç‚¹æ’­éŸ³é¢‘dtsç®—æ³•ï¼š</p>
<p>dts = åˆå§‹å€¼ + (90000 <em> audio_samples_per_frame) / audio_sample_rateï¼Œaudio_samples_per_frameè¿™ä¸ªå€¼ä¸ç¼–è§£ç ç›¸å…³ï¼Œaacå–å€¼1024ï¼Œmp3å–å€¼1158ï¼Œaudio_sample_rateæ˜¯é‡‡æ ·ç‡ï¼Œæ¯”å¦‚24000ã€41000ã€‚AACä¸€å¸§è§£ç å‡ºæ¥æ˜¯æ¯å£°é“1024ä¸ªsampleï¼Œä¹Ÿå°±æ˜¯è¯´ä¸€å¸§çš„æ—¶é•¿ä¸º1024/sample_rateç§’ã€‚æ‰€ä»¥æ¯ä¸€å¸§æ—¶é—´æˆ³ä¾æ¬¡0ï¼Œ1024/sample_rateï¼Œâ€¦ï¼Œ1024</em>n/sample_rateç§’ã€‚</p>
<p>ç›´æ’­è§†é¢‘çš„dtså’Œptsåº”è¯¥ç›´æ¥ç”¨ç›´æ’­æ•°æ®æµä¸­çš„æ—¶é—´ï¼Œä¸åº”è¯¥æŒ‰å…¬å¼è®¡ç®—ã€‚</p>
<h4 id="es-ElementaryStream"><a href="#es-ElementaryStream" class="headerlink" title="es(ElementaryStream)"></a>es(ElementaryStream)</h4><p>eså±‚æŒ‡çš„å°±æ˜¯éŸ³è§†é¢‘æ•°æ®ï¼Œæˆ‘ä»¬åªä»‹ç»h.264è§†é¢‘å’ŒaacéŸ³é¢‘ã€‚</p>
<h5 id="h-264"><a href="#h-264" class="headerlink" title="h.264"></a>h.264</h5><p>æ‰“åŒ…h.264æ•°æ®æˆ‘ä»¬å¿…é¡»ç»™è§†é¢‘æ•°æ®åŠ ä¸Šä¸€ä¸ªnaluï¼ˆNetwork Abstraction Layer unitï¼‰ï¼ŒnaluåŒ…æ‹¬nalu headerå’Œnalu typeï¼Œnalu headerå›ºå®šä¸º0x00000001ï¼ˆå¸§å¼€å§‹ï¼‰æˆ–0x000001ï¼ˆå¸§ä¸­ï¼‰ã€‚h.264çš„æ•°æ®æ˜¯ç”±sliceç»„æˆçš„ï¼Œsliceçš„å†…å®¹åŒ…æ‹¬ï¼šè§†é¢‘ã€spsã€ppsç­‰ã€‚nalu typeå†³å®šäº†åé¢çš„h.264æ•°æ®å†…å®¹ã€‚</p>
<p>å¯¹h264æ ¼å¼ä¸å¤ªäº†è§£å¯ä»¥å‚è€ƒ<a href="http://llyblog.com/2017/03/16/H-264æ–‡ä»¶ç»“æ„å­¦ä¹ ç¬”è®°/" target="_blank" rel="noopener">h.264æ–‡ä»¶ç»“æ„å­¦ä¹ ç¬”è®°</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/07/20/UIViewControllerçš„å†…å­˜æ³„éœ²æ£€æµ‹å®è·µ/" itemprop="url">
                  UIViewControllerçš„å†…å­˜æ³„éœ²æ£€æµ‹å®è·µ
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2018-07-20T11:02:55+08:00" content="2018-07-20">
              2018-07-20
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/07/20/UIViewControllerçš„å†…å­˜æ³„éœ²æ£€æµ‹å®è·µ/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/07/20/UIViewControllerçš„å†…å­˜æ³„éœ²æ£€æµ‹å®è·µ/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="ç®€ä»‹"><a href="#ç®€ä»‹" class="headerlink" title="ç®€ä»‹"></a>ç®€ä»‹</h3><p>å†…å­˜æ³„éœ²åœ¨æ€§èƒ½ä¼˜åŒ–ä¸­ä¸€ç›´æ˜¯ä¸€ä¸ªè€ç”Ÿå¸¸è°ˆçš„é—®é¢˜ï¼Œè€Œä¸”æœ€å¸¸å‡ºç°åœ¨UIViewControllerçš„ä½¿ç”¨è¿‡ç¨‹ä¸­ã€‚ä¸€èˆ¬å½“VCé€€å‡ºUIå †æ ˆåï¼Œå¦‚æœä½¿ç”¨è¿‡çš„å†…å­˜æ²¡æœ‰è¢«é‡Šæ”¾ï¼Œå°±ä¼šäº§ç”Ÿå†…å­˜æ³„éœ²ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨UIViewControllerçš„æ—¶å€™éœ€è¦ç‰¹åˆ«æ³¨æ„ã€‚</p>
<h3 id="å†…å­˜æ³„éœ²åŸç†åŠè§£å†³æ–¹æ¡ˆ"><a href="#å†…å­˜æ³„éœ²åŸç†åŠè§£å†³æ–¹æ¡ˆ" class="headerlink" title="å†…å­˜æ³„éœ²åŸç†åŠè§£å†³æ–¹æ¡ˆ"></a>å†…å­˜æ³„éœ²åŸç†åŠè§£å†³æ–¹æ¡ˆ</h3><p>ä¸€èˆ¬åœ¨VCä¸­å‡ºç°å†…å­˜æ³„éœ²ä¸»è¦åŸç†æ˜¯äº§ç”Ÿäº†å¾ªç¯å¼•ç”¨å¯¼è‡´å†…å­˜å¾—ä¸åˆ°é‡Šæ”¾ï¼Œè€Œå¾ªç¯å¼•ç”¨äº§ç”Ÿçš„ä¸»è¦caseå¤§æ¦‚äº†ä»¥ä¸‹ä¸‰ç§æƒ…å†µï¼š</p>
<h4 id="NSTimer"><a href="#NSTimer" class="headerlink" title="NSTimer"></a>NSTimer</h4><p>åœ¨ä½¿ç”¨NSTimerçš„æ—¶å€™ä¸€èˆ¬ä¼šæŠŠtargetè®¾ç½®ä¸ºselfï¼Œè€Œtimeræœ¬èº«åˆæ˜¯selfçš„æˆå‘˜å˜é‡ï¼Œè¿™æ ·å°±ä¼šäº§ç”Ÿå¾ªç¯å¼•ç”¨çš„é—®é¢˜ã€‚</p>
<p>æ‰“ç ´å¾ªç¯çš„æ–¹å¼æ˜¯åœ¨VCé€€å‡ºæ—¶åœæ‰timerå¹¶å°†timeræˆå‘˜å˜é‡ç½®ç©ºã€‚</p>
<h4 id="delegate"><a href="#delegate" class="headerlink" title="delegate"></a>delegate</h4><p>delegateäº§ç”Ÿå¾ªç¯å¼•ç”¨çš„åŸç†å’Œtimerç±»åŒï¼Œä¸€èˆ¬æˆ‘ä»¬ä¼šå°†delegateä¿®é¥°ä¸ºweakæ¥æ‰“ç ´å¾ªç¯</p>
<h4 id="block"><a href="#block" class="headerlink" title="block"></a>block</h4><p>blockä¹Ÿæ˜¯æœ€å®¹æ˜“äº§ç”Ÿå¾ªç¯å¼•ç”¨çš„åœ°æ–¹ï¼Œç¨ä¸æ³¨æ„å°±ä¼šé€ æˆå†…å­˜æ³„éœ²ã€‚æ‰€ä»¥åœ¨ä½¿ç”¨blockçš„æ—¶å€™ä¹Ÿéœ€è¦æ ¼å¤–ç•™ç¥ã€‚blockäº§ç”Ÿå¾ªç¯å¼•ç”¨çš„åŸç†ä¸»è¦è¿˜å¾—ä»å®ƒçš„å†…å­˜è¯´èµ·ï¼Œè¿™é‡Œä¸ç»†è¯´ï¼ˆç½‘ä¸Šè®²è¿™ä¸ªcaseçš„æƒ…å†µä¸è¦å¤ªå¤šï¼‰ã€‚</p>
<p>æœ‰2ä¸­æ–¹æ³•å¯ä»¥æ‰“ç ´blockçš„å¾ªç¯å¼•ç”¨ï¼š</p>
<ol>
<li>ä½¿ç”¨weakä¿®é¥°self</li>
<li>ä½¿ç”¨__blockä¿®é¥°selfï¼Œåœ¨blockå†…éƒ¨å°†selfç½®ç©º</li>
</ol>
<p>ä¸è¿‡æ–¹æ¡ˆ2æœ‰ä¸ªå°é—®é¢˜ï¼Œå¦‚æœè¯¥blockæ²¡æœ‰è¢«è°ƒç”¨çš„è¯è¿™ä¸ªå¾ªç¯å¼•ç”¨å°±æ²¡æ³•è¢«æ‰“ç ´äº†ï¼Œæ‰€ä»¥é€šå¸¸æˆ‘ä»¬éƒ½ä½¿ç”¨ç¬¬ä¸€ç§æ–¹æ¡ˆã€‚</p>
<p>ä½†æ˜¯åœ¨å¼€å‘ä¸šåŠ¡çš„è¿‡ç¨‹ä¸­éš¾å…ä¼šæœ‰ç–æ¼çš„åœ°æ–¹ï¼Œç»éªŒä¸°å¯Œçš„è€é¸Ÿè¿˜å¥½ï¼Œå¦‚æœç»„å†…æœ‰å°èŒæ–°çš„è¯ï¼Œè¿™ç§é—®é¢˜å°±å¾ˆå¯èƒ½ä¼šå‡ºç°ï¼Œè¿™é‡Œå†™è¿™ä¸ªå·¥å…·ä¹Ÿæ˜¯åšä¸€ä¸ªä¿æŠ¤ã€‚</p>
<h3 id="å†…å­˜æ³„éœ²æ£€æµ‹åŸç†"><a href="#å†…å­˜æ³„éœ²æ£€æµ‹åŸç†" class="headerlink" title="å†…å­˜æ³„éœ²æ£€æµ‹åŸç†"></a>å†…å­˜æ³„éœ²æ£€æµ‹åŸç†</h3><p>å½“VCè¢«popæˆ–è€…dismissåï¼Œæ­£å¸¸çš„æµç¨‹æ˜¯èµ°åˆ°deallocï¼Œç„¶åä½¿ç”¨çš„å†…å­˜ä¼šè¢«é‡Šæ”¾ï¼Œselfä¼šä¸ºnil,å¦‚æœæœ‰å¾ªç¯å¼•ç”¨ï¼Œåˆ™ä¸ä¼šèµ°dealloc,å†…å­˜å¾—ä¸åˆ°é‡Šæ”¾ï¼Œselfä¹Ÿä¸ä¼šä¸ºnil.</p>
<p>è¿™é‡Œæˆ‘ä»¬å°±åˆ©ç”¨äº†é‡Šæ”¾åselfä¼šè¢«ç½®ç©ºï¼Œè€Œä¸é‡Šæ”¾selfä¸ä¼šä¸ºnilçš„åŸç†æ¥å®ç°å†…å­˜æ³„éœ²çš„è­¦å‘Šã€‚</p>
<h3 id="å®ç°"><a href="#å®ç°" class="headerlink" title="å®ç°"></a>å®ç°</h3><p>é¦–å…ˆæˆ‘ä»¬éœ€è¦hook UIViewControllerçš„ä¸‹é¢å‡ ä¸ªæ–¹æ³•ï¼š</p>
<ul>
<li>viewWillAppear</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">+ (void)swizzledViewWillAppear&#123;</div><div class="line">    </div><div class="line">    Class class = [self class];</div><div class="line">    </div><div class="line">    SEL originalSelector = @selector(viewWillAppear:);</div><div class="line">    SEL swizzledSelector = @selector(ocn_viewWillAppear:);</div><div class="line">    </div><div class="line">    Method originalMethod = class_getInstanceMethod(class, originalSelector);</div><div class="line">    Method swizzledMethod = class_getInstanceMethod(class, swizzledSelector);</div><div class="line">    </div><div class="line">    BOOL success = class_addMethod(class, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod));</div><div class="line">    if (success) &#123;</div><div class="line">        class_replaceMethod(class, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod));</div><div class="line">    &#125;</div><div class="line">    else&#123;</div><div class="line">        method_exchangeImplementations(originalMethod, swizzledMethod);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>viewDidDisappear</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">+ (void)swizzledViewDidDisappear&#123;</div><div class="line">    </div><div class="line">    Class class = [self class];</div><div class="line">    </div><div class="line">    SEL originalSelector = @selector(viewDidDisappear:);</div><div class="line">    SEL swizzledSelector = @selector(ocn_viewDidDisappear:);</div><div class="line">    </div><div class="line">    Method originalMethod = class_getInstanceMethod(class, originalSelector);</div><div class="line">    Method swizzledMethod = class_getInstanceMethod(class, swizzledSelector);</div><div class="line">    </div><div class="line">    BOOL success = class_addMethod(class, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod));</div><div class="line">    if (success) &#123;</div><div class="line">        class_replaceMethod(class, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod));</div><div class="line">    &#125;</div><div class="line">    else&#123;</div><div class="line">        method_exchangeImplementations(originalMethod, swizzledMethod);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<ul>
<li>dismissViewControllerAnimated</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">+ (void)swizzledDismissViewController&#123;</div><div class="line">    </div><div class="line">    Class class = [self class];</div><div class="line">    </div><div class="line">    SEL originalSelector = @selector(dismissViewControllerAnimated:completion:);</div><div class="line">    SEL swizzledSelector = @selector(ocn_dismissViewControllerAnimated:completion:);</div><div class="line">    </div><div class="line">    Method originalMethod = class_getInstanceMethod(class, originalSelector);</div><div class="line">    Method swizzledMethod = class_getInstanceMethod(class, swizzledSelector);</div><div class="line">    </div><div class="line">    BOOL success = class_addMethod(class, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod));</div><div class="line">    if (success) &#123;</div><div class="line">        class_replaceMethod(class, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod));</div><div class="line">    &#125;</div><div class="line">    else&#123;</div><div class="line">        method_exchangeImplementations(originalMethod, swizzledMethod);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åŒæ—¶æˆ‘ä»¬è¿˜éœ€è¦hook ä¸€ä¸‹UINavigationControllerçš„popæ–¹æ³•:</p>
<ul>
<li>popViewControllerAnimated</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">+ (void)swizzledPopViewControllerAnimated&#123;</div><div class="line">    </div><div class="line">    Class class = [self class];</div><div class="line">    </div><div class="line">    SEL originalSelector = @selector(popViewControllerAnimated:);</div><div class="line">    SEL swizzledSelector = @selector(ocn_popViewControllerAnimated:);</div><div class="line">    </div><div class="line">    Method originalMethod = class_getInstanceMethod(class, originalSelector);</div><div class="line">    Method swizzledMethod = class_getInstanceMethod(class, swizzledSelector);</div><div class="line">    </div><div class="line">    BOOL success = class_addMethod(class, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod));</div><div class="line">    if (success) &#123;</div><div class="line">        class_replaceMethod(class, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod));</div><div class="line">    &#125;</div><div class="line">    else&#123;</div><div class="line">        method_exchangeImplementations(originalMethod, swizzledMethod);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œå½“ç„¶é€‰æ‹©åœ¨åˆ†ç±»ä¸­è¿›è¡Œhookæœ€æ–¹ä¾¿äº†ã€‚æˆ‘ä»¬æŠŠhookçš„ä»£ç æ”¾åœ¨loadå‡½æ•°ä¸­æ‰§è¡Œï¼Œå…·ä½“åŸå› å‚è€ƒ<a href="https://nshipster.cn/method-swizzling/" target="_blank" rel="noopener">è¿™é‡Œ</a>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">+ (void)load&#123;</div><div class="line">    </div><div class="line">#if defined(DATAONLINE) &amp;&amp; DATAONLINE == 0</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        </div><div class="line">        [self swizzledViewWillAppear];</div><div class="line">        [self swizzledViewDidDisappear];</div><div class="line">        [self swizzledDismissViewController];</div><div class="line">        </div><div class="line">    &#125;);</div><div class="line">#endif</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (void)load&#123;</div><div class="line">    </div><div class="line">#if defined(DATAONLINE) &amp;&amp; DATAONLINE == 0 </div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        [self swizzledPopViewControllerAnimated];</div><div class="line">    &#125;);</div><div class="line">#endif</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„å®è¡¨ç¤ºæ˜¯æµ‹è¯•ç¯å¢ƒã€‚</p>
<p>åœ¨viewWillAppearä¸­ï¼Œæˆ‘ä»¬è®°å½•ä¸€ä¸‹å½“å‰VCçš„çŠ¶æ€ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">- (void)ocn_viewWillAppear:(BOOL)animated&#123;</div><div class="line">    </div><div class="line">    [self ocn_viewWillAppear:animated];</div><div class="line">    </div><div class="line">    [self setOcn_hasBeenPopped:NO];</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶ååœ¨viewDidDisappearæ—¶ï¼Œæˆ‘ä»¬åˆ¤æ–­ä¸€ä¸‹å½“å‰VCçš„çŠ¶æ€ï¼Œå¦‚æœVCè¢«popæˆ–è€…dismissäº†ï¼Œæˆ‘ä»¬è°ƒç”¨ä¸€ä¸‹å†…å­˜æ³„éœ²æé†’çš„æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">- (void)ocn_viewDidDisappear:(BOOL)animated&#123;</div><div class="line">    </div><div class="line">    [self ocn_viewDidDisappear:animated];</div><div class="line"></div><div class="line">    __weak __typeof(self)weakSelf = self;</div><div class="line">    dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(1 * NSEC_PER_SEC)), dispatch_get_main_queue(), ^&#123;</div><div class="line">        if ([weakSelf ocn_hasBeenPopped]) &#123;</div><div class="line">            [weakSelf alertWithClassName:NSStringFromClass([weakSelf class])];</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">    </div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œæˆ‘ä»¬åšäº†ä¸€ä¸ªå»¶æ—¶è°ƒç”¨ï¼Œå‰é¢å·²ç»è¯´è¿‡ï¼Œå¦‚æœVCèµ°æ­£å¸¸æµç¨‹ï¼Œå†…å­˜è¢«é‡Šæ”¾ï¼Œselfä¼šè¢«ç½®ç©ºï¼Œæ‰€ä»¥è¿™é‡Œå¦‚æœæ²¡æœ‰å†…å­˜æ³„éœ²çš„è¯ï¼Œweakselfåº”è¯¥æ˜¯ä¸ºnilï¼Œæˆ‘ä»¬ä½¿ç”¨nilå¯¹è±¡è°ƒç”¨è¿™ä¸¤ä¸ªæ–¹æ³•ä¸ä¼šæœ‰æé†’ï¼Œè€Œå¦‚æœå‘ç”Ÿäº†å†…å­˜æ³„éœ²ï¼Œweakselfä¸ä¼šä¸ºnilï¼Œè¿™æ—¶è°ƒç”¨è€…è¿™2ä¸ªæ–¹æ³•å°±ä¼šå¼¹å‡ºå†…å­˜æ³„éœ²çš„è­¦å‘Šäº†ã€‚</p>
<p>å½“ç„¶ï¼Œæˆ‘ä»¬è¿˜éœ€è¦å†dismisså’Œpopçš„æ—¶å€™è®¾ç½®å½“å‰vcçš„çŠ¶æ€ä¸ºå·²popçš„çŠ¶æ€ï¼Œåªæœ‰æ˜¯å·²ç»è¢«popäº†ï¼Œæ‰ä¼šå»å°è¯•è°ƒç”¨æé†’äº‹ä»¶ã€‚å› ä¸ºå½“vcçš„è°ƒç”¨æ ˆè¢«pushåˆ°ä¸‹ä¸€çº§ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æœ‰æ–°çš„vcæ—¶ï¼ŒviewDidDisappearä¹Ÿä¼šè¢«è°ƒç”¨ï¼Œä½†æ˜¯æ­¤æ—¶vcçš„å†…å­˜è¿˜ä¼šä¿å­˜åœ¨å†…å­˜ä¸­ï¼Œåªæœ‰åœ¨è¢«popæˆ–è€…dismissåï¼Œvcçš„å†…å­˜æ‰æœ‰å¯èƒ½è¢«é‡Šæ”¾ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">- (void)ocn_dismissViewControllerAnimated:(BOOL)flag completion:(void (^)(void))completion &#123;</div><div class="line">    </div><div class="line">    [self ocn_dismissViewControllerAnimated:flag completion:completion];</div><div class="line">    [self setOcn_hasBeenPopped:YES];</div><div class="line">    </div><div class="line">&#125;</div><div class="line"></div><div class="line">- (UIViewController *)ocn_popViewControllerAnimated:(BOOL)animated &#123;</div><div class="line">    UIViewController *poppedViewController = [self ocn_popViewControllerAnimated:animated];</div><div class="line">    </div><div class="line">    if (!poppedViewController) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    objc_setAssociatedObject(poppedViewController, kHasBeenPoppedKey, @(YES), OBJC_ASSOCIATION_RETAIN);</div><div class="line">    </div><div class="line">    return poppedViewController;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="åç»­"><a href="#åç»­" class="headerlink" title="åç»­"></a>åç»­</h3><p>è¿™ä¸ªå·¥å…·ç›®å‰åªèƒ½æ£€æµ‹UIViewControllerçš„å†…å­˜æ³„éœ²é—®é¢˜ï¼Œåç»­è¿˜å¯ä»¥å†åŠ ä¸Šå…¶ä»–ç±»å‹çš„æ£€æµ‹æ–¹æ³•ã€‚å†™è¿™ä¸ªå·¥å…·ä¹Ÿç®—æ˜¯å¯¹runtimeå­¦ä¹ çš„ä¸€ä¸ªå®è·µã€‚</p>
<p><a href="https://github.com/lilingyu0620/LLYMemoryLeakDetector" target="_blank" rel="noopener">è¿™é‡Œæ˜¯demo</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/07/04/FDFullscreenPopGestureå…¨å±è¿”å›å®ç°åŸç†è§£æ/" itemprop="url">
                  FDFullscreenPopGestureå®ç°åŸç†è§£æ
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2018-07-04T14:47:58+08:00" content="2018-07-04">
              2018-07-04
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/07/04/FDFullscreenPopGestureå…¨å±è¿”å›å®ç°åŸç†è§£æ/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/07/04/FDFullscreenPopGestureå…¨å±è¿”å›å®ç°åŸç†è§£æ/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>æœ€è¿‘åœ¨é¡¹ç›®ä¸­å¤„ç†äº†ä¸€ä¸ªUIScrollViewå³æ»‘è¿”å›ä¸Šçº§é¡µçš„é—®é¢˜ï¼Œåˆšå¥½é¡¹ç›®ä¸­ä¹Ÿä½¿ç”¨äº†<a href="https://github.com/forkingdog/FDFullscreenPopGesture" target="_blank" rel="noopener">FDFullscreenPopGesture</a>è¿™ä¸ªå…¨å±è¿”å›çš„åº“ï¼Œäºæ˜¯æ¥åˆ†æå®ƒçš„å®ç°å§ã€‚</p>
<p>è¿™ä¸ªåº“æ˜¯sunngxxä¹‹å‰åœ¨ç™¾åº¦çš„æ—¶å€™å¼„çš„ï¼Œå·²ç»å¥½ä¹…æ²¡æœ‰æ›´æ–°äº†ï¼Œä¸è¿‡ç›®å‰è¿˜èƒ½ç”¨ï¼Œstarä¹Ÿå·²ç»æœ‰5kå¤šäº†ï¼Œè€Œä¸”sunngxxè¿™ç§runtimeå°ç‹å­ï¼Œå†™çš„è¿™ä¸ªåº“å‡ ä¹æ‰€æœ‰å‡½æ•°éƒ½æ˜¯runtimeå®ç°ï¼Œè¿˜æ˜¯å¾ˆæœ‰å­¦ä¹ çš„ä»·å€¼çš„ã€‚</p>
<p>FDFullscreenPopGestureæ˜¯ä»¥ä¸€ä¸ªåˆ†ç±»æ–‡ä»¶çš„å½¢å¼æä¾›ç»™ä½¿ç”¨è€…ï¼Œåœ¨å†…éƒ¨é‡å†™äº†<strong>+(void)load;</strong>æ–¹æ³•ï¼Œåªè¦æŠŠä»£ç é›†æˆåˆ°é¡¹ç›®ä¸­å°±å¯ä»¥ä½¿ç”¨å…¨å±è¿”å›äº†ã€‚</p>
<p>å…ˆæ¥çœ‹ä¸€ä¸‹å¤´æ–‡ä»¶ä¸­çš„å†…å®¹ï¼Œé¦–å…ˆæ˜¯UINavigationControllerçš„åˆ†ç±»</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">@interface UINavigationController (FDFullscreenPopGesture)</div><div class="line"></div><div class="line">/// The gesture recognizer that actually handles interactive pop.</div><div class="line">@property (nonatomic, strong, readonly) UIPanGestureRecognizer *fd_fullscreenPopGestureRecognizer;</div><div class="line"></div><div class="line">/// A view controller is able to control navigation bar&apos;s appearance by itself,</div><div class="line">/// rather than a global way, checking &quot;fd_prefersNavigationBarHidden&quot; property.</div><div class="line">/// Default to YES, disable it if you don&apos;t want so.</div><div class="line">@property (nonatomic, assign) BOOL fd_viewControllerBasedNavigationBarAppearanceEnabled;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>ç¬¬ä¸€ä¸ªå±æ€§æ˜¯å½“å‰å®é™…ç›¸åº”å³æ»‘çš„æ‰‹åŠ¿å¯¹è±¡ï¼Œè¿™ä¸ªå¯¹è±¡æ›¿æ¢äº†ç³»ç»Ÿçš„æ‰‹åŠ¿å¯¹è±¡ï¼Œå…·ä½“å’‹æ›¿æ¢çš„åé¢åœ¨è¯´ã€‚</p>
<p>ç¬¬äºŒä¸ªå±æ€§è®¾ç½®æ˜¯å¦ä½¿ç”¨fdçš„æ–¹æ³•å»æ§åˆ¶å¯¼èˆªæ çš„æ˜¾ç¤ºéšè—ã€‚</p>
<p>ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹UIViewControllerçš„åˆ†ç±»:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">/// Allows any view controller to disable interactive pop gesture, which might</div><div class="line">/// be necessary when the view controller itself handles pan gesture in some</div><div class="line">/// cases.</div><div class="line">@interface UIViewController (FDFullscreenPopGesture)</div><div class="line"></div><div class="line">/// Whether the interactive pop gesture is disabled when contained in a navigation</div><div class="line">/// stack.</div><div class="line">@property (nonatomic, assign) BOOL fd_interactivePopDisabled;</div><div class="line"></div><div class="line">/// Indicate this view controller prefers its navigation bar hidden or not,</div><div class="line">/// checked when view controller based navigation bar&apos;s appearance is enabled.</div><div class="line">/// Default to NO, bars are more likely to show.</div><div class="line">@property (nonatomic, assign) BOOL fd_prefersNavigationBarHidden;</div><div class="line"></div><div class="line">/// Max allowed initial distance to left edge when you begin the interactive pop</div><div class="line">/// gesture. 0 by default, which means it will ignore this limit.</div><div class="line">@property (nonatomic, assign) CGFloat fd_interactivePopMaxAllowedInitialDistanceToLeftEdge;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<ul>
<li>fd_interactivePopDisabled:å½“å‰é¡µé¢æ˜¯å¦æ”¯æŒå³æ»‘è¿”å›</li>
<li>fd_prefersNavigationBarHidden:æ§åˆ¶å½“å‰é¡µé¢å¯¼èˆªæ çš„æ˜¾ç¤ºéšè—</li>
<li>fd_interactivePopMaxAllowedInitialDistanceToLeftEdge:å³æ»‘è¿”å›è§¦å‘çš„ä½ç½®ï¼Œè¿™é‡Œæ˜¯è·ç¦»å·¦è¾¹è·çš„è·ç¦»ã€‚</li>
</ul>
<h3 id="å…¨å±è¿”å›"><a href="#å…¨å±è¿”å›" class="headerlink" title="å…¨å±è¿”å›"></a>å…¨å±è¿”å›</h3><p>æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹å…¨å±è¿”å›çš„å®ç°ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div></pre></td><td class="code"><pre><div class="line">@interface _FDFullscreenPopGestureRecognizerDelegate : NSObject &lt;UIGestureRecognizerDelegate&gt;</div><div class="line"></div><div class="line">@property (nonatomic, weak) UINavigationController *navigationController;</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line">@implementation _FDFullscreenPopGestureRecognizerDelegate</div><div class="line"></div><div class="line">//åˆ¤æ–­æ˜¯å¦å¤„ç†è¿”å›æ‰‹åŠ¿</div><div class="line">- (BOOL)gestureRecognizerShouldBegin:(UIPanGestureRecognizer *)gestureRecognizer</div><div class="line">&#123;</div><div class="line">    // Ignore when no view controller is pushed into the navigation stack.</div><div class="line">    if (self.navigationController.viewControllers.count &lt;= 1) &#123;</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // Ignore when the active view controller doesn&apos;t allow interactive pop.</div><div class="line">    UIViewController *topViewController = self.navigationController.viewControllers.lastObject;</div><div class="line">    if (topViewController.fd_interactivePopDisabled) &#123;</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // Ignore when the beginning location is beyond max allowed initial distance to left edge.</div><div class="line">    CGPoint beginningLocation = [gestureRecognizer locationInView:gestureRecognizer.view];</div><div class="line">    CGFloat maxAllowedInitialDistance = topViewController.fd_interactivePopMaxAllowedInitialDistanceToLeftEdge;</div><div class="line">    if (maxAllowedInitialDistance &gt; 0 &amp;&amp; beginningLocation.x &gt; maxAllowedInitialDistance) &#123;</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Ignore pan gesture when the navigation controller is currently in transition.</div><div class="line">    if ([[self.navigationController valueForKey:@&quot;_isTransitioning&quot;] boolValue]) &#123;</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // Prevent calling the handler when the gesture begins in an opposite direction.</div><div class="line">    CGPoint translation = [gestureRecognizer translationInView:gestureRecognizer.view];</div><div class="line">    BOOL isLeftToRight = [UIApplication sharedApplication].userInterfaceLayoutDirection == UIUserInterfaceLayoutDirectionLeftToRight;</div><div class="line">    CGFloat multiplier = isLeftToRight ? 1 : - 1;</div><div class="line">    if ((translation.x * multiplier) &lt;= 0) &#123;</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return YES;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//åˆå§‹åŒ–è¿”å›æ‰‹åŠ¿</div><div class="line">- (UIPanGestureRecognizer *)fd_fullscreenPopGestureRecognizer</div><div class="line">&#123;</div><div class="line">    UIPanGestureRecognizer *panGestureRecognizer = objc_getAssociatedObject(self, _cmd);</div><div class="line"></div><div class="line">    if (!panGestureRecognizer) &#123;</div><div class="line">        panGestureRecognizer = [[UIPanGestureRecognizer alloc] init];</div><div class="line">        panGestureRecognizer.maximumNumberOfTouches = 1;</div><div class="line">        </div><div class="line">        objc_setAssociatedObject(self, _cmd, panGestureRecognizer, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">    &#125;</div><div class="line">    return panGestureRecognizer;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//åˆå§‹åŒ–è¿”å›æ‰‹åŠ¿çš„ä»£ç†</div><div class="line">- (_FDFullscreenPopGestureRecognizerDelegate *)fd_popGestureRecognizerDelegate</div><div class="line">&#123;</div><div class="line">    _FDFullscreenPopGestureRecognizerDelegate *delegate = objc_getAssociatedObject(self, _cmd);</div><div class="line"></div><div class="line">    if (!delegate) &#123;</div><div class="line">        delegate = [[_FDFullscreenPopGestureRecognizerDelegate alloc] init];</div><div class="line">        delegate.navigationController = self;</div><div class="line">        </div><div class="line">        objc_setAssociatedObject(self, _cmd, delegate, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">    &#125;</div><div class="line">    return delegate;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//hookç³»ç»Ÿçš„pushViewControlleræ–¹æ³•ï¼Œæ¯ä¸ªvcåœ¨è¢«pushåéƒ½ä¼šè°ƒç”¨fdçš„fd_pushViewControlleræ–¹æ³•</div><div class="line">+ (void)load</div><div class="line">&#123;</div><div class="line">    // Inject &quot;-pushViewController:animated:&quot;</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        Class class = [self class];</div><div class="line">        </div><div class="line">        SEL originalSelector = @selector(pushViewController:animated:);</div><div class="line">        SEL swizzledSelector = @selector(fd_pushViewController:animated:);</div><div class="line">        </div><div class="line">        Method originalMethod = class_getInstanceMethod(class, originalSelector);</div><div class="line">        Method swizzledMethod = class_getInstanceMethod(class, swizzledSelector);</div><div class="line">        </div><div class="line">        BOOL success = class_addMethod(class, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod));</div><div class="line">        if (success) &#123;</div><div class="line">            class_replaceMethod(class, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod));</div><div class="line">        &#125; else &#123;</div><div class="line">            method_exchangeImplementations(originalMethod, swizzledMethod);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//é‡è¦ä»£ç éƒ¨åˆ†ï¼Œè¿™é‡Œæ›¿æ¢ç³»ç»Ÿå³æ»‘æ‰‹åŠ¿ä¸ºfdè‡ªå·±çš„å¯¹è±¡ï¼Œå¹¶ç»™å¯¹è±¡è®¾ç½®fdè‡ªå®šä¹‰çš„delegate</div><div class="line">- (void)fd_pushViewController:(UIViewController *)viewController animated:(BOOL)animated</div><div class="line">&#123;</div><div class="line">    if (![self.interactivePopGestureRecognizer.view.gestureRecognizers containsObject:self.fd_fullscreenPopGestureRecognizer]) &#123;</div><div class="line">        </div><div class="line">        // Add our own gesture recognizer to where the onboard screen edge pan gesture recognizer is attached to.</div><div class="line">        [self.interactivePopGestureRecognizer.view addGestureRecognizer:self.fd_fullscreenPopGestureRecognizer];</div><div class="line"></div><div class="line">        // Forward the gesture events to the private handler of the onboard gesture recognizer.</div><div class="line">        NSArray *internalTargets = [self.interactivePopGestureRecognizer valueForKey:@&quot;targets&quot;];</div><div class="line">        id internalTarget = [internalTargets.firstObject valueForKey:@&quot;target&quot;];</div><div class="line">        SEL internalAction = NSSelectorFromString(@&quot;handleNavigationTransition:&quot;);</div><div class="line">        self.fd_fullscreenPopGestureRecognizer.delegate = self.fd_popGestureRecognizerDelegate;</div><div class="line">        [self.fd_fullscreenPopGestureRecognizer addTarget:internalTarget action:internalAction];</div><div class="line"></div><div class="line">        // Disable the onboard gesture recognizer.</div><div class="line">        self.interactivePopGestureRecognizer.enabled = NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // Handle perferred navigation bar appearance.</div><div class="line">    [self fd_setupViewControllerBasedNavigationBarAppearanceIfNeeded:viewController];</div><div class="line">    </div><div class="line">    // Forward to primary implementation.</div><div class="line">    if (![self.viewControllers containsObject:viewController]) &#123;</div><div class="line">        [self fd_pushViewController:viewController animated:animated];</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>ä¸Šé¢çš„ä»£ç å±•ç¤ºäº†fdæ˜¯æ€ä¹ˆä¸€æ­¥æ­¥çš„æ›¿æ¢äº†ç³»ç»Ÿçš„å³æ»‘æ‰‹åŠ¿çš„ï¼Œå…¶ä»–éƒ¨åˆ†æ¯”è¾ƒå¥½ç†è§£ï¼Œè¿™é‡Œæˆ‘ä»¬æ¥é‡ç‚¹çœ‹ä¸€ä¸‹æ›¿æ¢ä»£ç†çš„éƒ¨åˆ†ï¼Œå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">if (![self.interactivePopGestureRecognizer.view.gestureRecognizers containsObject:self.fd_fullscreenPopGestureRecognizer]) &#123;</div><div class="line">    </div><div class="line">    // Add our own gesture recognizer to where the onboard screen edge pan gesture recognizer is attached to.</div><div class="line">    [self.interactivePopGestureRecognizer.view addGestureRecognizer:self.fd_fullscreenPopGestureRecognizer];</div><div class="line"></div><div class="line">    // Forward the gesture events to the private handler of the onboard gesture recognizer.</div><div class="line">    NSArray *internalTargets = [self.interactivePopGestureRecognizer valueForKey:@&quot;targets&quot;];</div><div class="line">    id internalTarget = [internalTargets.firstObject valueForKey:@&quot;target&quot;];</div><div class="line">    SEL internalAction = NSSelectorFromString(@&quot;handleNavigationTransition:&quot;);</div><div class="line">    self.fd_fullscreenPopGestureRecognizer.delegate = self.fd_popGestureRecognizerDelegate;</div><div class="line">    [self.fd_fullscreenPopGestureRecognizer addTarget:internalTarget action:internalAction];</div><div class="line"></div><div class="line">    // Disable the onboard gesture recognizer.</div><div class="line">    self.interactivePopGestureRecognizer.enabled = NO;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œï¼Œå…ˆåˆ¤æ–­å½“å‰viewçš„æ‰‹åŠ¿åˆ—è¡¨ä¸­æ˜¯å¦åŒ…å«æˆ‘ä»¬è‡ªå®šä¹‰çš„å³æ»‘æ‰‹åŠ¿ï¼Œå¦‚æœä¸åŒ…å«ï¼Œå…ˆå°†è‡ªå®šä¹‰æ‰‹åŠ¿addåˆ°æ‰‹åŠ¿åˆ—è¡¨ä¸­ï¼Œç„¶åé‡ç‚¹æ¥äº†ï¼Œè·å–interactivePopGestureRecognizerè¿™ä¸ªç³»ç»Ÿå³æ»‘è¿”å›æ‰‹åŠ¿çš„æ‰€æœ‰target,ç„¶åå–å‡ºè¯¥æ‰‹åŠ¿çš„ç¬¬ä¸€å“åº”è€…ï¼Œç„¶åç”Ÿæˆç³»ç»Ÿè¿”å›æ‰‹åŠ¿å¤„ç†å‡½æ•°ï¼ˆhandleNavigationTransitionï¼‰çš„SELç»“æ„ä½“ï¼Œç„¶åè®¾ç½®è‡ªå®šä¹‰æ‰‹åŠ¿çš„ä»£ç†ï¼Œæœ€åå°†ç³»ç»Ÿçš„targetå’ŒSELæ·»åŠ ç»™è‡ªå®šä¹‰çš„æ‰‹åŠ¿å¯¹è±¡ï¼Œå¹¶å°†ç³»ç»Ÿçš„è¿”å›æ‰‹åŠ¿å…³é—­ã€‚è¿™æ ·ï¼Œfdå°±å¯ä»¥é€šè¿‡è‡ªå®šä¹‰çš„ä»£ç†æ§åˆ¶å³æ»‘è¿”å›äº†ã€‚</p>
<h3 id="éšè—å¯¼èˆªæ "><a href="#éšè—å¯¼èˆªæ " class="headerlink" title="éšè—å¯¼èˆªæ "></a>éšè—å¯¼èˆªæ </h3><p>çœ‹å®Œäº†å³æ»‘è¿”å›ï¼Œå†çœ‹ä¸€ä¸‹fdæ˜¯å¦‚ä½•éšè—ç³»ç»Ÿå¯¼èˆªæ çš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">+ (void)load</div><div class="line">&#123;</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        Class class = [self class];</div><div class="line">        </div><div class="line">        SEL originalSelector = @selector(viewWillAppear:);</div><div class="line">        SEL swizzledSelector = @selector(fd_viewWillAppear:);</div><div class="line">        </div><div class="line">        Method originalMethod = class_getInstanceMethod(class, originalSelector);</div><div class="line">        Method swizzledMethod = class_getInstanceMethod(class, swizzledSelector);</div><div class="line">        </div><div class="line">        BOOL success = class_addMethod(class, originalSelector, method_getImplementation(swizzledMethod), method_getTypeEncoding(swizzledMethod));</div><div class="line">        if (success) &#123;</div><div class="line">            class_replaceMethod(class, swizzledSelector, method_getImplementation(originalMethod), method_getTypeEncoding(originalMethod));</div><div class="line">        &#125; else &#123;</div><div class="line">            method_exchangeImplementations(originalMethod, swizzledMethod);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)fd_viewWillAppear:(BOOL)animated</div><div class="line">&#123;</div><div class="line">    // Forward to primary implementation.</div><div class="line">    [self fd_viewWillAppear:animated];</div><div class="line">    </div><div class="line">    if (self.fd_willAppearInjectBlock) &#123;</div><div class="line">        self.fd_willAppearInjectBlock(self, animated);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (_FDViewControllerWillAppearInjectBlock)fd_willAppearInjectBlock</div><div class="line">&#123;</div><div class="line">    return objc_getAssociatedObject(self, _cmd);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)setFd_willAppearInjectBlock:(_FDViewControllerWillAppearInjectBlock)block</div><div class="line">&#123;</div><div class="line">    objc_setAssociatedObject(self, @selector(fd_willAppearInjectBlock), block, OBJC_ASSOCIATION_COPY_NONATOMIC);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)fd_setupViewControllerBasedNavigationBarAppearanceIfNeeded:(UIViewController *)appearingViewController</div><div class="line">&#123;</div><div class="line">    if (!self.fd_viewControllerBasedNavigationBarAppearanceEnabled) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    __weak typeof(self) weakSelf = self;</div><div class="line">    _FDViewControllerWillAppearInjectBlock block = ^(UIViewController *viewController, BOOL animated) &#123;</div><div class="line">        __strong typeof(weakSelf) strongSelf = weakSelf;</div><div class="line">        if (strongSelf) &#123;</div><div class="line">            [strongSelf setNavigationBarHidden:viewController.fd_prefersNavigationBarHidden animated:animated];</div><div class="line">        &#125;</div><div class="line">    &#125;;</div><div class="line">    </div><div class="line">    // Setup will appear inject block to appearing view controller.</div><div class="line">    // Setup disappearing view controller as well, because not every view controller is added into</div><div class="line">    // stack by pushing, maybe by &quot;-setViewControllers:&quot;.</div><div class="line">    appearingViewController.fd_willAppearInjectBlock = block;</div><div class="line">    UIViewController *disappearingViewController = self.viewControllers.lastObject;</div><div class="line">    if (disappearingViewController &amp;&amp; !disappearingViewController.fd_willAppearInjectBlock) &#123;</div><div class="line">        disappearingViewController.fd_willAppearInjectBlock = block;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>éšè—è¿™ä¸ªå°±æ¯”è¾ƒç®€å•äº†ï¼Œä¹Ÿæ˜¯åœ¨fd_pushViewControlleré‡Œé¢å¤„ç†çš„ï¼Œå…·ä½“è¯´ä¸€ä¸‹ï¼Œè¿™é‡Œå…ˆç”Ÿæˆä¸€ä¸ªç”¨æ¥éšè—å¯¼èˆªæ çš„blockï¼Œä½¿ç”¨çš„æ–¹æ³•è¿˜æ˜¯ç³»ç»Ÿçš„setNavigationBarHiddenï¼šanimation æ–¹å¼ã€‚ç„¶åå°†è¿™ä¸ªblockèµ‹å€¼ç»™self.fd_willAppearInjectBlockï¼Œç„¶åå†æ¯æ¬¡fd_viewWillAppearæ—¶ï¼Œä¼šè°ƒç”¨ä¸€ä¸‹è¿™ä¸ªblockã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>å¯ä»¥çœ‹åˆ°ï¼Œä»£ç å¤§é‡çš„ä½¿ç”¨runtimeæ¥ç¼–å†™ï¼Œå­¦ä¹ ä¸€éä¸‹æ¥å¯¹åº”runtimeç›¸å…³çš„å†…å®¹ä¼šæœ‰æ›´æ·±åˆ»çš„è®¤è¯†ã€‚ç„¶åå°±æ˜¯fdæ›¿æ¢ç³»ç»Ÿæ–¹æ³•çš„è¿™ç§éªšæ“ä½œï¼Œå¦‚æœæœ‰ç±»ä¼¼çš„éœ€æ±‚çš„è¯ä¹Ÿæ˜¯å¯ä»¥å‚è€ƒçš„ã€‚è¿™ä¸ªåº“ä»£ç ä¹Ÿä¸å¤ªå¤šï¼Œå†…å®¹ä¹Ÿæ¯”è¾ƒå¥½ç†è§£ï¼Œä¸ªäººè§‰å¾—æœ‰å­¦ä¹ çš„ä»·å€¼ã€‚</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/06/19/SDWebImageå­¦ä¹ ç¬”è®°/" itemprop="url">
                  SDWebImageå­¦ä¹ ç¬”è®°
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2018-06-19T11:09:20+08:00" content="2018-06-19">
              2018-06-19
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/06/19/SDWebImageå­¦ä¹ ç¬”è®°/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/06/19/SDWebImageå­¦ä¹ ç¬”è®°/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/SDWebImage/sd1.png" alt=""></p>
<p>ä¸Šå›¾æŒ‰æ¨¡å—æ•´ç†äº†sdå„æ¨¡å—çš„ç±»</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/SDWebImage/sd2.png" alt=""></p>
<p>ä¸Šå›¾åˆ™è¡¨ç¤ºäº†å„æ¨¡å—å’Œç±»åœ¨æ•´ç†é¡¹ç›®ä¸­çš„å±‚çº§å…³ç³»ã€‚</p>
<p>æ ¹æ®ä¸Šé¢çš„æ¨¡å—å›¾ï¼Œæˆ‘è¿™é‡Œå…ˆæŒ‰ç…§æ¨¡å—å¯¹æºç è¿›è¡Œå­¦ä¹ å’Œåˆ†æã€‚</p>
<h3 id="ä¸‹è½½æ¨¡å—"><a href="#ä¸‹è½½æ¨¡å—" class="headerlink" title="ä¸‹è½½æ¨¡å—"></a>ä¸‹è½½æ¨¡å—</h3><p>å› ä¸ºä¹‹å‰çœ‹äº†afï¼Œsdçš„ä¸‹è½½æ¨¡å—åº”è¯¥ä¹Ÿæ˜¯åŸºäºNSUrlSessionå°è£…çš„ï¼Œæ‰€ä»¥å…ˆçœ‹ä¸‹è½½æ¨¡å—ã€‚</p>
<h4 id="SDWebImageDownloaderOperation"><a href="#SDWebImageDownloaderOperation" class="headerlink" title="SDWebImageDownloaderOperation"></a>SDWebImageDownloaderOperation</h4><p>SDWebImageDownloaderOperationæ˜¯ç»§æ‰¿è‡ªç³»ç»Ÿçš„NSOperation,ç„¶åè‡ªå·±å®ç°äº†ä¸€å¥—å¼‚æ­¥æ“ä½œçš„ç›¸å…³æ“ä½œã€‚è¿™é‡Œä¸å±•å¼€è®²è‡ªå®šä¹‰NSOprationéœ€è¦åšå“ªäº›äº‹æƒ…ï¼Œç½‘ä¸Šåº”è¯¥æœ‰å¾ˆå¤šç›¸å…³demoå’Œæ–‡ç« ã€‚</p>
<p>SDWebImageDownloaderOperationçš„å†…éƒ¨é€šè¿‡NSUrlSessionåˆ›å»ºtaskè¿›è¡Œå›¾ç‰‡çš„ä¸‹è½½ï¼Œæ¯ä¸ªrequestçš„httpmethodé»˜è®¤ä¸ºGETæ–¹å¼ï¼Œè¿™ä¹Ÿæ–¹ä¾¿æ‹¿åˆ°ä¸‹è½½è¿‡ç¨‹ä¸­çš„å›¾ç‰‡æ•°æ®ã€‚</p>
<p>SDWebImageDownloaderOperationé‡Œé¢ä½¿ç”¨NSURLCacheå¯¹URLçš„resopneè¿›è¡Œç¼“å­˜ï¼Œä»£ç å¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">if (self.options &amp; SDWebImageDownloaderIgnoreCachedResponse) &#123;</div><div class="line">    // Grab the cached data for later check</div><div class="line">    NSURLCache *URLCache = session.configuration.URLCache;</div><div class="line">    if (!URLCache) &#123;</div><div class="line">        URLCache = [NSURLCache sharedURLCache];</div><div class="line">    &#125;</div><div class="line">    NSCachedURLResponse *cachedResponse;</div><div class="line">    // NSURLCache&apos;s `cachedResponseForRequest:` is not thread-safe, see https://developer.apple.com/documentation/foundation/nsurlcache#2317483</div><div class="line">    @synchronized (URLCache) &#123;</div><div class="line">        cachedResponse = [URLCache cachedResponseForRequest:self.request];</div><div class="line">    &#125;</div><div class="line">    if (cachedResponse) &#123;</div><div class="line">        self.cachedData = cachedResponse.data;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>URLCacheç›¸å…³å†…å®¹å¯ä»¥<a href="http://nshipster.cn/nsurlcache/" target="_blank" rel="noopener">å‚è€ƒè¿™ä¸€ç¯‡æ–‡ç« </a></p>
<p>SDWebImageDownloaderOperationåŒæ—¶æ”¯æŒäº†åå°ä¸‹è½½ï¼Œä»£ç å¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">Class UIApplicationClass = NSClassFromString(@&quot;UIApplication&quot;);</div><div class="line">BOOL hasApplication = UIApplicationClass &amp;&amp; [UIApplicationClass respondsToSelector:@selector(sharedApplication)];</div><div class="line">if (hasApplication &amp;&amp; [self shouldContinueWhenAppEntersBackground]) &#123;</div><div class="line">    __weak __typeof__ (self) wself = self;</div><div class="line">    UIApplication * app = [UIApplicationClass performSelector:@selector(sharedApplication)];</div><div class="line">    self.backgroundTaskId = [app beginBackgroundTaskWithExpirationHandler:^&#123;</div><div class="line">        __strong __typeof (wself) sself = wself;</div><div class="line"></div><div class="line">        if (sself) &#123;</div><div class="line">            [sself cancel];</div><div class="line"></div><div class="line">            [app endBackgroundTask:sself.backgroundTaskId];</div><div class="line">            sself.backgroundTaskId = UIBackgroundTaskInvalid;</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>SDWebImageDownloaderOperationå°†æ¯ä¸ªtaskçš„progresså›è°ƒå’ŒCompleteå›è°ƒå­˜æ”¾åœ¨ä¸€ä¸ª <em>callbackBlocks</em> çš„æ•°ç»„ä¸­ï¼Œæ–¹ä¾¿åœ¨æ”¶åˆ°NSURLSessionDelegateçš„ä»£ç†æ—¶è°ƒç”¨ç›¸å¯¹åº”çš„block,å°†æ•°æ®ä¼ å‡ºå»ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">//æ·»åŠ äº†æŸ¥æ‰¾block</div><div class="line"></div><div class="line">- (nullable id)addHandlersForProgress:(nullable SDWebImageDownloaderProgressBlock)progressBlock</div><div class="line">                            completed:(nullable SDWebImageDownloaderCompletedBlock)completedBlock &#123;</div><div class="line">    SDCallbacksDictionary *callbacks = [NSMutableDictionary new];</div><div class="line">    if (progressBlock) callbacks[kProgressCallbackKey] = [progressBlock copy];</div><div class="line">    if (completedBlock) callbacks[kCompletedCallbackKey] = [completedBlock copy];</div><div class="line">    LOCK(self.callbacksLock);</div><div class="line">    [self.callbackBlocks addObject:callbacks];</div><div class="line">    UNLOCK(self.callbacksLock);</div><div class="line">    return callbacks;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (nullable NSArray&lt;id&gt; *)callbacksForKey:(NSString *)key &#123;</div><div class="line">    LOCK(self.callbacksLock);</div><div class="line">    NSMutableArray&lt;id&gt; *callbacks = [[self.callbackBlocks valueForKey:key] mutableCopy];</div><div class="line">    UNLOCK(self.callbacksLock);</div><div class="line">    // We need to remove [NSNull null] because there might not always be a progress block for each callback</div><div class="line">    [callbacks removeObjectIdenticalTo:[NSNull null]];</div><div class="line">    return [callbacks copy]; // strip mutability here</div><div class="line">&#125;</div><div class="line"></div><div class="line">//è°ƒç”¨Progress block</div><div class="line">for (SDWebImageDownloaderProgressBlock progressBlock in [self callbacksForKey:kProgressCallbackKey]) &#123;</div><div class="line">    progressBlock(self.imageData.length, self.expectedSize, self.request.URL);</div><div class="line">&#125;</div><div class="line"></div><div class="line">//è°ƒç”¨Complete block</div><div class="line"></div><div class="line">[self callCompletionBlocksWithImage:image imageData:nil error:nil finished:NO];</div><div class="line"></div><div class="line">- (void)callCompletionBlocksWithImage:(nullable UIImage *)image</div><div class="line">                            imageData:(nullable NSData *)imageData</div><div class="line">                                error:(nullable NSError *)error</div><div class="line">                             finished:(BOOL)finished &#123;</div><div class="line">    NSArray&lt;id&gt; *completionBlocks = [self callbacksForKey:kCompletedCallbackKey];</div><div class="line">    dispatch_main_async_safe(^&#123;</div><div class="line">        for (SDWebImageDownloaderCompletedBlock completedBlock in completionBlocks) &#123;</div><div class="line">            completedBlock(image, imageData, error, finished);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨æ”¶åˆ°didReceiveDataå›è°ƒåï¼Œå¦‚æœå½“å‰optionsä¸ºSDWebImageDownloaderProgressiveDownloadçš„è¯ï¼Œè¿˜éœ€è¦å°†æ”¶åˆ°çš„è¿™éƒ¨åˆ†å›¾ç‰‡æ•°æ®è¿›è¡Œè§£ç åæ˜¾ç¤ºï¼Œæ˜¾ç„¶è¿™ä¸æ˜¯å®Œæ•´çš„æ•°æ®ï¼Œä¸è¿‡è¿™éƒ¨åˆ†æ•°æ®ä¹Ÿæ˜¯å¯ä»¥æ­£å¸¸æ˜¾ç¤ºçš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div></pre></td><td class="code"><pre><div class="line">if (!self.progressiveCoder) &#123;</div><div class="line">    // We need to create a new instance for progressive decoding to avoid conflicts</div><div class="line">    for (id&lt;SDWebImageCoder&gt;coder in [SDWebImageCodersManager sharedInstance].coders) &#123;</div><div class="line">        if ([coder conformsToProtocol:@protocol(SDWebImageProgressiveCoder)] &amp;&amp;</div><div class="line">            [((id&lt;SDWebImageProgressiveCoder&gt;)coder) canIncrementallyDecodeFromData:imageData]) &#123;</div><div class="line">            self.progressiveCoder = [[[coder class] alloc] init];</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">    </div><div class="line">// progressive decode the image in coder queue</div><div class="line">dispatch_async(self.coderQueue, ^&#123;</div><div class="line">    UIImage *image = [self.progressiveCoder incrementallyDecodedImageWithData:imageData finished:finished];</div><div class="line">    if (image) &#123;</div><div class="line">        NSString *key = [[SDWebImageManager sharedManager] cacheKeyForURL:self.request.URL];</div><div class="line">        image = [self scaledImageForKey:key image:image];</div><div class="line">        if (self.shouldDecompressImages) &#123;</div><div class="line">            image = [[SDWebImageCodersManager sharedInstance] decompressedImageWithImage:image data:&amp;imageData options:@&#123;SDWebImageCoderScaleDownLargeImagesKey: @(NO)&#125;];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        // We do not keep the progressive decoding image even when `finished`=YES. Because they are for view rendering but not take full function from downloader options. And some coders implementation may not keep consistent between progressive decoding and normal decoding.</div><div class="line">        </div><div class="line">        [self callCompletionBlocksWithImage:image imageData:nil error:nil finished:NO];</div><div class="line">    &#125;</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>åœ¨æ”¶åˆ°didCompleteWithErrorå›è°ƒåï¼Œä¼šå¼‚æ­¥è§£ç æ”¶åˆ°çš„imageæ•°æ®,gifå’Œwebpé™¤å¤–ï¼Œè¿™ä¸¤ä¼šèµ°å¦å¤–çš„è§£ç æ¥å£ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">// decode the image in coder queue</div><div class="line">dispatch_async(self.coderQueue, ^&#123;</div><div class="line">    UIImage *image = [[SDWebImageCodersManager sharedInstance] decodedImageWithData:imageData];</div><div class="line">    NSString *key = [[SDWebImageManager sharedManager] cacheKeyForURL:self.request.URL];</div><div class="line">    image = [self scaledImageForKey:key image:image];</div><div class="line">    </div><div class="line">    BOOL shouldDecode = YES;</div><div class="line">    // Do not force decoding animated GIFs and WebPs</div><div class="line">    if (image.images) &#123;</div><div class="line">        shouldDecode = NO;</div><div class="line">    &#125; else &#123;</div><div class="line">#ifdef SD_WEBP</div><div class="line">        SDImageFormat imageFormat = [NSData sd_imageFormatForImageData:imageData];</div><div class="line">        if (imageFormat == SDImageFormatWebP) &#123;</div><div class="line">            shouldDecode = NO;</div><div class="line">        &#125;</div><div class="line">#endif</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (shouldDecode) &#123;</div><div class="line">        if (self.shouldDecompressImages) &#123;</div><div class="line">            BOOL shouldScaleDown = self.options &amp; SDWebImageDownloaderScaleDownLargeImages;</div><div class="line">            image = [[SDWebImageCodersManager sharedInstance] decompressedImageWithImage:image data:&amp;imageData options:@&#123;SDWebImageCoderScaleDownLargeImagesKey: @(shouldScaleDown)&#125;];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    CGSize imageSize = image.size;</div><div class="line">    if (imageSize.width == 0 || imageSize.height == 0) &#123;</div><div class="line">        [self callCompletionBlocksWithError:[NSError errorWithDomain:SDWebImageErrorDomain code:0 userInfo:@&#123;NSLocalizedDescriptionKey : @&quot;Downloaded image has 0 pixels&quot;&#125;]];</div><div class="line">    &#125; else &#123;</div><div class="line">        [self callCompletionBlocksWithImage:image imageData:imageData error:nil finished:YES];</div><div class="line">    &#125;</div><div class="line">    [self done];</div><div class="line">&#125;);</div></pre></td></tr></table></figure>
<p>sdåšhttpsçš„è¯ä¹¦éªŒè¯æ–¹æ³•å¾ˆç®€å•ï¼Œå¦‚æœè‡ªå®šä¹‰çš„è¯ä¹¦ä¸ä¸ºç©ºï¼Œåˆ™è¿”å›è‡ªå®šä¹‰çš„è¯ä¹¦ï¼Œä¸ºç©ºçš„è¯ï¼Œç›´æ¥å°†æœåŠ¡å™¨çš„è¯ä¹¦è¿”å›å¹¶æ ‡è¯†éªŒè¯æˆåŠŸï¼Œæ‰€ä»¥å®é™…ä¸Šå®ƒè¿™é‡Œåªæ˜¯ç®€å•çš„è¿”å›è¯ä¹¦ï¼Œå¹¶æ²¡æœ‰å¯¹è¯ä¹¦åšä¸€ä¸ªæ ¡éªŒã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">- (void)URLSession:(NSURLSession *)session task:(NSURLSessionTask *)task didReceiveChallenge:(NSURLAuthenticationChallenge *)challenge completionHandler:(void (^)(NSURLSessionAuthChallengeDisposition disposition, NSURLCredential *credential))completionHandler &#123;</div><div class="line">    </div><div class="line">    NSURLSessionAuthChallengeDisposition disposition = NSURLSessionAuthChallengePerformDefaultHandling;</div><div class="line">    __block NSURLCredential *credential = nil;</div><div class="line">    </div><div class="line">    if ([challenge.protectionSpace.authenticationMethod isEqualToString:NSURLAuthenticationMethodServerTrust]) &#123;</div><div class="line">        if (!(self.options &amp; SDWebImageDownloaderAllowInvalidSSLCertificates)) &#123;</div><div class="line">            disposition = NSURLSessionAuthChallengePerformDefaultHandling;</div><div class="line">        &#125; else &#123;</div><div class="line">            credential = [NSURLCredential credentialForTrust:challenge.protectionSpace.serverTrust];</div><div class="line">            disposition = NSURLSessionAuthChallengeUseCredential;</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        if (challenge.previousFailureCount == 0) &#123;</div><div class="line">            if (self.credential) &#123;</div><div class="line">                credential = self.credential;</div><div class="line">                disposition = NSURLSessionAuthChallengeUseCredential;</div><div class="line">            &#125; else &#123;</div><div class="line">                disposition = NSURLSessionAuthChallengeCancelAuthenticationChallenge;</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            disposition = NSURLSessionAuthChallengeCancelAuthenticationChallenge;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (completionHandler) &#123;</div><div class="line">        completionHandler(disposition, credential);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="SDWebImageDownloader"><a href="#SDWebImageDownloader" class="headerlink" title="SDWebImageDownloader"></a>SDWebImageDownloader</h4><p>SDWebImageDownloaderæ˜¯SDWebImageDownloaderOperationçš„ç®¡ç†ç±»ï¼Œå’Œafä¸åŒçš„æ˜¯ï¼ŒSDWebImageDownloaderåˆ›å»ºäº†ä¸€ä¸ªNSOperationQueueï¼Œç®¡ç†æ¯ä¸ªnsoperationã€‚å½“nsoperationè¢«æ ‡è®°ä¸ºfinishæˆ–è€…cancelåï¼Œä¼šè‡ªåŠ¨ä»Queueä¸­ç§»é™¤ã€‚</p>
<p>çœ‹ä¸€ä¸‹SDWebImageDownloaderæ˜¯å¦‚ä½•ç®¡ç†operationçš„ï¼Œæ¯”è¾ƒé‡è¦çš„å°±æ˜¯ä¸‹é¢è¿™ä¸€æ®µä»£ç äº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">- (nullable SDWebImageDownloadToken *)addProgressCallback:(SDWebImageDownloaderProgressBlock)progressBlock</div><div class="line">                                           completedBlock:(SDWebImageDownloaderCompletedBlock)completedBlock</div><div class="line">                                                   forURL:(nullable NSURL *)url</div><div class="line">                                           createCallback:(SDWebImageDownloaderOperation *(^)(void))createCallback &#123;</div><div class="line">    // The URL will be used as the key to the callbacks dictionary so it cannot be nil. If it is nil immediately call the completed block with no image or data.</div><div class="line">    if (url == nil) &#123;</div><div class="line">        if (completedBlock != nil) &#123;</div><div class="line">            completedBlock(nil, nil, nil, NO);</div><div class="line">        &#125;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    LOCK(self.operationsLock);</div><div class="line">    SDWebImageDownloaderOperation *operation = [self.URLOperations objectForKey:url];</div><div class="line">    // There is a case that the operation may be marked as finished, but not been removed from `self.URLOperations`.</div><div class="line">    if (!operation || operation.isFinished) &#123;</div><div class="line">        operation = createCallback();</div><div class="line">        __weak typeof(self) wself = self;</div><div class="line">        operation.completionBlock = ^&#123;</div><div class="line">            __strong typeof(wself) sself = wself;</div><div class="line">            if (!sself) &#123;</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line">            LOCK(sself.operationsLock);</div><div class="line">            [sself.URLOperations removeObjectForKey:url];</div><div class="line">            UNLOCK(sself.operationsLock);</div><div class="line">        &#125;;</div><div class="line">        [self.URLOperations setObject:operation forKey:url];</div><div class="line">        // Add operation to operation queue only after all configuration done according to Apple&apos;s doc.</div><div class="line">        // `addOperation:` does not synchronously execute the `operation.completionBlock` so this will not cause deadlock.</div><div class="line">        [self.downloadQueue addOperation:operation];</div><div class="line">    &#125;</div><div class="line">    UNLOCK(self.operationsLock);</div><div class="line"></div><div class="line">    id downloadOperationCancelToken = [operation addHandlersForProgress:progressBlock completed:completedBlock];</div><div class="line">    </div><div class="line">    SDWebImageDownloadToken *token = [SDWebImageDownloadToken new];</div><div class="line">    token.downloadOperation = operation;</div><div class="line">    token.url = url;</div><div class="line">    token.downloadOperationCancelToken = downloadOperationCancelToken;</div><div class="line"></div><div class="line">    return token;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>sdå°†æ¯ä¸€ä¸ªoperationå­˜åœ¨URLOperationsé‡Œé¢ï¼Œkeyæ˜¯urlï¼Œvalueæ˜¯operation,å½“éœ€è¦åˆ›å»ºä¸€ä¸ªä¸‹è½½ä»»åŠ¡æ—¶ï¼Œå…ˆä»è¿™ä¸ªURLOperationsçš„å­—å…¸ä¸­æŸ¥æ‰¾æ˜¯å¦å·²ç»æœ‰å¯¹åº”çš„ä¸‹è½½ä»»åŠ¡ï¼Œå¦‚æœæ²¡æœ‰çš„è¯ï¼Œå°†createCallbackï¼ˆï¼‰è¿™ä¸ªblockçš„è¿”å›å€¼èµ‹å€¼ç»™ä¸€ä¸ªæ–°çš„operationå¯¹è±¡ï¼ˆå¹¶åœ¨oprationçš„å®Œæˆå—ä¸­å°†å®ƒä»URLOperationså­—å…¸ä¸­ç§»é™¤ï¼‰ï¼Œç»™oprationæ·»åŠ ç›¸åº”çš„progressBlockå’ŒcompleteBlock,åå°†å®ƒå­˜å…¥URLOperationsä¸­ï¼Œå¹¶åˆ›å»ºoprationå¯¹åº”çš„SDWebImageDownloadTokenå¯¹è±¡ï¼Œå†å°†è¯¥tokenå¯¹è±¡è¿”å›ã€‚</p>
<p>ä¸Šé¢è¿™æ®µæè¿°ä¸­æœ‰2ä¸ªåœ°æ–¹éœ€è¦æ³¨æ„ä¸‹ï¼š</p>
<p>ç¬¬ä¸€ä¸ªæ˜¯createCallbackï¼ˆï¼‰è¿™ä¸ªæ˜¯ä¸ªå•¥ï¼Ÿçœ‹çœ‹ä¸‹é¢è¿™æ®µä»£ç å°±ä¼šæ˜ç™½ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">- (nullable SDWebImageDownloadToken *)downloadImageWithURL:(nullable NSURL *)url</div><div class="line">                                                   options:(SDWebImageDownloaderOptions)options</div><div class="line">                                                  progress:(nullable SDWebImageDownloaderProgressBlock)progressBlock</div><div class="line">                                                 completed:(nullable SDWebImageDownloaderCompletedBlock)completedBlock &#123;</div><div class="line">    __weak SDWebImageDownloader *wself = self;</div><div class="line"></div><div class="line">    return [self addProgressCallback:progressBlock completedBlock:completedBlock forURL:url createCallback:^SDWebImageDownloaderOperation *&#123;</div><div class="line">        __strong __typeof (wself) sself = wself;</div><div class="line">        NSTimeInterval timeoutInterval = sself.downloadTimeout;</div><div class="line">        if (timeoutInterval == 0.0) &#123;</div><div class="line">            timeoutInterval = 15.0;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        // In order to prevent from potential duplicate caching (NSURLCache + SDImageCache) we disable the cache for image requests if told otherwise</div><div class="line">        NSURLRequestCachePolicy cachePolicy = options &amp; SDWebImageDownloaderUseNSURLCache ? NSURLRequestUseProtocolCachePolicy : NSURLRequestReloadIgnoringLocalCacheData;</div><div class="line">        NSMutableURLRequest *request = [[NSMutableURLRequest alloc] initWithURL:url</div><div class="line">                                                                    cachePolicy:cachePolicy</div><div class="line">                                                                timeoutInterval:timeoutInterval];</div><div class="line">        </div><div class="line">        request.HTTPShouldHandleCookies = (options &amp; SDWebImageDownloaderHandleCookies);</div><div class="line">        request.HTTPShouldUsePipelining = YES;</div><div class="line">        if (sself.headersFilter) &#123;</div><div class="line">            request.allHTTPHeaderFields = sself.headersFilter(url, [sself allHTTPHeaderFields]);</div><div class="line">        &#125;</div><div class="line">        else &#123;</div><div class="line">            request.allHTTPHeaderFields = [sself allHTTPHeaderFields];</div><div class="line">        &#125;</div><div class="line">        SDWebImageDownloaderOperation *operation = [[sself.operationClass alloc] initWithRequest:request inSession:sself.session options:options];</div><div class="line">        operation.shouldDecompressImages = sself.shouldDecompressImages;</div><div class="line">        </div><div class="line">        if (sself.urlCredential) &#123;</div><div class="line">            operation.credential = sself.urlCredential;</div><div class="line">        &#125; else if (sself.username &amp;&amp; sself.password) &#123;</div><div class="line">            operation.credential = [NSURLCredential credentialWithUser:sself.username password:sself.password persistence:NSURLCredentialPersistenceForSession];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        if (options &amp; SDWebImageDownloaderHighPriority) &#123;</div><div class="line">            operation.queuePriority = NSOperationQueuePriorityHigh;</div><div class="line">        &#125; else if (options &amp; SDWebImageDownloaderLowPriority) &#123;</div><div class="line">            operation.queuePriority = NSOperationQueuePriorityLow;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        if (sself.executionOrder == SDWebImageDownloaderLIFOExecutionOrder) &#123;</div><div class="line">            // Emulate LIFO execution order by systematically adding new operations as last operation&apos;s dependency</div><div class="line">            [sself.lastAddedOperation addDependency:operation];</div><div class="line">            sself.lastAddedOperation = operation;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return operation;</div><div class="line">    &#125;];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>createCallbackå…¶å®å°±æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„downloadoperationï¼Œç„¶åå°†è¿™ä¸ªdownloadoperationè¿”å›ã€‚</p>
<p>ç¬¬äºŒä¸ªé—®é¢˜æ˜¯SDWebImageDownloadTokenè¿™ä¸ªç±»æ˜¯ç”¨æ¥å¹²å˜›çš„ï¼Œä¹Ÿæ˜¯çœ‹ä¸€ä¸‹ä¸‹é¢è¿™ä¸ªæ–¹æ³•åº”è¯¥å°±æ¸…æ¥šäº†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">- (void)cancel:(nullable SDWebImageDownloadToken *)token &#123;</div><div class="line">    NSURL *url = token.url;</div><div class="line">    if (!url) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    LOCK(self.operationsLock);</div><div class="line">    SDWebImageDownloaderOperation *operation = [self.URLOperations objectForKey:url];</div><div class="line">    if (operation) &#123;</div><div class="line">        BOOL canceled = [operation cancel:token.downloadOperationCancelToken];</div><div class="line">        if (canceled) &#123;</div><div class="line">            [self.URLOperations removeObjectForKey:url];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    UNLOCK(self.operationsLock);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>token.urlä¸ºä¸‹è½½çš„æ–‡ä»¶url,operationä¸ºå½“å‰ä¸‹è½½è¿™ä¸ªæ–‡ä»¶çš„ä»»åŠ¡ï¼ŒdownloadOperationCancelTokenå®é™…ä¸Šæ˜¯ä¸€ä¸ªå­—å…¸ï¼Œé‡Œé¢å­˜äº†è¿™ä¸ªä»»åŠ¡çš„progressBlockå’ŒcompletedBlockï¼Œä¿å­˜è¿™ä¸ªä¸»è¦æ˜¯ä¸ºäº†å–æ¶ˆçš„æ—¶å€™æŠŠoperationä¸­ä¿å­˜çš„è¿™ä¸¤blockç»™ç§»é™¤æ‰ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹å°±æ˜¯ï¼Œè¿™ä¸ªSDWebImageDownloadTokenå¯¹è±¡å…¶å®å°±æ˜¯ç”¨åœ¨cancelçš„æ—¶å€™ç§»é™¤ä¹‹å‰ä¿å­˜åœ¨ç›¸å…³å­—å…¸ä¸­çš„æ•°æ®çš„ã€‚åœ¨SDWebImageManagerä¸­ä¹Ÿæ˜¯è¿™ä¹ˆç”¨çš„ã€‚</p>
<h3 id="ç¼“å­˜æ¨¡å—"><a href="#ç¼“å­˜æ¨¡å—" class="headerlink" title="ç¼“å­˜æ¨¡å—"></a>ç¼“å­˜æ¨¡å—</h3><p>çœ‹å®Œä¸‹è½½æ¨¡å—ï¼Œå†æ¥çœ‹ä¸€ä¸‹ç¼“å­˜æ¨¡å—ã€‚å¤§å®¶éƒ½çŸ¥é“sdé‡Œé¢çš„ç¼“å­˜ç”¨åˆ°äº†NSCache,é‚£å®ƒåˆ°åº•æ˜¯å’‹ç”¨çš„å‘¢ï¼Œæˆ‘ä»¬å…·ä½“çœ‹ä¸€ä¸‹å§ã€‚</p>
<h4 id="SDImageCacheConfig"><a href="#SDImageCacheConfig" class="headerlink" title="SDImageCacheConfig"></a>SDImageCacheConfig</h4><p>å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªconfigç±»ä¸­éƒ½å®šä¹‰äº†å“ªäº›å˜é‡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">static const NSInteger kDefaultCacheMaxCacheAge = 60 * 60 * 24 * 7; // 1 week</div><div class="line"></div><div class="line">@implementation SDImageCacheConfig</div><div class="line"></div><div class="line">- (instancetype)init &#123;</div><div class="line">    if (self = [super init]) &#123;</div><div class="line">    	//éœ€è¦è§£ç </div><div class="line">        _shouldDecompressImages = YES;</div><div class="line">        //ä¸é€‚ç”¨iCloudå­˜å‚¨</div><div class="line">        _shouldDisableiCloud = YES;</div><div class="line">        //å­˜åˆ°å†…å­˜</div><div class="line">        _shouldCacheImagesInMemory = YES;</div><div class="line">        //ç³»ç»Ÿè¯»å†™ç›¸å…³å±æ€§</div><div class="line">        _diskCacheReadingOptions = 0;</div><div class="line">        _diskCacheWritingOptions = NSDataWritingAtomic;</div><div class="line">        //è¿‡æœŸæ—¶é—´</div><div class="line">        _maxCacheAge = kDefaultCacheMaxCacheAge;</div><div class="line">        //æœ€å¤§å­˜å‚¨ç©ºé—´ 0åˆ™ä¸ºæ²¡æœ‰é™åˆ¶</div><div class="line">        _maxCacheSize = 0;</div><div class="line">    &#125;</div><div class="line">    return self;</div><div class="line">&#125;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<h4 id="SDImageCache"><a href="#SDImageCache" class="headerlink" title="SDImageCache"></a>SDImageCache</h4><p>NSCacheç›¸å…³å†…å®¹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">// A memory cache which auto purge the cache on memory warning and support weak cache.</div><div class="line">@interface SDMemoryCache &lt;KeyType, ObjectType&gt; : NSCache &lt;KeyType, ObjectType&gt;</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line">// Private</div><div class="line">@interface SDMemoryCache &lt;KeyType, ObjectType&gt; ()</div><div class="line"></div><div class="line">@property (nonatomic, strong, nonnull) NSMapTable&lt;KeyType, ObjectType&gt; *weakCache; // strong-weak cache</div><div class="line">@property (nonatomic, strong, nonnull) dispatch_semaphore_t weakCacheLock; // a lock to keep the access to `weakCache` thread-safe</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°sdè‡ªå®šä¹‰äº†ä¸€ä¸ªç»§æ‰¿è‡ªNSCacheçš„ç±»ï¼Œå¹¶ç”³æ˜äº†ä¸€ä¸ªNSMapTableç±»å‹çš„å±æ€§weakCacheï¼Œç›´æ¥ç”¨NSCacheä¸å°±å¯ä»¥å­˜å‚¨å˜é‡åˆ°å†…å­˜äº†å—ï¼Œè¿™é‡Œä¸ºå•¥è¿˜è¦åŠ ä¸€ä¸ªNSMapTableå‘¢ã€‚æˆ‘ä»¬å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªNSMapTableçš„åˆå§‹åŒ–ï¼ˆ<a href="http://www.isaced.com/post-235.html" target="_blank" rel="noopener">NSMapTableç›¸å…³å†…å®¹å‚è€ƒè¿™é‡Œ</a>ï¼‰</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">self.weakCache = [[NSMapTable alloc] initWithKeyOptions:NSPointerFunctionsStrongMemory valueOptions:NSPointerFunctionsWeakMemory capacity:0];</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼ŒNSMapTableä¸­å­˜åœ¨å€¼éƒ½æ˜¯weakçš„ï¼Œå¦‚æœvalueè¢«é‡Šæ”¾ï¼Œåˆ™å­˜çš„å€¼å°†å˜ä¸ºç©ºï¼Œç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹è‡ªå®šä¹‰çš„SDMemoryCacheç±»çš„getå’Œsetæ–¹æ³•ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">// `setObject:forKey:` just call this with 0 cost. Override this is enough</div><div class="line">- (void)setObject:(id)obj forKey:(id)key cost:(NSUInteger)g &#123;</div><div class="line">    [super setObject:obj forKey:key cost:g];</div><div class="line">    if (key &amp;&amp; obj) &#123;</div><div class="line">        // Store weak cache</div><div class="line">        LOCK(self.weakCacheLock);</div><div class="line">        [self.weakCache setObject:obj forKey:key];</div><div class="line">        UNLOCK(self.weakCacheLock);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (id)objectForKey:(id)key &#123;</div><div class="line">    id obj = [super objectForKey:key];</div><div class="line">    if (key &amp;&amp; !obj) &#123;</div><div class="line">        // Check weak cache</div><div class="line">        LOCK(self.weakCacheLock);</div><div class="line">        obj = [self.weakCache objectForKey:key];</div><div class="line">        UNLOCK(self.weakCacheLock);</div><div class="line">        if (obj) &#123;</div><div class="line">            // Sync cache</div><div class="line">            NSUInteger cost = 0;</div><div class="line">            if ([obj isKindOfClass:[UIImage class]]) &#123;</div><div class="line">                cost = SDCacheCostForImage(obj);</div><div class="line">            &#125;</div><div class="line">            [super setObject:obj forKey:key cost:cost];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return obj;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯¹å†…å­˜ä¸­å›¾ç‰‡çš„å­˜å–éƒ½æ˜¯åšäº†2æ¬¡æ“ä½œï¼Œä¸€æ¬¡æ˜¯å­˜åˆ°NSCacheä¸­ï¼Œä¸€æ¬¡æ˜¯å­˜åˆ°NSMapTableä¸­ï¼Œå¤§å®¶éƒ½çŸ¥é“NSCacheæœ‰ä¸€ä¸ªç‰¹æ€§å°±æ˜¯å½“ç³»ç»Ÿå†…å­˜ä¸è¶³çš„æ—¶å€™ä¼šé¦–å…ˆå›æ”¶NSCacheçš„å†…å­˜ï¼Œçœ‹è¿™æ®µgetçš„ä»£ç ï¼Œè¿™é‡Œä½œè€…åº”è¯¥æ˜¯è€ƒè™‘å¦‚æœNSCacheä¸­å†…å­˜è¢«å›æ”¶äº†å¯ä»¥ä»NSMapTableä¸­ç»§ç»­æ‰¾åˆ°è¯¥å›¾ç‰‡æ•°æ®ï¼Œä¸ç”¨å»è¯»ç£ç›˜æ•°æ®æˆ–è€…é‡æ–°ä¸‹è½½ã€‚</p>
<p>ç„¶åæˆ‘ä»¬æ¥çœ‹ä¸€ä¸‹å­˜å‚¨åˆ°diskçš„è¿‡ç¨‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">if (toDisk) &#123;</div><div class="line">    dispatch_async(self.ioQueue, ^&#123;</div><div class="line">        @autoreleasepool &#123;</div><div class="line">            NSData *data = imageData;</div><div class="line">            if (!data &amp;&amp; image) &#123;</div><div class="line">                // If we do not have any data to detect image format, check whether it contains alpha channel to use PNG or JPEG format</div><div class="line">                SDImageFormat format;</div><div class="line">                if (SDCGImageRefContainsAlpha(image.CGImage)) &#123;</div><div class="line">                    format = SDImageFormatPNG;</div><div class="line">                &#125; else &#123;</div><div class="line">                    format = SDImageFormatJPEG;</div><div class="line">                &#125;</div><div class="line">                data = [[SDWebImageCodersManager sharedInstance] encodedDataWithImage:image format:format];</div><div class="line">            &#125;</div><div class="line">            [self _storeImageDataToDisk:data forKey:key];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        if (completionBlock) &#123;</div><div class="line">            dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">                completionBlock();</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line">    &#125;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœå½“å‰çš„å›¾ç‰‡dataä¸ä¸ºç©ºåˆ™ç›´æ¥å­˜åœ¨ç£ç›˜ï¼Œå¦‚æœä¸ºç©ºè€Œä¸”å›¾ç‰‡å¯¹è±¡ä¸ä¸ºç©ºï¼Œåˆ™éœ€è¦å…ˆå¯¹å›¾ç‰‡è¿›è¡Œç¼–ç å¤„ç†è½¬ä¸ºdataåœ¨å­˜åˆ°ç£ç›˜ä¸­,è¿™æ˜¯å› ä¸ºdataæ˜¯ç›´æ¥ä»æœåŠ¡å™¨æ‹¿åˆ°çš„æ•°æ®ï¼Œæ˜¯ç¼–ç è¿‡çš„ï¼Œè€Œimageåˆ™æ˜¯å·²ç»è§£ç äº†çš„ï¼Œæ˜¯åŸå§‹æ•°æ®ï¼Œæ•°æ®é‡ä¼šæ¯”è¾ƒå¤§ï¼Œæ‰€ä»¥éœ€è¦å…ˆç¼–ç åœ¨å­˜å‚¨ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">- (void)_storeImageDataToDisk:(nullable NSData *)imageData forKey:(nullable NSString *)key &#123;</div><div class="line">    if (!imageData || !key) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (![self.fileManager fileExistsAtPath:_diskCachePath]) &#123;</div><div class="line">        [self.fileManager createDirectoryAtPath:_diskCachePath withIntermediateDirectories:YES attributes:nil error:NULL];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // get cache Path for image key</div><div class="line">    NSString *cachePathForKey = [self defaultCachePathForKey:key];</div><div class="line">    // transform to NSUrl</div><div class="line">    NSURL *fileURL = [NSURL fileURLWithPath:cachePathForKey];</div><div class="line">    </div><div class="line">    [imageData writeToURL:fileURL options:self.config.diskCacheWritingOptions error:nil];</div><div class="line">    </div><div class="line">    // disable iCloud backup</div><div class="line">    if (self.config.shouldDisableiCloud) &#123;</div><div class="line">        [fileURL setResourceValue:@YES forKey:NSURLIsExcludedFromBackupKey error:nil];</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å­˜å‚¨è¿‡ç¨‹å¾ˆç®€å•ï¼Œå°±æ˜¯ä¸€ä¸ªæ–‡ä»¶å†™å…¥å°±OKäº†ã€‚å†™å…¥å‰å…ˆåˆ¤æ–­ä¸€ä¸‹æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨çš„è¯å…ˆåˆ›å»ºä¸€ä¸ªã€‚</p>
<p>ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹æ¯”è¾ƒé‡è¦çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå›¾ç‰‡çš„æŸ¥è¯¢</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line">// First check the in-memory cache...</div><div class="line">UIImage *image = [self imageFromMemoryCacheForKey:key];</div><div class="line">BOOL shouldQueryMemoryOnly = (image &amp;&amp; !(options &amp; SDImageCacheQueryDataWhenInMemory));</div><div class="line">if (shouldQueryMemoryOnly) &#123;</div><div class="line">    if (doneBlock) &#123;</div><div class="line">        doneBlock(image, nil, SDImageCacheTypeMemory);</div><div class="line">    &#125;</div><div class="line">    return nil;</div><div class="line">&#125;</div><div class="line">    </div><div class="line">NSOperation *operation = [NSOperation new];</div><div class="line">void(^queryDiskBlock)(void) =  ^&#123;</div><div class="line">    if (operation.isCancelled) &#123;</div><div class="line">        // do not call the completion if cancelled</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    @autoreleasepool &#123;</div><div class="line">        NSData *diskData = [self diskImageDataBySearchingAllPathsForKey:key];</div><div class="line">        UIImage *diskImage;</div><div class="line">        SDImageCacheType cacheType = SDImageCacheTypeDisk;</div><div class="line">        if (image) &#123;</div><div class="line">            // the image is from in-memory cache</div><div class="line">            diskImage = image;</div><div class="line">            cacheType = SDImageCacheTypeMemory;</div><div class="line">        &#125; else if (diskData) &#123;</div><div class="line">            // decode image data only if in-memory cache missed</div><div class="line">            diskImage = [self diskImageForKey:key data:diskData options:options];</div><div class="line">            if (diskImage &amp;&amp; self.config.shouldCacheImagesInMemory) &#123;</div><div class="line">                NSUInteger cost = SDCacheCostForImage(diskImage);</div><div class="line">                [self.memCache setObject:diskImage forKey:key cost:cost];</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        if (doneBlock) &#123;</div><div class="line">            if (options &amp; SDImageCacheQueryDiskSync) &#123;</div><div class="line">                doneBlock(diskImage, diskData, cacheType);</div><div class="line">            &#125; else &#123;</div><div class="line">                dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">                    doneBlock(diskImage, diskData, cacheType);</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;;</div><div class="line">    </div><div class="line">if (options &amp; SDImageCacheQueryDiskSync) &#123;</div><div class="line">    queryDiskBlock();</div><div class="line">&#125; else &#123;</div><div class="line">    dispatch_async(self.ioQueue, queryDiskBlock);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…ˆä»nscacheä¸­æŸ¥æ‰¾ï¼Œå¦‚æœæŸ¥æ‰¾æˆåŠŸä¸”optionsä¸ºSDImageCacheQueryDataWhenInMemoryï¼Œåˆ™è¿”å›nscacheä¸­çš„ç»“æœ<br>å¦‚æœnscacheæŸ¥æ‰¾å¤±è´¥ï¼Œåˆ™æŸ¥æ‰¾diskä¸­çš„data,å¹¶è§£ç è¯¥dataåŒæ—¶å°†è§£ç åçš„imageå¡åˆ°nscacheä¸­,ç„¶åè¿”å›ã€‚</p>
<p>sdè¿˜æä¾›äº†ä¸€ä¸ªåˆ é™¤ç¼“å­˜æ–‡ä»¶çš„æ–¹æ³•ï¼Œåœ¨è¯¥æ–¹æ³•ä¸­ï¼Œä¸€å…±ä½¿ç”¨äº†2ç§åˆ é™¤ç­–ç•¥ï¼Œç¬¬ä¸€ç§æ˜¯æŒ‰è¿‡æœŸæ—¶é—´åˆ é™¤</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">NSDate *expirationDate = [NSDate dateWithTimeIntervalSinceNow:-self.config.maxCacheAge];</div><div class="line">NSMutableDictionary&lt;NSURL *, NSDictionary&lt;NSString *, id&gt; *&gt; *cacheFiles = [NSMutableDictionary dictionary];</div><div class="line">NSUInteger currentCacheSize = 0;</div><div class="line"></div><div class="line">// Enumerate all of the files in the cache directory.  This loop has two purposes:</div><div class="line">//</div><div class="line">//  1. Removing files that are older than the expiration date.</div><div class="line">//  2. Storing file attributes for the size-based cleanup pass.</div><div class="line">NSMutableArray&lt;NSURL *&gt; *urlsToDelete = [[NSMutableArray alloc] init];</div><div class="line">for (NSURL *fileURL in fileEnumerator) &#123;</div><div class="line">    NSError *error;</div><div class="line">    NSDictionary&lt;NSString *, id&gt; *resourceValues = [fileURL resourceValuesForKeys:resourceKeys error:&amp;error];</div><div class="line"></div><div class="line">    // Skip directories and errors.</div><div class="line">    if (error || !resourceValues || [resourceValues[NSURLIsDirectoryKey] boolValue]) &#123;</div><div class="line">        continue;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Remove files that are older than the expiration date;</div><div class="line">    NSDate *modificationDate = resourceValues[NSURLContentModificationDateKey];</div><div class="line">    if ([[modificationDate laterDate:expirationDate] isEqualToDate:expirationDate]) &#123;</div><div class="line">        [urlsToDelete addObject:fileURL];</div><div class="line">        continue;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Store a reference to this file and account for its total size.</div><div class="line">    NSNumber *totalAllocatedSize = resourceValues[NSURLTotalFileAllocatedSizeKey];</div><div class="line">    currentCacheSize += totalAllocatedSize.unsignedIntegerValue;</div><div class="line">    cacheFiles[fileURL] = resourceValues;</div><div class="line">&#125;</div><div class="line">    </div><div class="line">for (NSURL *fileURL in urlsToDelete) &#123;</div><div class="line">    [self.fileManager removeItemAtURL:fileURL error:nil];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœæŒ‰è¿‡æœŸæ—¶é—´åˆ é™¤åçš„æ–‡ä»¶å¤§å°è¿˜æ˜¯å¤§äºæœ€å¤§ç¼“å­˜ç©ºé—´ï¼ˆmaxCacheSizeï¼‰çš„è¯ï¼Œè¿˜æœ‰ä¸€ç§åˆ é™¤ç­–ç•¥ï¼Œå°±æ˜¯åˆ é™¤ç°æœ‰æ–‡ä»¶å¤§å°çš„ä¸€åŠçš„æ–‡ä»¶ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">// If our remaining disk cache exceeds a configured maximum size, perform a second</div><div class="line">// size-based cleanup pass.  We delete the oldest files first.</div><div class="line">if (self.config.maxCacheSize &gt; 0 &amp;&amp; currentCacheSize &gt; self.config.maxCacheSize) &#123;</div><div class="line">    // Target half of our maximum cache size for this cleanup pass.</div><div class="line">    const NSUInteger desiredCacheSize = self.config.maxCacheSize / 2;</div><div class="line"></div><div class="line">    // Sort the remaining cache files by their last modification time (oldest first).</div><div class="line">    NSArray&lt;NSURL *&gt; *sortedFiles = [cacheFiles keysSortedByValueWithOptions:NSSortConcurrent</div><div class="line">                                                             usingComparator:^NSComparisonResult(id obj1, id obj2) &#123;</div><div class="line">                                                                 return [obj1[NSURLContentModificationDateKey] compare:obj2[NSURLContentModificationDateKey]];</div><div class="line">                                                             &#125;];</div><div class="line"></div><div class="line">    // Delete files until we fall below our desired cache size.</div><div class="line">    for (NSURL *fileURL in sortedFiles) &#123;</div><div class="line">        if ([self.fileManager removeItemAtURL:fileURL error:nil]) &#123;</div><div class="line">            NSDictionary&lt;NSString *, id&gt; *resourceValues = cacheFiles[fileURL];</div><div class="line">            NSNumber *totalAllocatedSize = resourceValues[NSURLTotalFileAllocatedSizeKey];</div><div class="line">            currentCacheSize -= totalAllocatedSize.unsignedIntegerValue;</div><div class="line"></div><div class="line">            if (currentCacheSize &lt; desiredCacheSize) &#123;</div><div class="line">                break;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h3 id="å›¾ç‰‡ç¼–è§£ç æ¨¡å—"><a href="#å›¾ç‰‡ç¼–è§£ç æ¨¡å—" class="headerlink" title="å›¾ç‰‡ç¼–è§£ç æ¨¡å—"></a>å›¾ç‰‡ç¼–è§£ç æ¨¡å—</h3><p>å›¾ç‰‡çš„ç¼–è§£ç æ¨¡å—ä¹Ÿæ˜¯sdä¸­æ¯”è¾ƒé‡è¦ä¹Ÿæ¯”è¾ƒéš¾åƒé€çš„æ¨¡å—ï¼Œæ¶‰åŠåˆ°ä¸€äº›å›¾ç‰‡ç›¸å…³çš„å§¿åŠ¿ï¼Œéœ€è¦æ…¢æ…¢å­¦ä¹ ç†è§£ã€‚</p>
<h4 id="SDWebImageCoder"><a href="#SDWebImageCoder" class="headerlink" title="SDWebImageCoder"></a>SDWebImageCoder</h4><p>å…ˆæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªåè®®ç±»ï¼Œè¿™ä¸ªç±»ä¸­å®šä¹‰äº†ä¸€äº›ç¼–è§£ç çš„åè®®å’Œå‡ ä¸ªé™æ€å‡½æ•°ã€‚</p>
<p>é™æ€å‡½æ•°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">//è¿”å›å›¾ç‰‡çš„é¢œè‰²ç©ºé—´ï¼Œè¿™é‡Œè¿”å›RGB</div><div class="line">CGColorSpaceRef SDCGColorSpaceGetDeviceRGB(void) &#123;</div><div class="line">    static CGColorSpaceRef colorSpace;</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        colorSpace = CGColorSpaceCreateDeviceRGB();</div><div class="line">    &#125;);</div><div class="line">    return colorSpace;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//åˆ¤æ–­å›¾ç‰‡æ˜¯å¦æœ‰é€æ˜åº¦</div><div class="line">BOOL SDCGImageRefContainsAlpha(CGImageRef imageRef) &#123;</div><div class="line">    if (!imageRef) &#123;</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">    CGImageAlphaInfo alphaInfo = CGImageGetAlphaInfo(imageRef);</div><div class="line">    BOOL hasAlpha = !(alphaInfo == kCGImageAlphaNone ||</div><div class="line">                      alphaInfo == kCGImageAlphaNoneSkipFirst ||</div><div class="line">                      alphaInfo == kCGImageAlphaNoneSkipLast);</div><div class="line">    return hasAlpha;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="SDWebImageImageIOCoder"><a href="#SDWebImageImageIOCoder" class="headerlink" title="SDWebImageImageIOCoder"></a>SDWebImageImageIOCoder</h4><p>è¿™ä¸ªæ˜¯å›¾ç‰‡ç¼–è§£ç çš„æ ¸å¿ƒç±»ï¼Œç›¸å…³æ–¹æ³•å’Œåè®®éƒ½åœ¨è¿™ä¸ªç±»ä¸­å®ç°ã€‚çœ‹å¤´æ–‡ä»¶çš„æ³¨é‡Šï¼Œsdæ”¯æŒPNG,JPEG,TIFFå’ŒHEIC(éœ€è¦åˆ¤æ–­è®¾å¤‡æ˜¯å¦æ”¯æŒ)è¿™å‡ ç§å›¾ç‰‡æ ¼å¼çš„ç¼–è§£ç ã€‚gifå’Œwebpæœ‰å•ç‹¬çš„ç¼–è§£ç ç±»ã€‚</p>
<p>å› ä¸ºsdæ˜¯æ”¯æŒå›¾ç‰‡è¾¹ä¸‹è½½è¾¹æ˜¾ç¤ºçš„ï¼Œè€Œè¿™ä¸ªæ˜¾ç¤ºæ“ä½œéœ€è¦å…ˆå°†æ¥å—åˆ°çš„éƒ¨åˆ†å›¾ç‰‡è§£ç åæ‰å¯ä»¥æ˜¾ç¤ºï¼Œè¿™é‡Œçœ‹ä¸€ä¸‹è¿™ä¸ªè§£ç éƒ¨åˆ†å›¾ç‰‡æ˜¯å¦‚ä½•å®ç°çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">- (UIImage *)incrementallyDecodedImageWithData:(NSData *)data finished:(BOOL)finished &#123;</div><div class="line">    if (!_imageSource) &#123;</div><div class="line">        _imageSource = CGImageSourceCreateIncremental(NULL);</div><div class="line">    &#125;</div><div class="line">    UIImage *image;</div><div class="line">    </div><div class="line">    // The following code is from http://www.cocoaintheshell.com/2011/05/progressive-images-download-imageio/</div><div class="line">    // Thanks to the author @Nyx0uf</div><div class="line">    </div><div class="line">    // Update the data source, we must pass ALL the data, not just the new bytes</div><div class="line">    CGImageSourceUpdateData(_imageSource, (__bridge CFDataRef)data, finished);</div><div class="line">    </div><div class="line">    if (_width + _height == 0) &#123;</div><div class="line">        CFDictionaryRef properties = CGImageSourceCopyPropertiesAtIndex(_imageSource, 0, NULL);</div><div class="line">        if (properties) &#123;</div><div class="line">            NSInteger orientationValue = 1;</div><div class="line">            CFTypeRef val = CFDictionaryGetValue(properties, kCGImagePropertyPixelHeight);</div><div class="line">            if (val) CFNumberGetValue(val, kCFNumberLongType, &amp;_height);</div><div class="line">            val = CFDictionaryGetValue(properties, kCGImagePropertyPixelWidth);</div><div class="line">            if (val) CFNumberGetValue(val, kCFNumberLongType, &amp;_width);</div><div class="line">            val = CFDictionaryGetValue(properties, kCGImagePropertyOrientation);</div><div class="line">            if (val) CFNumberGetValue(val, kCFNumberNSIntegerType, &amp;orientationValue);</div><div class="line">            CFRelease(properties);</div><div class="line">            </div><div class="line">            // When we draw to Core Graphics, we lose orientation information,</div><div class="line">            // which means the image below born of initWithCGIImage will be</div><div class="line">            // oriented incorrectly sometimes. (Unlike the image born of initWithData</div><div class="line">            // in didCompleteWithError.) So save it here and pass it on later.</div><div class="line">#if SD_UIKIT || SD_WATCH</div><div class="line">            _orientation = [SDWebImageCoderHelper imageOrientationFromEXIFOrientation:orientationValue];</div><div class="line">#endif</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (_width + _height &gt; 0) &#123;</div><div class="line">        // Create the image</div><div class="line">        CGImageRef partialImageRef = CGImageSourceCreateImageAtIndex(_imageSource, 0, NULL);</div><div class="line">        </div><div class="line">        if (partialImageRef) &#123;</div><div class="line">#if SD_UIKIT || SD_WATCH</div><div class="line">            image = [[UIImage alloc] initWithCGImage:partialImageRef scale:1 orientation:_orientation];</div><div class="line">#elif SD_MAC</div><div class="line">            image = [[UIImage alloc] initWithCGImage:partialImageRef size:NSZeroSize];</div><div class="line">#endif</div><div class="line">            CGImageRelease(partialImageRef);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (finished) &#123;</div><div class="line">        if (_imageSource) &#123;</div><div class="line">            CFRelease(_imageSource);</div><div class="line">            _imageSource = NULL;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return image;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…ˆåˆ›å»ºä¸€ä¸ªimagesource,ç„¶åæ›´æ–°imagesourceçš„dataï¼Œæ³¨æ„è¿™é‡Œçš„dataæ˜¯ç›®å‰æ¥æ”¶åˆ°çš„å›¾ç‰‡çš„æ‰€æœ‰æ•°æ®ï¼Œä¸æ­¢æ˜¯æ–°å¢çš„éƒ¨åˆ†ï¼Œè¿™é‡Œåœ¨ä¸‹è½½çš„å›¾ç‰‡çš„æ—¶å€™sdå·²ç»å¤„ç†å¥½äº†ï¼Œä¿å­˜äº†ä¹‹å‰ä¸‹è½½çš„é‚£éƒ¨åˆ†æ•°æ®ã€‚ç„¶åè·å–å›¾ç‰‡å®½é«˜å±æ€§å’Œæ–¹å‘ï¼Œæœ€åç”Ÿæˆå›¾ç‰‡åè¿”å›ã€‚</p>
<p>æ¥ç€çœ‹æ­£å¸¸å›¾ç‰‡çš„è§£ç è¿‡ç¨‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">- (UIImage *)decompressedImageWithImage:(UIImage *)image</div><div class="line">                                   data:(NSData *__autoreleasing  _Nullable *)data</div><div class="line">                                options:(nullable NSDictionary&lt;NSString*, NSObject*&gt;*)optionsDict &#123;</div><div class="line">#if SD_MAC</div><div class="line">    return image;</div><div class="line">#endif</div><div class="line">#if SD_UIKIT || SD_WATCH</div><div class="line">    BOOL shouldScaleDown = NO;</div><div class="line">    if (optionsDict != nil) &#123;</div><div class="line">        NSNumber *scaleDownLargeImagesOption = nil;</div><div class="line">        if ([optionsDict[SDWebImageCoderScaleDownLargeImagesKey] isKindOfClass:[NSNumber class]]) &#123;</div><div class="line">            scaleDownLargeImagesOption = (NSNumber *)optionsDict[SDWebImageCoderScaleDownLargeImagesKey];</div><div class="line">        &#125;</div><div class="line">        if (scaleDownLargeImagesOption != nil) &#123;</div><div class="line">            shouldScaleDown = [scaleDownLargeImagesOption boolValue];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    if (!shouldScaleDown) &#123;</div><div class="line">        return [self sd_decompressedImageWithImage:image];</div><div class="line">    &#125; else &#123;</div><div class="line">        UIImage *scaledDownImage = [self sd_decompressedAndScaledDownImageWithImage:image];</div><div class="line">        if (scaledDownImage &amp;&amp; !CGSizeEqualToSize(scaledDownImage.size, image.size)) &#123;</div><div class="line">            // if the image is scaled down, need to modify the data pointer as well</div><div class="line">            SDImageFormat format = [NSData sd_imageFormatForImageData:*data];</div><div class="line">            NSData *imageData = [self encodedDataWithImage:scaledDownImage format:format];</div><div class="line">            if (imageData) &#123;</div><div class="line">                *data = imageData;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        return scaledDownImage;</div><div class="line">    &#125;</div><div class="line">#endif</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é¦–å…ˆéœ€è¦åˆ¤æ–­ä¸€ä¸‹å›¾ç‰‡æ˜¯å¦éœ€è¦è¢«ç¼©æ”¾ï¼Œå› ä¸ºåœ¨ä¸‹è½½å®Œä»¥åçš„å›¾ç‰‡ä¹Ÿæ˜¯æ ¹æ®å›¾ç‰‡åç¼€æ˜¯å¦å¸¦@2x@3xè¿™ç§æ ‡è¯†è¿›è¡Œè¿‡ç¼©æ”¾çš„ï¼Œå¹¶ä¸æ˜¯å›¾ç‰‡çš„å®é™…å°ºå¯¸ã€‚</p>
<p>å¦‚æœä¸éœ€è¦ç¼©æ”¾ï¼Œç›´æ¥è°ƒç”¨ä¸‹é¢çš„è§£ç æ–¹æ³•è§£ç å³å¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div></pre></td><td class="code"><pre><div class="line">#if SD_UIKIT || SD_WATCH</div><div class="line">- (nullable UIImage *)sd_decompressedImageWithImage:(nullable UIImage *)image &#123;</div><div class="line">    if (![[self class] shouldDecodeImage:image]) &#123;</div><div class="line">        return image;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // autorelease the bitmap context and all vars to help system to free memory when there are memory warning.</div><div class="line">    // on iOS7, do not forget to call [[SDImageCache sharedImageCache] clearMemory];</div><div class="line">    @autoreleasepool&#123;</div><div class="line">        </div><div class="line">        CGImageRef imageRef = image.CGImage;</div><div class="line">        // device color space</div><div class="line">        CGColorSpaceRef colorspaceRef = SDCGColorSpaceGetDeviceRGB();</div><div class="line">        BOOL hasAlpha = SDCGImageRefContainsAlpha(imageRef);</div><div class="line">        // iOS display alpha info (BRGA8888/BGRX8888)</div><div class="line">        CGBitmapInfo bitmapInfo = kCGBitmapByteOrder32Host;</div><div class="line">        bitmapInfo |= hasAlpha ? kCGImageAlphaPremultipliedFirst : kCGImageAlphaNoneSkipFirst;</div><div class="line">        </div><div class="line">        size_t width = CGImageGetWidth(imageRef);</div><div class="line">        size_t height = CGImageGetHeight(imageRef);</div><div class="line">        </div><div class="line">        // kCGImageAlphaNone is not supported in CGBitmapContextCreate.</div><div class="line">        // Since the original image here has no alpha info, use kCGImageAlphaNoneSkipLast</div><div class="line">        // to create bitmap graphics contexts without alpha info.</div><div class="line">        CGContextRef context = CGBitmapContextCreate(NULL,</div><div class="line">                                                     width,</div><div class="line">                                                     height,</div><div class="line">                                                     kBitsPerComponent,</div><div class="line">                                                     0,</div><div class="line">                                                     colorspaceRef,</div><div class="line">                                                     bitmapInfo);</div><div class="line">        if (context == NULL) &#123;</div><div class="line">            return image;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        // Draw the image into the context and retrieve the new bitmap image without alpha</div><div class="line">        CGContextDrawImage(context, CGRectMake(0, 0, width, height), imageRef);</div><div class="line">        CGImageRef imageRefWithoutAlpha = CGBitmapContextCreateImage(context);</div><div class="line">        UIImage *imageWithoutAlpha = [[UIImage alloc] initWithCGImage:imageRefWithoutAlpha scale:image.scale orientation:image.imageOrientation];</div><div class="line">        CGContextRelease(context);</div><div class="line">        CGImageRelease(imageRefWithoutAlpha);</div><div class="line">        </div><div class="line">        return imageWithoutAlpha;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™æ®µä»£ç å¾ˆç»å…¸ï¼Œå¾ˆå¤šå›¾ç‰‡è§£ç ç›¸å…³çš„åº“éƒ½ä¼šç”¨åˆ°ï¼Œå¦‚æœä½ æƒ³è‡ªå·±å†™ä¸€ä¸ªå¼‚æ­¥çš„å›¾ç‰‡è§£ç å‡½æ•°ï¼Œä¹Ÿå¯ä»¥ç›´æ¥æ‹¿å»ç”¨ã€‚è¿™é‡Œç”¨çš„å‚æ•°åŠç›¸å…³è§£é‡Šç½‘ä¸Šæœ‰å¾ˆå¤šæ–‡ç« åˆ†æè¿‡ï¼Œ<a href="http://blog.leichunfeng.com/blog/2017/02/20/talking-about-the-decompression-of-the-image-in-ios/" target="_blank" rel="noopener">æ¯”å¦‚è¿™ç¯‡å°±è§£é‡Šçš„æŒºæ¸…æ¥š</a>ã€‚</p>
<p>å¦‚æœæ˜¯éœ€è¦ç¼©æ”¾çš„å›¾ç‰‡ï¼Œåˆ™èµ°ä¸‹é¢è¿™ä¸ªæ–¹æ³•è§£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div></pre></td><td class="code"><pre><div class="line">- (nullable UIImage *)sd_decompressedAndScaledDownImageWithImage:(nullable UIImage *)image &#123;</div><div class="line">    if (![[self class] shouldDecodeImage:image]) &#123;</div><div class="line">        return image;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (![[self class] shouldScaleDownImage:image]) &#123;</div><div class="line">        return [self sd_decompressedImageWithImage:image];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    CGContextRef destContext;</div><div class="line">    </div><div class="line">    // autorelease the bitmap context and all vars to help system to free memory when there are memory warning.</div><div class="line">    // on iOS7, do not forget to call [[SDImageCache sharedImageCache] clearMemory];</div><div class="line">    @autoreleasepool &#123;</div><div class="line">        CGImageRef sourceImageRef = image.CGImage;</div><div class="line">        </div><div class="line">        CGSize sourceResolution = CGSizeZero;</div><div class="line">        sourceResolution.width = CGImageGetWidth(sourceImageRef);</div><div class="line">        sourceResolution.height = CGImageGetHeight(sourceImageRef);</div><div class="line">        float sourceTotalPixels = sourceResolution.width * sourceResolution.height;</div><div class="line">        // Determine the scale ratio to apply to the input image</div><div class="line">        // that results in an output image of the defined size.</div><div class="line">        // see kDestImageSizeMB, and how it relates to destTotalPixels.</div><div class="line">        float imageScale = kDestTotalPixels / sourceTotalPixels;</div><div class="line">        CGSize destResolution = CGSizeZero;</div><div class="line">        destResolution.width = (int)(sourceResolution.width*imageScale);</div><div class="line">        destResolution.height = (int)(sourceResolution.height*imageScale);</div><div class="line">        </div><div class="line">        // device color space</div><div class="line">        CGColorSpaceRef colorspaceRef = SDCGColorSpaceGetDeviceRGB();</div><div class="line">        BOOL hasAlpha = SDCGImageRefContainsAlpha(sourceImageRef);</div><div class="line">        // iOS display alpha info (BGRA8888/BGRX8888)</div><div class="line">        CGBitmapInfo bitmapInfo = kCGBitmapByteOrder32Host;</div><div class="line">        bitmapInfo |= hasAlpha ? kCGImageAlphaPremultipliedFirst : kCGImageAlphaNoneSkipFirst;</div><div class="line">        </div><div class="line">        // kCGImageAlphaNone is not supported in CGBitmapContextCreate.</div><div class="line">        // Since the original image here has no alpha info, use kCGImageAlphaNoneSkipLast</div><div class="line">        // to create bitmap graphics contexts without alpha info.</div><div class="line">        destContext = CGBitmapContextCreate(NULL,</div><div class="line">                                            destResolution.width,</div><div class="line">                                            destResolution.height,</div><div class="line">                                            kBitsPerComponent,</div><div class="line">                                            0,</div><div class="line">                                            colorspaceRef,</div><div class="line">                                            bitmapInfo);</div><div class="line">        </div><div class="line">        if (destContext == NULL) &#123;</div><div class="line">            return image;</div><div class="line">        &#125;</div><div class="line">        CGContextSetInterpolationQuality(destContext, kCGInterpolationHigh);</div><div class="line">        </div><div class="line">        // Now define the size of the rectangle to be used for the</div><div class="line">        // incremental blits from the input image to the output image.</div><div class="line">        // we use a source tile width equal to the width of the source</div><div class="line">        // image due to the way that iOS retrieves image data from disk.</div><div class="line">        // iOS must decode an image from disk in full width &apos;bands&apos;, even</div><div class="line">        // if current graphics context is clipped to a subrect within that</div><div class="line">        // band. Therefore we fully utilize all of the pixel data that results</div><div class="line">        // from a decoding opertion by achnoring our tile size to the full</div><div class="line">        // width of the input image.</div><div class="line">        CGRect sourceTile = CGRectZero;</div><div class="line">        sourceTile.size.width = sourceResolution.width;</div><div class="line">        // The source tile height is dynamic. Since we specified the size</div><div class="line">        // of the source tile in MB, see how many rows of pixels high it</div><div class="line">        // can be given the input image width.</div><div class="line">        sourceTile.size.height = (int)(kTileTotalPixels / sourceTile.size.width );</div><div class="line">        sourceTile.origin.x = 0.0f;</div><div class="line">        // The output tile is the same proportions as the input tile, but</div><div class="line">        // scaled to image scale.</div><div class="line">        CGRect destTile;</div><div class="line">        destTile.size.width = destResolution.width;</div><div class="line">        destTile.size.height = sourceTile.size.height * imageScale;</div><div class="line">        destTile.origin.x = 0.0f;</div><div class="line">        // The source seem overlap is proportionate to the destination seem overlap.</div><div class="line">        // this is the amount of pixels to overlap each tile as we assemble the ouput image.</div><div class="line">        float sourceSeemOverlap = (int)((kDestSeemOverlap/destResolution.height)*sourceResolution.height);</div><div class="line">        CGImageRef sourceTileImageRef;</div><div class="line">        // calculate the number of read/write operations required to assemble the</div><div class="line">        // output image.</div><div class="line">        int iterations = (int)( sourceResolution.height / sourceTile.size.height );</div><div class="line">        // If tile height doesn&apos;t divide the image height evenly, add another iteration</div><div class="line">        // to account for the remaining pixels.</div><div class="line">        int remainder = (int)sourceResolution.height % (int)sourceTile.size.height;</div><div class="line">        if(remainder) &#123;</div><div class="line">            iterations++;</div><div class="line">        &#125;</div><div class="line">        // Add seem overlaps to the tiles, but save the original tile height for y coordinate calculations.</div><div class="line">        float sourceTileHeightMinusOverlap = sourceTile.size.height;</div><div class="line">        sourceTile.size.height += sourceSeemOverlap;</div><div class="line">        destTile.size.height += kDestSeemOverlap;</div><div class="line">        for( int y = 0; y &lt; iterations; ++y ) &#123;</div><div class="line">            @autoreleasepool &#123;</div><div class="line">                sourceTile.origin.y = y * sourceTileHeightMinusOverlap + sourceSeemOverlap;</div><div class="line">                destTile.origin.y = destResolution.height - (( y + 1 ) * sourceTileHeightMinusOverlap * imageScale + kDestSeemOverlap);</div><div class="line">                sourceTileImageRef = CGImageCreateWithImageInRect( sourceImageRef, sourceTile );</div><div class="line">                if( y == iterations - 1 &amp;&amp; remainder ) &#123;</div><div class="line">                    float dify = destTile.size.height;</div><div class="line">                    destTile.size.height = CGImageGetHeight( sourceTileImageRef ) * imageScale;</div><div class="line">                    dify -= destTile.size.height;</div><div class="line">                    destTile.origin.y += dify;</div><div class="line">                &#125;</div><div class="line">                CGContextDrawImage( destContext, destTile, sourceTileImageRef );</div><div class="line">                CGImageRelease( sourceTileImageRef );</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        CGImageRef destImageRef = CGBitmapContextCreateImage(destContext);</div><div class="line">        CGContextRelease(destContext);</div><div class="line">        if (destImageRef == NULL) &#123;</div><div class="line">            return image;</div><div class="line">        &#125;</div><div class="line">        UIImage *destImage = [[UIImage alloc] initWithCGImage:destImageRef scale:image.scale orientation:image.imageOrientation];</div><div class="line">        CGImageRelease(destImageRef);</div><div class="line">        if (destImage == nil) &#123;</div><div class="line">            return image;</div><div class="line">        &#125;</div><div class="line">        return destImage;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œå…ˆåˆ¤æ–­å›¾ç‰‡çš„æ€»åƒç´ æ˜¯å¦æ¯”sdè®¾ç½®çš„æœ€å¤§åƒç´ å€¼å¤§ï¼Œå¦‚æœæ€»åƒç´ è¶…å‡ºäº†è®¾ç½®çš„æœ€å¤§åƒç´ å€¼ï¼Œåˆ™éœ€è¦å…ˆç¼©æ”¾å›¾ç‰‡å†è§£ç ï¼Œä¸ç„¶è§£ç éœ€è¦çš„å†…å­˜ç©ºé—´å¤ªå¤§ï¼Œå¯èƒ½é€ æˆå†…å­˜æš´æ¶¨ç­‰é—®é¢˜ã€‚ã€‚ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">#if SD_UIKIT || SD_WATCH</div><div class="line">+ (BOOL)shouldScaleDownImage:(nonnull UIImage *)image &#123;</div><div class="line">    BOOL shouldScaleDown = YES;</div><div class="line">    </div><div class="line">    CGImageRef sourceImageRef = image.CGImage;</div><div class="line">    CGSize sourceResolution = CGSizeZero;</div><div class="line">    sourceResolution.width = CGImageGetWidth(sourceImageRef);</div><div class="line">    sourceResolution.height = CGImageGetHeight(sourceImageRef);</div><div class="line">    float sourceTotalPixels = sourceResolution.width * sourceResolution.height;</div><div class="line">    float imageScale = kDestTotalPixels / sourceTotalPixels;</div><div class="line">    if (imageScale &lt; 1) &#123;</div><div class="line">        shouldScaleDown = YES;</div><div class="line">    &#125; else &#123;</div><div class="line">        shouldScaleDown = NO;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return shouldScaleDown;</div><div class="line">&#125;</div><div class="line">#endif</div></pre></td></tr></table></figure>
<p>sdè¿™é‡Œåº”è¯¥ä¹Ÿæ˜¯ç”¨äº†å¸§å†…å‹ç¼©ç®—æ³•å»å‹ç¼©å›¾ç‰‡çš„å°ºå¯¸ï¼Œé€šè¿‡è®¡ç®—åƒç´ å·®å€¼çš„æ–¹å¼å°†å¤šä½™çš„åƒç´ å‰”é™¤ï¼Œç„¶åsdä½¿ç”¨äº†ä¸€ä¸ªtileçš„ä¸œä¸œå»å­˜å‚¨æ¯æ¬¡è®¡ç®—å‡ºæ¥çš„æ•°æ®ï¼Œå¹¶å°†è¿™äº›æ•°æ®å†™å…¥åˆ°è®¾å¤‡ä¸Šä¸‹æ–‡ä¸­ã€‚è®¡ç®—å®Œæˆåå†ä»ä¸Šä¸‹æ–‡ä¸­å–å‡ºä¸€å¼ ä½å›¾ã€‚è¿™ä¸ªå‹ç¼©è§£ç å‡½æ•°çš„è¯¦ç»†æ³¨é‡Šå¯ä»¥<a href="https://www.jianshu.com/p/dfa47380fc05" target="_blank" rel="noopener">å‚è€ƒè¿™ä¸€ç¯‡æ–‡ç« </a>.</p>
<p>ç„¶åå°±æ˜¯ç¼–ç éƒ¨åˆ†ï¼Œä»€ä¹ˆæ—¶å€™éœ€è¦ç¼–ç å‘¢ï¼Ÿå°±æ˜¯åœ¨å­˜å…¥diskçš„æ—¶å€™ï¼Œå› ä¸ºä¹‹å‰ç”¨åˆ°çš„imageå¯èƒ½æ˜¯è§£ç ä¹‹åçš„å›¾ç‰‡ï¼Œç›´æ¥å­˜å…¥çš„è¯ä¼šå ç”¨æ¯”è¾ƒå¤§çš„å†…å­˜ç©ºé—´ï¼Œæ‰€ä»¥sdè¿™é‡Œéƒ½æ˜¯å…ˆå°†imageç¼–ç åå†å­˜çš„ã€‚</p>
<p>ç¼–ç çš„å‡½æ•°å’Œè§£ç ç›¸æ¯”è¿˜æ˜¯æ¯”è¾ƒç®€å•çš„ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line">- (NSData *)encodedDataWithImage:(UIImage *)image format:(SDImageFormat)format &#123;</div><div class="line">    if (!image) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (format == SDImageFormatUndefined) &#123;</div><div class="line">        BOOL hasAlpha = SDCGImageRefContainsAlpha(image.CGImage);</div><div class="line">        if (hasAlpha) &#123;</div><div class="line">            format = SDImageFormatPNG;</div><div class="line">        &#125; else &#123;</div><div class="line">            format = SDImageFormatJPEG;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    NSMutableData *imageData = [NSMutableData data];</div><div class="line">    CFStringRef imageUTType = [NSData sd_UTTypeFromSDImageFormat:format];</div><div class="line">    </div><div class="line">    // Create an image destination.</div><div class="line">    CGImageDestinationRef imageDestination = CGImageDestinationCreateWithData((__bridge CFMutableDataRef)imageData, imageUTType, 1, NULL);</div><div class="line">    if (!imageDestination) &#123;</div><div class="line">        // Handle failure.</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    NSMutableDictionary *properties = [NSMutableDictionary dictionary];</div><div class="line">#if SD_UIKIT || SD_WATCH</div><div class="line">    NSInteger exifOrientation = [SDWebImageCoderHelper exifOrientationFromImageOrientation:image.imageOrientation];</div><div class="line">    [properties setValue:@(exifOrientation) forKey:(__bridge_transfer NSString *)kCGImagePropertyOrientation];</div><div class="line">#endif</div><div class="line">    </div><div class="line">    // Add your image to the destination.</div><div class="line">    CGImageDestinationAddImage(imageDestination, image.CGImage, (__bridge CFDictionaryRef)properties);</div><div class="line">    </div><div class="line">    // Finalize the destination.</div><div class="line">    if (CGImageDestinationFinalize(imageDestination) == NO) &#123;</div><div class="line">        // Handle failure.</div><div class="line">        imageData = nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    CFRelease(imageDestination);</div><div class="line">    </div><div class="line">    return [imageData copy];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…ˆåˆ›å»ºä¸€ä¸ªCGImageDestinationRefï¼Œå¹¶ç»‘å®šä¸€ä¸ªimagedata,ç„¶åè·å–å›¾ç‰‡çš„ç›¸å…³å±æ€§ï¼Œç„¶åå°†å›¾ç‰‡æ•°æ®å’Œç›¸å…³å±æ€§ä¸€èµ·addåˆ°CGImageDestinationRefä¸­ï¼Œè·å–ä¹‹å‰ç»‘å®šçš„imagedataå¹¶è¿”å›ï¼Œæ•´ä¸ªç¼–ç è¿‡ç¨‹ç»“æŸã€‚</p>
<h4 id="SDWebImageGIFCoder"><a href="#SDWebImageGIFCoder" class="headerlink" title="SDWebImageGIFCoder"></a>SDWebImageGIFCoder</h4><p>è¿™ä¸ªç±»ä¸»è¦åšgifçš„ç¼–è§£ç ã€‚ç›´æ¥çœ‹è§£ç å‡½æ•°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div></pre></td><td class="code"><pre><div class="line">- (UIImage *)decodedImageWithData:(NSData *)data &#123;</div><div class="line">    if (!data) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">#if SD_MAC</div><div class="line">    SDAnimatedImageRep *imageRep = [[SDAnimatedImageRep alloc] initWithData:data];</div><div class="line">    NSImage *animatedImage = [[NSImage alloc] initWithSize:imageRep.size];</div><div class="line">    [animatedImage addRepresentation:imageRep];</div><div class="line">    return animatedImage;</div><div class="line">#else</div><div class="line">    </div><div class="line">    CGImageSourceRef source = CGImageSourceCreateWithData((__bridge CFDataRef)data, NULL);</div><div class="line">    if (!source) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    size_t count = CGImageSourceGetCount(source);</div><div class="line">    </div><div class="line">    UIImage *animatedImage;</div><div class="line">    </div><div class="line">    if (count &lt;= 1) &#123;</div><div class="line">        animatedImage = [[UIImage alloc] initWithData:data];</div><div class="line">    &#125; else &#123;</div><div class="line">        NSMutableArray&lt;SDWebImageFrame *&gt; *frames = [NSMutableArray array];</div><div class="line">        </div><div class="line">        for (size_t i = 0; i &lt; count; i++) &#123;</div><div class="line">            CGImageRef imageRef = CGImageSourceCreateImageAtIndex(source, i, NULL);</div><div class="line">            if (!imageRef) &#123;</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            float duration = [self sd_frameDurationAtIndex:i source:source];</div><div class="line">            UIImage *image = [[UIImage alloc] initWithCGImage:imageRef];</div><div class="line">            CGImageRelease(imageRef);</div><div class="line">            </div><div class="line">            SDWebImageFrame *frame = [SDWebImageFrame frameWithImage:image duration:duration];</div><div class="line">            [frames addObject:frame];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        NSUInteger loopCount = 1;</div><div class="line">        NSDictionary *imageProperties = (__bridge_transfer NSDictionary *)CGImageSourceCopyProperties(source, nil);</div><div class="line">        NSDictionary *gifProperties = [imageProperties valueForKey:(__bridge_transfer NSString *)kCGImagePropertyGIFDictionary];</div><div class="line">        if (gifProperties) &#123;</div><div class="line">            NSNumber *gifLoopCount = [gifProperties valueForKey:(__bridge_transfer NSString *)kCGImagePropertyGIFLoopCount];</div><div class="line">            if (gifLoopCount != nil) &#123;</div><div class="line">                loopCount = gifLoopCount.unsignedIntegerValue;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        animatedImage = [SDWebImageCoderHelper animatedImageWithFrames:frames];</div><div class="line">        animatedImage.sd_imageLoopCount = loopCount;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    CFRelease(source);</div><div class="line">    </div><div class="line">    return animatedImage;</div><div class="line">#endif</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>sdè¿™é‡Œè‡ªå®šä¹‰äº†ä¸€ä¸ªSDWebImageFrameç±»ç”¨æ¥å­˜æ”¾æ¯ä¸€å¸§å›¾ç‰‡çš„æ•°æ®ï¼Œç„¶åå°†æ‰€æœ‰å¸§å­˜æ”¾åœ¨ä¸€ä¸ªæ•°ç»„ä¸­ï¼Œç„¶åé€šè¿‡ä¸‹é¢è¿™ä¸ªæ–¹æ³•å°†å¸§æ•°ç»„è½¬ä¸ºä¸€ä¸ªimageå¯¹è±¡,è¿™ä¸ªæ–¹æ³•ç­‰ä¸‹åœ¨åˆ†æhelperç±»çš„æ—¶å€™å†ä¸€èµ·åˆ†æä¸€ä¸‹ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">animatedImage = [SDWebImageCoderHelper animatedImageWithFrames:frames];</div></pre></td></tr></table></figure>
<p>ä¸Šé¢è¿˜ç”¨åˆ°ä¸€ä¸ªæ–¹æ³•æ˜¯å¦‚ä½•è·å–æ¯ä¸€å¸§çš„æ—¶é•¿æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">- (float)sd_frameDurationAtIndex:(NSUInteger)index source:(CGImageSourceRef)source &#123;</div><div class="line">    float frameDuration = 0.1f;</div><div class="line">    CFDictionaryRef cfFrameProperties = CGImageSourceCopyPropertiesAtIndex(source, index, nil);</div><div class="line">    if (!cfFrameProperties) &#123;</div><div class="line">        return frameDuration;</div><div class="line">    &#125;</div><div class="line">    NSDictionary *frameProperties = (__bridge NSDictionary *)cfFrameProperties;</div><div class="line">    NSDictionary *gifProperties = frameProperties[(NSString *)kCGImagePropertyGIFDictionary];</div><div class="line">    </div><div class="line">    NSNumber *delayTimeUnclampedProp = gifProperties[(NSString *)kCGImagePropertyGIFUnclampedDelayTime];</div><div class="line">    if (delayTimeUnclampedProp != nil) &#123;</div><div class="line">        frameDuration = [delayTimeUnclampedProp floatValue];</div><div class="line">    &#125; else &#123;</div><div class="line">        NSNumber *delayTimeProp = gifProperties[(NSString *)kCGImagePropertyGIFDelayTime];</div><div class="line">        if (delayTimeProp != nil) &#123;</div><div class="line">            frameDuration = [delayTimeProp floatValue];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // Many annoying ads specify a 0 duration to make an image flash as quickly as possible.</div><div class="line">    // We follow Firefox&apos;s behavior and use a duration of 100 ms for any frames that specify</div><div class="line">    // a duration of &lt;= 10 ms. See &lt;rdar://problem/7689300&gt; and &lt;http://webkit.org/b/36082&gt;</div><div class="line">    // for more information.</div><div class="line">    </div><div class="line">    if (frameDuration &lt; 0.011f) &#123;</div><div class="line">        frameDuration = 0.100f;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    CFRelease(cfFrameProperties);</div><div class="line">    return frameDuration;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é»˜è®¤æ¯ä¸€å¸§çš„æ—¶é•¿æ˜¯0.1ï¼Œå¦‚æœè·å–propertydicå¤±è´¥ç›´æ¥è¿”å›é»˜è®¤å€¼ï¼Œå¦åˆ™çš„è¯ä»propertydicå–å¯¹åº”çš„valueã€‚</p>
<p>ç„¶åçœ‹ä¸€ä¸‹gifçš„ç¼–ç è¿‡ç¨‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">- (NSData *)encodedDataWithImage:(UIImage *)image format:(SDImageFormat)format &#123;</div><div class="line">    if (!image) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (format != SDImageFormatGIF) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    NSMutableData *imageData = [NSMutableData data];</div><div class="line">    CFStringRef imageUTType = [NSData sd_UTTypeFromSDImageFormat:SDImageFormatGIF];</div><div class="line">    NSArray&lt;SDWebImageFrame *&gt; *frames = [SDWebImageCoderHelper framesFromAnimatedImage:image];</div><div class="line">    </div><div class="line">    // Create an image destination. GIF does not support EXIF image orientation</div><div class="line">    CGImageDestinationRef imageDestination = CGImageDestinationCreateWithData((__bridge CFMutableDataRef)imageData, imageUTType, frames.count, NULL);</div><div class="line">    if (!imageDestination) &#123;</div><div class="line">        // Handle failure.</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    if (frames.count == 0) &#123;</div><div class="line">        // for static single GIF images</div><div class="line">        CGImageDestinationAddImage(imageDestination, image.CGImage, nil);</div><div class="line">    &#125; else &#123;</div><div class="line">        // for animated GIF images</div><div class="line">        NSUInteger loopCount = image.sd_imageLoopCount;</div><div class="line">        NSDictionary *gifProperties = @&#123;(__bridge_transfer NSString *)kCGImagePropertyGIFDictionary: @&#123;(__bridge_transfer NSString *)kCGImagePropertyGIFLoopCount : @(loopCount)&#125;&#125;;</div><div class="line">        CGImageDestinationSetProperties(imageDestination, (__bridge CFDictionaryRef)gifProperties);</div><div class="line">        </div><div class="line">        for (size_t i = 0; i &lt; frames.count; i++) &#123;</div><div class="line">            SDWebImageFrame *frame = frames[i];</div><div class="line">            float frameDuration = frame.duration;</div><div class="line">            CGImageRef frameImageRef = frame.image.CGImage;</div><div class="line">            NSDictionary *frameProperties = @&#123;(__bridge_transfer NSString *)kCGImagePropertyGIFDictionary : @&#123;(__bridge_transfer NSString *)kCGImagePropertyGIFDelayTime : @(frameDuration)&#125;&#125;;</div><div class="line">            CGImageDestinationAddImage(imageDestination, frameImageRef, (__bridge CFDictionaryRef)frameProperties);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    // Finalize the destination.</div><div class="line">    if (CGImageDestinationFinalize(imageDestination) == NO) &#123;</div><div class="line">        // Handle failure.</div><div class="line">        imageData = nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    CFRelease(imageDestination);</div><div class="line">    </div><div class="line">    return [imageData copy];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç¼–ç çš„æ—¶å€™ä¹Ÿæ˜¯éœ€è¦å…ˆè·å–åˆ°SDWebImageFrameæ•°ç»„ï¼Œç„¶åå’Œæ™®é€šå›¾ç‰‡ç¼–ç è¿‡ç¨‹ä¸€æ ·ï¼Œä¹Ÿæ˜¯åˆ›å»ºä¸€ä¸ªCGImageDestinationRefï¼Œç»‘å®šimagedata,ç„¶åéå†SDWebImageFrameæ•°ç»„å°†æ¯ä¸€å¸§å†™å…¥CGImageDestinationRefä¸­ï¼Œç„¶åè·å–imagedataå¹¶è¿”å›ã€‚</p>
<h4 id="SDWebImageWebPCoder"><a href="#SDWebImageWebPCoder" class="headerlink" title="SDWebImageWebPCoder"></a>SDWebImageWebPCoder</h4><p><a href="https://developers.google.com/speed/webp/docs/compression" target="_blank" rel="noopener">è¿™ç¯‡æ–‡ç« ä»‹ç»äº†webpçš„å‹ç¼©ç®—æ³•</a></p>
<p>ä½¿ç”¨webpç›¸å…³çš„ç¼–è§£ç æ–¹æ³•ï¼Œéœ€è¦podä¸­æ·»åŠ ä¸€ä¸ªä¾èµ–ä»“åº“</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">pod &apos;SDWebImage/WebP&apos;</div></pre></td></tr></table></figure>
<p>sdä¸ºwebpæä¾›äº†2ç§è§£ç æ–¹æ³•ï¼Œåˆ†åˆ«æ˜¯éƒ¨åˆ†æ•°æ®çš„è§£ç å’Œå®Œæ•´æ•°æ®çš„è§£ç ã€‚</p>
<p>å…ˆçœ‹å®Œæ•´çš„æ•°æ®è§£ç å‡½æ•°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div></pre></td><td class="code"><pre><div class="line">- (UIImage *)decodedImageWithData:(NSData *)data &#123;</div><div class="line">    if (!data) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    WebPData webpData;</div><div class="line">    WebPDataInit(&amp;webpData);</div><div class="line">    webpData.bytes = data.bytes;</div><div class="line">    webpData.size = data.length;</div><div class="line">    WebPDemuxer *demuxer = WebPDemux(&amp;webpData);</div><div class="line">    if (!demuxer) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    uint32_t flags = WebPDemuxGetI(demuxer, WEBP_FF_FORMAT_FLAGS);</div><div class="line">    int loopCount = WebPDemuxGetI(demuxer, WEBP_FF_LOOP_COUNT);</div><div class="line">    int canvasWidth = WebPDemuxGetI(demuxer, WEBP_FF_CANVAS_WIDTH);</div><div class="line">    int canvasHeight = WebPDemuxGetI(demuxer, WEBP_FF_CANVAS_HEIGHT);</div><div class="line">    CGBitmapInfo bitmapInfo;</div><div class="line">    // `CGBitmapContextCreate` does not support RGB888 on iOS. Where `CGImageCreate` supports.</div><div class="line">    if (!(flags &amp; ALPHA_FLAG)) &#123;</div><div class="line">        // RGBX8888</div><div class="line">        bitmapInfo = kCGBitmapByteOrder32Big | kCGImageAlphaNoneSkipLast;</div><div class="line">    &#125; else &#123;</div><div class="line">        // RGBA8888</div><div class="line">        bitmapInfo = kCGBitmapByteOrder32Big | kCGImageAlphaPremultipliedLast;</div><div class="line">    &#125;</div><div class="line">    CGContextRef canvas = CGBitmapContextCreate(NULL, canvasWidth, canvasHeight, 8, 0, SDCGColorSpaceGetDeviceRGB(), bitmapInfo);</div><div class="line">    if (!canvas) &#123;</div><div class="line">        WebPDemuxDelete(demuxer);</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (!(flags &amp; ANIMATION_FLAG)) &#123;</div><div class="line">        // for static single webp image</div><div class="line">        UIImage *staticImage = [self sd_rawWebpImageWithData:webpData];</div><div class="line">        if (staticImage) &#123;</div><div class="line">            // draw on CGBitmapContext can reduce memory usage</div><div class="line">            CGImageRef imageRef = staticImage.CGImage;</div><div class="line">            size_t width = CGImageGetWidth(imageRef);</div><div class="line">            size_t height = CGImageGetHeight(imageRef);</div><div class="line">            CGContextDrawImage(canvas, CGRectMake(0, 0, width, height), imageRef);</div><div class="line">            CGImageRef newImageRef = CGBitmapContextCreateImage(canvas);</div><div class="line">#if SD_UIKIT || SD_WATCH</div><div class="line">            staticImage = [[UIImage alloc] initWithCGImage:newImageRef];</div><div class="line">#else</div><div class="line">            staticImage = [[UIImage alloc] initWithCGImage:newImageRef size:NSZeroSize];</div><div class="line">#endif</div><div class="line">            CGImageRelease(newImageRef);</div><div class="line">        &#125;</div><div class="line">        WebPDemuxDelete(demuxer);</div><div class="line">        CGContextRelease(canvas);</div><div class="line">        return staticImage;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // for animated webp image</div><div class="line">    WebPIterator iter;</div><div class="line">    if (!WebPDemuxGetFrame(demuxer, 1, &amp;iter)) &#123;</div><div class="line">        WebPDemuxReleaseIterator(&amp;iter);</div><div class="line">        WebPDemuxDelete(demuxer);</div><div class="line">        CGContextRelease(canvas);</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    NSMutableArray&lt;SDWebImageFrame *&gt; *frames = [NSMutableArray array];</div><div class="line">    </div><div class="line">    do &#123;</div><div class="line">        @autoreleasepool &#123;</div><div class="line">            UIImage *image = [self sd_drawnWebpImageWithCanvas:canvas iterator:iter];</div><div class="line">            if (!image) &#123;</div><div class="line">                continue;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            int duration = iter.duration;</div><div class="line">            if (duration &lt;= 10) &#123;</div><div class="line">                // WebP standard says 0 duration is used for canvas updating but not showing image, but actually Chrome and other implementations set it to 100ms if duration is lower or equal than 10ms</div><div class="line">                // Some animated WebP images also created without duration, we should keep compatibility</div><div class="line">                duration = 100;</div><div class="line">            &#125;</div><div class="line">            SDWebImageFrame *frame = [SDWebImageFrame frameWithImage:image duration:duration / 1000.f];</div><div class="line">            [frames addObject:frame];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">    &#125; while (WebPDemuxNextFrame(&amp;iter));</div><div class="line">    </div><div class="line">    WebPDemuxReleaseIterator(&amp;iter);</div><div class="line">    WebPDemuxDelete(demuxer);</div><div class="line">    CGContextRelease(canvas);</div><div class="line">    </div><div class="line">    UIImage *animatedImage = [SDWebImageCoderHelper animatedImageWithFrames:frames];</div><div class="line">    animatedImage.sd_imageLoopCount = loopCount;</div><div class="line">    </div><div class="line">    return animatedImage;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œä¹Ÿæ˜¯åˆ†äº†2ç§ç±»å‹å»è§£ç ï¼Œä¸€ç§æ˜¯é™æ€å›¾ç‰‡ï¼Œç›´æ¥ä½¿ç”¨ä¸‹é¢è¿™ä¸ªæ–¹æ³•æˆ–è€…é™æ€å›¾ç‰‡</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div></pre></td><td class="code"><pre><div class="line">- (nullable UIImage *)sd_rawWebpImageWithData:(WebPData)webpData &#123;</div><div class="line">    WebPDecoderConfig config;</div><div class="line">    if (!WebPInitDecoderConfig(&amp;config)) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (WebPGetFeatures(webpData.bytes, webpData.size, &amp;config.input) != VP8_STATUS_OK) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    config.output.colorspace = config.input.has_alpha ? MODE_rgbA : MODE_RGB;</div><div class="line">    config.options.use_threads = 1;</div><div class="line">    </div><div class="line">    // Decode the WebP image data into a RGBA value array</div><div class="line">    if (WebPDecode(webpData.bytes, webpData.size, &amp;config) != VP8_STATUS_OK) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    int width = config.input.width;</div><div class="line">    int height = config.input.height;</div><div class="line">    if (config.options.use_scaling) &#123;</div><div class="line">        width = config.options.scaled_width;</div><div class="line">        height = config.options.scaled_height;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // Construct a UIImage from the decoded RGBA value array</div><div class="line">    CGDataProviderRef provider =</div><div class="line">    CGDataProviderCreateWithData(NULL, config.output.u.RGBA.rgba, config.output.u.RGBA.size, FreeImageData);</div><div class="line">    CGColorSpaceRef colorSpaceRef = SDCGColorSpaceGetDeviceRGB();</div><div class="line">    CGBitmapInfo bitmapInfo;</div><div class="line">    // `CGBitmapContextCreate` does not support RGB888 on iOS. Where `CGImageCreate` supports.</div><div class="line">    if (!config.input.has_alpha) &#123;</div><div class="line">        // RGB888</div><div class="line">        bitmapInfo = kCGBitmapByteOrder32Big | kCGImageAlphaNone;</div><div class="line">    &#125; else &#123;</div><div class="line">        // RGBA8888</div><div class="line">        bitmapInfo = kCGBitmapByteOrder32Big | kCGImageAlphaPremultipliedLast;</div><div class="line">    &#125;</div><div class="line">    size_t components = config.input.has_alpha ? 4 : 3;</div><div class="line">    CGColorRenderingIntent renderingIntent = kCGRenderingIntentDefault;</div><div class="line">    CGImageRef imageRef = CGImageCreate(width, height, 8, components * 8, components * width, colorSpaceRef, bitmapInfo, provider, NULL, NO, renderingIntent);</div><div class="line">    </div><div class="line">    CGDataProviderRelease(provider);</div><div class="line">    </div><div class="line">#if SD_UIKIT || SD_WATCH</div><div class="line">    UIImage *image = [[UIImage alloc] initWithCGImage:imageRef];</div><div class="line">#else</div><div class="line">    UIImage *image = [[UIImage alloc] initWithCGImage:imageRef size:NSZeroSize];</div><div class="line">#endif</div><div class="line">    CGImageRelease(imageRef);</div><div class="line">    </div><div class="line">    return image;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¦‚æœæ˜¯åŠ¨å›¾çš„è¯ï¼Œå’ŒGIFçš„è§£ç ä¸€æ ·ï¼Œéœ€è¦è·å–ä¸€ä¸ªSDWebImageFrameçš„æ•°ç»„ï¼Œå…ˆä½¿ç”¨ä¸‹é¢è¿™ä¸ªå‡½æ•°è·å–æ¯ä¸€å¸§çš„å›¾ç‰‡æ•°æ®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line">- (nullable UIImage *)sd_drawnWebpImageWithCanvas:(CGContextRef)canvas iterator:(WebPIterator)iter &#123;</div><div class="line">    UIImage *image = [self sd_rawWebpImageWithData:iter.fragment];</div><div class="line">    if (!image) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    size_t canvasWidth = CGBitmapContextGetWidth(canvas);</div><div class="line">    size_t canvasHeight = CGBitmapContextGetHeight(canvas);</div><div class="line">    CGSize size = CGSizeMake(canvasWidth, canvasHeight);</div><div class="line">    CGFloat tmpX = iter.x_offset;</div><div class="line">    CGFloat tmpY = size.height - iter.height - iter.y_offset;</div><div class="line">    CGRect imageRect = CGRectMake(tmpX, tmpY, iter.width, iter.height);</div><div class="line">    BOOL shouldBlend = iter.blend_method == WEBP_MUX_BLEND;</div><div class="line">    </div><div class="line">    // If not blend, cover the target image rect. (firstly clear then draw)</div><div class="line">    if (!shouldBlend) &#123;</div><div class="line">        CGContextClearRect(canvas, imageRect);</div><div class="line">    &#125;</div><div class="line">    CGContextDrawImage(canvas, imageRect, image.CGImage);</div><div class="line">    CGImageRef newImageRef = CGBitmapContextCreateImage(canvas);</div><div class="line">    </div><div class="line">#if SD_UIKIT || SD_WATCH</div><div class="line">    image = [[UIImage alloc] initWithCGImage:newImageRef];</div><div class="line">#elif SD_MAC</div><div class="line">    image = [[UIImage alloc] initWithCGImage:newImageRef size:NSZeroSize];</div><div class="line">#endif</div><div class="line">    </div><div class="line">    CGImageRelease(newImageRef);</div><div class="line">    </div><div class="line">    if (iter.dispose_method == WEBP_MUX_DISPOSE_BACKGROUND) &#123;</div><div class="line">        CGContextClearRect(canvas, imageRect);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return image;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªå‡½æ•°é‡Œé¢å…ˆè°ƒç”¨é™æ€è·å–å›¾ç‰‡çš„æ–¹æ³•ç”Ÿæˆä¸€å¼ å›¾ç‰‡ï¼Œç„¶ååˆ¤æ–­æ˜¯å¦éœ€è¦æ··åˆå½“å‰ä¸Šä¸‹æ–‡ä¸­çš„å†…å®¹ï¼Œå¦‚æœä¸éœ€è¦å°±æ¸…ç©ºä¹‹å‰çš„å†…å®¹ï¼Œå¦‚æœéœ€è¦çš„è¯å°†åˆšç”Ÿæˆçš„å›¾ç‰‡å†å†™å…¥ä¹‹å‰çš„ä¸Šä¸‹æ–‡ä¸­æ··åˆæˆä¸€å¼ æ–°çš„å›¾ã€‚</p>
<p>ç„¶åä½¿ç”¨ä¹‹å‰gifä¸­ä½¿ç”¨è¿‡çš„ä¸‹é¢è¿™ä¸ªå‡½æ•°å°†å¸§æ•°ç»„è½¬ä¸ºä¸€ä¸ªimage</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">UIImage *animatedImage = [SDWebImageCoderHelper animatedImageWithFrames:frames];</div></pre></td></tr></table></figure>
<p>éƒ¨åˆ†æ•°æ®çš„è§£ç å‡½æ•°å¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div></pre></td><td class="code"><pre><div class="line">- (UIImage *)incrementallyDecodedImageWithData:(NSData *)data finished:(BOOL)finished &#123;</div><div class="line">    if (!_idec) &#123;</div><div class="line">        // Progressive images need transparent, so always use premultiplied RGBA</div><div class="line">        _idec = WebPINewRGB(MODE_rgbA, NULL, 0, 0);</div><div class="line">        if (!_idec) &#123;</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    UIImage *image;</div><div class="line">    </div><div class="line">    VP8StatusCode status = WebPIUpdate(_idec, data.bytes, data.length);</div><div class="line">    if (status != VP8_STATUS_OK &amp;&amp; status != VP8_STATUS_SUSPENDED) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    int width = 0;</div><div class="line">    int height = 0;</div><div class="line">    int last_y = 0;</div><div class="line">    int stride = 0;</div><div class="line">    uint8_t *rgba = WebPIDecGetRGB(_idec, &amp;last_y, &amp;width, &amp;height, &amp;stride);</div><div class="line">    // last_y may be 0, means no enough bitmap data to decode, ignore this</div><div class="line">    if (width + height &gt; 0 &amp;&amp; last_y &gt; 0 &amp;&amp; height &gt;= last_y) &#123;</div><div class="line">        // Construct a UIImage from the decoded RGBA value array</div><div class="line">        size_t rgbaSize = last_y * stride;</div><div class="line">        CGDataProviderRef provider =</div><div class="line">        CGDataProviderCreateWithData(NULL, rgba, rgbaSize, NULL);</div><div class="line">        CGColorSpaceRef colorSpaceRef = SDCGColorSpaceGetDeviceRGB();</div><div class="line">        </div><div class="line">        CGBitmapInfo bitmapInfo = kCGBitmapByteOrder32Big | kCGImageAlphaPremultipliedLast;</div><div class="line">        size_t components = 4;</div><div class="line">        CGColorRenderingIntent renderingIntent = kCGRenderingIntentDefault;</div><div class="line">        // Why to use last_y for image height is because of libwebp&apos;s bug (https://bugs.chromium.org/p/webp/issues/detail?id=362)</div><div class="line">        // It will not keep memory barrier safe on x86 architechure (macOS &amp; iPhone simulator) but on ARM architecture (iPhone &amp; iPad &amp; tv &amp; watch) it works great</div><div class="line">        // If different threads use WebPIDecGetRGB to grab rgba bitmap, it will contain the previous decoded bitmap data</div><div class="line">        // So this will cause our drawed image looks strange(above is the current part but below is the previous part)</div><div class="line">        // We only grab the last_y height and draw the last_y heigh instead of total height image</div><div class="line">        // Besides fix, this can enhance performance since we do not need to create extra bitmap</div><div class="line">        CGImageRef imageRef = CGImageCreate(width, last_y, 8, components * 8, components * width, colorSpaceRef, bitmapInfo, provider, NULL, NO, renderingIntent);</div><div class="line">        </div><div class="line">        CGDataProviderRelease(provider);</div><div class="line">        </div><div class="line">        if (!imageRef) &#123;</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        CGContextRef canvas = CGBitmapContextCreate(NULL, width, height, 8, 0, SDCGColorSpaceGetDeviceRGB(), bitmapInfo);</div><div class="line">        if (!canvas) &#123;</div><div class="line">            CGImageRelease(imageRef);</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        // Only draw the last_y image height, keep remains transparent, in Core Graphics coordinate system</div><div class="line">        CGContextDrawImage(canvas, CGRectMake(0, height - last_y, width, last_y), imageRef);</div><div class="line">        CGImageRef newImageRef = CGBitmapContextCreateImage(canvas);</div><div class="line">        CGImageRelease(imageRef);</div><div class="line">        if (!newImageRef) &#123;</div><div class="line">            CGContextRelease(canvas);</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">#if SD_UIKIT || SD_WATCH</div><div class="line">        image = [[UIImage alloc] initWithCGImage:newImageRef];</div><div class="line">#else</div><div class="line">        image = [[UIImage alloc] initWithCGImage:newImageRef size:NSZeroSize];</div><div class="line">#endif</div><div class="line">        CGImageRelease(newImageRef);</div><div class="line">        CGContextRelease(canvas);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (finished) &#123;</div><div class="line">        if (_idec) &#123;</div><div class="line">            WebPIDelete(_idec);</div><div class="line">            _idec = NULL;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return image;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æµç¨‹éƒ½å’Œä¹‹å‰çš„å…¶ä»–æ ¼å¼éƒ¨åˆ†è§£ç å‡½æ•°å·®ä¸å¤šå§ï¼Œåªæ˜¯æœ‰å†™apiçš„å°å·®å¼‚ã€‚</p>
<p>è§£ç çš„éƒ¨åˆ†å·®ä¸å¤šå°±è¿™äº›ï¼Œæ¥ç€çœ‹ä¸€ä¸‹ç¼–ç çš„éƒ¨åˆ†æ˜¯å¦‚ä½•å®ç°çš„ï¼Œç›´æ¥ä¸Šä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div></pre></td><td class="code"><pre><div class="line">- (NSData *)encodedDataWithImage:(UIImage *)image format:(SDImageFormat)format &#123;</div><div class="line">    if (!image) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    NSData *data;</div><div class="line">    </div><div class="line">    NSArray&lt;SDWebImageFrame *&gt; *frames = [SDWebImageCoderHelper framesFromAnimatedImage:image];</div><div class="line">    if (frames.count == 0) &#123;</div><div class="line">        // for static single webp image</div><div class="line">        data = [self sd_encodedWebpDataWithImage:image];</div><div class="line">    &#125; else &#123;</div><div class="line">        // for animated webp image</div><div class="line">        WebPMux *mux = WebPMuxNew();</div><div class="line">        if (!mux) &#123;</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">        for (size_t i = 0; i &lt; frames.count; i++) &#123;</div><div class="line">            SDWebImageFrame *currentFrame = frames[i];</div><div class="line">            NSData *webpData = [self sd_encodedWebpDataWithImage:currentFrame.image];</div><div class="line">            int duration = currentFrame.duration * 1000;</div><div class="line">            WebPMuxFrameInfo frame = &#123; .bitstream.bytes = webpData.bytes,</div><div class="line">                .bitstream.size = webpData.length,</div><div class="line">                .duration = duration,</div><div class="line">                .id = WEBP_CHUNK_ANMF,</div><div class="line">                .dispose_method = WEBP_MUX_DISPOSE_BACKGROUND, // each frame will clear canvas</div><div class="line">                .blend_method = WEBP_MUX_NO_BLEND</div><div class="line">            &#125;;</div><div class="line">            if (WebPMuxPushFrame(mux, &amp;frame, 0) != WEBP_MUX_OK) &#123;</div><div class="line">                WebPMuxDelete(mux);</div><div class="line">                return nil;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        int loopCount = (int)image.sd_imageLoopCount;</div><div class="line">        WebPMuxAnimParams params = &#123; .bgcolor = 0,</div><div class="line">            .loop_count = loopCount</div><div class="line">        &#125;;</div><div class="line">        if (WebPMuxSetAnimationParams(mux, &amp;params) != WEBP_MUX_OK) &#123;</div><div class="line">            WebPMuxDelete(mux);</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        WebPData outputData;</div><div class="line">        WebPMuxError error = WebPMuxAssemble(mux, &amp;outputData);</div><div class="line">        WebPMuxDelete(mux);</div><div class="line">        if (error != WEBP_MUX_OK) &#123;</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">        data = [NSData dataWithBytes:outputData.bytes length:outputData.size];</div><div class="line">        WebPDataClear(&amp;outputData);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return data;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å’Œgifçš„ç¼–ç æµç¨‹ç›¸ä¼¼ï¼Œå…ˆè·å–åˆ°è¿™å¼ å›¾çš„æ‰€æœ‰å¸§ï¼Œï¼ˆé™æ€å›¾ç‰‡åªæœ‰ä¸€å¸§ï¼Œç›´æ¥è°ƒç”¨å¤„ç†æ¯ä¸€å¸§çš„ç¼–ç å‡½æ•°è¿›è¡Œå¤„ç†ï¼‰ï¼Œç„¶åå¾ªç¯å¤„ç†æ¯ä¸€å¸§çš„æ•°æ®ï¼Œç„¶åå°†å¤„ç†å®Œçš„æ¯ä¸€å¸§æ•°æ®å­˜æ”¾åˆ°WebPMuxFrameInfoè¿™ä¸ªç»“æ„ä½“ï¼Œå†å°†æ¯ä¸ªç»“æ„ä½“addåˆ°WebPMuxè¿™ä¸ªç±»é‡Œé¢ï¼Œå¾ªç¯ç»“æŸä»WebPMuxè¿™ä¸ªç±»ä¸­å–å‡ºæ•°æ®å¹¶è¿”å›ã€‚</p>
<p>ä¸‹é¢è¿™ä¸ªå‡½æ•°æ˜¯å…·ä½“å¤„ç†æ¯ä¸€å¸§çš„æ•°æ®çš„ç¼–ç ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div></pre></td><td class="code"><pre><div class="line">- (nullable NSData *)sd_encodedWebpDataWithImage:(nullable UIImage *)image &#123;</div><div class="line">    if (!image) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    NSData *webpData;</div><div class="line">    CGImageRef imageRef = image.CGImage;</div><div class="line">    </div><div class="line">    size_t width = CGImageGetWidth(imageRef);</div><div class="line">    size_t height = CGImageGetHeight(imageRef);</div><div class="line">    if (width == 0 || width &gt; WEBP_MAX_DIMENSION) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    if (height == 0 || height &gt; WEBP_MAX_DIMENSION) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    size_t bytesPerRow = CGImageGetBytesPerRow(imageRef);</div><div class="line">    CGBitmapInfo bitmapInfo = CGImageGetBitmapInfo(imageRef);</div><div class="line">    CGImageAlphaInfo alphaInfo = bitmapInfo &amp; kCGBitmapAlphaInfoMask;</div><div class="line">    CGBitmapInfo byteOrderInfo = bitmapInfo &amp; kCGBitmapByteOrderMask;</div><div class="line">    BOOL hasAlpha = !(alphaInfo == kCGImageAlphaNone ||</div><div class="line">                      alphaInfo == kCGImageAlphaNoneSkipFirst ||</div><div class="line">                      alphaInfo == kCGImageAlphaNoneSkipLast);</div><div class="line">    BOOL byteOrderNormal = NO;</div><div class="line">    switch (byteOrderInfo) &#123;</div><div class="line">        case kCGBitmapByteOrderDefault: &#123;</div><div class="line">            byteOrderNormal = YES;</div><div class="line">        &#125; break;</div><div class="line">        case kCGBitmapByteOrder32Little: &#123;</div><div class="line">        &#125; break;</div><div class="line">        case kCGBitmapByteOrder32Big: &#123;</div><div class="line">            byteOrderNormal = YES;</div><div class="line">        &#125; break;</div><div class="line">        default: break;</div><div class="line">    &#125;</div><div class="line">    // If we can not get bitmap buffer, early return</div><div class="line">    CGDataProviderRef dataProvider = CGImageGetDataProvider(imageRef);</div><div class="line">    if (!dataProvider) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    CFDataRef dataRef = CGDataProviderCopyData(dataProvider);</div><div class="line">    if (!dataRef) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    uint8_t *rgba = NULL;</div><div class="line">    // We could not assume that input CGImage&apos;s color mode is always RGB888/RGBA8888. Convert all other cases to target color mode using vImage</div><div class="line">    if (byteOrderNormal &amp;&amp; ((alphaInfo == kCGImageAlphaNone) || (alphaInfo == kCGImageAlphaLast))) &#123;</div><div class="line">        // If the input CGImage is already RGB888/RGBA8888</div><div class="line">        rgba = (uint8_t *)CFDataGetBytePtr(dataRef);</div><div class="line">    &#125; else &#123;</div><div class="line">        // Convert all other cases to target color mode using vImage</div><div class="line">        vImageConverterRef convertor = NULL;</div><div class="line">        vImage_Error error = kvImageNoError;</div><div class="line">        </div><div class="line">        vImage_CGImageFormat srcFormat = &#123;</div><div class="line">            .bitsPerComponent = (uint32_t)CGImageGetBitsPerComponent(imageRef),</div><div class="line">            .bitsPerPixel = (uint32_t)CGImageGetBitsPerPixel(imageRef),</div><div class="line">            .colorSpace = CGImageGetColorSpace(imageRef),</div><div class="line">            .bitmapInfo = bitmapInfo</div><div class="line">        &#125;;</div><div class="line">        vImage_CGImageFormat destFormat = &#123;</div><div class="line">            .bitsPerComponent = 8,</div><div class="line">            .bitsPerPixel = hasAlpha ? 32 : 24,</div><div class="line">            .colorSpace = SDCGColorSpaceGetDeviceRGB(),</div><div class="line">            .bitmapInfo = hasAlpha ? kCGImageAlphaLast | kCGBitmapByteOrderDefault : kCGImageAlphaNone | kCGBitmapByteOrderDefault // RGB888/RGBA8888 (Non-premultiplied to works for libwebp)</div><div class="line">        &#125;;</div><div class="line">        </div><div class="line">        convertor = vImageConverter_CreateWithCGImageFormat(&amp;srcFormat, &amp;destFormat, NULL, kvImageNoFlags, &amp;error);</div><div class="line">        if (error != kvImageNoError) &#123;</div><div class="line">            CFRelease(dataRef);</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        vImage_Buffer src = &#123;</div><div class="line">            .data = (uint8_t *)CFDataGetBytePtr(dataRef),</div><div class="line">            .width = width,</div><div class="line">            .height = height,</div><div class="line">            .rowBytes = bytesPerRow</div><div class="line">        &#125;;</div><div class="line">        vImage_Buffer dest;</div><div class="line">        </div><div class="line">        error = vImageBuffer_Init(&amp;dest, height, width, destFormat.bitsPerPixel, kvImageNoFlags);</div><div class="line">        if (error != kvImageNoError) &#123;</div><div class="line">            CFRelease(dataRef);</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        // Convert input color mode to RGB888/RGBA8888</div><div class="line">        error = vImageConvert_AnyToAny(convertor, &amp;src, &amp;dest, NULL, kvImageNoFlags);</div><div class="line">        if (error != kvImageNoError) &#123;</div><div class="line">            CFRelease(dataRef);</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        rgba = dest.data; // Converted buffer</div><div class="line">        bytesPerRow = dest.rowBytes; // Converted bytePerRow</div><div class="line">        CFRelease(dataRef);</div><div class="line">        dataRef = NULL;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    uint8_t *data = NULL; // Output WebP data</div><div class="line">    float qualityFactor = 100; // WebP quality is 0-100</div><div class="line">    // Encode RGB888/RGBA8888 buffer to WebP data</div><div class="line">    size_t size;</div><div class="line">    if (hasAlpha) &#123;</div><div class="line">        size = WebPEncodeRGBA(rgba, (int)width, (int)height, (int)bytesPerRow, qualityFactor, &amp;data);</div><div class="line">    &#125; else &#123;</div><div class="line">        size = WebPEncodeRGB(rgba, (int)width, (int)height, (int)bytesPerRow, qualityFactor, &amp;data);</div><div class="line">    &#125;</div><div class="line">    if (dataRef) &#123;</div><div class="line">        CFRelease(dataRef); // free non-converted rgba buffer</div><div class="line">        dataRef = NULL;</div><div class="line">    &#125; else &#123;</div><div class="line">        free(rgba); // free converted rgba buffer</div><div class="line">        rgba = NULL;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (size) &#123;</div><div class="line">        // success</div><div class="line">        webpData = [NSData dataWithBytes:data length:size];</div><div class="line">    &#125;</div><div class="line">    if (data) &#123;</div><div class="line">        WebPFree(data);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return webpData;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å’Œä¹‹å‰çš„å…¶ä»–å›¾ç‰‡çš„ç¼–ç ä¸ä¸€æ ·ï¼Œå®ƒè¿™é‡Œæ²¡æœ‰ä½¿ç”¨CGImageDestinationRefè¿™ä¸ªç»“æ„å¤„ç†ç¼–ç ï¼Œè€Œæ˜¯ä½¿ç”¨çš„webpåº“æä¾›çš„ç¼–ç æ–¹æ³•ã€‚å…ˆåˆ›å»ºvImageConverterRefè¿™ä¸ªå¯¹è±¡ï¼Œç„¶åè®¾ç½®ç¼–ç å‰çš„æ ¼å¼å’Œç¼–ç åçš„æ ¼å¼ï¼Œç„¶ååˆå§‹åŒ–vImageConverterRefå¯¹è±¡ï¼Œç„¶ååˆå§‹åŒ–vImage_Bufferï¼Œæœ€åè°ƒç”¨vImageConvert_AnyToAnyæ–¹æ³•è¿›è¡Œæ ¼å¼è½¬æ¢ï¼Œæœ€åè°ƒç”¨WebPEncodeRGBAç”Ÿæˆæœ€ç»ˆéœ€è¦è¿”å›çš„æ•°æ®ã€‚<br>æ•´ä¸ªè¿‡ç¨‹å’Œä½¿ç”¨AudioUnitè¿›è¡ŒéŸ³é¢‘æ ¼å¼è½¬æ¢å¾ˆç›¸ä¼¼ã€‚</p>
<h4 id="SDWebImageCodersManager"><a href="#SDWebImageCodersManager" class="headerlink" title="SDWebImageCodersManager"></a>SDWebImageCodersManager</h4><p>è¿™ä¸ªç±»å°±æ˜¯å¯¹ä¸Šé¢è¿™å‡ ä¸ªç¼–è§£ç ç±»çš„ä½¿ç”¨çš„ä¸€ä¸ªå°è£…ï¼Œçœ‹åˆå§‹åŒ–å‡½æ•°é»˜è®¤åªä½¿ç”¨äº†SDWebImageImageIOCoderè¿™ä¸ªç±»ä½œä¸ºå½“å‰ç¼–è§£ç ç±»ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">- (instancetype)init &#123;</div><div class="line">    if (self = [super init]) &#123;</div><div class="line">        // initialize with default coders</div><div class="line">        NSMutableArray&lt;id&lt;SDWebImageCoder&gt;&gt; *mutableCoders = [@[[SDWebImageImageIOCoder sharedCoder]] mutableCopy];</div><div class="line">#ifdef SD_WEBP</div><div class="line">        [mutableCoders addObject:[SDWebImageWebPCoder sharedCoder]];</div><div class="line">#endif</div><div class="line">        _coders = [mutableCoders copy];</div><div class="line">        _codersLock = dispatch_semaphore_create(1);</div><div class="line">    &#125;</div><div class="line">    return self;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å½“ç„¶ï¼Œä½ å¯ä»¥é€šè¿‡ä¸‹é¢è¿™ä¸ªæ–¹æ³•æ‰‹åŠ¨çš„æ·»åŠ å’Œç§»é™¤ä½ éœ€è¦çš„ç¼–è§£ç ç±»ï¼Œæ¯”å¦‚gifçš„Coder</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">- (void)addCoder:(nonnull id&lt;SDWebImageCoder&gt;)coder &#123;</div><div class="line">    if (![coder conformsToProtocol:@protocol(SDWebImageCoder)]) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    LOCK(self.codersLock);</div><div class="line">    NSMutableArray&lt;id&lt;SDWebImageCoder&gt;&gt; *mutableCoders = [self.coders mutableCopy];</div><div class="line">    if (!mutableCoders) &#123;</div><div class="line">        mutableCoders = [NSMutableArray array];</div><div class="line">    &#125;</div><div class="line">    [mutableCoders addObject:coder];</div><div class="line">    self.coders = [mutableCoders copy];</div><div class="line">    UNLOCK(self.codersLock);</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)removeCoder:(nonnull id&lt;SDWebImageCoder&gt;)coder &#123;</div><div class="line">    if (![coder conformsToProtocol:@protocol(SDWebImageCoder)]) &#123;</div><div class="line">        return;</div><div class="line">    &#125;</div><div class="line">    LOCK(self.codersLock);</div><div class="line">    NSMutableArray&lt;id&lt;SDWebImageCoder&gt;&gt; *mutableCoders = [self.coders mutableCopy];</div><div class="line">    [mutableCoders removeObject:coder];</div><div class="line">    self.coders = [mutableCoders copy];</div><div class="line">    UNLOCK(self.codersLock);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åå®ƒæä¾›äº†ç›´æ¥å¯¹æ•°æ®è¿›è¡Œç¼–è§£ç çš„æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">- (UIImage *)decodedImageWithData:(NSData *)data &#123;</div><div class="line">    LOCK(self.codersLock);</div><div class="line">    NSArray&lt;id&lt;SDWebImageCoder&gt;&gt; *coders = self.coders;</div><div class="line">    UNLOCK(self.codersLock);</div><div class="line">    for (id&lt;SDWebImageCoder&gt; coder in coders.reverseObjectEnumerator) &#123;</div><div class="line">        if ([coder canDecodeFromData:data]) &#123;</div><div class="line">            return [coder decodedImageWithData:data];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return nil;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (UIImage *)decompressedImageWithImage:(UIImage *)image</div><div class="line">                                   data:(NSData *__autoreleasing  _Nullable *)data</div><div class="line">                                options:(nullable NSDictionary&lt;NSString*, NSObject*&gt;*)optionsDict &#123;</div><div class="line">    if (!image) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    LOCK(self.codersLock);</div><div class="line">    NSArray&lt;id&lt;SDWebImageCoder&gt;&gt; *coders = self.coders;</div><div class="line">    UNLOCK(self.codersLock);</div><div class="line">    for (id&lt;SDWebImageCoder&gt; coder in coders.reverseObjectEnumerator) &#123;</div><div class="line">        if ([coder canDecodeFromData:*data]) &#123;</div><div class="line">            return [coder decompressedImageWithImage:image data:data options:optionsDict];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return nil;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSData *)encodedDataWithImage:(UIImage *)image format:(SDImageFormat)format &#123;</div><div class="line">    if (!image) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    LOCK(self.codersLock);</div><div class="line">    NSArray&lt;id&lt;SDWebImageCoder&gt;&gt; *coders = self.coders;</div><div class="line">    UNLOCK(self.codersLock);</div><div class="line">    for (id&lt;SDWebImageCoder&gt; coder in coders.reverseObjectEnumerator) &#123;</div><div class="line">        if ([coder canEncodeToFormat:format]) &#123;</div><div class="line">            return [coder encodedDataWithImage:image format:format];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return nil;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>é€šè¿‡åˆ¤æ–­ä¼ å…¥çš„æ•°æ®æ˜¯å¦æ”¯æŒç¼–è§£ç ï¼Œå¦‚æœæ”¯æŒå°±è°ƒç”¨å¯¹åº”çš„ç¼–è§£ç å‡½æ•°ï¼Œå¦‚æœä¸æ”¯æŒç›´æ¥è¿”å›ç©ºã€‚</p>
<h4 id="SDWebImageCoderHelper"><a href="#SDWebImageCoderHelper" class="headerlink" title="SDWebImageCoderHelper"></a>SDWebImageCoderHelper</h4><p>æœ€åæ¥çœ‹ä¸€ä¸‹è¿™ä¸ªHelper,è¯¥ç±»æä¾›äº†å‡ ä¸ªé€šç”¨çš„æ–¹æ³•ï¼Œä¸»è¦æœ‰ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">//ä½¿ç”¨SDWebImageFrameå¸§åºåˆ—åˆ›å»ºå›¾ç‰‡</div><div class="line">+ (UIImage * _Nullable)animatedImageWithFrames:(NSArray&lt;SDWebImageFrame *&gt; * _Nullable)frames;</div><div class="line">//è·å–å›¾ç‰‡çš„æ‰€æœ‰å¸§æ•°æ®</div><div class="line">+ (NSArray&lt;SDWebImageFrame *&gt; * _Nullable)framesFromAnimatedImage:(UIImage * _Nullable)animatedImage;</div><div class="line">//åˆ¤æ–­å›¾ç‰‡çš„æœå‘</div><div class="line">+ (UIImageOrientation)imageOrientationFromEXIFOrientation:(NSInteger)exifOrientation;</div><div class="line">//å°†sdçš„æœå‘è½¬ä¸ºæ–‡ä»¶ä¸­åº”è¯¥çš„å€¼</div><div class="line">+ (NSInteger)exifOrientationFromImageOrientation:(UIImageOrientation)imageOrientation;</div></pre></td></tr></table></figure>
<p>çœ‹ä¸€ä¸‹å…·ä½“å®ç°éƒ¨åˆ†ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line">+ (UIImage *)animatedImageWithFrames:(NSArray&lt;SDWebImageFrame *&gt; *)frames &#123;</div><div class="line">    NSUInteger frameCount = frames.count;</div><div class="line">    if (frameCount == 0) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    UIImage *animatedImage;</div><div class="line">    </div><div class="line">#if SD_UIKIT || SD_WATCH</div><div class="line">    NSUInteger durations[frameCount];</div><div class="line">    for (size_t i = 0; i &lt; frameCount; i++) &#123;</div><div class="line">        durations[i] = frames[i].duration * 1000;</div><div class="line">    &#125;</div><div class="line">    NSUInteger const gcd = gcdArray(frameCount, durations);</div><div class="line">    __block NSUInteger totalDuration = 0;</div><div class="line">    NSMutableArray&lt;UIImage *&gt; *animatedImages = [NSMutableArray arrayWithCapacity:frameCount];</div><div class="line">    [frames enumerateObjectsUsingBlock:^(SDWebImageFrame * _Nonnull frame, NSUInteger idx, BOOL * _Nonnull stop) &#123;</div><div class="line">        UIImage *image = frame.image;</div><div class="line">        NSUInteger duration = frame.duration * 1000;</div><div class="line">        totalDuration += duration;</div><div class="line">        NSUInteger repeatCount;</div><div class="line">        if (gcd) &#123;</div><div class="line">            repeatCount = duration / gcd;</div><div class="line">        &#125; else &#123;</div><div class="line">            repeatCount = 1;</div><div class="line">        &#125;</div><div class="line">        for (size_t i = 0; i &lt; repeatCount; ++i) &#123;</div><div class="line">            [animatedImages addObject:image];</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">    animatedImage = [UIImage animatedImageWithImages:animatedImages duration:totalDuration / 1000.f];</div><div class="line">    </div><div class="line">#else</div><div class="line">    </div><div class="line">    NSMutableData *imageData = [NSMutableData data];</div><div class="line">    CFStringRef imageUTType = [NSData sd_UTTypeFromSDImageFormat:SDImageFormatGIF];</div><div class="line">    // Create an image destination. GIF does not support EXIF image orientation</div><div class="line">    CGImageDestinationRef imageDestination = CGImageDestinationCreateWithData((__bridge CFMutableDataRef)imageData, imageUTType, frameCount, NULL);</div><div class="line">    if (!imageDestination) &#123;</div><div class="line">        // Handle failure.</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    for (size_t i = 0; i &lt; frameCount; i++) &#123;</div><div class="line">        @autoreleasepool &#123;</div><div class="line">            SDWebImageFrame *frame = frames[i];</div><div class="line">            float frameDuration = frame.duration;</div><div class="line">            CGImageRef frameImageRef = frame.image.CGImage;</div><div class="line">            NSDictionary *frameProperties = @&#123;(__bridge_transfer NSString *)kCGImagePropertyGIFDictionary : @&#123;(__bridge_transfer NSString *)kCGImagePropertyGIFDelayTime : @(frameDuration)&#125;&#125;;</div><div class="line">            CGImageDestinationAddImage(imageDestination, frameImageRef, (__bridge CFDictionaryRef)frameProperties);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    // Finalize the destination.</div><div class="line">    if (CGImageDestinationFinalize(imageDestination) == NO) &#123;</div><div class="line">        // Handle failure.</div><div class="line">        CFRelease(imageDestination);</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    CFRelease(imageDestination);</div><div class="line">    SDAnimatedImageRep *imageRep = [[SDAnimatedImageRep alloc] initWithData:imageData];</div><div class="line">    animatedImage = [[NSImage alloc] initWithSize:imageRep.size];</div><div class="line">    [animatedImage addRepresentation:imageRep];</div><div class="line">#endif</div><div class="line">    </div><div class="line">    return animatedImage;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¸§æ•°ç»„è½¬å›¾ç‰‡ï¼Œå¦‚æœæ˜¯iOSå¹³å°ï¼Œä¸»è¦è°ƒç”¨UIImageçš„<strong>animatedImageWithImages:duration</strong>æ–¹æ³•åˆ›å»ºï¼Œmacå¹³å°ä¸Šæˆ‘ä»¬çœ‹åˆ°äº†ç†Ÿæ‚‰çš„èº«å½±CGImageDestinationRefï¼Œè¿™ä¸ªä¹‹å‰åœ¨åšç¼–ç çš„æ—¶å€™ç”¨åˆ°è¿‡ã€‚</p>
<p>ç„¶åæ˜¯å›¾ç‰‡è½¬å¸§æ•°ç»„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line">+ (NSArray&lt;SDWebImageFrame *&gt; *)framesFromAnimatedImage:(UIImage *)animatedImage &#123;</div><div class="line">    if (!animatedImage) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    NSMutableArray&lt;SDWebImageFrame *&gt; *frames = [NSMutableArray array];</div><div class="line">    NSUInteger frameCount = 0;</div><div class="line">    </div><div class="line">#if SD_UIKIT || SD_WATCH</div><div class="line">    NSArray&lt;UIImage *&gt; *animatedImages = animatedImage.images;</div><div class="line">    frameCount = animatedImages.count;</div><div class="line">    if (frameCount == 0) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    NSTimeInterval avgDuration = animatedImage.duration / frameCount;</div><div class="line">    if (avgDuration == 0) &#123;</div><div class="line">        avgDuration = 0.1; // if it&apos;s a animated image but no duration, set it to default 100ms (this do not have that 10ms limit like GIF or WebP to allow custom coder provide the limit)</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    __block NSUInteger index = 0;</div><div class="line">    __block NSUInteger repeatCount = 1;</div><div class="line">    __block UIImage *previousImage = animatedImages.firstObject;</div><div class="line">    [animatedImages enumerateObjectsUsingBlock:^(UIImage * _Nonnull image, NSUInteger idx, BOOL * _Nonnull stop) &#123;</div><div class="line">        // ignore first</div><div class="line">        if (idx == 0) &#123;</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        if ([image isEqual:previousImage]) &#123;</div><div class="line">            repeatCount++;</div><div class="line">        &#125; else &#123;</div><div class="line">            SDWebImageFrame *frame = [SDWebImageFrame frameWithImage:previousImage duration:avgDuration * repeatCount];</div><div class="line">            [frames addObject:frame];</div><div class="line">            repeatCount = 1;</div><div class="line">            index++;</div><div class="line">        &#125;</div><div class="line">        previousImage = image;</div><div class="line">        // last one</div><div class="line">        if (idx == frameCount - 1) &#123;</div><div class="line">            SDWebImageFrame *frame = [SDWebImageFrame frameWithImage:previousImage duration:avgDuration * repeatCount];</div><div class="line">            [frames addObject:frame];</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line">    </div><div class="line">#else</div><div class="line">    </div><div class="line">    NSBitmapImageRep *bitmapRep;</div><div class="line">    for (NSImageRep *imageRep in animatedImage.representations) &#123;</div><div class="line">        if ([imageRep isKindOfClass:[NSBitmapImageRep class]]) &#123;</div><div class="line">            bitmapRep = (NSBitmapImageRep *)imageRep;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    if (bitmapRep) &#123;</div><div class="line">        frameCount = [[bitmapRep valueForProperty:NSImageFrameCount] unsignedIntegerValue];</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (frameCount == 0) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    for (size_t i = 0; i &lt; frameCount; i++) &#123;</div><div class="line">        @autoreleasepool &#123;</div><div class="line">            // NSBitmapImageRep need to manually change frame. &quot;Good taste&quot; API</div><div class="line">            [bitmapRep setProperty:NSImageCurrentFrame withValue:@(i)];</div><div class="line">            float frameDuration = [[bitmapRep valueForProperty:NSImageCurrentFrameDuration] floatValue];</div><div class="line">            NSImage *frameImage = [[NSImage alloc] initWithCGImage:bitmapRep.CGImage size:CGSizeZero];</div><div class="line">            SDWebImageFrame *frame = [SDWebImageFrame frameWithImage:frameImage duration:frameDuration];</div><div class="line">            [frames addObject:frame];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">#endif</div><div class="line">    </div><div class="line">    return frames;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¹Ÿæ˜¯åˆ†äº†iOSå’Œmac2ä¸ªå¹³å°ï¼ŒiOSä¸Šç›´æ¥å»UIImageçš„imageså±æ€§éå†ä¸€éï¼Œmacä¸Šä½¿ç”¨äº†NSBitmapImageRepè¿™ä¸ªå¯¹è±¡è·å–å›¾ç‰‡çš„æ‰€æœ‰å¸§æ•°æ®ï¼Œç„¶ååœ¨å¾ªç¯ä¸­ä»è¿™ä¸ªå¯¹è±¡ä¸­å–å‡ºæ‰€æœ‰çš„å¸§æ•°æ®ã€‚</p>
<p>ä¸‹é¢è¿™2ä¸ªæ˜¯æœå‘è½¬æ¢çš„å‡½æ•°ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">#if SD_UIKIT || SD_WATCH</div><div class="line">// Convert an EXIF image orientation to an iOS one.</div><div class="line">+ (UIImageOrientation)imageOrientationFromEXIFOrientation:(NSInteger)exifOrientation &#123;</div><div class="line">    // CGImagePropertyOrientation is available on iOS 8 above. Currently kept for compatibility</div><div class="line">    UIImageOrientation imageOrientation = UIImageOrientationUp;</div><div class="line">    switch (exifOrientation) &#123;</div><div class="line">        case 1:</div><div class="line">            imageOrientation = UIImageOrientationUp;</div><div class="line">            break;</div><div class="line">        case 3:</div><div class="line">            imageOrientation = UIImageOrientationDown;</div><div class="line">            break;</div><div class="line">        case 8:</div><div class="line">            imageOrientation = UIImageOrientationLeft;</div><div class="line">            break;</div><div class="line">        case 6:</div><div class="line">            imageOrientation = UIImageOrientationRight;</div><div class="line">            break;</div><div class="line">        case 2:</div><div class="line">            imageOrientation = UIImageOrientationUpMirrored;</div><div class="line">            break;</div><div class="line">        case 4:</div><div class="line">            imageOrientation = UIImageOrientationDownMirrored;</div><div class="line">            break;</div><div class="line">        case 5:</div><div class="line">            imageOrientation = UIImageOrientationLeftMirrored;</div><div class="line">            break;</div><div class="line">        case 7:</div><div class="line">            imageOrientation = UIImageOrientationRightMirrored;</div><div class="line">            break;</div><div class="line">        default:</div><div class="line">            break;</div><div class="line">    &#125;</div><div class="line">    return imageOrientation;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// Convert an iOS orientation to an EXIF image orientation.</div><div class="line">+ (NSInteger)exifOrientationFromImageOrientation:(UIImageOrientation)imageOrientation &#123;</div><div class="line">    // CGImagePropertyOrientation is available on iOS 8 above. Currently kept for compatibility</div><div class="line">    NSInteger exifOrientation = 1;</div><div class="line">    switch (imageOrientation) &#123;</div><div class="line">        case UIImageOrientationUp:</div><div class="line">            exifOrientation = 1;</div><div class="line">            break;</div><div class="line">        case UIImageOrientationDown:</div><div class="line">            exifOrientation = 3;</div><div class="line">            break;</div><div class="line">        case UIImageOrientationLeft:</div><div class="line">            exifOrientation = 8;</div><div class="line">            break;</div><div class="line">        case UIImageOrientationRight:</div><div class="line">            exifOrientation = 6;</div><div class="line">            break;</div><div class="line">        case UIImageOrientationUpMirrored:</div><div class="line">            exifOrientation = 2;</div><div class="line">            break;</div><div class="line">        case UIImageOrientationDownMirrored:</div><div class="line">            exifOrientation = 4;</div><div class="line">            break;</div><div class="line">        case UIImageOrientationLeftMirrored:</div><div class="line">            exifOrientation = 5;</div><div class="line">            break;</div><div class="line">        case UIImageOrientationRightMirrored:</div><div class="line">            exifOrientation = 7;</div><div class="line">            break;</div><div class="line">        default:</div><div class="line">            break;</div><div class="line">    &#125;</div><div class="line">    return exifOrientation;</div><div class="line">&#125;</div><div class="line">#endif</div></pre></td></tr></table></figure>
<p>sdä¸­æ˜¯ä½¿ç”¨ä¸‹é¢çš„ä»£ç æ‹¿åˆ°åœ¨å›¾ç‰‡æ•°æ®ä¸­æœå‘çš„å€¼çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">CFDictionaryRef properties = CGImageSourceCopyPropertiesAtIndex(_imageSource, 0, NULL);</div><div class="line">NSInteger orientationValue = 1;</div><div class="line">CFTypeRef val = CFDictionaryGetValue(properties, kCGImagePropertyPixelHeight);</div><div class="line">val = CFDictionaryGetValue(properties, kCGImagePropertyOrientation);</div><div class="line">            if (val) CFNumberGetValue(val, kCFNumberNSIntegerType, &amp;orientationValue);</div></pre></td></tr></table></figure>
<p>ä»¥ä¸Šæ‰€æœ‰ç¼–è§£ç ç›¸å…³çš„ç±»å°±åˆ†æå®Œæ¯•äº†ã€‚è¿™é‡Œæˆ‘ä»¬åœ¨è®¾è®¡æ¨¡å—çš„æ—¶å€™å¯åº”è¯¥å‚è€ƒsdé‡Œé¢çš„åšæ³•ï¼Œé¦–å…ˆé€šè¿‡åè®®çš„æ–¹å¼æ”¾å¼€éœ€è¦çš„æ¥å£ï¼Œå„æ¨¡å—æŒ‰æ ¹æ®éœ€æ±‚å†³å®šæ˜¯å¦å®ç°å¯¹åº”åè®®ï¼Œè™½ç„¶éƒ½æ˜¯ç¼–è§£ç ï¼Œä½†æ˜¯é’ˆå¯¹ä¸åŒçš„æ ¼å¼åˆ›å»ºä¸åŒçš„ç±»å»å®ç°ï¼Œç„¶ååœ¨managerä¸­é€šè¿‡åˆ¤æ–­ä¸åŒçš„æ ¼å¼è°ƒç”¨ä¸åŒçš„æ¨¡å—å»åšå…·ä½“çš„äº‹æƒ…ï¼Œå‡å°‘é€»è¾‘çš„è€¦åˆã€‚</p>
<h3 id="SDWebImageManager"><a href="#SDWebImageManager" class="headerlink" title="SDWebImageManager"></a>SDWebImageManager</h3><p>çœ‹å®Œäº†ä¸‹è½½ï¼Œç¼“å­˜å’Œç¼–è§£ç è¿™ä¸‰ä¸ªä¸»è¦çš„æ¨¡å—ï¼Œåœ¨æ¥çœ‹çœ‹å®ƒä»¬çš„managerï¼Œè¿™ä¸ªå…¶å®å°±æ¯”è¾ƒç®€å•äº†ï¼Œå°±æ˜¯å¯¹ä¸Šé¢å‡ ä¸ªæ¨¡å—çš„ç›¸å…³æ–¹æ³•è¿›è¡Œäº†ä¸€äº›å°è£…ã€‚</p>
<p>å…ˆçœ‹ä¸€ä¸‹è¿™ä¸ªç§æœ‰ç±»</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">@interface SDWebImageCombinedOperation : NSObject &lt;SDWebImageOperation&gt;</div><div class="line"></div><div class="line">@property (assign, nonatomic, getter = isCancelled) BOOL cancelled;</div><div class="line">@property (strong, nonatomic, nullable) SDWebImageDownloadToken *downloadToken;</div><div class="line">@property (strong, nonatomic, nullable) NSOperation *cacheOperation;</div><div class="line">@property (weak, nonatomic, nullable) SDWebImageManager *manager;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<p>åœ¨managerä¸­å®šä¹‰äº†ç›¸å…³å±æ€§</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@property (strong, nonatomic, nonnull) NSMutableArray&lt;SDWebImageCombinedOperation *&gt; *runningOperations;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œï¼Œmanagerå°†æ¯ä¸€ä¸ªdownloadè¿”å›çš„SDWebImageDownloadTokenå°è£…ä¸ºä¸€ä¸ªSDWebImageCombinedOperationï¼Œå­˜æ”¾åœ¨runningOperationsè¿™ä¸ªæ•°ç»„é‡Œé¢ï¼Œä¸»è¦æ˜¯ä¸ºäº†åœ¨å–æ¶ˆçš„æ—¶å€™æ–¹ä¾¿æ“ä½œï¼ˆè¿™ä¸ªåœ¨ä¹‹å‰ä»‹ç»ä¸‹è½½æ¨¡å—çš„æ—¶å€™å·²ç»æœ‰è¯´æ˜ï¼‰ã€‚</p>
<p>manageråˆ›å»ºäº†ä¸€ä¸ªé›†åˆå¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">@property (strong, nonatomic, nonnull) NSMutableSet&lt;NSURL *&gt; *failedURLs;</div></pre></td></tr></table></figure>
<p>ä¸»è¦ç”¨æ¥å­˜å‚¨ä¸‹è½½å¤±è´¥çš„urlï¼Œå¦‚æœurlä¸‹è½½å¤±è´¥ä¼šè¢«æ·»åŠ åˆ°ä¸Šé¢çš„é›†åˆä¸­ï¼Œå¦‚æœå½“å‰urlåœ¨è¯¥åˆé›†ä¸­ï¼Œä¸”optionä¸æ˜¯SDWebImageRetryFailedï¼ˆè¿™ä¸ªoptionæ˜¯æ¶ˆé™¤é»‘åå•ç”¨çš„ï¼‰ï¼Œåˆ™ç›´æ¥è¿”å›ä¸‹è½½å¤±è´¥ã€‚å¦‚æœoptionæ˜¯SDWebImageRetryFailedï¼Œåˆ™ä¼šå»é‡æ–°ä¸‹è½½ã€‚</p>
<p>managerè¿˜æä¾›äº†2ä¸ªblockï¼Œè®©ä½¿ç”¨è€…æœ‰æœºä¼šä¿®æ”¹ä¸€ä¸‹å†…å®¹ã€‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">typedef NSString * _Nullable(^SDWebImageCacheKeyFilterBlock)(NSURL * _Nullable url);</div><div class="line"></div><div class="line">@property (nonatomic, copy, nullable) SDWebImageCacheKeyFilterBlock cacheKeyFilter;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªblockå¯ä»¥ä¿®æ”¹å½“å‰å›¾ç‰‡ç¼“å­˜æ—¶çš„é”®å€¼ï¼Œé»˜è®¤æ˜¯ä½¿ç”¨url.absoluteStringä½œä¸ºé”®å€¼è¿›è¡Œç¼“å­˜çš„ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">typedef NSData * _Nullable(^SDWebImageCacheSerializerBlock)(UIImage * _Nonnull image, NSData * _Nullable data, NSURL * _Nullable imageURL);</div><div class="line"></div><div class="line">@property (nonatomic, copy, nullable) SDWebImageCacheSerializerBlock cacheSerializer;</div></pre></td></tr></table></figure>
<p>è¿™ä¸ªblockå¯ä»¥ç”¨æ¥ä¿®æ”¹ç¼“å­˜å›¾ç‰‡çš„æ•°æ®ã€‚å®ƒæ¥æ”¶å½“å‰ä¸‹è½½çš„å›¾ç‰‡çš„imageå¯¹è±¡ï¼Œdataå¯¹è±¡å’Œurlï¼Œè¿”å›ä¸€ä¸ªdata.ä½ å¯ä»¥åœ¨blockå¯¹ä¼ å…¥çš„å›¾ç‰‡æ•°æ®åšä¸€äº›å¤„ç†ï¼Œæ¯”å¦‚åšä¸€ä¸‹ç¼–ç æˆ–è€…æ ¼å¼è½¬åŒ–ä»€ä¹ˆçš„ã€‚</p>
<p>managerä¸­æœ€ä¸»è¦çš„è¿˜æ˜¯ä¸‹é¢è¿™ä¸ªloadimageurlçš„å‡½æ•°ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div></pre></td><td class="code"><pre><div class="line">- (id &lt;SDWebImageOperation&gt;)loadImageWithURL:(nullable NSURL *)url</div><div class="line">                                     options:(SDWebImageOptions)options</div><div class="line">                                    progress:(nullable SDWebImageDownloaderProgressBlock)progressBlock</div><div class="line">                                   completed:(nullable SDInternalCompletionBlock)completedBlock &#123;</div><div class="line">    // Invoking this method without a completedBlock is pointless</div><div class="line">    NSAssert(completedBlock != nil, @&quot;If you mean to prefetch the image, use -[SDWebImagePrefetcher prefetchURLs] instead&quot;);</div><div class="line"></div><div class="line">    // Very common mistake is to send the URL using NSString object instead of NSURL. For some strange reason, Xcode won&apos;t</div><div class="line">    // throw any warning for this type mismatch. Here we failsafe this error by allowing URLs to be passed as NSString.</div><div class="line">    if ([url isKindOfClass:NSString.class]) &#123;</div><div class="line">        url = [NSURL URLWithString:(NSString *)url];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    // Prevents app crashing on argument type error like sending NSNull instead of NSURL</div><div class="line">    if (![url isKindOfClass:NSURL.class]) &#123;</div><div class="line">        url = nil;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    SDWebImageCombinedOperation *operation = [SDWebImageCombinedOperation new];</div><div class="line">    operation.manager = self;</div><div class="line"></div><div class="line">    BOOL isFailedUrl = NO;</div><div class="line">    if (url) &#123;</div><div class="line">        LOCK(self.failedURLsLock);</div><div class="line">        isFailedUrl = [self.failedURLs containsObject:url];</div><div class="line">        UNLOCK(self.failedURLsLock);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (url.absoluteString.length == 0 || (!(options &amp; SDWebImageRetryFailed) &amp;&amp; isFailedUrl)) &#123;</div><div class="line">        [self callCompletionBlockForOperation:operation completion:completedBlock error:[NSError errorWithDomain:NSURLErrorDomain code:NSURLErrorFileDoesNotExist userInfo:nil] url:url];</div><div class="line">        return operation;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    LOCK(self.runningOperationsLock);</div><div class="line">    [self.runningOperations addObject:operation];</div><div class="line">    UNLOCK(self.runningOperationsLock);</div><div class="line">    NSString *key = [self cacheKeyForURL:url];</div><div class="line">    </div><div class="line">    SDImageCacheOptions cacheOptions = 0;</div><div class="line">    if (options &amp; SDWebImageQueryDataWhenInMemory) cacheOptions |= SDImageCacheQueryDataWhenInMemory;</div><div class="line">    if (options &amp; SDWebImageQueryDiskSync) cacheOptions |= SDImageCacheQueryDiskSync;</div><div class="line">    if (options &amp; SDWebImageScaleDownLargeImages) cacheOptions |= SDImageCacheScaleDownLargeImages;</div><div class="line">    </div><div class="line">    __weak SDWebImageCombinedOperation *weakOperation = operation;</div><div class="line">    operation.cacheOperation = [self.imageCache queryCacheOperationForKey:key options:cacheOptions done:^(UIImage *cachedImage, NSData *cachedData, SDImageCacheType cacheType) &#123;</div><div class="line">        __strong __typeof(weakOperation) strongOperation = weakOperation;</div><div class="line">        if (!strongOperation || strongOperation.isCancelled) &#123;</div><div class="line">            [self safelyRemoveOperationFromRunning:strongOperation];</div><div class="line">            return;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        // Check whether we should download image from network</div><div class="line">        BOOL shouldDownload = (!(options &amp; SDWebImageFromCacheOnly))</div><div class="line">            &amp;&amp; (!cachedImage || options &amp; SDWebImageRefreshCached)</div><div class="line">            &amp;&amp; (![self.delegate respondsToSelector:@selector(imageManager:shouldDownloadImageForURL:)] || [self.delegate imageManager:self shouldDownloadImageForURL:url]);</div><div class="line">        if (shouldDownload) &#123;</div><div class="line">            if (cachedImage &amp;&amp; options &amp; SDWebImageRefreshCached) &#123;</div><div class="line">                // If image was found in the cache but SDWebImageRefreshCached is provided, notify about the cached image</div><div class="line">                // AND try to re-download it in order to let a chance to NSURLCache to refresh it from server.</div><div class="line">                [self callCompletionBlockForOperation:strongOperation completion:completedBlock image:cachedImage data:cachedData error:nil cacheType:cacheType finished:YES url:url];</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // download if no image or requested to refresh anyway, and download allowed by delegate</div><div class="line">            SDWebImageDownloaderOptions downloaderOptions = 0;</div><div class="line">            if (options &amp; SDWebImageLowPriority) downloaderOptions |= SDWebImageDownloaderLowPriority;</div><div class="line">            if (options &amp; SDWebImageProgressiveDownload) downloaderOptions |= SDWebImageDownloaderProgressiveDownload;</div><div class="line">            if (options &amp; SDWebImageRefreshCached) downloaderOptions |= SDWebImageDownloaderUseNSURLCache;</div><div class="line">            if (options &amp; SDWebImageContinueInBackground) downloaderOptions |= SDWebImageDownloaderContinueInBackground;</div><div class="line">            if (options &amp; SDWebImageHandleCookies) downloaderOptions |= SDWebImageDownloaderHandleCookies;</div><div class="line">            if (options &amp; SDWebImageAllowInvalidSSLCertificates) downloaderOptions |= SDWebImageDownloaderAllowInvalidSSLCertificates;</div><div class="line">            if (options &amp; SDWebImageHighPriority) downloaderOptions |= SDWebImageDownloaderHighPriority;</div><div class="line">            if (options &amp; SDWebImageScaleDownLargeImages) downloaderOptions |= SDWebImageDownloaderScaleDownLargeImages;</div><div class="line">            </div><div class="line">            if (cachedImage &amp;&amp; options &amp; SDWebImageRefreshCached) &#123;</div><div class="line">                // force progressive off if image already cached but forced refreshing</div><div class="line">                downloaderOptions &amp;= ~SDWebImageDownloaderProgressiveDownload;</div><div class="line">                // ignore image read from NSURLCache if image if cached but force refreshing</div><div class="line">                downloaderOptions |= SDWebImageDownloaderIgnoreCachedResponse;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            // `SDWebImageCombinedOperation` -&gt; `SDWebImageDownloadToken` -&gt; `downloadOperationCancelToken`, which is a `SDCallbacksDictionary` and retain the completed block below, so we need weak-strong again to avoid retain cycle</div><div class="line">            __weak typeof(strongOperation) weakSubOperation = strongOperation;</div><div class="line">            strongOperation.downloadToken = [self.imageDownloader downloadImageWithURL:url options:downloaderOptions progress:progressBlock completed:^(UIImage *downloadedImage, NSData *downloadedData, NSError *error, BOOL finished) &#123;</div><div class="line">                __strong typeof(weakSubOperation) strongSubOperation = weakSubOperation;</div><div class="line">                if (!strongSubOperation || strongSubOperation.isCancelled) &#123;</div><div class="line">                    // Do nothing if the operation was cancelled</div><div class="line">                    // See #699 for more details</div><div class="line">                    // if we would call the completedBlock, there could be a race condition between this block and another completedBlock for the same object, so if this one is called second, we will overwrite the new data</div><div class="line">                &#125; else if (error) &#123;</div><div class="line">                    [self callCompletionBlockForOperation:strongSubOperation completion:completedBlock error:error url:url];</div><div class="line">                    BOOL shouldBlockFailedURL;</div><div class="line">                    // Check whether we should block failed url</div><div class="line">                    if ([self.delegate respondsToSelector:@selector(imageManager:shouldBlockFailedURL:withError:)]) &#123;</div><div class="line">                        shouldBlockFailedURL = [self.delegate imageManager:self shouldBlockFailedURL:url withError:error];</div><div class="line">                    &#125; else &#123;</div><div class="line">                        shouldBlockFailedURL = (   error.code != NSURLErrorNotConnectedToInternet</div><div class="line">                                                &amp;&amp; error.code != NSURLErrorCancelled</div><div class="line">                                                &amp;&amp; error.code != NSURLErrorTimedOut</div><div class="line">                                                &amp;&amp; error.code != NSURLErrorInternationalRoamingOff</div><div class="line">                                                &amp;&amp; error.code != NSURLErrorDataNotAllowed</div><div class="line">                                                &amp;&amp; error.code != NSURLErrorCannotFindHost</div><div class="line">                                                &amp;&amp; error.code != NSURLErrorCannotConnectToHost</div><div class="line">                                                &amp;&amp; error.code != NSURLErrorNetworkConnectionLost);</div><div class="line">                    &#125;</div><div class="line">                    </div><div class="line">                    if (shouldBlockFailedURL) &#123;</div><div class="line">                        LOCK(self.failedURLsLock);</div><div class="line">                        [self.failedURLs addObject:url];</div><div class="line">                        UNLOCK(self.failedURLsLock);</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">                else &#123;</div><div class="line">                    if ((options &amp; SDWebImageRetryFailed)) &#123;</div><div class="line">                        LOCK(self.failedURLsLock);</div><div class="line">                        [self.failedURLs removeObject:url];</div><div class="line">                        UNLOCK(self.failedURLsLock);</div><div class="line">                    &#125;</div><div class="line">                    </div><div class="line">                    BOOL cacheOnDisk = !(options &amp; SDWebImageCacheMemoryOnly);</div><div class="line">                    </div><div class="line">                    // We&apos;ve done the scale process in SDWebImageDownloader with the shared manager, this is used for custom manager and avoid extra scale.</div><div class="line">                    if (self != [SDWebImageManager sharedManager] &amp;&amp; self.cacheKeyFilter &amp;&amp; downloadedImage) &#123;</div><div class="line">                        downloadedImage = [self scaledImageForKey:key image:downloadedImage];</div><div class="line">                    &#125;</div><div class="line"></div><div class="line">                    if (options &amp; SDWebImageRefreshCached &amp;&amp; cachedImage &amp;&amp; !downloadedImage) &#123;</div><div class="line">                        // Image refresh hit the NSURLCache cache, do not call the completion block</div><div class="line">                    &#125; else if (downloadedImage &amp;&amp; (!downloadedImage.images || (options &amp; SDWebImageTransformAnimatedImage)) &amp;&amp; [self.delegate respondsToSelector:@selector(imageManager:transformDownloadedImage:withURL:)]) &#123;</div><div class="line">                        dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^&#123;</div><div class="line">                            UIImage *transformedImage = [self.delegate imageManager:self transformDownloadedImage:downloadedImage withURL:url];</div><div class="line"></div><div class="line">                            if (transformedImage &amp;&amp; finished) &#123;</div><div class="line">                                BOOL imageWasTransformed = ![transformedImage isEqual:downloadedImage];</div><div class="line">                                NSData *cacheData;</div><div class="line">                                // pass nil if the image was transformed, so we can recalculate the data from the image</div><div class="line">                                if (self.cacheSerializer) &#123;</div><div class="line">                                    cacheData = self.cacheSerializer(transformedImage, (imageWasTransformed ? nil : downloadedData), url);</div><div class="line">                                &#125; else &#123;</div><div class="line">                                    cacheData = (imageWasTransformed ? nil : downloadedData);</div><div class="line">                                &#125;</div><div class="line">                                [self.imageCache storeImage:transformedImage imageData:cacheData forKey:key toDisk:cacheOnDisk completion:nil];</div><div class="line">                            &#125;</div><div class="line">                            </div><div class="line">                            [self callCompletionBlockForOperation:strongSubOperation completion:completedBlock image:transformedImage data:downloadedData error:nil cacheType:SDImageCacheTypeNone finished:finished url:url];</div><div class="line">                        &#125;);</div><div class="line">                    &#125; else &#123;</div><div class="line">                        if (downloadedImage &amp;&amp; finished) &#123;</div><div class="line">                            if (self.cacheSerializer) &#123;</div><div class="line">                                dispatch_async(dispatch_get_global_queue(DISPATCH_QUEUE_PRIORITY_HIGH, 0), ^&#123;</div><div class="line">                                    NSData *cacheData = self.cacheSerializer(downloadedImage, downloadedData, url);</div><div class="line">                                    [self.imageCache storeImage:downloadedImage imageData:cacheData forKey:key toDisk:cacheOnDisk completion:nil];</div><div class="line">                                &#125;);</div><div class="line">                            &#125; else &#123;</div><div class="line">                                [self.imageCache storeImage:downloadedImage imageData:downloadedData forKey:key toDisk:cacheOnDisk completion:nil];</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        [self callCompletionBlockForOperation:strongSubOperation completion:completedBlock image:downloadedImage data:downloadedData error:nil cacheType:SDImageCacheTypeNone finished:finished url:url];</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                if (finished) &#123;</div><div class="line">                    [self safelyRemoveOperationFromRunning:strongSubOperation];</div><div class="line">                &#125;</div><div class="line">            &#125;];</div><div class="line">        &#125; else if (cachedImage) &#123;</div><div class="line">            [self callCompletionBlockForOperation:strongOperation completion:completedBlock image:cachedImage data:cachedData error:nil cacheType:cacheType finished:YES url:url];</div><div class="line">            [self safelyRemoveOperationFromRunning:strongOperation];</div><div class="line">        &#125; else &#123;</div><div class="line">            // Image not in cache and download disallowed by delegate</div><div class="line">            [self callCompletionBlockForOperation:strongOperation completion:completedBlock image:nil data:nil error:nil cacheType:SDImageCacheTypeNone finished:YES url:url];</div><div class="line">            [self safelyRemoveOperationFromRunning:strongOperation];</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line"></div><div class="line">    return operation;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å°±æ˜¯ä¸€ä¸ªå…ˆæŸ¥æ‰¾ç¼“å­˜ï¼Œå¦‚æœæ²¡æœ‰å‘½ä¸­å†å»ä¸‹è½½çš„è¿‡ç¨‹ï¼Œæ˜¯ä¸€ä¸ªæ¯”è¾ƒç»å…¸çš„é€»è¾‘ï¼Œç½‘ä¸Šä¸€èˆ¬è¯´sdéƒ½ä¼šè¯´åˆ°è¿™é‡Œçš„è¿™ä¸ªé€»è¾‘ã€‚è¿™é‡Œå°±ä¸ç»†è¯´äº†ã€‚</p>
<h3 id="åˆ†ç±»"><a href="#åˆ†ç±»" class="headerlink" title="åˆ†ç±»"></a>åˆ†ç±»</h3><p>sdå¤§å®¶ç”¨çš„æœ€å¤šçš„å…¶å®æ˜¯åˆ†ç±»ï¼Œç‰¹åˆ«æ˜¯UIImageViewçš„åˆ†ç±»ï¼Œè¿™é‡Œæˆ‘æŒ‘2ä¸ªæ¯”è¾ƒæœ‰å†…å®¹çš„åˆ†ç±»è¯´ä¸€ä¸‹ï¼Œå…¶ä»–åˆ†ç±»éƒ½æ¯”è¾ƒç®€å•ï¼Œå°±æ˜¯çº¯è°ƒapiäº†ã€‚</p>
<h4 id="NSData-ImageContentType"><a href="#NSData-ImageContentType" class="headerlink" title="NSData + ImageContentType"></a>NSData + ImageContentType</h4><p>è¿™ä¸ªåˆ†ç±»æ¯”è¾ƒé‡è¦çš„çŸ¥è¯†ç‚¹å°±æ˜¯å¦‚ä½•é€šè¿‡å›¾ç‰‡æ–‡ä»¶åˆ¤æ–­å›¾ç‰‡æ ¼å¼ï¼Œçœ‹ä¸€ä¸‹ä¸»è¦ä»£ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line">+ (SDImageFormat)sd_imageFormatForImageData:(nullable NSData *)data &#123;</div><div class="line">    if (!data) &#123;</div><div class="line">        return SDImageFormatUndefined;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    // File signatures table: http://www.garykessler.net/library/file_sigs.html</div><div class="line">    uint8_t c;</div><div class="line">    [data getBytes:&amp;c length:1];</div><div class="line">    switch (c) &#123;</div><div class="line">        case 0xFF:</div><div class="line">            return SDImageFormatJPEG;</div><div class="line">        case 0x89:</div><div class="line">            return SDImageFormatPNG;</div><div class="line">        case 0x47:</div><div class="line">            return SDImageFormatGIF;</div><div class="line">        case 0x49:</div><div class="line">        case 0x4D:</div><div class="line">            return SDImageFormatTIFF;</div><div class="line">        case 0x52: &#123;</div><div class="line">            if (data.length &gt;= 12) &#123;</div><div class="line">                //RIFF....WEBP</div><div class="line">                NSString *testString = [[NSString alloc] initWithData:[data subdataWithRange:NSMakeRange(0, 12)] encoding:NSASCIIStringEncoding];</div><div class="line">                if ([testString hasPrefix:@&quot;RIFF&quot;] &amp;&amp; [testString hasSuffix:@&quot;WEBP&quot;]) &#123;</div><div class="line">                    return SDImageFormatWebP;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">        case 0x00: &#123;</div><div class="line">            if (data.length &gt;= 12) &#123;</div><div class="line">                //....ftypheic ....ftypheix ....ftyphevc ....ftyphevx</div><div class="line">                NSString *testString = [[NSString alloc] initWithData:[data subdataWithRange:NSMakeRange(4, 8)] encoding:NSASCIIStringEncoding];</div><div class="line">                if ([testString isEqualToString:@&quot;ftypheic&quot;]</div><div class="line">                    || [testString isEqualToString:@&quot;ftypheix&quot;]</div><div class="line">                    || [testString isEqualToString:@&quot;ftyphevc&quot;]</div><div class="line">                    || [testString isEqualToString:@&quot;ftyphevx&quot;]) &#123;</div><div class="line">                    return SDImageFormatHEIC;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            break;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return SDImageFormatUndefined;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>çœ‹åˆ°ä»£ç å°±åº”è¯¥å¾ˆæ˜äº†äº†ï¼Œé€šè¿‡æ–‡ä»¶æ•°æ®çš„ç¬¬ä¸€ä¸ªå­—èŠ‚æ¥åˆ¤æ–­æ–‡ä»¶æ ¼å¼ï¼Œè¿™é‡Œç”¨2ä¸ªåå…­è¿›åˆ¶æ•°è¡¨ç¤ºä¸€ä¸ªå­—èŠ‚ã€‚è¿™ä¸ªå‡½æ•°å¦‚æœæœ‰éœ€è¦å¯ä»¥ç›´æ¥æ‹¿æ¥ç”¨ã€‚</p>
<h4 id="UIView-WebCache"><a href="#UIView-WebCache" class="headerlink" title="UIView + WebCache"></a>UIView + WebCache</h4><p>è¿™ä¸ªç®—æ˜¯æ‰€æœ‰åˆ†ç±»çš„çˆ¶ç±»äº†ï¼Œå¤§éƒ¨åˆ†UIç›¸å…³çš„åˆ†ç±»æœ€åéƒ½æ˜¯è°ƒç”¨çš„è¿™ä¸ªåˆ†ç±»é‡Œé¢çš„ä¸€ä¸ªæ–¹æ³•ï¼Œå¦‚ä¸‹:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div></pre></td><td class="code"><pre><div class="line">- (void)sd_internalSetImageWithURL:(nullable NSURL *)url</div><div class="line">                  placeholderImage:(nullable UIImage *)placeholder</div><div class="line">                           options:(SDWebImageOptions)options</div><div class="line">                      operationKey:(nullable NSString *)operationKey</div><div class="line">                     setImageBlock:(nullable SDSetImageBlock)setImageBlock</div><div class="line">                          progress:(nullable SDWebImageDownloaderProgressBlock)progressBlock</div><div class="line">                         completed:(nullable SDExternalCompletionBlock)completedBlock</div><div class="line">                           context:(nullable NSDictionary&lt;NSString *, id&gt; *)context &#123;</div><div class="line">    NSString *validOperationKey = operationKey ?: NSStringFromClass([self class]);</div><div class="line">    [self sd_cancelImageLoadOperationWithKey:validOperationKey];</div><div class="line">    objc_setAssociatedObject(self, &amp;imageURLKey, url, OBJC_ASSOCIATION_RETAIN_NONATOMIC);</div><div class="line">    </div><div class="line">    if (!(options &amp; SDWebImageDelayPlaceholder)) &#123;</div><div class="line">        if ([context valueForKey:SDWebImageInternalSetImageGroupKey]) &#123;</div><div class="line">            dispatch_group_t group = [context valueForKey:SDWebImageInternalSetImageGroupKey];</div><div class="line">            dispatch_group_enter(group);</div><div class="line">        &#125;</div><div class="line">        dispatch_main_async_safe(^&#123;</div><div class="line">            [self sd_setImage:placeholder imageData:nil basedOnClassOrViaCustomSetImageBlock:setImageBlock];</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    if (url) &#123;</div><div class="line">#if SD_UIKIT</div><div class="line">        // check if activityView is enabled or not</div><div class="line">        if ([self sd_showActivityIndicatorView]) &#123;</div><div class="line">            [self sd_addActivityIndicator];</div><div class="line">        &#125;</div><div class="line">#endif</div><div class="line">        </div><div class="line">        // reset the progress</div><div class="line">        self.sd_imageProgress.totalUnitCount = 0;</div><div class="line">        self.sd_imageProgress.completedUnitCount = 0;</div><div class="line">        </div><div class="line">        SDWebImageManager *manager;</div><div class="line">        if ([context valueForKey:SDWebImageExternalCustomManagerKey]) &#123;</div><div class="line">            manager = (SDWebImageManager *)[context valueForKey:SDWebImageExternalCustomManagerKey];</div><div class="line">        &#125; else &#123;</div><div class="line">            manager = [SDWebImageManager sharedManager];</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        __weak __typeof(self)wself = self;</div><div class="line">        SDWebImageDownloaderProgressBlock combinedProgressBlock = ^(NSInteger receivedSize, NSInteger expectedSize, NSURL * _Nullable targetURL) &#123;</div><div class="line">            wself.sd_imageProgress.totalUnitCount = expectedSize;</div><div class="line">            wself.sd_imageProgress.completedUnitCount = receivedSize;</div><div class="line">            if (progressBlock) &#123;</div><div class="line">                progressBlock(receivedSize, expectedSize, targetURL);</div><div class="line">            &#125;</div><div class="line">        &#125;;</div><div class="line">        id &lt;SDWebImageOperation&gt; operation = [manager loadImageWithURL:url options:options progress:combinedProgressBlock completed:^(UIImage *image, NSData *data, NSError *error, SDImageCacheType cacheType, BOOL finished, NSURL *imageURL) &#123;</div><div class="line">            __strong __typeof (wself) sself = wself;</div><div class="line">            if (!sself) &#123; return; &#125;</div><div class="line">#if SD_UIKIT</div><div class="line">            [sself sd_removeActivityIndicator];</div><div class="line">#endif</div><div class="line">            // if the progress not been updated, mark it to complete state</div><div class="line">            if (finished &amp;&amp; !error &amp;&amp; sself.sd_imageProgress.totalUnitCount == 0 &amp;&amp; sself.sd_imageProgress.completedUnitCount == 0) &#123;</div><div class="line">                sself.sd_imageProgress.totalUnitCount = SDWebImageProgressUnitCountUnknown;</div><div class="line">                sself.sd_imageProgress.completedUnitCount = SDWebImageProgressUnitCountUnknown;</div><div class="line">            &#125;</div><div class="line">            BOOL shouldCallCompletedBlock = finished || (options &amp; SDWebImageAvoidAutoSetImage);</div><div class="line">            BOOL shouldNotSetImage = ((image &amp;&amp; (options &amp; SDWebImageAvoidAutoSetImage)) ||</div><div class="line">                                      (!image &amp;&amp; !(options &amp; SDWebImageDelayPlaceholder)));</div><div class="line">            SDWebImageNoParamsBlock callCompletedBlockClojure = ^&#123;</div><div class="line">                if (!sself) &#123; return; &#125;</div><div class="line">                if (!shouldNotSetImage) &#123;</div><div class="line">                    [sself sd_setNeedsLayout];</div><div class="line">                &#125;</div><div class="line">                if (completedBlock &amp;&amp; shouldCallCompletedBlock) &#123;</div><div class="line">                    completedBlock(image, error, cacheType, url);</div><div class="line">                &#125;</div><div class="line">            &#125;;</div><div class="line">            </div><div class="line">            // case 1a: we got an image, but the SDWebImageAvoidAutoSetImage flag is set</div><div class="line">            // OR</div><div class="line">            // case 1b: we got no image and the SDWebImageDelayPlaceholder is not set</div><div class="line">            if (shouldNotSetImage) &#123;</div><div class="line">                dispatch_main_async_safe(callCompletedBlockClojure);</div><div class="line">                return;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            UIImage *targetImage = nil;</div><div class="line">            NSData *targetData = nil;</div><div class="line">            if (image) &#123;</div><div class="line">                // case 2a: we got an image and the SDWebImageAvoidAutoSetImage is not set</div><div class="line">                targetImage = image;</div><div class="line">                targetData = data;</div><div class="line">            &#125; else if (options &amp; SDWebImageDelayPlaceholder) &#123;</div><div class="line">                // case 2b: we got no image and the SDWebImageDelayPlaceholder flag is set</div><div class="line">                targetImage = placeholder;</div><div class="line">                targetData = nil;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">#if SD_UIKIT || SD_MAC</div><div class="line">            // check whether we should use the image transition</div><div class="line">            SDWebImageTransition *transition = nil;</div><div class="line">            if (finished &amp;&amp; (options &amp; SDWebImageForceTransition || cacheType == SDImageCacheTypeNone)) &#123;</div><div class="line">                transition = sself.sd_imageTransition;</div><div class="line">            &#125;</div><div class="line">#endif</div><div class="line">            if ([context valueForKey:SDWebImageInternalSetImageGroupKey]) &#123;</div><div class="line">                dispatch_group_t group = [context valueForKey:SDWebImageInternalSetImageGroupKey];</div><div class="line">                dispatch_group_enter(group);</div><div class="line">                dispatch_main_async_safe(^&#123;</div><div class="line">#if SD_UIKIT || SD_MAC</div><div class="line">                    [sself sd_setImage:targetImage imageData:targetData basedOnClassOrViaCustomSetImageBlock:setImageBlock transition:transition cacheType:cacheType imageURL:imageURL];</div><div class="line">#else</div><div class="line">                    [sself sd_setImage:targetImage imageData:targetData basedOnClassOrViaCustomSetImageBlock:setImageBlock];</div><div class="line">#endif</div><div class="line">                &#125;);</div><div class="line">                // ensure completion block is called after custom setImage process finish</div><div class="line">                dispatch_group_notify(group, dispatch_get_main_queue(), ^&#123;</div><div class="line">                    callCompletedBlockClojure();</div><div class="line">                &#125;);</div><div class="line">            &#125; else &#123;</div><div class="line">                dispatch_main_async_safe(^&#123;</div><div class="line">#if SD_UIKIT || SD_MAC</div><div class="line">                    [sself sd_setImage:targetImage imageData:targetData basedOnClassOrViaCustomSetImageBlock:setImageBlock transition:transition cacheType:cacheType imageURL:imageURL];</div><div class="line">#else</div><div class="line">                    [sself sd_setImage:targetImage imageData:targetData basedOnClassOrViaCustomSetImageBlock:setImageBlock];</div><div class="line">#endif</div><div class="line">                    callCompletedBlockClojure();</div><div class="line">                &#125;);</div><div class="line">            &#125;</div><div class="line">        &#125;];</div><div class="line">        [self sd_setImageLoadOperation:operation forKey:validOperationKey];</div><div class="line">    &#125; else &#123;</div><div class="line">        dispatch_main_async_safe(^&#123;</div><div class="line">#if SD_UIKIT</div><div class="line">            [self sd_removeActivityIndicator];</div><div class="line">#endif</div><div class="line">            if (completedBlock) &#123;</div><div class="line">                NSError *error = [NSError errorWithDomain:SDWebImageErrorDomain code:-1 userInfo:@&#123;NSLocalizedDescriptionKey : @&quot;Trying to load a nil url&quot;&#125;];</div><div class="line">                completedBlock(nil, error, SDImageCacheTypeNone, url);</div><div class="line">            &#125;</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç›´æ¥çœ‹åŠ è½½å›¾ç‰‡éƒ¨åˆ†å§ï¼Œå›¾ç‰‡ä¸‹è½½å®Œæˆåï¼Œå¦‚æœå½“å‰æ˜¯MACå¹³å°çš„è¯ï¼Œè¿˜åˆ›å»ºäº†ä¸€ä¸ªè½¬åœºåŠ¨ç”»SDWebImageTransitionï¼Œè¿™ä¸ªè½¬åœºåŠ¨ç”»æ¯”è¾ƒç®€å•ï¼Œéƒ½æ˜¯æœ€åŸºæœ¬çš„è½¬åœºæ•ˆæœã€‚</p>
<p>ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹è®¾ç½®å›¾ç‰‡ç»™UIçš„æ–¹æ³•ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div></pre></td><td class="code"><pre><div class="line">//ä¸å¸¦è½¬åœºåŠ¨ç”»çš„æ–¹æ³•</div><div class="line">- (void)sd_setImage:(UIImage *)image imageData:(NSData *)imageData basedOnClassOrViaCustomSetImageBlock:(SDSetImageBlock)setImageBlock &#123;</div><div class="line">#if SD_UIKIT || SD_MAC</div><div class="line">    [self sd_setImage:image imageData:imageData basedOnClassOrViaCustomSetImageBlock:setImageBlock transition:nil cacheType:0 imageURL:nil];</div><div class="line">#else</div><div class="line">    // watchOS does not support view transition. Simplify the logic</div><div class="line">    if (setImageBlock) &#123;</div><div class="line">        setImageBlock(image, imageData);</div><div class="line">    &#125; else if ([self isKindOfClass:[UIImageView class]]) &#123;</div><div class="line">        UIImageView *imageView = (UIImageView *)self;</div><div class="line">        [imageView setImage:image];</div><div class="line">    &#125;</div><div class="line">#endif</div><div class="line">&#125;</div><div class="line"></div><div class="line">//å¸¦è½¬åœºåŠ¨ç”»çš„æ–¹æ³•</div><div class="line"></div><div class="line">#if SD_UIKIT || SD_MAC</div><div class="line">- (void)sd_setImage:(UIImage *)image imageData:(NSData *)imageData basedOnClassOrViaCustomSetImageBlock:(SDSetImageBlock)setImageBlock transition:(SDWebImageTransition *)transition cacheType:(SDImageCacheType)cacheType imageURL:(NSURL *)imageURL &#123;</div><div class="line">    UIView *view = self;</div><div class="line">    SDSetImageBlock finalSetImageBlock;</div><div class="line">    if (setImageBlock) &#123;</div><div class="line">        finalSetImageBlock = setImageBlock;</div><div class="line">    &#125; else if ([view isKindOfClass:[UIImageView class]]) &#123;</div><div class="line">        UIImageView *imageView = (UIImageView *)view;</div><div class="line">        finalSetImageBlock = ^(UIImage *setImage, NSData *setImageData) &#123;</div><div class="line">            imageView.image = setImage;</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">#if SD_UIKIT</div><div class="line">    else if ([view isKindOfClass:[UIButton class]]) &#123;</div><div class="line">        UIButton *button = (UIButton *)view;</div><div class="line">        finalSetImageBlock = ^(UIImage *setImage, NSData *setImageData)&#123;</div><div class="line">            [button setImage:setImage forState:UIControlStateNormal];</div><div class="line">        &#125;;</div><div class="line">    &#125;</div><div class="line">#endif</div><div class="line">    </div><div class="line">    if (transition) &#123;</div><div class="line">#if SD_UIKIT</div><div class="line">        [UIView transitionWithView:view duration:0 options:0 animations:^&#123;</div><div class="line">            // 0 duration to let UIKit render placeholder and prepares block</div><div class="line">            if (transition.prepares) &#123;</div><div class="line">                transition.prepares(view, image, imageData, cacheType, imageURL);</div><div class="line">            &#125;</div><div class="line">        &#125; completion:^(BOOL finished) &#123;</div><div class="line">            [UIView transitionWithView:view duration:transition.duration options:transition.animationOptions animations:^&#123;</div><div class="line">                if (finalSetImageBlock &amp;&amp; !transition.avoidAutoSetImage) &#123;</div><div class="line">                    finalSetImageBlock(image, imageData);</div><div class="line">                &#125;</div><div class="line">                if (transition.animations) &#123;</div><div class="line">                    transition.animations(view, image);</div><div class="line">                &#125;</div><div class="line">            &#125; completion:transition.completion];</div><div class="line">        &#125;];</div><div class="line">#elif SD_MAC</div><div class="line">        [NSAnimationContext runAnimationGroup:^(NSAnimationContext * _Nonnull prepareContext) &#123;</div><div class="line">            // 0 duration to let AppKit render placeholder and prepares block</div><div class="line">            prepareContext.duration = 0;</div><div class="line">            if (transition.prepares) &#123;</div><div class="line">                transition.prepares(view, image, imageData, cacheType, imageURL);</div><div class="line">            &#125;</div><div class="line">        &#125; completionHandler:^&#123;</div><div class="line">            [NSAnimationContext runAnimationGroup:^(NSAnimationContext * _Nonnull context) &#123;</div><div class="line">                context.duration = transition.duration;</div><div class="line">                context.timingFunction = transition.timingFunction;</div><div class="line">                context.allowsImplicitAnimation = (transition.animationOptions &amp; SDWebImageAnimationOptionAllowsImplicitAnimation);</div><div class="line">                if (finalSetImageBlock &amp;&amp; !transition.avoidAutoSetImage) &#123;</div><div class="line">                    finalSetImageBlock(image, imageData);</div><div class="line">                &#125;</div><div class="line">                if (transition.animations) &#123;</div><div class="line">                    transition.animations(view, image);</div><div class="line">                &#125;</div><div class="line">            &#125; completionHandler:^&#123;</div><div class="line">                if (transition.completion) &#123;</div><div class="line">                    transition.completion(YES);</div><div class="line">                &#125;</div><div class="line">            &#125;];</div><div class="line">        &#125;];</div><div class="line">#endif</div><div class="line">    &#125; else &#123;</div><div class="line">        if (finalSetImageBlock) &#123;</div><div class="line">            finalSetImageBlock(image, imageData);</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line">#endif</div></pre></td></tr></table></figure>
<p>è¿™é‡Œçœ‹ä¸€ä¸‹å…·ä½“çš„è½¬åœºåŠ¨ç”»æ˜¯å’‹åšçš„å§ï¼Œå¦‚æœæ˜¯iOSï¼Œä½¿ç”¨UIViewçš„transitionWithViewæ–¹æ³•æ·»åŠ åŠ¨ç”»ï¼Œå…·ä½“çš„æ·»åŠ åŠ¨ç”»çš„ä»£ç å†transition.animationsè¿™ä¸ªblockä¸­ï¼Œå°±æ˜¯ç»™å½“å‰viewçš„layeræ·»åŠ ä¸€ä¸ªanimation.åœ¨macä¸Šåˆ™æ˜¯ä½¿ç”¨NSAnimationContextçš„runAnimationGroupæ–¹æ³•æ·»åŠ åŠ¨ç”»ï¼Œå…·ä½“æ·»åŠ æ–¹æ³•å’ŒiOSä¸€æ ·ã€‚</p>
<h3 id="æ€»ç»“"><a href="#æ€»ç»“" class="headerlink" title="æ€»ç»“"></a>æ€»ç»“</h3><p>åˆçœ‹sdçš„ä»£ç æ—¶ï¼Œè§‰å¾—æœ‰ç‚¹æ‚ä¹±æ— ç« ï¼Œå‘½åä¹Ÿä¸å¤ªå‹å¥½ï¼Œç„¶åæ¨¡å—å±‚çº§ä¹Ÿä¸å¤ªæ˜ç¡®ï¼Œå’Œafæ¯”èµ·æ¥åœ¨æ¶æ„æ–¹é¢å·®å¥½å¤šã€‚ä¸è¿‡åœ¨æŒ‰æ¨¡å—åˆ†æå’Œç ”è¯»sdçš„ä»£ç åï¼Œè¿˜æœ‰èƒ½å­¦åˆ°å¾ˆå¤šè€Œä¸”æ˜¯å¯ä»¥è¿ç”¨åˆ°å®é™…å¼€å‘ä¸­çš„å§¿åŠ¿ç‚¹çš„ï¼Œæ¯”å¦‚è‡ªå®šä¹‰ä¸€ä¸ªä¸‹è½½å™¨éƒ¨åˆ†ï¼Œå¯ä»¥å­¦ä¹ sdæ˜¯å¦‚ä½•è‡ªå®šä¹‰å°è£…ä¸€ä¸ªNSOpearionï¼Œå¦‚ä½•ç®¡ç†æ¯ä¸€ä¸ªNSOpearionçš„ç”Ÿå‘½å‘¨æœŸï¼Œå¦‚ä½•å›è°ƒä¸‹è½½ä¸­çš„æ•°æ®ç­‰ã€‚å¯¹äºç¼–è§£ç èƒ½å­¦åˆ°çš„ä¸œè¥¿ä¹Ÿå¾ˆå¤šï¼Œæ¯”å¦‚é’ˆå¯¹ä¸åŒç¼–è§£ç å™¨å¦‚ä½•ä½¿ç”¨åŒä¸€å¥—æ¥å£å»ç¼–ç¨‹ï¼Œæœ€ä¸»è¦çš„å½“ç„¶æ˜¯å¯¹ä¸åŒå›¾ç‰‡æ•°æ®çš„ç¼–è§£ç æ–¹å¼ï¼Œè¿™ä¸ªä¹Ÿæ˜¯è¯¥æ¨¡å—æœ€æ ¸å¿ƒçš„åŠŸèƒ½ã€‚å¯¹äºç¼“å­˜æ¨¡å—å¯ä»¥å­¦åˆ°NSCacheä»¥åŠNSMapTableçš„ä½¿ç”¨ï¼ŒNSURLCacheçš„ä½¿ç”¨ï¼Œå¯¹äºç¼“å­˜å†…å­˜çš„é™åˆ¶ï¼Œä»¥åŠç¼“å­˜ä¸è¶³æ—¶çš„åˆ é™¤ç­–ç•¥ç­‰ã€‚</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/06/14/ä½¿ç”¨AudioQueueå®ç°ä¸€ä¸ªéŸ³é¢‘æ’­æ”¾-äºŒ-è¾¹æ’­è¾¹ç¼“å­˜/" itemprop="url">
                  ä½¿ç”¨AudioQueueå®ç°ä¸€ä¸ªéŸ³é¢‘æ’­æ”¾(äºŒ)--è¾¹æ’­è¾¹ç¼“å­˜
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2018-06-14T16:01:06+08:00" content="2018-06-14">
              2018-06-14
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/06/14/ä½¿ç”¨AudioQueueå®ç°ä¸€ä¸ªéŸ³é¢‘æ’­æ”¾-äºŒ-è¾¹æ’­è¾¹ç¼“å­˜/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/06/14/ä½¿ç”¨AudioQueueå®ç°ä¸€ä¸ªéŸ³é¢‘æ’­æ”¾-äºŒ-è¾¹æ’­è¾¹ç¼“å­˜/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p><a href="http://llyblog.com/2018/05/07/ä½¿ç”¨AudioQueueå®ç°ä¸€ä¸ªéŸ³é¢‘æ’­æ”¾å™¨/" target="_blank" rel="noopener">å‰ä¸€ç¯‡æ–‡ç« </a>ä¸­ä»‹ç»äº†ä½¿ç”¨AuidoQueueå®ç°ä¸€ä¸ªéŸ³é¢‘æ’­æ”¾å™¨çš„åŠŸèƒ½,æœ€è¿‘æˆ‘åˆæŠŠè¿™ä¸ªé¡¹ç›®å®Œå–„äº†ä¸€ä¸‹ï¼Œåšäº†ä¸€ä¸ªè¾¹æ’­è¾¹ç¼“å­˜çš„åŠŸèƒ½ã€‚</p>
<p>å› ä¸ºæ’­æ”¾éƒ¨åˆ†çš„é€»è¾‘æˆ‘ä»¬å·²ç»å®Œæˆï¼Œè¿™é‡Œä¸»è¦æ˜¯æ€ä¹ˆç¼“å­˜æ•°æ®çš„é—®é¢˜ï¼Œå®ç°ä¹‹å‰æˆ‘æƒ³åˆ°äº†2ç§æ–¹æ¡ˆã€‚</p>
<h3 id="æ–¹æ¡ˆä¸€-åœ¨didReceiveDataBlockä¸­ç¼“å­˜æ–‡ä»¶"><a href="#æ–¹æ¡ˆä¸€-åœ¨didReceiveDataBlockä¸­ç¼“å­˜æ–‡ä»¶" class="headerlink" title="æ–¹æ¡ˆä¸€ åœ¨didReceiveDataBlockä¸­ç¼“å­˜æ–‡ä»¶"></a>æ–¹æ¡ˆä¸€ åœ¨didReceiveDataBlockä¸­ç¼“å­˜æ–‡ä»¶</h3><p>ç›´æ¥åœ¨æ‹¿åˆ°éŸ³é¢‘æ•°æ®è¿›è¡Œæ’­æ”¾çš„åŒæ—¶å°±å°†æ•°æ®å†™å…¥æ–‡ä»¶ï¼Œè¿™ç§æ–¹æ¡ˆçš„ä¼˜ç‚¹æ˜¯å®æ—¶æ€§ï¼Œæ’­æ”¾è¿‡çš„éŸ³é¢‘æ•°æ®éƒ½ä¼šè¢«ç¼“å­˜èµ·æ¥ï¼Œç¼ºç‚¹å°±æ˜¯ç¼“å­˜çš„æ–‡ä»¶å¯èƒ½å¹¶ä¸æ˜¯ä¸€ä¸ªå®Œæ•´çš„éŸ³é¢‘ï¼Œæ¯”å¦‚æ’­äº†1åˆ†é’Ÿåseekåˆ°2åˆ†é’Ÿçš„åœ°æ–¹ç»§ç»­æ’­ï¼Œä¸­é—´1åˆ†é’Ÿçš„æ•°æ®å¯èƒ½å°±æ²¡æœ‰æ”¶åˆ°ï¼Œè¿™å°±å¯¼è‡´ç¼“å­˜çš„æ–‡ä»¶æ˜¯æœ‰é—®é¢˜çš„ï¼Œå¦‚æœä¸‹æ¬¡ç›´æ¥æ’­è¿™ä¸ªæœ¬åœ°æ–‡ä»¶å¯èƒ½å°±å‡‰å‡‰äº†ã€‚ã€‚ã€‚</p>
<h3 id="æ–¹æ¡ˆäºŒ-åœ¨successçš„å›è°ƒä¸­ç¼“å­˜æ•°æ®"><a href="#æ–¹æ¡ˆäºŒ-åœ¨successçš„å›è°ƒä¸­ç¼“å­˜æ•°æ®" class="headerlink" title="æ–¹æ¡ˆäºŒ åœ¨successçš„å›è°ƒä¸­ç¼“å­˜æ•°æ®"></a>æ–¹æ¡ˆäºŒ åœ¨successçš„å›è°ƒä¸­ç¼“å­˜æ•°æ®</h3><p>åœ¨successä¸­å›è°ƒå›æ¥çš„æ•°æ®å°±æ˜¯å®Œæ•´çš„éŸ³é¢‘æ•°æ®ï¼Œç¼“å­˜è¿™ä¸ªæ•°æ®ä¸ä¼šå‡ºç°æ•°æ®ä¸å®Œæ•´çš„æƒ…å†µï¼Œä½†æ˜¯è¿™ä¸ªå›è°ƒå¹¶ä¸æ˜¯å®æ—¶è¿”å›çš„ï¼Œä¼šåœ¨æ•´ä¸ªéŸ³é¢‘çš„æ•°æ®éƒ½è·å–åˆ°ä»¥åæ‰ä¼šè¿”å›ï¼Œæœ‰ä¸€ä¸ªå»¶è¿Ÿï¼Œå¦‚æœç½‘ç»œä¸å¤ªå¥½ï¼Œå¯èƒ½ç›´åˆ°éŸ³é¢‘æ’­æ”¾å®Œäº†æ‰ä¼šè¿”å›ã€‚</p>
<p>è€ƒè™‘åˆ°æ–¹æ¡ˆçš„å¯è¡Œæ€§å’Œæ•°æ®çš„å¯ç”¨æ€§ï¼Œè¿™é‡Œæˆ‘é€‰æ‹©äº†æ–¹æ¡ˆäºŒï¼Œæ¯•ç«Ÿå®Œæ•´çš„æ•°æ®æ¯”ç¼“å­˜çš„å®æ—¶æ€§æ›´é‡è¦ä¸€äº›ã€‚å½“ç„¶ï¼Œè¿™ä¸ªæ–¹æ¡ˆä¸€æˆ‘è§‰å¾—è¿˜æ˜¯æœ‰ä¼˜åŒ–çš„ç©ºé—´ï¼Œå¦‚æœèƒ½å¤Ÿä¼˜åŒ–åˆ°ä¿è¯äº†æ•°æ®çš„å®Œæ•´æ€§ï¼Œä¼šæ¯”æ–¹æ¡ˆäºŒæ›´ä¼˜ã€‚</p>
<h3 id="å¢åŠ çš„æ¨¡å—"><a href="#å¢åŠ çš„æ¨¡å—" class="headerlink" title="å¢åŠ çš„æ¨¡å—"></a>å¢åŠ çš„æ¨¡å—</h3><p>è¿™é‡Œæˆ‘å¢åŠ äº†2ä¸ªæ¨¡å—ï¼Œä¸€ä¸ªæ˜¯æ–‡ä»¶çš„æ“ä½œæ¨¡å—ï¼Œè¿˜æœ‰ä¸€ä¸ªæ˜¯ç½‘ç»œæ¨¡å—ã€‚</p>
<h4 id="LLYFileManager"><a href="#LLYFileManager" class="headerlink" title="LLYFileManager"></a>LLYFileManager</h4><p>æ–‡ä»¶æ“ä½œæ¨¡å—æ˜¯å¯¹éŸ³é¢‘æ•°æ®çš„å­˜å‚¨ç›¸å…³æ“ä½œã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">@interface LLYFileManager : NSObject</div><div class="line"></div><div class="line">//ç½‘ç»œåœ°å€è½¬æœ¬åœ°åœ°å€</div><div class="line">+ (NSString *)pathWithUrl:(NSString *)fileUrl;</div><div class="line">//å°†æ•°æ®ä¿å­˜åˆ°æœ¬åœ°ç›®å½•ä¸‹</div><div class="line">+ (BOOL)saveFileWithPath:(NSString *)path fileObject:(id)fileObject;</div><div class="line">//åˆ¤æ–­å½“å‰urlå¯¹åº”çš„æ–‡ä»¶æ˜¯å¦å·²ç»ç¼“å­˜</div><div class="line">+ (BOOL)isFileExit:(NSString *)url;</div><div class="line">//è·å–æ–‡ä»¶å¤§å°</div><div class="line">+ (unsigned long long)fileSizeWithFilePath:(NSString *)filePath;</div><div class="line"></div><div class="line">@end</div></pre></td></tr></table></figure>
<h4 id="LLYHttpSessionManager"><a href="#LLYHttpSessionManager" class="headerlink" title="LLYHttpSessionManager"></a>LLYHttpSessionManager</h4><p>ç½‘ç»œæ¨¡å—æ˜¯åŸºäºAFNetworkingåšçš„ä¸€ä¸ªäºŒæ¬¡å°è£…<a href="http://llyblog.com/2018/06/14/AFNetworkingå­¦ä¹ ç¬”è®°ä¸å®è·µ/" target="_blank" rel="noopener">(å‚è€ƒè¿™ç¯‡æ–‡ç« )</a>ï¼Œä¸»è¦å°±æ˜¯è¯·æ±‚éŸ³é¢‘æ•°æ®ã€‚</p>
<h3 id="æ’­æ”¾ä¼˜åŒ–"><a href="#æ’­æ”¾ä¼˜åŒ–" class="headerlink" title="æ’­æ”¾ä¼˜åŒ–"></a>æ’­æ”¾ä¼˜åŒ–</h3><p>åœ¨æ’­æ”¾å‰ï¼Œæˆ‘ä»¬éœ€åˆ¤æ–­ä¸€ä¸‹å½“å‰urlå¯¹åº”çš„æ–‡ä»¶æ˜¯å¦å·²ç»ä¸‹è½½åˆ°æœ¬åœ°äº†ï¼Œå¦‚æœå·²ç»ä¸‹è½½å°±ç›´æ¥æ’­æœ¬åœ°çš„æ–‡ä»¶ï¼Œå¦åˆ™è¿˜æ˜¯èµ°ç½‘ç»œæ’­æ”¾çš„é€»è¾‘ã€‚</p>
<p>è¿™ä¸ªåˆ¤æ–­é€»è¾‘æˆ‘æ˜¯è¿™æ ·å¤„ç†çš„ï¼Œå…ˆå‘é€ä¸€ä¸ªhttp headè¯·æ±‚ï¼Œæ‹¿åˆ°å¯¹åº”urlæ–‡ä»¶çš„countOfBytesExpectedToReceiveï¼Œç„¶åå°†countOfBytesExpectedToReceiveå’Œæœ¬åœ°æ–‡ä»¶å¤§å°ï¼ˆfileSizeï¼‰è¿›è¡Œæ¯”è¾ƒï¼Œå¦‚æœfileSize &gt;= contentExceptLengthï¼Œåˆ™è¯´æ˜æœ¬åœ°æ–‡ä»¶æ˜¯å®Œæ•´çš„éŸ³é¢‘æ–‡ä»¶ï¼Œå¯ä»¥ç›´æ¥æ’­æ”¾ï¼Œå¦åˆ™çš„è¯è¿˜æ˜¯èµ°ç½‘ç»œæ’­æ”¾çš„é€»è¾‘ï¼Œå¹¶åœ¨successå›è°ƒä¸­è¦†ç›–ä¹‹å‰çš„ä¸å®Œæ•´æ–‡ä»¶ã€‚</p>
<p><a href="https://github.com/lilingyu0620/LLYAudioPlayer.git" target="_blank" rel="noopener">æˆ‘çš„demo</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/06/14/AFNetworkingå­¦ä¹ ç¬”è®°ä¸å®è·µ/" itemprop="url">
                  AFNetworkingå­¦ä¹ ç¬”è®°ä¸å®è·µ
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2018-06-14T09:58:47+08:00" content="2018-06-14">
              2018-06-14
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/06/14/AFNetworkingå­¦ä¹ ç¬”è®°ä¸å®è·µ/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/06/14/AFNetworkingå­¦ä¹ ç¬”è®°ä¸å®è·µ/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>è‡ªä»AFä½¿ç”¨NSURLSessioné‡å†™ä¹‹åï¼Œè¿˜æ²¡æœ‰çœ‹è¿‡æºç ï¼ŒNSURLSessionæ˜¯åŸºäºNSURLConnectionçš„å°è£…ï¼Œåº”è¯¥æ˜¯æ±²å–äº†AFä¹‹å‰çš„è®¾è®¡ï¼Œå†…éƒ¨å°è£…äº†ä¸€ä¸ªNSOperationæ¥å®ç°å¼‚æ­¥è¯·æ±‚ã€‚æœ€è¿‘è¦åšä¸€ä¸ªéŸ³é¢‘æ’­æ”¾çš„è¾¹æ’­è¾¹ç¼“å­˜çš„åŠŸèƒ½ï¼Œç½‘è·¯è¯·æ±‚è¿™å—éœ€è¦å°è£…ä¸€ä¸‹ï¼Œéšä¾¿ç ”ç©¶ä¸€ä¸‹AFçš„æºç ï¼Œè¿™é‡Œæˆ‘æŒ‰æ¨¡å—é€ä¸ªåˆ†æä¸€ä¸‹ã€‚</p>
<h4 id="AFURLSessionManager"><a href="#AFURLSessionManager" class="headerlink" title="AFURLSessionManager"></a>AFURLSessionManager</h4><p>è¿™ä¸ªæ¨¡å—æ˜¯AFä¸­æœ€å¤§ä¹Ÿæ˜¯æœ€é‡è¦çš„ä¸€ä¸ªæ¨¡å—ï¼Œå®ƒå°è£…äº†ä¸€ä¸ªsession,æä¾›äº†ä¸€ç³»åˆ—çš„åˆå§‹åŒ–æ–¹æ³•å’Œåˆ›å»ºtaskçš„æ–¹æ³•ã€‚å¦‚æœå¤§å®¶å¯¹sessionå’Œtaskçš„æ¦‚å¿µè¿˜ä¸å¤ªç†è§£ï¼Œå¯ä»¥å…ˆçœ‹ä¸€ä¸‹NSURLSessionè¿™ä¸ªç±»çš„ç›¸å…³å†…å®¹ï¼ˆè¿™ä¸ªå¤§æ¦‚è¯´ä¸€ä¸‹ï¼Œsessionæ˜¯ç®¡ç†æ‰€æœ‰ç½‘ç»œè¯·æ±‚çš„ï¼Œæ¯ä¸€ä¸ªç½‘ç»œè¯·æ±‚æ˜¯ä¸€ä¸ªtaskï¼Œtaskæ˜¯ä½¿ç”¨sessionåˆ›å»ºçš„ï¼Œæ‰€æœ‰taskå…±äº«sessionçš„ç›¸å…³è®¾ç½®ï¼‰ã€‚</p>
<p>å…ˆæ¥çœ‹ä¸€ä¸‹åˆ›å»ºtaskçš„æ–¹æ³•ï¼Œè¿™é‡Œæ€»å…±æœ‰datatask,uploadtaskå’Œdownloadtaskä¸‰ç§taskï¼Œä¸è¿‡ä»–ä»¬çš„åˆ›å»ºé€»è¾‘éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä»¥datataskä¸ºä¾‹</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">- (NSURLSessionDataTask *)dataTaskWithRequest:(NSURLRequest *)request</div><div class="line">                               uploadProgress:(nullable void (^)(NSProgress *uploadProgress)) uploadProgressBlock</div><div class="line">                             downloadProgress:(nullable void (^)(NSProgress *downloadProgress)) downloadProgressBlock</div><div class="line">                            completionHandler:(nullable void (^)(NSURLResponse *response, id _Nullable responseObject,  NSError * _Nullable error))completionHandler &#123;</div><div class="line"></div><div class="line">    __block NSURLSessionDataTask *dataTask = nil;</div><div class="line">    url_session_manager_create_task_safely(^&#123;</div><div class="line">        dataTask = [self.session dataTaskWithRequest:request];</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    [self addDelegateForDataTask:dataTask uploadProgress:uploadProgressBlock downloadProgress:downloadProgressBlock completionHandler:completionHandler];</div><div class="line"></div><div class="line">    return dataTask;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…ˆçœ‹çœ‹ä¸Šé¢è¿™ä¸ªå®çš„å®ç°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">static void url_session_manager_create_task_safely(dispatch_block_t block) &#123;</div><div class="line">    if (NSFoundationVersionNumber &lt; NSFoundationVersionNumber_With_Fixed_5871104061079552_bug) &#123;</div><div class="line">        // Fix of bug</div><div class="line">        // Open Radar:http://openradar.appspot.com/radar?id=5871104061079552 (status: Fixed in iOS8)</div><div class="line">        // Issue about:https://github.com/AFNetworking/AFNetworking/issues/2093</div><div class="line">        dispatch_sync(url_session_manager_creation_queue(), block);</div><div class="line">    &#125; else &#123;</div><div class="line">        block();</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">static dispatch_queue_t url_session_manager_creation_queue() &#123;</div><div class="line">    static dispatch_queue_t af_url_session_manager_creation_queue;</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        af_url_session_manager_creation_queue = dispatch_queue_create(&quot;com.alamofire.networking.session.manager.creation&quot;, DISPATCH_QUEUE_SERIAL);</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    return af_url_session_manager_creation_queue;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œè¿™æ ·åšä¸»è¦æ˜¯ä¸ºäº†è§£å†³ios8ä¹‹å‰çš„ä¸€ä¸ªbugï¼Œå¦‚æœå¼‚æ­¥åŒæ—¶åˆ›å»ºtaskçš„è¯ï¼Œtaskçš„idæœ‰å¯èƒ½æ˜¯ä¸€æ ·çš„ï¼Œè¿™ä¼šå¯¼è‡´å›è°ƒæ—¶å‡ºç°é—®é¢˜ï¼ˆcompletionHandlerè¢«æ›¿æ¢ï¼‰ï¼Œä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œåˆ›å»ºtaskçš„æ“ä½œéƒ½æ”¾åœ¨ä¸€ä¸ªä¸²è¡Œé˜Ÿåˆ—ä¸­æ‰§è¡Œã€‚</p>
<p>ç„¶åçœ‹ä¸€ä¸‹æ·»åŠ ä»£ç†è¿™ä¸ªåˆæ˜¯è¦å¹²å˜›</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">- (void)addDelegateForDataTask:(NSURLSessionDataTask *)dataTask</div><div class="line">                uploadProgress:(nullable void (^)(NSProgress *uploadProgress)) uploadProgressBlock</div><div class="line">              downloadProgress:(nullable void (^)(NSProgress *downloadProgress)) downloadProgressBlock</div><div class="line">             completionHandler:(void (^)(NSURLResponse *response, id responseObject, NSError *error))completionHandler</div><div class="line">&#123;</div><div class="line">    AFURLSessionManagerTaskDelegate *delegate = [[AFURLSessionManagerTaskDelegate alloc] initWithTask:dataTask];</div><div class="line">    delegate.manager = self;</div><div class="line">    delegate.completionHandler = completionHandler;</div><div class="line"></div><div class="line">    dataTask.taskDescription = self.taskDescriptionForSessionTasks;</div><div class="line">    [self setDelegate:delegate forTask:dataTask];</div><div class="line"></div><div class="line">    delegate.uploadProgressBlock = uploadProgressBlock;</div><div class="line">    delegate.downloadProgressBlock = downloadProgressBlock;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)setDelegate:(AFURLSessionManagerTaskDelegate *)delegate</div><div class="line">            forTask:(NSURLSessionTask *)task</div><div class="line">&#123;</div><div class="line">    NSParameterAssert(task);</div><div class="line">    NSParameterAssert(delegate);</div><div class="line"></div><div class="line">    [self.lock lock];</div><div class="line">    self.mutableTaskDelegatesKeyedByTaskIdentifier[@(task.taskIdentifier)] = delegate;</div><div class="line">    [self addNotificationObserverForTask:task];</div><div class="line">    [self.lock unlock];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œafä¸ºæ¯ä¸€ä¸ªtaskéƒ½åˆ›å»ºäº†ä¸€ä¸ªdelegateï¼Œç„¶åå°†ä»£ç†å­˜åœ¨äº†self.mutableTaskDelegatesKeyedByTaskIdentifierè¿™ä¸ªå­—å…¸ä¸­ï¼Œé”®å€¼æ˜¯taskçš„id,è¿™é‡Œä¹Ÿè§£é‡Šäº†ä¸Šé¢çš„ä¸ºå•¥è¦åŒæ­¥åˆ›å»ºtask,é‚£ä¹ˆå®ƒä¸ºå•¥è¦ä¸ºæ¯ä¸ªtaskæ·»åŠ ä¸€ä¸ªä»£ç†å‘¢ï¼Œæˆ‘ä»¬ç»§ç»­å¾€ä¸‹çœ‹ã€‚</p>
<p>çœ‹å®Œtaskçš„åˆ›å»ºï¼Œç„¶åæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹æ•°æ®çš„å›è°ƒã€‚<strong>afä¸ºæ¯ä¸ªNSURLSessionçš„å›è°ƒå‡½æ•°åˆ›å»ºäº†å¯¹åº”blockå’ŒsetBlockçš„æ–¹æ³•ï¼Œå¦‚æœä½ éœ€è¦å“ªä¸ªä»£ç†é‡Œé¢çš„æ•°æ®ï¼Œç›´æ¥åˆ›å»ºå¯¹åº”çš„blockå³å¯ã€‚</strong></p>
<p>æˆ‘ä»¬å…ˆæ¥çœ‹æœ€å¸¸ç”¨çš„å›è°ƒæ–¹æ³•ï¼Œå³è¯·æ±‚å®Œæˆçš„å›è°ƒ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line">- (void)URLSession:(NSURLSession *)session</div><div class="line">              task:(NSURLSessionTask *)task</div><div class="line">didCompleteWithError:(NSError *)error</div><div class="line">&#123;</div><div class="line">    AFURLSessionManagerTaskDelegate *delegate = [self delegateForTask:task];</div><div class="line"></div><div class="line">    // delegate may be nil when completing a task in the background</div><div class="line">    if (delegate) &#123;</div><div class="line">        [delegate URLSession:session task:task didCompleteWithError:error];</div><div class="line">        </div><div class="line">        //å°†è¯¥taskçš„ä»£ç†ä»å­—å…¸ä¸­ç§»é™¤</div><div class="line">        [self removeDelegateForTask:task];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (self.taskDidComplete) &#123;</div><div class="line">        self.taskDidComplete(session, task, error);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">- (void)URLSession:(__unused NSURLSession *)session</div><div class="line">              task:(NSURLSessionTask *)task</div><div class="line">didCompleteWithError:(NSError *)error</div><div class="line">&#123;</div><div class="line">    __strong AFURLSessionManager *manager = self.manager;</div><div class="line"></div><div class="line">    __block id responseObject = nil;</div><div class="line"></div><div class="line">    __block NSMutableDictionary *userInfo = [NSMutableDictionary dictionary];</div><div class="line">    userInfo[AFNetworkingTaskDidCompleteResponseSerializerKey] = manager.responseSerializer;</div><div class="line"></div><div class="line">    //Performance Improvement from #2672</div><div class="line">    NSData *data = nil;</div><div class="line">    if (self.mutableData) &#123;</div><div class="line">        data = [self.mutableData copy];</div><div class="line">        //We no longer need the reference, so nil it out to gain back some memory.</div><div class="line">        self.mutableData = nil;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (self.downloadFileURL) &#123;</div><div class="line">        userInfo[AFNetworkingTaskDidCompleteAssetPathKey] = self.downloadFileURL;</div><div class="line">    &#125; else if (data) &#123;</div><div class="line">        userInfo[AFNetworkingTaskDidCompleteResponseDataKey] = data;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (error) &#123;</div><div class="line">        userInfo[AFNetworkingTaskDidCompleteErrorKey] = error;</div><div class="line"></div><div class="line">        dispatch_group_async(manager.completionGroup ?: url_session_manager_completion_group(), manager.completionQueue ?: dispatch_get_main_queue(), ^&#123;</div><div class="line">            if (self.completionHandler) &#123;</div><div class="line">                self.completionHandler(task.response, responseObject, error);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">                [[NSNotificationCenter defaultCenter] postNotificationName:AFNetworkingTaskDidCompleteNotification object:task userInfo:userInfo];</div><div class="line">            &#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125; else &#123;</div><div class="line">        dispatch_async(url_session_manager_processing_queue(), ^&#123;</div><div class="line">            NSError *serializationError = nil;</div><div class="line">            responseObject = [manager.responseSerializer responseObjectForResponse:task.response data:data error:&amp;serializationError];</div><div class="line"></div><div class="line">            if (self.downloadFileURL) &#123;</div><div class="line">                responseObject = self.downloadFileURL;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (responseObject) &#123;</div><div class="line">                userInfo[AFNetworkingTaskDidCompleteSerializedResponseKey] = responseObject;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            if (serializationError) &#123;</div><div class="line">                userInfo[AFNetworkingTaskDidCompleteErrorKey] = serializationError;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            dispatch_group_async(manager.completionGroup ?: url_session_manager_completion_group(), manager.completionQueue ?: dispatch_get_main_queue(), ^&#123;</div><div class="line">                if (self.completionHandler) &#123;</div><div class="line">                    self.completionHandler(task.response, responseObject, serializationError);</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                dispatch_async(dispatch_get_main_queue(), ^&#123;</div><div class="line">                    [[NSNotificationCenter defaultCenter] postNotificationName:AFNetworkingTaskDidCompleteNotification object:task userInfo:userInfo];</div><div class="line">                &#125;);</div><div class="line">            &#125;);</div><div class="line">        &#125;);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å’‹ä¸€çœ‹æœ‰ç‚¹å¥‡æ€ªï¼Œè¿™2æ–¹æ³•åä¸€æ¯›ä¸€æ ·å•Šã€‚æ²¡æœ‰é”™ï¼Œè¿™ä¸¤ä¸ªæ–¹æ³•æ˜¯åŒä¸€ä¸ªä»£ç†æ–¹æ³•ï¼Œåªæ˜¯ä»–ä»¬çš„å®ç°å¯¹è±¡æ˜¯ä¸ä¸€æ ·çš„ï¼Œç¬¬ä¸€ä¸ªçš„å®ç°å¯¹è±¡æ˜¯AFURLSessionManagerç±»,ç¬¬äºŒä¸ªçš„å®ç°å¯¹è±¡åˆ™æ˜¯AFURLSessionManagerTaskDelegateè¿™ä¸ªç±»ï¼Œè¿™é‡Œå°±è§£é‡Šä¸Šé¢çš„ä¸ºå•¥è¦ä¸ºæ¯ä¸€ä¸ªtaskè®¾ç½®ä¸€ä¸ªä»£ç†ï¼Œafè¿™é‡Œå…¶å®æ˜¯å§NSURLSessionçš„ä»£ç†åˆåŒ…äº†ä¸€å±‚ï¼Œå°†NSURLSessionçš„æ•°æ®éƒ½ä¼ åˆ°AFURLSessionManagerTaskDelegateè¿™ä¸ªç±»é‡Œé¢å»å¤„ç†äº†ã€‚</p>
<p>ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹è¿™ä¸ªå›è°ƒä¸­å¯¹æ•°æ®çš„å¤„ç†ï¼Œå¯ä»¥çœ‹åˆ°å›è°ƒçš„è¿”å›éƒ½æ˜¯æ”¾åœ¨ä¸€ä¸ªgcdçš„groupä¸­å¤„ç†çš„ï¼Œå¦‚æœæˆ‘ä»¬è®¾ç½®äº†è¿”å›å¤„ç†çº¿ç¨‹çš„è¯å°±ä½¿ç”¨è®¾ç½®çš„çº¿ç¨‹ï¼Œå¦åˆ™ä¼šåœ¨ä¸»çº¿ç¨‹ä¸­å¤„ç†æ•°æ®çš„è¿”å›ï¼Œå¦‚æœæœ‰é”™è¯¯æ˜¯ç›´æ¥è¿”å›äº†ï¼Œæ²¡æœ‰é”™è¯¯çš„è¯ï¼Œä¼šå…ˆä½¿ç”¨responeseSerializerå»éªŒè¯ä¸€ä¸‹è¿”å›çš„æ•°æ®æ ¼å¼æ˜¯å¦åˆæ³•ï¼Œè¿™ä¸ªç±»æˆ‘ä»¬ä¸‹é¢åœ¨ç»†çœ‹ã€‚</p>
<p>ç»§ç»­çœ‹å…¶ä»–å‡ ä¸ªæˆ‘è§‰å¾—æ¯”è¾ƒå¸¸ç”¨çš„å›è°ƒ</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">- (void)URLSession:(NSURLSession *)session</div><div class="line">          dataTask:(NSURLSessionDataTask *)dataTask</div><div class="line">didReceiveResponse:(NSURLResponse *)response</div><div class="line"> completionHandler:(void (^)(NSURLSessionResponseDisposition disposition))completionHandler</div><div class="line">&#123;</div><div class="line">    NSURLSessionResponseDisposition disposition = NSURLSessionResponseAllow;</div><div class="line"></div><div class="line">    if (self.dataTaskDidReceiveResponse) &#123;</div><div class="line">        disposition = self.dataTaskDidReceiveResponse(session, dataTask, response);</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (completionHandler) &#123;</div><div class="line">        completionHandler(disposition);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">- (void)URLSession:(NSURLSession *)session</div><div class="line">          dataTask:(NSURLSessionDataTask *)dataTask</div><div class="line">    didReceiveData:(NSData *)data</div><div class="line">&#123;</div><div class="line"></div><div class="line">    AFURLSessionManagerTaskDelegate *delegate = [self delegateForTask:dataTask];</div><div class="line">    [delegate URLSession:session dataTask:dataTask didReceiveData:data];</div><div class="line"></div><div class="line">    if (self.dataTaskDidReceiveData) &#123;</div><div class="line">        self.dataTaskDidReceiveData(session, dataTask, data);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (void)URLSession:(__unused NSURLSession *)session</div><div class="line">          dataTask:(__unused NSURLSessionDataTask *)dataTask</div><div class="line">    didReceiveData:(NSData *)data</div><div class="line">&#123;</div><div class="line">    self.downloadProgress.totalUnitCount = dataTask.countOfBytesExpectedToReceive;</div><div class="line">    self.downloadProgress.completedUnitCount = dataTask.countOfBytesReceived;</div><div class="line"></div><div class="line">	//è¿™é‡Œä¿å­˜çš„æ•°æ®ä¼šåœ¨completeçš„å›è°ƒä¸­ä½¿ç”¨</div><div class="line">    [self.mutableData appendData:data];</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™2ä¸ªå›è°ƒä¸€ä¸ªæ˜¯æ”¶åˆ°responeseè¢«è§¦å‘ï¼Œè¿™ä¸ªå›è°ƒå¯ä»¥æ‹¿åˆ°ç›¸åº”å¤´éƒ¨ä¿¡æ¯ï¼Œæ¯”å¦‚æ¥æ”¶æ–‡ä»¶çš„å¤§å°ï¼Œæ ¼å¼ç­‰ï¼Œä¸€ä¸ªæ˜¯æ”¶åˆ°æ•°æ®æ—¶è¢«è§¦å‘ï¼Œè¿›åº¦ç›¸å…³çš„ä¿¡æ¯å°±åœ¨é€šè¿‡è¿™ä¸ªå›è°ƒæ‹¿åˆ°çš„ã€‚<strong>è¿˜æœ‰ä¸€ç‚¹å°±æ˜¯ï¼Œdownloadçš„taskä¸ä¼šèµ°datataskçš„ä»£ç†ï¼Œæ„å‘³ç€downloadçš„æ•°æ®åªèƒ½åœ¨ä¸‹è½½å®Œæˆåé€šè¿‡æ–‡ä»¶çš„æ–¹å¼æ‹¿åˆ°ã€‚</strong></p>
<h4 id="AFHTTPSessionManager"><a href="#AFHTTPSessionManager" class="headerlink" title="AFHTTPSessionManager"></a>AFHTTPSessionManager</h4><p>è¿™ä¸ªç±»å°±æ˜¯ç»§æ‰¿äº†AFURLSessionManagerï¼Œç„¶åæä¾›äº†ä¸€äº›å°è£…å¥½çš„åˆ›å»ºtaskçš„æ–¹æ³•ã€‚å¹³æ—¶äºŒæ¬¡å°è£…ä¹Ÿæ˜¯ä½¿ç”¨è¿™ä¸ªç±»å°±è¡Œã€‚</p>
<p>ç„¶åè¿™ä¸ªç±»æœ‰ä¸‰ä¸ªæ¯”è¾ƒé‡è¦çš„å±æ€§</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">@property (nonatomic, strong) AFHTTPRequestSerializer &lt;AFURLRequestSerialization&gt; * requestSerializer;</div><div class="line"></div><div class="line">@property (nonatomic, strong) AFHTTPResponseSerializer &lt;AFURLResponseSerialization&gt; * responseSerializer;</div><div class="line"></div><div class="line">@property (nonatomic, strong) AFSecurityPolicy *securityPolicy;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œç®€å•ä»‹ç»æ¯ä¸ªå±æ€§çš„ç”¨é€”ï¼Œä¸‹é¢è¿˜æœ‰è¯¦è§£ã€‚<br>requestSerializerä¸»è¦ç”¨æ¥è®¾ç½®httpheaderï¼ŒresponseSerializerä¸»è¦ç”¨æ¥è§£æè¿”å›æ•°æ®æ˜¯å¦åˆæ³•ï¼Œ<br>securityPolicyä¸»è¦ç”¨æ¥éªŒè¯æœåŠ¡å™¨è¯ä¹¦ã€‚</p>
<h4 id="AFHTTPRequestSerializer"><a href="#AFHTTPRequestSerializer" class="headerlink" title="AFHTTPRequestSerializer"></a>AFHTTPRequestSerializer</h4><p>å…ˆæ¥çœ‹ä¸€ä¸‹AFHTTPRequestSerializeråœ¨AFHTTPSessionManagerä¸­æ˜¯å¦‚ä½•ä½¿ç”¨çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line">- (NSURLSessionDataTask *)dataTaskWithHTTPMethod:(NSString *)method</div><div class="line">                                       URLString:(NSString *)URLString</div><div class="line">                                      parameters:(id)parameters</div><div class="line">                                  uploadProgress:(nullable void (^)(NSProgress *uploadProgress)) uploadProgress</div><div class="line">                                downloadProgress:(nullable void (^)(NSProgress *downloadProgress)) downloadProgress</div><div class="line">                                         success:(void (^)(NSURLSessionDataTask *, id))success</div><div class="line">                                         failure:(void (^)(NSURLSessionDataTask *, NSError *))failure</div><div class="line">&#123;</div><div class="line">    NSError *serializationError = nil;</div><div class="line">    NSMutableURLRequest *request = [self.requestSerializer requestWithMethod:method URLString:[[NSURL URLWithString:URLString relativeToURL:self.baseURL] absoluteString] parameters:parameters error:&amp;serializationError];</div><div class="line">    if (serializationError) &#123;</div><div class="line">        if (failure) &#123;</div><div class="line">            dispatch_async(self.completionQueue ?: dispatch_get_main_queue(), ^&#123;</div><div class="line">                failure(nil, serializationError);</div><div class="line">            &#125;);</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    __block NSURLSessionDataTask *dataTask = nil;</div><div class="line">    dataTask = [self dataTaskWithRequest:request</div><div class="line">                          uploadProgress:uploadProgress</div><div class="line">                        downloadProgress:downloadProgress</div><div class="line">                       completionHandler:^(NSURLResponse * __unused response, id responseObject, NSError *error) &#123;</div><div class="line">        if (error) &#123;</div><div class="line">            if (failure) &#123;</div><div class="line">                failure(dataTask, error);</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            if (success) &#123;</div><div class="line">                success(dataTask, responseObject);</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line"></div><div class="line">    return dataTask;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ï¼Œåœ¨è°ƒç”¨AFURLSessionManagerçš„åˆ›å»ºtaskæ–¹æ³•å‰ï¼Œä¼šå…ˆè°ƒç”¨ä¸€ä¸‹ä¸‹é¢è¿™ä¸ªæ–¹æ³•ç”Ÿæˆä¸€ä¸ªrequest</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">NSMutableURLRequest *request = [self.requestSerializer requestWithMethod:method URLString:[[NSURL URLWithString:URLString relativeToURL:self.baseURL] absoluteString] parameters:parameters error:&amp;serializationError];</div></pre></td></tr></table></figure>
<p>é‚£æˆ‘ä»¬æ¥å…·ä½“çœ‹ä¸€ä¸‹è¿™ä¸ªæ–¹æ³•çš„å®ç°</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line">- (NSMutableURLRequest *)requestWithMethod:(NSString *)method</div><div class="line">                                 URLString:(NSString *)URLString</div><div class="line">                                parameters:(id)parameters</div><div class="line">                                     error:(NSError *__autoreleasing *)error</div><div class="line">&#123;</div><div class="line">    NSParameterAssert(method);</div><div class="line">    NSParameterAssert(URLString);</div><div class="line"></div><div class="line">    NSURL *url = [NSURL URLWithString:URLString];</div><div class="line"></div><div class="line">    NSParameterAssert(url);</div><div class="line"></div><div class="line">    NSMutableURLRequest *mutableRequest = [[NSMutableURLRequest alloc] initWithURL:url];</div><div class="line">    mutableRequest.HTTPMethod = method;</div><div class="line"></div><div class="line">    for (NSString *keyPath in AFHTTPRequestSerializerObservedKeyPaths()) &#123;</div><div class="line">        if ([self.mutableObservedChangedKeyPaths containsObject:keyPath]) &#123;</div><div class="line">            [mutableRequest setValue:[self valueForKeyPath:keyPath] forKey:keyPath];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    mutableRequest = [[self requestBySerializingRequest:mutableRequest withParameters:parameters error:error] mutableCopy];</div><div class="line"></div><div class="line">	return mutableRequest;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">- (NSURLRequest *)requestBySerializingRequest:(NSURLRequest *)request</div><div class="line">                               withParameters:(id)parameters</div><div class="line">                                        error:(NSError *__autoreleasing *)error</div><div class="line">&#123;</div><div class="line">    NSParameterAssert(request);</div><div class="line"></div><div class="line">    NSMutableURLRequest *mutableRequest = [request mutableCopy];</div><div class="line"></div><div class="line">    [self.HTTPRequestHeaders enumerateKeysAndObjectsUsingBlock:^(id field, id value, BOOL * __unused stop) &#123;</div><div class="line">        if (![request valueForHTTPHeaderField:field]) &#123;</div><div class="line">            [mutableRequest setValue:value forHTTPHeaderField:field];</div><div class="line">        &#125;</div><div class="line">    &#125;];</div><div class="line"></div><div class="line">    NSString *query = nil;</div><div class="line">    if (parameters) &#123;</div><div class="line">        if (self.queryStringSerialization) &#123;</div><div class="line">            NSError *serializationError;</div><div class="line">            query = self.queryStringSerialization(request, parameters, &amp;serializationError);</div><div class="line"></div><div class="line">            if (serializationError) &#123;</div><div class="line">                if (error) &#123;</div><div class="line">                    *error = serializationError;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                return nil;</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            switch (self.queryStringSerializationStyle) &#123;</div><div class="line">                case AFHTTPRequestQueryStringDefaultStyle:</div><div class="line">                    query = AFQueryStringFromParameters(parameters);</div><div class="line">                    break;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if ([self.HTTPMethodsEncodingParametersInURI containsObject:[[request HTTPMethod] uppercaseString]]) &#123;</div><div class="line">        if (query &amp;&amp; query.length &gt; 0) &#123;</div><div class="line">            mutableRequest.URL = [NSURL URLWithString:[[mutableRequest.URL absoluteString] stringByAppendingFormat:mutableRequest.URL.query ? @&quot;&amp;%@&quot; : @&quot;?%@&quot;, query]];</div><div class="line">        &#125;</div><div class="line">    &#125; else &#123;</div><div class="line">        // #2864: an empty string is a valid x-www-form-urlencoded payload</div><div class="line">        if (!query) &#123;</div><div class="line">            query = @&quot;&quot;;</div><div class="line">        &#125;</div><div class="line">        if (![mutableRequest valueForHTTPHeaderField:@&quot;Content-Type&quot;]) &#123;</div><div class="line">            [mutableRequest setValue:@&quot;application/x-www-form-urlencoded&quot; forHTTPHeaderField:@&quot;Content-Type&quot;];</div><div class="line">        &#125;</div><div class="line">        [mutableRequest setHTTPBody:[query dataUsingEncoding:self.stringEncoding]];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return mutableRequest;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…·ä½“æµç¨‹ï¼š</p>
<ul>
<li>ä½¿ç”¨urlå’Œmethodåˆ›å»ºä¸€ä¸ªmutableRequestï¼Œ</li>
<li>kvoç›¸å…³å±æ€§ï¼Œå¦‚æœä¸ä¸ºç©ºåˆ™kvcåˆ°mutableRequest</li>
<li>è®¾ç½®HTTPRequestHeadersæ•°ç»„ä¸­ç›¸å…³å±æ€§åˆ°mutableRequest</li>
<li>å°†ä¼ å…¥çš„å‚æ•°åšä¸€ä¸‹urlç¼–ç </li>
<li>å¦‚æœæ˜¯getï¼Œhead,deleteæ–¹å¼ï¼Œå°†å‚æ•°åŠ åˆ°urlåé¢ï¼Œå¦åˆ™ï¼Œå°†å‚æ•°è®¾ç½®ä¸ºmutableRequestçš„bodyï¼ŒåŒæ—¶è®¾ç½®mutableRequestçš„Content-Type.</li>
</ul>
<p>å¯ä»¥çœ‹å‡ºï¼Œè¿™ä¸ªç±»çš„ä¸»è¦ä½œç”¨å°±æ˜¯åˆ›å»ºrequestï¼Œç»™requestè®¾ç½®ç›¸åº”çš„headerå’Œbody,å¯¹urlå’Œå‚æ•°è¿›è¡Œç¼–ç (urlä½¿ç”¨URLEncode,bodyä½¿ç”¨UNICodeç¼–ç ).</p>
<h4 id="AFHTTPResponseSerializer"><a href="#AFHTTPResponseSerializer" class="headerlink" title="AFHTTPResponseSerializer"></a>AFHTTPResponseSerializer</h4><p>è¿™ä¸ªç±»åœ¨ä¸Šé¢çš„completeå›è°ƒä¸­æœ‰æåˆ°ï¼Œè¿™é‡Œå…·ä½“åˆ†æã€‚</p>
<p>afä¸€å…±æä¾›äº†7ç§ResponseSerializerï¼Œåˆ†åˆ«æ˜¯ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">AFHTTPResponseSerializer</div><div class="line"></div><div class="line">AFJSONResponseSerializer</div><div class="line"></div><div class="line">AFXMLParserResponseSerializer</div><div class="line"></div><div class="line">AFXMLDocumentResponseSerializer</div><div class="line"></div><div class="line">AFPropertyListResponseSerializer</div><div class="line"></div><div class="line">AFImageResponseSerializer</div><div class="line"></div><div class="line">AFCompoundResponseSerializer</div></pre></td></tr></table></figure>
<p>ä¸åŒçš„responseé’ˆå¯¹ä¸åŒçš„æ•°æ®ç±»å‹ã€‚</p>
<p>ä»–ä»¬çš„ä¸»è¦åŒºåˆ«å…¶å®å°±åœ¨acceptableContentTypesè¿™ä¸ªå±æ€§ä¸Šï¼Œå®ƒæ˜¯ä¸€ä¸ªé›†åˆï¼Œç”¨æ¥å­˜å‚¨æˆ‘ä»¬éœ€è¦æ¥å—çš„æ•°æ®ç±»å‹ã€‚</p>
<p>æ¯”å¦‚JSONçš„acceptableContentTypesä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">self.acceptableContentTypes = [NSSet setWithObjects:@&quot;application/json&quot;, @&quot;text/json&quot;, @&quot;text/javascript&quot;, nil];</div></pre></td></tr></table></figure>
<p>IMAGEçš„acceptableContentTypesä¸ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">self.acceptableContentTypes = [[NSSet alloc] initWithObjects:@&quot;image/tiff&quot;, @&quot;image/jpeg&quot;, @&quot;image/gif&quot;, @&quot;image/png&quot;, @&quot;image/ico&quot;, @&quot;image/x-icon&quot;, @&quot;image/bmp&quot;, @&quot;image/x-bmp&quot;, @&quot;image/x-xbitmap&quot;, @&quot;image/x-win-bitmap&quot;, nil];</div></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥é€šè¿‡NSHTTPSessionManagerçš„responseSerializerä¿®æ”¹ä½ éœ€è¦çš„æ•°æ®ç±»å‹ã€‚</p>
<p>å›åˆ°ä¹‹å‰çš„completeå›è°ƒï¼Œçœ‹çœ‹å…·ä½“æ€ä¹ˆä½¿ç”¨çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line">responseObject = [manager.responseSerializer responseObjectForResponse:task.response data:data error:&amp;serializationError];</div><div class="line"></div><div class="line">- (BOOL)validateResponse:(NSHTTPURLResponse *)response</div><div class="line">                    data:(NSData *)data</div><div class="line">                   error:(NSError * __autoreleasing *)error</div><div class="line">&#123;</div><div class="line">    BOOL responseIsValid = YES;</div><div class="line">    NSError *validationError = nil;</div><div class="line"></div><div class="line">    if (response &amp;&amp; [response isKindOfClass:[NSHTTPURLResponse class]]) &#123;</div><div class="line">        if (self.acceptableContentTypes &amp;&amp; ![self.acceptableContentTypes containsObject:[response MIMEType]] &amp;&amp;</div><div class="line">            !([response MIMEType] == nil &amp;&amp; [data length] == 0)) &#123;</div><div class="line"></div><div class="line">            if ([data length] &gt; 0 &amp;&amp; [response URL]) &#123;</div><div class="line">                NSMutableDictionary *mutableUserInfo = [@&#123;</div><div class="line">                                                          NSLocalizedDescriptionKey: [NSString stringWithFormat:NSLocalizedStringFromTable(@&quot;Request failed: unacceptable content-type: %@&quot;, @&quot;AFNetworking&quot;, nil), [response MIMEType]],</div><div class="line">                                                          NSURLErrorFailingURLErrorKey:[response URL],</div><div class="line">                                                          AFNetworkingOperationFailingURLResponseErrorKey: response,</div><div class="line">                                                        &#125; mutableCopy];</div><div class="line">                if (data) &#123;</div><div class="line">                    mutableUserInfo[AFNetworkingOperationFailingURLResponseDataErrorKey] = data;</div><div class="line">                &#125;</div><div class="line"></div><div class="line">                validationError = AFErrorWithUnderlyingError([NSError errorWithDomain:AFURLResponseSerializationErrorDomain code:NSURLErrorCannotDecodeContentData userInfo:mutableUserInfo], validationError);</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            responseIsValid = NO;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        if (self.acceptableStatusCodes &amp;&amp; ![self.acceptableStatusCodes containsIndex:(NSUInteger)response.statusCode] &amp;&amp; [response URL]) &#123;</div><div class="line">            NSMutableDictionary *mutableUserInfo = [@&#123;</div><div class="line">                                               NSLocalizedDescriptionKey: [NSString stringWithFormat:NSLocalizedStringFromTable(@&quot;Request failed: %@ (%ld)&quot;, @&quot;AFNetworking&quot;, nil), [NSHTTPURLResponse localizedStringForStatusCode:response.statusCode], (long)response.statusCode],</div><div class="line">                                               NSURLErrorFailingURLErrorKey:[response URL],</div><div class="line">                                               AFNetworkingOperationFailingURLResponseErrorKey: response,</div><div class="line">                                       &#125; mutableCopy];</div><div class="line"></div><div class="line">            if (data) &#123;</div><div class="line">                mutableUserInfo[AFNetworkingOperationFailingURLResponseDataErrorKey] = data;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            validationError = AFErrorWithUnderlyingError([NSError errorWithDomain:AFURLResponseSerializationErrorDomain code:NSURLErrorBadServerResponse userInfo:mutableUserInfo], validationError);</div><div class="line"></div><div class="line">            responseIsValid = NO;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (error &amp;&amp; !responseIsValid) &#123;</div><div class="line">        *error = validationError;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return responseIsValid;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>[response MIMEType] è¿™ä¸ªtypeå°±æ˜¯å½“å‰æœåŠ¡å™¨è¿”å›çš„æ•°æ®çš„æ ¼å¼ï¼Œéœ€è¦self.acceptableContentTypesè¿™ä¸ªé›†åˆä¸­åŒ…å«ä¸Šé¢çš„typeï¼Œè§£ææ•°æ®çš„æ—¶å€™æ‰ä¼šè¿”å›æˆåŠŸï¼Œæ‰€ä»¥ï¼Œå¦‚æœé‡åˆ°è§£æå¤±è´¥çš„è¯ï¼Œå¯ä»¥æ–­ç‚¹åˆ°è¿™é‡Œçœ‹ä¸€ä¸‹è¿™ä¸ªtypeç„¶åæ‰‹åŠ¨æ·»åŠ åˆ°acceptableContentTypesè¿™ä¸ªé›†åˆä¸­ã€‚</p>
<h4 id="AFSecurityPolicy"><a href="#AFSecurityPolicy" class="headerlink" title="AFSecurityPolicy"></a>AFSecurityPolicy</h4><p>afæä¾›äº†ä¸‰ç§éªŒè¯è¯ä¹¦çš„æ–¹å¼ï¼Œç¬¬ä¸€ç§ä¸éœ€è¦æœ¬åœ°è¯ä¹¦ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">typedef NS_ENUM(NSUInteger, AFSSLPinningMode) &#123;</div><div class="line">    AFSSLPinningModeNone,//é»˜è®¤æ–¹å¼ï¼Œåªéœ€è¦éªŒè¯æœåŠ¡å™¨è¿”å›çš„è¯ä¹¦æ˜¯å¦åˆæ³•</div><div class="line">    AFSSLPinningModePublicKey,//éœ€è¦éªŒè¯æœ¬åœ°è¯ä¹¦ä¸­çš„å…¬é’¥æ˜¯å¦åŒ…å«æœåŠ¡å™¨è¿”å›çš„è¯ä¹¦ä¸­çš„å…¬é’¥</div><div class="line">    AFSSLPinningModeCertificate,//éœ€è¦éªŒè¯æœ¬åœ°è¯ä¹¦æ˜¯å¦åœ¨æœåŠ¡å™¨è¯ä¹¦çš„è¯ä¹¦é“¾ä¸­</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<p>å¯¹åº”çš„æœ‰å‡ ç§ä¸åŒçš„åˆå§‹åŒ–æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">+ (NSSet *)certificatesInBundle:(NSBundle *)bundle &#123;</div><div class="line">    NSArray *paths = [bundle pathsForResourcesOfType:@&quot;cer&quot; inDirectory:@&quot;.&quot;];</div><div class="line"></div><div class="line">    NSMutableSet *certificates = [NSMutableSet setWithCapacity:[paths count]];</div><div class="line">    for (NSString *path in paths) &#123;</div><div class="line">        NSData *certificateData = [NSData dataWithContentsOfFile:path];</div><div class="line">        [certificates addObject:certificateData];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    return [NSSet setWithSet:certificates];</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (NSSet *)defaultPinnedCertificates &#123;</div><div class="line">    static NSSet *_defaultPinnedCertificates = nil;</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        NSBundle *bundle = [NSBundle bundleForClass:[self class]];</div><div class="line">        _defaultPinnedCertificates = [self certificatesInBundle:bundle];</div><div class="line">    &#125;);</div><div class="line"></div><div class="line">    return _defaultPinnedCertificates;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (instancetype)defaultPolicy &#123;</div><div class="line">    AFSecurityPolicy *securityPolicy = [[self alloc] init];</div><div class="line">    securityPolicy.SSLPinningMode = AFSSLPinningModeNone;</div><div class="line"></div><div class="line">    return securityPolicy;</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (instancetype)policyWithPinningMode:(AFSSLPinningMode)pinningMode &#123;</div><div class="line">    return [self policyWithPinningMode:pinningMode withPinnedCertificates:[self defaultPinnedCertificates]];</div><div class="line">&#125;</div><div class="line"></div><div class="line">+ (instancetype)policyWithPinningMode:(AFSSLPinningMode)pinningMode withPinnedCertificates:(NSSet *)pinnedCertificates &#123;</div><div class="line">    AFSecurityPolicy *securityPolicy = [[self alloc] init];</div><div class="line">    securityPolicy.SSLPinningMode = pinningMode;</div><div class="line"></div><div class="line">    [securityPolicy setPinnedCertificates:pinnedCertificates];</div><div class="line"></div><div class="line">    return securityPolicy;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åæˆ‘ä»¬çœ‹ä¸€ä¸‹åˆ°åº•æ˜¯å¦‚ä½•è¿›è¡Œè¯ä¹¦éªŒè¯çš„</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line">- (BOOL)evaluateServerTrust:(SecTrustRef)serverTrust</div><div class="line">                  forDomain:(NSString *)domain</div><div class="line">&#123;</div><div class="line">    if (domain &amp;&amp; self.allowInvalidCertificates &amp;&amp; self.validatesDomainName &amp;&amp; (self.SSLPinningMode == AFSSLPinningModeNone || [self.pinnedCertificates count] == 0)) &#123;</div><div class="line">        // https://developer.apple.com/library/mac/documentation/NetworkingInternet/Conceptual/NetworkingTopics/Articles/OverridingSSLChainValidationCorrectly.html</div><div class="line">        //  According to the docs, you should only trust your provided certs for evaluation.</div><div class="line">        //  Pinned certificates are added to the trust. Without pinned certificates,</div><div class="line">        //  there is nothing to evaluate against.</div><div class="line">        //</div><div class="line">        //  From Apple Docs:</div><div class="line">        //          &quot;Do not implicitly trust self-signed certificates as anchors (kSecTrustOptionImplicitAnchors).</div><div class="line">        //           Instead, add your own (self-signed) CA certificate to the list of trusted anchors.&quot;</div><div class="line">        NSLog(@&quot;In order to validate a domain name for self signed certificates, you MUST use pinning.&quot;);</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    NSMutableArray *policies = [NSMutableArray array];</div><div class="line">    if (self.validatesDomainName) &#123;</div><div class="line">        [policies addObject:(__bridge_transfer id)SecPolicyCreateSSL(true, (__bridge CFStringRef)domain)];</div><div class="line">    &#125; else &#123;</div><div class="line">        [policies addObject:(__bridge_transfer id)SecPolicyCreateBasicX509()];</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    SecTrustSetPolicies(serverTrust, (__bridge CFArrayRef)policies);</div><div class="line"></div><div class="line">    if (self.SSLPinningMode == AFSSLPinningModeNone) &#123;</div><div class="line">        return self.allowInvalidCertificates || AFServerTrustIsValid(serverTrust);</div><div class="line">    &#125; else if (!AFServerTrustIsValid(serverTrust) &amp;&amp; !self.allowInvalidCertificates) &#123;</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    switch (self.SSLPinningMode) &#123;</div><div class="line">        case AFSSLPinningModeNone:</div><div class="line">        default:</div><div class="line">            return NO;</div><div class="line">        case AFSSLPinningModeCertificate: &#123;</div><div class="line">            NSMutableArray *pinnedCertificates = [NSMutableArray array];</div><div class="line">            for (NSData *certificateData in self.pinnedCertificates) &#123;</div><div class="line">                [pinnedCertificates addObject:(__bridge_transfer id)SecCertificateCreateWithData(NULL, (__bridge CFDataRef)certificateData)];</div><div class="line">            &#125;</div><div class="line">            SecTrustSetAnchorCertificates(serverTrust, (__bridge CFArrayRef)pinnedCertificates);</div><div class="line"></div><div class="line">            if (!AFServerTrustIsValid(serverTrust)) &#123;</div><div class="line">                return NO;</div><div class="line">            &#125;</div><div class="line"></div><div class="line">            // obtain the chain after being validated, which *should* contain the pinned certificate in the last position (if it&apos;s the Root CA)</div><div class="line">            NSArray *serverCertificates = AFCertificateTrustChainForServerTrust(serverTrust);</div><div class="line">            </div><div class="line">            for (NSData *trustChainCertificate in [serverCertificates reverseObjectEnumerator]) &#123;</div><div class="line">                if ([self.pinnedCertificates containsObject:trustChainCertificate]) &#123;</div><div class="line">                    return YES;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            return NO;</div><div class="line">        &#125;</div><div class="line">        case AFSSLPinningModePublicKey: &#123;</div><div class="line">            NSUInteger trustedPublicKeyCount = 0;</div><div class="line">            NSArray *publicKeys = AFPublicKeyTrustChainForServerTrust(serverTrust);</div><div class="line"></div><div class="line">            for (id trustChainPublicKey in publicKeys) &#123;</div><div class="line">                for (id pinnedPublicKey in self.pinnedPublicKeys) &#123;</div><div class="line">                    if (AFSecKeyIsEqualToKey((__bridge SecKeyRef)trustChainPublicKey, (__bridge SecKeyRef)pinnedPublicKey)) &#123;</div><div class="line">                        trustedPublicKeyCount += 1;</div><div class="line">                    &#125;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            return trustedPublicKeyCount &gt; 0;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return NO;</div><div class="line">&#125;</div><div class="line"></div><div class="line">static BOOL AFServerTrustIsValid(SecTrustRef serverTrust) &#123;</div><div class="line">    BOOL isValid = NO;</div><div class="line">    SecTrustResultType result;</div><div class="line">    __Require_noErr_Quiet(SecTrustEvaluate(serverTrust, &amp;result), _out);</div><div class="line"></div><div class="line">    isValid = (result == kSecTrustResultUnspecified || result == kSecTrustResultProceed);</div><div class="line"></div><div class="line">_out:</div><div class="line">    return isValid;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œé‡ç‚¹çœ‹ä¸€ä¸‹self.allowInvalidCertificatesè¿™ä¸ªå‚æ•°ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå¦‚æœä½¿ç”¨é»˜è®¤çš„éªŒè¯ç­–ç•¥ï¼ŒåŒæ—¶self.allowInvalidCertificates = YESçš„è¯ï¼Œä¼šç›´æ¥è¿”å›YESï¼Œç›¸å½“äºæ²¡æœ‰éªŒè¯ï¼Œæ‰€æœ‰è¿™é‡Œæˆ‘ä»¬ä¸€èˆ¬å°†self.allowInvalidCertificates = NOã€‚self.validatesDomainNameè¿™ä¸ªå‚æ•°é»˜è®¤ä¸ºYESå°±å¯ä»¥äº†ã€‚</p>
<p>éªŒè¯æœåŠ¡å™¨è¯ä¹¦æ˜¯å¦åˆæ³•çš„æ–¹æ³•ä¸ºAFServerTrustIsValidï¼Œè¿™ä¸ªæ–¹æ³•é‡Œé¢å°±æ˜¯è°ƒç”¨çš„ç³»ç»Ÿçš„æ–¹æ³•ã€‚</p>
<p>é‚£è¿™ä¸ªéªŒè¯æ–¹æ³•åˆ°åº•åœ¨å“ªé‡Œè°ƒç”¨çš„å‘¢ï¼Œæˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸‹é¢è¿™ä¸ªä»£ç†ï¼Œåœ¨NSURLSessionManagerä¸­</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">- (void)URLSession:(NSURLSession *)session</div><div class="line">didReceiveChallenge:(NSURLAuthenticationChallenge *)challenge</div><div class="line"> completionHandler:(void (^)(NSURLSessionAuthChallengeDisposition disposition, NSURLCredential *credential))completionHandler</div><div class="line">&#123;</div><div class="line">    NSURLSessionAuthChallengeDisposition disposition = NSURLSessionAuthChallengePerformDefaultHandling;</div><div class="line">    __block NSURLCredential *credential = nil;</div><div class="line"></div><div class="line">    if (self.sessionDidReceiveAuthenticationChallenge) &#123;</div><div class="line">        disposition = self.sessionDidReceiveAuthenticationChallenge(session, challenge, &amp;credential);</div><div class="line">    &#125; else &#123;</div><div class="line">        if ([challenge.protectionSpace.authenticationMethod isEqualToString:NSURLAuthenticationMethodServerTrust]) &#123;</div><div class="line">            if ([self.securityPolicy evaluateServerTrust:challenge.protectionSpace.serverTrust forDomain:challenge.protectionSpace.host]) &#123;</div><div class="line">                credential = [NSURLCredential credentialForTrust:challenge.protectionSpace.serverTrust];</div><div class="line">                if (credential) &#123;</div><div class="line">                    disposition = NSURLSessionAuthChallengeUseCredential;</div><div class="line">                &#125; else &#123;</div><div class="line">                    disposition = NSURLSessionAuthChallengePerformDefaultHandling;</div><div class="line">                &#125;</div><div class="line">            &#125; else &#123;</div><div class="line">                disposition = NSURLSessionAuthChallengeCancelAuthenticationChallenge;</div><div class="line">            &#125;</div><div class="line">        &#125; else &#123;</div><div class="line">            disposition = NSURLSessionAuthChallengePerformDefaultHandling;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line">    if (completionHandler) &#123;</div><div class="line">        completionHandler(disposition, credential);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>æ‰€æœ‰çš„httpsè¯·æ±‚éƒ½ä¼šå…ˆè¿›è¿™ä¸ªä»£ç†ï¼Œè¿™ä¸ªchallenge.protectionSpaceå¯¹è±¡ä¸­å°±æ˜¯æœåŠ¡å™¨å‘è¿‡æ¥çš„éœ€è¦å®¢æˆ·ç«¯éªŒè¯çš„è¯ä¹¦ï¼ŒåŸŸåç­‰ç›¸å…³é‡è¦ä¿¡æ¯ï¼Œç„¶åafè°ƒç”¨evaluateServerTrustè¿™ä¸ªæ–¹æ³•å¯¹ç›¸å…³ä¿¡æ¯è¿›è¡ŒéªŒè¯ã€‚</p>
<h3 id="å®æˆ˜ï¼Œç®€å•çš„äºŒæ¬¡å°è£…"><a href="#å®æˆ˜ï¼Œç®€å•çš„äºŒæ¬¡å°è£…" class="headerlink" title="å®æˆ˜ï¼Œç®€å•çš„äºŒæ¬¡å°è£…"></a>å®æˆ˜ï¼Œç®€å•çš„äºŒæ¬¡å°è£…</h3><p>æˆ‘è¿™è¾¹ä½¿ç”¨ä¸€ä¸ªå•ä¾‹æ¥ç®¡ç†AFHTTPSessionManager,åœ¨initæ–¹æ³•ä¸­ï¼Œè®¾ç½®ç›¸å…³delegateå¯¹åº”çš„block.è¿™é‡Œè®¾ç½®blockä¸»è¦æ˜¯æ»¡è¶³æˆ‘éœ€è¦åœ¨å¼€å§‹è·å–åˆ°éŸ³é¢‘æ•°æ®çš„æ—¶å€™å°±å¯¹æ•°æ®è¿›è¡Œå¤„ç†ï¼Œä¸éœ€è¦ç­‰åˆ°æ•´ä¸ªè¯·æ±‚å®Œæˆå†å¤„ç†æ•°æ®çš„éœ€æ±‚ã€‚å¦‚æœéœ€è¦å…¶ä»–delegateçš„ä¿¡æ¯ï¼Œæ·»åŠ ç›¸åº”çš„blockå³å¯ã€‚</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line">+ (instancetype)shareInstance&#123;</div><div class="line">    static LLYHttpSessionManager *_llyHttpSessionManager = nil;</div><div class="line">    static dispatch_once_t onceToken;</div><div class="line">    dispatch_once(&amp;onceToken, ^&#123;</div><div class="line">        _llyHttpSessionManager = [[LLYHttpSessionManager alloc]init];</div><div class="line">    &#125;);</div><div class="line">    return _llyHttpSessionManager;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (instancetype)init&#123;</div><div class="line">    </div><div class="line">    self = [super init];</div><div class="line">    if (self) &#123;</div><div class="line">        </div><div class="line">        _httpSessionManager = [[AFHTTPSessionManager alloc]initWithSessionConfiguration:[NSURLSessionConfiguration defaultSessionConfiguration]];</div><div class="line">        _httpSessionManager.securityPolicy = [AFSecurityPolicy defaultPolicy];</div><div class="line">//        [_httpSessionManager.requestSerializer setValue:[self generateXUserAgent] forHTTPHeaderField:@&quot;User-Agent&quot;];</div><div class="line">//        [_httpSessionManager.requestSerializer setValue:[self generateClientCookie] forHTTPHeaderField:@&quot;Cookie&quot;];</div><div class="line">        </div><div class="line">        __weak __typeof(self)weakSelf = self;</div><div class="line">        </div><div class="line">        [_httpSessionManager setDataTaskDidReceiveResponseBlock:^NSURLSessionResponseDisposition(NSURLSession * _Nonnull session, NSURLSessionDataTask * _Nonnull dataTask, NSURLResponse * _Nonnull response) &#123;</div><div class="line">            if (weakSelf.didReceiveResponseBlock) &#123;</div><div class="line">                weakSelf.didReceiveResponseBlock(session, dataTask, response);</div><div class="line">            &#125;</div><div class="line">            return NSURLSessionResponseAllow;</div><div class="line">        &#125;];</div><div class="line">        </div><div class="line">        [_httpSessionManager setDataTaskDidReceiveDataBlock:^(NSURLSession * _Nonnull session, NSURLSessionDataTask * _Nonnull dataTask, NSData * _Nonnull data) &#123;</div><div class="line">            if (weakSelf.didReceiveDataBlock) &#123;</div><div class="line">                weakSelf.didReceiveDataBlock(session, dataTask, data);</div><div class="line">            &#125;</div><div class="line">        &#125;];</div><div class="line">        </div><div class="line">        //é»˜è®¤json</div><div class="line">        self.fileType = LLYHttpFileType_JSON;</div><div class="line">    &#125;</div><div class="line">    return self;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å› ä¸ºæˆ‘è¿™è¾¹éœ€è¦è¯·æ±‚éŸ³è§†é¢‘çš„æ•°æ®ï¼Œafæä¾›çš„å‡ ç§responeseé»˜è®¤æ˜¯ä¸æ”¯æŒéŸ³è§†é¢‘æ ¼å¼çš„ï¼Œæ‰€æœ‰æˆ‘å°è£…äº†å‡ ç§æ–‡ä»¶typeï¼Œæ¯ç§typeå¯¹åº”ä¸åŒçš„responese</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div></pre></td><td class="code"><pre><div class="line">typedef NS_ENUM(NSUInteger, LLYHttpFileType) &#123;</div><div class="line">    LLYHttpFileType_JSON = 0,</div><div class="line">    LLYHttpFileType_IMAGE,</div><div class="line">    LLYHttpFileType_AUDIO,</div><div class="line">    LLYHttpFileType_VIDEO</div><div class="line">&#125;;</div><div class="line"></div><div class="line">- (void)setResponseSerializer:(LLYHttpFileType)fileType&#123;</div><div class="line">    </div><div class="line">    switch (fileType) &#123;</div><div class="line">        case LLYHttpFileType_JSON:&#123;</div><div class="line">            _httpSessionManager.responseSerializer = [AFJSONResponseSerializer serializer];</div><div class="line">        &#125;</div><div class="line">            break;</div><div class="line">        case LLYHttpFileType_IMAGE:</div><div class="line">        &#123;</div><div class="line">            _httpSessionManager.responseSerializer = [AFImageResponseSerializer serializer];</div><div class="line">        &#125;</div><div class="line">            break;</div><div class="line">        case LLYHttpFileType_AUDIO:&#123;</div><div class="line">            _httpSessionManager.responseSerializer = [AFHTTPResponseSerializer serializer];</div><div class="line">            _httpSessionManager.responseSerializer.acceptableContentTypes = [NSSet setWithObjects:@&quot;audio/mpeg&quot;,nil];</div><div class="line">        &#125;</div><div class="line">            break;</div><div class="line">        case LLYHttpFileType_VIDEO:&#123;</div><div class="line">            _httpSessionManager.responseSerializer = [AFHTTPResponseSerializer serializer];</div><div class="line">            _httpSessionManager.responseSerializer.acceptableContentTypes = [NSSet setWithObjects:@&quot;video/mp4&quot;,@&quot;video/mpeg&quot;,nil];</div><div class="line">        &#125;</div><div class="line">            break;</div><div class="line">        default:</div><div class="line">        &#123;</div><div class="line">            _httpSessionManager.responseSerializer = [AFHTTPResponseSerializer serializer];</div><div class="line">        &#125;</div><div class="line">            break;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ç„¶åæä¾›äº†2ä¸ªblockï¼Œåˆ†åˆ«æ˜¯didReceiveResponseBlockå’ŒdidReceiveDataBlockï¼Œå¦‚æœéœ€è¦æ‹¿åˆ°è¯·æ±‚è¿‡ç¨‹ä¸­çš„ç›¸å…³æ•°æ®å’Œä¿¡æ¯ï¼Œç›´æ¥å®ç°è¿™2ä¸ªblockå°±okäº†.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">@property (nonatomic, copy) DidReceiveResponseBlock didReceiveResponseBlock;</div><div class="line">@property (nonatomic, copy) DidReceiveDataBlock didReceiveDataBlock;</div></pre></td></tr></table></figure>
<p>é’ˆå¯¹ä¸åŒçš„æ•°æ®ç±»å‹ï¼Œæˆ‘è¿™è¾¹æä¾›äº†ç›¸åº”çš„taskçš„åˆ›å»ºæ–¹æ³•ï¼Œç„¶åè¿˜æä¾›äº†ä¸€ä¸ªæ€»çš„åˆ›å»ºtaskçš„æ–¹æ³•å’Œä¸€ä¸ªä¸‹è½½æ–¹æ³•</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">- (nullable NSURLSessionTask *)requestJSONWithMethod:(LLYHttpMethod)method</div><div class="line">                                       urlString:(nullable NSString *)URLString</div><div class="line">                                      parameters:(nullable id)parameters</div><div class="line">                                        progress:(nullable void (^)(NSProgress * _Nullable downloadProgress))downloadProgress</div><div class="line">                                         success:(nullable void (^)(NSURLSessionDataTask * _Nullable task, id _Nullable responseObject))success</div><div class="line">                                             failure:(nullable void (^)(NSURLSessionDataTask * _Nullable task, NSError * _Nullable error))failure;</div><div class="line"></div><div class="line">- (nullable NSURLSessionTask *)requestIMAGEWithMethod:(LLYHttpMethod)method</div><div class="line">                                           urlString:(nullable NSString *)URLString</div><div class="line">                                          parameters:(nullable id)parameters</div><div class="line">                                            progress:(nullable void (^)(NSProgress * _Nullable downloadProgress))downloadProgress</div><div class="line">                                             success:(nullable void (^)(NSURLSessionDataTask * _Nullable task, id _Nullable responseObject))success</div><div class="line">                                             failure:(nullable void (^)(NSURLSessionDataTask * _Nullable task, NSError * _Nullable error))failure;</div><div class="line"></div><div class="line">- (nullable NSURLSessionTask *)requestAUDIOWithMethod:(LLYHttpMethod)method</div><div class="line">                                            urlString:(nullable NSString *)URLString</div><div class="line">                                           parameters:(nullable id)parameters</div><div class="line">                                             progress:(nullable void (^)(NSProgress * _Nullable downloadProgress))downloadProgress</div><div class="line">                                              success:(nullable void (^)(NSURLSessionDataTask * _Nullable task, id _Nullable responseObject))success</div><div class="line">                                              failure:(nullable void (^)(NSURLSessionDataTask * _Nullable task, NSError * _Nullable error))failure;</div><div class="line"></div><div class="line">- (nullable NSURLSessionTask *)requestVIDEOWithMethod:(LLYHttpMethod)method</div><div class="line">                                            urlString:(nullable NSString *)URLString</div><div class="line">                                           parameters:(nullable id)parameters</div><div class="line">                                             progress:(nullable void (^)(NSProgress * _Nullable downloadProgress))downloadProgress</div><div class="line">                                              success:(nullable void (^)(NSURLSessionDataTask * _Nullable task, id _Nullable responseObject))success</div><div class="line">                                              failure:(nullable void (^)(NSURLSessionDataTask * _Nullable task, NSError * _Nullable error))failure;</div><div class="line"></div><div class="line"></div><div class="line">- (nullable NSURLSessionTask *)requestWithMethod:(LLYHttpMethod)method</div><div class="line">                                        fileType:(LLYHttpFileType)fileType</div><div class="line">                              urlString:(nullable NSString *)URLString</div><div class="line">                             parameters:(nullable id)parameters</div><div class="line">                               progress:(nullable void (^)(NSProgress * _Nullable downloadProgress))downloadProgress</div><div class="line">                                success:(nullable void (^)(NSURLSessionDataTask * _Nullable task, id _Nullable responseObject))success</div><div class="line">                                failure:(nullable void (^)(NSURLSessionDataTask * _Nullable task, NSError * _Nullable error))failure</div><div class="line">;</div><div class="line"></div><div class="line">- (nullable NSURLSessionDownloadTask *)downloadWithUrl:(nullable NSString *)urlString</div><div class="line">                                     progress:(nullable void (^)(NSProgress * _Nullable downloadProgress))downloadProgressBlock</div><div class="line">                                  destination:(nullable NSURL * _Nullable(^)(NSURL * _Nullable targetPath, NSURLResponse * _Nullable response))destination</div><div class="line">                            completionHandler:(nullable void (^)(NSURLResponse * _Nullable response, NSURL * _Nullable filePath, NSError * _Nullable error))completionHandler;</div></pre></td></tr></table></figure>
<p>å®ç°éƒ¨åˆ†å°±æ¯”è¾ƒç®€å•äº†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div></pre></td><td class="code"><pre><div class="line">- (nullable NSURLSessionTask *)requestWithMethod:(LLYHttpMethod)method</div><div class="line">                                        fileType:(LLYHttpFileType)fileType</div><div class="line">                                       urlString:(NSString *)URLString</div><div class="line">                                      parameters:(nullable id)parameters</div><div class="line">                                        progress:(nullable void (^)(NSProgress *downloadProgress))downloadProgress</div><div class="line">                                         success:(nullable void (^)(NSURLSessionDataTask *task, id _Nullable responseObject))success</div><div class="line">                                         failure:(nullable void (^)(NSURLSessionDataTask * _Nullable task, NSError *error))failure</div><div class="line">&#123;</div><div class="line">    </div><div class="line">    self.fileType = fileType;</div><div class="line">    </div><div class="line">    NSURLSessionTask *task = nil;</div><div class="line">    </div><div class="line">    switch (method) &#123;</div><div class="line">        case LLYHttpMethod_GET:</div><div class="line">        &#123;</div><div class="line">            task = [_httpSessionManager GET:URLString parameters:parameters progress:downloadProgress success:success failure:failure];</div><div class="line">        &#125;</div><div class="line">            break;</div><div class="line">            </div><div class="line">        case LLYHttpMethod_POST:</div><div class="line">        &#123;</div><div class="line">            task = [_httpSessionManager POST:URLString parameters:parameters progress:downloadProgress success:success failure:failure];</div><div class="line">        &#125;</div><div class="line">            break;</div><div class="line">            </div><div class="line">        case LLYHttpMethod_HEAD:</div><div class="line">        &#123;</div><div class="line">            task = [_httpSessionManager HEAD:URLString parameters:parameters success:^(NSURLSessionDataTask * _Nonnull task) &#123;</div><div class="line">                if (success) &#123;</div><div class="line">                    success(task,nil);</div><div class="line">                &#125;</div><div class="line">            &#125; failure:failure];</div><div class="line">        &#125;</div><div class="line">            break;</div><div class="line">            </div><div class="line">        default:</div><div class="line">            break;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return task;</div><div class="line">&#125;</div><div class="line"></div><div class="line">- (NSURLSessionDownloadTask *)downloadWithUrl:(NSString *)urlString</div><div class="line">                                     progress:(nullable void (^)(NSProgress *downloadProgress))downloadProgressBlock</div><div class="line">                                  destination:(nullable NSURL * (^)(NSURL *targetPath, NSURLResponse *response))destination</div><div class="line">                            completionHandler:(nullable void (^)(NSURLResponse *response, NSURL * _Nullable filePath, NSError * _Nullable error))completionHandler&#123;</div><div class="line">    NSURLSessionDownloadTask *task = nil;</div><div class="line">    </div><div class="line">    NSMutableURLRequest *request = [NSMutableURLRequest requestWithURL:[NSURL URLWithString:urlString]];</div><div class="line">    </div><div class="line">    task = [_httpSessionManager downloadTaskWithRequest:request progress:downloadProgressBlock destination:destination completionHandler:completionHandler];</div><div class="line">    </div><div class="line">    [task resume];</div><div class="line">    </div><div class="line">    return task;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p><a href="https://github.com/lilingyu0620/LLYAFNetworking.git" target="_blank" rel="noopener">æˆ‘çš„demo</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/15/ä½¿ç”¨FFMPEGè§£ç ä¹‹-éŸ³é¢‘è§£ç /" itemprop="url">
                  ä½¿ç”¨FFMPEGè§£ç ä¹‹--éŸ³é¢‘è§£ç 
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2018-05-15T11:15:41+08:00" content="2018-05-15">
              2018-05-15
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/05/15/ä½¿ç”¨FFMPEGè§£ç ä¹‹-éŸ³é¢‘è§£ç /#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/05/15/ä½¿ç”¨FFMPEGè§£ç ä¹‹-éŸ³é¢‘è§£ç /" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>è¿™å‡ å¤©ä¸€ç›´åœ¨å†™ä½¿ç”¨ffmpegå®Œæˆä¸€ä¸ªè§†é¢‘æ’­æ”¾å™¨çš„demo,å› ä¸ºå¯¹éŸ³é¢‘è¿™ä¸€å—æ¯”è¾ƒç†Ÿæ‚‰ï¼Œæ‰€ä»¥å…ˆä»éŸ³é¢‘è§£ç å¼€å§‹ä¸‹æ‰‹ï¼Œä¹Ÿç†Ÿæ‚‰ä¸€ä¸‹ffmpegçš„ä½¿ç”¨æµç¨‹ã€‚éŸ³é¢‘è§£ç è¿™å—å·²ç»å®Œæˆäº†ï¼Œæ‰€ä»¥è¿™é‡Œå…ˆç®€å•æ€»ç»“ä¸€ä¸‹æ•´ä¸ªéŸ³é¢‘è§£ç çš„æµç¨‹ã€‚è¿™é‡Œåªè¯´å¤§æ¦‚æµç¨‹ï¼Œå…·ä½“å®ç°ç»†èŠ‚å‚è€ƒä¸‹é¢çš„demoå°±å¯ä»¥ã€‚</p>
<h4 id="1-æ³¨å†Œffmpeg"><a href="#1-æ³¨å†Œffmpeg" class="headerlink" title="1.æ³¨å†Œffmpeg"></a>1.æ³¨å†Œffmpeg</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">av_register_all()</div></pre></td></tr></table></figure>
<h4 id="2-åˆå§‹åŒ–AVFormatContext"><a href="#2-åˆå§‹åŒ–AVFormatContext" class="headerlink" title="2.åˆå§‹åŒ–AVFormatContext"></a>2.åˆå§‹åŒ–AVFormatContext</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">AVFormatContext *formatCtx = avformat_alloc_context();</div></pre></td></tr></table></figure>
<h4 id="3-å¯ä»¥æ³¨å†Œä¸€ä¸ªæ‰“æ–­å›è°ƒ"><a href="#3-å¯ä»¥æ³¨å†Œä¸€ä¸ªæ‰“æ–­å›è°ƒ" class="headerlink" title="3.å¯ä»¥æ³¨å†Œä¸€ä¸ªæ‰“æ–­å›è°ƒ"></a>3.å¯ä»¥æ³¨å†Œä¸€ä¸ªæ‰“æ–­å›è°ƒ</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">AVIOInterruptCB int_cb = &#123;interrupt_callback,(__bridge void *)self&#125;;</div><div class="line">    formatCtx-&gt;interrupt_callback = int_cb;</div></pre></td></tr></table></figure>
<p>å…¶ä¸­ interrupt_callback æ˜¯ä¸€ä¸ªå‡½æ•°æŒ‡é’ˆ </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">static int interrupt_callback(void *ctx)&#123;</div><div class="line">    if (!ctx) &#123;</div><div class="line">        return 0;</div><div class="line">    &#125;</div><div class="line">    __unsafe_unretained LLYDecoder *decoder = (__bridge LLYDecoder *)ctx;</div><div class="line">    const BOOL bRet = [decoder detectInterrupted];</div><div class="line">    if (bRet) &#123;</div><div class="line">        NSLog(@&quot;DEBUG: INTERRUPT_CALLBACK!&quot;);</div><div class="line">    &#125;</div><div class="line">    return bRet;</div><div class="line">&#125;</div><div class="line"></div><div class="line">//æ‰“æ–­çŠ¶æ€</div><div class="line">- (BOOL)detectInterrupted&#123;</div><div class="line">    //æ‰“æ–­è¶…æ—¶</div><div class="line">    if ([[NSDate date] timeIntervalSince1970] - _readLastestFrameTime &gt; _subscribeTimeOutTimeInSecs) &#123;</div><div class="line">        return YES;</div><div class="line">    &#125;</div><div class="line">    return _interrupted;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å³ä½¿è¿”å›ä¸€ä¸ªæ˜¯å¦è¢«æ‰“æ–­çš„çŠ¶æ€ã€‚</p>
<h4 id="4-æ‰“å¼€æµåœ°å€"><a href="#4-æ‰“å¼€æµåœ°å€" class="headerlink" title="4.æ‰“å¼€æµåœ°å€"></a>4.æ‰“å¼€æµåœ°å€</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">- (int)openInputWithFormatCtx:(AVFormatContext **)formatCtx path:(NSString *)path parameter:(NSDictionary *)parameters&#123;</div><div class="line">    const char *inputURL = [path cStringUsingEncoding:NSUTF8StringEncoding];</div><div class="line">    AVDictionary *options = NULL;</div><div class="line">    //TCURLåº”è¯¥ä¸æµçš„CDNç›¸å…³ å¦‚æœåŸå§‹çš„reqä¸­æœ‰tcUrlï¼Œå°±ä½¿ç”¨åŸå§‹çš„</div><div class="line">    NSString *rtmpTCURLStr = parameters[RTMP_TCURL_KEY];</div><div class="line">    if (rtmpTCURLStr.length &gt; 0) &#123;</div><div class="line">        const char *rtmpTcURL = [rtmpTCURLStr cStringUsingEncoding:NSUTF8StringEncoding];</div><div class="line">        av_dict_set(&amp;options, &quot;rtmp_tcurl&quot;, rtmpTcURL, 0);</div><div class="line">    &#125;</div><div class="line">    return avformat_open_input(formatCtx, inputURL, NULL, &amp;options);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿”å›ä¸€ä¸ªæ˜¯å¦æ‰“å¼€æˆåŠŸçš„çŠ¶æ€ã€‚0è¡¨ç¤ºæˆåŠŸ</p>
<h4 id="5-è®¾ç½®è§£æå‚æ•°probesize-amp-max-analyze-duration"><a href="#5-è®¾ç½®è§£æå‚æ•°probesize-amp-max-analyze-duration" class="headerlink" title="5.è®¾ç½®è§£æå‚æ•°probesize &amp; max_analyze_duration"></a>5.è®¾ç½®è§£æå‚æ•°probesize &amp; max_analyze_duration</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line">//ä¸ªäººç†è§£æ˜¯å¼€å§‹è¯»å–æ•°æ®çš„å»¶æ—¶å’Œç¼“å­˜ç©ºé—´ï¼ˆé»˜è®¤5Mï¼‰</div><div class="line">- (void)initAnalyzeDurationAndProbeSize:(AVFormatContext *)formatCtx parameter:(NSDictionary *)parameters&#123;</div><div class="line">    float probeSize = [parameters[PROBE_SIZE] floatValue];</div><div class="line">    formatCtx-&gt;probesize = probeSize ?: 50 * 1024;</div><div class="line">    NSArray *durations = parameters[MAX_ANALYZE_DURATION_ARRAY];</div><div class="line">    if (durations &amp;&amp; durations.count &gt; _connectionRetry) &#123;</div><div class="line">        formatCtx-&gt;max_analyze_duration = [durations[_connectionRetry] floatValue];</div><div class="line">    &#125;</div><div class="line">    else&#123;</div><div class="line">        //pow(x,y) xçš„yæ¬¡æ–¹</div><div class="line">        float multiplier = 0.5 + (double)pow(2.0, (double)_connectionRetry) * 0.25;</div><div class="line">        formatCtx-&gt;max_analyze_duration = multiplier;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //å¸§ç‡</div><div class="line">    BOOL fpsProbeSizeConfiged = [parameters[FPS_PROBE_SIZE_CONFIGURED] floatValue];</div><div class="line">    if (fpsProbeSizeConfiged) &#123;</div><div class="line">        formatCtx-&gt;fps_probe_size = 3;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="6-è·å–éŸ³è§†é¢‘ä¿¡æ¯"><a href="#6-è·å–éŸ³è§†é¢‘ä¿¡æ¯" class="headerlink" title="6.è·å–éŸ³è§†é¢‘ä¿¡æ¯"></a>6.è·å–éŸ³è§†é¢‘ä¿¡æ¯</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">int findStreamErrorCode = 0;</div><div class="line">double startFindStreamTimeMills = CFAbsoluteTimeGetCurrent() * 1000;</div><div class="line">if ((findStreamErrorCode = avformat_find_stream_info(formatCtx, NULL)) &lt; 0) &#123;</div><div class="line">    avformat_close_input(&amp;formatCtx);</div><div class="line">    avformat_free_context(formatCtx);</div><div class="line">    NSLog(@&quot;Video decoder find stream info failed... find stream ErrCode is %s&quot;, av_err2str(findStreamErrorCode));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è·å–çš„ä¿¡æ¯éƒ½åœ¨formatCtxè¿™ä¸ªå‚æ•°é‡Œå­˜ç€ï¼Œåé¢å¾ˆå¤šåœ°æ–¹è¦ç”¨ã€‚</p>
<h4 id="7-è·å–æµæ•°æ®çš„ç´¢å¼•æ•°ç»„"><a href="#7-è·å–æµæ•°æ®çš„ç´¢å¼•æ•°ç»„" class="headerlink" title="7.è·å–æµæ•°æ®çš„ç´¢å¼•æ•°ç»„"></a>7.è·å–æµæ•°æ®çš„ç´¢å¼•æ•°ç»„</h4><p>é€šè¿‡æµçš„ç±»å‹è·å–æµçš„ç´¢å¼•ï¼Œæœ‰æ—¶å€™å¯èƒ½éŸ³é¢‘æˆ–è€…è§†é¢‘éƒ½æœ‰å¥½å‡ è·¯æµæ•°æ®</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">//è·å–æµæ•°æ®çš„ç´¢å¼•</div><div class="line">static NSArray *collectionStreams(AVFormatContext *formatCtx,enum AVMediaType codecType)&#123;</div><div class="line">    NSMutableArray *ma = [NSMutableArray array];</div><div class="line">    for (int i = 0; i &lt; formatCtx-&gt;nb_streams; i++) &#123;</div><div class="line">        if (codecType == formatCtx-&gt;streams[i]-&gt;codec-&gt;codec_type) &#123;</div><div class="line">            [ma addObject:@(i)];</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    return ma;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="8-é€šè¿‡æµçš„ç´¢å¼•ï¼Œè·å–æ¯ä¸€è·¯æµçš„AVCodecContext-amp-AVCodec"><a href="#8-é€šè¿‡æµçš„ç´¢å¼•ï¼Œè·å–æ¯ä¸€è·¯æµçš„AVCodecContext-amp-AVCodec" class="headerlink" title="8.é€šè¿‡æµçš„ç´¢å¼•ï¼Œè·å–æ¯ä¸€è·¯æµçš„AVCodecContext &amp; AVCodec"></a>8.é€šè¿‡æµçš„ç´¢å¼•ï¼Œè·å–æ¯ä¸€è·¯æµçš„AVCodecContext &amp; AVCodec</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">AVCodecContext *codecCtx = _formatCtx-&gt;streams[streamIndex]-&gt;codec;</div><div class="line">//è·å–è¯¥streamå¯¹åº”çš„è§£ç å™¨</div><div class="line">AVCodec *codec = avcodec_find_decoder(codecCtx-&gt;codec_id);</div><div class="line">if(!codec)&#123;</div><div class="line">    NSLog(@&quot;Find Audio Decoder Failed codec_id %d CODEC_ID_AAC is %d&quot;, codecCtx-&gt;codec_id, AV_CODEC_ID_AAC);</div><div class="line">    return NO;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="9-æ‰“å¼€è§£ç å™¨"><a href="#9-æ‰“å¼€è§£ç å™¨" class="headerlink" title="9.æ‰“å¼€è§£ç å™¨"></a>9.æ‰“å¼€è§£ç å™¨</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">int openCodecErrorCode = 0;</div><div class="line">if ((openCodecErrorCode = avcodec_open2(codecCtx, codec, NULL)) &lt; 0) &#123;</div><div class="line">    NSLog(@&quot;open Audio Codec Failed openCodecErr is %s&quot;, av_err2str(openCodecErrorCode));</div><div class="line">    return NO;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="10-å¦‚æœä¸æ”¯æŒå½“å‰æµçš„é‡‡æ ·æ ¼å¼ï¼Œéœ€è¦åšä¸€ä¸‹é‡æ–°é‡‡æ ·"><a href="#10-å¦‚æœä¸æ”¯æŒå½“å‰æµçš„é‡‡æ ·æ ¼å¼ï¼Œéœ€è¦åšä¸€ä¸‹é‡æ–°é‡‡æ ·" class="headerlink" title="10.å¦‚æœä¸æ”¯æŒå½“å‰æµçš„é‡‡æ ·æ ¼å¼ï¼Œéœ€è¦åšä¸€ä¸‹é‡æ–°é‡‡æ ·"></a>10.å¦‚æœä¸æ”¯æŒå½“å‰æµçš„é‡‡æ ·æ ¼å¼ï¼Œéœ€è¦åšä¸€ä¸‹é‡æ–°é‡‡æ ·</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">//æ˜¯å¦éœ€è¦é‡é‡‡æ ·</div><div class="line">SwrContext *swrContext = NULL;</div><div class="line">if (![self audioCodecIsSupported:codecCtx]) &#123;</div><div class="line">    </div><div class="line">    NSLog(@&quot;because of audio Codec Is Not Supported so we will init swresampler...&quot;);</div><div class="line">    /**</div><div class="line">     * åˆå§‹åŒ–resampler</div><div class="line">     * @param s               Swr context, can be NULL</div><div class="line">     * @param out_ch_layout   output channel layout (AV_CH_LAYOUT_*)</div><div class="line">     * @param out_sample_fmt  output sample format (AV_SAMPLE_FMT_*).</div><div class="line">     * @param out_sample_rate output sample rate (frequency in Hz)</div><div class="line">     * @param in_ch_layout    input channel layout (AV_CH_LAYOUT_*)</div><div class="line">     * @param in_sample_fmt   input sample format (AV_SAMPLE_FMT_*).</div><div class="line">     * @param in_sample_rate  input sample rate (frequency in Hz)</div><div class="line">     * @param log_offset      logging level offset</div><div class="line">     * @param log_ctx         parent logging context, can be NULL</div><div class="line">     */</div><div class="line">    swrContext = swr_alloc_set_opts(NULL, av_get_default_channel_layout(codecCtx-&gt;channels), AV_SAMPLE_FMT_S16, codecCtx-&gt;sample_rate, av_get_default_channel_layout(codecCtx-&gt;channels), codecCtx-&gt;sample_fmt, codecCtx-&gt;sample_rate, 0, NULL);</div><div class="line">    if (!swrContext || swr_init(swrContext)) &#123;</div><div class="line">        if (swrContext)</div><div class="line">            swr_free(&amp;swrContext);</div><div class="line">        avcodec_close(codecCtx);</div><div class="line">        NSLog(@&quot;init resampler failed...&quot;);</div><div class="line">        return NO;</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">- (BOOL)audioCodecIsSupported:(AVCodecContext *) audioCodecCtx;&#123;</div><div class="line">    if (audioCodecCtx-&gt;sample_fmt == AV_SAMPLE_FMT_S16) &#123;</div><div class="line">        return true;</div><div class="line">    &#125;</div><div class="line">    return false;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="11-åˆå§‹åŒ–ä¸€ä¸ªAVFrame"><a href="#11-åˆå§‹åŒ–ä¸€ä¸ªAVFrame" class="headerlink" title="11.åˆå§‹åŒ–ä¸€ä¸ªAVFrame"></a>11.åˆå§‹åŒ–ä¸€ä¸ªAVFrame</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">_audioFrame = av_frame_alloc();</div><div class="line">if (!_audioFrame) &#123;</div><div class="line">    NSLog(@&quot;Alloc Audio Frame Failed...&quot;);</div><div class="line">    if (swrContext)</div><div class="line">        swr_free(&amp;swrContext);</div><div class="line">    avcodec_close(codecCtx);</div><div class="line">    return NO;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="12-è·å–AVPacket"><a href="#12-è·å–AVPacket" class="headerlink" title="12.è·å–AVPacket"></a>12.è·å–AVPacket</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">AVPacket packet;</div><div class="line">if (av_read_frame(_formatCtx, &amp;packet) &lt; 0) &#123;</div><div class="line">        _isEOF = YES;</div><div class="line">        break;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="13-è·å–AVFrame"><a href="#13-è·å–AVFrame" class="headerlink" title="13.è·å–AVFrame"></a>13.è·å–AVFrame</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">int gotFrame = 0;</div><div class="line">//len =  number of bytes consumed from the input *AVPacket</div><div class="line">int len = avcodec_decode_audio4(_audioCodecCtx, _audioFrame, &amp;gotFrame, &amp;packet);</div><div class="line">if (len &lt; 0) &#123;</div><div class="line">    NSLog(@&quot;decode audio error, skip packet&quot;);</div><div class="line">    break;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="14-å°†AVFrameè½¬ä¸ºè‡ªå®šä¹‰çš„LLYAudioFrame"><a href="#14-å°†AVFrameè½¬ä¸ºè‡ªå®šä¹‰çš„LLYAudioFrame" class="headerlink" title="14.å°†AVFrameè½¬ä¸ºè‡ªå®šä¹‰çš„LLYAudioFrame"></a>14.å°†AVFrameè½¬ä¸ºè‡ªå®šä¹‰çš„LLYAudioFrame</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line">- (LLYAudioFrame *)handleAudioFrame&#123;</div><div class="line">    </div><div class="line">    if (!_audioFrame-&gt;data[0]) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    const NSUInteger numChannels = _audioCodecCtx-&gt;channels;</div><div class="line">    NSInteger numFrames;</div><div class="line">    </div><div class="line">    void *audioData;</div><div class="line">    </div><div class="line">    if (_swrContext) &#123;</div><div class="line">        const NSUInteger ratio = 2;</div><div class="line">        const int bufSize = av_samples_get_buffer_size(NULL, (int)numChannels ,(int)(_audioFrame-&gt;nb_samples * ratio), AV_SAMPLE_FMT_S16, 1);</div><div class="line">        if (!_swrBuffer || _swrBufferSize &lt; bufSize) &#123;</div><div class="line">            _swrBufferSize = bufSize;</div><div class="line">            _swrBuffer = realloc(_swrBuffer, _swrBufferSize);</div><div class="line">        &#125;</div><div class="line">        Byte *outbuf[2] = &#123;_swrBuffer,0&#125;;</div><div class="line">        numFrames = swr_convert(_swrContext, outbuf, (int)(_audioFrame-&gt;nb_samples * ratio), (const uint8_t **)_audioFrame-&gt;data, _audioFrame-&gt;nb_samples);</div><div class="line">        if (numFrames &lt; 0) &#123;</div><div class="line">            NSLog(@&quot;fail resample audio&quot;);</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">        audioData = _swrBuffer;</div><div class="line">    &#125;else&#123;</div><div class="line">        if (_audioCodecCtx-&gt;sample_fmt != AV_SAMPLE_FMT_S16) &#123;</div><div class="line">            NSLog(@&quot;Audio format is invalid&quot;);</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">        audioData = _audioFrame-&gt;data[0];</div><div class="line">        numFrames = _audioFrame-&gt;nb_samples;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    //æ€»å¸§æ•° = ä¸€æ¡ä¿¡é“çš„å¸§æ•°*ä¿¡é“æ•°</div><div class="line">    const NSUInteger numElements = numFrames * numChannels;</div><div class="line">    NSMutableData *pcmData = [NSMutableData dataWithLength:numElements * sizeof(SInt16)];</div><div class="line">    memcpy(pcmData.mutableBytes, audioData, numElements * sizeof(SInt16));</div><div class="line">    LLYAudioFrame *frame = [[LLYAudioFrame alloc]init];</div><div class="line">    frame.position = av_frame_get_best_effort_timestamp(_audioFrame) * _audioTimeBase;</div><div class="line">    frame.duration = av_frame_get_pkt_duration(_audioFrame) * _audioTimeBase;</div><div class="line">    frame.sampleData = pcmData;</div><div class="line">    frame.frameType = LLYFrameType_Audio;</div><div class="line">    </div><div class="line">    return frame;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œåˆ¤æ–­ä¸€ä¸‹å¦‚æœæ˜¯é‡é‡‡æ ·çš„ï¼Œéœ€è¦åšä¸€ä¸ªè½¬æ¢ã€‚</p>
<h3 id="è§†é¢‘è§£ç ï¼ˆè¡¥å……ï¼‰"><a href="#è§†é¢‘è§£ç ï¼ˆè¡¥å……ï¼‰" class="headerlink" title="è§†é¢‘è§£ç ï¼ˆè¡¥å……ï¼‰"></a>è§†é¢‘è§£ç ï¼ˆè¡¥å……ï¼‰</h3><p>è§†é¢‘è§£ç çš„å·¥ä½œä¹Ÿåšå®Œäº†ï¼Œæµç¨‹å’ŒéŸ³é¢‘å¤§åŒå°å¼‚ï¼Œåªæ˜¯åœ¨æœ€åå‡ æ­¥çš„æ—¶å€™ä¼šæœ‰å·®å¼‚</p>
<h4 id="è·å–AVFrame"><a href="#è·å–AVFrame" class="headerlink" title="è·å–AVFrame"></a>è·å–AVFrame</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">int gotFrmae = 0;</div><div class="line">int len = avcodec_decode_video2(_videoCodecCtx, _videoFrame, &amp;gotFrmae, &amp;packet);</div><div class="line">if (len &lt; 0) &#123;</div><div class="line">    NSLog(@&quot;decode video error, skip packet %s&quot;, av_err2str(len));</div><div class="line">    *errorState = 1;</div><div class="line">    break;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œä½¿ç”¨videoçš„è§£ç api.</p>
<h4 id="å°†AVFrameè½¬ä¸ºè‡ªå®šä¹‰çš„LLYVideoFrame"><a href="#å°†AVFrameè½¬ä¸ºè‡ªå®šä¹‰çš„LLYVideoFrame" class="headerlink" title="å°†AVFrameè½¬ä¸ºè‡ªå®šä¹‰çš„LLYVideoFrame"></a>å°†AVFrameè½¬ä¸ºè‡ªå®šä¹‰çš„LLYVideoFrame</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div></pre></td><td class="code"><pre><div class="line">- (LLYVideoFrame *)handleVideoFrame&#123;</div><div class="line">    </div><div class="line">    if (!_videoFrame-&gt;data[0]) &#123;</div><div class="line">        return nil;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    LLYVideoFrame *videoFrame = [[LLYVideoFrame alloc]init];</div><div class="line">    //å°†yuvæ•°æ®å–å‡ºæ¥</div><div class="line">    if (_videoCodecCtx-&gt;pix_fmt == AV_PIX_FMT_YUV420P || _videoCodecCtx-&gt;pix_fmt == AV_PIX_FMT_YUVJ420P) &#123;</div><div class="line">        videoFrame.luma = copyFrameData(_videoFrame-&gt;data[0], _videoFrame-&gt;linesize[0], _videoCodecCtx-&gt;width, _videoCodecCtx-&gt;height);</div><div class="line">        videoFrame.chromaB = copyFrameData(_videoFrame-&gt;data[1], _videoFrame-&gt;linesize[1], _videoCodecCtx-&gt;width/2, _videoCodecCtx-&gt;height/2);</div><div class="line">        videoFrame.chromaR = copyFrameData(_videoFrame-&gt;data[2], _videoFrame-&gt;linesize[2], _videoCodecCtx-&gt;width/2, _videoCodecCtx-&gt;height/2);</div><div class="line">    &#125;else&#123;</div><div class="line">        //ä¸æ˜¯yuvæ ¼å¼å…ˆè¦å°†æ ¼å¼è½¬ä¸ºyuvçš„</div><div class="line">        if (!_swsContext &amp;&amp;</div><div class="line">            ![self setupScaler]) &#123;</div><div class="line">            NSLog(@&quot;fail setup video scaler&quot;);</div><div class="line">            return nil;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        sws_scale(_swsContext,</div><div class="line">                  (const uint8_t **)_videoFrame-&gt;data,</div><div class="line">                  _videoFrame-&gt;linesize,</div><div class="line">                  0,</div><div class="line">                  _videoCodecCtx-&gt;height,</div><div class="line">                  _picture.data,</div><div class="line">                  _picture.linesize);</div><div class="line">        videoFrame.luma = copyFrameData(_picture.data[0], _videoFrame-&gt;linesize[0], _videoCodecCtx-&gt;width, _videoCodecCtx-&gt;height);</div><div class="line">        videoFrame.chromaB = copyFrameData(_picture.data[1], _videoFrame-&gt;linesize[1], _videoCodecCtx-&gt;width/2, _videoCodecCtx-&gt;height/2);</div><div class="line">        videoFrame.chromaR = copyFrameData(_picture.data[2], _videoFrame-&gt;linesize[2], _videoCodecCtx-&gt;width/2, _videoCodecCtx-&gt;height/2);</div><div class="line">    &#125;</div><div class="line">    videoFrame.width = _videoCodecCtx-&gt;width;</div><div class="line">    videoFrame.height = _videoCodecCtx-&gt;height;</div><div class="line">    videoFrame.lineSize = _videoFrame-&gt;linesize[0];</div><div class="line">    videoFrame.frameType = LLYFrameType_Video;</div><div class="line">    videoFrame.position = av_frame_get_best_effort_timestamp(_videoFrame) * _videoTimeBase;</div><div class="line">    const int64_t frameDuration = av_frame_get_pkt_duration(_videoFrame);</div><div class="line">    if (frameDuration) &#123;</div><div class="line">        videoFrame.duration = frameDuration * _videoTimeBase;</div><div class="line">        videoFrame.duration += _videoFrame-&gt;repeat_pict * _videoTimeBase * 0.5;</div><div class="line">    &#125; else &#123;</div><div class="line">        // sometimes, ffmpeg unable to determine a frame duration</div><div class="line">        // as example yuvj420p stream from web camera</div><div class="line">        videoFrame.duration = 1.0 / _fps;</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    return videoFrame;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>è¿™é‡Œè½¬ä¸ºè‡ªå®šä¹‰çš„LLYVideoFrameæ—¶éœ€è¦å°†YUVçš„æ•°æ®éƒ½å–å‡ºæ¥ã€‚</p>
<p>ä¸»è¦æµç¨‹å¤§æ¦‚å°±æ˜¯ä¸Šé¢è¿™äº›äº†ã€‚å½“ç„¶è¿˜æœ‰ä¸€äº›ç»†èŠ‚çš„ä¸œè¥¿ï¼Œè¿™é‡Œæ²¡æœ‰ä¸€ä¸€åˆ—å‡ºæ¥ï¼Œå¯ä»¥ä»demoä¸­å¯»æ‰¾ç­”æ¡ˆã€‚</p>
<p><a href="https://github.com/lilingyu0620/LLYFFMPEGPlayer.git" target="_blank" rel="noopener">LLYFFMPEGPlayer</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2018/05/07/FFMPEGå­¦ä¹ ç¬”è®°/" itemprop="url">
                  FFMPEGå­¦ä¹ ç¬”è®°
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">å‘è¡¨äº</span>
            <time itemprop="dateCreated" datetime="2018-05-07T17:52:01+08:00" content="2018-05-07">
              2018-05-07
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2018/05/07/FFMPEGå­¦ä¹ ç¬”è®°/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2018/05/07/FFMPEGå­¦ä¹ ç¬”è®°/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>æƒ³è¦ä»äº‹éŸ³è§†é¢‘ç›¸å…³çš„å·¥ä½œï¼ŒFFMPEGæ˜¯ç»•ä¸å¼€çš„ä¸€é“åï¼Œå°±åƒå‰ä»–é‡Œé¢çš„å¤§æ¨ªæŒ‰ï¼Œæ—¢ç„¶æˆ‘èƒ½ç»™å¾æœå¤§æ¨ªæŒ‰ï¼Œç›¸ä¿¡æˆ‘ä¹Ÿèƒ½å¾æœä½ ï¼ŒFFMPEGï¼ï¼ï¼</p>
<p>è‡ªå­¦éŸ³è§†é¢‘ç›¸å…³çš„å†…å®¹ä¹Ÿæœ‰ä¸€æ®µæ—¶é—´å•¦ï¼Œæ¯”å¦‚ä¹‹å‰çš„H264,RTMP,FLV,è¿˜æœ‰æœ€è¿‘çš„AudioUintå’ŒAudioQueueï¼Œé€šè¿‡è¿™æ®µæ—¶é—´çš„å­¦ä¹ ï¼Œæˆ‘æ€»ç»“å‡ºæ¥çš„æ–¹æ³•å°±æ˜¯ï¼Œå…ˆå°†ä»–ä»¬çš„æ•°æ®ç»“æ„åˆ†ææ¸…æ¥šï¼Œäº†è§£ä¸»è¦çš„apiï¼Œç„¶åä»ç®€å•çš„apiå¼€å§‹å®è·µã€‚</p>
<p>æ‰€ä»¥æˆ‘ä»¬å…ˆæ¥çœ‹ä¸€ä¸‹FFMPEGçš„ä¸»è¦æ•°æ®ç»“æ„å’Œapiâ€¦</p>
<h3 id="æ•°æ®ç»“æ„"><a href="#æ•°æ®ç»“æ„" class="headerlink" title="æ•°æ®ç»“æ„"></a>æ•°æ®ç»“æ„</h3><h4 id="æ–‡ä»¶è¯»å–ç›¸å…³"><a href="#æ–‡ä»¶è¯»å–ç›¸å…³" class="headerlink" title="æ–‡ä»¶è¯»å–ç›¸å…³"></a>æ–‡ä»¶è¯»å–ç›¸å…³</h4><h5 id="AVIOContext"><a href="#AVIOContext" class="headerlink" title="AVIOContext"></a>AVIOContext</h5><p>AVIOContextæ˜¯FFMPEGç®¡ç†è¾“å…¥è¾“å‡ºæ•°æ®çš„ç»“æ„ä½“</p>
<p>æ¯”è¾ƒé‡è¦çš„å±æ€§ï¼š</p>
<ul>
<li><p>unsigned char *bufferï¼šç¼“å­˜è¯»å–çš„æ•°æ®</p>
</li>
<li><p>int buffer_sizeï¼šç¼“å­˜å¤§å°ï¼ˆé»˜è®¤32768ï¼‰</p>
</li>
<li><p>unsigned char *buf_ptrï¼šå½“å‰æŒ‡é’ˆè¯»å–åˆ°çš„ä½ç½®</p>
</li>
<li><p>unsigned char *buf_endï¼šç¼“å­˜ç»“æŸçš„ä½ç½®</p>
</li>
<li><p>void *opaqueï¼šURLContextç»“æ„ä½“</p>
</li>
</ul>
<h4 id="åè®®ç›¸å…³"><a href="#åè®®ç›¸å…³" class="headerlink" title="åè®®ç›¸å…³"></a>åè®®ç›¸å…³</h4><h5 id="URLContextã€URLProtocol"><a href="#URLContextã€URLProtocol" class="headerlink" title="URLContextã€URLProtocol"></a>URLContextã€URLProtocol</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div></pre></td><td class="code"><pre><div class="line">typedef struct URLContext &#123;  </div><div class="line">    const AVClass *av_class; ///&lt; information for av_log(). Set by url_open().  </div><div class="line">    struct URLProtocol *prot;  </div><div class="line">    int flags;  </div><div class="line">    int is_streamed;  /**&lt; true if streamed (no seek possible), default = false */  </div><div class="line">    int max_packet_size;  /**&lt; if non zero, the stream is packetized with this max packet size */  </div><div class="line">    void *priv_data;  </div><div class="line">    char *filename; /**&lt; specified URL */  </div><div class="line">    int is_connected;  </div><div class="line">    AVIOInterruptCB interrupt_callback;  </div><div class="line">&#125; URLContext;  </div><div class="line"></div><div class="line">typedef struct URLProtocol &#123;  </div><div class="line">    const char *name;  </div><div class="line">    int (*url_open)(URLContext *h, const char *url, int flags);  </div><div class="line">    int (*url_read)(URLContext *h, unsigned char *buf, int size);  </div><div class="line">    int (*url_write)(URLContext *h, const unsigned char *buf, int size);  </div><div class="line">    int64_t (*url_seek)(URLContext *h, int64_t pos, int whence);  </div><div class="line">    int (*url_close)(URLContext *h);  </div><div class="line">    struct URLProtocol *next;  </div><div class="line">    int (*url_read_pause)(URLContext *h, int pause);  </div><div class="line">    int64_t (*url_read_seek)(URLContext *h, int stream_index,  </div><div class="line">        int64_t timestamp, int flags);  </div><div class="line">    int (*url_get_file_handle)(URLContext *h);  </div><div class="line">    int priv_data_size;  </div><div class="line">    const AVClass *priv_data_class;  </div><div class="line">    int flags;  </div><div class="line">    int (*url_check)(URLContext *h, int mask);  </div><div class="line">&#125; URLProtocol;</div></pre></td></tr></table></figure>
<p>URLContextç»“æ„ä½“ä¸­è¿˜æœ‰ä¸€ä¸ªç»“æ„ä½“URLProtocol,æ¯ç§åè®®ï¼ˆrtpï¼Œrtmpï¼Œfileç­‰ï¼‰å¯¹åº”ä¸€ä¸ªURLProtocolã€‚</p>
<h4 id="å°è£…æ ¼å¼ç›¸å…³"><a href="#å°è£…æ ¼å¼ç›¸å…³" class="headerlink" title="å°è£…æ ¼å¼ç›¸å…³"></a>å°è£…æ ¼å¼ç›¸å…³</h4><h5 id="AVFormatContext"><a href="#AVFormatContext" class="headerlink" title="AVFormatContext"></a>AVFormatContext</h5><p>è¿™ä¸ªç»“æ„ä½“æè¿°äº†ä¸€ä¸ªåª’ä½“æ–‡ä»¶æˆ–åª’ä½“æµçš„æ„æˆå’ŒåŸºæœ¬ä¿¡æ¯</p>
<p>åœ¨ä½¿ç”¨FFMPEGè¿›è¡Œå¼€å‘çš„æ—¶å€™ï¼ŒAVFormatContextæ˜¯ä¸€ä¸ªè´¯ç©¿å§‹ç»ˆçš„æ•°æ®ç»“æ„ï¼Œå¾ˆå¤šå‡½æ•°éƒ½è¦ç”¨åˆ°å®ƒä½œä¸ºå‚æ•°ã€‚</p>
<p>çœ‹å‡ ä¸ªä¸»è¦å˜é‡çš„ä½œç”¨:</p>
<ul>
<li><p>struct AVInputFormat *iformatï¼šè¾“å…¥æ•°æ®çš„å°è£…æ ¼å¼</p>
</li>
<li><p>AVIOContext *pbï¼šè¾“å…¥æ•°æ®çš„ç¼“å­˜</p>
</li>
<li><p>unsigned int nb_streamsï¼šè§†éŸ³é¢‘æµçš„ä¸ªæ•°</p>
</li>
<li><p>AVStream **streamsï¼šéŸ³è§†é¢‘æµ</p>
</li>
<li><p>char filename[1024]ï¼šæ–‡ä»¶å</p>
</li>
<li><p>int64_t durationï¼šæ—¶é•¿ï¼ˆå•ä½ï¼šå¾®ç§’usï¼Œè½¬æ¢ä¸ºç§’éœ€è¦é™¤ä»¥1000000ï¼‰</p>
</li>
<li><p>int bit_rateï¼šæ¯”ç‰¹ç‡ï¼ˆå•ä½bpsï¼Œè½¬æ¢ä¸ºkbpséœ€è¦é™¤ä»¥1000ï¼‰</p>
</li>
<li><p>AVDictionary *metadataï¼šå…ƒæ•°æ®</p>
</li>
</ul>
<h5 id="AVInputFormat"><a href="#AVInputFormat" class="headerlink" title="AVInputFormat"></a>AVInputFormat</h5><p>ä½œä¸ºè¾“å…¥å®¹å™¨ï¼ŒåŒ…å«äº†è¾“å…¥æ–‡ä»¶çš„éŸ³è§†é¢‘æµä¿¡æ¯,ç¨‹åºä»è¾“å…¥å®¹å™¨ä»è¯»å‡ºéŸ³è§†é¢‘åŒ…è¿›è¡Œè§£ç å¤„ç†</p>
<h5 id="AVOutputFormat"><a href="#AVOutputFormat" class="headerlink" title="AVOutputFormat"></a>AVOutputFormat</h5><p>ä½œä¸ºè¾“å‡ºå®¹å™¨ï¼Œç¨‹åºæŠŠç¼–ç å¥½çš„éŸ³è§†é¢‘åŒ…å†™å…¥åˆ°è¾“å‡ºå®¹å™¨ä¸­</p>
<h4 id="ç¼–è§£ç ç›¸å…³"><a href="#ç¼–è§£ç ç›¸å…³" class="headerlink" title="ç¼–è§£ç ç›¸å…³"></a>ç¼–è§£ç ç›¸å…³</h4><h5 id="AVCodecContext"><a href="#AVCodecContext" class="headerlink" title="AVCodecContext"></a>AVCodecContext</h5><p>è¿™æ˜¯ä¸€ä¸ªæè¿°ç¼–è§£ç å™¨ä¸Šä¸‹æ–‡çš„æ•°æ®ç»“æ„ï¼ŒåŒ…å«äº†ä¼—å¤šç¼–è§£ç å™¨éœ€è¦çš„å‚æ•°ä¿¡æ¯</p>
<p>çœ‹ä¸€ä¸‹å…³é”®å±æ€§ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">enum AVMediaType codec_typeï¼šç¼–è§£ç å™¨çš„ç±»å‹ï¼ˆè§†é¢‘ï¼ŒéŸ³é¢‘...ï¼‰</div><div class="line"></div><div class="line">struct AVCodec  *codecï¼šé‡‡ç”¨çš„è§£ç å™¨AVCodecï¼ˆH.264,MPEG2...ï¼‰</div><div class="line"></div><div class="line">int bit_rateï¼šå¹³å‡æ¯”ç‰¹ç‡</div><div class="line"></div><div class="line">uint8_t *extradata; int extradata_sizeï¼šé’ˆå¯¹ç‰¹å®šç¼–ç å™¨åŒ…å«çš„é™„åŠ ä¿¡æ¯ï¼ˆä¾‹å¦‚å¯¹äºH.264è§£ç å™¨æ¥è¯´ï¼Œå­˜å‚¨SPSï¼ŒPPSç­‰ï¼‰</div><div class="line"></div><div class="line">AVRational time_baseï¼šæ ¹æ®è¯¥å‚æ•°ï¼Œå¯ä»¥æŠŠPTSè½¬åŒ–ä¸ºå®é™…çš„æ—¶é—´ï¼ˆå•ä½ä¸ºç§’sï¼‰</div><div class="line"></div><div class="line">int width, heightï¼šå¦‚æœæ˜¯è§†é¢‘çš„è¯ï¼Œä»£è¡¨å®½å’Œé«˜</div><div class="line"></div><div class="line">int refsï¼šè¿åŠ¨ä¼°è®¡å‚è€ƒå¸§çš„ä¸ªæ•°ï¼ˆH.264çš„è¯ä¼šæœ‰å¤šå¸§ï¼ŒMPEG2è¿™ç±»çš„ä¸€èˆ¬å°±æ²¡æœ‰äº†ï¼‰</div><div class="line"></div><div class="line">int sample_rateï¼šé‡‡æ ·ç‡ï¼ˆéŸ³é¢‘ï¼‰</div><div class="line"></div><div class="line">int channelsï¼šå£°é“æ•°ï¼ˆéŸ³é¢‘ï¼‰</div><div class="line"></div><div class="line">enum AVSampleFormat sample_fmtï¼šé‡‡æ ·æ ¼å¼</div><div class="line"></div><div class="line">int profileï¼šå‹ï¼ˆH.264é‡Œé¢å°±æœ‰ï¼Œå…¶ä»–ç¼–ç æ ‡å‡†åº”è¯¥ä¹Ÿæœ‰ï¼‰</div><div class="line"></div><div class="line">int levelï¼šçº§ï¼ˆå’Œprofileå·®ä¸å¤ªå¤šï¼‰</div></pre></td></tr></table></figure>
<h5 id="AVCodec"><a href="#AVCodec" class="headerlink" title="AVCodec"></a>AVCodec</h5><p>AVCodecæ˜¯å­˜å‚¨ç¼–è§£ç å™¨ä¿¡æ¯çš„ç»“æ„ä½“ï¼Œæ¯ä¸€ä¸ªç¼–è§£ç å™¨å¯¹åº”ä¸€ä¸ªè¯¥ç»“æ„ä½“ã€‚</p>
<p>ä¸‹é¢è¯´ä¸€ä¸‹æœ€ä¸»è¦çš„å‡ ä¸ªå˜é‡ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">const char *nameï¼šç¼–è§£ç å™¨çš„åå­—ï¼Œæ¯”è¾ƒçŸ­</div><div class="line"></div><div class="line">const char *long_nameï¼šç¼–è§£ç å™¨çš„åå­—ï¼Œå…¨ç§°ï¼Œæ¯”è¾ƒé•¿</div><div class="line"></div><div class="line">enum AVMediaType typeï¼šæŒ‡æ˜äº†ç±»å‹ï¼Œæ˜¯è§†é¢‘ï¼ŒéŸ³é¢‘ï¼Œè¿˜æ˜¯å­—å¹•</div><div class="line"></div><div class="line">enum AVCodecID idï¼šIDï¼Œä¸é‡å¤</div><div class="line"></div><div class="line">const AVRational *supported_frameratesï¼šæ”¯æŒçš„å¸§ç‡ï¼ˆä»…è§†é¢‘ï¼‰</div><div class="line"></div><div class="line">const enum AVPixelFormat *pix_fmtsï¼šæ”¯æŒçš„åƒç´ æ ¼å¼ï¼ˆä»…è§†é¢‘ï¼‰</div><div class="line"></div><div class="line">const int *supported_sampleratesï¼šæ”¯æŒçš„é‡‡æ ·ç‡ï¼ˆä»…éŸ³é¢‘ï¼‰</div><div class="line"></div><div class="line">const enum AVSampleFormat *sample_fmtsï¼šæ”¯æŒçš„é‡‡æ ·æ ¼å¼ï¼ˆä»…éŸ³é¢‘ï¼‰</div><div class="line"></div><div class="line">const uint64_t *channel_layoutsï¼šæ”¯æŒçš„å£°é“æ•°ï¼ˆä»…éŸ³é¢‘ï¼‰</div><div class="line"></div><div class="line">int priv_data_sizeï¼šç§æœ‰æ•°æ®çš„å¤§å°</div></pre></td></tr></table></figure>
<h5 id="AVStream"><a href="#AVStream" class="headerlink" title="AVStream"></a>AVStream</h5><p>AVStreamæ˜¯å­˜å‚¨æ¯ä¸€ä¸ªè§†é¢‘/éŸ³é¢‘æµä¿¡æ¯çš„ç»“æ„ä½“</p>
<p>AVStreamé‡è¦çš„å˜é‡å¦‚ä¸‹æ‰€ç¤ºï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">int indexï¼šæ ‡è¯†è¯¥è§†é¢‘/éŸ³é¢‘æµ</div><div class="line"></div><div class="line">AVCodecContext *codecï¼šæŒ‡å‘è¯¥è§†é¢‘/éŸ³é¢‘æµçš„AVCodecContextï¼ˆå®ƒä»¬æ˜¯ä¸€ä¸€å¯¹åº”çš„å…³ç³»ï¼‰</div><div class="line"></div><div class="line">AVRational time_baseï¼šæ—¶åŸºã€‚é€šè¿‡è¯¥å€¼å¯ä»¥æŠŠPTSï¼ŒDTSè½¬åŒ–ä¸ºçœŸæ­£çš„æ—¶é—´ã€‚FFMPEGå…¶ä»–ç»“æ„ä½“ä¸­ä¹Ÿæœ‰è¿™ä¸ªå­—æ®µï¼Œä½†æ˜¯æ ¹æ®æˆ‘çš„ç»éªŒï¼Œåªæœ‰AVStreamä¸­çš„time_baseæ˜¯å¯ç”¨çš„ã€‚PTS*time_base=çœŸæ­£çš„æ—¶é—´</div><div class="line"></div><div class="line">int64_t durationï¼šè¯¥è§†é¢‘/éŸ³é¢‘æµé•¿åº¦</div><div class="line"></div><div class="line">AVDictionary *metadataï¼šå…ƒæ•°æ®ä¿¡æ¯</div><div class="line"></div><div class="line">AVRational avg_frame_rateï¼šå¸§ç‡ï¼ˆæ³¨ï¼šå¯¹è§†é¢‘æ¥è¯´ï¼Œè¿™ä¸ªæŒºé‡è¦çš„ï¼‰</div><div class="line"></div><div class="line">AVPacket attached_picï¼šé™„å¸¦çš„å›¾ç‰‡ã€‚æ¯”å¦‚è¯´ä¸€äº›MP3ï¼ŒAACéŸ³é¢‘æ–‡ä»¶é™„å¸¦çš„ä¸“è¾‘å°é¢ã€‚</div></pre></td></tr></table></figure>
<h5 id="AVPacket"><a href="#AVPacket" class="headerlink" title="AVPacket"></a>AVPacket</h5><p>AVPacketæ˜¯å­˜å‚¨å‹ç¼©ç¼–ç æ•°æ®ç›¸å…³ä¿¡æ¯çš„ç»“æ„ä½“</p>
<p>é‡è¦çš„å˜é‡æœ‰ä»¥ä¸‹å‡ ä¸ª:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">&lt;!--ä¾‹å¦‚å¯¹äºH.264æ¥è¯´ã€‚1ä¸ªAVPacketçš„dataé€šå¸¸å¯¹åº”ä¸€ä¸ªNALã€‚</div><div class="line"></div><div class="line">æ³¨æ„ï¼šåœ¨è¿™é‡Œåªæ˜¯å¯¹åº”ï¼Œè€Œä¸æ˜¯ä¸€æ¨¡ä¸€æ ·ã€‚ä»–ä»¬ä¹‹é—´æœ‰å¾®å°çš„å·®åˆ«ï¼šä½¿ç”¨FFMPEGç±»åº“åˆ†ç¦»å‡ºå¤šåª’ä½“æ–‡ä»¶ä¸­çš„H.264ç æµ</div><div class="line"></div><div class="line">å› æ­¤åœ¨ä½¿ç”¨FFMPEGè¿›è¡Œè§†éŸ³é¢‘å¤„ç†çš„æ—¶å€™ï¼Œå¸¸å¸¸å¯ä»¥å°†å¾—åˆ°çš„AVPacketçš„dataæ•°æ®ç›´æ¥å†™æˆæ–‡ä»¶ï¼Œä»è€Œå¾—åˆ°è§†éŸ³é¢‘çš„ç æµæ–‡ä»¶ã€‚</div><div class="line">--&gt;</div><div class="line"></div><div class="line">uint8_t *dataï¼šå‹ç¼©ç¼–ç çš„æ•°æ®ã€‚</div><div class="line"></div><div class="line">int   sizeï¼šdataçš„å¤§å°</div><div class="line"></div><div class="line">int64_t ptsï¼šæ˜¾ç¤ºæ—¶é—´æˆ³</div><div class="line"></div><div class="line">int64_t dtsï¼šè§£ç æ—¶é—´æˆ³</div><div class="line"></div><div class="line">int   stream_indexï¼šæ ‡è¯†è¯¥AVPacketæ‰€å±çš„è§†é¢‘/éŸ³é¢‘æµã€‚</div></pre></td></tr></table></figure>
<h5 id="AVFrame"><a href="#AVFrame" class="headerlink" title="AVFrame"></a>AVFrame</h5><p>AVFrameç»“æ„ä½“ä¸€èˆ¬ç”¨äºå­˜å‚¨åŸå§‹æ•°æ®ï¼ˆå³éå‹ç¼©æ•°æ®ï¼Œä¾‹å¦‚å¯¹è§†é¢‘æ¥è¯´æ˜¯YUVï¼ŒRGBï¼Œå¯¹éŸ³é¢‘æ¥è¯´æ˜¯PCMï¼‰ï¼Œæ­¤å¤–è¿˜åŒ…å«äº†ä¸€äº›ç›¸å…³çš„ä¿¡æ¯ã€‚æ¯”å¦‚è¯´ï¼Œè§£ç çš„æ—¶å€™å­˜å‚¨äº†å®å—ç±»å‹è¡¨ï¼ŒQPè¡¨ï¼Œè¿åŠ¨çŸ¢é‡è¡¨ç­‰æ•°æ®ã€‚ç¼–ç çš„æ—¶å€™ä¹Ÿå­˜å‚¨äº†ç›¸å…³çš„æ•°æ®ã€‚å› æ­¤åœ¨ä½¿ç”¨FFMPEGè¿›è¡Œç æµåˆ†æçš„æ—¶å€™ï¼ŒAVFrameæ˜¯ä¸€ä¸ªå¾ˆé‡è¦çš„ç»“æ„ä½“ã€‚</p>
<p>ä¸‹é¢çœ‹å‡ ä¸ªä¸»è¦å˜é‡çš„ä½œç”¨ï¼š</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">uint8_t *data[AV_NUM_DATA_POINTERS]ï¼šè§£ç ååŸå§‹æ•°æ®ï¼ˆå¯¹è§†é¢‘æ¥è¯´æ˜¯YUVï¼ŒRGBï¼Œå¯¹éŸ³é¢‘æ¥è¯´æ˜¯PCMï¼‰</div><div class="line"></div><div class="line">int linesize[AV_NUM_DATA_POINTERS]ï¼šdataä¸­â€œä¸€è¡Œâ€æ•°æ®çš„å¤§å°ã€‚æ³¨æ„ï¼šæœªå¿…ç­‰äºå›¾åƒçš„å®½ï¼Œä¸€èˆ¬å¤§äºå›¾åƒçš„å®½ã€‚</div><div class="line"></div><div class="line">int width, heightï¼šè§†é¢‘å¸§å®½å’Œé«˜ï¼ˆ1920x1080,1280x720...ï¼‰</div><div class="line"></div><div class="line">int nb_samplesï¼šéŸ³é¢‘çš„ä¸€ä¸ªAVFrameä¸­å¯èƒ½åŒ…å«å¤šä¸ªéŸ³é¢‘å¸§ï¼Œåœ¨æ­¤æ ‡è®°åŒ…å«äº†å‡ ä¸ª</div><div class="line"></div><div class="line">int formatï¼šè§£ç ååŸå§‹æ•°æ®ç±»å‹ï¼ˆYUV420ï¼ŒYUV422ï¼ŒRGB24...ï¼‰</div><div class="line"></div><div class="line">int key_frameï¼šæ˜¯å¦æ˜¯å…³é”®å¸§</div><div class="line"></div><div class="line">enum AVPictureType pict_typeï¼šå¸§ç±»å‹ï¼ˆI,B,P...ï¼‰</div><div class="line"></div><div class="line">AVRational sample_aspect_ratioï¼šå®½é«˜æ¯”ï¼ˆ16:9ï¼Œ4:3...ï¼‰</div><div class="line"></div><div class="line">int64_t ptsï¼šæ˜¾ç¤ºæ—¶é—´æˆ³</div><div class="line"></div><div class="line">int coded_picture_numberï¼šç¼–ç å¸§åºå·</div><div class="line"></div><div class="line">int display_picture_numberï¼šæ˜¾ç¤ºå¸§åºå·</div><div class="line"></div><div class="line">int8_t *qscale_tableï¼šQPè¡¨</div><div class="line"></div><div class="line">uint8_t *mbskip_tableï¼šè·³è¿‡å®å—è¡¨</div><div class="line"></div><div class="line">int16_t (*motion_val[2])[2]ï¼šè¿åŠ¨çŸ¢é‡è¡¨</div><div class="line"></div><div class="line">uint32_t *mb_typeï¼šå®å—ç±»å‹è¡¨</div><div class="line"></div><div class="line">short *dct_coeffï¼šDCTç³»æ•°ï¼Œè¿™ä¸ªæ²¡æœ‰æå–è¿‡</div><div class="line"></div><div class="line">int8_t *ref_index[2]ï¼šè¿åŠ¨ä¼°è®¡å‚è€ƒå¸§åˆ—è¡¨ï¼ˆè²Œä¼¼H.264è¿™ç§æ¯”è¾ƒæ–°çš„æ ‡å‡†æ‰ä¼šæ¶‰åŠåˆ°å¤šå‚è€ƒå¸§ï¼‰</div><div class="line"></div><div class="line">int interlaced_frameï¼šæ˜¯å¦æ˜¯éš”è¡Œæ‰«æ</div><div class="line"></div><div class="line">uint8_t motion_subsample_log2ï¼šä¸€ä¸ªå®å—ä¸­çš„è¿åŠ¨çŸ¢é‡é‡‡æ ·ä¸ªæ•°ï¼Œå–logçš„</div></pre></td></tr></table></figure>
<p>ç»“æ„ä½“ä¹‹é—´çš„å…³ç³»å¯ä»¥å‚è€ƒä¸‹å›¾ï¼š</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/FFMPEG/20130914204051125.jpg" alt=""></p>
<h3 id="api"><a href="#api" class="headerlink" title="api"></a>api</h3><h4 id="avcodec-init"><a href="#avcodec-init" class="headerlink" title="avcodec_init()"></a>avcodec_init()</h4><p>åˆå§‹åŒ–libavcodec,ä¸€èˆ¬æœ€å…ˆè°ƒç”¨è¯¥å‡½æ•°</p>
<p>è¯¥å‡½æ•°å¿…é¡»åœ¨è°ƒç”¨libavcodecé‡Œçš„å…¶å®ƒå‡½æ•°å‰è°ƒç”¨,ä¸€èˆ¬åœ¨ç¨‹åºå¯åŠ¨æˆ–æ¨¡å—åˆå§‹åŒ–æ—¶è°ƒç”¨,å¦‚æœä½ è°ƒç”¨äº†å¤šæ¬¡ä¹Ÿæ— æ‰€è°“,å› ä¸ºåé¢çš„è°ƒç”¨ä¸ä¼šåšä»»ä½•äº‹æƒ….ä»å‡½æ•°çš„å®ç°é‡Œä½ å¯ä»¥å‘ç°,ä»£ç ä¸­å¯¹å¤šæ¬¡è°ƒç”¨è¿›è¡Œäº†æ§åˆ¶.</p>
<h4 id="av-register-all"><a href="#av-register-all" class="headerlink" title="av_register_all()"></a>av_register_all()</h4><p>åˆå§‹åŒ– libavformatå’Œæ³¨å†Œæ‰€æœ‰çš„muxersã€demuxerså’Œprotocolsï¼Œ</p>
<p>ä¸€èˆ¬åœ¨è°ƒç”¨avcodec_initåè°ƒç”¨è¯¥æ–¹æ³•</p>
<p>å…¶ä¸­ä¼šè°ƒç”¨avcodec_register_all()æ³¨å†Œå¤šç§éŸ³è§†é¢‘æ ¼å¼çš„ç¼–è§£ç å™¨,å¹¶æ³¨å†Œå„ç§æ–‡ä»¶çš„ç¼–è§£å¤ç”¨å™¨</p>
<h4 id="avformat-alloc-context"><a href="#avformat-alloc-context" class="headerlink" title="avformat_alloc_context()"></a>avformat_alloc_context()</h4><p>åˆ†é…ä¸€ä¸ªAVFormatContextç»“æ„ï¼Œè´Ÿè´£ç”³è¯·ä¸€ä¸ªAVFormatContextç»“æ„çš„å†…å­˜,å¹¶è¿›è¡Œç®€å•åˆå§‹åŒ–</p>
<h4 id="avformat-open-input"><a href="#avformat-open-input" class="headerlink" title="avformat_open_input()"></a>avformat_open_input()</h4><p>æ‰“å¼€ä¸€ä¸ªæµåª’ä½“æ–‡ä»¶</p>
<h4 id="avformat-close-input"><a href="#avformat-close-input" class="headerlink" title="avformat_close_input()"></a>avformat_close_input()</h4><p>å…³é—­ä¸€ä¸ªæµåª’ä½“æ–‡ä»¶</p>
<h4 id="avformat-free-context"><a href="#avformat-free-context" class="headerlink" title="avformat_free_context()"></a>avformat_free_context()</h4><p>é‡Šæ”¾ä¸€ä¸ªAVFormatContextç»“æ„</p>
<p>ä½¿ç”¨ avformat_alloc_context()åˆ†é…çš„ç»“æ„,é‡‡ç”¨è¯¥å‡½æ•°è¿›è¡Œé‡Šæ”¾,é™¤é‡Šæ”¾AVFormatContextç»“æ„æœ¬èº«å†…å­˜ä¹‹å¤–,AVFormatContextä¸­æŒ‡é’ˆæ‰€æŒ‡å‘çš„å†…å­˜ä¹Ÿä¼šä¸€å¹¶é‡Šæ”¾</p>
<h4 id="avio-alloc-context"><a href="#avio-alloc-context" class="headerlink" title="avio_alloc_context()"></a>avio_alloc_context()</h4><p>ä¸ºI/0ç¼“å­˜ç”³è¯·å¹¶åˆå§‹åŒ–ä¸€ä¸ªAVIOContextç»“æ„,ç»“æŸä½¿ç”¨æ—¶å¿…é¡»ä½¿ç”¨av_free()è¿›è¡Œé‡Šæ”¾</p>
<h4 id="av-open-input-file"><a href="#av-open-input-file" class="headerlink" title="av_open_input_file()"></a>av_open_input_file()</h4><p>ä»¥è¾“å…¥æ–¹å¼æ‰“å¼€ä¸€ä¸ªåª’ä½“æ–‡ä»¶,ä¹Ÿå³æºæ–‡ä»¶,codecså¹¶æ²¡æœ‰æ‰“å¼€,åªè¯»å–äº†æ–‡ä»¶çš„å¤´ä¿¡æ¯.</p>
<h4 id="av-close-input-file"><a href="#av-close-input-file" class="headerlink" title="av_close_input_file()"></a>av_close_input_file()</h4><p>å…³é—­ä½¿ç”¨avformat_close_input()æ‰“å¼€çš„è¾“å…¥æ–‡ä»¶å®¹å™¨,ä½†å¹¶ä¸å…³ç³»å®ƒçš„codecs</p>
<p>ä½¿ç”¨ av_close_input_file å…³é—­å,å°±ä¸å†éœ€è¦ä½¿ç”¨avformat_free_context è¿›è¡Œé‡Šæ”¾äº†</p>
<h4 id="av-find-stream-info-AVFormatContext-ic"><a href="#av-find-stream-info-AVFormatContext-ic" class="headerlink" title="av_find_stream_info(AVFormatContext *ic)"></a>av_find_stream_info(AVFormatContext *ic)</h4><p>é€šè¿‡è¯»å–åª’ä½“æ–‡ä»¶çš„ä¸­çš„åŒ…æ¥è·å–åª’ä½“æ–‡ä»¶ä¸­çš„æµä¿¡æ¯,å¯¹äºæ²¡æœ‰å¤´ä¿¡æ¯çš„æ–‡ä»¶å¦‚(mpeg)æ˜¯éå¸¸æœ‰ç”¨çš„</p>
<h4 id="AVCodec-avcodec-find-decoder-enum-CodecID-id"><a href="#AVCodec-avcodec-find-decoder-enum-CodecID-id" class="headerlink" title="AVCodec *avcodec_find_decoder(enum CodecID id)"></a>AVCodec *avcodec_find_decoder(enum CodecID id)</h4><p>é€šè¿‡code IDæŸ¥æ‰¾ä¸€ä¸ªå·²ç»æ³¨å†Œçš„éŸ³è§†é¢‘è§£ç å™¨</p>
<p>æŸ¥æ‰¾è§£ç å™¨ä¹‹å‰,å¿…é¡»å…ˆè°ƒç”¨av_register_allæ³¨å†Œæ‰€æœ‰æ”¯æŒçš„è§£ç å™¨</p>
<p>éŸ³è§†é¢‘è§£ç å™¨ä¿å­˜åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­,æŸ¥æ‰¾è¿‡ç¨‹ä¸­,å‡½æ•°ä»å¤´åˆ°å°¾éå†é“¾è¡¨,é€šè¿‡æ¯”è¾ƒè§£ç å™¨çš„IDæ¥æŸ¥æ‰¾</p>
<h4 id="AVCodec-avcodec-find-decoder-by-name-constchar-name"><a href="#AVCodec-avcodec-find-decoder-by-name-constchar-name" class="headerlink" title="AVCodec  avcodec_find_decoder_by_name (constchar  name)"></a>AVCodec <em> avcodec_find_decoder_by_name (constchar </em> name)</h4><p>é€šè¿‡ä¸€ä¸ªæŒ‡å®šçš„åç§°æŸ¥æ‰¾ä¸€ä¸ªå·²ç»æ³¨å†Œçš„éŸ³è§†é¢‘è§£ç å™¨</p>
<p>æŸ¥æ‰¾è§£ç å™¨ä¹‹å‰,å¿…é¡»å…ˆè°ƒç”¨av_register_allæ³¨å†Œæ‰€æœ‰æ”¯æŒçš„è§£ç å™¨</p>
<p>éŸ³è§†é¢‘è§£ç å™¨ä¿å­˜åœ¨ä¸€ä¸ªé“¾è¡¨ä¸­,æŸ¥æ‰¾è¿‡ç¨‹ä¸­,å‡½æ•°ä»å¤´åˆ°å°¾éå†é“¾è¡¨,é€šè¿‡æ¯”è¾ƒè§£ç å™¨çš„nameæ¥æŸ¥æ‰¾</p>
<h4 id="avcodec-find-encoder"><a href="#avcodec-find-encoder" class="headerlink" title="avcodec_find_encoder()"></a>avcodec_find_encoder()</h4><h4 id="avcodec-find-encoder-by-name"><a href="#avcodec-find-encoder-by-name" class="headerlink" title="avcodec_find_encoder_by_name()"></a>avcodec_find_encoder_by_name()</h4><p>åŒä¸Šã€‚ã€‚ã€‚</p>
<h4 id="int-avcodec-open-AVCodecContext-avctx-AVCodec-codec-avcodec-open2"><a href="#int-avcodec-open-AVCodecContext-avctx-AVCodec-codec-avcodec-open2" class="headerlink" title="int avcodec_open(AVCodecContext  avctx, AVCodec  codec) / avcodec_open2()"></a>int avcodec_open(AVCodecContext <em> avctx, AVCodec </em> codec) / avcodec_open2()</h4><p>ä½¿ç”¨ç»™å®šçš„AVCodecåˆå§‹åŒ–AVCodecContext</p>
<h4 id="av-guess-format"><a href="#av-guess-format" class="headerlink" title="av_guess_format()"></a>av_guess_format()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">AVOutputFormat *av_guess_format(constchar *short_name,</div><div class="line"></div><div class="line">                                constchar *filename,</div><div class="line"></div><div class="line">                                constchar *mime_type);</div></pre></td></tr></table></figure>
<p>è¿”å›ä¸€ä¸ªå·²ç»æ³¨å†Œçš„æœ€åˆé€‚çš„è¾“å‡ºæ ¼å¼</p>
<h4 id="void-av-init-packet-AVPacket-pkt"><a href="#void-av-init-packet-AVPacket-pkt" class="headerlink" title="void av_init_packet(AVPacket *pkt);"></a>void av_init_packet(AVPacket *pkt);</h4><p>ä½¿ç”¨é»˜è®¤å€¼åˆå§‹åŒ–AVPacket</p>
<p>å®šä¹‰AVPacketå¯¹è±¡å,è¯·ä½¿ç”¨av_init_packetè¿›è¡Œåˆå§‹åŒ–</p>
<h4 id="int-av-read-frame-AVFormatContext-s-AVPacket-pkt"><a href="#int-av-read-frame-AVFormatContext-s-AVPacket-pkt" class="headerlink" title="int av_read_frame(AVFormatContext  s, AVPacket  pkt)"></a>int av_read_frame(AVFormatContext <em> s, AVPacket </em> pkt)</h4><p>ä»è¾“å…¥æºæ–‡ä»¶å®¹å™¨ä¸­è¯»å–ä¸€ä¸ªAVPacketæ•°æ®åŒ…</p>
<p>è¯¥å‡½æ•°è¯»å‡ºçš„åŒ…å¹¶ä¸æ¯æ¬¡éƒ½æ˜¯æœ‰æ•ˆçš„,å¯¹äºè¯»å‡ºçš„åŒ…æˆ‘ä»¬éƒ½åº”è¯¥è¿›è¡Œç›¸åº”çš„è§£ç (è§†é¢‘è§£ç /éŸ³é¢‘è§£ç ),</p>
<p>åœ¨è¿”å›å€¼&gt;=0æ—¶,å¾ªç¯è°ƒç”¨è¯¥å‡½æ•°è¿›è¡Œè¯»å–,å¾ªç¯è°ƒç”¨ä¹‹å‰è¯·è°ƒç”¨av_free_packetå‡½æ•°æ¸…ç†AVPacket</p>
<h4 id="avcodec-decode-video2"><a href="#avcodec-decode-video2" class="headerlink" title="avcodec_decode_video2()"></a>avcodec_decode_video2()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">int avcodec_decode_video2(AVCodecContext *avctx, 										AVFrame *picture,</div><div class="line">                         int *got_picture_ptr,</div><div class="line">                         AVPacket *avpkt);</div><div class="line">                         </div><div class="line">                         </div><div class="line">// è§£ç è§†é¢‘æµAVPacket</div><div class="line">// ä½¿ç”¨av_read_frameè¯»å–åª’ä½“æµåéœ€è¦è¿›è¡Œåˆ¤æ–­,å¦‚æœä¸ºè§†é¢‘æµåˆ™è°ƒç”¨è¯¥å‡½æ•°è§£ç </div><div class="line">// è¿”å›ç»“æœ&lt;0æ—¶å¤±è´¥,æ­¤æ—¶ç¨‹åºåº”è¯¥é€€å‡ºæ£€æŸ¥åŸå› </div><div class="line">// è¿”å›&gt;=0æ—¶æ­£å¸¸,å‡è®¾ è¯»å–åŒ…ä¸º:AVPacket vPacket è¿”å›å€¼ä¸º int vLen; æ¯æ¬¡è§£ç æ­£å¸¸æ—¶,å¯¹vPacketåš</div><div class="line">// å¦‚ä¸‹å¤„ç†:</div><div class="line">//   vPacket.size -= vLen;</div><div class="line">//   vPacket.data += vLen;</div><div class="line">// å¦‚æœ vPacket.size==0,åˆ™ç»§ç»­è¯»ä¸‹ä¸€æµåŒ…,å¦åˆ™ç»§ç»­è°ƒåº¦è¯¥æ–¹æ³•è¿›è¡Œè§£ç ,ç›´åˆ°vPacket.size==0</div><div class="line">// è¿”å› got_picture_ptr &gt; 0 æ—¶,è¡¨ç¤ºè§£ç åˆ°äº†AVFrame *picture,å…¶åå¯ä»¥å¯¹pictureè¿›ç¨‹å¤„ç†</div></pre></td></tr></table></figure>
<h4 id="avcodec-decode-audio3-avcodec-decode-audio4"><a href="#avcodec-decode-audio3-avcodec-decode-audio4" class="headerlink" title="avcodec_decode_audio3()/avcodec_decode_audio4()"></a>avcodec_decode_audio3()/avcodec_decode_audio4()</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">int avcodec_decode_audio3(AVCodecContext *avctx, int16_t *samples,</div><div class="line"></div><div class="line">                         int *frame_size_ptr,</div><div class="line"></div><div class="line">                         AVPacket *avpkt);</div><div class="line">                         </div><div class="line">int avcodec_decode_audio4(AVCodecContext *avctx, AVFrame *frame,</div><div class="line">int *got_frame_ptr, </div><div class="line">const AVPacket *avpkt);</div><div class="line"></div><div class="line"></div><div class="line">// è§£ç éŸ³é¢‘æµAVPacket</div><div class="line">// ä½¿ç”¨av_read_frameè¯»å–åª’ä½“æµåéœ€è¦è¿›è¡Œåˆ¤æ–­,å¦‚æœä¸ºéŸ³é¢‘æµåˆ™è°ƒç”¨è¯¥å‡½æ•°è§£ç </div><div class="line">// è¿”å›ç»“æœ&lt;0æ—¶å¤±è´¥,æ­¤æ—¶ç¨‹åºåº”è¯¥é€€å‡ºæ£€æŸ¥åŸå› </div><div class="line">// è¿”å›&gt;=0æ—¶æ­£å¸¸,å‡è®¾ è¯»å–åŒ…ä¸º:AVPacket vPacket è¿”å›å€¼ä¸º int vLen; æ¯æ¬¡è§£ç æ­£å¸¸æ—¶,å¯¹vPacketåš</div><div class="line">// å¦‚ä¸‹å¤„ç†:</div><div class="line">//   vPacket.size -= vLen;</div><div class="line">//   vPacket.data += vLen;</div><div class="line">// å¦‚æœ vPacket.size==0,åˆ™ç»§ç»­è¯»ä¸‹ä¸€æµåŒ…,å¦åˆ™ç»§ç»­è°ƒåº¦è¯¥æ–¹æ³•è¿›è¡Œè§£ç ,ç›´åˆ°vPacket.size==0</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/6/">6</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/head.png"
               alt="lly" />
          <p class="site-author-name" itemprop="name">lly</p>
          <p class="site-description motion-element" itemprop="description">è€¿ç›´çš„ä¸€Boy</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">53</span>
              <span class="site-state-item-name">æ—¥å¿—</span>
            </a>
          </div>

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2019</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lly</span>
</div>

<div class="powered-by">
  ç”± <a class="theme-link" href="https://hexo.io">Hexo</a> å¼ºåŠ›é©±åŠ¨
</div>

<div class="theme-info">
  ä¸»é¢˜ -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"llyblog"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
