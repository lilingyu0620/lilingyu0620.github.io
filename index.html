<!doctype html>



  


<html class="theme-next mist use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.1" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.1" />






<meta name="description" content="耿直的一Boy">
<meta property="og:type" content="website">
<meta property="og:title" content="lly&#39;s Blog">
<meta property="og:url" content="http://yoursite.com/index.html">
<meta property="og:site_name" content="lly&#39;s Blog">
<meta property="og:description" content="耿直的一Boy">
<meta property="og:locale" content="zh-Hans">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="lly&#39;s Blog">
<meta name="twitter:description" content="耿直的一Boy">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Mist',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: 0,
      author: '博主'
    }
  };
</script>




  <link rel="canonical" href="http://yoursite.com/"/>

  <title> lly's Blog </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">lly's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">用心记录点滴</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2021/01/01/从【class-getInstanceSize方法】探究iOS的内存分配策略/" itemprop="url">
                  从【class_getInstanceSize方法】探究iOS的内存分配策略
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2021-01-01T21:39:15+08:00" content="2021-01-01">
              2021-01-01
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2021/01/01/从【class-getInstanceSize方法】探究iOS的内存分配策略/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2021/01/01/从【class-getInstanceSize方法】探究iOS的内存分配策略/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="先抛问题"><a href="#先抛问题" class="headerlink" title="先抛问题"></a>先抛问题</h4><p>各位看官请看下面两种case的输出分别是多少：</p>
<h5 id="case1"><a href="#case1" class="headerlink" title="case1:"></a>case1:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">@interface LLYModel : NSObject</div><div class="line"></div><div class="line">@property (nonatomic, copy) NSString *name;</div><div class="line">@property (nonatomic, copy) NSString *nickName;</div><div class="line">@property (nonatomic, assign) int age;</div><div class="line">@property (nonatomic, assign) long height;</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line"></div><div class="line">LLYModel *objc = [LLYModel alloc];</div><div class="line">objc.name = @&quot;lly&quot;;</div><div class="line">objc.nickName = @&quot;123&quot;;</div><div class="line">objc.age = 18;</div><div class="line">objc.height = 180;</div><div class="line">NSLog(@&quot;%@ - %lu - %lu - %lu&quot;,objc,sizeof(objc),class_getInstanceSize([LLYModel class]),malloc_size((__bridge const void *)(objc)));</div></pre></td></tr></table></figure>
<h5 id="case2"><a href="#case2" class="headerlink" title="case2:"></a>case2:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">@interface LLYModel : NSObject</div><div class="line"></div><div class="line">@property (nonatomic, copy) NSString *name;</div><div class="line">@property (nonatomic, copy) NSString *nickName;</div><div class="line">@property (nonatomic, assign) int age;</div><div class="line">@property (nonatomic, assign) long height;</div><div class="line">@property (nonatomic, assign) long weight;</div><div class="line"></div><div class="line">@end</div><div class="line"></div><div class="line"></div><div class="line">LLYModel *objc = [LLYModel alloc];</div><div class="line">objc.name = @&quot;lly&quot;;</div><div class="line">objc.nickName = @&quot;123&quot;;</div><div class="line">objc.age = 18;</div><div class="line">objc.height = 180;</div><div class="line">objc.weight = 180;</div><div class="line">NSLog(@&quot;%@ - %lu - %lu - %lu&quot;,objc,sizeof(objc),class_getInstanceSize([LLYModel class]),malloc_size((__bridge const void *)(objc)));</div></pre></td></tr></table></figure>
<p>可以先分析一下打印情况，我这里直接上结果：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">case1:&lt;LLYModel: 0x1006cf490&gt; - 8 - 40 - 48</div><div class="line">case2:&lt;LLYModel: 0x1006cf490&gt; - 8 - 48 - 48</div></pre></td></tr></table></figure>
<p>这就有点意思了，class_getInstanceSize获取到的大小并不完全和对象的真实大小完全一致，通过对相关源码的探究，最终发现了原因，这里先上结论：</p>
<p><strong>class_getInstanceSize获取的大小是根据8字节对齐计算，而内存的实际分配策略是根据16字节对齐计算</strong></p>
<h4 id="源码分析"><a href="#源码分析" class="headerlink" title="源码分析"></a>源码分析</h4><p>我们首先来看看runtime中class_getInstanceSize的实现，通过调用栈的追踪，最终定位到下面几个比较重要的函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">// Class&apos;s ivar size rounded up to a pointer-size boundary. </div><div class="line">// 这里返回类的实例变量的大小 因为只有实例变量是存放在类对象中的。</div><div class="line">uint32_t alignedInstanceSize() const &#123;</div><div class="line">    return word_align(unalignedInstanceSize());</div><div class="line">&#125;</div><div class="line"></div><div class="line">// May be unaligned depending on class&apos;s ivars.</div><div class="line">// 未对齐的实例变量的大小</div><div class="line">uint32_t unalignedInstanceSize() const &#123;</div><div class="line">    ASSERT(isRealized());</div><div class="line">    return data()-&gt;ro()-&gt;instanceSize;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#ifdef __LP64__</div><div class="line">#   define WORD_SHIFT 3UL</div><div class="line">#   define WORD_MASK 7UL</div><div class="line">#   define WORD_BITS 64</div><div class="line">#else</div><div class="line">#   define WORD_SHIFT 2UL</div><div class="line">#   define WORD_MASK 3UL</div><div class="line">#   define WORD_BITS 32</div><div class="line">#endif</div><div class="line"></div><div class="line">// 64位下8字节对齐 32位下4字节对齐 </div><div class="line">static inline uint32_t word_align(uint32_t x) &#123;</div><div class="line">    return (x + WORD_MASK) &amp; ~WORD_MASK;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>通过以上几个函数的调用，就可以验证上面的结论<strong>class_getInstanceSize是以8字节对齐的</strong>，<br>在上面的函数中，我们还发现了一个很熟悉的身影，就是下面这个结构：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">class_ro_t *ro()</div></pre></td></tr></table></figure>
<p>我们知道，这里面的数据都是只读数据，是在程序编译期就决定了的，我们常用的实例变量就存放在这个结构体中，这也是为什么类在初始化后不能再动态添加实例变量的原因。</p>
<p>然后我们再来看看类的创建过程，还是从源码入手，不过内存创建的函数调用栈比较复杂，我画个简单的流程图来表示下先：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Alloc分析/alloc01.png" alt=""></p>
<p>在runtime库中，这个调用堆栈跟到最后两个标黄部分就进不去了，不过我们还是通过一些细节找到了这两个函数的出处，并最终定位到了负责内存分配过程中size计算的函数，该部分代码位于libsystem_malloc库中，具体代码实现如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">static MALLOC_INLINE size_t</div><div class="line">segregated_size_to_fit(nanozone_t *nanozone, size_t size, size_t *pKey)</div><div class="line">&#123;</div><div class="line">	size_t k, slot_bytes;</div><div class="line"></div><div class="line">	//最小16字节</div><div class="line">	if (0 == size) &#123;</div><div class="line">		size = NANO_REGIME_QUANTA_SIZE; // Historical behavior </div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	//先加上16个字节 然后抹掉零头</div><div class="line">	k = (size + NANO_REGIME_QUANTA_SIZE - 1) &gt;&gt; SHIFT_NANO_QUANTUM; // round up and shift for number of quanta </div><div class="line">	slot_bytes = k &lt;&lt; SHIFT_NANO_QUANTUM;							// multiply by power of two quanta size</div><div class="line">	*pKey = k - 1;													// Zero-based!</div><div class="line"></div><div class="line">	return slot_bytes;</div><div class="line">&#125;</div><div class="line"></div><div class="line">#define NANO_MAX_SIZE			256 /* Buckets sized &#123;16, 32, 48, ..., 256&#125; */</div><div class="line">#define SHIFT_NANO_QUANTUM		4</div><div class="line">#define NANO_REGIME_QUANTA_SIZE	(1 &lt;&lt; SHIFT_NANO_QUANTUM)	// 16</div><div class="line">#define NANO_QUANTA_MASK		(NANO_REGIME_QUANTA_SIZE - 1)</div><div class="line">#define NANO_SIZE_CLASSES		(NANO_MAX_SIZE/NANO_REGIME_QUANTA_SIZE)</div></pre></td></tr></table></figure>
<p>通过以上源码也证明了上面的结论<strong>内存的实际分配策略是根据16字节对齐计算</strong></p>
<h4 id="补充部分"><a href="#补充部分" class="headerlink" title="补充部分"></a>补充部分</h4><p>因为iOS中的类本质上都是结构体，所以他们的内存大小应该也需要满足c语言中结构体对齐的原则，这里简单介绍下c语言中如何进行字节对齐：</p>
<h5 id="内部对齐"><a href="#内部对齐" class="headerlink" title="内部对齐"></a>内部对齐</h5><p>即结构体内部变量的起始地址需要是变量自身大小的倍数。具体对齐逻辑参考下图：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/Alloc分析/alig.png" alt=""></p>
<h5 id="外部对齐"><a href="#外部对齐" class="headerlink" title="外部对齐"></a>外部对齐</h5><p>即结构体的整体大小需要和当前运行环境的字对齐。</p>
<p><strong>这里还有一个知识点需要提及，为了更高效的利用内存，xcode编译器会对实例变量进行重排序，这个在我上面的LLYModel中并未体现，感兴趣的同学可以自行实验</strong></p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>以上就是这次对iOS类分配内存大小探索的全部内容，首先是发现问题，然后通过源码的分析找到问题产生的原因，中间的探索过程一度中断，不过最后还是通过一些小的线索定位到问题的所在，在源码分析过程中，我们应该做到抓住关键问题，忽略干扰条件，多一些细心和耐心。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/07/04/架构设计的一些思考/" itemprop="url">
                  架构设计的一些思考
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-07-04T17:21:34+08:00" content="2020-07-04">
              2020-07-04
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/07/04/架构设计的一些思考/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/07/04/架构设计的一些思考/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>从宏观上看，计算机系统整体上都是一种分层的架构设计，从网络的五层协议到分布式系统；从操作系统到应用软件。架构设计要解决的核心问题就是如何分层，层与层之间以及同层之前如何去交互的问题。在我们着手去做分层架构和通信设计之前，我们可能还需要一些设计理论和原则的支撑，历史一次次证明，如果只是全凭实践经验，我们是无法成功设计出一款好的产品的。（比如飞机的发明，飞行器古代就已经出现，但是现代意义上的飞机直到空气动力学理论出现后才由莱特兄弟设计制造出来，这样的例子在科技史上还有很多）这里我总结了三个部分：模块设计原则，设计模式的应用和重构原则。</p>
<h3 id="模块设计原则"><a href="#模块设计原则" class="headerlink" title="模块设计原则"></a>模块设计原则</h3><p>模块设计原则就是做架构的理论基础，只有熟练掌握以下这些原则，你在着手软件架构时才能得心应手，信手拈来，设计出更合理的架构，就好比有了九阳神功的张无忌再去修炼乾坤大挪移。</p>
<h4 id="单一职能原则SRP"><a href="#单一职能原则SRP" class="headerlink" title="单一职能原则SRP"></a>单一职能原则SRP</h4><p>单一职能原则强调一个模块或者一个类只应该有一种行为，也只能对一种行为负责，比如负责UI展示的类，就不要在内部去处理业务逻辑，负责业务逻辑的类，则内部必要去修改UI布局等。这个原则在MVVM的模式中被广泛采用。</p>
<h4 id="开闭原则OCP"><a href="#开闭原则OCP" class="headerlink" title="开闭原则OCP"></a>开闭原则OCP</h4><p>开闭原则指类或者模块应该易于扩展，而难以修改。要遵守该原则，我们在设计模块时就要尽量设计“害羞”的代码，隐藏自己的大部分行为，只将必要的接口暴露给外部，并且尽量只暴露只读的接口，不要暴露能够修改内部属性的接口，这是难以修改部分，那易于扩展部分，我们应该预留适当的钩子接口，该钩子可以扩展类的行为，将该行为的实现交于外部去处理。</p>
<h4 id="里斯替换原则LSP"><a href="#里斯替换原则LSP" class="headerlink" title="里斯替换原则LSP"></a>里斯替换原则LSP</h4><p>里斯替换也是描述的接口扩展问题，但是和开闭描述的场景又不太一样，里斯替换更像工厂，一个接口的具体行为不依赖该类，而依赖其扩展类，该接口的行为可以很容易被其扩展类替换。</p>
<h4 id="接口隔离原则ISP"><a href="#接口隔离原则ISP" class="headerlink" title="接口隔离原则ISP"></a>接口隔离原则ISP</h4><p>接口隔离很重要，但是经常被忽视，只有正在懂的人才会在模块封装的过程中采用这个原则，大部分人则无视该原则的好处，只是为了代码写起来更方便。我们是封装系统库和三方库时，往往会使用该原则去对系统方法做一层隔离，但是大部分也仅仅只是做到了这一层，选择忽略更上层的情况。其实对更上层的业务实体来说，每一个实体都应该再加一层的隔离，这样做的利大于弊，模块的职能划分的越清晰，维护和扩展的成本就会越低。</p>
<h4 id="依赖反转原则DIP"><a href="#依赖反转原则DIP" class="headerlink" title="依赖反转原则DIP"></a>依赖反转原则DIP</h4><p>该原则主要解决模块间比较常见的相互依赖的问题，相互依赖的坏处这里不再多描述，依赖反转将双向或者多向的依赖关系梳理为单向的依赖关系，依赖反转的工具常常使用抽象接口去实现。</p>
<h4 id="组件聚合原则"><a href="#组件聚合原则" class="headerlink" title="组件聚合原则"></a>组件聚合原则</h4><p>组件聚合原则主要介绍在做组件封装时类的归属问题，哪些类应该放入一个组件，哪些又不应该放入一个组件内，该原则主要包括以下三部分：</p>
<ul>
<li><p>复用/发布等同原则 </p>
<p>  该原则指组件中的类和模块应该是可以共同发布，也能被其他组件共同复用的，即该组件中的类应该具有紧密的关系和共同的主题，而不是毫不相干的内容。</p>
</li>
<li><p>共同闭包原则</p>
<p>  一个组件中的各类应该是会因为同一个行为而被一起修改的，如果有一些独善其身的类，那说明该类可能并不适合该组件，应该将其剥离该组件。</p>
</li>
<li><p>共同复用原则</p>
<p>  一个组件中的类应该是可以被外部共同复用的，而不应该存在只需要复用一部分的情况，一个组件应该是不可再拆分的。</p>
</li>
</ul>
<h4 id="组件解耦原则"><a href="#组件解耦原则" class="headerlink" title="组件解耦原则"></a>组件解耦原则</h4><p>该原则主要介绍组件内部或者组件之间的关系。</p>
<ul>
<li>无依赖环原则，这个上面已经介绍过（DIP）.</li>
<li><p>稳定依赖原则：</p>
<p>  这里先介绍什么是<strong>模块的稳定性</strong>，一个模块被其他模块依赖称为<em>入口依赖</em>,该模块依赖其他模块称为<em>出口依赖</em>，入口依赖越多，该模块就越稳定。</p>
<p>  组件之间的依赖关系应该是从不稳定指向稳定方向的。这里已一个分层组件举例的话，越上层的组件，应该是越不稳定，因为它依赖了太多其他组件，越底层的组件，应该越稳定，因为它几乎只被其他组件依赖，分层组件的依赖关系应该是自顶向下的单向依赖。</p>
</li>
<li><p>稳定抽象原则：</p>
<p>  抽象这个概念应该都知道，这里已接口举例，一个接口就是一个抽象方法。稳定抽象原则是指一个组件的稳定性应该和它的抽象性保持一致。</p>
<p>  这里又要解释一下<strong>抽象性的概念</strong>，组件中的抽象类和抽象方法 / 组件中的实现类和实现方法 = 组件的抽象性。其实很好理解，抽象类和抽象方法越多，表示该组件越抽象。</p>
<p>  既然稳定性和抽象性要保持一致，还是按上面的分层组件举例，就可以解释为：越是上层的组件应该越具体，越是底层的组件应该越抽象。    </p>
</li>
</ul>
<h3 id="设计模式的应用"><a href="#设计模式的应用" class="headerlink" title="设计模式的应用"></a>设计模式的应用</h3><p>设计模式在代码中角色很奇妙，有的人可能根据自身经验采用了许多设计模式而不自知，其实设计模式本身也是从实践和经验中总结出来的一套代码设计的真理，了解并应用这些设计模式，在模块和架构设计过程中是必不可少的。</p>
<h4 id="创建型"><a href="#创建型" class="headerlink" title="创建型"></a>创建型</h4><p>创建型设计模式这里重点介绍抽象工厂和工厂模式，工厂模式比较单一，一次只能生产一种对象，抽象工厂在工厂的基础上做了扩展，可同时生产多个对象。</p>
<p>考虑下面这种情况：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/架构设计的一些思考/factory.png" alt=""></p>
<p>这个活动目前有5种类型，我们在展示UI时可以选择创建5种cell去分别适配，如果以后还有类型的扩展再新建cell,但是这种方案会造成子类爆炸，也贡献了大量的重复代码，更好的方案是新建一个类型的抽象工厂，抽象工厂提供变化的UI元素的生成接口（设计模式的核心就是对变化的概念进行抽象），具体生成逻辑放到工厂实体类进行。这样就只需要一个cell和一个抽象工厂实体即可完全展示，后续扩展也更方便。整体类结构大概长这样：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/架构设计的一些思考/activity.png" alt=""></p>
<p>其他的创建型设计模式比如原型描述的是对象的复用（clone），单例则是对象的共享，生成器一般用在比较复杂的对象创建上，比如这个对象由很多子对象组成，如一个订单等。</p>
<h4 id="结构型"><a href="#结构型" class="headerlink" title="结构型"></a>结构型</h4><p><strong>结构型设计模式主要描述如何组合类和对象的行为已获得更大的结构</strong></p>
<p>适配器模式主要描述如何对类和对象的行为进行扩展，方式主要是依赖和继承。iOS中还可以通过协议和消息转发扩展类。</p>
<p>桥接有点像抽象工厂，基类只提供行为接口，具体的行为逻辑放到实体类进行。这种设计方便了对行为进行替换和扩展。</p>
<p>组合是同一个类型的集合，方便统一处理一些行为，iOS中的subviews集合就是一个典型的组合模式的应用。</p>
<p>装饰其实也是在给类添加属性或者方法，iOS中的分类就是装饰模式的应用。</p>
<p>外观是将一系列相关联的方法进行封装，然后提供一个统一的入口。编译器的封装采用了外观模式,将整个编译链进行封装，隐藏内部过程，只提供一个统一的api供外部调用.</p>
<p>享元模式有点类似上面的原型，只是享元复用的对象可能颗粒度更细，而且只是内部数据，内部数据是不变的，外部数据是可变的。</p>
<p>代理模式比较好理解，类的某个行为自己不去实现，而是交给另一个代理类去实现，代理模式可以用来解耦模块间的相互依赖。</p>
<h4 id="行为型"><a href="#行为型" class="headerlink" title="行为型"></a>行为型</h4><p><strong>行为型设计模式具体描述算法和对象之间职能的分配方式</strong></p>
<p>责任链模式描述组合对象对同一方法的调用情况，强调每个对象都有机会去处理改方法，具体实现逻辑可以参考iOS响应链传递机制中hitTest方法的处理。</p>
<p>命令模式将用户的行为进行封装，每一个行为都抽象为一个命令，使用命令队列进行维护，该模式主要应用于编辑软件中redo和undo操作的支持。</p>
<p>解释器模式对特定的语法进行解释，这些语法往往比较复杂且多变，如果直接使用比较麻烦，比如正则表达式的匹配，就需要使用专门的解释器。</p>
<p>迭代器模式主要来用进行集合的访问，在无需暴露集合内部具体结构的情况下。不同的遍历策略对应不同的迭代器类，即多态迭代。编程语言一般都有自己的集合迭代器。</p>
<p>中介者模式为各类之间的交互提供一个环境，避免各类因为相互调用而产生双向依赖。将与其他类的通信转变为和中介者的通信。</p>
<p>备忘录模式是一种数据持久化的应用，当我们需要保存对象信息时，通过将对象持久化本地，下次需要使用时直接从本地获取。</p>
<p>观察者模式提供了一种方式，保证依赖同一属性的多个类的一致性。通过注册对这个属性的观察回调，在这个属性改变时，可以很方便的通知这些依赖类。观察者模式是一对多的通信方式。iOS中的通知和KVO都属于这种模式。</p>
<p>状态模式用来解决对象在不同的时间节点时有不同行为的场景。我们可以将不同的时间节点抽象为不同的状态，通过对状态的观察改变对象的行为。tcp的建连和断开的过程就是应用的状态模式。</p>
<p>策略模式和状态模式相似，不同的是对象在各时间节点需要调用不同的算法，这里我们将变化的概念抽象为策略，每一种算法对应一种策略。</p>
<p>模板方法将基类的逻辑复用，而将具体的数据等属性延迟到子类实现。这样子类在继承父类的逻辑的同时还能拥有自己的行为。模板方法是基类预留的钩子，能够钩住子类的特定行为。</p>
<p>访问者模式提供了一种访问类簇对象的解决方案。可以将访问行为抽象为访问者，每一种具体行为对应具体的一个访问者类，该访问者为类簇中每一个类添加一个该行为的访问方法。如果以后有新的访问行为，在不修改类簇结构的情况下，即可通过扩展访问者来实现。</p>
<h3 id="重构原则"><a href="#重构原则" class="headerlink" title="重构原则"></a>重构原则</h3><h4 id="类的重构"><a href="#类的重构" class="headerlink" title="类的重构"></a>类的重构</h4><h4 id="函数的重构"><a href="#函数的重构" class="headerlink" title="函数的重构"></a>函数的重构</h4>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/06/30/《软技能-代码之外的生存指南-职业篇》读书笔记/" itemprop="url">
                  《软技能-代码之外的生存指南-职业篇》读书笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-06-30T22:48:16+08:00" content="2020-06-30">
              2020-06-30
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/06/30/《软技能-代码之外的生存指南-职业篇》读书笔记/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/06/30/《软技能-代码之外的生存指南-职业篇》读书笔记/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="职业"><a href="#职业" class="headerlink" title="职业"></a>职业</h3><p>该部分讲述程序员职业规划相关内容，比如对待工作的态度，长远的职业目标，同事间的相处之道，面试之道等等内容。核心点是如何获得更好的职业生涯。</p>
<h4 id="从非同凡响开始：绝不要做他人都在做的事"><a href="#从非同凡响开始：绝不要做他人都在做的事" class="headerlink" title="从非同凡响开始：绝不要做他人都在做的事"></a>从非同凡响开始：绝不要做他人都在做的事</h4><p><strong>他人都在做的事</strong>是指将工作视为一种不得不完成的任务来做。虽然公司是老板的，软件是公司的，但是职业生涯是你自己的。正确的做法是将每一份工作视为自己的事业，将软件作为自己的产品，将公司和老板想象为自己的客户，转变心态，变被动为主动。只有积极主动的人才可能获得更多的机会，从而获得更好的职业生涯。</p>
<h4 id="思考未来：你的目标是什么"><a href="#思考未来：你的目标是什么" class="headerlink" title="思考未来：你的目标是什么"></a>思考未来：你的目标是什么</h4><p>为自己的职业生涯设立至少一个远大的目标，比如十年后你会在哪里，做什么？这个目标不需要太具体，只要能给你指引大概的方向即可。在此基础上，还需要设置具体的小目标，比如每月需要读一本技术书籍，写两篇技术博客，具体到每天应该读几页等等内容，大目标指明方向，小目标督促你不断向大目标前行。</p>
<p>当然只是设置目标没有太大意义，更重要的完成这些目标，所以我们需要不断的追踪自己定下的这些目标，看看是否已正常完成，未完成的原因是什么，不断的优化和自省，找到最适合自己的节奏。</p>
<h4 id="人际交往能力：远比你想象的重要"><a href="#人际交往能力：远比你想象的重要" class="headerlink" title="人际交往能力：远比你想象的重要"></a>人际交往能力：远比你想象的重要</h4><p>软件开发并不只是和代码打交道，实际上我们大部分时间是在和人打交道。<strong>我只想一个人安静的写代码</strong>这种思想是罪恶的，人际交往能力比你想象的重要得多。</p>
<p>大部分人都希望自己能够被他人认可和尊重，所以如果你也想获得他人的认可和尊重，那么最好先认可和尊重他人。不要以贬低他人的方式来抬高自己，因为这要只会适得其反。更不要对他人进行批评，批评是一项很少能达成预期的工具，奖励才是最好的激励方式。</p>
<p>人际关系活动成功关键是换位思考，我和我想要什么并不重要，他人需要什么更重要，一次成功的沟通应该是了解对方的需求，然后将你想表达的内容以对方期望的形式传递出去。比如跟老板汇报工作时，太多的技术细节就不是一个好的选择，老板更期望听到的是整个前因后果。</p>
<p>避免争吵，因为争吵解决不了任何问题。虽然我们只是伪装成大人，将情绪隐藏起来的小孩。《人性的弱点》中说道：据我所知，普天之下解决争吵的灵丹妙药只有一个，那就是避免争吵，像避免响尾蛇和地震一样的远离争吵。</p>
<p>沟通和交流往往都是程序员的软肋和短板，根据木桶理论，恰恰是这些短板决定了人生的天花板。如果想获得一个更好的职业生涯，就要补强这些短板，有时候甚至必须强迫自己去做才行。</p>
<h4 id="破解面试之道"><a href="#破解面试之道" class="headerlink" title="破解面试之道"></a>破解面试之道</h4><p>书上这一章主要说的是打破常规的面试方法，通过获得与面试公司相关人员的联系，俗称<strong>混脸熟</strong>，来达到一条走捷径的面试之道。作为一个程序员，个人觉得还是真刀真枪的上吧，拼硬实力拿到的offer可能心里更踏实。当然运气也很重要。</p>
<p>结合自己的面试经验，个人总结面试成功与否主要有两点：面试前的准备和面试时的表达能力。面试前的准备过程可能会很长，特别是专业的技术细节方面，比如源码的实现原理等等，可能需要你始终保持学习的习惯，经常检测自己的知识体系是否出现盲区并及时补全。项目方面则应该将你最具有代表性的几个项目好好总结，具体到每个细节都要非常了解，从前期调研到线上数据，所用到的技术和难点及解决过程。</p>
<p>面试过程中的表达也很重要，对于常见的技术问题和项目介绍，我们应该尽量提前组织好语言，面对我们没有准备的问题，先不要着急回答，可以已提问的方式跟面试官多沟通，了解更多面试官想知道的问题的细节，同时也是为自己争取时间组织语言。</p>
<h4 id="就业选择：列出你的选择"><a href="#就业选择：列出你的选择" class="headerlink" title="就业选择：列出你的选择"></a>就业选择：列出你的选择</h4><p>本章主要介绍个人在职场中主要的三种角色：雇员，独立咨询师和创业者。</p>
<p>雇员的好处是稳定，轻松；缺点是没有自由，收入封顶，作为初入职场的人来说，雇员往往是一个比较好的选择，在积累足够的经验，人脉和财富以后，我们可以选择改变自己的角色。</p>
<p>独立咨询师是创业者的前期状态了，你已经准备开始为自己工作，你拥有更大的自由度和潜在的赚钱能力，但是你开始需要自己去寻找业务和客户，打理一切开销，为成为创业者打基础。</p>
<p>创业者应该是职场的终极目标了，只有优秀且有魄力的职场人士会选择创业，创业是风险和机遇并存的选择，需要创业者有一颗强大的心脏作为支撑，敏感且脆弱的人是不适合创业的。</p>
<p>以上三种角色不是一层不变，随着时间的推移和个人的发展，我们可能还在三者中间来回切换，不管是哪种角色，只有适合自己的才是最好的角色。但是有一个是共同的，那就是全力以赴。</p>
<h4 id="你是哪类软件开发人员"><a href="#你是哪类软件开发人员" class="headerlink" title="你是哪类软件开发人员"></a>你是哪类软件开发人员</h4><p>全栈开发很好，但是精通一个细分领域让你获得机会的可能性更大。因为专业化更重要，人们需要全才，更需要专才。这里作者的观点和我一样，比起了解更多的技术方向和语言，更好的建议是深入到某个细分的领域去，成为该领域的专家。即使这个领域以后不景气，凭借在该领域积累的经验，也能很快转到其他方向上去，因为计算机的姿势是相通的。</p>
<h4 id="公司与公司是不一样的"><a href="#公司与公司是不一样的" class="headerlink" title="公司与公司是不一样的"></a>公司与公司是不一样的</h4><p>小公司和创业公司关注业务增长，追求快速迭代，甚至已牺牲产品质量为代价，在这样的团队你可能会成为一个多面手，拥有快速解决问题的能力，你的影响会更大，责任也更大。在小公司你的上升机会更多，更辛苦同时回报可能更丰厚。</p>
<p>中等规模的公司比小公司稳定，甚至比大公司也稳定，保持业务的稳定是第一要素，这类公司不像小公司追求业务的快速增长，也不像大公司有一套规范的做事标准和足够的资金去探索新的领域，尝试新的技术。如果你追求稳定，这类公司是不错的选择。</p>
<p>大公司很规范，做事情一板一眼，按部就班。大部分人在大公司就是一颗小小的螺丝钉，只负责打理自己的一亩三分地。同时大公司提供了一个很好的学习平台，如果你热爱学习和专研，大公司会更适合你，你有足够的资源让自己成为某一领域的专家。</p>
<h4 id="攀登晋升阶梯"><a href="#攀登晋升阶梯" class="headerlink" title="攀登晋升阶梯"></a>攀登晋升阶梯</h4><p>在任何公司里能让你脱颖而出最重要的法宝就是承担更多的责任。更多的责任意味着更多的付出，一般付出和收获是成正比的。主动承担更多责任可以从以下几点着手：</p>
<ul>
<li>主动去负责一个不受重视的项目</li>
<li>帮助团队里面的新人快速成长</li>
<li>主动编写项目文档，并经常维护</li>
<li>那些没有人愿意去做的事情（可能会有很多坑，需要提前有思想准备）</li>
</ul>
<p>引入注目会让你更容易获得晋升的资格，这里更多介绍如何引起老板的注意：</p>
<ul>
<li>写一份亮眼的周报，除了叙述日常事务，最好加上自己的总结和思考</li>
<li>分享，分享不仅能让大家认识你，更重要的是你在这种压力下可能学到更多，百利无一害。</li>
</ul>
<p>持续不断的学习，增加自己的技能和知识，当你的水平在不断提高的时候，升职和加薪就会随之而来。</p>
<p>永远不要去做推脱问题的人，而要成为解决问题的人，你能解决别人无法解决或不愿意解决的问题，无论在哪家公司，你都能轻而易举的成为mvp。</p>
<p>不要在办公室政治上投入太多的精力。</p>
<h4 id="成为专业人士"><a href="#成为专业人士" class="headerlink" title="成为专业人士"></a>成为专业人士</h4><p>成为专业人士是一种心态。如果我们总是与恐惧，自毁，拖延和自我怀疑做斗争，那么问题就是：我们正在像外行那样思考问题。外行毫不起眼，外行人废话连篇，外行屈从于逆境。专业人士可不这么想。不管怎样，他引人注目，他恪尽职守，他始终如一。</p>
<p>专业人士会严肃对待自己的责任和事业，愿意做出艰难的选择去做自己认为正确的事情，同时承担起相应的代价。</p>
<p>成为专业人士的最基本原则就是养成良好的习惯，一切都始于习惯。坏习惯很难被打破，而新习惯又不容易养成，所以如果你养成了良好的习惯，那你就强于大部分的人，这比大部分人更专业。</p>
<p>坚守正道，坚持做自己认为正确的事情，不要被外行人的一些意见左右，除非那个人是老板。也就是培养自己说不的能力，知道什么时候应该说不，什么时候不要说不。能够说不的人，其实更专业。</p>
<p>追求品质，完善自我。不断提升自我的素养，是让你保持专业的秘诀。设置高质量的做事标准，要时刻谨记<strong>你做的每一件事就是你所做的一切</strong>，所谓代码无小事。 </p>
<h4 id="赢得自由-如何辞职"><a href="#赢得自由-如何辞职" class="headerlink" title="赢得自由-如何辞职"></a>赢得自由-如何辞职</h4><p>不要在冲动的时候做决定，辞职也是如此。可能因为公司的某些制度惹怒了你，让你很不爽，感觉在公司一秒都待不下去了，辞职的想法在你脑海中冒出来一次又一次，但是，我要提醒你，这个时候千万不要提辞职，给自己一个冷静下来的时间，考虑清楚辞职的代价你是否能承受，再做决定。</p>
<p>不要裸辞，这会让你找工作的过程背负更大的压力，适当的压力可以催人前进，但是压力过大会让人寸步难行。如果你想单干，确保已经预留了足够的资金支撑至少一年。而且最好是在已经有副业的前提下。</p>
<p>了解自己每天工作时长，8小时的正常工作时间里，你有多少时间是正在在做事，有多少时间又是在划水呢。对于以后要单干是一个很少的参考，因为单干的话，你会比现在工作更长的时间。</p>
<h4 id="成为自由职业者：开启自己的一片天地"><a href="#成为自由职业者：开启自己的一片天地" class="headerlink" title="成为自由职业者：开启自己的一片天地"></a>成为自由职业者：开启自己的一片天地</h4><p>万事开头难，如何迈出创业的第一步很重要。首先要有稳定的业务，可以先以副业的形成发展业务，待业务逐渐稳定后，就可以全职创业了。业务来源可以是朋友介绍，广告等，最好的形式是客户主动找上门，这就需要你有足够的个人影响力，后面还会专业介绍程序员如何营销自己。</p>
<p>自己创业该如何收费呢？这里也可以参考你最后一份工作的收入，然后平均到小时，如果你之前每小时50刀，那创业后至少需要100刀才能达到之前的收入水平，因为除了工资你还需要支付其他相关的开支。如果你有足够的影响力，业务多到做不完，那你的收费标准可以定得更高，高到客户开始还价为止。</p>
<h4 id="创建你的第一个产品"><a href="#创建你的第一个产品" class="headerlink" title="创建你的第一个产品"></a>创建你的第一个产品</h4><p>程序员创业有一个先天的优势，我们可以自己将想法编程一个产品而不用求助于他人。但是在实现你的想法之前，你应该先为自己的产品找到受众，当你的产品发布以后，哪些人会去使用呢？我们不可能在初期就去打造一个适合所有人的产品，所以我们需要进入细分领域，首先在该领域寻找客户，站稳脚跟，再考虑扩张问题。</p>
<p>找到受众后，我们可以开始进行市场测试，投放一些广告，然后发布一个demo级别的产品，看看市场反应如何，最重要的是前期的用户反馈，这些信息比用户本身更为宝贵，我们需要根据用户反馈调整产品结构，当然我们不可能满足所有用户的需求，做到尽量覆盖大部分的用户即可。</p>
<p>最后是风险提醒，创业失败的可能性太大，在你的产品用户可观的数据量前，尽量不要all in，如上面提到的，可以先已副业的形式开始你的创业之路，同时去学习如何成为一个创业者，在你拥有了创业的理论基础和可观的用户积累后，就可以迈出下一步。</p>
<h4 id="你打算创业吗"><a href="#你打算创业吗" class="headerlink" title="你打算创业吗"></a>你打算创业吗</h4><p>大部分程序员应该都有过自己创业的想法冒出，特别是当你脑海中有了一个点子，创业的冲动会从你脑中呼之欲出，只是迫于现实的约束，很多人最终放弃，选择更为稳定的生活。在上面也提到过，其实很多人并不适合创业，创业者需要一颗大心脏，同时还要极具冒险精神，要有激情和干劲，这些都是很难拥有的品质。</p>
<p>创业公司一般分为两种，一种是在创业初始就试图以获取外部投资来刺激公司的快速发展，通过不断的融资来提升公司的估值，不会优先考虑赢利问题，获取更多用户和市场规模在他们看来更为重要，因为这些数据就是他们下一次融资的资本。还有一种公司则自力更生，他们在创业初期可能就已经赢利，这类公司规模会更小，失败风险也更低，当然发展也会比较缓慢。</p>
<p>在创业前，想好退路也是很重要的，如果公司成功上市或者被收购，你又会在哪里，有的创业者可能希望创建一家百年老店，但是投资人可不这么想，他们希望更快的实现盈利，套现离场。这也是一些创业公司不去寻求融资的原因，资本市场就像催化剂，会快速的将你的公司催熟，如果公司过于早熟，等到资本退场后，可能迎接你的就是失败了。</p>
<p>如果你在创业初期能够加入一家孵化器，那将对你的公司发展起到很好的促进作用，特别是你是第一次创业的话。孵化器不仅可以为你的创业提供指导意见，还能帮你和投资人建立联系。</p>
<p>获取投资意味着你要放弃公司的部分股权，甚至牺牲大部分股权，失去对公司的管理权，当然资本也能帮助你更好的发展公司，获得投资的公司更容易成功。</p>
<h4 id="远程工作的生存策略"><a href="#远程工作的生存策略" class="headerlink" title="远程工作的生存策略"></a>远程工作的生存策略</h4><p>随着这次疫情的影响，远程办公也越来越流行起来，但是远程办公并没有想象的那么美好，下面介绍的是远程办公的一些弊端。</p>
<p>个人的时间管理问题。作者的建议是即使是远程办公，也最好将作息时间和在公司办公时保持一致，这样才能保持相同的状态。</p>
<p>自我激励问题。每个人都会有惰性，可能在公司班上时，环境不允许你释放自己的惰性，但是远程办公，在没有其他人监督之下，惰性更容易产生。当然如果你是一个严格自律的人，可以很好的控制自己的行为，可能不必太担心这个问题。</p>
<p>远程办公伴随而来的孤独感。远程办公减少了不必要的沟通，但也剥夺了很多必要的沟通。如果你感到孤独，好的建议就是走出去，多和他人交流，约一些朋友一起小聚。</p>
<h4 id="假装自己能成功"><a href="#假装自己能成功" class="headerlink" title="假装自己能成功"></a>假装自己能成功</h4><p>这种自我暗示很重要，对于我们不能掌控的事情，我们必须这样暗示自己，然后全力以赴的去接受挑战。<br>每个人在面对未知的时候都会恐惧，克服这种恐惧的方法之一就是自我暗示，短暂的麻痹自己。不管做什么事情，心态都是至关重要的，乐观积极的心态会让你更容易成事。</p>
<h4 id="单调乏味的简历-如何修改"><a href="#单调乏味的简历-如何修改" class="headerlink" title="单调乏味的简历-如何修改"></a>单调乏味的简历-如何修改</h4><p>最近看了一位UI同学的简历，设计排版，图表，文案都做的特别漂亮，看着就很高大上，给人一种很厉害的感觉，这就是简历的作用。相比之前，技术同学的简历就逊色好多，很多人连自己的工作内容都无法描述清楚，更不用说自己所擅长的技术和优势了。</p>
<p>技术的简历虽然不需要太花哨，但是吸引眼球的东西一样要有。不需要泛泛而谈，将项目中的核心业务和技术点列出来即可，如果你还有比较擅长的领域就会更加分。比较常用的写简历的原则即STAR，能够帮助你很好的梳理自己的项目经历，并突出重点内容，吸引到面试官的注意力。</p>
<h4 id="请勿陷入对技术的狂热之中"><a href="#请勿陷入对技术的狂热之中" class="headerlink" title="请勿陷入对技术的狂热之中"></a>请勿陷入对技术的狂热之中</h4><p>每一项技术都有它适用的场景和局限，没有必须因为自己不使用不了解就去贬低，或者因为自己正在用就去吹捧，还是应该辩证的看待技术，php到底是不是最好的语言这个话题真的没有任何意义，除了会掀起口水战。</p>
<p>面对技术我们应该做一个“拿来主义者”，需要的时候就用，不需要的时候就放到一边，要记住：技术本身只是一种工具。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/06/13/《程序员修炼之道-通向务实的最高境界（第二版）》/" itemprop="url">
                  《程序员修炼之道-通向务实的最高境界（第二版）》
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-06-13T14:44:53+08:00" content="2020-06-13">
              2020-06-13
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/06/13/《程序员修炼之道-通向务实的最高境界（第二版）》/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/06/13/《程序员修炼之道-通向务实的最高境界（第二版）》/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="人生是你自己的"><a href="#人生是你自己的" class="headerlink" title="人生是你自己的"></a>人生是你自己的</h4><p>如果你觉得当前的工作状况很糟糕，为什么不去尝试改变呢，如果你既不能改变环境，也不想改变自己，为什么不换一个环境呢？</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/08/直播项目总结/" itemprop="url">
                  直播项目总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-05-08T20:04:34+08:00" content="2020-05-08">
              2020-05-08
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/05/08/直播项目总结/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/05/08/直播项目总结/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="iOS音视频播放总结"><a href="#iOS音视频播放总结" class="headerlink" title="iOS音视频播放总结"></a>iOS音视频播放总结</h4><p>iOS音视频播放器主要分系统播放器和三方播放器，系统播放器以AVPlayer应用最为方便和广泛，三方播放器以IJK+FFMPEG使用作为常见。在直播项目中，很少有使用AVPlayer做拉流播放器的，因为AVPlayer不支持常见的推流协议RTMP，虽然AVPlayer支持苹果自家的HLS协议，但该协议在直播时延迟很高，一般不采用，只会在点播的时候采用。直播中常用的则是IJK+FFMPEG作为播放器。实际上FFMPEG本身并不具备播放视频的能力，它是一个音视频的编解码器，在iOS一个典型的播放流程中，会先使用FFMPEG对音视频进行解码，音频数据被解码为PCM，视频数据被解码为NSData(luma,chromaB,chromaR),解码数据被保存在缓冲区，会有一个音视频同步器去决定当前需要播放的数据，将音频数据丢给音频播放器（一般是AUGraph+AudioUnit）,视频数据丢给视频播放器（OPENGLES）。</p>
<p>RTMP是一种直播流的传输协议，主要有BaseHeader,MessageHeader,ExtendedTimestamp和ChunkData四部分组成，其中BaseHeader中的type又决定了MessageHeader的类型，主要有4类。Type = 0时是完整数据，说明该数据帧是IDR或者I帧数据，应该是一个Gop的第一帧。其他type则代表p,b帧等数据。ExtendedTimestamp是扩展时间戳，只会在MessageHeader存储不下时间戳时才会有数据。扩展时间戳里面存的是完整的绝对时间，而MessageHeader里面存的是减去时间戳或时间差值。ChunkData里面存的就是被编码的音视频数据了，H.264使用NAL Uint来标示具体的一帧数据，可能是SPS（序列参数集），PPS（图像参数集）I，P，B帧等。一系列的NAL Uint组成一个GoP,当摄像头静止时，GoP可能会很长，而在运动中时，GoP应该尽量短，保证视频数据完整性。在提高直播秒开率上面，我们也需要从GoP上去做文章，如果GoP太长，当前连接的用户可能因为错过I帧而导致长时间等待的情况，解决这个问题的一种方案是服务器对上一个GoP做一个缓冲，有新用户连接时先推这个缓存的GoP,不过这种方案不太适合对延迟很敏感的场景，其他方案就是怎么去合适的设置GoP之间的时间间隔。</p>
<p>一个完整的音视频播放器应该有以下几个模块：文件存取模块，解码模块，音视频同步模块，音频播放模块，视频播放模块，完整播放器模块（对以上模块的封装）。其中，文件存取主要用来拉取数据和缓存数据，比如我们如果使用硬解的话，就需要先使用Http协议中的Get方法拉取到数据，然后对数据进行解析和分发，其中如果我们还想实现边播边缓存的功能，还需要将数据缓存到本地。解码模块主要对数据进行解码，一般会新启一个解码线程，解码线程会是一个常驻线程，解码器内部会缓存以下数据：已解码音频列表，已解码视频列表，当前已解码未播放总时长，当已解码未播放总时长大于解码器的最大阈值，解码线程会被阻塞暂停解码以节约资源，当已解码未播放时长小于了最小阈值，解码器会抛出卡顿。音视频同步模块实际上控制了整个播放器的播放流程，比较常见的同步方案是使用音频的时间戳去同步视频的时间戳，因为人对音频比对视频更敏感，既先播放音频，然后用音频的当前进度从视频缓存列表中找到合适的帧进行播放。如果视频列表中有旧数据，还需要将旧数据移除，如果没有合适的数据，则继续展示上一帧的数据。音频播放模块负责播放音频，这里解码出来的就是PCM数据，每一个PCM的采样默认是2个字节的大小，音频通常还会有多个声道，我们需要计算出一个packet的总的字节数，才能够正常的播放数据，按一个packet里面只有一帧，每一帧里面有一个双声道来计算的话，一个packet的size就是4字节32bit。还有一点需要注意的是音频的数据存放有2种方式，既线性存放和交叉存放。线性存放时，每一个声道的数据是分开的，都只有2个字节。当交叉存放时，两个声道的数据会合并到一个声道，该声道的字节数会变成4个字节。视频播放模块主要负责视频数据的播放，一帧视频数据也就是一张图片，如果是使用的硬件解码，我们可以直接将编码数据转成CVImageBuffer,如果是使用FFMPEG解码，我们还需要手动的将YUV数据转成CVImageBuffer,然后丢给OpenGLES去渲染。</p>
<h4 id="播放器优化部分总结"><a href="#播放器优化部分总结" class="headerlink" title="播放器优化部分总结"></a>播放器优化部分总结</h4><h5 id="秒开优化"><a href="#秒开优化" class="headerlink" title="秒开优化"></a>秒开优化</h5><h5 id="卡顿优化"><a href="#卡顿优化" class="headerlink" title="卡顿优化"></a>卡顿优化</h5><h4 id="对直播间整体架构的思考"><a href="#对直播间整体架构的思考" class="headerlink" title="对直播间整体架构的思考"></a>对直播间整体架构的思考</h4><h5 id="视图层级"><a href="#视图层级" class="headerlink" title="视图层级"></a>视图层级</h5><p>根据具体业务可以拆分出不同的业务层视图，比如常驻功能层，礼物层，弹幕层，活动层等。层的优先级可以预先和运用，产品约定好，根据业务重要程度确定优先级，保证高优的业务在上层，避免视图叠加导致的遮挡。<br>同层视图之间则应避免叠加，每层可按实践业务情况进行功能区的划分，保证各功能区互不干扰，各司其职。<br>同时，我们要保证各层的点击事件不被其他层影响，在处理完自己的事件后，应将该事件抛给下一层。<br>以上层级拆分的好处是如果有新的视图需要被添加到直播间时，可以很方便的添加到正确的坐标上。维护行和扩展性都比较好。</p>
<h5 id="弹窗"><a href="#弹窗" class="headerlink" title="弹窗"></a>弹窗</h5><p>弹窗的触发时机一直是比较头疼的问题，特别是有多个弹窗需要同时展示时，处理不好的话就会出现弹窗叠加的现象，影响用户体验。这里借鉴线程的调度策略，思考出一种弹窗展示逻辑，使用队列和优先级对弹窗进行管理，比如首页弹窗队列，直播间弹窗队列等，每个弹窗又会有（高中低）不同的优先级和一些依赖关系等（比如需要登录）。这个方案的难点在于调度这些队列的时机和方式，这个我们可以参考iOS的runloop的实现机制，每一种队列可以抽象为一种mode,当程序在直播间时，运行在直播间的mode下，既只对直播间的队列进行调度，当程序在首页时，运行在首页mode下，只对首页的队列进行调度，如果是全局的弹窗，则可以添加到这两种队列中，当然全局弹窗还需要在展示完成后对可能存在其他队列中的相同对象进行移除，这样既能保证该弹窗不会被阻塞，又解决了可能重复弹出的问题。</p>
<h5 id="直播间模块通信"><a href="#直播间模块通信" class="headerlink" title="直播间模块通信"></a>直播间模块通信</h5><p>由于直播间相关模块众多，代码肯定不可能都堆放在一起，会按业务模块或者功能模块进行封装，这时模块之间的通信就是一个问题，如果靠block和delegate去传递的话，层级可能会非常深，导致传递的链条会很长，出现大量重复代码。解决这个问题我们可以反向去思考，模块间的相互调用实际上就是获取其他模块的某种能力，那么我们可以把常用的一些能力（发送弹幕，送礼，点赞等）抽象为一种服务（server），然后在调度程序里面注册这些服务，同时我们需要去维护一个服务列表，其他模块如果需要某种服务，只需要通过调度程序添加这个服务到服务列表既可，对服务列表的调度会在调度程序内部去进行，不需要暴露给外界。这种方案的好处是解耦了各业务模块的依赖，简化了模块间的调用关系，方便代码的扩展。坏处是代码调试的关系链被断掉了，需要花更多的时间去理解代码逻辑和进行代码调试。</p>
<h5 id="直播间大礼物播放方案"><a href="#直播间大礼物播放方案" class="headerlink" title="直播间大礼物播放方案"></a>直播间大礼物播放方案</h5><p>礼物系统是直播的重要部分，也是可能出现性能瓶颈的一个点，选取好的礼物播放方案对用户体验的提升有关键作用。礼物播放方案的优劣主要从cpu，memory和礼物资源大小这三方面去评价。目前比较常用的方案中直接使用序列帧去播放实现最简单，性能消耗和礼物资源也是最大，不是最优解。YYUED出品的SVGA使用Protobuf对数据进行编解码，所以礼物资源本身很小，礼物展示使用CALayer+多线程异步图片解码的方案使得cpu和memory的消耗都很小，是比较理想的实现方案，不过svga礼物对粒子的支持不太好。还有一种综合实力最优的方案是使用视频进行礼物的展示，该方案性能较好，支持多种礼物类型，礼物文件也很小，实现也不太复杂（基于GPUImage）。</p>
<h5 id="直播间性能监控"><a href="#直播间性能监控" class="headerlink" title="直播间性能监控"></a>直播间性能监控</h5><p>直播间性能主要从推拉流播放器，设备性能指标和网络情况三方面来考量。播放器主要关注码率，延迟，卡顿，分辨率和帧率信息。设备性能有cpu使用率，内存情况，fps，电量几个方面。网络情况有ping，metrics和带宽。对于出现性能问题的设备，我们就可以根据上面这些指标的数据去定位可能的性能瓶颈，比如对于较低端的设备，可以适当降低推拉流的码率，帧率和分辨率，首先保证数据能正常传输。当设备性能出现瓶颈时，我们也可以根据设备出一套适配策略，将直播间比较消耗性能的模块做“降级”处理,比如减小礼物资源的分辨率和帧率，阉割部分直播间特效。对于出现网络瓶颈的用户，我们可以建议切换网络等。有一点要明确的是我们获取这些性能指标数据的作用就是为了更好的为用户服务，当用户有反馈性能问题的时候，我们能够及时的帮助定位和解决问题，增加用户好感度和粘性。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/05/06/MBP搭建本地Https服务器实现ipa文件的下载/" itemprop="url">
                  MBP搭建本地Https服务器实现ipa文件的下载
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-05-06T20:02:59+08:00" content="2020-05-06">
              2020-05-06
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/05/06/MBP搭建本地Https服务器实现ipa文件的下载/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/05/06/MBP搭建本地Https服务器实现ipa文件的下载/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h4 id="起因"><a href="#起因" class="headerlink" title="起因"></a>起因</h4><p>2020年新春，本是阖家欢乐，走亲访友的好时节。没想到一场疫情改变了所有计划，本人刚好又处于风暴的中心湖北，按时返京是不太可能了，于是只得开启漫长的在家办公的旅程。回家时带了个mbp，没有带TypeC的装接头，没有办法真机调试，而我们的项目又不能在模拟器上运行，这样的工作环境想想就头大。只能是硬着头皮使用打包上传fir的方式进行开发和调试，但是村里的网络也不太给力，可能一次打包上传再到安装在真机上需要一个多小时，效率实在太低，于是开始思考有啥办法可能提高现在的效率，也就有了下面的实践经历。</p>
<h4 id="经过"><a href="#经过" class="headerlink" title="经过"></a>经过</h4><h5 id="安装nginx"><a href="#安装nginx" class="headerlink" title="安装nginx"></a>安装nginx</h5><p>我是使用的nginx来搭建的https服务，因为之前也用它搭过rtmp服务，使用起来会比较顺手吧。推荐使用homebrew来安装。</p>
<p>安装完后使用一下命令来进行nginx的相关操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">sudo nginx //启动Nginx</div><div class="line">sudo nginx -s reload //重启Nginx</div><div class="line">sudo nginx -s stop //快速停止Nginx</div></pre></td></tr></table></figure>
<p>开启nginx成功后，在Safari里面输入<a href="http://127.0.0.1" target="_blank" rel="noopener">http://127.0.0.1</a> 应该就能正常访问到nginx自带的一个html了，接下来是支持https。</p>
<h5 id="安装openssl"><a href="#安装openssl" class="headerlink" title="安装openssl"></a>安装openssl</h5><p>生成证书时需要使用openssl服务。同上，使用homebrew安装。</p>
<h5 id="生成证书"><a href="#生成证书" class="headerlink" title="生成证书"></a>生成证书</h5><p>推荐使用下面的脚本来生成：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">cd /usr/local/etc/nginx # 进入希望生成证书和私钥的目录，这里我们选择nginx.conf所在目录</div><div class="line">openssl genrsa -des3 -out 172.20.10.9.key 1024   # 创建服务器私钥，该命令会让你输入一个口令</div><div class="line">openssl req -new -key 172.20.10.9.key -out 172.20.10.9.csr    # 创建签名请求的证书(CSR)</div><div class="line">cp 172.20.10.9.key 172.20.10.9.key.org    </div><div class="line">openssl rsa -in 172.20.10.9.key.org -out 172.20.10.9.key  # 在加载SSL支持的Nginx并使用上述私钥时除去必须的口令</div><div class="line">openssl x509 -req -days 365 -in 172.20.10.9.csr -signkey 172.20.10.9.key -out 172.20.10.9.crt  # 最后标记证书使用上述私钥和CSR</div></pre></td></tr></table></figure>
<p>每一句的具体作用参考上面的注释，这里的<strong>172.20.10.9</strong>是我电脑的内网IP，用来做证书名方便识别，在生成证书时，会需要输入密码和一些企业信息，其他的信息都可以随意（密码需要一致），<strong>重点：有一个Common Name字段信息需要和你服务器地址（我这里也就是我的内网IP）保持一致，因为在下载ipa进行证书校验时需要校验这两个是否一致，如果不一致会报：无法连接到“xxx”的错误</strong></p>
<p>下面是openssl生成几个文件</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/nginxipa/nginxopenssl.png" alt=""></p>
<h5 id="配置nginx-conf"><a href="#配置nginx-conf" class="headerlink" title="配置nginx.conf"></a>配置nginx.conf</h5><p>nginx.conf目录地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">/usr/local/etc/nginx</div></pre></td></tr></table></figure>
<p>具体配置项参考如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">#user  nobody;</div><div class="line">worker_processes  1;</div><div class="line"></div><div class="line">#error_log  logs/error.log;</div><div class="line">#error_log  logs/error.log  notice;</div><div class="line">#error_log  logs/error.log  info;</div><div class="line"></div><div class="line">#pid        logs/nginx.pid;</div><div class="line"></div><div class="line"></div><div class="line">events &#123;</div><div class="line">    worker_connections  1024;</div><div class="line">&#125;</div><div class="line"></div><div class="line"></div><div class="line">http &#123;</div><div class="line">    include       mime.types;</div><div class="line">    default_type  application/octet-stream;</div><div class="line"></div><div class="line">    #log_format  main  &apos;$remote_addr - $remote_user [$time_local] &quot;$request&quot; &apos;</div><div class="line">    #                  &apos;$status $body_bytes_sent &quot;$http_referer&quot; &apos;</div><div class="line">    #                  &apos;&quot;$http_user_agent&quot; &quot;$http_x_forwarded_for&quot;&apos;;</div><div class="line"></div><div class="line">    #access_log  logs/access.log  main;</div><div class="line"></div><div class="line">    sendfile        on;</div><div class="line">    #tcp_nopush     on;</div><div class="line"></div><div class="line">    #keepalive_timeout  0;</div><div class="line">    keepalive_timeout  65;</div><div class="line"></div><div class="line">    #gzip  on;</div><div class="line"></div><div class="line">    server &#123;</div><div class="line"></div><div class="line">		listen       443 ssl;</div><div class="line">        server_name  localhost	;</div><div class="line"></div><div class="line">        ssl_certificate      172.20.10.9.crt;</div><div class="line">        ssl_certificate_key  172.20.10.9.key;</div><div class="line"></div><div class="line">        #charset koi8-r;</div><div class="line"></div><div class="line">        #access_log  logs/host.access.log  main;</div><div class="line"></div><div class="line">        location / &#123;</div><div class="line">            root   /usr/local/etc/nginx/doki;</div><div class="line">            index  download.html index.htm;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        #error_page  404              /404.html;</div><div class="line"></div><div class="line">        # redirect server error pages to the static page /50x.html</div><div class="line">        #</div><div class="line">        error_page   500 502 503 504  /50x.html;</div><div class="line">        location = /50x.html &#123;</div><div class="line">            root   html;</div><div class="line">        &#125;</div><div class="line"></div><div class="line">        # proxy the PHP scripts to Apache listening on 127.0.0.1:80</div><div class="line">        #</div><div class="line">        #location ~ \.php$ &#123;</div><div class="line">        #    proxy_pass   http://127.0.0.1;</div><div class="line">        #&#125;</div><div class="line"></div><div class="line">        # pass the PHP scripts to FastCGI server listening on 127.0.0.1:9000</div><div class="line">        #</div><div class="line">        #location ~ \.php$ &#123;</div><div class="line">        #    root           html;</div><div class="line">        #    fastcgi_pass   127.0.0.1:9000;</div><div class="line">        #    fastcgi_index  index.php;</div><div class="line">        #    fastcgi_param  SCRIPT_FILENAME  /scripts$fastcgi_script_name;</div><div class="line">        #    include        fastcgi_params;</div><div class="line">        #&#125;</div><div class="line"></div><div class="line">        # deny access to .htaccess files, if Apache&apos;s document root</div><div class="line">        # concurs with nginx&apos;s one</div><div class="line">        #</div><div class="line">        #location ~ /\.ht &#123;</div><div class="line">        #    deny  all;</div><div class="line">        #&#125;</div><div class="line">    &#125;</div><div class="line"></div><div class="line"></div><div class="line">    # another virtual host using mix of IP-, name-, and port-based configuration</div><div class="line">    #</div><div class="line">    #server &#123;</div><div class="line">    #    listen       8000;</div><div class="line">    #    listen       somename:8080;</div><div class="line">    #    server_name  somename  alias  another.alias;</div><div class="line"></div><div class="line">    #    location / &#123;</div><div class="line">    #        root   html;</div><div class="line">    #        index  index.html index.htm;</div><div class="line">    #    &#125;</div><div class="line">    #&#125;</div><div class="line"></div><div class="line"></div><div class="line">    # HTTPS server</div><div class="line">    #</div><div class="line"></div><div class="line">    #server &#123;</div><div class="line">    #    listen       443 ssl;</div><div class="line">    #    server_name  localhost;</div><div class="line"></div><div class="line">    #   ssl_certificate      server.crt;</div><div class="line">    #    ssl_certificate_key  cert.key;</div><div class="line"></div><div class="line">    #    ssl_session_cache    shared:SSL:1m;</div><div class="line">    #    ssl_session_timeout  5m;</div><div class="line"></div><div class="line">    #    ssl_ciphers  HIGH:!aNULL:!MD5;</div><div class="line">    #    ssl_prefer_server_ciphers  on;</div><div class="line"></div><div class="line">    #    location / &#123;</div><div class="line">    #        root   html;</div><div class="line">    #        index  index.html index.htm;</div><div class="line">    #    &#125;</div><div class="line">    #&#125;</div><div class="line">    include servers/*;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>需要注意一下，上面的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">ssl_certificate      172.20.10.9.crt;</div><div class="line">ssl_certificate_key  172.20.10.9.key;</div></pre></td></tr></table></figure>
<p>就是你之前使用openssl生成的证书和私钥。这个要保持一致，而且最好放在同一个目录下。</p>
<h5 id="新建下载页html-配置plist-复制ipa文件和crt文件到指定目录。"><a href="#新建下载页html-配置plist-复制ipa文件和crt文件到指定目录。" class="headerlink" title="新建下载页html,配置plist,复制ipa文件和crt文件到指定目录。"></a>新建下载页html,配置plist,复制ipa文件和crt文件到指定目录。</h5><p>上面配置的location就是你的网页资源所有在的目录：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">location / &#123;</div><div class="line">    root   /usr/local/etc/nginx/doki;</div><div class="line">    index  download.html index.htm;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>这里我是在nginx目录下新建了一个doki（名字无要求）目录。可以参考一下我的目录结构：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/nginxipa/dokiipa.png" alt=""></p>
<p>然后我们分别来看一下这几个文件的格式：</p>
<p>html:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">&lt;!DOCTYPE html PUBLIC &quot;-//W3C//DTD XHTML 1.0 Transitional//EN&quot; &quot;http://     www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd&quot;&gt;</div><div class="line">&lt;html xmlns=&quot;http://www.w3.org/1999/xhtml&quot;&gt;</div><div class="line">&lt;head&gt;</div><div class="line">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;</div><div class="line">&lt;title&gt;DokoDokiLive&lt;/title&gt;</div><div class="line">&lt;/head&gt;</div><div class="line">&lt;body&gt;</div><div class="line">&lt;h1 style=&quot;font-size:40pt&quot;&gt;iOS应用OTA安装&lt;h1/&gt;</div><div class="line">&lt;h1 style=&quot;font-size:40pt&quot;&gt;</div><div class="line">&lt;a title=&quot;iPhone&quot; href=&quot;itms-services://?action=download-manifest&amp;url=https://172.20.10.9/DokiDokiLive.plist&quot;&gt;点击安装&lt;/a&gt;</div><div class="line">&lt;h1/&gt;</div><div class="line">&lt;a title=&quot;iPhone&quot; href=&quot;https://172.20.10.9/172.20.10.9.crt&quot;&gt;ssl 证书安装&lt;/a&gt;</div><div class="line">&lt;h1/&gt;</div><div class="line">&lt;/body&gt;</div><div class="line">&lt;/html&gt;</div></pre></td></tr></table></figure>
<p>plist:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</div><div class="line">&lt;!DOCTYPE plist PUBLIC &quot;-//Apple//DTD PLIST 1.0//EN&quot; &quot;http://www.apple.com/DTDs/PropertyList-1.0.dtd&quot;&gt;</div><div class="line">&lt;plist version=&quot;1.0&quot;&gt;</div><div class="line">&lt;dict&gt;</div><div class="line">	&lt;key&gt;items&lt;/key&gt;</div><div class="line">	&lt;array&gt;</div><div class="line">		&lt;dict&gt;</div><div class="line">			&lt;key&gt;assets&lt;/key&gt;</div><div class="line">			&lt;array&gt;</div><div class="line">				&lt;dict&gt;</div><div class="line">					&lt;key&gt;kind&lt;/key&gt;</div><div class="line">					&lt;string&gt;software-package&lt;/string&gt;</div><div class="line">					&lt;key&gt;url&lt;/key&gt;</div><div class="line">					&lt;string&gt;https://172.20.10.9/DokiDokiLive.ipa&lt;/string&gt;</div><div class="line">				&lt;/dict&gt;</div><div class="line">			&lt;/array&gt;</div><div class="line">			&lt;key&gt;metadata&lt;/key&gt;</div><div class="line">			&lt;dict&gt;</div><div class="line">				&lt;key&gt;title&lt;/key&gt;</div><div class="line">				&lt;string&gt;DokiDoki App download&lt;/string&gt;</div><div class="line">				&lt;key&gt;bundle-version&lt;/key&gt;</div><div class="line">				&lt;string&gt;1.0.0&lt;/string&gt;</div><div class="line">				&lt;key&gt;kind&lt;/key&gt;</div><div class="line">				&lt;string&gt;software&lt;/string&gt;</div><div class="line">				&lt;key&gt;bundle-identifier&lt;/key&gt;</div><div class="line">				&lt;string&gt;com.xxx.xxx&lt;/string&gt;</div><div class="line">			&lt;/dict&gt;</div><div class="line">		&lt;/dict&gt;</div><div class="line">	&lt;/array&gt;</div><div class="line">&lt;/dict&gt;</div><div class="line">&lt;/plist&gt;</div></pre></td></tr></table></figure>
<p>把上面的IP地址和bundle-identifier做相应的替换即可。</p>
<h4 id="成果"><a href="#成果" class="headerlink" title="成果"></a>成果</h4><p>reload一下nginx,然后在手机Safari上输入<a href="https://172.20.10.9" target="_blank" rel="noopener">https://172.20.10.9</a> 这个时候可能会提示网站安全，选择查看网站内容，出现下面的界面，说明环境搭建成功。</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/nginxipa/download.PNG" alt=""></p>
<p>先安装ssl证书，记得在设置中信任证书（有两处地方需要信任），然后点击安装即可。</p>
<h4 id="结尾"><a href="#结尾" class="headerlink" title="结尾"></a>结尾</h4><p>通过搭建本地服务，省去了上传fir的操作，局域网下载ipa速度也比从fir上下载快很多，之前重新安装一个包需要1个多小时的，现在只要十分钟不到就搞定了，所以，遇到问题还是应该多思考，争取能找到更好的解决方案。</p>
<h4 id="后续"><a href="#后续" class="headerlink" title="后续"></a>后续</h4><p>原来可以直接把IPA文件通过AirDrop的方式安装到手机上，以上的步骤都可以省略了。不过也是一次好的学习经验。</p>
<p>参考文档：</p>
<p><a href="https://www.jianshu.com/p/75f01a638a07" target="_blank" rel="noopener">https://www.jianshu.com/p/75f01a638a07</a><br><a href="https://blog.csdn.net/shuaihj/article/details/49999529" target="_blank" rel="noopener">https://blog.csdn.net/shuaihj/article/details/49999529</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2020/01/04/iOS基于GPUImage带Alpha的mp4播放方案/" itemprop="url">
                  iOS基于GPUImage带Alpha的mp4播放方案
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2020-01-04T16:26:00+08:00" content="2020-01-04">
              2020-01-04
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2020/01/04/iOS基于GPUImage带Alpha的mp4播放方案/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2020/01/04/iOS基于GPUImage带Alpha的mp4播放方案/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>mp4本身并不带透明通道，使用普通的视频播放器（比如AVPlayerLayer）只能播放一个不透明的视频，如果我们需要播放带透明度的视频（比如直播中的大礼物动画），就需要自己去写一个视频播放器。</p>
<h4 id="原理"><a href="#原理" class="headerlink" title="原理"></a>原理</h4><p>基于OPENGLES的渲染流程，我们拿到视频每一帧的数据，即每个像素的RGB值，然后再拿到该像素点对应的Alpha值，组成一个新的RGBA，通过shader渲染成新的视频。这里的关键点在怎么将每个像素的Alpha值传给shader,这里采用的方式是在导出视频的时候导出两个视频，一个正常导出，另一个只导出透明度，同时为了避免取值的时候不同步，再将这两个视频合成为一个视频。最后播放的视频可能长下面这样：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/GPUImage播放透明视频/9muuy-6x9z7.gif" alt=""></p>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>GPUImage提供了很多的Filter，但是都不太满足这里的需求，所有需要自定义一个Filter,核心代码如下：</p>
<h5 id="shader"><a href="#shader" class="headerlink" title="shader"></a>shader</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">NSString *const kGPUImageVideoAlphaShaderString = SHADER_STRING</div><div class="line">(</div><div class="line"> </div><div class="line"> varying highp vec2 textureCoordinate;//这个对应下面的ST坐标,即右边视频的坐标</div><div class="line"> uniform sampler2D inputImageTexture;//这个是完整视频的纹理</div><div class="line"> </div><div class="line"> const lowp vec2 leftW = vec2(-0.5,0.0);</div><div class="line"> </div><div class="line"> void main()</div><div class="line"> &#123;</div><div class="line">     //从右边的视频中拿RGB值，从左边的视频中拿Alpha值，然后返回一个新的RGBA.</div><div class="line">     lowp vec4 rightTextureColor = texture2D(inputImageTexture, textureCoordinate);</div><div class="line">     lowp vec2 leftTextureCoordinate = leftW + textureCoordinate;</div><div class="line">     lowp vec4 leftTextureColor = texture2D(inputImageTexture, leftTextureCoordinate);</div><div class="line">     gl_FragColor = vec4(rightTextureColor.rgb,leftTextureColor.r);</div><div class="line"> &#125;</div><div class="line"> );</div></pre></td></tr></table></figure>
<h5 id="opengl相关设置"><a href="#opengl相关设置" class="headerlink" title="opengl相关设置"></a>opengl相关设置</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">- (void)renderToTextureWithVertices:(const GLfloat *)vertices textureCoordinates:(const GLfloat *)textureCoordinates;</div><div class="line">&#123;</div><div class="line">    </div><div class="line">    static const GLfloat posVertices[] = &#123;</div><div class="line">        // x , y</div><div class="line">        -1, 1,</div><div class="line">        1, 1,</div><div class="line">        -1, -1,</div><div class="line">        1, -1,</div><div class="line">    &#125;;</div><div class="line">    static const GLfloat textVertices[] = &#123;</div><div class="line">        // s , t</div><div class="line">        0.5, 1.0,</div><div class="line">        1.0, 1.0,</div><div class="line">        0.5, 0.0,</div><div class="line">        1.0, 0.0</div><div class="line">    &#125;;</div><div class="line"></div><div class="line">    // 向缓冲区对象写入刚定义的顶点数据</div><div class="line">    glEnable(GL_BLEND);</div><div class="line">    glBlendFunc(GL_SRC_ALPHA, GL_ONE_MINUS_SRC_ALPHA);</div><div class="line">//    glBlendFunc(GL_ONE, GL_ZERO);</div><div class="line">    </div><div class="line">    [super renderToTextureWithVertices:posVertices textureCoordinates:textVertices];</div><div class="line">    </div><div class="line">    glDisable(GL_BLEND);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ST坐标这里，我们只取右边的部分进行展示，然后就是需要设置GL_BLEND和glBlendFunc的透明度混合模式，这里的模式有很多种，每个模式的具体含义参考<a href="https://www.cnblogs.com/ylwn817/archive/2012/09/07/2675285.html" target="_blank" rel="noopener">这篇文章</a></p>
<h4 id="播放"><a href="#播放" class="headerlink" title="播放"></a>播放</h4><p>播放的代码比较简单，可以参考下面的demo,最后的播放效果大概是这样：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/GPUImage播放透明视频/pvert-k93lw.gif" alt=""></p>
<p><a href="https://github.com/lilingyu0620/LLYGPUImageDemo" target="_blank" rel="noopener">demo</a></p>
<h4 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h4><p>这个方案需要对opengl和shader有一些了解，比如顶点坐标系和纹理坐标系之间如何映射，shader中如何获取每个像素点的RGB值，包括向量的偏移计算，shader的变量类型如何声明等等。。。使用视频播放大礼物比直接用序列帧播放在性能和内存占用上都有明显的优势，应该算一种不错的优化方案了。之前我在iOS性能优化中提起过，做性能优化需要程序员本身有一定的技术积累，所以，程序员学习的脚步不能停止，不知道哪天你现在学的东西就会体现出它的价值。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/11/23/《设计模式-可复用面向对象软件的基础》读书笔记/" itemprop="url">
                  《设计模式-可复用面向对象软件的基础》读书笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-11-23T17:28:26+08:00" content="2019-11-23">
              2019-11-23
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2019/11/23/《设计模式-可复用面向对象软件的基础》读书笔记/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/11/23/《设计模式-可复用面向对象软件的基础》读书笔记/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="引言"><a href="#引言" class="headerlink" title="引言"></a>引言</h3><h4 id="why要学习设计模式"><a href="#why要学习设计模式" class="headerlink" title="why要学习设计模式"></a>why要学习设计模式</h4><ul>
<li>有经验的面向对象设计者的确能做出良好的设计，而新手则面对众多选择无从下手。</li>
<li>内行的设计者更愿意复用以前使用过的解决方案，当找到一个好的解决方案时，他们会一遍又一遍的使用。</li>
<li>设计模式使人们更加简单方便的复用成功的设计和体系结构。</li>
</ul>
<h4 id="设计模式相关概念"><a href="#设计模式相关概念" class="headerlink" title="设计模式相关概念"></a>设计模式相关概念</h4><ul>
<li>设计模式确定所包含的类和实例的角色，协作方式和职责分配。</li>
<li>设计模式一个主要动机是<strong>对变化的概念进行封装</strong></li>
</ul>
<h4 id="设计模式四要素"><a href="#设计模式四要素" class="headerlink" title="设计模式四要素"></a>设计模式四要素</h4><ul>
<li>模式名（pattern name）</li>
<li>问题（problem）</li>
<li>解决方案（solution）</li>
<li>效果（consequence）</li>
</ul>
<h4 id="设计模式的目的"><a href="#设计模式的目的" class="headerlink" title="设计模式的目的"></a>设计模式的目的</h4><ul>
<li>灵活</li>
<li>模块化</li>
<li>可复用</li>
<li>易理解</li>
</ul>
<h4 id="设计模式如何解决问题"><a href="#设计模式如何解决问题" class="headerlink" title="设计模式如何解决问题"></a>设计模式如何解决问题</h4><ul>
<li>寻找合适的对象</li>
<li>决定对象的粒度</li>
<li>指定对象接口</li>
<li>描述对象的实现</li>
<li>运用复用机制</li>
<li>关联运行时刻和编译时刻的结构</li>
<li>设计应支持变化</li>
</ul>
<h4 id="怎样使用设计模式"><a href="#怎样使用设计模式" class="headerlink" title="怎样使用设计模式"></a>怎样使用设计模式</h4><ul>
<li>1.大致浏览一遍模式</li>
<li>2.回头研究结构部分，参与者部分和协作部分</li>
<li>3.看代码示例部分，看看这个模式代码的具体例子</li>
<li>4.选择模式参与者的名字，使它们在应用上下文中有意义</li>
<li>5.定义类</li>
<li>6.定义模式中专用于应用的操作名称</li>
<li>7.实现执行模式中责任和协作的操作</li>
</ul>
<h4 id="设计模式的分类"><a href="#设计模式的分类" class="headerlink" title="设计模式的分类"></a>设计模式的分类</h4><h5 id="创建型"><a href="#创建型" class="headerlink" title="创建型"></a>创建型</h5><ul>
<li>Abstract Factory（抽象工厂）</li>
<li>Factory Method（工厂方法）</li>
<li>Builder（生成器）</li>
<li>Prototype（原型）</li>
<li>Singleton（单例）</li>
</ul>
<h5 id="结构型"><a href="#结构型" class="headerlink" title="结构型"></a>结构型</h5><ul>
<li>Adapter</li>
<li>Bridge</li>
<li>Composition</li>
<li>Decorator</li>
<li>Facade</li>
<li>Flyweight</li>
<li>Proxy</li>
</ul>
<h5 id="行为型"><a href="#行为型" class="headerlink" title="行为型"></a>行为型</h5><ul>
<li>Interpreter</li>
<li>Template Method</li>
<li>Chain of Responsibility</li>
<li>Command</li>
<li>Iterator</li>
<li>Mediator</li>
<li>Memento</li>
<li>Observer</li>
<li>State</li>
<li>Strategy</li>
<li>Visitor</li>
</ul>
<h4 id="UML类图关系"><a href="#UML类图关系" class="headerlink" title="UML类图关系"></a>UML类图关系</h4><p>在详解各个设计模式之前，先来复现一下UML中怎么表示类的各种关系。</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/UML类的关系.png" alt=""></p>
<ul>
<li>聚合关系是非强依赖的，而组合关系是强依赖的。</li>
<li>继承关系中，实现关系是继承的抽象类，泛化关系是继承的非抽象类。</li>
<li>依赖关系是动态关系，而关联关系是静态关系。</li>
</ul>
<h3 id="创建型设计模式"><a href="#创建型设计模式" class="headerlink" title="创建型设计模式"></a>创建型设计模式</h3><p>创建型设计模式主要用来创建相关对象，将创建和使用解耦，同时隐藏创建的细节等。创建型设计模式的优势是将原本硬编码的创建过程分散到其他类，使创建行为易于扩展。</p>
<h4 id="Factory-Method（工厂方法）"><a href="#Factory-Method（工厂方法）" class="headerlink" title="Factory Method（工厂方法）"></a>Factory Method（工厂方法）</h4><p>工厂方法将对象创建的过程进行了封装，使用者不用关心具体返回的对象类型。在工厂方法中，父类负责定义创建对象的方法，而具体的创建逻辑则放到了子类中完成，这也方便了新类型的扩展，在不修改旧代码的情况下就能正常使用新的类型。</p>
<p>工厂方法各类的关系大致如下图：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/FactoryMethod.jpg" alt=""></p>
<h4 id="Abstract-Factory（抽象工厂）"><a href="#Abstract-Factory（抽象工厂）" class="headerlink" title="Abstract Factory（抽象工厂）"></a>Abstract Factory（抽象工厂）</h4><p>使用抽象工厂模式时，每个子工厂往往需要生产一个产品族的产品，而不单只生产一种产品。这是抽象工厂和工厂的主要区别。</p>
<p>抽象工厂各类的关系大致如下图：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/AbatractFactory.jpg" alt=""></p>
<p>其中，每个子工厂都至少生产了2类产品。而且这2类产品应该是有比较强的关联。比如Factory1是生产apple旗下的iPhone和iPad,而Factory2是生产华为旗下的P30和华为Pad。</p>
<h4 id="Builder（生成器）"><a href="#Builder（生成器）" class="headerlink" title="Builder（生成器）"></a>Builder（生成器）</h4><p>生成器比较适合一些需要分步创建的对象，一个生成器会将对象创建过程中的所有需要步骤都抽象出来，并在子类中一一实现，并提供一个返回对象实例的方法。在使用生成器时，我们往往需要一个导演类去帮我们选择生成对象的步骤。</p>
<p>生成器类图：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/Builder.jpg" alt=""></p>
<p>对于一个比较复杂的对象，创建的过程可能依赖很多上下文，这种对象的创建就比较适合使用生成器来创建。下面是KFC点餐系统应用生成器模式创建订单的例子：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/KFCBuilder.jpg" alt=""></p>
<h4 id="Prototype（原型）"><a href="#Prototype（原型）" class="headerlink" title="Prototype（原型）"></a>Prototype（原型）</h4><p>原型模式使用频率并不高，主要是这种模式比较奇葩，会先将对象创建一份在内存中，然后通过拷贝构造的方式生成一个新的对象并返回。</p>
<p>原型的类图：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/原型.png" alt=""></p>
<p>原型模式必须要提供一个Clone()方法，而且为了保证产生的每个对象都是新对象，需要对自身进行深拷贝操作。原型的好处是它可以减少类的数目，简化创建对象的过程，并将创建的细节隐藏。</p>
<h4 id="Singleton（单例）"><a href="#Singleton（单例）" class="headerlink" title="Singleton（单例）"></a>Singleton（单例）</h4><p>单例模式原理简单，对于数据共享和同步是较好的实现方式，所以应用比较广泛。但是容易被滥用导致内存问题等。iOS中的metaclass(元类)就是使用的单例模式。</p>
<p>单例类图：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/Singleton.jpg" alt=""></p>
<p>单例一旦创建了就不会被释放，所以除非必要，还是不要滥用。不能只图一时方便就选择一种并不适合的设计模式，这样其实是违背了设计模式的初衷。</p>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>工厂方法使用比较简单，但是扩展性不太强，而抽象工厂有更好的灵活性，同时又增加了系统的复杂度和类的层级。生成器模式适合创建复杂对象，原型模式则更适合创建同时存在多个子类的对象。最后的单例模式使用最方便，但是可能会因为滥用导致一些系统资源问题。通常，一个创建型模式会以工厂模式开始，然后在迭代过程中慢慢进化为更适合自身的模式。</p>
<h3 id="结构型设计模式"><a href="#结构型设计模式" class="headerlink" title="结构型设计模式"></a>结构型设计模式</h3><p>结构型模式所做的事情是关于如何组合类和对象以获得更大的结构。它们不是对接口和实现进行组合，而是描述如何对一些对象进行组合，从而实现新功能的一些方法。</p>
<h4 id="Adapter（适配器）"><a href="#Adapter（适配器）" class="headerlink" title="Adapter（适配器）"></a>Adapter（适配器）</h4><p>适配器模式又叫Wrapper(包装器),主要用来扩展当前类的接口，适配器模式又分为类适配器和对象适配器两种实现方式，很显然，对象适配器是操作对象，而类适配器是操作类。</p>
<p>对象适配器类图：<br><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/Adapter_object.jpg" alt=""></p>
<p>类适配器类图：<br><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/Adapter_classModel.jpg" alt=""></p>
<p>对于类适配器，可能依赖语言本身的继承体系，比如OC只支持单继承，则不能将多个类的接口统一为一个适配器，只能使用对象适配器或者使用协议去重构类的结构。对象适配器则相对更灵活，而且不会改变类本身的性质。</p>
<h4 id="Bridge（桥接）"><a href="#Bridge（桥接）" class="headerlink" title="Bridge（桥接）"></a>Bridge（桥接）</h4><p>桥接模式的一个重要目的是将抽象接口和具体实现进行分离。这样就打破了抽象和具体实现的绑定关系，增强了抽象类的扩展性。而且对实现的修改并不会直接影响抽象类，符合ISP原则。</p>
<p>桥接模式类图：<br><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/Bridge.jpg" alt=""></p>
<p>设计模式中抽象的概念一直都比较重要，良好的抽象能力是掌握设计模式的基础。将抽象和具体实现进行解耦是设计模式的准则。</p>
<h4 id="Composite（组合）"><a href="#Composite（组合）" class="headerlink" title="Composite（组合）"></a>Composite（组合）</h4><p>组合模式将对象组合成树形结构以表示部分和整理的层次结构。保证用户对单一和组合对象使用具有一致性。</p>
<p>组合模式类图：<br><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/Composite.png" alt=""></p>
<p>iOS中，UIView就是一个典型的组合模式的应用。UIView在渲染或者处理点击事件时，都会逐一遍历子视图，分别对单个子视图进行处理。</p>
<h4 id="Decorator（装饰）"><a href="#Decorator（装饰）" class="headerlink" title="Decorator（装饰）"></a>Decorator（装饰）</h4><p>装饰模式可以动态的给一个类添加职责而不影响改类本身，也不用修改该类的具体实现。同时，装饰比继承更为灵活，方便扩展，且不会造成子类爆炸等问题。</p>
<p>装饰模式类图：<br><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/Decorator.jpg" alt=""></p>
<p>变形金刚的装饰模式应用：<br><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/Decorator_eg.jpg" alt=""></p>
<p>这里需要注意一下装饰类和被装饰类的接口至少需要保持一致，当然对于不同的装饰行为，可以扩展不同的特定接口。</p>
<h4 id="Facade（外观模式）"><a href="#Facade（外观模式）" class="headerlink" title="Facade（外观模式）"></a>Facade（外观模式）</h4><p>外观模式通常应用在你需要为一个复杂的系统提供一个简单的接口供外界使用时。外观并不特指UI,而是提供给外界使用这一行为上。</p>
<p>外观模式的类图：<br><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/Facade.jpg" alt=""></p>
<p>下面是一个编译器项目对于外观模式的应用：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/facade_complier.png" alt=""></p>
<p>外观模式在提供简单的接口的同时，并不隐藏实现的细节，这样，对于想要了解具体实现的客户也比较友好。外观模式除了符合SRP原则外，同时也隔离了调用者和具体的模块实现，符合ISP原则。</p>
<h4 id="Flyweight（享元模式）"><a href="#Flyweight（享元模式）" class="headerlink" title="Flyweight（享元模式）"></a>Flyweight（享元模式）</h4><p>享元模式描述了如何共享对象，使得可以细颗粒度地使用它们而无需高昂的代价。享元模式一般会有一个享元对象的复用池，对象本身会有<strong>外部状态</strong>和<strong>内部状态</strong>两种状态，通过维护这两种状态实现对象的共享。</p>
<p>享元模式类图：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/Flyweight.jpg" alt=""></p>
<p>当项目中使用了大量的相同或者相似对象，并且因为这些对象导致一些内存问题，就应该考虑是否可以采用享元模式来优化对象的使用。</p>
<h4 id="Proxy（代理模式）"><a href="#Proxy（代理模式）" class="headerlink" title="Proxy（代理模式）"></a>Proxy（代理模式）</h4><p>当一个客户因为某些原因不能直接使用一个类时，可以通过使用这个类的代理间接使用该类。和装饰模式类似，代理类的接口也至少需要和该类保持一致，同时还可以进行扩展。代理模式也是ISP原则的应用。</p>
<p>代理模式类图：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/Proxy.jpg" alt=""></p>
<p>下面是一个Image代理的实例：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/proxy_image.png" alt=""></p>
<p>在显示image时，会先创建ImageProxy作为一个占位对象，只有当真正调用draw时才会开始创建image实例。这也是一种延迟加载的策略，对于比较消耗资源的对象比较实用。</p>
<h4 id="结构型模式总结"><a href="#结构型模式总结" class="headerlink" title="结构型模式总结"></a>结构型模式总结</h4><p>结构型设计模式的目的就是通过各种类和对象的组合，来扩展出一个拥有更多功能的新的类。<br>Adapter通过对象适配和类适配两种方式将多个类的功能集成到一个类中。Bridge则是通过给抽象接口增加具体的实现类来实现类的组合。Composite将一个类簇对象递归组合为一个集合类，统一了接口的调用。Decorator虽然和Composite有相似的递归结构，但这也就是两种唯一相似之处了，Decorator强调的是特殊问题特殊处理，可扩展性极强，这点上这正好和Composite相反。Facade将复杂对象组合起来，提供了简单的调用接口，单它和Composite又完全不同，Facade组合的类之间可能存在依赖，但不存在类簇的关系。Flyweight强调的是类的复用机制，Proxy则为类的调用提供了新的方式，即加一个中间层，这也是解决计算机科学中所有问题的终极法宝。</p>
<p>以上七种结构型模式，各有各的优势，不足和适合的使用场景。我们在使用前，首先需要熟悉各个模式的优劣和使用场景，才能更好的去应用，当然，走出第一步才是最重要的，只有先用起来，至于是否是最优选择，可以在代码重构中慢慢优化，这样边用边优化，总结出使用心得，最终才可能真正的掌握，到达灵活使用，信手拈来的境界。</p>
<h3 id="行为型设计模式"><a href="#行为型设计模式" class="headerlink" title="行为型设计模式"></a>行为型设计模式</h3><p>行为模式涉及到<strong>算法和对象间职责的分配</strong>。行为模式不仅描述对象或类的模式，还可以描述它们之间的通信模式。这些模式刻画了在运行时难以跟踪的复杂的控制流。模式模式的作用就是将注意力从控制流转移到<strong>对象之间的联系方式</strong>上来。</p>
<h4 id="Chain-of-Responsibility-责任链模式"><a href="#Chain-of-Responsibility-责任链模式" class="headerlink" title="Chain of Responsibility(责任链模式)"></a>Chain of Responsibility(责任链模式)</h4><p>当多个相关联的类需要处理同一个事件请求，而请求发起者又不能依赖所有可能的接收者时，可以将所有的接收者组成一条链，使请求沿着这条链传递下去。责任链模式往往和上面的Composition模式同时使用，因为Composition模式很容易提供这种链式结构。</p>
<p>责任链类图：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/责任链.png" alt=""></p>
<p>iOS响应链正是这种设计模式的应用，hitTest方法就类似上图中的HandleRequest()方法，而Event对象则是一个Request，通过参数的形式传递给所有的响应者。每个响应者可以在自己内部重写hitTest方法，决定是否需要处理某个事件。</p>
<h4 id="Command-命令模式"><a href="#Command-命令模式" class="headerlink" title="Command(命令模式)"></a>Command(命令模式)</h4><p>在软件设计中，我们经常需要向某些对象发送请求，但是并想依赖请求的接收者，我们只需在程序运行时指定具体的请求接收者即可，此时，可以使用命令模式来进行设计，使得请求发送者与请求接收者消除彼此之间的耦合，让对象之间的调用关系更加灵活。</p>
<p>命令模式类图：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/Command.jpg" alt=""></p>
<p>在实现命令模式时，我们一般会创建一个命令抽象类，然后继承出具体的命令子类，而命令的接收者我们会以参数的形式传递给各命令子类。在调用该命令时，我们通过使用命令子类创建一个Invoker操作类来发送命令，这样就将命令接收者和调用者成功解耦。</p>
<p>电视遥控实例：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/Command_eg.jpg" alt=""></p>
<p>编辑软件的redo和undo实现就是Command模式很好的一个应用，会有一个命令列表去维护之前的所有操作，需要进行redo或者undo时，只需要遍历一下这个列表，重新处理对应的Command。</p>
<h4 id="Interpreter-解释器"><a href="#Interpreter-解释器" class="headerlink" title="Interpreter(解释器)"></a>Interpreter(解释器)</h4><p>如果一种特定类型的问题发生的频率足够高，那么可能就值得将该问题的各个实例表述为一个简单语言中的句子。这样就可以构造一个解释器，该解释器通过解释这些句子来解决该问题。字符串的模式匹配就是一个很好的例子，字符串在进行匹配的时候可能会有多种模式，比如是否重复，是否结束等，我们可以构建一个抽象的语法树，然后为每一种模式实现一种语法的解释算法，这样就产生了一个字符串模式匹配的解释器。</p>
<p>解释器模式类图:</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/解释器.png" alt=""></p>
<p>解释器在正则表达式和编译器中都有大量的应用场景。比如编译器中的AST，就是一个语法解释器。而正则中对各种字符串模式的匹配算法，也是一个解释器应用。</p>
<h4 id="Iterator-迭代器"><a href="#Iterator-迭代器" class="headerlink" title="Iterator(迭代器)"></a>Iterator(迭代器)</h4><p>迭代器主要用来进行列表的遍历，当需要访问列表中的元素而又不想暴露元素的具体内部结构时，就可以使用迭代器来实现。同时，迭代器也解决了访问不同类型对象需要不同判断条件的问题。</p>
<p>迭代器依赖具体的列表实例。针对不同的遍历策略，可以生成不同的迭代器，而无需对具体列表实例进行任何操作。这样就分离了数据和具体的遍历操作。比如我们想要过滤列表则只需要创建一个具体的过滤迭代器。</p>
<p>下图是一个多态迭代器类结构，即每一种列表类型对应一种迭代器模型，迭代器本身不需要再去判断当前聚合类型，这样迭代机制就与具体的聚合类无关。</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/polyiterator.png" alt=""></p>
<p>下图是迭代器的具体创建逻辑，创建过程采用了工厂模式，每一种集合创建一种对应的迭代器。<br><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/createiterator.png" alt=""></p>
<p>迭代器的具体控制方式又分为两种，即外部迭代器和内部迭代器。外部迭代器的控制条件需要通过参数传递给迭代器。外部迭代器比内部迭代器更灵活，比如外部迭代器可以很容易实现判断两个具体元素是否相等。</p>
<h4 id="Mediator-中介者"><a href="#Mediator-中介者" class="headerlink" title="Mediator(中介者) *"></a>Mediator(中介者) *</h4><p>如果多个类之间存在各种依赖关系，而且这些类又可能存在各种扩展类，这种情况下如果在每个类中各自处理依赖关系，会导致各类之间的大量强关联，增加代码的复杂度和维护成本，降低了类和模块的可扩展性。这种情况下，可以引入中介者模式来处理类的依赖。</p>
<p>中介者提供了一个中间人，其他各类如果需要相互调用，只需要调用中介者，而不需要调用具体的类，一切都交给中介者来操作。下图是中介者模式中各类之间的依赖关系：<br><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/mediator.png" alt=""></p>
<p>需要注意的是中介者和调用它的类之间是可能存在相互依赖的关系，如果这种相互依赖最终导致了循环引用产生内存问题的话，可能需要想办法打破这种依赖，可以参考DIP原则，下图是一个中介者模式的类图：<br><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/Mediator.jpg" alt=""></p>
<p>中介者模式是解决对象之间相互通信时好的选择，它减少了子类生成，将原本耦合的依赖关系解耦，将多对多的调用关系简化为一对多，并且对各对象的调用进行了抽象和封装，方便维护和扩展。</p>
<h4 id="MEMENTO-备忘录"><a href="#MEMENTO-备忘录" class="headerlink" title="MEMENTO(备忘录)"></a>MEMENTO(备忘录)</h4><p>备忘录模式旨在对对象实例进行合理的保存，在不过度暴露对象内部实现的前提下，对对象行为进行取消或者恢复。备忘录模式可以理解为一种持久化对象的方式。从出发点来看，备忘录和命令模式有一定的相似性，都能取消和恢复对象的行为，但是命令模式强调的可能是一连串的操作，而且命令模式的优势是将命令的发送者和接受者做了解耦，而备忘录则更强调对象和备忘录的关联关系，即原发器和备忘录的关系。</p>
<p>下图是备忘录模式的类图关系：<br><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/memento.png" alt=""></p>
<h4 id="Observer-观察者"><a href="#Observer-观察者" class="headerlink" title="Observer(观察者) *"></a>Observer(观察者) *</h4><p>观察者模式提供了一种方式，保证了依赖同一个对象的多个类的一致性，当这个对象的状态改变时，可以很方便通知到这些依赖类。</p>
<p>在面向对象的项目中，我们往往会将模块进行各种分割和封装，这样各个模块在共享数据时就会产生问题，如果每个模块都对数据进行各种强的依赖，则会破坏整个系统封装，扩展和重用性。这个时候就可以引入观察者模式来解决数据同步的问题。</p>
<p>观察者模式类图：<br><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/Obeserver.jpg" alt=""></p>
<p>在iOS系统中，观察者模式也是一种比较常用的和推荐的设计模式，因为它很好的解决了各模块之间的数据一致性问题，但是，也因此产生了比较多的问题，最常见的就是各种崩溃，比如观察者的重复删除问题，以及野指针问题，iOS中比较好的解决方案比如FB的KVOController,就是自己去维护一个观察者的弱引用列表，在进行观察者的添加，删除和触发通知时，先进行容错，避免崩溃。</p>
<h4 id="State-状态"><a href="#State-状态" class="headerlink" title="State(状态)"></a>State(状态)</h4><p>当一个类的行为变化依赖于一种或者多种条件时，这些条件可以称为这个类的各种状态，这种场景也是状态模式的由来。</p>
<p>比较典型的状态模式比如TCP的连接状态，我们先来复习一下TCP都有哪些连接状态。</p>
<h5 id="建立连接时"><a href="#建立连接时" class="headerlink" title="建立连接时"></a>建立连接时</h5><p>主叫方的状态有：</p>
<p>SYN_SENT -&gt; ESTABLISHED </p>
<p>被叫方的状态有：</p>
<p>LISTEN -&gt; SYN_RCVD -&gt; ESTABLISHED</p>
<h5 id="断开连接时"><a href="#断开连接时" class="headerlink" title="断开连接时"></a>断开连接时</h5><p>主叫方的状态有：</p>
<p>FIN_WAIT_1 -&gt; FIN_WAIT_2 -&gt; TIME_WAIT -&gt; CLOSED</p>
<p>被叫方的状态有:</p>
<p>CLOSE_WAIT -&gt; LAST_ACK -&gt; CLOSED</p>
<p>一个TCP连接存在多种状态，当处于不同状态时，又将产生不同的行为，这里状态是tcp连接类的一个实例，tcp连接对外暴露的API，都依赖该状态实例，不同状态产生不同行为，具体类图如下：<br><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/State.png" alt=""></p>
<p>除了上面的场景外，状态模式还有一个比较适用的场景是一个操作中有大量的条件判断或者switch分支，这时可以抽象一个状态类，将每一种分支封装为一种具体状态，条件执行语句则在各封装子类中去实现，这样外部只需调用统一的抽象接口即可。</p>
<h4 id="STRATEGY-策略"><a href="#STRATEGY-策略" class="headerlink" title="STRATEGY(策略)"></a>STRATEGY(策略)</h4><p>当你在处理某种case时，有多种处理方法，这些处理方法可以被称为不同的算法，如果我们将这些算法硬编码到处理类中，该类就失去了扩展性，这些算法也没有了被复用的可能，所以，我们可以抽象出一个策略类，每种算法去实现具体的策略子类，处理类只需要根据情况调用不同的策略子类即可，这就是策略模式。</p>
<p>下面是策略模式的类图结构：<br><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/Strategy.jpg" alt=""></p>
<p>对比上面的状态模式，可以发现，这两个模式的类图结构基本一致,只是应用的场景不同，状态强调的是一种属性状态，而策略强调的是一种处理算法，两者在应用场景上还是有比较明显的差别。</p>
<h4 id="Template-Method-模版方法"><a href="#Template-Method-模版方法" class="headerlink" title="Template Method(模版方法)"></a>Template Method(模版方法)</h4><p>在一个类簇中，子类可能需要共享一套API接口和调用逻辑，但是又需要有自己特定的行为，这种场景就可以使用模板方法来实现，可以将API的实现模板写在父类，而具体的逻辑分散到各个子类中去实现。下图为模板方法的类图：</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/TemplateMwthod.png" alt=""></p>
<p>模板方法是一种代码复用的基本技术，它们在面向对象语言和类簇中尤为重要，可以减少大量重复代码，简化代码逻辑。在子类中实现的逻辑，又称为<strong>钩子操作</strong>。模板方法也是我比较喜欢使用的一种设计模式。</p>
<h4 id="Visitor-访问者"><a href="#Visitor-访问者" class="headerlink" title="Visitor(访问者)"></a>Visitor(访问者)</h4><p>当我们需要对一系列元素进行一系列操作，而且每一种操作不一样时，我们可以将这些操作抽象为访问者，每一种操作则为一个具体的访问者子类，该子类为每一个元素提供一个操作方法供元素调用。同时，我们还需要将元素也进行抽象，然后生成具体的元素子类，每一个子类根据自身需要接收不同的访问者。</p>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/设计模式/Vistor2.png" alt=""></p>
<p>该模式将调用者和被调用者进行了解耦操作，对访问者进行了封装，方便了访问者的扩展。不过元素缺比较难被扩展，因为每扩展一个元素，需要对之前所有访问者进行修改。</p>
<h4 id="行为型设计模式的几个出发点"><a href="#行为型设计模式的几个出发点" class="headerlink" title="行为型设计模式的几个出发点"></a>行为型设计模式的几个出发点</h4><ol>
<li>对变化的封装（策略，状态，中介者，迭代器）</li>
<li>使用对象作为参数（命令，备忘录）</li>
<li>通信时被封装还是被分布（中介者，观察者）</li>
<li>对发送者和接受者的解耦（命令，观察者，中介者，）</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/11/21/《重构-改善既有代码的设计》系列读书笔记（八、大型重构和个人总结）/" itemprop="url">
                  《重构-改善既有代码的设计》系列读书笔记（八、大型重构和个人总结）
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-11-21T11:43:34+08:00" content="2019-11-21">
              2019-11-21
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2019/11/21/《重构-改善既有代码的设计》系列读书笔记（八、大型重构和个人总结）/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/11/21/《重构-改善既有代码的设计》系列读书笔记（八、大型重构和个人总结）/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="大型重构"><a href="#大型重构" class="headerlink" title="大型重构"></a>大型重构</h3><p>不要被名字吓到。。。</p>
<h4 id="Tease-Apart-Inheritance-梳理并分解继承关系"><a href="#Tease-Apart-Inheritance-梳理并分解继承关系" class="headerlink" title="Tease Apart Inheritance(梳理并分解继承关系)"></a>Tease Apart Inheritance(梳理并分解继承关系)</h4><p>某个继承体系同时承担两项责任</p>
<h5 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h5><ul>
<li>混乱的继承体系是一个严重的问题，它会导致重复代码，会使修改变得困难。</li>
<li>如果继承体系中的某一特定层级上的所有类，其子类名称都以相同的形容词开始，那么这个体系很可能承担着两项不同的责任。</li>
</ul>
<h5 id="做法"><a href="#做法" class="headerlink" title="做法"></a>做法</h5><ul>
<li><p>before<br><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/重构/TeaseBefore.png" alt=""></p>
</li>
<li><p>after</p>
</li>
</ul>
<p><img src="https://github.com/lilingyu0620/LLYBlogImageSource/raw/master/重构/TeaseAfter.png" alt=""></p>
<h4 id="Convert-Procedural-Design-to-Objects-将过程化设计转化为对象设计"><a href="#Convert-Procedural-Design-to-Objects-将过程化设计转化为对象设计" class="headerlink" title="Convert Procedural Design to Objects(将过程化设计转化为对象设计)"></a>Convert Procedural Design to Objects(将过程化设计转化为对象设计)</h4><p>你手上有一些传统过程化风格的代码</p>
<h5 id="动机-1"><a href="#动机-1" class="headerlink" title="动机"></a>动机</h5><ul>
<li>在面向对象语言中，应该尽量少的使用过程化的代码，多用对象。</li>
</ul>
<h5 id="做法-1"><a href="#做法-1" class="headerlink" title="做法"></a>做法</h5><ul>
<li>将数据记录变成对象，将大块的行为分割小块，并将行为移入相关对象之中。</li>
</ul>
<h4 id="Separate-Domain-from-Presentation-将领域和表述-显示分离"><a href="#Separate-Domain-from-Presentation-将领域和表述-显示分离" class="headerlink" title="Separate Domain from Presentation(将领域和表述/显示分离)"></a>Separate Domain from Presentation(将领域和表述/显示分离)</h4><p>某些GUI类之中包含了数据处理逻辑</p>
<h5 id="动机-2"><a href="#动机-2" class="headerlink" title="动机"></a>动机</h5><ul>
<li>MVC模式。。。</li>
<li>M 还是 VM ？这是一个问题。</li>
</ul>
<h5 id="做法-2"><a href="#做法-2" class="headerlink" title="做法"></a>做法</h5><ul>
<li>将显示逻辑和数据处理逻辑分离。。。</li>
</ul>
<h4 id="Extract-Hierarchy-提炼继承体系"><a href="#Extract-Hierarchy-提炼继承体系" class="headerlink" title="Extract Hierarchy(提炼继承体系)"></a>Extract Hierarchy(提炼继承体系)</h4><p>你有某个类做了太多工作，其中一部分工作是以大量条件表达式完成的。</p>
<h5 id="动机-3"><a href="#动机-3" class="headerlink" title="动机"></a>动机</h5><ul>
<li>当一个简单的类在不断迭代之后，可能产生一系列不同的行为，这些行为的执行依赖于各种条件和标记，日积月累，这个类就完全一团糟了。</li>
<li>只有这些条件和标记在整个类的生命周期内保持不变时，本重构手法才适用。</li>
<li>Extract Hierarchy是一项大型重构，可能需要花费大量的时间和精力，先易后难，循序渐进。</li>
</ul>
<h5 id="做法-3"><a href="#做法-3" class="headerlink" title="做法"></a>做法</h5><ul>
<li>将各种需要条件判断的地方提炼为一个新的子类，直到将超类改为抽象类为止。</li>
</ul>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><p>总结以上各种重构手段，我们不难发现，重构的最终目主要有以下两点：</p>
<h4 id="消除重复代码"><a href="#消除重复代码" class="headerlink" title="消除重复代码"></a>消除重复代码</h4><p>我们所以要提炼函数，提炼类，消除临时变量，重新组织数据，内联函数和类，大部分操作都是在消除重复的代码。</p>
<p>重复代码的危害是显而易见的，它除了增加你的整体代码量，使你的逻辑变得更复杂外，也阻碍着他人阅读和理解你的代码，并且大大增加了代码的维护成本。所以说消除重复代码，不止可以大大降低代码维护成本，还能减少整体代码量，提高代码的可读性，可以说是一举多得。</p>
<p>然而在实际的开发过程中，往往还是会出现很多的重复代码，这种代码主要出现在相似的功能模块之间，而且后来者重复前人代码的比例会更大一些。可能由于懒得，开发时间，个人素质等各种原因，最终导致项目中出现大量重复代码。</p>
<p>要解决重复代码的问题，我个人觉得首先需要提高开发者的个人素质，一个对自己代码严格要求的开发者在编码过程中会时刻提醒自己减少重复。其次，团队开发中代码review是必要的，而且应该严格执行，不能因为个人惰性，面子问题或者时间不够这些主观原因而不做或者打折扣。你做或者不做，代码都在那里，不增不减。</p>
<h4 id="梳理代码之间的关系（类，函数等）"><a href="#梳理代码之间的关系（类，函数等）" class="headerlink" title="梳理代码之间的关系（类，函数等）"></a>梳理代码之间的关系（类，函数等）</h4><p>对代码之间关系的梳理，是能够大大改善代码的另外一个手段。程序本质上就是由各种代码串联起来的一个软体，代码间的关系决定了软件的所有行为。这些关系主要包括类的关系，函数的关系，条件语句的关系和数据的关系。</p>
<p>计算机科学和土木工程，电子信息，机械等专业都被归于工科，说明他们之间是有一些共性存在的。我们可以参考土木工程中一个项目的整体流程，然后和计算机软件项目来一个大致的对比。土木工程师在开始一个项目时，会花费大量的时间去做方案设计，中间可能需要经过多次改版，最终方案形成后才会开始施工，而且必须是严格按照设计方案来施工，不然后面的验收可能就会不通过。反观软件工程师的开发流程，则简单很多，前期及时有方案设计，也不会事无巨细，可能几个主要的模块确定后，就可以开始编码。</p>
<p>土木和计算机软件的主要差别就体现在“软”字上，土木的设计方案如果出问题，并且在初期并没有被发现话，对项目整体影响会很大，而软件开发中对代码的修改是随时的，并不会产生什么大的影响。正是基于软件的这种特殊属性，也就出现了大量因为设计不良，甚至根本谈不上设计的代码，而这种不经设计的代码，正是导致代码之间关系混乱的元凶。</p>
<p>和代码重复不同的是，良好的代码关系并不是开发者多注意就可以形成的。需要大量的学习和实践才能有一些心得，而将这些心得运用到项目中又需要一些时间成本，所以总体上讲好的代码关系在实际开发过程中不可能尽善尽美，开发者能做的就是尽自己最大的努力去设计出合理的代码关系，然后在不断的重构中去进一步完善。这就要求我们对设计模式学习和实践的脚步不能停止。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2019/11/20/《重构-改善既有代码的设计》系列读书笔记（七、处理概括关系（继承关系））/" itemprop="url">
                  《重构-改善既有代码的设计》系列读书笔记（七、处理概括关系（继承关系））
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2019-11-20T11:38:51+08:00" content="2019-11-20">
              2019-11-20
            </time>
          </span>

          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2019/11/20/《重构-改善既有代码的设计》系列读书笔记（七、处理概括关系（继承关系））/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2019/11/20/《重构-改善既有代码的设计》系列读书笔记（七、处理概括关系（继承关系））/" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h3 id="处理概括关系（继承关系）"><a href="#处理概括关系（继承关系）" class="headerlink" title="处理概括关系（继承关系）"></a>处理概括关系（继承关系）</h3><h4 id="Pull-Up-Field-字段上移"><a href="#Pull-Up-Field-字段上移" class="headerlink" title="Pull Up Field(字段上移)"></a>Pull Up Field(字段上移)</h4><p>两个子类拥有相同的字段</p>
<h5 id="动机"><a href="#动机" class="headerlink" title="动机"></a>动机</h5><ul>
<li>本重构从两方面减少重复，首先去除了重复的数据声明，其次去除了重复的行为。</li>
</ul>
<h4 id="Pull-Up-Method-函数上移"><a href="#Pull-Up-Method-函数上移" class="headerlink" title="Pull Up Method (函数上移)"></a>Pull Up Method (函数上移)</h4><p>有些函数，在各个子类中产生完全相同的结果</p>
<h5 id="动机-1"><a href="#动机-1" class="headerlink" title="动机"></a>动机</h5><ul>
<li>如果系统中出现重复，意味着以后你修改一处代码时需要同时修改另一个。</li>
<li>子类函数覆盖了超类的函数，确做的相同的工作。</li>
</ul>
<h4 id="Pull-Up-Constructor-Body-构造函数本体上移"><a href="#Pull-Up-Constructor-Body-构造函数本体上移" class="headerlink" title="Pull Up Constructor Body(构造函数本体上移)"></a>Pull Up Constructor Body(构造函数本体上移)</h4><p>你在各个子类中拥有一些构造函数，他们的本体几乎完全一致</p>
<h5 id="动机-2"><a href="#动机-2" class="headerlink" title="动机"></a>动机</h5><ul>
<li>构造函数不能继承，所以如果有相同的构造逻辑，需要将具体逻辑上移到父类的构造函数中。</li>
</ul>
<h5 id="做法"><a href="#做法" class="headerlink" title="做法"></a>做法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">// before </div><div class="line">class Employee...</div><div class="line">	protected String _name;</div><div class="line">	protected String _id;</div><div class="line">	</div><div class="line">class Manager extends Employee...</div><div class="line">	public Manager(String name,String id,int grade) &#123;</div><div class="line">		_name = name;</div><div class="line">		_id = id;</div><div class="line">		_grade = grade;</div><div class="line">	&#125;</div><div class="line">	</div><div class="line">	private int _grade;</div><div class="line">	</div><div class="line">//after</div><div class="line">class Employee...</div><div class="line">	public Employee(String name,String id) &#123;</div><div class="line">		_name = name;</div><div class="line">		_id = id;</div><div class="line">	&#125;</div><div class="line">	protected String _name;</div><div class="line">	protected String _id;</div><div class="line">	</div><div class="line">class Manager extends Employee...</div><div class="line">	public Manager(String name,String id,int grade) &#123;</div><div class="line">		super (name,id);</div><div class="line">		_grade = grade;</div><div class="line">	&#125;</div><div class="line">	private int _grade;</div></pre></td></tr></table></figure>
<h4 id="Pull-Down-Method-函数下移"><a href="#Pull-Down-Method-函数下移" class="headerlink" title="Pull Down Method(函数下移)"></a>Pull Down Method(函数下移)</h4><p>超类中某个函数只与部分子类有关</p>
<h5 id="动机-3"><a href="#动机-3" class="headerlink" title="动机"></a>动机</h5><ul>
<li>使用完提炼子类后，你可能会需要用到这个手段。</li>
</ul>
<h4 id="Pull-Down-Field-字段下移"><a href="#Pull-Down-Field-字段下移" class="headerlink" title="Pull Down Field(字段下移)"></a>Pull Down Field(字段下移)</h4><p>超类中的某个字段只被部分子类用到</p>
<h5 id="动机-4"><a href="#动机-4" class="headerlink" title="动机"></a>动机</h5><ul>
<li>同上面的函数下移</li>
</ul>
<h4 id="Extract-Subclass-提炼子类"><a href="#Extract-Subclass-提炼子类" class="headerlink" title="Extract Subclass (提炼子类)"></a>Extract Subclass (提炼子类)</h4><p>类中的某些特性只被某些实例用到（这个有点勉强吧，不可能每个实例都会用到所有特性，当然，将关联性比较强的特性组成一个新的类是可以的）</p>
<h4 id="Extract-Superclass-提炼超类"><a href="#Extract-Superclass-提炼超类" class="headerlink" title="Extract Superclass (提炼超类)"></a>Extract Superclass (提炼超类)</h4><p>两个类有相似特性</p>
<h5 id="动机-5"><a href="#动机-5" class="headerlink" title="动机"></a>动机</h5><ul>
<li>重复代码的危害。</li>
</ul>
<h4 id="Extract-Interface-提炼接口"><a href="#Extract-Interface-提炼接口" class="headerlink" title="Extract Interface (提炼接口)"></a>Extract Interface (提炼接口)</h4><p>若干客户使用类接口中的同一个子集，或者有部分接口相同。</p>
<h5 id="动机-6"><a href="#动机-6" class="headerlink" title="动机"></a>动机</h5><ul>
<li>分离出公用的接口可以使系统的用法更清晰，同时也更容易看清楚系统的责任划分。</li>
<li>接口或者多继承可以实现这种模块分离需求。</li>
</ul>
<h4 id="Collapse-Hierarchy-折叠集成关系"><a href="#Collapse-Hierarchy-折叠集成关系" class="headerlink" title="Collapse Hierarchy(折叠集成关系)"></a>Collapse Hierarchy(折叠集成关系)</h4><p>超类和子类之间无太大区别</p>
<h5 id="动机-7"><a href="#动机-7" class="headerlink" title="动机"></a>动机</h5><ul>
<li>消除无谓的集成关系，简化代码结构。</li>
</ul>
<h4 id="Form-Template-Method（塑造模板函数）"><a href="#Form-Template-Method（塑造模板函数）" class="headerlink" title="Form Template Method（塑造模板函数）"></a>Form Template Method（塑造模板函数）</h4><p>你有一些子类，其中相应的某些函数以相同顺序执行类似的操作，但各个操作的细节上有所不同</p>
<h5 id="动机-8"><a href="#动机-8" class="headerlink" title="动机"></a>动机</h5><ul>
<li>将执行操作的顺序移至超类，并借多态保证各操作仍得以保持差异性，这样的函数称为模板函数。</li>
</ul>
<h5 id="做法-1"><a href="#做法-1" class="headerlink" title="做法"></a>做法</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">// before</div><div class="line">class Customer...</div><div class="line"></div><div class="line">public String statement() &#123;</div><div class="line">	String result = textHeaderString();</div><div class="line">	while(...)&#123;</div><div class="line">		result += textEachRentalString();</div><div class="line">	&#125; </div><div class="line">	result += textFooterString();</div><div class="line">	return result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">public String htmlStatement() &#123;</div><div class="line">	String result = htmlHeaderString();</div><div class="line">	while(...)&#123;</div><div class="line">		result += htmlEachRentalString();</div><div class="line">	&#125; </div><div class="line">	result += htmlFooterString();</div><div class="line">	return result;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// step 1</div><div class="line"></div><div class="line">class Statement &#123;&#125;</div><div class="line">class TextStatement extends Statement &#123;&#125;</div><div class="line">class HtmlStatement extends Statement &#123;&#125;</div><div class="line"></div><div class="line">class Customer...</div><div class="line">public String statement() &#123;</div><div class="line">	return new TextStatement().value(this);</div><div class="line">&#125;</div><div class="line">public String htmlStatsment() &#123;</div><div class="line">	return new HtmlStatement().value(this);</div><div class="line">&#125;</div><div class="line"></div><div class="line">class TextStatement &#123;</div><div class="line">	public String value(Customer aCustomer) &#123;</div><div class="line">		String result = headerString(aCustomer);</div><div class="line">		while(...)&#123;</div><div class="line">			result += eachRentalString();</div><div class="line">		&#125; </div><div class="line">		result += footerString(aCustomer);</div><div class="line">		return result;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">class HtmlStatement &#123;</div><div class="line">	public String value(Customer aCustomer) &#123;</div><div class="line">		String result = headerString(aCustomer);</div><div class="line">		while(...)&#123;</div><div class="line">			result += eachRentalString();</div><div class="line">		&#125; </div><div class="line">		result += footerString(aCustomer);</div><div class="line">		return result;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// step 2</div><div class="line"></div><div class="line">class Statement &#123;</div><div class="line">	public String value(Customer aCustomer) &#123;</div><div class="line">		String result = headerString(aCustomer);</div><div class="line">		while(...)&#123;</div><div class="line">			result += eachRentalString();</div><div class="line">		&#125; </div><div class="line">		result += footerString(aCustomer);</div><div class="line">		return result;</div><div class="line">	&#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">abstract String headerString(Customer aCustomer)</div><div class="line">abstract String eachRentalString()</div><div class="line">abstract String footerString(Customer aCustomer)</div></pre></td></tr></table></figure>
<h4 id="Replace-Inheritance-with-Delegation-以委托取代继承"><a href="#Replace-Inheritance-with-Delegation-以委托取代继承" class="headerlink" title="Replace Inheritance with Delegation(以委托取代继承)"></a>Replace Inheritance with Delegation(以委托取代继承)</h4><p>某个子类只使用超类接口中的一部分，或是根本不需要继承而来的数据。</p>
<h5 id="动机-9"><a href="#动机-9" class="headerlink" title="动机"></a>动机</h5><ul>
<li><p>当你从超类中继承了一堆并不需要的东西时，传达出的信息与你的意图南辕北辙，这是一种混淆，你应该将它去除。</p>
</li>
<li><p>所用委托取代继承时，你可以有目的的选择需要的接口。 </p>
</li>
</ul>
<h4 id="Replace-Delegation-with-Inheritance-以继承取代委托"><a href="#Replace-Delegation-with-Inheritance-以继承取代委托" class="headerlink" title="Replace Delegation with Inheritance(以继承取代委托)"></a>Replace Delegation with Inheritance(以继承取代委托)</h4><p>你的两个子类之间使用委托关系，并且经常是全托。。。</p>
<h5 id="动机-10"><a href="#动机-10" class="headerlink" title="动机"></a>动机</h5><ul>
<li>委托需要编写大量的委托代码，如果是全托，会增加大量的代码量。</li>
<li>如果你没有使用受委托类的所有接口，那就不需要修改，如果需要使用所有的接口，请使用继承代替委托。</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/7/">7</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/head.png"
               alt="lly" />
          <p class="site-author-name" itemprop="name">lly</p>
          <p class="site-description motion-element" itemprop="description">耿直的一Boy</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">68</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          

          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">lly</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Mist
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.1"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.1"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.1"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"llyblog"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  

</body>
</html>
